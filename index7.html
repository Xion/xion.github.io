<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/code/sqlalchemy-regex-filters.html#sqlalchemy-regex-filters">Regular expression filters in&nbsp;SQLAlchemy</a></h2>
    <p>
      Posted on Wed 14 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/regular-expressions.html">regular expressions</a>,      <a href="http://xion.io/tag/sqlalchemy.html">SQLAlchemy</a>,      <a href="http://xion.io/tag/sql.html">SQL</a>,      <a href="http://xion.io/tag/postgres.html">Postgres</a>,      <a href="http://xion.io/tag/sqlite.html">SQLite</a>,      <a href="http://xion.io/tag/ast.html">AST</a>      &#8226; <a href="http://xion.io/post/code/sqlalchemy-regex-filters.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>The nice part about <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>
&#8212; an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping"><span class="caps">ORM</span></a> library/framework for Python &#8212;
is that it offers much more than just mapping of <span class="caps">SQL</span> relations to model classes. At its lower level, for example,
there exists an additional layer between those classes and raw <span class="caps">SQL</span> queries: an abstraction for the <em><span class="caps">SQL</span> language itself</em>.</p>
<p>Although it may sound byzantine at first, this extra layer serves two important&nbsp;purposes:</p>
<ul>
<li><em>portability</em>: compiling of the same query to potentially different <span class="caps">SQL</span> syntaxes,
as required by different database&nbsp;backends</li>
<li><em>extensibility</em>: allowing the user to introduce new elements: operators, functions, or even whole&nbsp;statements</li>
</ul>
<p>I&#8217;m going to take advantage of both of these qualities here, and show how you can implement support
for <em>regular expression</em> operators in query filters. On supported database backends, it will allow for powerful
pattern matching on string&nbsp;columns.</p>
<h4>Database&nbsp;side</h4>
<p>We will use the Postgres syntax of <span class="caps">POSIX</span>
<a href="http://www.postgresql.org/docs/9.3/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP">regular expression matchers</a>
as a reference. It includes four operators: for case sensitive or insensitive matching, in regular or negated&nbsp;versions.</p>
<p>Since it&#8217;s a common practice to use an in-memory <a href="https://www.sqlite.org/">SQLite</a> for running database-involved
&#8220;unit&#8221; tests<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>, we will also add support for that backend. Regular expressions are not implemented there directly,
but thanks to
<a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"><code>sqlite3</code><span class="quo">&#8216;</span>s custom function ability</a>,
it&#8217;ll be easy enough to provide the necessary support in&nbsp;Python.</p>
<h4>Desired <span class="caps">API</span></h4>
<p>In essence, what we want to do is to enhance the <code>String</code> column type with additional <em>comparators</em>, which will then
be usable as arguments for the <code>Query.filter</code> method.</p>
<p>As an example, consider the following model class with a string&nbsp;column:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nick</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="c"># ...</span>
</pre></div>


<p>Once we&#8217;re done, it should be possible to query for e.g. all the people whose nicks contain numbers
in a pretty straightforward&nbsp;fashion:</p>
<div class="highlight"><pre><span class="n">numerics</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">nick</span><span class="o">.</span><span class="n">regexp</span><span class="p">(</span><span class="s">r&#39;\d+&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>Because of the limitations of underlying databases backends, only <em>literal</em> regular expressions would be supported.
It means that, from the <span class="caps">SQL</span> standpoint, they have to be constants: you cannot use the value of one column as part
of a regular expression that another column is matched&nbsp;against.</p>
<p>But of course, you can still construct those literals in Python&nbsp;code:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_copycats</span><span class="p">(</span><span class="n">nick</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all the people who tried to parrot given nick</span>
<span class="sd">    but failed and had to append some numbers to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nick_regexp</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">nick</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;\d+$&#39;</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">nick</span><span class="o">.</span><span class="n">regexp</span><span class="p">(</span><span class="n">nick_regexp</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>Considering that regular expressions themselves are already pretty powerful, this really ought to be sufficient
for all reasonable&nbsp;purposes.</p>
<h4>How comparators&nbsp;work?</h4>
<p>So how do we add the <code>regexp</code> method to the <code>String</code> type? It may seem logical to simply extend the class
and add it&nbsp;directly:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span> <span class="k">as</span> <span class="n">_String</span>


<span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">_String</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enhanced version of the standard string type.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># hmm...</span>
</pre></div>


<p>But this won&#8217;t actually work. In SQLAlchemy, objects like <code>String</code> or <code>Integer</code> do not represent columns of certain type;
they correspond to <em>types themselves</em><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. Extending them with additional methods won&#8217;t do much good, because regular code
rarely operates on column&nbsp;types.</p>
<p>On the other hand, though, we obviously don&#8217;t want to mess with the <code>Column</code> class itself. Our additions are only
meaningful for string columns, but putting them there would expose them to <em>all</em> columns, regardless of&nbsp;type!</p>
<p>Thankfully, there is an intermediate mechanism which SQLAlchemy introduced precisely to address the need we&#8217;ve got here.
Every column type can define a
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/type_api.html#sqlalchemy.types.TypeEngine.comparator_factory"><code>comparator_factory</code></a>: a kind of mixin class whose methods are incorporated into columns of that type.
By <a href="http://docs.sqlalchemy.org/en/rel_0_9/core/custom_types.html#types-operators">overriding this inner class</a>,
we can both modify the behavior of existing operators, as well as introduce completely new&nbsp;ones.</p>
<p>So in order to add <code>regexp</code> and other methods to all <code>String</code> columns, our new string type must define its own
<code>comparator_factory</code>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">_String</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">comparator_factory</span><span class="p">(</span><span class="n">_String</span><span class="o">.</span><span class="n">comparator_factory</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="c"># ...</span>
</pre></div>


<p>We need to remember about deriving it from the original one, too. Otherwise, all the standard operators
you&#8217;d want to use in queries (<code>==</code>, <code>+</code>, etc.) would cease to work, because the new <code>comparator_factory</code> wouldn&#8217;t
include an implementation of any of the necessary magic methods (<code>__eq__</code>, <code>__add__</code>,&nbsp;etc.).</p>
<h4><span class="caps">SQL</span>,&nbsp;abstracted</h4>
<p>Knowing where to put our new comparator methods is certainly desirable, but the more interesting question is
how do we implement&nbsp;them?</p>
<p>Like I&#8217;ve mentioned in the beginning, SQLAlchemy employs an additional layer between
<span class="caps">ORM</span> models and raw, textual <span class="caps">SQL</span> language. Basically, it&#8217;s an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"><span class="caps">AST</span></a>
for backend-independent queries which includes almost all of the various <span class="caps">SQL</span> constructs, codified in a platform-agnostic
way inside the <code>sqlalchemy.sql</code> package.</p>
<p>You may have used this layer directly if you ever wrote queries based on
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/metadata.html#sqlalchemy.schema.Table"><code>Table</code> objects</a> and ran them with
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/session_api.html#sqlalchemy.orm.session.Session.execute"><code>Session.execute</code></a>. But even those constructed using the more familiar
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query"><code>Query</code> class</a> interface
end up in this intermediate representation. Often there is little to no additional processing&nbsp;involved.</p>
<p>Arguments to the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query.filter"><code>Query.filter</code> method</a>,
for example, are already given as <span class="caps">SQL</span> clause objects. It just so happens that its creation is hidden behind
a very neat, operator-based <span class="caps">API</span>.</p>
<p>Thus, if our regular expression filters are to cooperate, they also need to return pieces of the <span class="caps">SQL</span> syntax tree.
Not very complicated pieces, mind you, since we only need to represent simple expressions: something like <code>foo ~ 'bar'</code>, where <code>~</code> may optionally be replaced by one of the other three&nbsp;operators.</p>
<h4>Creating the&nbsp;node</h4>
<p>They are all <em>binary</em> operators, by the way (i.e. taking exactly two arguments), so it makes sense that the corresponding
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.BinaryExpression"><span class="caps">AST</span> node class</a> is called <code>BinaryExpression</code>. The node&#8217;s children are the left argument, the right argument, and the operator&nbsp;itself.</p>
<p>With a little help from a few more <span class="caps">SQL</span> syntax wrappers, the implementation of <code>regexp</code> and the other methods
turns out to be quite&nbsp;straightforward:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">BinaryExpression</span><span class="p">,</span> <span class="n">literal</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.operators</span> <span class="kn">import</span> <span class="n">custom_op</span>


<span class="c"># (inside String.comparator_factory)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~*&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">not_regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;!~&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">not_iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;!~*&#39;</span><span class="p">))</span>
</pre></div>


<p>The use of
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.literal"><code>literal</code> function</a>
is dictated by the limitation that was mentioned earlier: any regular expression given in the query must be a <span class="caps">SQL</span> literal.
If we now try to pass a column-like clause, we&#8217;ll get an exception right at the query definition, rather than
a database error when we try to execute&nbsp;it.</p>
<p>The <a href="docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.operators.custom_op"><code>custom_op</code> function</a>,
on the other hand, is simply the easiest way to create an &#8220;operator node&#8221; that&#8217;s required as a child
of <code>BinaryExpression</code>. Since it&#8217;s a custom operator, it won&#8217;t be interpreted by SQLAlchemy in any way; it will simply
be used verbatim in the final <span class="caps">SQL</span> string that&#8217;s sent to the&nbsp;database.</p>
<h4>Compile!</h4>
<p>You may have noticed that this would pose a problem if said database doesn&#8217;t support <code>~</code> or the other operators,
which happens to be the case for everything besides Postgres. Because we originally intended to support SQLite in addition
to Postgres, this is evidently a&nbsp;problem.</p>
<p>It&#8217;s also where the portability of an intermediate <span class="caps">SQL</span> representation comes into play. Since our new operators return
<span class="caps">AST</span> nodes and not just textual <span class="caps">SQL</span>, we can redefine the way those nodes are <em>compiled</em> into actual query fragments
on various database&nbsp;backends.</p>
<p>To accomplish that, first we need to distinguish our regex filters from other <code>BinaryExpression</code>s:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RegexMatchExpression</span><span class="p">(</span><span class="n">BinaryExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents matching of a column againsts a regular expression.&quot;&quot;&quot;</span>

<span class="c"># (inside String.comparator_factory)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RegexMatchExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">))</span>
<span class="c"># etc.</span>
</pre></div>


<p>Once we&#8217;ve introduced such a distinction, it becomes possible to provide a different way for those filters to be turned
into <span class="caps">SQL</span>. We can namely define a new compilation routine for them,
and <a href="docs.sqlalchemy.org/en/rel_0_9/core/compiler.html#sqlalchemy.ext.compiler.compiles">mark it as canonical</a>
for a specific <span class="caps">SQL</span>&nbsp;dialect:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile the SQL expression representing a regular expression match</span>
<span class="sd">    for the SQLite engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># ...</span>
</pre></div>


<p>The function receives an <span class="caps">AST</span> <code>element</code> to process (here, the <code>RegexMatchExpression</code>), along with a
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/internals.html#sqlalchemy.sql.compiler.SQLCompiler">special <code>compiler</code> object</a>
that controls the whole translation process. Armed with those tools, we are allowed to modify the process
in arbitrary ways and output just the right <span class="caps">SQL</span> statement that&#8217;ll do the job in&nbsp;SQLite.</p>
<h4>Regex support&nbsp;lite</h4>
<p>How does such a statement look like, though? As I&#8217;ve remarked early on, SQLite is very easy to extend with your own
functions, and the <code>sqlite3</code> driver used by SQLAlchemy enables us to write those functions directly in Python.
Obviously, this is fantastic news when you have something like
<a href="https://docs.python.org/2/library/re.html">the standard <code>re</code> module</a> at your&nbsp;disposal.</p>
<p>Indeed, coding the four required functions is quite&nbsp;trivial:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="c"># Mapping from the regular expression matching operators</span>
<span class="c"># to named Python functions that implement them for SQLite.</span>
<span class="n">SQLITE_REGEX_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;~&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;REGEXP&#39;</span><span class="p">,</span>
          <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">))),</span>
    <span class="s">&#39;~*&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;IREGEXP&#39;</span><span class="p">,</span>
           <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))),</span>
    <span class="s">&#39;!~&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NOT_REGEXP&#39;</span><span class="p">,</span>
           <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">)),</span>
    <span class="s">&#39;!~*&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NOT_IREGEXP&#39;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)),</span>
<span class="p">}</span>
</pre></div>


<p>What&#8217;s less apparent is how &#8212; or rather, <em>when</em> &#8212; to instruct the SQLite database to use them.
As per the <a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"><span class="caps">API</span> we have to use</a>,
custom SQLite functions are created on a per-connection basis. But SQLAlchemy, like any good database interface,
takes care of connection management, lifecycle, and pooling. Nowhere in our application there is a <code>connect</code> call
(nor there should be!) that we could just follow with a few <code>create_function</code> invocations.</p>
<p>Yet, there is a way of doing exactly what we require, and it involves utilizing the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/event.html">event subsystem</a> included in SQLAlchemy. Anytime something
interesting happens to any of its <span class="caps">ORM</span> or core objects &#8212; models, sessions, connection pools, etc. &#8212; SQLAlchemy
publishes an <em>event</em> that our application code can <em>listen</em> (subscribe) to. It&#8217;s a classic
<a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">PubSub system</a> that introduces some serious potential
for&nbsp;extensibility.</p>
<p>Our use of it will be pretty modest, though. All we&#8217;re interested in is the establishing of a connection
to the SQLite database. This translates directly to a <code>'connect'</code> event of the
<a href="docs.sqlalchemy.org/en/rel_0_9/core/connections.html"><code>Engine</code> object</a>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Engine</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s">&#39;connect&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_engine_connect</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listener for the event of establishing connection to a SQLite database.</span>

<span class="sd">    Creates the functions handling regular expression operators</span>
<span class="sd">    within SQLite engine, pointing them to their Python implementations above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">SQLITE_REGEX_FUNCTIONS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
</pre></div>


<p>Note that this will catch all the connection events, so we have to verify it&#8217;s really SQLite we&#8217;re talking to.
Afterwards, the creation of <code>REGEXP</code>, <code>IREGEXP</code>, etc. functions is extremely&nbsp;straightforward.</p>
<h4>Compilation, take&nbsp;two</h4>
<p>This was quite a build-up, but now we&#8217;re very close to the finale. What remains is finishing the compilation&nbsp;routine:</p>
<div class="highlight"><pre><span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>We know that <code>element</code> corresponds to an expression in the form of <code>a ~ 'foo'</code>. For SQLite, however, the compatible
version is a <em>function call</em>: <code>REGEXP(a, 'foo')</code>. At first this may appear rather disconcerting, because it&#8217;s basically
a completely different <span class="caps">AST</span> node to&nbsp;build.</p>
<p>But it&#8217;s actually not a problem at all. Inside compiler hooks, we are allowed to use the much of the same <span class="caps">API</span> that&#8217;s
available when drafting regular queries. This includes the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.func"><code>func</code> factory object</a>
which produces calls to arbitrary <span class="caps">SQL</span> functions. Rather than compiling the original binary expression, we&#8217;ll simply
poach its operands and use them as arguments to one of the new&nbsp;functions:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">func</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="c"># determine the name of a custom SQLite function to use for the operator</span>
    <span class="n">operator</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">opstring</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SQLITE_REGEX_FUNCTIONS</span><span class="p">[</span><span class="n">operator</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">would_be_sql_string</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">left</span><span class="p">),</span>
                                        <span class="n">operator</span><span class="p">,</span>
                                        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">right</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">StatementError</span><span class="p">(</span>
            <span class="s">&quot;unknown regular expression match operator: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">,</span>
            <span class="n">would_be_sql_string</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c"># compile the expression as an invocation of the custom function</span>
    <span class="n">regex_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
    <span class="n">regex_func_call</span> <span class="o">=</span> <span class="n">regex_func</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">regex_func_call</span><span class="p">)</span>
</pre></div>


<p>Notice how <code>compiler.process</code> is used to obtain the final result. The <code>compiler</code> object doesn&#8217;t care that we use it on
a totally different <span class="caps">AST</span> node; it will dutifully carry out its compilation into raw <span class="caps">SQL</span>. We can even use this capability
to add a little bit of paranoid error handling: if we encounter an unknown operator, the resulting error message
will include fully compiled, <span class="caps">SQL</span> versions of both&nbsp;arguments.</p>
<h4>Summary</h4>
<p>This concludes our efforts: the original query examples with <code>Person.nick.regexp</code> should now work
in both Postgres and SQLite.
For you convenience, I&#8217;ve bundled all the code in <a href="https://gist.github.com/Xion/204ddbd020f1a4275a53">this gist</a>.</p>
<p>If you feel like tinkering with it further, I would suggest you try to remove the superfluous <code>NOT_*</code> functions.
They make little sense given that <span class="caps">SQL</span> has a perfectly adequate <code>NOT</code> keyword. A clean solution would probably prefer
an additional <code>reverse</code> flag in <code>RegexMatchExpression</code> over looking for a <code>'!'</code> character in the operator&nbsp;string.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It may or <a href="http://michael.robellard.com/2015/07/dont-test-with-sqllite-when-you-use.html">may not be</a>
a <em>good</em> practice, though.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Although it&#8217;s possible to write <code>Column(Integer)</code>, it&#8217;s merely a syntactical convenience.
SQLAlchemy interprets it readily as <code>Column(Integer())</code>. Parameterized types &#8212; like <code>String</code> &#8212; always require explicit
instantiation.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/dont-copy-paste-retype.html#dont-copy-paste-retype">Don&#8217;t Copy <span class="amp">&amp;</span> Paste.&nbsp;Retype.</a></h2>
    <p>
      Posted on Sat 03 October 2015 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/problem-solving.html">problem solving</a>,      <a href="http://xion.io/tag/stack-overflow.html">Stack Overflow</a>,      <a href="http://xion.io/tag/typing.html">typing</a>      &#8226; <a href="http://xion.io/post/programming/dont-copy-paste-retype.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In this day and age, Google and <a href="http://stackoverflow.com">Stack Overflow</a> are quite essential tools for any developer.
Lately, though, the latter seems to be getting some bad rap. On one side, it&#8217;s because of seemingly peculiar
and sometimes alienating <a href="https://medium.com/@johnslegers/the-decline-of-stack-overflow-7cb69faa575d">moderation policies</a>.
But more pertinently, it&#8217;s the apparent rise of a phenomenon that&#8217;s wittily dubbed
&#8220;the <a href="https://www.christianheilmann.com/2015/07/17/the-full-stackoverflow-developer/">full Stack Overflow developer</a>&#8220;.</p>
<p>In a nutshell, individuals deserving to be called that are code slingers who throw software artifacts together mostly by
copying and pasting code samples found in Stack Overflow answers. They may be getting something working pretty quickly,
but they also lack understanding of problems they&#8217;re facing and solutions they&#8217;re using so&nbsp;cheerily.</p>
<p>Of course, not every instance of code Copy Pasta is to be scorned. I&#8217;m pretty sure most people reading this post
(and certainly the person writing it!) are guilty of replicating at least a few snippets from Stack Overflow, verbatim,
in their own codebase. Heck, we may have even done so with nigh zero interest as to why it has been written this way.
Not every technology is intrinsically fascinating, after all, and deadlines are sometimes too close for&nbsp;comfort.</p>
<p>But if so, does it mean we are gradually turning into full Stack Overflow developers?&#8230;
Yikes! Surely we don&#8217;t want that to&nbsp;happen!</p>
<h4>Mitigation&nbsp;tactic</h4>
<p>Before you shut off your Internet connection altogether while coding, consider employing the following technique
whenever you feel like scraping a piece of code from Stack Overflow, and dumping it in your project&nbsp;source.</p>
<p>Don&#8217;t use the clipboard. Don&#8217;t copy and paste. <strong>Retype</strong> the code you&#8217;ve found&nbsp;instead.</p>
<p>It&#8217;s going to take more time, yes. It&#8217;s definitely more cumbersome than just hitting <em>Ctrl+C</em>/<em>Ctrl+V</em>.
It may also make little sense: if the end result is the same, why does it matter whether the code was transfered
through the clipboard or&nbsp;not?</p>
<h4>Rationale</h4>
<p>I&#8217;d argue, however, that it makes perfect sense. From the least to the most important, the reasons why I think so
are the&nbsp;following:</p>
<ul>
<li>
<p>The fact that retyping is slower than copy-pasting is what actually makes it <em>better</em>. If you vow not to use
the clipboard, you&#8217;re much less likely to just pick whatever&#8217;s the first Stack Overflow result Google has given.
You&#8217;ll weigh different solutions, and you&#8217;ll be rightfully biased towards shorter and simpler&nbsp;ones.</p>
</li>
<li>
<p>When you type something, you cannot do it completely thoughtlessly. Whether you want it or not, you&#8217;ll absorb
some of the knowledge through sheer osmosis, because the code will flow through your eyes and fingers as it&#8217;s transfered
from the browser to your editor or <span class="caps">IDE</span>. Your subconscious brain will latch onto the bits and pieces of information,
and it will sort them out for you to use later. Even if you didn&#8217;t intend to, you will most likely <em>learn something</em>.</p>
</li>
<li>
<p>But most importantly, what you type almost certainly won&#8217;t be a perfect copy of the original snippet.
As you progress through the code, you&#8217;ll inevitably deviate from it, if only to conform to a particular style guide
your project is following.<br>
It&#8217;s quite likely, though, that you&#8217;ll make larger changes as well.
You will replace familiar patterns with calls to utility functions.
You&#8217;ll rearrange the code visually for better readability.
You will add comments, or extract functions to make it more self-documenting.
You might even enhance and customize it, so that you can abstract and reuse it multiple&nbsp;times.</p>
</li>
</ul>
<p>Afterwards, what you&#8217;ve just typed won&#8217;t be just some code you have found on the Internet. It&#8217;ll be <em>your code</em>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/requirejs-optional.html#requirejs-optional">Optional loading of RequireJS&nbsp;modules</a></h2>
    <p>
      Posted on Tue 29 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/javascript.html">JavaScript</a>,      <a href="http://xion.io/tag/requirejs.html">RequireJS</a>,      <a href="http://xion.io/tag/modules.html">modules</a>,      <a href="http://xion.io/tag/web-workers.html">Web Workers</a>,      <a href="http://xion.io/tag/dom.html">DOM</a>,      <a href="http://xion.io/tag/ajax.html">AJAX</a>      &#8226; <a href="http://xion.io/post/code/requirejs-optional.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://requirejs.org/">RequireJS</a> is a module loader for JavaScript. Similar to its alternatives such as
<a href="http://browserify.org/">Browserify</a>, it tries to solve an important problem on the web front(end):
dividing JavaScript code into modules for better maintainability while still loading them correctly and efficiently
without manual curation of the <code>&lt;script&gt;</code> tags.</p>
<p>Once it&#8217;s configured correctly (which can be rather <a href="http://requirejs.org/docs/api.html#config">non-trivial</a>, though),
modules in RequireJS are simply <code>define</code>d as functions that return arbitrary JavaScript&nbsp;objects:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;jquery&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lodash&#39;</span><span class="p">,</span>

    <span class="s1">&#39;myapp/dep1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;myapp/dep2&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dep1</span><span class="p">,</span> <span class="nx">dep2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... all of the module&#39;s code ...</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">exportedSymbol1</span><span class="o">:</span> <span class="p">...,</span>
        <span class="nx">exportedSymbol2</span><span class="o">:</span> <span class="p">...,</span>
    <span class="p">};</span>
<span class="p">});</span>
</pre></div>


<p>Before executing the function, RequireJS loads all the specified dependencies, repeating the process recursively
and asynchronously. Return values from module functions are passed as parameters to the next module function,
and thus the whole mechanism clicks, serving as a crafty workaround for the lack of proper <code>import</code> functionality<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>Relative&nbsp;failures</h4>
<p>If, at some point in the chain, the desired module cannot be found or loaded, the entire process grinds to a halt
with an error. Most of the time, this is perfectly acceptable (or even desirable) behavior, equivalent to an incorrect
<code>import</code> statement, invalid <code>#include</code> directive, or similar mistake in other&nbsp;languages.</p>
<p>But there are situations when we&#8217;d like to proceed with a missing module, because the dependent code is prepared
to handle it. The canonical example are
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Web Workers</a>.
Unlike traditional web application code, Web Worker scripts operate outside of a context of any single page,
having no access to the <abbr title="Document Object Model"><span class="caps">DOM</span></abbr> tree (because <em>which</em> <span class="caps">DOM</span> tree would it be?).
Correspondingly, they have no <code>document</code> nor <code>window</code> objects in their global&nbsp;scope.</p>
<p>Unfortunately, some libraries (<em>*cough*</em> jQuery <em>*cough*</em>) require those objects as a hard (and usually implicit)
dependency. This doesn&#8217;t exactly help if we&#8217;d like to use them in worker code for other features, not related to <span class="caps">DOM</span>.
In case of jQuery, for example, it could be the <span class="caps">API</span> for making <span class="caps">AJAX</span> calls, which is still decidedly more pleasant
than dealing with bare <code>XMLHTTPRequest</code> if we&#8217;re doing anything&nbsp;non-trivial.</p>
<p>Due to this hard dependency on <span class="caps">DOM</span>, however, Web Workers cannot <code>require</code> jQuery. No biggie, you may think: browsers
supporting workers also offer an excellent, promise-based
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch <span class="caps">API</span></a> that largely replaces the old <span class="caps">AJAX</span>,
so we may just use it in worker code. Good thinking indeed, but it doesn&#8217;t solve the issue of <em>sharing code</em> between
main (&#8220;<span class="caps">UI</span>&#8221;) part of the app and Web&nbsp;Workers.</p>
<p>Suppose you have the following dependency&nbsp;graph:</p>
<p><div class="graphviz" style="text-align: center;"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAD7CAYAAAAvttudAAAAAXNSR0IArs4c6QAAMvxJREFUeAHtnQe0FEXWx8ucM4IiCuaECTOiYM7ZVUExR9wVzPoZcA3HHNawrgrmiIqCWVAxiwkzKggoCiq65hzqu7+71tgzb6bfvJnumQ51z+nXbzpUuF23wg3/ms5aO8R48hzwHCjLgelEQGzZO/6i54DngJne88BzwHOgMge8gFTmjb/jOeBHEN8GPAfCODBj2M24733++efmzTff1GPChAlmypQpekydOtV899135scffzQ//fST+fXXX82ss86qx2yzzWbmnXde07FjRz0WWWQRs9xyy5muXbua5ZdfXp+Ju9x5SP/33383H330kZk4caLh20yaNMlMmzbN8M3c8fXXX5tffvnF/Pzzz4UzvJllllnMzDPPXDjPM888pl27doVjwQUXNF26dDFLLLGEWXzxxU2nTp3MDDPMkEi2NnSRjjA88cQTejz99NMGQYDmn39+s/TSSxsaOw1/4YUXNnPNNVdBIGaaaSYVFIQFofnvf/9bECY+4nvvvacfCSYjJBtssIHp2bOnHh06dEgk45NUqM8++8yMGTPGvPrqq4Xj/fff146Jcs4+++zaoOHlAgssUGjodFQIQ1AgeD4oMPz/1VdfFYTqiy++MJ9++qkK3A8//MDjhu+71FJLmVVWWcWsuuqqeqy22mqmffv2er+Zf2IVkD/++MM888wzZujQoXp8+OGHht6kR48eZv311zfdunXTnh+BqIfo7caNG6cj0ejRo82TTz5pXnnlFcP1ddZZx+y0005m55131t6qnnyy8i4j9ahRowqd1bvvvqtVoyenkXKsuOKKhR4+rk4GQXEj1FtvvWVee+01FdCPP/5Yy7PssssWOrpevXpp59nwb4CaN2r65JNP7Jlnnmk7d+6MCtmusMIK9sQTT7QvvviilUYbdXZl0/v222/t8OHD7T777GNlhNJyCJPtbbfdZmVaUPadLF+U0cGeeuqpVnpm5YX02nbddde1xx9/vH3ggQesTJsSU33KQpkoG2WkrLQjyk4dqEujyESZkfTidu+999YK0SiPOOIIKz1DlFnUlJasYZTh22+/vZVpmJUe0Z5zzjlW1jk1pZeWl2TdYAcOHGhlnq8NTKav9pBDDlFefP/992mphqWsCAxlpw4IC3WibtQxTopEQGTqpIJB41tmmWXstddea2WtEGe5a05b1iz2uOOOs3POOaeVxaI9//zzrcyTa04vaS8yQt9xxx12k002sdNNN52Vebw98sgjdfSWKW/Sitvm8lAHZiLUibpRR+pKneOYndQlIPTM5557rp1jjjnskksuaW+66Sb722+/tbnSzXiBYfyEE06wohWzogWzjz32WDOKEVmeosCwV155pZXFrp1++untdtttZ4cNG2b5Rlkl6kYdt912W60zdYcH8CIqqllA3n77bbvyyitrAzvttNMiLVRUlasmHVkkamNi2D7ggAN0OK/mvaQ8Q685aNAgK4oOK9oke+CBB1pZdCeleA0rB3Wm7vAAXsCTKEaUmgTkmmuusaL6s2uvvbYVdWDDmBBnRnfddZcu5lEovPHGG3FmFVnajHqicbIzzjij7devn0U5kneCB/ACnsCbemcGbRIQ5n8svJn3oWHI2vDNWkpU0Lo+efjhhxPb1tDQMdox6jG9GDt2bGLL2qyCwRN442YG8KwWqlpAUI327t3bioXU3nLLLbXklYp3qGffvn1VE3fjjTcmrsxiYFUNjlimdWGauAImrEAs3uEVWi9411aqSkAYOfr06aM9a71DVlsL2Kznjz32WF34weCk0NVXX62CywJcjGxJKVbiywGv4Bn2FHjYFqpKQJhWMXKMGDGiLWmn/tm///3vuuh7/PHHm1oXOqhjjjlGp7Ynn3yy5bentnEAnsE7lgfwsloetiogt956q87jOOeNYOIuu+yi9hLxG2tK9SkD2hl6vzx+g6iZDg/hJTytRkhCBQQrpfhOqVYg6oKmJb1vvvlGbTybbbZZVQyNul4YNTHADhkyJOqkc5sevISnKJpao1ABQQuA2jOpVvHWKhfVfXGA1PXIDTfcEFWSVaVz88036+iNZ4KnaDkAT9FwweMwqigg4pauCTz00ENh7+fm3v77728XW2yxhhlEGb1xhxkwYEBueNzoisJbeBzmz1XR3X3DDTdUP/1HHnlEBM0TLuLELIjvlhFDVOwMkdFbA5Vw2yfewlP0HCBWhZALArfuvffeshmUFZDx48drANN9991ntt5667IvRnFRVMYaPBNMi+hAgmUgItbEizN426y33noaY1J0UX4QY7LooouWXo70t7jOG7Gym5dffjnSdEsTe+qppzToS7SGRhzxSm+n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aj744APz/vvvmwkTJpgPP/zQfP7553pMmzZNz99995355ZdfzM8//2x++ukn/R8VL+sPFuqMLPyPvaRdu3aFo2PHjmaJJZYoHHPPPXcEJfZJVMsBLyDVcurP56ZMmWLGjBlTOF599VUzadKkgn1j3nnnNV26dDELLrhgoZHT4Oeaay4VBCcMI0eO1OkVwoXQIDw//PCD+eKLLwrChZBNnjzZkKfz4SKtlVde2ay22moG71/Oyy+/fEU3ljZWzz9ewgEvICUMKf350Ucfmccff9yMGjVKD0YIaPHFF9cGSiNdYYUV9Dc9/XzzzVeaRNnfNHgcFKshBAghJO/33nvPvPbaawbBfOutt1SwEEpc6nv16qUHZcI676l+DngBKcPD119/3dx999160BiZ/qy99tqmZ8+eeqy55pqGBXazidEHIXnyySfNE088oWdGnfbt26u9ZccddzQbb7xxC+Nks8udpvy9gPz5tRgprrvuOj1YSzD3x6i3ww47qKftrLPOmvjvyqj0xhtvmHvvvdfcc8895qWXXjKsWXCU3H///U337t0TX4fEFVCYmlsSNw9733332a222srKgtnK/N7279/fjh492nIv7STrF3vRRRdZWbMQhGJlrWIvvPBC+80336S9ag0rP4u/3JEY6OzNN99sV1ppJW04m222mb3jjjuszPUzywsZTeyhhx5qxd3FyjrJnnzyyVY0bJmtb1QVy52AyNrCLrXUUlbcPKzYI6ysMaLiZSrSES2ZPe2006xo2ezss89uTznlFPv999+nouzNKGRuBARB2HDDDXXEEEu2FY1QM/idmDxFpWzPPvtsK2sUKygq9sYbb0xM2ZJUkMwLCNMpekxGjHXWWcdKXHiS+N/0snz22Wf2kEMOsaIWtptvvrkVm0vTy5SkAmRaQEQbpUIhGihdnGZh4R1X43nmmWd06imWfHvXXXfFlU3q0s2sgIhtwM4///xWLM127NixqfswzSgwaxFGEzReAwcObEYREpdnJgUEDZUY96zEefsFaA1N7sorr9QpqbjiW3GBqSGF7LySOQG59dZbdT59zDHHZMKW0aym9uijj1qBRrW77bab/f3335tVjKbnmykBeeihh+xMM81kjzjiiKYzNgsFeOyxxyzrN+wneaXMCIg48VnxmLX77rtvXr9lLPUWTGEdkS+55JJY0k96opnwxZIp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"></div></p>
<p>The <code>common</code> module has some logic that we&#8217;d want reused between regular <code>&lt;script&gt;</code>-based code and a Web Worker,
but its dependency on jQuery makes it impossible. It would work, however, if this dependency was a <em>soft</em> one.
If <code>common</code> could <em>detect</em> that jQuery is not available and fall back to other solutions (like the Fetch <span class="caps">API</span>),
we would be able to <code>require</code> it in both execution&nbsp;environments.</p>
<h4>The <code>optional</code> plugin</h4>
<p>What we need, it seems, is an ability to say that some dependencies (like <code>'jquery'</code>) are <em>optional</em>. They can be loaded
if they&#8217;re available but otherwise, they shouldn&#8217;t cause the whole dependency structure to crumble. RequireJS does not
support this functionality by default, but it&#8217;s easy enough to add it via a <em>plugin</em>.</p>
<p>There are already <a href="https://github.com/jrburke/requirejs/wiki/Plugins">several useful plugins</a> available for RequireJS
that offer some interesting features. As of this writing, however, optional module loading doesn&#8217;t seem to be among them.
That&#8217;s not a big problem: rolling out our own<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> plugin turns out to be relatively&nbsp;easy.</p>
<p><a href="http://requirejs.org/docs/plugins.html">RequireJS plugins</a> are themselves modules: you create them as separate JavaScript
files having code wrapped in <code>define</code> call. They can also declare their own dependencies like any other module.
The only requirement is that they export an object with <a href="http://requirejs.org/docs/plugins.html#api">certain <span class="caps">API</span></a>:
at minimum, it has to include the <code>load</code> method. Since our <code>optional</code> plugin is very simple, <code>load</code> is in fact
the only method we have to&nbsp;implement:</p>
<div class="highlight"><pre><span class="cm">/* Skeleton of a simple RequireJS plugin module. */</span>

<span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

<span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">parentRequire</span><span class="p">,</span> <span class="nx">onload</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="nx">load</span><span class="p">,</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>


<p>As its name would hint, <code>load</code> carries out the actual module loading which a plugin is allowed to influence, modify,
or even replace with something altogether different. In our case, we don&#8217;t want to be too invasive, but we need to
detect failure in the original loading procedure and step&nbsp;in.</p>
<p>I mentioned previously that module loading is asynchronous, which JavaScript often translates to &#8220;callbacks&#8221;.
Here, <code>load</code> receives the <code>onload</code> callback which we eventually need to invoke. It also get the mysterious
<code>parentRequire</code> argument; this is simply a regular <code>require</code> function that&#8217;d normally be used if our plugin didn&#8217;t
stand in the&nbsp;way.</p>
<p>Those two are the most important pieces of the puzzle, which overall has a pretty succinct&nbsp;solution:</p>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * RequireJS plugin for optional module loading.</span>
<span class="cm"> */</span>
<span class="nx">define</span> <span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>


<span class="cm">/** Default value to return when a module failed to load. */</span>
<span class="kd">var</span> <span class="nx">DEFAULT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">parentRequire</span><span class="p">,</span> <span class="nx">onload</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parentRequire</span><span class="p">([</span><span class="nx">moduleName</span><span class="p">],</span> <span class="nx">onload</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">failedModule</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">&amp;&amp;</span> <span class="nx">requireModules</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Could not load optional module: &quot;</span> <span class="o">+</span> <span class="nx">failedModule</span><span class="p">);</span>
        <span class="nx">requirejs</span><span class="p">.</span><span class="nx">undef</span><span class="p">(</span><span class="nx">failedModule</span><span class="p">);</span>

        <span class="nx">define</span><span class="p">(</span><span class="nx">failedModule</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">DEFAULT</span><span class="p">;</span> <span class="p">});</span>
        <span class="nx">parentRequire</span><span class="p">([</span><span class="nx">failedModule</span><span class="p">],</span> <span class="nx">onload</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="nx">load</span><span class="p">,</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>


<p>The logic here is as&nbsp;follows:</p>
<ul>
<li>First, try to load the module normally (via the outer <code>parentRequire</code> call).</li>
<li>If it succeeds, <code>onload</code> is called and there is nothing for us to&nbsp;do.</li>
<li>If it fails, we log the <code>failedModule</code> and cleanup some internal RequireJS state with <code>requirejs.undef</code>.</li>
<li>Most importantly, we <code>define</code> the module as a trivial shim that returns some <code>DEFAULT</code> (here, <code>null</code>).</li>
<li>As a result, when we require it again (through the inner <code>parentRequire</code> call), we <em>know</em> it&#8217;ll be loaded&nbsp;successfully.</li>
</ul>
<h4>Usage</h4>
<p>Plugins in RequireJS are invoked on a per-module basis. You can specify that a certain dependency <code>'bar'</code> shall be loaded
through a plugin <code>'foo'</code> by putting <code>'foo!bar'</code> on the dependency&nbsp;list:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span> <span class="s1">&#39;foo!bar&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>Both <code>'foo'</code> and <code>'bar'</code> represent module paths here: the first one is the path to the <em>plugin</em> module,
while the second one is the actual dependency. In a more realistic example &#8212; like when our optional loader is involved &#8212;
both of them would most likely be multi-segments&nbsp;paths:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;myapp/ext/require/optional!myapp/common/buttons/awesome-button&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>As you can see, they can get pretty unreadable rather quickly. It would be better if the plugin prefix consisted
of just one segment (i.e. <code>optional!</code>) instead. We can make that happen by adding
<a href="http://requirejs.org/docs/api.html#config-map">a mapping</a> to the RequireJS&nbsp;config:</p>
<div class="highlight"><pre><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="c1">// ...</span>
    <span class="nx">map</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;optional&#39;</span><span class="o">:</span> <span class="s1">&#39;myapp/ext/require/optional&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>


<p>With this renaming in place, the loading of non-mandatory dependencies becomes quite a bit&nbsp;clearer:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;optional!myapp/common/buttons/awesome-button&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>

<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... (some work around) ...</span>
<span class="p">}</span>

<span class="p">});</span>
</pre></div>


<p>Of course, you still need to actually code around the potential lack of an optional dependency.
The <code>if</code> statement above is just an illustrative example; you may find it more sensible to provide some shim&nbsp;instead:</p>
<div class="highlight"><pre><span class="nx">AwesomeButtonController</span> <span class="o">=</span> <span class="nx">AwesomeButtonController</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</pre></div>


<p>Either way, I recommend trying to keep the size of such conditional logic to a minimum.
Ideally, it should be confined to a single place, or &#8212; better yet &#8212; abstracted behind a&nbsp;function.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>An actual <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import"><code>import</code> statement</a>
has made it into the <span class="caps">ES6</span> (ECMAScript 2015) standard but, as of this writing, no browser implements it.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Most of the code for the plugin presented here is based on
<a href="http://stackoverflow.com/a/27422370/434799">this StackOverflow answer</a>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/jinja-reload-macro-files.html#jinja-reload-macro-files">Reload Jinja macro&nbsp;files</a></h2>
    <p>
      Posted on Thu 24 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/jinja.html">Jinja</a>,      <a href="http://xion.io/tag/flask.html">Flask</a>,      <a href="http://xion.io/tag/werkzeug.html">Werkzeug</a>,      <a href="http://xion.io/tag/flask-script.html">Flask-Script</a>      &#8226; <a href="http://xion.io/post/code/jinja-reload-macro-files.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>The integration between <a href="http://jinja.pocoo.org">Jinja templating engine</a> and the
<a href="http://flask.pocoo.org">Flask microframework</a> for Python is quite seamless most of the time. It also facilitates
rapid development: when we run our web application through Flask&#8217;s development server, any changes in Python code
will get picked up immediately without restarting it. Similarly, Jinja&#8217;s default template loader will detect
whether any template has been modified after its last compilation and recompile it if&nbsp;necessary.</p>
<p>One instance when it <em>doesn&#8217;t</em> seem to work that well, though, is template files that only contain
<a href="http://jinja.pocoo.org/docs/dev/templates/#macros">Jinja macros</a>. They apparently aren&#8217;t subject to the same caching
rules that apply to regular templates. Modifications to those files alone may not be picked up by Jinja <code>Environment</code>,
causing <a href="http://flask.pocoo.org/docs/0.10/api/#flask.render_template"><code>render_template</code> calls</a> in Flask
to (indirectly) use their stale&nbsp;versions.</p>
<h4>I&#8217;ll be watching&nbsp;you</h4>
<p>This problem can be alleviated by making the server watch those macro files explicitly, not unlike the Python sources
it already monitors. When running a Flask server through
<a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.run">the <code>Flask.run</code> method</a>, you can pass additional keyword arguments
which aren&#8217;t handled by Flask itself, but by the underlying <a href="http://wsgi.readthedocs.org/en/latest/what.html"><span class="caps">WSGI</span></a>
scaffolding called <a href="http://werkzeug.pocoo.org/">Werkzeug</a>. The automatic reloader is actually part of it and is quite
configurable. Most importantly, it allows passing a list of <code>extra_files=</code> to&nbsp;watch:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PORT&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)),</span>
        <span class="n">extra_files</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">template_folder</span><span class="p">,</span> <span class="s">&#39;macros.html&#39;</span><span class="p">)])</span>
</pre></div>


<p>But of course it&#8217;s tedious and error-prone to keep this list up to date manually, so let&#8217;s try to do&nbsp;better.</p>
<h4>&#8230;all of&nbsp;you</h4>
<p>I&#8217;m going to assume you&#8217;re keeping all your Jinja macro files inside a single directory. This makes sense,
as macros are reusable pieces of template code that are imported by multiple regular templates,
so they shouldn&#8217;t be scattered around the codebase without some order. The folder may be named <em>macros</em>, <em>util</em>,
<em>common</em>, or similar; what&#8217;s important is that all the macros have a designated place in the project source&nbsp;tree.</p>
<p>Under this assumption, it&#8217;s not difficult to programmatically compute their complete list<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">myapplication</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c"># Flask application object</span>


<span class="c">#: Directories under app&#39;s template folder that contain files</span>
<span class="c">#: with only Jinja macros.</span>
<span class="n">JINJA_MACRO_DIRS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;macros&#39;</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">get_extra_files</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns an iterable of the extra files that the Flask server</span>
<span class="sd">    should monitor for changes and reload the app if any has been modified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">app_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">JINJA_MACRO_DIRS</span><span class="p">:</span>
        <span class="n">macros_dir</span> <span class="o">=</span> <span class="n">app_root</span> <span class="o">/</span> <span class="n">app</span><span class="o">.</span><span class="n">template_folder</span> <span class="o">/</span> <span class="n">dirname</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">macros_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">&#39;*.html&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>


<p>If you&#8217;re using Flask <a href="http://flask.pocoo.org/docs/0.10/blueprints/">blueprints</a>,
in addition to the global application templates you&#8217;d also want to monitor any blueprint-specific macro&nbsp;files:</p>
<div class="highlight"><pre>        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">blueprints</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">macros_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">bp</span><span class="o">.</span><span class="n">template_folder</span> <span class="o">/</span> <span class="n">dirname</span>
            <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">macros_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">&#39;*.html&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>


<h4>A new&nbsp;start</h4>
<p>How you&#8217;re going to use the <code>get_extra_files</code> function from the snippet above depends on how exactly you&#8217;re running
the Flask development server. In the simplest case, when <code>Flask.run</code> is invoked at the top-level scope of some module,
it&#8217;s pretty&nbsp;obvious:</p>
<div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">extra_files</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">get_extra_files</span><span class="p">()))</span>
</pre></div>


<p>More realistically, though, you may be using the <a href="http://flask-script.readthedocs.org/">Flask-Script</a> extension
for all management tasks, including starting the server. If so, calling <code>Flask.run</code> will be relegated to it,
so you&#8217;ll need to override the <code>Server</code> command to inject additional parameters&nbsp;there:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask.ext.script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Server</span> <span class="k">as</span> <span class="n">_Server</span>

<span class="kn">from</span> <span class="nn">myapplication</span> <span class="kn">import</span> <span class="n">app</span>


<span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">_Server</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;use_reloader&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;extra_files&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_extra_files</span><span class="p">())</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">with_default_commands</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PORT&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)))</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
</pre></div>


<p>This new <code>server</code> command should work just like the default one provided by Flask-Script out of the box,
except that all your Jinja macro files will now be monitored for&nbsp;changes.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Like <a href="http://xion.io/post/code/flask-auto-error-pages.html">before</a>, I&#8217;m using the
<a href="https://docs.python.org/3/library/pathlib.html"><em>pathlib</em> module</a>, for which there is a
<a href="https://pypi.python.org/pypi/pathlib/">backport</a> if you&#8217;re using Python 3.3 or older.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/memcached-purge-local.html#memcached-purge-local">Purging local&nbsp;Memcached</a></h2>
    <p>
      Posted on Sat 19 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/memcache.html">memcache</a>,      <a href="http://xion.io/tag/memcached.html">Memcached</a>,      <a href="http://xion.io/tag/expect.html">expect</a>,      <a href="http://xion.io/tag/caching.html">caching</a>,      <a href="http://xion.io/tag/scripting.html">scripting</a>,      <a href="http://xion.io/tag/tcl.html">Tcl</a>      &#8226; <a href="http://xion.io/post/code/memcached-purge-local.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://memcached.org/">Memcached</a> is a ubiquitous caching solution, most commonly used to speed things up
in web application backends. You deploy it as a separate binary and have your application servers talk to it
before querying a database, calling a third party <span class="caps">API</span> over <span class="caps">HTTP</span>, or performing some other time-consuming I/O operation.
Since it stores data in memory, as its name obviously suggests, it can be orders of magnitude faster than anything
that may have to hit a spinning disk (like a database) or an unreliable, external&nbsp;network.</p>
<p>From the point of view of a developer, using Memcached is pretty simple.
There exist <a href="https://code.google.com/p/memcached/wiki/Clients">numerous libraries</a> that wrap its protocol in a neat,
language-appropriate <span class="caps">API</span>. It does put another requirement on the development environment, of course: you need to have
a working memcached deamon in the background if you want the local server to hit code paths where it retrieves data
from memcache<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. Thankfully, it&#8217;s an extremely popular piece of software, present in basically all
<a href="https://code.google.com/p/memcached/wiki/NewInstallFromPackage">package repositories</a>,
so having it up and running is just one <code>apt-get install</code> or <code>brew install</code> away.</p>
<h4>How to&nbsp;flush</h4>
<p>It&#8217;s a little dated and finicky piece of software, too. Once you have its local instance used for a while,
there comes a time when you&#8217;d like to purge all its contents and have your server(s) fill it up again.
Rather than restarting the daemon (which is system-specific procedure that may require root privileges),
you&#8217;d like to just issue the <code>flush_all</code> command to&nbsp;it.</p>
<p>This <em>should</em> be easy. Unlike <a href="http://redis.io/">Redis</a>, however, memcached doesn&#8217;t come with a dedicated <span class="caps">CLI</span> client.
In theory, it doesn&#8217;t have to, because you can talk to it over just <code>telnet</code>:</p>
<div class="highlight"><pre><span class="nv">$ </span>telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">&#39;^]&#39;</span>.
flush_all
OK
^<span class="o">]</span>

telnet&gt; quit
Connection closed.
</pre></div>


<p>But going through this rigmarole every time we want to flush memcache gets a bit tedious after a while.
An obvious attempt at automating it will, however,&nbsp;fail:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;flush_all\n&quot;</span> <span class="p">|</span> telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">&#39;^]&#39;</span>.
Connection closed by foreign host.
</pre></div>


<p>Turns out the you cannot just bombard memcached with <code>flush_all</code> (or any other command) while the connection
is being established. You can of course try adding a <code>sleep</code> to allow it some time, but this is inherently unreliable,
especially when connecting to remote&nbsp;servers.</p>
<p>The most successful approach I&#8217;ve managed to find is to automate not the raw data exchange,
but the <em>interactive <code>telnet</code> session itself</em>. By that I mean invoking a <code>telnet</code> command, observing its output
and reacting to it &#8212; just like a human would do, but in a scripted, automated&nbsp;way.</p>
<h4>Nobody expects the Telnet&nbsp;instrumentation</h4>
<p>There is a dedicated Unix program for scripting just this kind of <span class="caps">CLI</span> interactions. It&#8217;s decidedly more obscure
than mere <code>echo</code> or pipes, but should nonetheless be available for any modern (or ancient) Unix system,
from Linuxes to <span class="caps">OSX</span>. Its name is <code>expect</code> and &#8212; if installed<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> &#8212; the usual place you can find it is
<code>/usr/bin</code> or <code>/usr/local/bin</code>.</p>
<p><code>expect</code> accepts commands and scripts written in <a href="https://en.wikipedia.org/wiki/Tcl">Tcl</a> &#8212; a scripting language
whose syntax looks a bit like a mix of <span class="caps">PHP</span> and Objective-C. It&#8217;s a fully featured language with all the usual
programming constructs you&#8217;d normally want but <code>expect</code> enhances it further with instructions dedicated to spawning
external processes, reading their output, and sending input in&nbsp;response.</p>
<p>In fact, the main commands of the <code>expect</code> program are <code>spawn</code>, <code>expect</code>, and <code>send</code>. Mashing them together,
we can easily nail the crucial part of our memcache-purging&nbsp;script:</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/expect</span>

<span class="nv">spawn</span> telnet localhost <span class="mi">11211</span><span class="k">;</span>
<span class="nv">expect</span> <span class="s2">&quot;Connected to localhost&quot;</span><span class="k">;</span>
<span class="nv">send</span> <span class="s2">&quot;flush_all\n&quot;</span><span class="k">;</span>
</pre></div>


<p>This performs the actual flush but the <code>telnet</code> session/process is kept open afterwards.
Once the <code>expect</code> program ends (after finishing our script), that process may get orphaned and hog system resources.
To prevent that, we should behave like a good Unix citizen and <em>wait</em> for our child processes to&nbsp;terminate:</p>
<div class="highlight"><pre><span class="nv">wait</span><span class="k">;</span>
</pre></div>


<p>But obviously, this will never happen, because we&#8217;ve never instructed the <code>telnet</code> process to&nbsp;end!</p>
<h4>Escape&nbsp;artist</h4>
<p>Your first instinct may be to send <code>^C</code> (<span class="caps">SIGINT</span>) or <code>^D</code> (end-of-file) to the <code>telnet</code> process
but this won&#8217;t work either. Everything we type inside an active Telnet session is sent to the remote server,
and that includes those two key&nbsp;chords.</p>
<p>Authors of the <code>telnet</code> program were of course aware of this problem. As a countermeasure, they introduced the concept
of an <em>escape character</em> that allows the user to control the Telnet connection itself &#8212; including, but not limited to,
its termination. When encountered in the input stream, the escape character causes <code>telnet</code> to temporally suspend
its normal operation, &#8220;escaping&#8221; from the client-server session to a simple command shell of the <code>telnet</code> program itself.
(This is indicated by the <code>telnet&gt;</code> prompt).</p>
<p>The default escape character is <code>^]</code>, which can be easily typed on a keyboard using the key combination <em>Ctrl+]</em>.
The <code>expect</code> program, however, only simulates typing real characters. Coupled with some syntactical quirks of the Tcl
language, this makes the usage of <code>^]</code> as an escape character rather cumbersome, to say the&nbsp;least.</p>
<p>Fortunately, this default can be changed rather easily with an <code>-e</code> flag to the <code>telnet</code> application.
After setting it to something more common but still outside of the memcache protocol &#8212; such as the exclamation mark &#8212;
we are now able to <code>send</code> it without an&nbsp;issue:</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/expect</span>

<span class="k">set</span> escapechar <span class="o">!</span><span class="k">;</span>

<span class="nv">spawn</span> telnet <span class="o">-</span>e <span class="nv">$escapechar</span> localhost <span class="mi">11211</span><span class="k">;</span>
<span class="nv">expect</span> <span class="s2">&quot;Connected to localhost&quot;</span><span class="k">;</span>
<span class="nv">send</span> <span class="s2">&quot;flush_all\n&quot;</span><span class="k">;</span>

<span class="nv">send</span> <span class="nv">$escapechar</span><span class="k">;</span>
<span class="nv">expect</span> <span class="s2">&quot;telnet&gt;&quot;</span><span class="k">;</span>
<span class="nv">send</span> <span class="s2">&quot;quit\n&quot;</span><span class="k">;</span>
<span class="nv">wait</span><span class="k">;</span>
</pre></div>


<p>The script will also terminate despite <code>wait</code>ing for the <code>telnet</code> process to finish, which means everything has been
shut down&nbsp;gracefully.</p>
<h4>Production-ready</h4>
<p>As a final touch, it&#8217;d be nice to make our solution work with any memcache server and not just <em>localhost</em>.
You can see it done in <a href="https://gist.github.com/Xion/624979b05e0411324eb1">this gist</a>: the script accepts
two optional arguments (host <span class="amp">&amp;</span> port) and uses it when spawning the <code>telnet</code> process.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It probably goes without saying that any value in the memcache, as well as the entire memcached server (or servers),
must be treated as potentially unavailable at any time. A properly written application server should still be able
to service all requests &#8212; if only a little slower &#8212; without any (mem)caching at all.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>On all distros, as well as in Homebrew for <span class="caps">OSX</span>, it should be available as a package with a totally uncreative
name of <code>expect</code>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/js-mailto-urls.html#js-mailto-urls">mailto: URLs in&nbsp;JavaScript</a></h2>
    <p>
      Posted on Tue 15 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/javascript.html">JavaScript</a>,      <a href="http://xion.io/tag/email.html">email</a>,      <a href="http://xion.io/tag/url.html">URL</a>      &#8226; <a href="http://xion.io/post/code/js-mailto-urls.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Though not as popular as back in the days, <code>mailto:</code> URLs are sometimes still the best way
&#8212; and most certainly the easiest &#8212; to enable users to send emails from a web application. Typically, they are used
in plain regular links that are created with the <code>&lt;a&gt;</code> tag:</p>
<div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;mailto:john.doe@example.com&quot;</span><span class="nt">&gt;</span>Send email<span class="nt">&lt;/a&gt;</span>
</pre></div>


<p>Depending on the operating system and browser settings, clicking on such a link could invoke a different mail client.
In the past, this could cause much confusion if the user has never used its local email application (e.g. Outlook),
but nowadays browsers are increasingly doing the right thing and presenting a choice of possible options.
This includes the various web applications from popular email providers. User can thus choose &#8212; say &#8212; Gmail, and have
all subsequent <code>mailto:</code> links take them to a <em>Compose Mail</em> view&nbsp;there.</p>
<p>Given those developments, it&#8217;s possible that soon those URLs won&#8217;t be as quaint as they used to be ;)
In any case, I think it&#8217;s worthwhile to have a few <code>mailto:</code> tricks up our sleeve for when they turn out to be
an appropriate solution for the task at&nbsp;hand.</p>
<h4>Triggering them in&nbsp;JavaScript</h4>
<p>In the example above, I&#8217;ve used a <code>mailto:</code> <span class="caps">URL</span> directly in some <span class="caps">HTML</span> markup. For the most part, however, those URLs
behave like any other and support a lot of the same functionality that <code>http://</code> URLs&nbsp;do:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;mailto:&#39;</span> <span class="o">+</span> <span class="nx">address</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Predictably, calling this <code>sendEmail</code> function is equivalent to clicking on a <code>mailto:</code> link. This additional level
of indirection, however, may be enough to fool some web crawlers that look for email addresses to spam. Its effectiveness
depends largely on how radically we&#8217;re going to obfuscate the <code>address</code> argument in the actual&nbsp;invocation.</p>
<p>More importantly, though, a function like that can be part of some more complicated logic. The only limitation is
the same one that restricts where and when it&#8217;s possible to <code>window.open</code> another browser window. Namely, it has to be
called in a direct response to a <span class="caps">UI</span> action triggered by the user (a button click would be a good&nbsp;example).</p>
<h4>Customization</h4>
<p>In their simplest form, <code>mailto:</code> URLs aren&#8217;t terribly interesting, since their only parameter is the address of a sole recipient. Fortunately, this isn&#8217;t where their capabilities end: it&#8217;s possible to customize other email fields as well,
such as the subject or even body<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>Somewhat surprisingly, all this can be done in a manner that&#8217;s more typical for <code>http://</code> <span class="caps">URL</span>: with query string
parameters. Right after the recipient&#8217;s address, we can drop a question mark and add some ampersand-separated
key-value&nbsp;pairs:</p>
<div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;mailto:john.doe@example.com?subject=Hi&amp;amp;body=Hello%20John!&quot;</span><span class="nt">&gt;</span>
  Say hello to John!
<span class="nt">&lt;/a&gt;</span>
</pre></div>


<p>A more programmatic approach is of course also possible. One thing we need to remember, though, is the proper escaping
of input values in order to make them safe to put inside an <span class="caps">URL</span><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>.
The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent"><code>encodeURIComponent</code> function</a> can be used for this&nbsp;purpose:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getMailtoUrl</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">subject</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;subject=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">subject</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">body</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;body=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;mailto:&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>In theory, almost any of the numerous <a href="https://en.wikipedia.org/wiki/Email#Header_fields">email headers</a> can be specified
this way. However, support may vary across browsers, especially since some of the headers
(like <a href="https://en.wikipedia.org/wiki/Blind_carbon_copy">the <code>Bcc:</code> one</a>) are subject to certain security
or privacy considerations. Personally, I wouldn&#8217;t recommend relying on anything besides
<code>subject=</code> and <code>body=</code>, with a possible addition of <code>cc=</code> for
<a href="https://en.wikipedia.org/wiki/Carbon_copy">the <code>Cc:</code>header </a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>By <a href="http://www.ietf.org/rfc/rfc2368.txt"><span class="caps">RFC</span> 2368</a>, only <em>text/plain</em> email body can be specified this way.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Note that this is unrelated to the <em><span class="caps">HTML</span></em> escaping of <code>&amp;</code> character as <code>&amp;amp;</code> entity in the previous example.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/requests-query-string-auth.html#requests-query-string-auth">Query string authentication in&nbsp;Requests</a></h2>
    <p>
      Posted on Fri 11 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/requests.html">Requests</a>,      <a href="http://xion.io/tag/http.html">HTTP</a>,      <a href="http://xion.io/tag/authentication.html">authentication</a>      &#8226; <a href="http://xion.io/post/code/requests-query-string-auth.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://python-requests.org">Requests</a> is a widely used Python library that provides a nicer <span class="caps">API</span> for writing <span class="caps">HTTP</span> clients
than the standard <code>urllib2</code> module does. It deals with authentication in an especially concise way: through
a simple <code>auth=</code> argument, rather than a
<a href="https://gist.github.com/kennethreitz/973705">separate password manager <span class="amp">&amp;</span> authentication handler</a> or other such&nbsp;nonsense.</p>
<p>There are <a href="http://docs.python-requests.org/en/latest/user/authentication/">several possible ways</a>
to authenticate an <span class="caps">HTTP</span> call with Requests, and it&#8217;s pretty easy to
<a href="http://docs.python-requests.org/en/latest/user/authentication/#new-forms-of-authentication">implement our own approach</a>
if the server requires it. All the built-in ways, however, as well as
<a href="http://docs.python-requests.org/en/latest/user/advanced/#custom-authentication">the examples of custom implementations</a>,
are heavily biased towards using <span class="caps">HTTP</span> headers to transmit the necessary credentials (such as username/password
or some kind of opaque&nbsp;token).</p>
<h4>Non-standard&nbsp;auth</h4>
<p>This is actually quite reasonable: the most popular authentication methods, including OAuth 1.0 <span class="amp">&amp;</span> 2.0, use <span class="caps">HTTP</span> headers
either primarily or&nbsp;exclusively.</p>
<p>Not every <span class="caps">HTTP</span> <span class="caps">API</span> follows this convention, though. Sometimes, credentials are put in other parts of the request,
commonly the <span class="caps">URL</span> itself. It may seem like a bad idea at first but it can also be perfectly acceptable:
credentials don&#8217;t have to expose secrets of any particular <em>user</em> of the remote&nbsp;system.</p>
<p><a href="http://steamcommunity.com/dev">Steam <span class="caps">API</span></a> is a good example here. Calling any of
<a href="https://developer.valvesoftware.com/wiki/Steam_Web_API#Interfaces_and_method">its endpoints</a> requires providing
an <span class="caps">API</span> key but it grants no special rights to access data of any particular Steam user. All the information
it returns is already visible on their public profile<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>For those special authentication schemes, Requests necessitate rolling out our own implementation.
Thankfully, doing so is mostly pretty&nbsp;straightforward.</p>
<h4>Simple&nbsp;example</h4>
<p>All Requests&#8217; authenticators are callable objects inheriting from <code>requests.auth.AuthBase</code> class.
Writing your own is hence a matter of defining a subclass of <code>AuthBase</code> with at least a <code>__call__</code> method:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">SillyAuth</span><span class="p">(</span><span class="n">AuthBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;X-ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;im valid so auth is yes&#39;</span>
        <span class="k">return</span> <span class="n">request</span>

<span class="c"># usage</span>
<span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://example.com&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">SillyAuth</span><span class="p">())</span>
</pre></div>


<p>The job of an authenticator is to modify the <code>request</code> so that it includes appropriate credentials in whatever form
necessary to have them accepted by the remote server. Like I&#8217;ve mentioned before, <span class="caps">HTTP</span> headers are the most common option,
but the request can be modified in other ways as&nbsp;well.</p>
<h4>Query string&nbsp;parameters</h4>
<p>One problem with modifying a query string, though, is that it&#8217;s a part of request <span class="caps">URL</span>. By the time it reaches
authenticators, the Requests library has already merged any additional query params into it<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. Including more params
will thus require modifying the <span class="caps">URL</span>.</p>
<p>Though it may sound like a risky endeavour involving string manipulations that are fraught with security issues,
it&#8217;s not really <em>that</em> bad at all. In fact, the Requests library provides an <span class="caps">API</span> to do exactly&nbsp;this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">QueryStringAuth</span><span class="p">(</span><span class="n">AuthBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Authenticator that attaches a set of query string parameters</span>
<span class="sd">    (e.g. an API key) to the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">prepare_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>
</pre></div>


<p>Albeit <a href="http://docs.python-requests.org/en/latest/api/#requests.PreparedRequest.prepare_url">scantly documented</a>,
the <code>prepare_url</code> method will take an existing <span class="caps">URL</span> and a dictionary of query string params, and outfit the request
with a brand new <span class="caps">URL</span> that contains those params neatly&nbsp;encoded.</p>
<p>Full implementation of <code>QueryStringAuth</code> is a <a href="https://gist.github.com/Xion/9c1bbbc287d4443dbaf5">little more involved</a>
than the snippet above, because we should like to replicate all the idiosyncracies of how
<a href="http://docs.python-requests.org/en/latest/user/quickstart/#passing-parameters-in-urls">regular Requests <span class="caps">API</span></a>
handles query string params. Some of them &#8212; like allowing both strings and lists as param values &#8212; are taken care of
by <code>prepare_url</code> itself, but the rest should be dealt with on our&nbsp;own.</p>
<h4>Usage</h4>
<p>To finish up, let&#8217;s use this authenticator to call Steam <span class="caps">API</span> and return a
<a href="https://developer.valvesoftware.com/wiki/Steam_Web_API#GetOwnedGames_.28v0001.29">list of games</a>
that a given user owns but hasn&#8217;t played&nbsp;yet:</p>
<div class="highlight"><pre><span class="n">STEAM_API_KEY</span> <span class="o">=</span> <span class="s">&#39;a1b2c3d4e5f6g7h8i9j&#39;</span>  <span class="c"># not a real one, of course</span>


<span class="k">def</span> <span class="nf">get_steam_backlog</span><span class="p">(</span><span class="n">steam_id</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;steamid&#39;</span><span class="p">:</span> <span class="n">steam_id</span><span class="p">,</span>
        <span class="s">&#39;include_appinfo&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">QueryStringAuth</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">STEAM_API_KEY</span><span class="p">))</span>
    <span class="n">games</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;response&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;games&#39;</span><span class="p">,</span> <span class="p">())</span>

    <span class="k">for</span> <span class="n">game</span> <span class="ow">in</span> <span class="n">games</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">game</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;playtime_forever&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">yield</span> <span class="n">game</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
</pre></div>


<p>We could&#8217;ve put <code>STEAM_API_KEY</code> directly in <code>params</code>, of course. Singling it out explicitly as an authentication
detail, however, makes the code clearer and plays nicely with more advanced features of Requests,
such as <a href="http://docs.python-requests.org/en/latest/user/advanced/#session-objects">sessions</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It can be said that only in this case we&#8217;re dealing with exclusively <em>authentication</em>, whereas the others
also perform <em>authorization</em>. I wouldn&#8217;t quibble too much about those details. The fact that both terms are often
shortened to &#8220;auth&#8221; doesn&#8217;t exactly help with distinguishing them anyway.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>In fact, what <code>AuthBase.__call__</code> receives is a special
<a href="http://docs.python-requests.org/en/latest/user/advanced/#prepared-requests"><code>PreparedRequest</code> object</a> which contains
the exact bytes that&#8217;ll be sent to the server. Most of the higher level abstractions offered by the Requests library
(like form data or <span class="caps">JSON</span> request body) has been compiled to raw octets at this point. This is done to allow
some authenticators (like OAuth) to analyze the full request payload and sign it cryptographically
as a part of their flow.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/flask-auto-error-pages.html#flask-auto-error-pages">Automatic error pages in&nbsp;Flask</a></h2>
    <p>
      Posted on Tue 08 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/flask.html">Flask</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/http.html">HTTP</a>,      <a href="http://xion.io/tag/errors.html">errors</a>      &#8226; <a href="http://xion.io/post/code/flask-auto-error-pages.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In <a href="http://flask.pocoo.org">Flask</a>, a popular web framework for Python, it&#8217;s pretty easy to implement custom handlers
for specific <span class="caps">HTTP</span> errors. All you have to do is to write a function and annotate it with the <code>@errorhandler</code> decorator:</p>
<div class="highlight"><pre><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;errors/404.html&#39;</span><span class="p">)</span>
</pre></div>


<p>Albeit simple, the above example is actually very realistic. There&#8217;s rarely anything else to do in response to serious
request error than to send back some <span class="caps">HTML</span> with an appropriate message. If you have more handlers like that, though,
you&#8217;ll notice they get pretty repetitive: for each erroneous <span class="caps">HTTP</span> status code (404, 403, 400, etc.),
pick a corresponding template and simply render&nbsp;it.</p>
<p>Which is, of course, why we&#8217;d want to deal with all in a little smarter way and with less&nbsp;boilerplate.</p>
<h4>Just add a&nbsp;template</h4>
<p>Ideally, we would like to avoid writing any Python code at all for each individual error handler. Since all we&#8217;re doing
revolves around predefined templates, let&#8217;s just define the handlers automatically based on the <span class="caps">HTML</span> files&nbsp;themselves.</p>
<p>Assuming we store them in the same template directory &#8212; say, <code>errors/</code> &#8212; and name their files after
numeric status codes (e.g. <em>404.html</em>), getting all those codes is quite simple<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PurePath</span>

<span class="kn">from</span> <span class="nn">mywebapp</span> <span class="kn">import</span> <span class="n">app</span>


<span class="c">#: Path to the directory where HTML templates for error pages are stored.</span>
<span class="n">ERRORS_DIR</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="s">&#39;errors&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_supported_error_codes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns an iterable of HTTP status codes for which we have</span>
<span class="sd">    a custom error page templates defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_templates_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">template_folder</span><span class="p">,</span> <span class="n">ERRORS_DIR</span><span class="p">)</span>

    <span class="n">potential_error_templates</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">error_templates_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&#39;*.html&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">potential_error_templates</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>  <span class="c"># e.g. 404.html</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c"># could be some base.html template, or similar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s">&quot;Found error template for non-error HTTP status </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">code</span>
</pre></div>
</td></tr></table>

<p>Once we have them, we can try wiring up the handlers programmatically and making them do the right&nbsp;thing.</p>
<h4>One function to handle them&nbsp;all</h4>
<p>Although I&#8217;ve used a plural here, in reality we only need a single handler, as it&#8217;ll be perfectly capable of
dealing with any <span class="caps">HTTP</span> error we bind it to. To help distinguishing between the different status codes,
Flask by default invokes our error handlers with an
<a href="http://werkzeug.pocoo.org/docs/0.10/exceptions/#werkzeug.exceptions.HTTPException"><code>HTTPException</code></a> argument
that has the <code>code</code> as an&nbsp;attribute:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">TemplateNotFound</span>


<span class="k">def</span> <span class="nf">error_handler</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Universal handler for all HTTP errors.</span>

<span class="sd">    :param error: :class:`~werkzeug.exceptions.HTTPException`</span>
<span class="sd">                  representing the HTTP error.</span>

<span class="sd">    :return: HTTP response to be returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s">&quot;Got spurious argument to HTTP error handler: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FATAL_ERROR_RESPONSE</span>

    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;HTTP error </span><span class="si">%s</span><span class="s">, rendering error page&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">ERRORS_DIR</span> <span class="o">/</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.html&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">template</span><span class="p">)),</span> <span class="n">code</span>
    <span class="k">except</span> <span class="n">TemplateNotFound</span><span class="p">:</span>
        <span class="c"># shouldn&#39;t happen if the handler has been wired up properly</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Missing template for HTTP error page: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FATAL_ERROR_RESPONSE</span>

<span class="c">#: Response emitted when an error occurs in the error handler itself.</span>
<span class="n">FATAL_ERROR_RESPONSE</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Internal Server Error&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>Catching <code>TemplateNotFound</code> exception is admittedly a little paranoid here, as it can occur pretty much exclusively
due to a programming error elsewhere. Feel free to treat it as a failed assertion about application&#8217;s internal state
and e.g. convert to <code>AssertionError</code> if&nbsp;desirable.</p>
<h4>The&nbsp;setup</h4>
<p>The final step is to actually set up the&nbsp;handler(s):</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">get_supported_error_codes</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">code</span><span class="p">)(</span><span class="n">error_handler</span><span class="p">)</span>
</pre></div>


<p>It may look a bit wonky, but it&#8217;s just a simple desugaring of the standard Python decorator syntax from the first example.
There exists a more direct approach of putting the handler inside <code>app.error_handler_spec</code> dictionary,
but it is <a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.errorhandler">discouraged by Flask documentation</a>.</p>
<p>Where to put the above code, though? I posit it&#8217;s perfectly fine to place in the module&#8217;s global scope,
because the error handlers (and other request handlers) are traditionally defined at import time&nbsp;anyway.</p>
<p>Also notice that the default error handling we&#8217;ve defined here doesn&#8217;t preclude more specialized variants
for select <span class="caps">HTTP</span> codes. All you have to do is ensure that your custom <code>@app.errorhandler</code> definition occurs
<em>after</em> the above&nbsp;loop.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Note that I&#8217;m using the <a href="https://docs.python.org/3/library/pathlib.html"><em>pathlib</em> module</a> here
&#8212; and you should, too, since it&#8217;s all around awesome. However, it is only a part of the standard library
since Python 3.4, so you will most likely need to get <a href="https://pypi.python.org/pypi/pathlib/">the backport</a> first.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://xion.io/index8.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
    <a class="btn float-right" href="http://xion.io/index6.html">
      Newer Posts <i class="fa fa-angle-right"></i>
    </a>
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2019 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>