<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/thoughts/in-microsoft-we-trust.html#in-microsoft-we-trust">In Microsoft we&nbsp;trust</a></h2>
    <p>
      Posted on Fri 08 April 2016 in <a href="http://xion.io/category/thoughts.html">Thoughts</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/microsoft.html">Microsoft</a>,      <a href="http://xion.io/tag/windows.html">Windows</a>,      <a href="http://xion.io/tag/github.html">GitHub</a>,      <a href="http://xion.io/tag/apple.html">Apple</a>,      <a href="http://xion.io/tag/facebook.html">Facebook</a>,      <a href="http://xion.io/tag/google.html">Google</a>,      <a href="http://xion.io/tag/tech-culture.html">tech culture</a>      &#8226; <a href="http://xion.io/post/thoughts/in-microsoft-we-trust.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Just like many other people, I was following news from the last week&#8217;s
<a href="https://build.microsoft.com/"><span class="caps">BUILD</span> conference</a> with piqued interest. The ability to run Linux userland programs
on Windows &#8212; including, of course,
<a href="http://techcrunch.com/2016/03/30/be-very-afraid-hell-has-frozen-over-bash-is-coming-to-windows-10/">bash</a> &#8212;
is something to be excited about. If nothing else, it should dramatically improve Windows support of new programming
languages that seem to pop up all the&nbsp;time.</p>
<p>There was something else, however, that I couldn&#8217;t help but notice. The reactions of tech communities to this and similar developments focused very frequently on Microsoft&nbsp;itself.</p>
<p>The beloved &#8220;new Microsoft&#8221;,
as <a href="https://www.reddit.com/r/programming/comments/4cqm9y/xamarin_becomes_free_and_opensource/d1kjwl8">some call it</a>,
embraces open source, supports Linux, and generally does almost a full 180 with their stance on
proprietary vs. free software. The circumstances fit this narrative rather snuggly, too: a new <span class="caps">CEO</span> makes a clean break
with the past to pivot the company in this new world ruled by mobile and&nbsp;cloud.</p>
<p>Still&#8230; <em>love</em>? Even considering how Internet comments are grotesquely exaggerated most of the time, that&#8217;s quite
a declaration. The sentiment is nowhere near isolated either. But it&#8217;s not a question whether this infatuation
has a rational merit, or whether those feelings will eventually turn out to be&nbsp;misplaced.</p>
<p>The question is: why does it exist at all? We are talking about a <em>company</em> here, a for-profit organization.
How can such a language even enter the&nbsp;picture?</p>
<p>Then I realized this is not really a new phenomenon. Quite the opposite: the broad developer community seems to
always need a company to champion its core values. Nowadays, we&#8217;re simply trying to find someone new
to carry the&nbsp;standard.</p>
<p>Why? Because we feel that our old heroes have forsaken&nbsp;us.</p>
<h4>Hall of past&nbsp;fame</h4>
<p>Take <strong>GitHub</strong> for example. Once a darling of the open source community, it&#8217;s been suffering sharp criticism
for many months now. Rightfully or not, many people aren&#8217;t exactly excited &#8212; to put it mildly &#8212; about changes to
the <a href="https://github.com/blog/2146-organizations-can-now-block-abusive-users">policy</a>
and <a href="https://github.com/blog/2039-adopting-the-open-code-of-conduct">atmosphere</a> at GitHub,
typified by the ill-fated <a href="http://www.businessinsider.com/githubs-ceo-ditches-meritocracy-rug-2014-1">meritocracy rug</a>.
The widely backed and long standing <a href="https://github.com/dear-github/dear-github">plea for a few critical features</a>
has only recently stopped falling on deaf ears. And in the background, there are always concerns about GitHub simply
<a href="https://news.ycombinator.com/item?id=10823128">becoming too big</a>, and exterting too much control over
the open source&nbsp;ecosystem.</p>
<p><em>Nota bene</em>, the very same ecosystem it had once been lauded for&nbsp;nurturing.</p>
<p>Among the other flagship tech companies, <strong>Apple</strong> or <strong>Facebook</strong> have never garnered much good will. Sure, they are
recognized for the pure utilitarian value of hardware they produce; or convenience, broad applicability, and stability
of APIs they offer. Facebook may be scoring some additional points for trying to
<a href="https://facebook.github.io/react/">sort out</a> the mess of frontend development, but many say it&#8217;s
<a href="https://medium.com/@ericclemmons/javascript-fatigue-48d4011b6fc4#.j740brod8">not doing anybody any favors</a>.
Neither company is easy to portray as a paragon of openness, though, and it&#8217;s probably easier to argue
<a href="http://www.ibtimes.co.uk/apples-closed-ecosystem-threatening-derail-technological-revolution-1535944">the exact opposite</a>.</p>
<p>And then there is <strong>Google</strong>, of course<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. Some time in the past few years, a palpable shift occurred in how
the company is perceived by the techie crowd. It&#8217;s difficult to pinpoint the exact pivotal moment, and the
<a href="https://googleblog.blogspot.com.au/2013/03/a-second-spring-of-cleaning.html">one event that leaps to attention</a>
doesn&#8217;t seem sufficient to explain it. But the tone has been set,
allowing <a href="http://google-opensource.blogspot.com/2015/03/farewell-to-google-code.html">news</a> to be
<a href="https://www.reddit.com/r/programming/comments/2yt73v/google_to_close_google_code_open_source_project/cpdb6xs">molded</a>
to fit it. Add this to the usual backdrop of complaints about the
<a href="https://www.reddit.com/r/cscareerquestions/comments/2ll864/my_horrible_google_interview_experience/">onerous</a>
interview process and general fearmongering, and the picture doesn&#8217;t look very&nbsp;bright.</p>
<h4>Shades of&nbsp;grey</h4>
<p>No similar woes seem to have been plaguing Microsoft as of late, even though their record of recent &#8220;unwholesome&#8221; deeds
isn&#8217;t exactly
<a href="http://www.theinquirer.net/inquirer/news/2447177/updategate-windows-10-is-resetting-default-apps-back-to-microsoft-stock">clean</a>
either. Does it mean they are indeed the most fitting candidate for a (new) enterprise ally of the hacker&nbsp;community?&#8230;</p>
<p>Or maybe we can finally recognize the whole notion as the utterly silly concept it actually is. Hard to shake though
it be, this quasi-Manicheic mentality of assigning labels of virtue or sin is, at best, a naive idealism. At worst,
it&#8217;s a peculiar kind of harmful partisanship that technologists are particularly susceptible to. You may recognize it
as something that has a <a href="https://en.wikipedia.org/wiki/Editor_war">very long tradition</a> in the hacker&nbsp;community.</p>
<p>But it doesn&#8217;t mean it&#8217;s a tradition worth&nbsp;keeping.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>I have no illusions I will be attributed any objectivity, but it bears mentioning
<a href="http://xion.io/page/about.html">again</a> that nothing I say here is representative of anything but my own opinions.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/shell-xargs-into-find.html#shell-xargs-into-find">Pipe `xargs` into&nbsp;`find`</a></h2>
    <p>
      Posted on Sun 03 April 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/shell-scripting.html">shell scripting</a>,      <a href="http://xion.io/tag/bash.html">Bash</a>,      <a href="http://xion.io/tag/xargs.html">xargs</a>,      <a href="http://xion.io/tag/find.html">find</a>,      <a href="http://xion.io/tag/zsh.html">zsh</a>      &#8226; <a href="http://xion.io/post/code/shell-xargs-into-find.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Here&#8217;s a trick that&#8217;s hardly new, but if you haven&#8217;t heard about, it will save you a trip to a man page or&nbsp;two.</p>
<p>Assuming you&#8217;re a person who mostly prefers the terminal over some fancy <span class="caps">GUI</span>, you&#8217;ve probably used the <code>find</code> command
along with <code>xargs</code> at least a few times. It&#8217;s very common, for example, to use the results of <code>find</code> as arguments
to some other program. It could something as simple as figuring out which modules in your project have grown
slightly too&nbsp;large:</p>
<div class="highlight"><pre>$ find . -name &#39;*.py&#39; | xargs wc -l | sort -hr
1467 total
 322 callee/base.py
 261 callee/general.py
 251 callee/collections.py
# etc.
</pre></div>


<p>We find them all first, and then use <code>xargs</code> to build a long <code>wc</code> invocation, and we finally display results
in the reverse order. Pretty easy stuff: I don&#8217;t usually have to try more than a dozen times to get it right!<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<p>But how about the opposite situation? Let&#8217;s say you have a list of <em>directories</em> you want to search through with <code>find</code>.
Doing so may seem easy enough<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre>$ cat packagedirs.txt | xargs find -name &#39;__init__.py&#39;
</pre></div>


<p>Except it&#8217;s not going to work. Like a few other Unix commands, <code>find</code> is very particular about the order of arguments
it receives. Not only are the predicate flags (like <code>-name</code>) considered in sequence, but they also have to appear
<em>after</em> the directories we want to search&nbsp;through.</p>
<p>But in the <code>xargs</code> invocation above, essentially the opposite is going to&nbsp;happen.</p>
<h4>The replacement&nbsp;flag</h4>
<p>So how to remedy this? Enter the <code>-I</code> flag to <code>xargs</code>:</p>
<div class="highlight"><pre>$ cat packagedirs.txt | xargs -I{} find {} -name &#39;__init__.py&#39;
</pre></div>


<p>This flag will tell <code>xargs</code> quite a few&nbsp;things.</p>
<p>The most important one is to stop putting the arguments at the end of the command invocation.
Instead, it shall place them wherever it sees the <em>replacement string</em> &#8212; here, pair of braces<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>: <code>{}</code>.
And because we placed the braces where <code>find</code> is normally expecting the list of directories to search through,
the command will now get us exactly the results we&nbsp;wanted.</p>
<p>What&#8217;s almost impossible to see, however, is that it may not use the exact <em>way</em> we intended to obtain those results.
The difference is easier to spot when we replace <code>find</code> with <code>echo</code>:</p>
<div class="highlight"><pre>$ cat &gt;/tmp/list
foo
bar
$ cat /tmp/list | xargs echo
foo bar
$ cat /tmp/list | xargs -I{} echo {}
foo
bar
</pre></div>


<p>or, better yet, use <code>xargs</code> with the <code>-t</code> flag to print the commands on stderr before executing&nbsp;them:</p>
<div class="highlight"><pre>$ cat packagedirs.txt | xargs -I{} -t find {} -name &#39;__init__.py&#39; &gt;/dev/null
find callee -name &#39;__init__.py&#39;
find tests -name &#39;__init__.py&#39;
</pre></div>


<p>As you can see, we actually have more than one <code>find</code> invocation&nbsp;here!</p>
<p>This is the second effect of <code>-I</code>: it causes <code>xargs</code> to execute given command line <em>for each argument separately</em>.
It so happens that it doesn&#8217;t really make any difference for our usage of <code>find</code>, which is why it wasn&#8217;t at all obvious
we were running it multiple&nbsp;times.</p>
<p>To avoid problems, though, you should definitely be cognizant of this fact when calling other programs with <code>xargs -I</code>.</p>
<h4>Make arguments spaced&nbsp;again</h4>
<p>Incidentally, I&#8217;m not aware of any method that&#8217;d actually make <code>xargs</code> produce <code>find foo bar -name ...</code> calls.
If you need this exact form, probably the easiest way is to use plain old shell&nbsp;variables:</p>
<div class="highlight"><pre>$ (d=$(cat packagedirs.txt); find $d -name &#39;*.py&#39;)
</pre></div>


<p>This takes advantage of the <a href="http://mywiki.wooledge.org/WordSplitting">word splitting</a> feature of Bash and a few other
compatible shells. Caveat is, you may be using a shell where this behavior is disabled by default. The result would be
making <code>find</code> interpret the content of <code>$d</code> as a <em>single</em> directory name: <code>foo bar</code> rather than <code>foo</code> and <code>bar</code>.</p>
<p>zsh is one such shell. Although <a href="http://zsh.sourceforge.net/FAQ/zshfaq03.html#l18">probably a good thing overall</a>,
in times like these you&#8217;d want to bring the &#8220;normal&#8221; behavior back. In zsh, it&#8217;s fortunately pretty&nbsp;simple:</p>
<div class="highlight"><pre>$ (d=$(cat packagedirs.txt); find ${=d} -name &#39;*.py&#39;)
</pre></div>


<p>What about a portable solution? As far as I can tell, the only certain way you can ensure word splitting occurs
is to use <code>eval</code>. Here, the <code>xargs</code> command can actually come in handy again, albeit only as a&nbsp;prop:</p>
<div class="highlight"><pre>$ (d=$(cat packagedirs.txt | xargs echo); eval &quot;find $d -name &#39;*.py&#39;&quot;)
</pre></div>


<p>One would hope such hacks aren&#8217;t needed very&nbsp;often.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>A completely kosher version would also use the <code>-print0</code> flag to <code>find</code> and the <code>-0</code> flag to <code>xargs</code>.
It&#8217;s not necessary here because Python module files cannot contain spaces.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Purists shall excuse my use of <code>cat</code> here, it&#8217;s merely for illustrative purposes.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>This use of braces in <code>find</code> has of course nothing to do with the <em>other</em> possible occurrences of <code>{}</code> there,
like in the <code>-exec</code> flag. Since you cannot force <code>find</code> to expect a different placeholder, you should use something else
for <code>xargs</code> in those cases, .e.g: <code>xargs -I^ find ^ -name '__main__.py' -exec 'python {}' \;</code>.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/package-management.html#package-management">Package managers&#8217; appreciation&nbsp;day</a></h2>
    <p>
      Posted on Sat 26 March 2016 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/packages.html">packages</a>,      <a href="http://xion.io/tag/package-manager.html">package manager</a>,      <a href="http://xion.io/tag/nodejs.html">node.js</a>,      <a href="http://xion.io/tag/npm.html">npm</a>,      <a href="http://xion.io/tag/c.html">C++</a>      &#8226; <a href="http://xion.io/post/programming/package-management.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>By now you have probably heard about the infamous &#8220;npm-gate&#8221; that swept through the developer community
over the last week. It has been
<a href="https://medium.com/@azerbike/i-ve-just-liberated-my-modules-9045c06be67c#.hp7p1aolc">brought up</a>,
<a href="https://medium.com/@mproberts/a-discussion-about-the-breaking-of-the-internet-3d4d2a83aa4d#.rlnh89inz">discussed</a>,
<a href="http://www.theregister.co.uk/2016/03/23/npm_left_pad_chaos/">covered</a>,
<a href="http://www.haneycodes.net/npm-left-pad-have-we-forgotten-how-to-program">meta-discussed</a>,
<a href="http://left-pad.io/">satirized</a>, and even featured by
<a href="http://www.businessinsider.com/npm-left-pad-controversy-explained-2016-3">some mainstream media</a>.
Evidently the nerds have managed to stir up some serious trouble again, and it only took them 11 lines of
that strange thing they call&nbsp;&#8220;code&#8221;.</p>
<h4>No good things in small&nbsp;packages</h4>
<p>When looking for a culprit, the one party that everyone pounced on immediately was of course
the <a href="http://npmjs.com">npm</a> itself. With its myriad of packages that could each fit in a tweet, it invites to create
the exact house of cards we&#8217;ve seen&nbsp;collapse.</p>
<p>This serves as a good wake-up call, of course. But it also compels to throw the baby out with the bathwater,
and draw a conclusion that may be a little too far-fetched. Like perhaps declaring the <em>entire idea</em> of
managing dependencies &#8220;the npm way&#8221; suspect. If packages tend to degenerate into something as ludicrous as
<a href="https://www.npmjs.com/package/isarray"><code>isArray</code></a> &#8212; to say nothing of
<a href="https://www.npmjs.com/package/left-pad"><code>left-pad</code></a>, which started the whole debacle &#8212; then maybe this approach
to software reusability has simply bankrupted&nbsp;itself?</p>
<h4>A world without&nbsp;*pm</h4>
<p>I&#8217;m right away responding to that with a resounding &#8220;No!&#8221;. Package management as a concept is not responsible for
the poor decision making of one specific developer collective. And anyone who might think tools like npm do more
harm than good I ask: have you recently written any&nbsp;C++?</p>
<p>See, C++ is the odd one among languages that at least pretend to be keeping up with the times. It doesn&#8217;t present
a package management story at all. That&#8217;s right &#8212; the C++ &#8220;ecosystem&#8221;, as it stands now,&nbsp;has:</p>
<ul>
<li>no package&nbsp;manager</li>
<li>no repository of&nbsp;packages</li>
<li>no unified way of managing&nbsp;dependencies</li>
<li>no way to isolate development environments of different projects from one&nbsp;another</li>
</ul>
<p>Adding any kind of third-party dependency to a C++ project &#8212; especially a portable one, which is allegedly one of C++&#8217;s
strengths &#8212; is a considerable pain, even when it doesn&#8217;t require any additional libraries by itself. And environment
isolation? Some people are using Linux containers (!) for this, which is like dealing with a mosquito by shooting it
with a&nbsp;howitzer.</p>
<p style="text-align: center">
    <img src="http://xion.io/images/carl-sagan.jpg" alt="Billions upon billions of lines"></br>
    <small>To build a C++ binary, you must first build the userspace.</small>
</p>

<p>But hey, at least they can use <code>apt-get</code>,&nbsp;right?&#8230;</p>
<p>So, string padding incidents aside, package managers are absolutely <em>essential</em>. Sure, we can and should discuss
the merits of their particular flavors and implementation details &#8212;like whether it&#8217;s prudent to allow &#8220;delisting&#8221;
of packages. As a whole, however, package managers deserve recognition as a crucial part of modern language tooling
that we cannot really do&nbsp;without.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/news/callee-intro.html#callee-intro">Introducing callee: matchers for&nbsp;unittest.mock</a></h2>
    <p>
      Posted on Sun 20 March 2016 in <a href="http://xion.io/category/news.html">News</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/testing.html">testing</a>,      <a href="http://xion.io/tag/mocking.html">mocking</a>,      <a href="http://xion.io/tag/argument-matchers.html">argument matchers</a>      &#8226; <a href="http://xion.io/post/news/callee-intro.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Combined with dynamic typing, the lax object model of Python makes it pretty easy to write unit tests that involve
<em>mocking</em> some parts of the tested code. Still, there&#8217;s plenty of third party libraries &#8212; usually with &#8220;mock&#8221; somewhere
in the name &#8212; which promise to make it even shorter and simpler. There&#8217;s evidently been a need here that the standard
library didn&#8217;t address&nbsp;adequately.</p>
<p>It changed, however, with Python 3.3. This version introduced a new
<a href="https://docs.python.org/3/library/unittest.mock.html"><code>unittest.mock</code> module</a> which essentially obsoleted
all the other, third party solutions. The module, available also as a <a href="https://pypi.python.org/pypi/mock">backport</a>
for Python 2.6 and above, is flexible, easy to use, and offers most if not all of the requisite&nbsp;functionality.</p>
<h4>Called it,&nbsp;maybe?</h4>
<p>Well, with one notable exception. If we mock a function, or any other callable&nbsp;object:</p>
<div class="highlight"><pre><span class="c"># (production code)</span>
<span class="k">class</span> <span class="nc">ProductionClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">florb</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c"># (test code)</span>
<span class="n">something</span> <span class="o">=</span> <span class="n">ProductionClass</span><span class="p">()</span>
<span class="n">something</span><span class="o">.</span><span class="n">florb</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
</pre></div>


<p>we have very limited capabilities when it comes to verifying <em>how</em> they were called. Sure, we can be extremely&nbsp;specific:</p>
<div class="highlight"><pre><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s">&#39;this particular string&#39;</span><span class="p">)</span>
</pre></div>


<p>or very&nbsp;lenient:</p>
<div class="highlight"><pre><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>  <span class="c"># works for _any_ argument</span>
</pre></div>


<p>but there is virtually nothing in between. Suppose we don&#8217;t care too much what <em>exact</em> string the method was called with,
only that it was <em>some</em> string that&#8217;s long enough? Things get awkward <em>very</em> fast&nbsp;then:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">posargs</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">:</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">posargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;required call to </span><span class="si">%r</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="p">,))</span>
</pre></div>


<p>Yes, this is what&#8217;s required: an actual loop through all the mock&#8217;s calls<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>; unpacking tuples of positional and keyword
arguments; and manual assertions that won&#8217;t even emit useful error messages when they&nbsp;fail.</p>
<p>Eww! Surely Python can do better than&nbsp;that?</p>
<h4>Meet <code>callee</code></h4>
<p>Why, of course it can! Today, I&#8217;m releasing <a href="https://callee.readthedocs.org"><em>callee</em></a>: a library of <strong>argument matchers</strong>
compatible with <code>unittest.mock</code>. It enables you to write much simpler, more readable,
and delightfully declarative&nbsp;assertions:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">callee</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">LongerOrEqual</span>
<span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">String</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">LongerOrEqual</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</pre></div>


<p>The wide array of matchers offered by <em>callee</em> includes
<a href="https://callee.readthedocs.org/en/latest/reference/numbers.html">numeric</a>,
<a href="https://callee.readthedocs.org/en/latest/reference/strings.html">string</a>,
and <a href="https://callee.readthedocs.org/en/latest/reference/collections.html">collection</a> ones.
And if none suits your particular needs,
it&#8217;s a trivial matter to <a href="https://callee.readthedocs.org/en/latest/guide/custom-matchers.html">implement a custom one</a>.</p>
<p>Check the library&#8217;s documentation for <a href="https://callee.readthedocs.org/en/latest/guide/usage.html#example">more examples</a>,
or jump right in to the <a href="https://callee.readthedocs.org/en/latest/guide/installing.html">installation guide</a>
or a <a href="https://callee.readthedocs.org/#api-reference">full matcher reference</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>A loop is not necessary if we simulate <code>assert_called_once_with</code> rather than <code>assert_called_with</code>,
but we still have to dig into <code>mock.call</code> objects to eke out the arguments.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/rust-borrowchk-tricks.html#rust-borrowchk-tricks">Tricks with ownership in&nbsp;Rust</a></h2>
    <p>
      Posted on Mon 07 March 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/borrow-checker.html">borrow checker</a>,      <a href="http://xion.io/tag/reference-counting.html">reference counting</a>,      <a href="http://xion.io/tag/traits.html">traits</a>      &#8226; <a href="http://xion.io/post/code/rust-borrowchk-tricks.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>&#8230;or how I learned to stop worrying and love the borrow&nbsp;checker.</em></p>
<p>Having no equivalents in other languages, the <a href="https://doc.rust-lang.org/book/ownership.html">borrow checker</a>
is arguably the most difficult thing to come to terms with when learning Rust. It&#8217;s easy to understand why it&#8217;s immensely
useful, especially if you recall
<a href="https://googleonlinesecurity.blogspot.com/2016/02/cve-2015-7547-glibc-getaddrinfo-stack.html">the various vulnerabities</a>
stemming from memory mismanagement. But that knowledge doesn&#8217;t exactly help when the compiler is whining about what
seems like a perfectly correct&nbsp;code.</p>
<p>Let&#8217;s face it: it will take some time to become productive writing efficient and safe code. It&#8217;s not entirely unlike
adjusting to a different paradigm such as functional programming when you&#8217;ve been writing mostly imperative code.
Before that happens, though, you can use some tricks to make the transition a little&nbsp;easier.</p>
<h4>Just <code>clone</code> it</h4>
<p>Ideally, we&#8217;d want our code to be both correct <em>and</em> fast. But if we cannot quite get to the &#8220;correctness&#8221; part yet &#8212;
because our program doesn&#8217;t, you know, <em>compile</em> &#8212; then how about paying for it with a small (and refundable)
performance&nbsp;hit?</p>
<p>This is where the <code>clone</code> method comes in handy. Many problems with the borrow checker stem from trying to spread
object ownership too thin. It is a precious resource and it&#8217;s not very cheap to &#8220;produce&#8221;, which is why good Rust code
often deals with just immutable or mutable&nbsp;references.</p>
<p>But if that proves difficult, then &#8220;making more objects&#8221; is a great intermediate solution. Incidentally, this is what
higher level languages are doing all the time, and often transparently. To ease the transition to Rust from
those languages, we can start off by replicating their&nbsp;behavior.</p>
<p>As an example, consider a function that tries to convert some value to <code>String</code>:</p>
<div class="highlight"><pre><span class="k">struct</span><span class="w"> </span><span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span><span class="w"> </span><span class="n">maybe_to_string</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// omitted</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>If we attempt to build upon it and create a <code>Vec</code>tor&nbsp;version:</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">maybe_all_to_string</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">results</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">maybe_to_string</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">is_err</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">ok</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">collect</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>then we&#8217;ll be unpleasantly surprised by a borrow checker&nbsp;error:</p>
<div class="highlight"><pre>error: cannot move out of borrowed content [E0507]
    Ok(results.iter().map(|r| r.ok().unwrap()).collect())
                              ^
</pre></div>


<p>Much head scratching will ensue, and we may eventually find an idiomatic and efficient solution.
However, a simple stepping stone in the shape of additional <code>clone()</code> call can help move things forward just
a little&nbsp;quicker:</p>
<div class="highlight"><pre><span class="cp">#[derive(Clone)]</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="c1">// ...</span>
<span class="nb">Ok</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">clone</span><span class="p">().</span><span class="n">ok</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">collect</span><span class="p">())</span><span class="w"></span>
</pre></div>


<p>The performance tradeoff is explicit, and easy to find later on with a simple <code>grep clone\(\)</code> or similar.
When you learn to do things the Rusty way, it won&#8217;t be hard to go back to your &#8220;hack&#8221; and fix it&nbsp;properly.</p>
<h4>Refcounting to the&nbsp;rescue</h4>
<p>Adding <code>clone()</code> willy-nilly to make the code compile is a valid workaround when we&#8217;re just learning. Sometimes, however,
even some gratuitous cloning doesn&#8217;t <em>quite</em> solve the problem, because the <code>clone()</code> itself can become an&nbsp;issue.</p>
<p>For one, it requires our objects to implement the <a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code>Clone</code> trait</a>.
This was apparent even in our previous example, since we had to add a <code>#[derive(Clone)]</code> attribute to the <code>struct Error</code>
in order to make it <code>clone</code>-able.</p>
<p>Fortunately, in the vast majority of cases this will be all that&#8217;s necessary, as most built-in types in Rust implement
<code>Clone</code> already. One notable exception are <em>function traits</em> (<code>FnOnce</code>, <code>Fn</code>, and <code>FnMut</code>) which are used to store
and refer to <em>closures</em><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. Structures and other custom types that contain them (or those which <em>may</em> contain them)
cannot therefore implement <code>Clone</code> through a simple <code>#[derive]</code> annotation:</p>
<div class="highlight"><pre><span class="c-Doc">/// A value that&#39;s either there already</span>
<span class="c-Doc">/// or can be obtained by calling a function.</span>
<span class="cp">#[derive(Clone)]</span><span class="w"></span>
<span class="k">enum</span><span class="w"> </span><span class="n">LazyValue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="nb">Clone</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Immediate</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Deferred</span><span class="p">(</span><span class="n">Fn</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<!-- -->

<div class="highlight"><pre>error: the trait `core::marker::Sized` is not implemented for the type `core::ops::Fn() -&gt; T + &#39;static` [E0277]
    #[derive(Clone)]
             ^~~~~
</pre></div>


<p>What can we do in this case, then? Well, there is yet another kind of performance concessions we can make,
and this one will likely sound familiar if you&#8217;ve ever worked with a higher level language before. Instead of actually
cloning an object, you can merely increment its <em>reference counter</em>. As the most rudimentary kind of garbage collection,
this allows to safely share the object between multiple &#8220;owners&#8221;, where each can behave as if it had
its own copy of&nbsp;it.</p>
<p>Rust&#8217;s pointer type that provides reference counting capabilities is called <code>std::rc::Rc</code>. Conceptually, it is analogous
to <code>std::shared_ptr</code> from C++, and it similarly keeps the refcount updated when the pointer is &#8220;acquired&#8221; (<code>clone</code>-ed)
and &#8220;released&#8221; (<code>drop</code>-ed). Because no data is moved around during either of those two operations, <code>Rc</code> can refer even
to types whose size isn&#8217;t known at compilation time, like abstract&nbsp;closures:</p>
<div class="highlight"><pre><span class="kn">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">rc</span><span class="o">::</span><span class="n">Rc</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Clone)]</span><span class="w"></span>
<span class="k">enum</span><span class="w"> </span><span class="n">LazyValue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="nb">Clone</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Immediate</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Deferred</span><span class="p">(</span><span class="n">Rc</span><span class="o">&lt;</span><span class="n">Fn</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Wrapping them in <code>Rc</code> therefore makes them &#8220;cloneable&#8221;. They aren&#8217;t actually cloned, of course, but because of
the inherent immutability of Rust types they will appear so to any outside observer<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>.</p>
<h4>Move&nbsp;it!</h4>
<p>Ultimately, most problems with the borrow checker boil down to unskillful mixing of the two ways you handle data in Rust.
There is <em>ownership</em>, which is passed around by moving the values; and there is <em>borrowing</em>, which means operating
on them through&nbsp;references.</p>
<p>When you try to switch from one to the other, some friction is bound to occur. Code that uses references, for example,
has to be copiously sprinkled with <code>&amp;</code> and <code>&amp;mut</code>, and may sometimes require explicit lifetime annotations. All these
have to be added or removed, and changes like that tend to propagate quite readily to the upper layers
of the program&#8217;s&nbsp;logic.</p>
<p>Therefore it is generally preferable, if at all possible, to deal with data directly
and not through references. To maintain efficiency, however, we need to learn how to move the objects through the various
stages of our algorithms. It turns out it&#8217;s surprisingly easy to inadvertently borrow something, hindering the possibility
of producing a moved&nbsp;value.</p>
<p>Take our first example. The intuitively named <code>Vec::iter</code> method produces an iterator that we can <code>map</code> over, but does
it really go over the actual <em>items</em> in the vector? Nope! It gives us a <em>reference</em> to each one &#8212; a borrow, if you will
&#8212; which is exactly why we originally had to use <code>clone</code> to get out of this&nbsp;bind.</p>
<p>Instead, why not just get the elements themselves, by moving them out of the vector? <code>Vec::into_iter</code> allows to do exactly&nbsp;this:</p>
<div class="highlight"><pre><span class="nb">Ok</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">r</span><span class="o">|</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">ok</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">collect</span><span class="p">())</span><span class="w"></span>
</pre></div>


<p>and enables us to remove the <code>clone()</code> call. The family of similar <code>into_X</code> (or even just <code>into</code>) methods can be reliably counted
on at least in the standard library. They are also part of a more-or-less official
<a href="https://aturon.github.io/style/naming.html#conversions">naming convention</a> that you should also follow in your own&nbsp;code.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Note how this is different from function <em>types</em>, i.e. <code>fn(A, B, C, ...) -&gt; Ret</code>. It is because plain functions
do not carry their closure environments along with them. This makes them little more than just pointers to some code,
and those can be freely <code>Clone</code>-d (or even <code>Copy</code>-ed).&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>If you want both shared ownership (&#8220;fake cloneability&#8221;) <em>and</em> the ability to mutate the shared value,
take a look at the <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html"><code>RefCell</code> type</a> and how it can be
<a href="http://doc.rust-lang.org/nightly/book/choosing-your-guarantees.html#composition">wrapped in <code>Rc</code></a> to achieve both.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-pip-requirements.html#python-pip-requirements">Requirements for Python&#8217;s&nbsp;pip</a></h2>
    <p>
      Posted on Sun 21 February 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/pip.html">pip</a>,      <a href="http://xion.io/tag/packages.html">packages</a>,      <a href="http://xion.io/tag/dependencies.html">dependencies</a>      &#8226; <a href="http://xion.io/post/code/python-pip-requirements.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In this post I&#8217;ll describe all (hopefully all!) the various ways you can specify a single dependency for a Python&nbsp;package.</p>
<p>This assumes <em>pip</em> is used for installation. The list of dependencies then goes either in <code>install_requires=</code>
parameter of the <code>setup</code> function within <em>setup.py</em>, or as a separate <em>requirements.txt</em> file. Commonly, it will actually
go in both places, with the latter being the canonical source of&nbsp;truth:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;requirements.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">(</span>
        <span class="c"># ...</span>
        <span class="n">install_requires</span><span class="o">=</span><span class="n">rf</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span>
    <span class="p">)</span>
</pre></div>


<p>More details about this approach can be found in
<a href="http://xion.org.pl/2014/01/27/anathomy-of-a-python-package/">one of my previous posts</a>.</p>
<p>Here, I will concentrate on the format of a single line in <em>requirements.txt</em> that defines a dependency.
There are numerous variants that <em>pip</em> supports, and they are all described in excruciating detail in
<a href="https://www.python.org/dev/peps/pep-0440/"><span class="caps">PEP</span> 440</a>. This post shall serve as a short reference on the most useful&nbsp;ones.</p>
<h4>Package name (and&nbsp;version)</h4>
<p>The simplest and most common option is to identify a dependency by its package&nbsp;name:</p>
<div class="highlight"><pre>SQLAlchemy
</pre></div>


<p>This will locate it in a global index of packages, which is sometimes called a &#8220;cheese shop&#8221;. Currently,
by far the most popular package registry for Python is <a href="https://pypi.python.org">PyPI</a>, and <em>pip</em> uses it by default<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>Without any further modifiers, <em>pip</em> will download and install the &#8220;current&#8221; version of the package &#8212; either the newest,
or the one designated explicitly by a maintainer. This obviously makes the dependency somewhat unpredictable,
for it can mean unintended upgrades that introduce breaking changes to your&nbsp;code.</p>
<p>To prevent this, you&#8217;d normally <em>pin</em> the dependency to an exact version<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre>SQLAlchemy==0.9.10
</pre></div>


<p>Other comparison operators are also&nbsp;available:</p>
<div class="highlight"><pre>SQLAlchemy&gt;=0.9.10
SQLAlchemy&lt;1.0.0
</pre></div>


<p>and can even be&nbsp;combined:</p>
<div class="highlight"><pre>SQLAlchemy&gt;=0.9,&lt;1.0.0
</pre></div>


<p>Specs like that will make <em>pip</em> find the newest version that&#8217;s within given range. Assuming your dependency follows
the <a href="http://semver.org/">semantic versioning</a> scheme, this will allow you to stay on top of any minor bugfixes
and improvements to an older release (0.9.x here), without the risk of accidentally upgrading to a new one (1.x)
that your code is not compatible with&nbsp;yet.</p>
<h4>Repository <span class="caps">URL</span></h4>
<p>Sometimes you want to live on the bleeding edge, though, and depend not just on the latest <em>release</em>,
but the head <em>commit</em> to the package&#8217;s repository. This makes sense especially in large systems
that are distributed among multiple repos, and where development happens in&nbsp;lockstep.</p>
<p>For those occasions, and a few others, <em>pip</em> can recognize direct repository URLs. They are in the&nbsp;format:</p>
<div class="highlight"><pre>$VCS+$PROTOCOL://$URL@$LABEL#egg=$PACKAGE
</pre></div>


<p>where the <code>$PROTOCOL</code> part can be optional if the version control system has a default there. That&#8217;s for example
the case for <code>git</code>, which is of course the most important <span class="caps">VCS</span> you&#8217;d be interested in<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>:</p>
<div class="highlight"><pre>git://git.example.com/somepackage#egg=somepackage
</pre></div>


<p>Note that the <code>#egg=$PACKAGE</code> part is not a part of the <code>$URL</code>, and it&#8217;s only there to give a local name for the package
distribution. This is what makes it possible to refer to it later via <em>pip</em>, if only to remove it with
<code>pip uninstall $PACKAGE</code>.
Of course, the sanest practice is to use the PyPI moniker if&nbsp;possible.</p>
<p>When no <code>$LABEL</code> is given, <em>pip</em> will use the <span class="caps">HEAD</span>, trunk, tip, or the equivalent default/current revision from the repo.
Often though (at least in case of Git), you would also pick a branch, tag, or even a particular <em>commit hash</em>:</p>
<div class="highlight"><pre>git+https://github.com/Xion/unmatcher.git@0.1.3.1#egg=unmatcher
git+ssh://github.com/You/yourpackage.git@master#egg=yourpackage
git+https://github.com/mitsuhiko/jinja2.git@5b498453b5898257b2287f14ef6c363799f1405a#egg=Jinja2
</pre></div>


<p>The last two options could be a good choice even with third party packages, when you don&#8217;t want to wait for a new PyPI
release to get a necessary feature or an urgent bug&nbsp;fix.</p>
<h4>Local&nbsp;filesystem</h4>
<p>Lastly, you can ask <em>pip</em> to install a package from a local directory or archive. The former option is often used
with the <code>-e</code> (<code>--editable</code>) flag for <code>pip install</code>. This installs the package in the so-called <em>development mode</em>,
allowing you to edit its source code&nbsp;in-place:</p>
<div class="highlight"><pre>$ pip install -e /home/me/Code/myotherpackage
</pre></div>


<p>You almost certainly don&#8217;t want to put this line in <em>requirements.txt</em>: you should still be pulling the other package
from PyPI. But if it&#8217;s your own one  &#8212; maybe a self-contained utility library used by your main program &#8212;
this setup will be very helpful for making changes to it, informed by your own usage of the&nbsp;package.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This can be changed with <code>--index_url</code> flag to <code>pip install</code>. Running local indexes is a good practice
for Python shops, especially those that rely on <code>pip install</code> as part of their deployment process.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>If the package uses <a href="http://semver.org/">semantic versioning</a>, a possible alternative to <code>==</code> is <code>~=</code>,
which means &#8220;compatible&#8221; version. The precise meaning of this is
<a href="https://www.python.org/dev/peps/pep-0440/#compatible-release">somewhat complicated</a>, but it roughly means that upgrades
are permitted as long as nothing in the public interface changes.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="https://pip.pypa.io/en/latest/reference/pip_install/#vcs-support">Other options</a> include <code>hg</code> (Mercurial),
<code>svn</code>, and <code>bzr</code> (Bazaar).&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/rust-move-out-of-container.html#rust-move-out-of-container">Moving out of a container in&nbsp;Rust</a></h2>
    <p>
      Posted on Fri 05 February 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/vector.html">vector</a>,      <a href="http://xion.io/tag/borrow-checker.html">borrow checker</a>,      <a href="http://xion.io/tag/references.html">references</a>      &#8226; <a href="http://xion.io/post/code/rust-move-out-of-container.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>To prevent the kind of memory errors that plagues many C programs,
the <a href="https://doc.rust-lang.org/book/ownership.html"><em>borrow checker</em> in Rust</a> tracks how data is moved between variables,
or accessed via references. This is all done at compile time, with zero runtime overhead, and is a sizeable part
of Rust&#8217;s value&nbsp;offering.</p>
<p>Like all rigid and automated systems, however, it is necessarily constrained and cannot handle all situations perfectly.
One of its limitations is treating all objects as <em>atomic</em>. It&#8217;s impossible for a variable to own a part of some bigger
structure, neither is it possible to maintain mutable references to two or more elements of a&nbsp;collection.</p>
<p>If we nonetheless <a href="http://is.gd/yWCYmJ">try</a>:</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="s">&quot;John&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Smith&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">()];</span><span class="w"></span>
<span class="w">    </span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&amp;</span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>we&#8217;ll be served with a classic borrow checker&nbsp;error:</p>
<div class="highlight"><pre>&lt;anon&gt;:3:25: 3:33 error: cannot move out of indexed content [E0507]
&lt;anon&gt;:3     let fullname = join(names[0], names[1]);
                                 ^~~~~~~~
</pre></div>


<p>Behind its rather cryptic verbiage, it informs us that we tried to move a <em>part</em> of the <code>names</code> vector &#8212; its first
element &#8212; to a new variable (here, a function parameter). This isn&#8217;t allowed, because in principle it would
render the vector invalid from the standpoint of strict memory safety. Rust would no longer guarantee <code>names[0]</code> to be
a legal <code>String</code>: its internal pointer could&#8217;ve been invalidated by the code which the element moved to
(the <code>join</code> function)<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>But while commendable, this guarantee isn&#8217;t exactly <em>useful</em> here. Even though <code>names[0]</code> would technically be invalid,
there isn&#8217;t anyone to actually notice this fact. The <code>names</code> vector is inaccessible outside of the function
it&#8217;s defined in, and even the function itself doesn&#8217;t look at it after the move. In its present form,
the program <del>is inarguably correct</del><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> could&#8217;ve been accepted if partial moves from <code>Vec</code> were allowed
by the borrow&nbsp;checker.</p>
<h4>Pointers to the&nbsp;rescue?</h4>
<p>Vectors wouldn&#8217;t be very useful or efficient, though, if we could only obtain <a href="https://doc.rust-lang.org/std/marker/trait.Copy.html">copies</a> or <a href="https://doc.rust-lang.org/std/clone/trait.Clone.html">clones</a> of their elements.
As this is an inherent limitation of Rust&#8217;s memory model, and applies to <em>all</em> compound types
(structs, hashmaps, etc.), it&#8217;s been recognized and countermeasures are&nbsp;available.</p>
<p>However, the <a href="http://is.gd/o3GRnw">idiomatic practice</a> is to actually leave the elements be and access them
solely through&nbsp;references:</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="s">&quot;John&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Smith&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">()];</span><span class="w"></span>
<span class="w">    </span><span class="n">join</span><span class="p">(</span><span class="o">&amp;</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>The obvious downside of this approach is that it requires an interface change to <code>join</code>: it now has to accept
pointers instead of actual objects<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>. And since the result is a completely new <code>String</code>, we have to either bite
the bullet and <code>clone</code>, or write a more awkward <code>join_into(a: &amp;mut String, b: &amp;String)</code> function.<br/>
In general, making an <span class="caps">API</span> switch from actual objects to references has an annoying tendency to percolate up
the call stacks and abstraction&nbsp;layers.</p>
<h4>Vector&nbsp;solution</h4>
<p>If we still insist on moving the elements out, at least in case of vector we aren&#8217;t <em>completely</em> out of luck.
The <code>Vec</code> type offers several specialized methods that can slice, dice, and splice the collection in various ways.
Those&nbsp;include:</p>
<ul>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_first"><code>split_first</code></a> (and <code>split_first_mut</code>)
for cutting right after the first&nbsp;element</li>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_last"><code>split_last</code></a> (and <code>split_last_mut</code>)
for a similar cut right before the last&nbsp;element</li>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_at"><code>split_at</code></a> (and <code>split_at_mut</code>),
generalized versions of the above&nbsp;methods</li>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_off"><code>split_off</code></a>, a partially-in-place version
of <code>split_at_mut</code></li>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.drain"><code>drain</code></a> for moving all elements from a specified&nbsp;range</li>
</ul>
<p>Other types may offer different methods, depending on their particular data layout, though <code>drain</code> should be available
on any data structure that can be iterated&nbsp;over.</p>
<h4>Structural&nbsp;advantage</h4>
<p>What about user-defined types, such as <code>struct</code>s?</p>
<p>Fortunately, these are covered by the compiler itself. Since accessing <code>struct</code> fields is a fully compile-time
operation, it is possible to track the ownership of each individual object that makes up the structure.
Thus there are no obstacles to simply <a href="http://is.gd/ZUI2Mn">moving all the fields</a>:</p>
<div class="highlight"><pre><span class="k">struct</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span><span class="w"> </span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Person</span><span class="p">{</span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;John&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span><span class="w"></span>
<span class="w">                   </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Smith&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">()};</span><span class="w"></span>
<span class="w">    </span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">last_name</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<h4>If all else&nbsp;fails&#8230;</h4>
<p>This leaves us with some rare cases when the container&#8217;s interface doesn&#8217;t <em>quite</em> support the exact subset of elements
we want to move out. If we don&#8217;t want to <code>drain</code> them all and inspect every item for potential preservation,
it may be time to skirt around the more dangerous areas of the&nbsp;language.</p>
<p>But I don&#8217;t necessarily mean going all out with <code>unsafe</code> blocks, pointers, and (let&#8217;s be honest) segfaults.
Instead, we can look at the gray zone between them and the regular, borrow-checked Rust&nbsp;code.</p>
<p>Some of the functions inside the <a href="https://doc.rust-lang.org/std/mem/index.html"><code>std::mem</code> module</a> can be said
to fall into this category. Most notably, <a href="https://doc.rust-lang.org/std/mem/fn.swap.html"><code>mem::swap</code></a> and
<a href="https://doc.rust-lang.org/std/mem/fn.replace.html"><code>mem::replace</code></a> allow us to operate directly on the memory blocks
that back every Rust object, albeit without the dangerous ability to freely modify&nbsp;them.</p>
<p>What those functions enable is a small sleight of hand &#8212; a quick exchange of two variables or objects
while the borrow checker &#8220;isn&#8217;t looking&#8221;. Possessing such an ability, we can smuggle any item out of a container
as long as we&#8217;re able to provide a suitable&nbsp;replacement:</p>
<div class="highlight"><pre><span class="kn">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">mem</span><span class="p">;</span><span class="w"></span>

<span class="c-Doc">/// Pick only the items under indices that are powers of two.</span>
<span class="k">fn</span><span class="w"> </span><span class="n">pick_powers_of_2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="nb">Default</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec</span><span class="o">::</span><span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">elem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">::</span><span class="n">default</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p style="text-align: center">
    <img src="http://xion.io/images/indyswap.jpg" alt="Swap!"></br>
    <small>Pictured: implementation of <code>mem::replace</code>.</small>
</p>

<p><a href="https://doc.rust-lang.org/std/default/trait.Default.html#tymethod.default">The <code>Default</code> value</a>,
if available, is usually a great choice here. Alternately, a <code>Copy</code> or <code>Clone</code> of some other element can also work
if it&#8217;s cheap to&nbsp;obtain.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>In Rust jargon, it is sometimes said that the object has been &#8220;consumed&#8221; there.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>As <a href="https://www.reddit.com/r/rust/comments/4cbc4u/moving_out_of_a_container_in_rust/d1gx9tb">/u/Gankro points out</a>
on <a href="https://reddit.com/r/rust">/r/rust</a>, since <code>Vec</code> isn&#8217;t a part of the language itself,
it doesn&#8217;t get to bend the borrow checking rules. Therefore speaking of counterfactual correctness
is a bit too far-fetched in this case.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>For <code>String</code>s specifically, the usual practice is to require a more generic <code>&amp;str</code> type (string slice)
instead of <code>&amp;String</code>.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-retry-idiom.html#python-retry-idiom">Retry idiom for&nbsp;Python</a></h2>
    <p>
      Posted on Wed 27 January 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/exceptions.html">exceptions</a>,      <a href="http://xion.io/tag/else.html">else</a>      &#8226; <a href="http://xion.io/post/code/python-retry-idiom.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>A relatively little known feature of Python is the <code>else</code> block for control flow statements other than <code>if</code>.</p>
<p>If you haven&#8217;t heard about it before, you can provide such a block for both <code>while</code> and <code>for</code> loops,
as well as any variant of the <code>try</code> statement, Its functionality is roughly analogous in both&nbsp;cases:</p>
<ul>
<li>in loops, the <code>else</code> block is executed if the loop didn&#8217;t exit abnormally (i.e. with <code>break</code>)</li>
<li>in <code>try</code> constructs, the <code>else</code> block runs if <em>no</em> exception&nbsp;happened</li>
</ul>
<p>Likely because of the unique semantics that don&#8217;t exist in other languages, neither of those constructs has been seen much
in real world code. Recently, however, I&#8217;ve found they can be combined into a very pythonic pattern
that&#8217;s also quite&nbsp;useful.</p>
<h4>The&nbsp;trick</h4>
<p>Say you have a task that won&#8217;t always succeed. Perhaps it&#8217;s a request made to a janky server, or other network operartion
that&#8217;s prone to timeouts. Since failures are likely to be transient, you&#8217;d like to retry it several more times before
giving up&nbsp;permanently.</p>
<p>With <code>try</code>/<code>except</code> block, you can detect those half-expected failures. With a simple loop, you can repeat the attempt
for as many times as you deem feasible. Combined, they can solve the problem rather&nbsp;neatly:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_RETRIES</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># ... do stuff ...</span>
    <span class="k">except</span> <span class="n">SomeTransientError</span><span class="p">:</span>
        <span class="c"># ... log it, sleep, etc. ...</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PermanentError</span><span class="p">()</span>
</pre></div>


<h4>But&nbsp;why?</h4>
<p>What&#8217;s the deal with the <code>else</code>s here, though? Are they both&nbsp;necessary?</p>
<p>The simple answer is of course no. <code>else</code> after either a loop or  <code>try</code>/<code>except</code> block is always a <em>syntactic sugar</em>.
Any code that contains it can be transformed into an equivalent snippet that utilizes different techniques to achieve
the same&nbsp;effect.</p>
<p>But this view isn&#8217;t very useful, for many of the essential features in any programming languages can be dismissed
as superfluous using this reasoning. The real question is whether the above idiom is more readable and understandable
than the&nbsp;alternatives.</p>
<p>To that, I posit, the answer is: <em>absolutely</em>.</p>
<h4>Desugaring</h4>
<p>Without the double <code>else</code>, this example would have to be written in a considerably more convoluted&nbsp;way:</p>
<div class="highlight"><pre><span class="n">retries</span> <span class="o">=</span> <span class="n">MAX_RETRIES</span>
<span class="k">while</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># ... do stuff ...</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="n">SomeTransientError</span><span class="p">:</span>
        <span class="c"># ... log it, sleep, etc. ...</span>
        <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="k">if</span> <span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PermanentError</span><span class="p">()</span>
</pre></div>


<p>Although at first glance the difference may be minuscule, this version adds significant extra busywork the programmer
has to pay careful attention&nbsp;to:</p>
<ul>
<li>The <code>retries</code> variable now has to be explicit, because the final conditional statement must look at its&nbsp;value.</li>
<li>We can&#8217;t use a <code>for</code> loop anymore (e.g. <code>for retries in range(MAX_RETRIES)</code>), because we wouldn&#8217;t distinguish the
&#8220;success at last try&#8221; and &#8220;retry limit exceeded&#8221; cases: they&#8217;d both result in <code>retries</code> equal to <code>MAX_RETRIES - 1</code>
after the loop<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</li>
<li>As a result, we have to remember to decrement the counter ourselves upon an&nbsp;error.</li>
</ul>
<p>Additionally, the <code>break</code> is easy to miss amidst the actual logic within the <code>try</code> block, both for developer
who writes the code and for any subsequent readers. An alternative is to move it outside of the <code>try</code>/<code>except</code> clause,
but that in turn reintroduces <code>continue</code> into the <code>except</code> branch and further complicates the whole&nbsp;flow.</p>
<p>In short, the desugared version is more error-prone (all those off-by-ones!) and also quite&nbsp;inscrutable.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Or to <code>1</code>, if we count from <code>MAX_RETRIES</code> down to zero.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://xion.io/index4.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
    <a class="btn float-right" href="http://xion.io/index2.html">
      Newer Posts <i class="fa fa-angle-right"></i>
    </a>
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2017 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>