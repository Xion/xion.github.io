<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/code/knockout-let-binding.html#knockout-let-binding">let: binding for&nbsp;Knockout</a></h2>
    <p>
      Posted on Wed 18 November 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/knockout.html">Knockout</a>,      <a href="http://xion.io/tag/javascript.html">JavaScript</a>,      <a href="http://xion.io/tag/web-frontend.html">web frontend</a>,      <a href="http://xion.io/tag/data-binding.html">data binding</a>      &#8226; <a href="http://xion.io/post/code/knockout-let-binding.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://knockoutjs.com/">Knockout</a> is a JavaScript &#8220;framework&#8221; that has always lurked in the shadows of other,
more flashy ones. Even in the days of its relative novelty, the likes of Backbone or Ember had seemed to garner more
widespread interest among frontend developers. Today, this hasn&#8217;t changed much, the difference being mainly
that the spotlight is now taken by new actors (<em>*cough*</em> <a href="https://facebook.github.io/react/">React</a> <em>*cough*</em>).</p>
<p>But Knockout has a loyal following, and for good reasons. Possibly the most imporant one is why I&#8217;ve put the word
&#8220;framework&#8221; in quotes. Knockout is, first and foremost, a <em>data binding</em> library: it doesn&#8217;t do much else besides
tying <span class="caps">DOM</span> nodes to JavaScript&nbsp;objects.</p>
<p>This quality makes it both easy to learn and simple to integrate. In fact, it can very well live in just some small
compartments of your web application, mingling easily with any server-side templating mechanism you might be using.
It also interplays effortlessly with other <span class="caps">JS</span> libraries, and sticks very well to
<a href="http://stackoverflow.com/q/30766900/434799">whatever duct tape you use</a> to hold your frontend stack&nbsp;together.</p>
<p>Lastly, it&#8217;s also quite extensible. We can, for example, create our own
<a href="http://knockoutjs.com/documentation/binding-syntax.html">bindings</a> rather easily, extending the declarative language
used to describe relationship between the data and <span class="caps">UI</span>.</p>
<p>In this post, I&#8217;m going to demonstrate this by implementing a very simple <code>let:</code> binding &#8212;
a kind of &#8220;assignment&#8221; of an expression to a&nbsp;name.</p>
<h4>From Knockout <code>with:</code> bluff</h4>
<p>Out of box, Knockout proffers the <a href="http://knockoutjs.com/documentation/with-binding.html"><code>with:</code> binding</a>,
a quite similar mechanism. How it may be somewhat problematic is analogous to the
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/with">widely discouraged <code>with</code> statement</a>
in JavaScript itself. Namely, it blends several namespaces together, making it harder to determine which object
is being referred to. As a result, the code is more prone to&nbsp;errors.</p>
<p>On the other hand, freeing the developer from repeating long and complicated expressions is obviously valuable.
Perhaps reducing them to nil is not the right approach, though, so how about we just shorten them
to a more manageable length? Well, that&#8217;s exactly what the <code>let:</code> binding is meant to&nbsp;do:</p>
<div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">data-bind=</span><span class="s">&quot;let: { addr: currentUser.personalInfo.address }&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">data-bind=</span><span class="s">&quot;text: addr.line1&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="c">&lt;!-- ko if: addr.line2 --&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">data-bind=</span><span class="s">&quot;text: addr.line2&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="c">&lt;!-- /ko --&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">data-bind=</span><span class="s">&quot;text: add.city&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>,
    <span class="nt">&lt;span</span> <span class="na">data-bind=</span><span class="s">&quot;text: add.region&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">data-bind=</span><span class="s">&quot;text: add.country&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>


<p>Making it happen turns out to be pretty&nbsp;easy.</p>
<h4>Binding&nbsp;contract</h4>
<p>To define a Knockout binding, up to two things are needed. We have to specify what the library should&nbsp;do:</p>
<ul>
<li>when the binding is first applied to a <span class="caps">DOM</span> node (the <code>init</code> method)</li>
<li>when any of the <a href="http://knockoutjs.com/documentation/observables.html">observed values</a> changes (the <code>update</code> method)</li>
</ul>
<p>Not every binding has to implement both methods. In our cases, only the <code>init</code> is necessary, because all we have to do
is modify the <em>binding context</em>.</p>
<p>What&#8217;s that? Shortly speaking, a <a href="http://knockoutjs.com/documentation/binding-context.html">binding context</a>,
is an object holding all the data you can potentially bind to your <span class="caps">DOM</span> nodes. Think of it as a namespace, or local scope:
whatever&#8217;s in there can be used directly inside <code>data-bind</code> attributes.</p>
<h4><code>let:</code> it&nbsp;go</h4>
<p>Therefore, all that the <code>let:</code> binding has to do is to extend the context with a mapping passed to it as an argument.
Well, almost&nbsp;all:</p>
<div class="highlight"><pre><span class="nx">ko</span><span class="p">.</span><span class="nx">bindingHandlers</span><span class="p">[</span><span class="s1">&#39;let&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">valueAccessor</span><span class="p">,</span> <span class="nx">allBindings</span><span class="p">,</span> <span class="nx">viewModel</span><span class="p">,</span> <span class="nx">bindingContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">innerContext</span> <span class="o">=</span> <span class="nx">bindingContext</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">valueAccessor</span><span class="p">);</span>
        <span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindingsToDescendants</span><span class="p">(</span><span class="nx">innerContext</span><span class="p">,</span> <span class="nx">element</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">controlsDescendantBindings</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>


<p>The resulting <code>innerContext</code> is a copy of the original <code>bindingContext</code>, augmented with additional properties from
the argument of <code>let:</code> (those are available through <code>valueAccessor</code>). Once we have it, though, we need to handle it
in a little special&nbsp;way.</p>
<p>Normally, Knockout is processing all bindings recursively, pasing down the same <code>bindingContext</code> (which ultimately
comes from the root <code>viewModel</code>). But since we want to locally alter the context, we also need to interrupt this regular
way and take care of the lower-level <span class="caps">DOM</span> nodes&nbsp;ourselves.</p>
<p>This is exactly what the overly-long <code>ko.applyBindingsToDescendants</code> function is doing. The only caveat is that Knockout
has to be <a href="http://knockoutjs.com/documentation/custom-bindings-controlling-descendant-bindings.html">told explicitly</a>
about our intentions through the <code>return</code> value from <code>init</code>. Otherwise, it would try to apply the <em>original</em>
<code>bindingContext</code> recursively, which in our case would amount to applying it <strong>twice</strong>.
<code>{ controlsDescendantBindings: true }</code> prevents Knockout from doing so&nbsp;erroneously.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/sqlalchemy-query-to-sql.html#sqlalchemy-query-to-sql">Turn SQLAlchemy queries into literal <span class="caps">SQL</span></a></h2>
    <p>
      Posted on Thu 12 November 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/sqlalchemy.html">SQLAlchemy</a>,      <a href="http://xion.io/tag/sql.html">SQL</a>,      <a href="http://xion.io/tag/databases.html">databases</a>      &#8226; <a href="http://xion.io/post/code/sqlalchemy-query-to-sql.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Like I mentioned in the <a href="http://xion.io/post/code/sqlalchemy-regex-filters.html">post about adding regular expression support</a>,
the nice thing about <a href="http://www.sqlalchemy.org/">SQLAlchemy</a> is the clean, layered structure of various abstractions
it&nbsp;utilizes.</p>
<p>Regretably, though, we know that <a href="https://en.wikipedia.org/wiki/Leaky_abstraction">software abstractions tend to leak</a>.
Inn particular, any <span class="caps">ORM</span> seem to be a poster child of this rule, especially in the popular opinion among
<a href="https://www.reddit.com/r/programming/search?q=ORM&amp;restrict_sr=on">developer crowds</a>.
By design, they&#8217;re intended to hide at least <em>some</em> details of the operations on a database,
but those very details can be quite critical at times. There are situations when we simply want to know
what <em>exactly</em> is going on, and how all those model classes and mappers and relationships translate
to the actual <span class="caps">SQL</span>&nbsp;code.</p>
<p>To make it a little more concrete, let&#8217;s focus on the SQLAlchemy <code>Query</code> class. Given such a query, we&#8217;d like to get
the final <span class="caps">SQL</span> representation of it, the one that&#8217;s ultimately sent to the database, It could be useful
for any number of things, from logging<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> to profiling, or just displaying in the web page&#8217;s footer,
or even solely for prototyping in the Python <span class="caps">REPL</span>.</p>
<p>In other words, we want to turn&nbsp;this:</p>
<div class="highlight"><pre><span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">some_email</span><span class="p">)</span>
</pre></div>


<p>into something like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">SELECT</span> <span class="n">users</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">users</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="p">:</span><span class="mi">1</span>
</pre></div>


<p>regardless of the complexity of the query, the number of model classes it spans, or the number of relationship-related
<code>JOIN</code>s it&nbsp;involves.</p>
<h4>It&#8217;s a&nbsp;dialect</h4>
<p>There is one aspect we cannot really universalize, though. It&#8217;s the specific <em>database backend</em> that SQLAlchemy
should compile our query for. Shrugging off syntactical and semantical differences between database engines
is one thing that using an <span class="caps">ORM</span> can potentially buy us, but if we want to get down to the <span class="caps">SQL</span> level,
we need to be specific about&nbsp;it.</p>
<p>In SQLAlchemy&#8217;s parlance, any specific variant of the <span class="caps">SQL</span> language is called a <em>dialect</em>. Most of the time,
you&#8217;ll be interested in the particular dialect your database of choice is using. This is easily obtainable from
the <a href="docs.sqlalchemy.org/en/latest/orm/session_api.html#sqlalchemy.orm.session.Session">database <code>Session</code></a>:</p>
<div class="highlight"><pre><span class="n">dialect</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span>
</pre></div>


<p>The resulting
<a href="http://docs.sqlalchemy.org/en/latest/core/internals.html#sqlalchemy.engine.interfaces.Dialect"><code>Dialect</code> object</a>
is little more than a container for small tidbits of information, used by SQLAlchemy to handle various quirks of
the database backends it supports. For our purposes, though, it can be treated as a completely opaque&nbsp;token.</p>
<h4>Compile <span class="amp">&amp;</span>&nbsp;unwrap</h4>
<p>With the <code>Dialect</code> in hand, we can invoke the query compiler to get the textual representation of our <code>Query</code>.
Or, to be more precise, the compiled version of the query&#8217;s
<a href="docs.sqlalchemy.org/en/latest/core/selectable.html#sqlalchemy.sql.expression.Select"><code>Select</code> statement</a></p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s">&#39;foo@example.com&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">db_session</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="p">))</span>
<span class="n">SELECT</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
<span class="n">FROM</span> <span class="n">users</span>
<span class="n">WHERE</span> <span class="n">users</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">email_1</span><span class="p">)</span><span class="n">s</span>
</pre></div>


<p>Perhaps unsurprisingly, even after compilation the result is still just <em>another object</em>:
the <a href="docs.sqlalchemy.org/en/latest/core/internals.html#sqlalchemy.engine.interfaces.Compiled"><code>Compiled</code> one</a>.
As you can see, however, the actual <span class="caps">SQL</span> text is just its <code>__str__</code><span class="quo">&#8216;</span>ing representation, which we can <code>print</code> directly
or obtain with <code>str()</code> or <code>unicode()</code>.</p>
<h4><code>Query.to_sql</code></h4>
<p>But obviously, we don&#8217;t want to type the above incantations every time we need to take a peek at the generated <span class="caps">SQL</span>
for an <span class="caps">ORM</span> query. Probably the best solution is to extend the <code>Query</code> class so that it offers this additional
functionality under a new&nbsp;method:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.orm.query</span> <span class="kn">import</span> <span class="n">Query</span> <span class="k">as</span> <span class="n">_Query</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">_Query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom, enhanced SQLALchemy Query class.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">to_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a literal SQL representation of the query.&quot;&quot;&quot;</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">))</span>
</pre></div>


<p>This new <code>Query</code> class needs then be passed as
<a href="http://docs.sqlalchemy.org/en/latest/orm/session_api.html#sqlalchemy.orm.session.Session.params.query_cls"><code>query_cls</code> argument</a>
to the constructor of <code>Session</code>. Details may vary a little bit depending on how exactly your application is set up,
but in most cases, it should be <a href="http://docs.sqlalchemy.org/en/latest/orm/contextual.html">easy enough to figure out</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>If you&#8217;re only interested in indiscriminate logging of all queries, setting the
<a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#sqlalchemy.create_engine.params.echo"><code>echo</code> parameter</a>
in <a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#sqlalchemy.create_engine"><code>create_engine</code></a> may be sufficient.
Another alternative is to look directly at the
<a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#configuring-logging">logging configuration options</a>
for various parts of SQLAlchemy&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/celery-include-flask-request-context.html#celery-include-flask-request-context">Celery task in a Flask request&nbsp;context</a></h2>
    <p>
      Posted on Tue 03 November 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/celery.html">Celery</a>,      <a href="http://xion.io/tag/flask.html">Flask</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/queue.html">queue</a>,      <a href="http://xion.io/tag/request-context.html">request context</a>      &#8226; <a href="http://xion.io/post/code/celery-include-flask-request-context.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://celeryproject.org">Celery</a> is an asynchronous task worker that&#8217;s frequently used for background processing
in Python web apps. Rather than performing a time-consuming task within the request loop, we delegate it to a <em>queue</em>
so that a <em>worker process</em> can pick it up when ready. The immediate benefit is much better latency for the end user.
Pros also include easier scalability, since you can adjust the number of workers to your task&nbsp;load.</p>
<p>Examples of tasks that are usually best done in the background vary from fetching data through a third-party <span class="caps">API</span>
to sending emails, and from pushing mobile notifications to pruning the database of stale records. Anything that may
take more than a couple hundred milliseconds to complete &#8212; and isn&#8217;t absolutely essential to the current <span class="caps">HTTP</span> request &#8212;
is typically a good candidate for asynchronous&nbsp;processing.</p>
<p>In Celery, workers are just regular Python processes, often running the exact same code that&#8217;s powering the app&#8217;s web
frontend<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. But unlike most of that code, they aren&#8217;t servicing any <span class="caps">HTTP</span> requests &#8212; they simply run some function
with given arguments, both specified by whomever sent a task for execution. Indeed, those functions don&#8217;t even <em>know</em>
who or what asked for them to be&nbsp;executed.</p>
<p>Neat, right? It is what we usually compliment as <em>decoupling</em>, or separation of concerns. They are valuable qualities even
regardless of the <span class="caps">UI</span> and scaling benefits mentioned&nbsp;earlier.</p>
<h4>Not quite&nbsp;web</h4>
<p>But those qualities come with a trade-off. Task code is no longer a web frontend code: it doesn&#8217;t run within the
comfy environment of our web framework of choice. Losing it may be quite unnerving, actually, because in a typical
web application there will be many things tied directly to the <span class="caps">HTTP</span> request pipeline. After all, this is what web
applications <em>do</em> &#8212; respond to <span class="caps">HTTP</span> requests &#8212; so it often makes perfect sense e.g. to marry the request flow
with database transactions, committing or rolling those back according to <span class="caps">HTTP</span> status code that the app&nbsp;produced.</p>
<p>Tasks may also require a database, though, if only to
<a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#state">assert the expected state of the world</a>.
Similar goes for memcache, a Redis instance, or basically any resource used by the frontend code.
Alas, it&#8217;s quite possible <em>the very reason</em> we delegate work to a task is to shift lengthy interactions with those
external systems away from the <span class="caps">UI</span>. Obviously, we&#8217;re going to need them for&nbsp;that!</p>
<h4>Fake a&nbsp;request</h4>
<p>So one way or another, our tasks will most likely need some initialization and/or cleanup code. And since it&#8217;s probably
the same code that most <span class="caps">HTTP</span> request handlers require and use already, why not just <em>pretend we&#8217;re handling a request
after all</em>?</p>
<p>In <a href="http://flask.pocoo.org">Flask</a>, we can pull that off rather easily.
The <a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.test_request_context"><code>test_request_context</code> method</a>
is conveniently provided to allow for faking the <em>request context</em> &#8212; that is, an execution environment for <span class="caps">HTTP</span> handlers.
Like the name suggest, it is used mostly <a href="http://flask.pocoo.org/docs/0.10/testing/">for testing</a>, but there is nothing
stopping us from using it in tasks run by&nbsp;Celery.</p>
<p>We probably don&#8217;t want to call it directly, though. What would be better is to have Celery prepare the context first,
and then run the task code as if it was an <span class="caps">HTTP</span> handler. For even better results, the context would preserve information
extracted from the <em>actual <span class="caps">HTTP</span> request</em>, one that has sent the task for execution. Moving some work to the background
would then be a trivial matter, for both the task and the original handler would operate within the same&nbsp;environment.</p>
<p>Convenient? I believe so. And as I&#8217;ll demonstrate next, it isn&#8217;t very complicated to implement&nbsp;either.</p>
<h4>Wrap the&nbsp;decorator?</h4>
<p>At least one piece of the solution should stand out as pretty obvious. Since our intention is to wrap the task&#8217;s code
in some additional packaging &#8212; the request context &#8212; it seems fairly natural to write our own <code>@task</code> decorator:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">celery</span>


<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator function to apply to Celery tasks.</span>
<span class="sd">    Executes the actual task inside Flask&#39;s test request context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actual decorator.&quot;&quot;&quot;</span>
        <span class="nd">@celery.task</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>


<p>Here, <code>app</code> is the <a href="http://flask.pocoo.org/docs/0.10/api/#application-object"><code>Flask</code> application</a>, and <code>celery</code> is the
<a href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery-application-objects"><code>Celery</code> object</a>
that&#8217;s often configured alongside&nbsp;it.</p>
<h4>The <code>Task</code> class</h4>
<p>While this technique will give us <em>a</em> request context inside the task code, it won&#8217;t be <em>the</em> request context
from which the task has been sent for execution. To replicate that context correctly, we need additional support
on the sender&nbsp;side.</p>
<p>Internally, Celery is converting every function we annotate with <code>@task</code> decorator into a subclass of
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task"><code>Celery.app.task.Task</code></a>.
This process can be customized, for example by providing an explicit <code>base=</code> parameter to <code>@task</code> which
specifies a <a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#custom-task-classes">custom <code>Task</code> subclass</a>
to use in place of the default one. Within that subclass, we&#8217;re free to override any functionality that we need&nbsp;to.</p>
<p>In our case, we&#8217;ll scrape the current request context from Flask for all relevant information,
and later use it to recreate the context in the task&nbsp;code.</p>
<p>But before we get to that, let&#8217;s just create the <code>Task</code> subclass and move the above execution logic to it.
This way, users won&#8217;t have to use a completely new <code>@task</code> decorator which would needlessly couple them to a specific
<code>Celery</code> app&nbsp;instance:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for tasks that run inside a Flask request context.&quot;&quot;&quot;</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<p>Instead, they can either set this class as <code>base=</code> for a specific&nbsp;task:</p>
<div class="highlight"><pre><span class="nd">@celery.task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">RequestContextTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sync_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>or make it into new default for all their&nbsp;tasks:</p>
<div class="highlight"><pre><span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">celery</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="n">RequestContextTask</span>
</pre></div>


<h4>Invocation&nbsp;patterns</h4>
<p>When the frontend asks for a task to be executed, it most often uses the
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.delay"><code>Task.delay</code> method</a>.
It will package a payload contaning task arguments, and send it off through a <em>broker</em> &#8212;
usually an <a href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol"><span class="caps">AMQP</span></a>-based queue,
such as <a href="https://www.rabbitmq.com/">RabbitMQ</a> &#8212; so that a Celery worker can pick it up and actually&nbsp;execute.</p>
<p>But there are other means of task invocation. We can even run it
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.apply">&#8220;in place&#8221;</a>,
locally and synchronously, which is especially useful for various testing scenarios. Lastly, a task can also be
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.retry">retried</a> from within
its own code, terminating its current run and scheduling another attempt for some future&nbsp;date.</p>
<p>Obviously, for the <code>RequestContextTask</code> to be useful, it needs to behave correctly in every situation.
Therefore we need to cover all the entry points I&#8217;ve mentioned &#8212;
the asynchronous call, a synchronous invocation, and a task&nbsp;retry:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_context</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_context</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_context</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">)</span>
</pre></div>


<p>Note that <code>Task.apply_async</code> is being called internally by <code>Task.delay</code>,
so it&#8217;s only that first method that we have to&nbsp;override.</p>
<h4>Context in a&nbsp;box</h4>
<p>As you can deduce right away, the Flask-related magic is meant to go in the <code>_include_context</code> method.
The idea is to prepare arguments for the eventual invocation of <code>Flask.test_request_context</code>,
and pass them through an extra task parameter.
Those arguments are relatively uncomplicated: they are just a medley of various pieces of information
that we can easily obtain from the Flask&#8217;s <code>request</code> object:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">has_request_context</span><span class="p">,</span> <span class="n">request</span>


<span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">CONTEXT_ARG_NAME</span> <span class="o">=</span> <span class="s">&#39;_flask_request_context&#39;</span>

    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">_include_request_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Includes all the information about current HTTP request context</span>
<span class="sd">        as an additional argument to the task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_request_context</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s">&#39;base_url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url_root</span><span class="p">,</span>
            <span class="s">&#39;method&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s">&#39;headers&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s">&#39;query_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">[(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ARG_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
</pre></div>


<p>On the worker side, we simply unpack them and recreate the&nbsp;context:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>

<span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">call</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ARG_NAME</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">has_request_context</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">call</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">call</span><span class="p">()</span>
            <span class="n">app</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">make_response</span><span class="p">(</span><span class="n">result</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>


<p>The only tricky part is calling
<a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.process_response"><code>Flask.process_response</code></a> at the end.
We need to do that for the <a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.after_request"><code>@after_request</code> hooks</a>
to execute correctly. This is quite crucial, because those hooks are where you&#8217;d normally put important cleanup code,
like commit/rollback of the database&nbsp;transaction.</p>
<h4>Complete&nbsp;solution</h4>
<p>To see how all those code snippets fit together, see <a href="https://gist.github.com/Xion/46d739b980af14a0d3ea">this gist</a>.
You may also want to have a look at
<a href="http://flask.pocoo.org/docs/0.10/patterns/celery/">the article on Celery integration</a> in Flask docs for some tips on
how to integrate it with your own&nbsp;project.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This isn&#8217;t strictly necessary, as Celery supports sending tasks for execution
<a href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery.send_task">by explicit name</a>.
For that request to reach the worker, however,
the <a href="http://docs.celeryproject.org/en/latest/configuration.html#broker-url">task broker configuration</a>
must be correctly shared between sender and the worker.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-enums-are-ok.html#python-enums-are-ok">Actually, Python enums are pretty <span class="caps">OK</span></a></h2>
    <p>
      Posted on Sun 25 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/enums.html">enums</a>,      <a href="http://xion.io/tag/serialization.html">serialization</a>      &#8226; <a href="http://xion.io/post/code/python-enums-are-ok.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Little over two years ago, I was writing about
<a href="http://xion.org.pl/2013/05/13/we-dont-need-no-enums-in-python/">my skepticism</a> towards the
<a href="https://www.python.org/dev/peps/pep-0435/">addition of enum types to Python</a>. My stance has changed somewhat since then,
and I now think there is some non-trivial value that enums can add to Python code. It becomes especially apparent
in the circumstances involving any kind of persistence,
from <a href="https://docs.python.org/2/library/pickle.html">pickling</a> to&nbsp;databases.</p>
<p>I will elaborate on that through the rest of this&nbsp;post.</p>
<h4>Revision</h4>
<p>First, let&#8217;s recap (or perhaps introduce) the important facts about enums in Python. An <em>enum</em>, or an enumeration type,
is a special class that inherits from <code>enum.Enum</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> and defines one or more&nbsp;constants:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">Cutlery</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">knife</span> <span class="o">=</span> <span class="s">&#39;knife&#39;</span>
    <span class="n">fork</span> <span class="o">=</span> <span class="s">&#39;fork&#39;</span>
    <span class="n">spoon</span> <span class="o">=</span> <span class="s">&#39;spoon&#39;</span>
</pre></div>


<p>Their values are then converted into singleton objects with distinct identity.
They available as attributes of the enumeration&nbsp;type:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">Cutlery</span><span class="o">.</span><span class="n">fork</span>
<span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">fork</span><span class="p">:</span> <span class="s">&#39;fork&#39;</span><span class="o">&gt;</span>
</pre></div>


<p>As a shorthand for when the values themselves are not important, the <code>Enum</code> class can be directly invoked
with constant names as&nbsp;strings:</p>
<div class="highlight"><pre><span class="n">Cutlery</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;Cutlery&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;knife&#39;</span><span class="p">,</span> <span class="s">&#39;fork&#39;</span><span class="p">,</span> <span class="s">&#39;spoon&#39;</span><span class="p">])</span>
</pre></div>


<p>Resulting class offers some useful <span class="caps">API</span> that we&#8217;d expect from an enumeration type in any programming&nbsp;language:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">Cutlery</span><span class="p">)</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">knife</span><span class="p">:</span> <span class="s">&#39;knife&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">fork</span><span class="p">:</span> <span class="s">&#39;fork&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">spoon</span><span class="p">:</span> <span class="s">&#39;spoon&#39;</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Cutlery</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;knife&#39;</span><span class="p">,</span> <span class="s">&#39;fork&#39;</span><span class="p">,</span> <span class="s">&#39;spoon&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;</span> <span class="n">Cutlery</span><span class="o">.</span><span class="n">knife</span> <span class="ow">in</span> <span class="n">Cutlery</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Cutlery</span><span class="p">(</span><span class="s">&#39;spoon&#39;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">spoon</span><span class="p">:</span> <span class="s">&#39;spoon&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Cutlery</span><span class="p">(</span><span class="s">&#39;spork&#39;</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="c"># (...)</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="s">&#39;spork&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">Cutlery</span>
</pre></div>


<h4>How it was done&nbsp;previously</h4>
<p>Of course, there is nothing really groundbreaking about assigning some values to &#8220;constants&#8221;. It&#8217;s been done like that
since times immemorial, and quite often those constants have been grouped within finite&nbsp;sets.</p>
<p>Here&#8217;s an example of a comment model in some imaginary <span class="caps">ORM</span>, complete with a status&nbsp;&#8220;enumeration&#8221;:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">APPROVED</span> <span class="o">=</span> <span class="s">&#39;approved&#39;</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="s">&#39;rejected&#39;</span>
    <span class="n">IN_REVIEW</span> <span class="o">=</span> <span class="s">&#39;in_review&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">APPROVED</span><span class="p">,</span> <span class="n">REJECTED</span><span class="p">,</span> <span class="n">IN_REVIEW</span><span class="p">])</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextProperty</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STATES</span><span class="p">)</span>

<span class="c"># usage</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s">&quot;Xion&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Boo&quot;</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">IN_REVIEW</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>Converting it to use an <code>Enum</code> is relatively&nbsp;straightforward:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">approved</span> <span class="o">=</span> <span class="s">&#39;approved&#39;</span>
        <span class="n">rejected</span> <span class="o">=</span> <span class="s">&#39;rejected&#39;</span>
        <span class="n">in_review</span> <span class="o">=</span> <span class="s">&#39;in_review&#39;</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextProperty</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">State</span><span class="p">])</span>

<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s">&quot;Xion&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Meh.&quot;</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">approved</span><span class="o">.</span><span class="n">value</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>It is not apparent, though, if there is any immediate benefit of doing so. True, we no longer need to define the <code>STATES</code>
set explicitly, but saving on this bit of boilerplate is balanced out by having to access the enum&#8217;s <code>value</code>
when assigning it to a string&nbsp;property.</p>
<p>All in all, it seems like a wash &#8212; though at least we&#8217;ve established that enums are <em>no worse</em> than their alternatives&nbsp;:)</p>
<h4>Enums are&nbsp;interoperable</h4>
<p>Obviously, this doesn&#8217;t exactly sound like high praise. Thing is, we haven&#8217;t really replaced the previous solution
<em>completely</em>. Remnants of it still linger in the way the <code>state</code> property is declared. Even though it&#8217;s supposed to hold
enum constants, it is defined as string, which at this point is more of an implementation detail of how those constants
are&nbsp;serialized.</p>
<p>What were really need here is a kind of <code>EnumProperty</code> that&#8217;d allow us to work solely with enum objects.
Before the introduction of a standard <code>Enum</code> base, however, there was little incentive for ORMs and other similiar
libraries to provide such a functionality. But now, it makes much more sense to support enums as first-class citizens,
at least for data exchange and serialization, because users can be expected to already prefer the standard <code>Enum</code>
in their own&nbsp;code.</p>
<p>Thus, the previous example changes into something along these&nbsp;lines:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">EnumProperty</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>

<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s">&quot;Xion&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Yay!&quot;</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">approved</span>  <span class="c"># no .value!</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>Details of <code>EnumProperty</code>, or some equivalent construct, are of course specific to any given data management library.
In SQLAlchemy, for example, a <a href="https://gist.github.com/Xion/5564b907e5f4e883511c">custom column type</a>
can handle the necessary serialization and deserialization between Python code and <span class="caps">SQL</span> queries,
allowing you to define your models like this<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="c"># ...</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">EnumType</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>

<span class="c"># usage like above</span>
</pre></div>


<p>In any case, the point is to have Python code operate solely on enum objects, while the persistence layer takes
care of converting between them and their serializable&nbsp;values.</p>
<h4>Enums are&nbsp;extensible</h4>
<p>The other advantage <code>Enum</code>s have over loose collections of constants is that they are proper <em>types</em>.
Like all user-defined types in Python, they can have additional methods and properties defined on their instances,
or even on the type&nbsp;itself.</p>
<p>Although this capability is (by default) not as powerful as e.g. in Java &#8212; where <em>each enum constant</em> can
<a href="https://gist.github.com/chandrasekhar4u/431839b9eac715c08b71">override a method in its own way</a> &#8212; it can nevertheless
be quite convenient at times. Typical use cases include constant&nbsp;classification:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">37</span>
    <span class="n">up</span> <span class="o">=</span> <span class="mi">38</span>
    <span class="n">right</span> <span class="o">=</span> <span class="mi">39</span>
    <span class="n">down</span> <span class="o">=</span> <span class="mi">40</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_horizontal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Direction</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_vertical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Direction</span><span class="o">.</span><span class="n">down</span><span class="p">,</span> <span class="n">Direction</span><span class="o">.</span><span class="n">up</span><span class="p">)</span>
</pre></div>


<p>and&nbsp;conversion:</p>
<div class="highlight"><pre>    <span class="k">def</span> <span class="nf">as_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">left</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>


<p>For the latter, it would be handy to have the Java&#8217;s ability to
<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html">attach additional data</a> to an enum constant.
As it turns out, Python supports this feature natively in a very similar way.
We simply have to override enum&#8217;s <code>__new__</code> method to parse out any extra values from the initializer
and turn them into attributes of the enum&nbsp;instance:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">up</span> <span class="o">=</span> <span class="mi">38</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="mi">39</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">down</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_value_</span> <span class="o">=</span> <span class="n">keycode</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="n">obj</span>
</pre></div>


<p>It&#8217;s possible, in fact, to insert any arbitrary computation here that yields the final <code>_value_</code> of an enum constant<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.
This trick can be used to, for example, construct enums that
<a href="https://docs.python.org/3/library/enum.html#autonumber">automatically number themselves</a>.</p>
<p>Finally, we can add static methods, class methods, or <a href="http://stackoverflow.com/a/3203659">class properties</a> to the
<code>Enum</code> subclass, just like we would do with any other&nbsp;class:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MyEnum</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">__values__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">]</span>
</pre></div>


<h4>Enums just&nbsp;are</h4>
<p>All these things are possible primarly because of the most notable aspect of Python enums: their existence
as an <em>explicit concept</em>. A syntactically unorganized bunch of constants cannot offer half of the highlighted features
because there is nowhere to pin them&nbsp;on.</p>
<p>For that reason alone, using enums as an explicit &#8212; rather than implicit &#8212; pattern seems worthwhile.
The one benefit we&#8217;re certain to reap is better code structure through separation of important&nbsp;concepts.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The <code>enum</code> module is part of the Python standard library
<a href="https://docs.python.org/3/library/enum.html">since version 3.4</a>
but <a href="https://pypi.python.org/pypi/enum/">a fully functional backport</a> is available for Python 2.x as well.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>It is even possible to instruct SQLAlchemy how to map Python enums to
<a href="http://www.postgresql.org/docs/9.1/static/datatype-enum.html"><code>ENUM</code> types</a> in database engines that support it,
but details are outside of the scope of this article.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>If you&#8217;re fine with the enum&#8217;s <code>value</code> being the <em>whole</em> tuple (everything after the <code>=</code> sign),
you can override <code>__init__</code> instead of <code>__new__</code>
(cf. <a href="https://docs.python.org/3/library/enum.html#planet">the planet example</a> from standard docs).&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/jinja-classlist.html#jinja-classlist"><span class="caps">CSS</span> class helper for&nbsp;Jinja</a></h2>
    <p>
      Posted on Thu 22 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/jinja.html">Jinja</a>,      <a href="http://xion.io/tag/css.html">CSS</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/flask.html">Flask</a>      &#8226; <a href="http://xion.io/post/code/jinja-classlist.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>One of the great uses for a templating engine such as <a href="http://jinja.pocoo.org">Jinja</a> is reducing the clutter
in our <span class="caps">HTML</span> source files. Even with the steady advances in the <span class="caps">CSS</span><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> standards, various <code>div.wrapper</code>, <code>div.container</code>,
<code>div.content</code>, and other presentational elements are still a common fact of life.
Unless you&#8217;re one of the cool kids who use <a href="http://webcomponents.org/">Web Components</a> with
<a href="https://www.polymer-project.org">Polymer</a>, your main option for abstracting this boilerplate away
is defining some more general <a href="http://jinja.pocoo.org/docs/dev/templates/#macros">template macros</a>.</p>
<p>As with any kind of abstraction, it&#8217;s crucial to balance broad applicability with a potential for finely-tuned
customization. In the case of wrapping <span class="caps">HTML</span> snippets in Jinja macros, an easy way to maintain flexibility is to allow
the caller to specify some crucial attributes of the root&nbsp;element:</p>
<div class="highlight"><pre><span class="c">{#</span>
<span class="c">  Renders the markup for a &lt;button&gt; from Twitter Bootstrap.</span>
<span class="c">#}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">button</span><span class="o">(</span><span class="nv">text</span><span class="o">=</span><span class="kp">none</span><span class="o">,</span> <span class="nv">style</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="o">,</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;button&#39;</span><span class="o">,</span> <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;button type=&quot;</span><span class="cp">{{</span> <span class="nv">type</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        class=&quot;btn btn-</span><span class="cp">{{</span> <span class="nv">style</span> <span class="cp">}}{%</span> <span class="k">if</span> <span class="nv">class</span> <span class="cp">%}</span><span class="x"> </span><span class="cp">{{</span> <span class="nv">class</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">&quot;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">kwargs</span><span class="o">|</span><span class="nf">xmlattr</span> <span class="cp">}}</span><span class="x">&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">text</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">  &lt;/button&gt;</span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<p>An element <code>id</code> would be a good example, and in the above macro it&#8217;s handled implicility
thanks to the <code>{{ kwargs|xmlattr }}</code> stanza.</p>
<p><code>class</code>, however, is not that simple, because a macro like that usually needs to supply some <span class="caps">CSS</span> classes of its own.
The operation of combining them with additional ones, passed by the caller, is awfully textual and error-prone.
It&#8217;s easy, for example, to forget about the crucial space and run two class names&nbsp;together.</p>
<p>As if <span class="caps">CSS</span> wasn&#8217;t difficult enough to debug&nbsp;already!</p>
<h4>Let them have&nbsp;list</h4>
<p>The root cause for any of those problems is working at a level that&#8217;s too low for the task.
The value for a <code>class</code> attribute may be <em>encoded</em> as string, but it&#8217;s fundamentally a <em>list of tokens</em>.
In the modern <span class="caps">DOM</span> <span class="caps">API</span>, for example, it is represented
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/classList">as exactly that</a>: a <code>DOMTokenList</code>.</p>
<p>I&#8217;ve found it helpful to replicate a similar mechanism in Jinja templates. The result is a <code>ClassList</code> wrapper
whose code I quote here in&nbsp;full:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">MutableSet</span>


<span class="k">class</span> <span class="nc">ClassList</span><span class="p">(</span><span class="n">MutableSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data structure for holding, and ultimately returning as a single string,</span>
<span class="sd">    a set of identifiers that should be managed like CSS classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        :param arg: A single class name or an iterable thereof.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s">&quot;expected a string or string iterable, got </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">classes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">classes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__html__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;class=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>
</pre></div>
</td></tr></table>

<p>To make it work with <a href="http://flask.pocoo.org">Flask</a>, adorn the class with
<a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.template_global"><code>Flask.template_global</code> decorator</a>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">myflaskapp</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.template_global</span><span class="p">(</span><span class="s">&#39;classlist&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ClassList</span><span class="p">(</span><span class="n">MutableSet</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>Otherwise, if you&#8217;re working with a raw <a href="http://jinja.pocoo.org/docs/dev/api/#jinja2.Environment">Jinja <code>Environment</code></a>,
simply add <code>ClassList</code> to its <a href="http://jinja.pocoo.org/docs/dev/api/#global-namespace">global namespace</a>&nbsp;directly:</p>
<div class="highlight"><pre><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s">&#39;classlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClassList</span>
</pre></div>


<p>In either case, I recommend following the apparent Jinja convention of naming template symbols
as <code>lowercasewithoutspaces</code>.</p>
<h4>Becoming&nbsp;classy</h4>
<p>Usage of this new <code>classlist</code> helper is relatively straightforward. Since it accepts both a space-separated string
or an iterable of <span class="caps">CSS</span> class names, a macro can wrap anything the caller would pass it as a value for <code>class</code> attribute:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">macro</span> <span class="nv">button</span><span class="o">(</span><span class="nv">text</span><span class="o">=</span><span class="kp">none</span><span class="o">,</span> <span class="nv">style</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="o">,</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;button&#39;</span><span class="o">,</span> <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">set</span> <span class="nv">classes</span> <span class="o">=</span> <span class="nv">classlist</span><span class="o">(</span><span class="nv">class</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="c">{# ... #}</span><span class="x"></span>
</pre></div>


<p>The <code>classlist</code> is capable of producing the complete <code>class</code> attribute syntax (i.e. <code>class="..."</code>), or omit it entirely
if it would be empty. All we need to do is evaluate it using the normal Jinja expression&nbsp;syntax:</p>
<div class="highlight"><pre><span class="x">  &lt;button type=&quot;</span><span class="cp">{{</span> <span class="nv">type</span> <span class="cp">}}</span><span class="x">&quot; </span><span class="cp">{{</span> <span class="nv">classes</span> <span class="cp">}}</span><span class="x"> </span><span class="cp">{{</span> <span class="nv">kwargs</span><span class="o">|</span><span class="nf">xmlattr</span> <span class="cp">}}</span><span class="x">&gt;</span>
</pre></div>


<p>Before that, though, we may want to include some additional classes that are specific to our macro.
The <code>button</code> macro, for example, needs to add the <a href="http://getbootstrap.com/css/#buttons">Bootstrap-specific</a>
<code>btn</code> and <code>btn-$STYLE</code> classes to the <code>&lt;button&gt;</code> element it produces<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre><span class="x">  </span><span class="cp">{%</span> <span class="k">do</span> <span class="nv">classes.add</span><span class="o">(</span><span class="s1">&#39;btn&#39;</span><span class="o">,</span> <span class="s1">&#39;btn-&#39;</span> <span class="o">+</span> <span class="nv">style</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<p>After executing this statement, the final <code>class</code> attribute contains both the caller-provided classes,
as well those two that were added&nbsp;explicitly.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Believe it or not, we can finally
<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/justify-content">center the content vertically</a>
without much of an issue!&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>The <code>{% do %}</code> block in Jinja allows to execute statements (such as function calls) without evaluating values
they return. It is not exposed by default,
but <a href="http://jinja.pocoo.org/docs/dev/api/#jinja2.Environment.add_extension">adding</a> a standard
<a href="http://jinja.pocoo.org/docs/dev/extensions/#expression-statement"><code>jinja2.ext.do</code> extension</a> to the <code>Environment</code>
makes it available.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/sqlalchemy-regex-filters.html#sqlalchemy-regex-filters">Regular expression filters in&nbsp;SQLAlchemy</a></h2>
    <p>
      Posted on Wed 14 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/regular-expressions.html">regular expressions</a>,      <a href="http://xion.io/tag/sqlalchemy.html">SQLAlchemy</a>,      <a href="http://xion.io/tag/sql.html">SQL</a>,      <a href="http://xion.io/tag/postgres.html">Postgres</a>,      <a href="http://xion.io/tag/sqlite.html">SQLite</a>,      <a href="http://xion.io/tag/ast.html">AST</a>      &#8226; <a href="http://xion.io/post/code/sqlalchemy-regex-filters.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>The nice part about <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>
&#8212; an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping"><span class="caps">ORM</span></a> library/framework for Python &#8212;
is that it offers much more than just mapping of <span class="caps">SQL</span> relations to model classes. At its lower level, for example,
there exists an additional layer between those classes and raw <span class="caps">SQL</span> queries: an abstraction for the <em><span class="caps">SQL</span> language itself</em>.</p>
<p>Although it may sound byzantine at first, this extra layer serves two important&nbsp;purposes:</p>
<ul>
<li><em>portability</em>: compiling of the same query to potentially different <span class="caps">SQL</span> syntaxes,
as required by different database&nbsp;backends</li>
<li><em>extensibility</em>: allowing the user to introduce new elements: operators, functions, or even whole&nbsp;statements</li>
</ul>
<p>I&#8217;m going to take advantage of both of these qualities here, and show how you can implement support
for <em>regular expression</em> operators in query filters. On supported database backends, it will allow for powerful
pattern matching on string&nbsp;columns.</p>
<h4>Database&nbsp;side</h4>
<p>We will use the Postgres syntax of <span class="caps">POSIX</span>
<a href="http://www.postgresql.org/docs/9.3/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP">regular expression matchers</a>
as a reference. It includes four operators: for case sensitive or insensitive matching, in regular or negated&nbsp;versions.</p>
<p>Since it&#8217;s a common practice to use an in-memory <a href="https://www.sqlite.org/">SQLite</a> for running database-involved
&#8220;unit&#8221; tests<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>, we will also add support for that backend. Regular expressions are not implemented there directly,
but thanks to
<a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"><code>sqlite3</code><span class="quo">&#8216;</span>s custom function ability</a>,
it&#8217;ll be easy enough to provide the necessary support in&nbsp;Python.</p>
<h4>Desired <span class="caps">API</span></h4>
<p>In essence, what we want to do is to enhance the <code>String</code> column type with additional <em>comparators</em>, which will then
be usable as arguments for the <code>Query.filter</code> method.</p>
<p>As an example, consider the following model class with a string&nbsp;column:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nick</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="c"># ...</span>
</pre></div>


<p>Once we&#8217;re done, it should be possible to query for e.g. all the people whose nicks contain numbers
in a pretty straightforward&nbsp;fashion:</p>
<div class="highlight"><pre><span class="n">numerics</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">nick</span><span class="o">.</span><span class="n">regexp</span><span class="p">(</span><span class="s">r&#39;\d+&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>Because of the limitations of underlying databases backends, only <em>literal</em> regular expressions would be supported.
It means that, from the <span class="caps">SQL</span> standpoint, they have to be constants: you cannot use the value of one column as part
of a regular expression that another column is matched&nbsp;against.</p>
<p>But of course, you can still construct those literals in Python&nbsp;code:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_copycats</span><span class="p">(</span><span class="n">nick</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all the people who tried to parrot given nick</span>
<span class="sd">    but failed and had to append some numbers to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nick_regexp</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">nick</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;\d+$&#39;</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">nick</span><span class="o">.</span><span class="n">regexp</span><span class="p">(</span><span class="n">nick_regexp</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>Considering that regular expressions themselves are already pretty powerful, this really ought to be sufficient
for all reasonable&nbsp;purposes.</p>
<h4>How comparators&nbsp;work?</h4>
<p>So how do we add the <code>regexp</code> method to the <code>String</code> type? It may seem logical to simply extend the class
and add it&nbsp;directly:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span> <span class="k">as</span> <span class="n">_String</span>


<span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">_String</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enhanced version of the standard string type.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># hmm...</span>
</pre></div>


<p>But this won&#8217;t actually work. In SQLAlchemy, objects like <code>String</code> or <code>Integer</code> do not represent columns of certain type;
they correspond to <em>types themselves</em><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. Extending them with additional methods won&#8217;t do much good, because regular code
rarely operates on column&nbsp;types.</p>
<p>On the other hand, though, we obviously don&#8217;t want to mess with the <code>Column</code> class itself. Our additions are only
meaningful for string columns, but putting them there would expose them to <em>all</em> columns, regardless of&nbsp;type!</p>
<p>Thankfully, there is an intermediate mechanism which SQLAlchemy introduced precisely to address the need we&#8217;ve got here.
Every column type can define a
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/type_api.html#sqlalchemy.types.TypeEngine.comparator_factory"><code>comparator_factory</code></a>: a kind of mixin class whose methods are incorporated into columns of that type.
By <a href="http://docs.sqlalchemy.org/en/rel_0_9/core/custom_types.html#types-operators">overriding this inner class</a>,
we can both modify the behavior of existing operators, as well as introduce completely new&nbsp;ones.</p>
<p>So in order to add <code>regexp</code> and other methods to all <code>String</code> columns, our new string type must define its own
<code>comparator_factory</code>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">_String</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">comparator_factory</span><span class="p">(</span><span class="n">_String</span><span class="o">.</span><span class="n">comparator_factory</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="c"># ...</span>
</pre></div>


<p>We need to remember about deriving it from the original one, too. Otherwise, all the standard operators
you&#8217;d want to use in queries (<code>==</code>, <code>+</code>, etc.) would cease to work, because the new <code>comparator_factory</code> wouldn&#8217;t
include an implementation of any of the necessary magic methods (<code>__eq__</code>, <code>__add__</code>,&nbsp;etc.).</p>
<h4><span class="caps">SQL</span>,&nbsp;abstracted</h4>
<p>Knowing where to put our new comparator methods is certainly desirable, but the more interesting question is
how do we implement&nbsp;them?</p>
<p>Like I&#8217;ve mentioned in the beginning, SQLAlchemy employs an additional layer between
<span class="caps">ORM</span> models and raw, textual <span class="caps">SQL</span> language. Basically, it&#8217;s an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"><span class="caps">AST</span></a>
for backend-independent queries which includes almost all of the various <span class="caps">SQL</span> constructs, codified in a platform-agnostic
way inside the <code>sqlalchemy.sql</code> package.</p>
<p>You may have used this layer directly if you ever wrote queries based on
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/metadata.html#sqlalchemy.schema.Table"><code>Table</code> objects</a> and ran them with
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/session_api.html#sqlalchemy.orm.session.Session.execute"><code>Session.execute</code></a>. But even those constructed using the more familiar
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query"><code>Query</code> class</a> interface
end up in this intermediate representation. Often there is little to no additional processing&nbsp;involved.</p>
<p>Arguments to the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query.filter"><code>Query.filter</code> method</a>,
for example, are already given as <span class="caps">SQL</span> clause objects. It just so happens that its creation is hidden behind
a very neat, operator-based <span class="caps">API</span>.</p>
<p>Thus, if our regular expression filters are to cooperate, they also need to return pieces of the <span class="caps">SQL</span> syntax tree.
Not very complicated pieces, mind you, since we only need to represent simple expressions: something like <code>foo ~ 'bar'</code>, where <code>~</code> may optionally be replaced by one of the other three&nbsp;operators.</p>
<h4>Creating the&nbsp;node</h4>
<p>They are all <em>binary</em> operators, by the way (i.e. taking exactly two arguments), so it makes sense that the corresponding
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.BinaryExpression"><span class="caps">AST</span> node class</a> is called <code>BinaryExpression</code>. The node&#8217;s children are the left argument, the right argument, and the operator&nbsp;itself.</p>
<p>With a little help from a few more <span class="caps">SQL</span> syntax wrappers, the implementation of <code>regexp</code> and the other methods
turns out to be quite&nbsp;straightforward:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">BinaryExpression</span><span class="p">,</span> <span class="n">literal</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.operators</span> <span class="kn">import</span> <span class="n">custom_op</span>


<span class="c"># (inside String.comparator_factory)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~*&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">not_regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;!~&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">not_iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;!~*&#39;</span><span class="p">))</span>
</pre></div>


<p>The use of
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.literal"><code>literal</code> function</a>
is dictated by the limitation that was mentioned earlier: any regular expression given in the query must be a <span class="caps">SQL</span> literal.
If we now try to pass a column-like clause, we&#8217;ll get an exception right at the query definition, rather than
a database error when we try to execute&nbsp;it.</p>
<p>The <a href="docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.operators.custom_op"><code>custom_op</code> function</a>,
on the other hand, is simply the easiest way to create an &#8220;operator node&#8221; that&#8217;s required as a child
of <code>BinaryExpression</code>. Since it&#8217;s a custom operator, it won&#8217;t be interpreted by SQLAlchemy in any way; it will simply
be used verbatim in the final <span class="caps">SQL</span> string that&#8217;s sent to the&nbsp;database.</p>
<h4>Compile!</h4>
<p>You may have noticed that this would pose a problem if said database doesn&#8217;t support <code>~</code> or the other operators,
which happens to be the case for everything besides Postgres. Because we originally intended to support SQLite in addition
to Postgres, this is evidently a&nbsp;problem.</p>
<p>It&#8217;s also where the portability of an intermediate <span class="caps">SQL</span> representation comes into play. Since our new operators return
<span class="caps">AST</span> nodes and not just textual <span class="caps">SQL</span>, we can redefine the way those nodes are <em>compiled</em> into actual query fragments
on various database&nbsp;backends.</p>
<p>To accomplish that, first we need to distinguish our regex filters from other <code>BinaryExpression</code>s:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RegexMatchExpression</span><span class="p">(</span><span class="n">BinaryExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents matching of a column againsts a regular expression.&quot;&quot;&quot;</span>

<span class="c"># (inside String.comparator_factory)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RegexMatchExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">))</span>
<span class="c"># etc.</span>
</pre></div>


<p>Once we&#8217;ve introduced such a distinction, it becomes possible to provide a different way for those filters to be turned
into <span class="caps">SQL</span>. We can namely define a new compilation routine for them,
and <a href="docs.sqlalchemy.org/en/rel_0_9/core/compiler.html#sqlalchemy.ext.compiler.compiles">mark it as canonical</a>
for a specific <span class="caps">SQL</span>&nbsp;dialect:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile the SQL expression representing a regular expression match</span>
<span class="sd">    for the SQLite engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># ...</span>
</pre></div>


<p>The function receives an <span class="caps">AST</span> <code>element</code> to process (here, the <code>RegexMatchExpression</code>), along with a
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/internals.html#sqlalchemy.sql.compiler.SQLCompiler">special <code>compiler</code> object</a>
that controls the whole translation process. Armed with those tools, we are allowed to modify the process
in arbitrary ways and output just the right <span class="caps">SQL</span> statement that&#8217;ll do the job in&nbsp;SQLite.</p>
<h4>Regex support&nbsp;lite</h4>
<p>How does such a statement look like, though? As I&#8217;ve remarked early on, SQLite is very easy to extend with your own
functions, and the <code>sqlite3</code> driver used by SQLAlchemy enables us to write those functions directly in Python.
Obviously, this is fantastic news when you have something like
<a href="https://docs.python.org/2/library/re.html">the standard <code>re</code> module</a> at your&nbsp;disposal.</p>
<p>Indeed, coding the four required functions is quite&nbsp;trivial:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="c"># Mapping from the regular expression matching operators</span>
<span class="c"># to named Python functions that implement them for SQLite.</span>
<span class="n">SQLITE_REGEX_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;~&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;REGEXP&#39;</span><span class="p">,</span>
          <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">))),</span>
    <span class="s">&#39;~*&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;IREGEXP&#39;</span><span class="p">,</span>
           <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))),</span>
    <span class="s">&#39;!~&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NOT_REGEXP&#39;</span><span class="p">,</span>
           <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">)),</span>
    <span class="s">&#39;!~*&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NOT_IREGEXP&#39;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)),</span>
<span class="p">}</span>
</pre></div>


<p>What&#8217;s less apparent is how &#8212; or rather, <em>when</em> &#8212; to instruct the SQLite database to use them.
As per the <a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"><span class="caps">API</span> we have to use</a>,
custom SQLite functions are created on a per-connection basis. But SQLAlchemy, like any good database interface,
takes care of connection management, lifecycle, and pooling. Nowhere in our application there is a <code>connect</code> call
(nor there should be!) that we could just follow with a few <code>create_function</code> invocations.</p>
<p>Yet, there is a way of doing exactly what we require, and it involves utilizing the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/event.html">event subsystem</a> included in SQLAlchemy. Anytime something
interesting happens to any of its <span class="caps">ORM</span> or core objects &#8212; models, sessions, connection pools, etc. &#8212; SQLAlchemy
publishes an <em>event</em> that our application code can <em>listen</em> (subscribe) to. It&#8217;s a classic
<a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">PubSub system</a> that introduces some serious potential
for&nbsp;extensibility.</p>
<p>Our use of it will be pretty modest, though. All we&#8217;re interested in is the establishing of a connection
to the SQLite database. This translates directly to a <code>'connect'</code> event of the
<a href="docs.sqlalchemy.org/en/rel_0_9/core/connections.html"><code>Engine</code> object</a>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Engine</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s">&#39;connect&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_engine_connect</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listener for the event of establishing connection to a SQLite database.</span>

<span class="sd">    Creates the functions handling regular expression operators</span>
<span class="sd">    within SQLite engine, pointing them to their Python implementations above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">SQLITE_REGEX_FUNCTIONS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
</pre></div>


<p>Note that this will catch all the connection events, so we have to verify it&#8217;s really SQLite we&#8217;re talking to.
Afterwards, the creation of <code>REGEXP</code>, <code>IREGEXP</code>, etc. functions is extremely&nbsp;straightforward.</p>
<h4>Compilation, take&nbsp;two</h4>
<p>This was quite a build-up, but now we&#8217;re very close to the finale. What remains is finishing the compilation&nbsp;routine:</p>
<div class="highlight"><pre><span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>We know that <code>element</code> corresponds to an expression in the form of <code>a ~ 'foo'</code>. For SQLite, however, the compatible
version is a <em>function call</em>: <code>REGEXP(a, 'foo')</code>. At first this may appear rather disconcerting, because it&#8217;s basically
a completely different <span class="caps">AST</span> node to&nbsp;build.</p>
<p>But it&#8217;s actually not a problem at all. Inside compiler hooks, we are allowed to use the much of the same <span class="caps">API</span> that&#8217;s
available when drafting regular queries. This includes the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.func"><code>func</code> factory object</a>
which produces calls to arbitrary <span class="caps">SQL</span> functions. Rather than compiling the original binary expression, we&#8217;ll simply
poach its operands and use them as arguments to one of the new&nbsp;functions:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">func</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="c"># determine the name of a custom SQLite function to use for the operator</span>
    <span class="n">operator</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">opstring</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SQLITE_REGEX_FUNCTIONS</span><span class="p">[</span><span class="n">operator</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">would_be_sql_string</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">left</span><span class="p">),</span>
                                        <span class="n">operator</span><span class="p">,</span>
                                        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">right</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">StatementError</span><span class="p">(</span>
            <span class="s">&quot;unknown regular expression match operator: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">,</span>
            <span class="n">would_be_sql_string</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c"># compile the expression as an invocation of the custom function</span>
    <span class="n">regex_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
    <span class="n">regex_func_call</span> <span class="o">=</span> <span class="n">regex_func</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">regex_func_call</span><span class="p">)</span>
</pre></div>


<p>Notice how <code>compiler.process</code> is used to obtain the final result. The <code>compiler</code> object doesn&#8217;t care that we use it on
a totally different <span class="caps">AST</span> node; it will dutifully carry out its compilation into raw <span class="caps">SQL</span>. We can even use this capability
to add a little bit of paranoid error handling: if we encounter an unknown operator, the resulting error message
will include fully compiled, <span class="caps">SQL</span> versions of both&nbsp;arguments.</p>
<h4>Summary</h4>
<p>This concludes our efforts: the original query examples with <code>Person.nick.regexp</code> should now work
in both Postgres and SQLite.
For you convenience, I&#8217;ve bundled all the code in <a href="https://gist.github.com/Xion/204ddbd020f1a4275a53">this gist</a>.</p>
<p>If you feel like tinkering with it further, I would suggest you try to remove the superfluous <code>NOT_*</code> functions.
They make little sense given that <span class="caps">SQL</span> has a perfectly adequate <code>NOT</code> keyword. A clean solution would probably prefer
an additional <code>reverse</code> flag in <code>RegexMatchExpression</code> over looking for a <code>'!'</code> character in the operator&nbsp;string.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It may or <a href="http://michael.robellard.com/2015/07/dont-test-with-sqllite-when-you-use.html">may not be</a>
a <em>good</em> practice, though.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Although it&#8217;s possible to write <code>Column(Integer)</code>, it&#8217;s merely a syntactical convenience.
SQLAlchemy interprets it readily as <code>Column(Integer())</code>. Parameterized types &#8212; like <code>String</code> &#8212; always require explicit
instantiation.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/dont-copy-paste-retype.html#dont-copy-paste-retype">Don&#8217;t Copy <span class="amp">&amp;</span> Paste.&nbsp;Retype.</a></h2>
    <p>
      Posted on Sat 03 October 2015 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/problem-solving.html">problem solving</a>,      <a href="http://xion.io/tag/stack-overflow.html">Stack Overflow</a>,      <a href="http://xion.io/tag/typing.html">typing</a>      &#8226; <a href="http://xion.io/post/programming/dont-copy-paste-retype.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In this day and age, Google and <a href="http://stackoverflow.com">Stack Overflow</a> are quite essential tools for any developer.
Lately, though, the latter seems to be getting some bad rap. On one side, it&#8217;s because of seemingly peculiar
and sometimes alienating <a href="https://medium.com/@johnslegers/the-decline-of-stack-overflow-7cb69faa575d">moderation policies</a>.
But more pertinently, it&#8217;s the apparent rise of a phenomenon that&#8217;s wittily dubbed
&#8220;the <a href="https://www.christianheilmann.com/2015/07/17/the-full-stackoverflow-developer/">full Stack Overflow developer</a>&#8220;.</p>
<p>In a nutshell, individuals deserving to be called that are code slingers who throw software artifacts together mostly by
copying and pasting code samples found in Stack Overflow answers. They may be getting something working pretty quickly,
but they also lack understanding of problems they&#8217;re facing and solutions they&#8217;re using so&nbsp;cheerily.</p>
<p>Of course, not every instance of code Copy Pasta is to be scorned. I&#8217;m pretty sure most people reading this post
(and certainly the person writing it!) are guilty of replicating at least a few snippets from Stack Overflow, verbatim,
in their own codebase. Heck, we may have even done so with nigh zero interest as to why it has been written this way.
Not every technology is intrinsically fascinating, after all, and deadlines are sometimes too close for&nbsp;comfort.</p>
<p>But if so, does it mean we are gradually turning into full Stack Overflow developers?&#8230;
Yikes! Surely we don&#8217;t want that to&nbsp;happen!</p>
<h4>Mitigation&nbsp;tactic</h4>
<p>Before you shut off your Internet connection altogether while coding, consider employing the following technique
whenever you feel like scraping a piece of code from Stack Overflow, and dumping it in your project&nbsp;source.</p>
<p>Don&#8217;t use the clipboard. Don&#8217;t copy and paste. <strong>Retype</strong> the code you&#8217;ve found&nbsp;instead.</p>
<p>It&#8217;s going to take more time, yes. It&#8217;s definitely more cumbersome than just hitting <em>Ctrl+C</em>/<em>Ctrl+V</em>.
It may also make little sense: if the end result is the same, why does it matter whether the code was transfered
through the clipboard or&nbsp;not?</p>
<h4>Rationale</h4>
<p>I&#8217;d argue, however, that it makes perfect sense. From the least to the most important, the reasons why I think so
are the&nbsp;following:</p>
<ul>
<li>
<p>The fact that retyping is slower than copy-pasting is what actually makes it <em>better</em>. If you vow not to use
the clipboard, you&#8217;re much less likely to just pick whatever&#8217;s the first Stack Overflow result Google has given.
You&#8217;ll weigh different solutions, and you&#8217;ll be rightfully biased towards shorter and simpler&nbsp;ones.</p>
</li>
<li>
<p>When you type something, you cannot do it completely thoughtlessly. Whether you want it or not, you&#8217;ll absorb
some of the knowledge through sheer osmosis, because the code will flow through your eyes and fingers as it&#8217;s transfered
from the browser to your editor or <span class="caps">IDE</span>. Your subconscious brain will latch onto the bits and pieces of information,
and it will sort them out for you to use later. Even if you didn&#8217;t intend to, you will most likely <em>learn something</em>.</p>
</li>
<li>
<p>But most importantly, what you type almost certainly won&#8217;t be a perfect copy of the original snippet.
As you progress through the code, you&#8217;ll inevitably deviate from it, if only to conform to a particular style guide
your project is following.<br>
It&#8217;s quite likely, though, that you&#8217;ll make larger changes as well.
You will replace familiar patterns with calls to utility functions.
You&#8217;ll rearrange the code visually for better readability.
You will add comments, or extract functions to make it more self-documenting.
You might even enhance and customize it, so that you can abstract and reuse it multiple&nbsp;times.</p>
</li>
</ul>
<p>Afterwards, what you&#8217;ve just typed won&#8217;t be just some code you have found on the Internet. It&#8217;ll be <em>your code</em>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/requirejs-optional.html#requirejs-optional">Optional loading of RequireJS&nbsp;modules</a></h2>
    <p>
      Posted on Tue 29 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/javascript.html">JavaScript</a>,      <a href="http://xion.io/tag/requirejs.html">RequireJS</a>,      <a href="http://xion.io/tag/modules.html">modules</a>,      <a href="http://xion.io/tag/web-workers.html">Web Workers</a>,      <a href="http://xion.io/tag/dom.html">DOM</a>,      <a href="http://xion.io/tag/ajax.html">AJAX</a>      &#8226; <a href="http://xion.io/post/code/requirejs-optional.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://requirejs.org/">RequireJS</a> is a module loader for JavaScript. Similar to its alternatives such as
<a href="http://browserify.org/">Browserify</a>, it tries to solve an important problem on the web front(end):
dividing JavaScript code into modules for better maintainability while still loading them correctly and efficiently
without manual curation of the <code>&lt;script&gt;</code> tags.</p>
<p>Once it&#8217;s configured correctly (which can be rather <a href="http://requirejs.org/docs/api.html#config">non-trivial</a>, though),
modules in RequireJS are simply <code>define</code>d as functions that return arbitrary JavaScript&nbsp;objects:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;jquery&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lodash&#39;</span><span class="p">,</span>

    <span class="s1">&#39;myapp/dep1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;myapp/dep2&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dep1</span><span class="p">,</span> <span class="nx">dep2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... all of the module&#39;s code ...</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">exportedSymbol1</span><span class="o">:</span> <span class="p">...,</span>
        <span class="nx">exportedSymbol2</span><span class="o">:</span> <span class="p">...,</span>
    <span class="p">};</span>
<span class="p">});</span>
</pre></div>


<p>Before executing the function, RequireJS loads all the specified dependencies, repeating the process recursively
and asynchronously. Return values from module functions are passed as parameters to the next module function,
and thus the whole mechanism clicks, serving as a crafty workaround for the lack of proper <code>import</code> functionality<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>Relative&nbsp;failures</h4>
<p>If, at some point in the chain, the desired module cannot be found or loaded, the entire process grinds to a halt
with an error. Most of the time, this is perfectly acceptable (or even desirable) behavior, equivalent to an incorrect
<code>import</code> statement, invalid <code>#include</code> directive, or similar mistake in other&nbsp;languages.</p>
<p>But there are situations when we&#8217;d like to proceed with a missing module, because the dependent code is prepared
to handle it. The canonical example are
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Web Workers</a>.
Unlike traditional web application code, Web Worker scripts operate outside of a context of any single page,
having no access to the <abbr title="Document Object Model"><span class="caps">DOM</span></abbr> tree (because <em>which</em> <span class="caps">DOM</span> tree would it be?).
Correspondingly, they have no <code>document</code> nor <code>window</code> objects in their global&nbsp;scope.</p>
<p>Unfortunately, some libraries (<em>*cough*</em> jQuery <em>*cough*</em>) require those objects as a hard (and usually implicit)
dependency. This doesn&#8217;t exactly help if we&#8217;d like to use them in worker code for other features, not related to <span class="caps">DOM</span>.
In case of jQuery, for example, it could be the <span class="caps">API</span> for making <span class="caps">AJAX</span> calls, which is still decidedly more pleasant
than dealing with bare <code>XMLHTTPRequest</code> if we&#8217;re doing anything&nbsp;non-trivial.</p>
<p>Due to this hard dependency on <span class="caps">DOM</span>, however, Web Workers cannot <code>require</code> jQuery. No biggie, you may think: browsers
supporting workers also offer an excellent, promise-based
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch <span class="caps">API</span></a> that largely replaces the old <span class="caps">AJAX</span>,
so we may just use it in worker code. Good thinking indeed, but it doesn&#8217;t solve the issue of <em>sharing code</em> between
main (&#8220;<span class="caps">UI</span>&#8221;) part of the app and Web&nbsp;Workers.</p>
<p>Suppose you have the following dependency&nbsp;graph:</p>
<p><div class="graphviz" style="text-align: center;"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAD7CAYAAAAvttudAAAy0klEQVR4Ae2dBbhVVRbHtzEWtoiOimJjIphYYHegjgp2d4/1GTjG2DHGOJigiIqtYIGK2DN2JyCYOHYyo+5ZvzXu63n3nXvejXPuPbHX95137juxY529dqz476mstcONJ88Bz4FQDkwlAmJD7/iLngOeA2ZqzwPPAc+ByhzwAlKZN/6O54AfQXwb8ByI4sC0UTeTvvfvf//bvPrqq3qMGzfOfPTRR3p8/PHH5rvvvjM//vij+emnn8x///tfM8MMM+gx44wzmtlnn93MN998esw///yme/fuZtlllzVLLbWUPpN0uYuQ/i+//GI++OADM378eMO3mTBhgvnss88M38wdX3/9tfnPf/5jpkyZUjrDm+mnn95MN910pfNss81mOnfuXDrmnntu061bN7PIIouYhRde2CywwAJmmmmmSSVbm7pIRxgeffRRPR5//HGDIEBzzjmnWXzxxQ2NnYb/xz/+0cwyyywlgfjDH/6ggoKwIDRffPFFSZj4iG+//bZ+JJiMkKy99tqmT58+eswzzzypZHyaCjV58mTzwgsvmBdffLF0vPfee9oxUc6ZZppJGzS8nGuuuUoNnY4KYQgKBM8HBYbfX331VUmoPv/8c/Ppp5+qwP3www88bvi+iy22mOnRo4dZYYUV9OjZs6fp0qWL3m/ln0QF5NdffzVPPPGEuf322/WYOHGioTdZc801zVprrWV69eqlPT8C0QjR273zzjs6Ej3zzDNm7Nix5vnnnzdcX2211cw222xjtt12W+2tGsknL+8yUo8ZM6bUWb311ltaNXpyGinHMsssU+rhk+pkEBQ3Qr322mvmpZdeUgH98MMPtTxLLrlkqaPr27evdp5N/waoeeOmTz75xJ5xxhl2oYUWQoVsl156aXvCCSfYf/3rX1YabdzZhab37bff2rvvvtvuvvvuVkYoLYcw2d50001WpgWh7+T5oowO9pRTTrHSMysvpNe2vXv3tscdd5y99957rUybUlN9ykKZKBtlpKy0I8pOHahLs8jEmZH04na33XbTCtEojzjiCCs9Q5xZ1JWWrGGU4VtttZWVaZiVHtGeffbZVtY5daWXlZdk3WAHDhxoZZ6vDUymr3b//fdXXnz//fdZqYalrAgMZacOCAt1om7UMUmKRUBk6qSCQeNbYokl7LXXXmtlrZBkuetOW9Ys9thjj7UzzzyzlcWiPe+886zMk+tOL20vMkLfcsstdv3117dTTTWVlXm8PfLII3X0lilv2opbc3moAzMR6kTdqCN1pc5JzE4aEhB65nPOOcd26tTJLrroonbo0KH2559/rrnSrXiBYfz444+3ohWzogWzDz/8cCuKEVueosCwgwYNsrLYtVNPPbXdcsst7V133WX5Rnkl6kYdt9hiC60zdYcH8CIuqltAXn/9dbv88strAzv11FNjLVRclasmHVkkamNi2N577711OK/mvbQ8Q6951VVXWVF0WNEm2X322cfKojstxWtaOagzdYcH8AKexDGi1CUg11xzjRXVn1111VWtqAObxoQkM7rtttt0MY9C4ZVXXkkyq9jSZtQTjZOddtpp7YEHHmhRjhSd4AG8gCfwptGZQU0CwvyPhTfzPjQMeRu+WUuJClrXJw888EBq2xoaOkY7Rj2mF2+88UZqy9qqgsETeONmBvCsHqpaQFCN9u/f34qF1A4bNqyevDLxDvXcZZddVBN3/fXXp67MYmBVDY5YpnVhmroCpqxALN7hFVoveFcrVSUgjBwDBgzQnrXRIavWArbq+WOOOUYXfjA4LXTllVeq4LIAFyNbWoqV+nLAK3iGPQUe1kJVCQjTKkaOUaNG1ZJ25p89+OCDddH3yCOPtLQudFBHH320Tm1POukky/+eauMAPIN3LA/gZbU87FBAbrzxRp3HcS4awcTttttO7SXiN9aS6lMGtDP0fkX8BnEzHR7CS3hajZBECghWSvGdUq1A3AXNSnrffPON2ng23HDDqhgad70wamKAHT58eNxJFzY9eAlPUTR1RJECghYAtWdareIdVS6u++IAqeuR6667Lq4kq0rnhhtu0NEbzwRP8XIAnqLhgsdRVFFAxC1dE7j//vuj3i/Mvb322ssuuOCCTTOIMnrjDnP44YcXhsfNrii8hcdR/lwV3d3XWWcd9dN/8MEHRdA84SJOzIL4bhkxRCXOEBm9NVAJt33iLTzFzwFiVQi5IHDrnnvuCc0gVEDeffddDWAaMWKE2WyzzUJfjOOiqIw1eCaYFtGBBMtARKyJF2fwtlljjTU0xqTNRfmHGJOuXbuWX471f3GdN2JlN88991ys6ZYn9thjj2nQl2gNjTjild/OzP8EXfH9iDPp169f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"></div></p>
<p>The <code>common</code> module has some logic that we&#8217;d want reused between regular <code>&lt;script&gt;</code>-based code and a Web Worker,
but its dependency on jQuery makes it impossible. It would work, however, if this dependency was a <em>soft</em> one.
If <code>common</code> could <em>detect</em> that jQuery is not available and fall back to other solutions (like the Fetch <span class="caps">API</span>),
we would be able to <code>require</code> it in both execution&nbsp;environments.</p>
<h4>The <code>optional</code> plugin</h4>
<p>What we need, it seems, is an ability to say that some dependencies (like <code>'jquery'</code>) are <em>optional</em>. They can be loaded
if they&#8217;re available but otherwise, they shouldn&#8217;t cause the whole dependency structure to crumble. RequireJS does not
support this functionality by default, but it&#8217;s easy enough to add it via a <em>plugin</em>.</p>
<p>There are already <a href="https://github.com/jrburke/requirejs/wiki/Plugins">several useful plugins</a> available for RequireJS
that offer some interesting features. As of this writing, however, optional module loading doesn&#8217;t seem to be among them.
That&#8217;s not a big problem: rolling out our own<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> plugin turns out to be relatively&nbsp;easy.</p>
<p><a href="http://requirejs.org/docs/plugins.html">RequireJS plugins</a> are themselves modules: you create them as separate JavaScript
files having code wrapped in <code>define</code> call. They can also declare their own dependencies like any other module.
The only requirement is that they export an object with <a href="http://requirejs.org/docs/plugins.html#api">certain <span class="caps">API</span></a>:
at minimum, it has to include the <code>load</code> method. Since our <code>optional</code> plugin is very simple, <code>load</code> is in fact
the only method we have to&nbsp;implement:</p>
<div class="highlight"><pre><span class="cm">/* Skeleton of a simple RequireJS plugin module. */</span>

<span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

<span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">parentRequire</span><span class="p">,</span> <span class="nx">onload</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="nx">load</span><span class="p">,</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>


<p>As its name would hint, <code>load</code> carries out the actual module loading which a plugin is allowed to influence, modify,
or even replace with something altogether different. In our case, we don&#8217;t want to be too invasive, but we need to
detect failure in the original loading procedure and step&nbsp;in.</p>
<p>I mentioned previously that module loading is asynchronous, which JavaScript often translates to &#8220;callbacks&#8221;.
Here, <code>load</code> receives the <code>onload</code> callback which we eventually need to invoke. It also get the mysterious
<code>parentRequire</code> argument; this is simply a regular <code>require</code> function that&#8217;d normally be used if our plugin didn&#8217;t
stand in the&nbsp;way.</p>
<p>Those two are the most important pieces of the puzzle, which overall has a pretty succinct&nbsp;solution:</p>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * RequireJS plugin for optional module loading.</span>
<span class="cm"> */</span>
<span class="nx">define</span> <span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>


<span class="cm">/** Default value to return when a module failed to load. */</span>
<span class="kd">var</span> <span class="nx">DEFAULT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">parentRequire</span><span class="p">,</span> <span class="nx">onload</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parentRequire</span><span class="p">([</span><span class="nx">moduleName</span><span class="p">],</span> <span class="nx">onload</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">failedModule</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">&amp;&amp;</span> <span class="nx">requireModules</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Could not load optional module: &quot;</span> <span class="o">+</span> <span class="nx">failedModule</span><span class="p">);</span>
        <span class="nx">requirejs</span><span class="p">.</span><span class="nx">undef</span><span class="p">(</span><span class="nx">failedModule</span><span class="p">);</span>

        <span class="nx">define</span><span class="p">(</span><span class="nx">failedModule</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">DEFAULT</span><span class="p">;</span> <span class="p">});</span>
        <span class="nx">parentRequire</span><span class="p">([</span><span class="nx">failedModule</span><span class="p">],</span> <span class="nx">onload</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="nx">load</span><span class="p">,</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>


<p>The logic here is as&nbsp;follows:</p>
<ul>
<li>First, try to load the module normally (via the outer <code>parentRequire</code> call).</li>
<li>If it succeeds, <code>onload</code> is called and there is nothing for us to&nbsp;do.</li>
<li>If it fails, we log the <code>failedModule</code> and cleanup some internal RequireJS state with <code>requirejs.undef</code>.</li>
<li>Most importantly, we <code>define</code> the module as a trivial shim that returns some <code>DEFAULT</code> (here, <code>null</code>).</li>
<li>As a result, when we require it again (through the inner <code>parentRequire</code> call), we <em>know</em> it&#8217;ll be loaded&nbsp;successfully.</li>
</ul>
<h4>Usage</h4>
<p>Plugins in RequireJS are invoked on a per-module basis. You can specify that a certain dependency <code>'bar'</code> shall be loaded
through a plugin <code>'foo'</code> by putting <code>'foo!bar'</code> on the dependency&nbsp;list:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span> <span class="s1">&#39;foo!bar&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>Both <code>'foo'</code> and <code>'bar'</code> represent module paths here: the first one is the path to the <em>plugin</em> module,
while the second one is the actual dependency. In a more realistic example &#8212; like when our optional loader is involved &#8212;
both of them would most likely be multi-segments&nbsp;paths:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;myapp/ext/require/optional!myapp/common/buttons/awesome-button&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>As you can see, they can get pretty unreadable rather quickly. It would be better if the plugin prefix consisted
of just one segment (i.e. <code>optional!</code>) instead. We can make that happen by adding
<a href="http://requirejs.org/docs/api.html#config-map">a mapping</a> to the RequireJS&nbsp;config:</p>
<div class="highlight"><pre><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="c1">// ...</span>
    <span class="nx">map</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;optional&#39;</span><span class="o">:</span> <span class="s1">&#39;myapp/ext/require/optional&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>


<p>With this renaming in place, the loading of non-mandatory dependencies becomes quite a bit&nbsp;clearer:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;optional!myapp/common/buttons/awesome-button&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>

<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... (some work around) ...</span>
<span class="p">}</span>

<span class="p">});</span>
</pre></div>


<p>Of course, you still need to actually code around the potential lack of an optional dependency.
The <code>if</code> statement above is just an illustrative example; you may find it more sensible to provide some shim&nbsp;instead:</p>
<div class="highlight"><pre><span class="nx">AwesomeButtonController</span> <span class="o">=</span> <span class="nx">AwesomeButtonController</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</pre></div>


<p>Either way, I recommend trying to keep the size of such conditional logic to a minimum.
Ideally, it should be confined to a single place, or &#8212; better yet &#8212; abstracted behind a&nbsp;function.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>An actual <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import"><code>import</code> statement</a>
has made it into the <span class="caps">ES6</span> (ECMAScript 2015) standard but, as of this writing, no browser implements it.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Most of the code for the plugin presented here is based on
<a href="http://stackoverflow.com/a/27422370/434799">this StackOverflow answer</a>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://xion.io/index5.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
    <a class="btn float-right" href="http://xion.io/index3.html">
      Newer Posts <i class="fa fa-angle-right"></i>
    </a>
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>