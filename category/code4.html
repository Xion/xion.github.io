<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog &ndash; Category: Code</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/code/celery-include-flask-request-context.html#celery-include-flask-request-context">Celery task in a Flask request&nbsp;context</a></h2>
    <p>
      Posted on Tue 03 November 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/celery.html">Celery</a>,      <a href="http://xion.io/tag/flask.html">Flask</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/queue.html">queue</a>,      <a href="http://xion.io/tag/request-context.html">request context</a>      &#8226; <a href="http://xion.io/post/code/celery-include-flask-request-context.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://celeryproject.org">Celery</a> is an asynchronous task worker that&#8217;s frequently used for background processing
in Python web apps. Rather than performing a time-consuming task within the request loop, we delegate it to a <em>queue</em>
so that a <em>worker process</em> can pick it up when ready. The immediate benefit is much better latency for the end user.
Pros also include easier scalability, since you can adjust the number of workers to your task&nbsp;load.</p>
<p>Examples of tasks that are usually best done in the background vary from fetching data through a third-party <span class="caps">API</span>
to sending emails, and from pushing mobile notifications to pruning the database of stale records. Anything that may
take more than a couple hundred milliseconds to complete &#8212; and isn&#8217;t absolutely essential to the current <span class="caps">HTTP</span> request &#8212;
is typically a good candidate for asynchronous&nbsp;processing.</p>
<p>In Celery, workers are just regular Python processes, often running the exact same code that&#8217;s powering the app&#8217;s web
frontend<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. But unlike most of that code, they aren&#8217;t servicing any <span class="caps">HTTP</span> requests &#8212; they simply run some function
with given arguments, both specified by whomever sent a task for execution. Indeed, those functions don&#8217;t even <em>know</em>
who or what asked for them to be&nbsp;executed.</p>
<p>Neat, right? It is what we usually compliment as <em>decoupling</em>, or separation of concerns. They are valuable qualities even
regardless of the <span class="caps">UI</span> and scaling benefits mentioned&nbsp;earlier.</p>
<h4>Not quite&nbsp;web</h4>
<p>But those qualities come with a trade-off. Task code is no longer a web frontend code: it doesn&#8217;t run within the
comfy environment of our web framework of choice. Losing it may be quite unnerving, actually, because in a typical
web application there will be many things tied directly to the <span class="caps">HTTP</span> request pipeline. After all, this is what web
applications <em>do</em> &#8212; respond to <span class="caps">HTTP</span> requests &#8212; so it often makes perfect sense e.g. to marry the request flow
with database transactions, committing or rolling those back according to <span class="caps">HTTP</span> status code that the app&nbsp;produced.</p>
<p>Tasks may also require a database, though, if only to
<a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#state">assert the expected state of the world</a>.
Similar goes for memcache, a Redis instance, or basically any resource used by the frontend code.
Alas, it&#8217;s quite possible <em>the very reason</em> we delegate work to a task is to shift lengthy interactions with those
external systems away from the <span class="caps">UI</span>. Obviously, we&#8217;re going to need them for&nbsp;that!</p>
<h4>Fake a&nbsp;request</h4>
<p>So one way or another, our tasks will most likely need some initialization and/or cleanup code. And since it&#8217;s probably
the same code that most <span class="caps">HTTP</span> request handlers require and use already, why not just <em>pretend we&#8217;re handling a request
after all</em>?</p>
<p>In <a href="http://flask.pocoo.org">Flask</a>, we can pull that off rather easily.
The <a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.test_request_context"><code>test_request_context</code> method</a>
is conveniently provided to allow for faking the <em>request context</em> &#8212; that is, an execution environment for <span class="caps">HTTP</span> handlers.
Like the name suggest, it is used mostly <a href="http://flask.pocoo.org/docs/0.10/testing/">for testing</a>, but there is nothing
stopping us from using it in tasks run by&nbsp;Celery.</p>
<p>We probably don&#8217;t want to call it directly, though. What would be better is to have Celery prepare the context first,
and then run the task code as if it was an <span class="caps">HTTP</span> handler. For even better results, the context would preserve information
extracted from the <em>actual <span class="caps">HTTP</span> request</em>, one that has sent the task for execution. Moving some work to the background
would then be a trivial matter, for both the task and the original handler would operate within the same&nbsp;environment.</p>
<p>Convenient? I believe so. And as I&#8217;ll demonstrate next, it isn&#8217;t very complicated to implement&nbsp;either.</p>
<h4>Wrap the&nbsp;decorator?</h4>
<p>At least one piece of the solution should stand out as pretty obvious. Since our intention is to wrap the task&#8217;s code
in some additional packaging &#8212; the request context &#8212; it seems fairly natural to write our own <code>@task</code> decorator:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">celery</span>


<span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator function to apply to Celery tasks.</span>
<span class="sd">    Executes the actual task inside Flask&#39;s test request context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actual decorator.&quot;&quot;&quot;</span>
        <span class="nd">@celery.task</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>


<p>Here, <code>app</code> is the <a href="http://flask.pocoo.org/docs/0.10/api/#application-object"><code>Flask</code> application</a>, and <code>celery</code> is the
<a href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery-application-objects"><code>Celery</code> object</a>
that&#8217;s often configured alongside&nbsp;it.</p>
<h4>The <code>Task</code> class</h4>
<p>While this technique will give us <em>a</em> request context inside the task code, it won&#8217;t be <em>the</em> request context
from which the task has been sent for execution. To replicate that context correctly, we need additional support
on the sender&nbsp;side.</p>
<p>Internally, Celery is converting every function we annotate with <code>@task</code> decorator into a subclass of
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task"><code>Celery.app.task.Task</code></a>.
This process can be customized, for example by providing an explicit <code>base=</code> parameter to <code>@task</code> which
specifies a <a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#custom-task-classes">custom <code>Task</code> subclass</a>
to use in place of the default one. Within that subclass, we&#8217;re free to override any functionality that we need&nbsp;to.</p>
<p>In our case, we&#8217;ll scrape the current request context from Flask for all relevant information,
and later use it to recreate the context in the task&nbsp;code.</p>
<p>But before we get to that, let&#8217;s just create the <code>Task</code> subclass and move the above execution logic to it.
This way, users won&#8217;t have to use a completely new <code>@task</code> decorator which would needlessly couple them to a specific
<code>Celery</code> app&nbsp;instance:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for tasks that run inside a Flask request context.&quot;&quot;&quot;</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<p>Instead, they can either set this class as <code>base=</code> for a specific&nbsp;task:</p>
<div class="highlight"><pre><span class="nd">@celery.task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">RequestContextTask</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sync_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>or make it into new default for all their&nbsp;tasks:</p>
<div class="highlight"><pre><span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">celery</span><span class="o">.</span><span class="n">Task</span> <span class="o">=</span> <span class="n">RequestContextTask</span>
</pre></div>


<h4>Invocation&nbsp;patterns</h4>
<p>When the frontend asks for a task to be executed, it most often uses the
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.delay"><code>Task.delay</code> method</a>.
It will package a payload contaning task arguments, and send it off through a <em>broker</em> &#8212;
usually an <a href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol"><span class="caps">AMQP</span></a>-based queue,
such as <a href="https://www.rabbitmq.com/">RabbitMQ</a> &#8212; so that a Celery worker can pick it up and actually&nbsp;execute.</p>
<p>But there are other means of task invocation. We can even run it
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.apply">&#8220;in place&#8221;</a>,
locally and synchronously, which is especially useful for various testing scenarios. Lastly, a task can also be
<a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.retry">retried</a> from within
its own code, terminating its current run and scheduling another attempt for some future&nbsp;date.</p>
<p>Obviously, for the <code>RequestContextTask</code> to be useful, it needs to behave correctly in every situation.
Therefore we need to cover all the entry points I&#8217;ve mentioned &#8212;
the asynchronous call, a synchronous invocation, and a task&nbsp;retry:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_context</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_context</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_context</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">rest</span><span class="p">)</span>
</pre></div>


<p>Note that <code>Task.apply_async</code> is being called internally by <code>Task.delay</code>,
so it&#8217;s only that first method that we have to&nbsp;override.</p>
<h4>Context in a&nbsp;box</h4>
<p>As you can deduce right away, the Flask-related magic is meant to go in the <code>_include_context</code> method.
The idea is to prepare arguments for the eventual invocation of <code>Flask.test_request_context</code>,
and pass them through an extra task parameter.
Those arguments are relatively uncomplicated: they are just a medley of various pieces of information
that we can easily obtain from the Flask&#8217;s <code>request</code> object:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">has_request_context</span><span class="p">,</span> <span class="n">request</span>


<span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">CONTEXT_ARG_NAME</span> <span class="o">=</span> <span class="s">&#39;_flask_request_context&#39;</span>

    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">_include_request_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Includes all the information about current HTTP request context</span>
<span class="sd">        as an additional argument to the task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_request_context</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s">&#39;base_url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url_root</span><span class="p">,</span>
            <span class="s">&#39;method&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s">&#39;headers&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s">&#39;query_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">[(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ARG_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
</pre></div>


<p>On the worker side, we simply unpack them and recreate the&nbsp;context:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>

<span class="k">class</span> <span class="nc">RequestContextTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">call</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestContextTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTEXT_ARG_NAME</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">has_request_context</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">call</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">call</span><span class="p">()</span>
            <span class="n">app</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">make_response</span><span class="p">(</span><span class="n">result</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>


<p>The only tricky part is calling
<a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.process_response"><code>Flask.process_response</code></a> at the end.
We need to do that for the <a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.after_request"><code>@after_request</code> hooks</a>
to execute correctly. This is quite crucial, because those hooks are where you&#8217;d normally put important cleanup code,
like commit/rollback of the database&nbsp;transaction.</p>
<h4>Complete&nbsp;solution</h4>
<p>To see how all those code snippets fit together, see <a href="https://gist.github.com/Xion/46d739b980af14a0d3ea">this gist</a>.
You may also want to have a look at
<a href="http://flask.pocoo.org/docs/0.10/patterns/celery/">the article on Celery integration</a> in Flask docs for some tips on
how to integrate it with your own&nbsp;project.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This isn&#8217;t strictly necessary, as Celery supports sending tasks for execution
<a href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery.send_task">by explicit name</a>.
For that request to reach the worker, however,
the <a href="http://docs.celeryproject.org/en/latest/configuration.html#broker-url">task broker configuration</a>
must be correctly shared between sender and the worker.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/celery-include-flask-request-context.html#celery-include-flask-request-context">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-enums-are-ok.html#python-enums-are-ok">Actually, Python enums are pretty <span class="caps">OK</span></a></h2>
    <p>
      Posted on Sun 25 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/enums.html">enums</a>,      <a href="http://xion.io/tag/serialization.html">serialization</a>      &#8226; <a href="http://xion.io/post/code/python-enums-are-ok.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Little over two years ago, I was writing about
<a href="http://xion.org.pl/2013/05/13/we-dont-need-no-enums-in-python/">my skepticism</a> towards the
<a href="https://www.python.org/dev/peps/pep-0435/">addition of enum types to Python</a>. My stance has changed somewhat since then,
and I now think there is some non-trivial value that enums can add to Python code. It becomes especially apparent
in the circumstances involving any kind of persistence,
from <a href="https://docs.python.org/2/library/pickle.html">pickling</a> to&nbsp;databases.</p>
<p>I will elaborate on that through the rest of this&nbsp;post.</p>
<h4>Revision</h4>
<p>First, let&#8217;s recap (or perhaps introduce) the important facts about enums in Python. An <em>enum</em>, or an enumeration type,
is a special class that inherits from <code>enum.Enum</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> and defines one or more&nbsp;constants:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">Cutlery</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">knife</span> <span class="o">=</span> <span class="s">&#39;knife&#39;</span>
    <span class="n">fork</span> <span class="o">=</span> <span class="s">&#39;fork&#39;</span>
    <span class="n">spoon</span> <span class="o">=</span> <span class="s">&#39;spoon&#39;</span>
</pre></div>


<p>Their values are then converted into singleton objects with distinct identity.
They available as attributes of the enumeration&nbsp;type:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">Cutlery</span><span class="o">.</span><span class="n">fork</span>
<span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">fork</span><span class="p">:</span> <span class="s">&#39;fork&#39;</span><span class="o">&gt;</span>
</pre></div>


<p>As a shorthand for when the values themselves are not important, the <code>Enum</code> class can be directly invoked
with constant names as&nbsp;strings:</p>
<div class="highlight"><pre><span class="n">Cutlery</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;Cutlery&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;knife&#39;</span><span class="p">,</span> <span class="s">&#39;fork&#39;</span><span class="p">,</span> <span class="s">&#39;spoon&#39;</span><span class="p">])</span>
</pre></div>


<p>Resulting class offers some useful <span class="caps">API</span> that we&#8217;d expect from an enumeration type in any programming&nbsp;language:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">Cutlery</span><span class="p">)</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">knife</span><span class="p">:</span> <span class="s">&#39;knife&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">fork</span><span class="p">:</span> <span class="s">&#39;fork&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">spoon</span><span class="p">:</span> <span class="s">&#39;spoon&#39;</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Cutlery</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;knife&#39;</span><span class="p">,</span> <span class="s">&#39;fork&#39;</span><span class="p">,</span> <span class="s">&#39;spoon&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;</span> <span class="n">Cutlery</span><span class="o">.</span><span class="n">knife</span> <span class="ow">in</span> <span class="n">Cutlery</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Cutlery</span><span class="p">(</span><span class="s">&#39;spoon&#39;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Cutlery</span><span class="o">.</span><span class="n">spoon</span><span class="p">:</span> <span class="s">&#39;spoon&#39;</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Cutlery</span><span class="p">(</span><span class="s">&#39;spork&#39;</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="c"># (...)</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="s">&#39;spork&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">Cutlery</span>
</pre></div>


<h4>How it was done&nbsp;previously</h4>
<p>Of course, there is nothing really groundbreaking about assigning some values to &#8220;constants&#8221;. It&#8217;s been done like that
since times immemorial, and quite often those constants have been grouped within finite&nbsp;sets.</p>
<p>Here&#8217;s an example of a comment model in some imaginary <span class="caps">ORM</span>, complete with a status&nbsp;&#8220;enumeration&#8221;:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">APPROVED</span> <span class="o">=</span> <span class="s">&#39;approved&#39;</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="s">&#39;rejected&#39;</span>
    <span class="n">IN_REVIEW</span> <span class="o">=</span> <span class="s">&#39;in_review&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">APPROVED</span><span class="p">,</span> <span class="n">REJECTED</span><span class="p">,</span> <span class="n">IN_REVIEW</span><span class="p">])</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextProperty</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STATES</span><span class="p">)</span>

<span class="c"># usage</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s">&quot;Xion&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Boo&quot;</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">IN_REVIEW</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>Converting it to use an <code>Enum</code> is relatively&nbsp;straightforward:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">approved</span> <span class="o">=</span> <span class="s">&#39;approved&#39;</span>
        <span class="n">rejected</span> <span class="o">=</span> <span class="s">&#39;rejected&#39;</span>
        <span class="n">in_review</span> <span class="o">=</span> <span class="s">&#39;in_review&#39;</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextProperty</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">State</span><span class="p">])</span>

<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s">&quot;Xion&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Meh.&quot;</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">approved</span><span class="o">.</span><span class="n">value</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>It is not apparent, though, if there is any immediate benefit of doing so. True, we no longer need to define the <code>STATES</code>
set explicitly, but saving on this bit of boilerplate is balanced out by having to access the enum&#8217;s <code>value</code>
when assigning it to a string&nbsp;property.</p>
<p>All in all, it seems like a wash &#8212; though at least we&#8217;ve established that enums are <em>no worse</em> than their alternatives&nbsp;:)</p>
<h4>Enums are&nbsp;interoperable</h4>
<p>Obviously, this doesn&#8217;t exactly sound like high praise. Thing is, we haven&#8217;t really replaced the previous solution
<em>completely</em>. Remnants of it still linger in the way the <code>state</code> property is declared. Even though it&#8217;s supposed to hold
enum constants, it is defined as string, which at this point is more of an implementation detail of how those constants
are&nbsp;serialized.</p>
<p>What were really need here is a kind of <code>EnumProperty</code> that&#8217;d allow us to work solely with enum objects.
Before the introduction of a standard <code>Enum</code> base, however, there was little incentive for ORMs and other similiar
libraries to provide such a functionality. But now, it makes much more sense to support enums as first-class citizens,
at least for data exchange and serialization, because users can be expected to already prefer the standard <code>Enum</code>
in their own&nbsp;code.</p>
<p>Thus, the previous example changes into something along these&nbsp;lines:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">EnumProperty</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>

<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s">&quot;Xion&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Yay!&quot;</span><span class="p">)</span>
<span class="n">comment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">approved</span>  <span class="c"># no .value!</span>
<span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>Details of <code>EnumProperty</code>, or some equivalent construct, are of course specific to any given data management library.
In SQLAlchemy, for example, a <a href="https://gist.github.com/Xion/5564b907e5f4e883511c">custom column type</a>
can handle the necessary serialization and deserialization between Python code and <span class="caps">SQL</span> queries,
allowing you to define your models like this<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="c"># ...</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">EnumType</span><span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>

<span class="c"># usage like above</span>
</pre></div>


<p>In any case, the point is to have Python code operate solely on enum objects, while the persistence layer takes
care of converting between them and their serializable&nbsp;values.</p>
<h4>Enums are&nbsp;extensible</h4>
<p>The other advantage <code>Enum</code>s have over loose collections of constants is that they are proper <em>types</em>.
Like all user-defined types in Python, they can have additional methods and properties defined on their instances,
or even on the type&nbsp;itself.</p>
<p>Although this capability is (by default) not as powerful as e.g. in Java &#8212; where <em>each enum constant</em> can
<a href="https://gist.github.com/chandrasekhar4u/431839b9eac715c08b71">override a method in its own way</a> &#8212; it can nevertheless
be quite convenient at times. Typical use cases include constant&nbsp;classification:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">37</span>
    <span class="n">up</span> <span class="o">=</span> <span class="mi">38</span>
    <span class="n">right</span> <span class="o">=</span> <span class="mi">39</span>
    <span class="n">down</span> <span class="o">=</span> <span class="mi">40</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_horizontal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Direction</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_vertical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Direction</span><span class="o">.</span><span class="n">down</span><span class="p">,</span> <span class="n">Direction</span><span class="o">.</span><span class="n">up</span><span class="p">)</span>
</pre></div>


<p>and&nbsp;conversion:</p>
<div class="highlight"><pre>    <span class="k">def</span> <span class="nf">as_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">left</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">up</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">right</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">Direction</span><span class="o">.</span><span class="n">down</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>


<p>For the latter, it would be handy to have the Java&#8217;s ability to
<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html">attach additional data</a> to an enum constant.
As it turns out, Python supports this feature natively in a very similar way.
We simply have to override enum&#8217;s <code>__new__</code> method to parse out any extra values from the initializer
and turn them into attributes of the enum&nbsp;instance:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">37</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">up</span> <span class="o">=</span> <span class="mi">38</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="mi">39</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">down</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_value_</span> <span class="o">=</span> <span class="n">keycode</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="n">obj</span>
</pre></div>


<p>It&#8217;s possible, in fact, to insert any arbitrary computation here that yields the final <code>_value_</code> of an enum constant<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.
This trick can be used to, for example, construct enums that
<a href="https://docs.python.org/3/library/enum.html#autonumber">automatically number themselves</a>.</p>
<p>Finally, we can add static methods, class methods, or <a href="http://stackoverflow.com/a/3203659">class properties</a> to the
<code>Enum</code> subclass, just like we would do with any other&nbsp;class:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MyEnum</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">__values__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">]</span>
</pre></div>


<h4>Enums just&nbsp;are</h4>
<p>All these things are possible primarly because of the most notable aspect of Python enums: their existence
as an <em>explicit concept</em>. A syntactically unorganized bunch of constants cannot offer half of the highlighted features
because there is nowhere to pin them&nbsp;on.</p>
<p>For that reason alone, using enums as an explicit &#8212; rather than implicit &#8212; pattern seems worthwhile.
The one benefit we&#8217;re certain to reap is better code structure through separation of important&nbsp;concepts.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The <code>enum</code> module is part of the Python standard library
<a href="https://docs.python.org/3/library/enum.html">since version 3.4</a>
but <a href="https://pypi.python.org/pypi/enum/">a fully functional backport</a> is available for Python 2.x as well.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>It is even possible to instruct SQLAlchemy how to map Python enums to
<a href="http://www.postgresql.org/docs/9.1/static/datatype-enum.html"><code>ENUM</code> types</a> in database engines that support it,
but details are outside of the scope of this article.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>If you&#8217;re fine with the enum&#8217;s <code>value</code> being the <em>whole</em> tuple (everything after the <code>=</code> sign),
you can override <code>__init__</code> instead of <code>__new__</code>
(cf. <a href="https://docs.python.org/3/library/enum.html#planet">the planet example</a> from standard docs).&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-enums-are-ok.html#python-enums-are-ok">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/jinja-classlist.html#jinja-classlist"><span class="caps">CSS</span> class helper for&nbsp;Jinja</a></h2>
    <p>
      Posted on Thu 22 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/jinja.html">Jinja</a>,      <a href="http://xion.io/tag/css.html">CSS</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/flask.html">Flask</a>      &#8226; <a href="http://xion.io/post/code/jinja-classlist.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>One of the great uses for a templating engine such as <a href="http://jinja.pocoo.org">Jinja</a> is reducing the clutter
in our <span class="caps">HTML</span> source files. Even with the steady advances in the <span class="caps">CSS</span><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> standards, various <code>div.wrapper</code>, <code>div.container</code>,
<code>div.content</code>, and other presentational elements are still a common fact of life.
Unless you&#8217;re one of the cool kids who use <a href="http://webcomponents.org/">Web Components</a> with
<a href="https://www.polymer-project.org">Polymer</a>, your main option for abstracting this boilerplate away
is defining some more general <a href="http://jinja.pocoo.org/docs/dev/templates/#macros">template macros</a>.</p>
<p>As with any kind of abstraction, it&#8217;s crucial to balance broad applicability with a potential for finely-tuned
customization. In the case of wrapping <span class="caps">HTML</span> snippets in Jinja macros, an easy way to maintain flexibility is to allow
the caller to specify some crucial attributes of the root&nbsp;element:</p>
<div class="highlight"><pre><span class="c">{#</span>
<span class="c">  Renders the markup for a &lt;button&gt; from Twitter Bootstrap.</span>
<span class="c">#}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">button</span><span class="o">(</span><span class="nv">text</span><span class="o">=</span><span class="kp">none</span><span class="o">,</span> <span class="nv">style</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="o">,</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;button&#39;</span><span class="o">,</span> <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;button type=&quot;</span><span class="cp">{{</span> <span class="nv">type</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">        class=&quot;btn btn-</span><span class="cp">{{</span> <span class="nv">style</span> <span class="cp">}}{%</span> <span class="k">if</span> <span class="nv">class</span> <span class="cp">%}</span><span class="x"> </span><span class="cp">{{</span> <span class="nv">class</span> <span class="cp">}}{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">&quot;</span>
<span class="x">        </span><span class="cp">{{</span> <span class="nv">kwargs</span><span class="o">|</span><span class="nf">xmlattr</span> <span class="cp">}}</span><span class="x">&gt;</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">text</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">  &lt;/button&gt;</span>
<span class="cp">{%</span> <span class="k">endmacro</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<p>An element <code>id</code> would be a good example, and in the above macro it&#8217;s handled implicility
thanks to the <code>{{ kwargs|xmlattr }}</code> stanza.</p>
<p><code>class</code>, however, is not that simple, because a macro like that usually needs to supply some <span class="caps">CSS</span> classes of its own.
The operation of combining them with additional ones, passed by the caller, is awfully textual and error-prone.
It&#8217;s easy, for example, to forget about the crucial space and run two class names&nbsp;together.</p>
<p>As if <span class="caps">CSS</span> wasn&#8217;t difficult enough to debug&nbsp;already!</p>
<h4>Let them have&nbsp;list</h4>
<p>The root cause for any of those problems is working at a level that&#8217;s too low for the task.
The value for a <code>class</code> attribute may be <em>encoded</em> as string, but it&#8217;s fundamentally a <em>list of tokens</em>.
In the modern <span class="caps">DOM</span> <span class="caps">API</span>, for example, it is represented
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/classList">as exactly that</a>: a <code>DOMTokenList</code>.</p>
<p>I&#8217;ve found it helpful to replicate a similar mechanism in Jinja templates. The result is a <code>ClassList</code> wrapper
whose code I quote here in&nbsp;full:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">MutableSet</span>


<span class="k">class</span> <span class="nc">ClassList</span><span class="p">(</span><span class="n">MutableSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data structure for holding, and ultimately returning as a single string,</span>
<span class="sd">    a set of identifiers that should be managed like CSS classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        :param arg: A single class name or an iterable thereof.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s">&quot;expected a string or string iterable, got </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">classes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">classes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__html__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;class=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>
</pre></div>
</td></tr></table>

<p>To make it work with <a href="http://flask.pocoo.org">Flask</a>, adorn the class with
<a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.template_global"><code>Flask.template_global</code> decorator</a>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">myflaskapp</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.template_global</span><span class="p">(</span><span class="s">&#39;classlist&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ClassList</span><span class="p">(</span><span class="n">MutableSet</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>Otherwise, if you&#8217;re working with a raw <a href="http://jinja.pocoo.org/docs/dev/api/#jinja2.Environment">Jinja <code>Environment</code></a>,
simply add <code>ClassList</code> to its <a href="http://jinja.pocoo.org/docs/dev/api/#global-namespace">global namespace</a>&nbsp;directly:</p>
<div class="highlight"><pre><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s">&#39;classlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClassList</span>
</pre></div>


<p>In either case, I recommend following the apparent Jinja convention of naming template symbols
as <code>lowercasewithoutspaces</code>.</p>
<h4>Becoming&nbsp;classy</h4>
<p>Usage of this new <code>classlist</code> helper is relatively straightforward. Since it accepts both a space-separated string
or an iterable of <span class="caps">CSS</span> class names, a macro can wrap anything the caller would pass it as a value for <code>class</code> attribute:</p>
<div class="highlight"><pre><span class="cp">{%</span> <span class="k">macro</span> <span class="nv">button</span><span class="o">(</span><span class="nv">text</span><span class="o">=</span><span class="kp">none</span><span class="o">,</span> <span class="nv">style</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="o">,</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;button&#39;</span><span class="o">,</span> <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">set</span> <span class="nv">classes</span> <span class="o">=</span> <span class="nv">classlist</span><span class="o">(</span><span class="nv">class</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="c">{# ... #}</span><span class="x"></span>
</pre></div>


<p>The <code>classlist</code> is capable of producing the complete <code>class</code> attribute syntax (i.e. <code>class="..."</code>), or omit it entirely
if it would be empty. All we need to do is evaluate it using the normal Jinja expression&nbsp;syntax:</p>
<div class="highlight"><pre><span class="x">  &lt;button type=&quot;</span><span class="cp">{{</span> <span class="nv">type</span> <span class="cp">}}</span><span class="x">&quot; </span><span class="cp">{{</span> <span class="nv">classes</span> <span class="cp">}}</span><span class="x"> </span><span class="cp">{{</span> <span class="nv">kwargs</span><span class="o">|</span><span class="nf">xmlattr</span> <span class="cp">}}</span><span class="x">&gt;</span>
</pre></div>


<p>Before that, though, we may want to include some additional classes that are specific to our macro.
The <code>button</code> macro, for example, needs to add the <a href="http://getbootstrap.com/css/#buttons">Bootstrap-specific</a>
<code>btn</code> and <code>btn-$STYLE</code> classes to the <code>&lt;button&gt;</code> element it produces<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre><span class="x">  </span><span class="cp">{%</span> <span class="k">do</span> <span class="nv">classes.add</span><span class="o">(</span><span class="s1">&#39;btn&#39;</span><span class="o">,</span> <span class="s1">&#39;btn-&#39;</span> <span class="o">+</span> <span class="nv">style</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>


<p>After executing this statement, the final <code>class</code> attribute contains both the caller-provided classes,
as well those two that were added&nbsp;explicitly.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Believe it or not, we can finally
<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/justify-content">center the content vertically</a>
without much of an issue!&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>The <code>{% do %}</code> block in Jinja allows to execute statements (such as function calls) without evaluating values
they return. It is not exposed by default,
but <a href="http://jinja.pocoo.org/docs/dev/api/#jinja2.Environment.add_extension">adding</a> a standard
<a href="http://jinja.pocoo.org/docs/dev/extensions/#expression-statement"><code>jinja2.ext.do</code> extension</a> to the <code>Environment</code>
makes it available.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/jinja-classlist.html#jinja-classlist">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/sqlalchemy-regex-filters.html#sqlalchemy-regex-filters">Regular expression filters in&nbsp;SQLAlchemy</a></h2>
    <p>
      Posted on Wed 14 October 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/regular-expressions.html">regular expressions</a>,      <a href="http://xion.io/tag/sqlalchemy.html">SQLAlchemy</a>,      <a href="http://xion.io/tag/sql.html">SQL</a>,      <a href="http://xion.io/tag/postgres.html">Postgres</a>,      <a href="http://xion.io/tag/sqlite.html">SQLite</a>,      <a href="http://xion.io/tag/ast.html">AST</a>      &#8226; <a href="http://xion.io/post/code/sqlalchemy-regex-filters.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>The nice part about <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>
&#8212; an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping"><span class="caps">ORM</span></a> library/framework for Python &#8212;
is that it offers much more than just mapping of <span class="caps">SQL</span> relations to model classes. At its lower level, for example,
there exists an additional layer between those classes and raw <span class="caps">SQL</span> queries: an abstraction for the <em><span class="caps">SQL</span> language itself</em>.</p>
<p>Although it may sound byzantine at first, this extra layer serves two important&nbsp;purposes:</p>
<ul>
<li><em>portability</em>: compiling of the same query to potentially different <span class="caps">SQL</span> syntaxes,
as required by different database&nbsp;backends</li>
<li><em>extensibility</em>: allowing the user to introduce new elements: operators, functions, or even whole&nbsp;statements</li>
</ul>
<p>I&#8217;m going to take advantage of both of these qualities here, and show how you can implement support
for <em>regular expression</em> operators in query filters. On supported database backends, it will allow for powerful
pattern matching on string&nbsp;columns.</p>
<h4>Database&nbsp;side</h4>
<p>We will use the Postgres syntax of <span class="caps">POSIX</span>
<a href="http://www.postgresql.org/docs/9.3/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP">regular expression matchers</a>
as a reference. It includes four operators: for case sensitive or insensitive matching, in regular or negated&nbsp;versions.</p>
<p>Since it&#8217;s a common practice to use an in-memory <a href="https://www.sqlite.org/">SQLite</a> for running database-involved
&#8220;unit&#8221; tests<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>, we will also add support for that backend. Regular expressions are not implemented there directly,
but thanks to
<a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"><code>sqlite3</code><span class="quo">&#8216;</span>s custom function ability</a>,
it&#8217;ll be easy enough to provide the necessary support in&nbsp;Python.</p>
<h4>Desired <span class="caps">API</span></h4>
<p>In essence, what we want to do is to enhance the <code>String</code> column type with additional <em>comparators</em>, which will then
be usable as arguments for the <code>Query.filter</code> method.</p>
<p>As an example, consider the following model class with a string&nbsp;column:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nick</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="c"># ...</span>
</pre></div>


<p>Once we&#8217;re done, it should be possible to query for e.g. all the people whose nicks contain numbers
in a pretty straightforward&nbsp;fashion:</p>
<div class="highlight"><pre><span class="n">numerics</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">nick</span><span class="o">.</span><span class="n">regexp</span><span class="p">(</span><span class="s">r&#39;\d+&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>Because of the limitations of underlying databases backends, only <em>literal</em> regular expressions would be supported.
It means that, from the <span class="caps">SQL</span> standpoint, they have to be constants: you cannot use the value of one column as part
of a regular expression that another column is matched&nbsp;against.</p>
<p>But of course, you can still construct those literals in Python&nbsp;code:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_copycats</span><span class="p">(</span><span class="n">nick</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all the people who tried to parrot given nick</span>
<span class="sd">    but failed and had to append some numbers to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nick_regexp</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">nick</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;\d+$&#39;</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">nick</span><span class="o">.</span><span class="n">regexp</span><span class="p">(</span><span class="n">nick_regexp</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>


<p>Considering that regular expressions themselves are already pretty powerful, this really ought to be sufficient
for all reasonable&nbsp;purposes.</p>
<h4>How comparators&nbsp;work?</h4>
<p>So how do we add the <code>regexp</code> method to the <code>String</code> type? It may seem logical to simply extend the class
and add it&nbsp;directly:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">String</span> <span class="k">as</span> <span class="n">_String</span>


<span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">_String</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enhanced version of the standard string type.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># hmm...</span>
</pre></div>


<p>But this won&#8217;t actually work. In SQLAlchemy, objects like <code>String</code> or <code>Integer</code> do not represent columns of certain type;
they correspond to <em>types themselves</em><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. Extending them with additional methods won&#8217;t do much good, because regular code
rarely operates on column&nbsp;types.</p>
<p>On the other hand, though, we obviously don&#8217;t want to mess with the <code>Column</code> class itself. Our additions are only
meaningful for string columns, but putting them there would expose them to <em>all</em> columns, regardless of&nbsp;type!</p>
<p>Thankfully, there is an intermediate mechanism which SQLAlchemy introduced precisely to address the need we&#8217;ve got here.
Every column type can define a
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/type_api.html#sqlalchemy.types.TypeEngine.comparator_factory"><code>comparator_factory</code></a>: a kind of mixin class whose methods are incorporated into columns of that type.
By <a href="http://docs.sqlalchemy.org/en/rel_0_9/core/custom_types.html#types-operators">overriding this inner class</a>,
we can both modify the behavior of existing operators, as well as introduce completely new&nbsp;ones.</p>
<p>So in order to add <code>regexp</code> and other methods to all <code>String</code> columns, our new string type must define its own
<code>comparator_factory</code>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">_String</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">comparator_factory</span><span class="p">(</span><span class="n">_String</span><span class="o">.</span><span class="n">comparator_factory</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="c"># ...</span>
</pre></div>


<p>We need to remember about deriving it from the original one, too. Otherwise, all the standard operators
you&#8217;d want to use in queries (<code>==</code>, <code>+</code>, etc.) would cease to work, because the new <code>comparator_factory</code> wouldn&#8217;t
include an implementation of any of the necessary magic methods (<code>__eq__</code>, <code>__add__</code>,&nbsp;etc.).</p>
<h4><span class="caps">SQL</span>,&nbsp;abstracted</h4>
<p>Knowing where to put our new comparator methods is certainly desirable, but the more interesting question is
how do we implement&nbsp;them?</p>
<p>Like I&#8217;ve mentioned in the beginning, SQLAlchemy employs an additional layer between
<span class="caps">ORM</span> models and raw, textual <span class="caps">SQL</span> language. Basically, it&#8217;s an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"><span class="caps">AST</span></a>
for backend-independent queries which includes almost all of the various <span class="caps">SQL</span> constructs, codified in a platform-agnostic
way inside the <code>sqlalchemy.sql</code> package.</p>
<p>You may have used this layer directly if you ever wrote queries based on
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/metadata.html#sqlalchemy.schema.Table"><code>Table</code> objects</a> and ran them with
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/session_api.html#sqlalchemy.orm.session.Session.execute"><code>Session.execute</code></a>. But even those constructed using the more familiar
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query"><code>Query</code> class</a> interface
end up in this intermediate representation. Often there is little to no additional processing&nbsp;involved.</p>
<p>Arguments to the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query.filter"><code>Query.filter</code> method</a>,
for example, are already given as <span class="caps">SQL</span> clause objects. It just so happens that its creation is hidden behind
a very neat, operator-based <span class="caps">API</span>.</p>
<p>Thus, if our regular expression filters are to cooperate, they also need to return pieces of the <span class="caps">SQL</span> syntax tree.
Not very complicated pieces, mind you, since we only need to represent simple expressions: something like <code>foo ~ 'bar'</code>, where <code>~</code> may optionally be replaced by one of the other three&nbsp;operators.</p>
<h4>Creating the&nbsp;node</h4>
<p>They are all <em>binary</em> operators, by the way (i.e. taking exactly two arguments), so it makes sense that the corresponding
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.BinaryExpression"><span class="caps">AST</span> node class</a> is called <code>BinaryExpression</code>. The node&#8217;s children are the left argument, the right argument, and the operator&nbsp;itself.</p>
<p>With a little help from a few more <span class="caps">SQL</span> syntax wrappers, the implementation of <code>regexp</code> and the other methods
turns out to be quite&nbsp;straightforward:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">BinaryExpression</span><span class="p">,</span> <span class="n">literal</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.operators</span> <span class="kn">import</span> <span class="n">custom_op</span>


<span class="c"># (inside String.comparator_factory)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~*&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">not_regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;!~&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">not_iregexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BinaryExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;!~*&#39;</span><span class="p">))</span>
</pre></div>


<p>The use of
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.literal"><code>literal</code> function</a>
is dictated by the limitation that was mentioned earlier: any regular expression given in the query must be a <span class="caps">SQL</span> literal.
If we now try to pass a column-like clause, we&#8217;ll get an exception right at the query definition, rather than
a database error when we try to execute&nbsp;it.</p>
<p>The <a href="docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.operators.custom_op"><code>custom_op</code> function</a>,
on the other hand, is simply the easiest way to create an &#8220;operator node&#8221; that&#8217;s required as a child
of <code>BinaryExpression</code>. Since it&#8217;s a custom operator, it won&#8217;t be interpreted by SQLAlchemy in any way; it will simply
be used verbatim in the final <span class="caps">SQL</span> string that&#8217;s sent to the&nbsp;database.</p>
<h4>Compile!</h4>
<p>You may have noticed that this would pose a problem if said database doesn&#8217;t support <code>~</code> or the other operators,
which happens to be the case for everything besides Postgres. Because we originally intended to support SQLite in addition
to Postgres, this is evidently a&nbsp;problem.</p>
<p>It&#8217;s also where the portability of an intermediate <span class="caps">SQL</span> representation comes into play. Since our new operators return
<span class="caps">AST</span> nodes and not just textual <span class="caps">SQL</span>, we can redefine the way those nodes are <em>compiled</em> into actual query fragments
on various database&nbsp;backends.</p>
<p>To accomplish that, first we need to distinguish our regex filters from other <code>BinaryExpression</code>s:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">RegexMatchExpression</span><span class="p">(</span><span class="n">BinaryExpression</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents matching of a column againsts a regular expression.&quot;&quot;&quot;</span>

<span class="c"># (inside String.comparator_factory)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RegexMatchExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">literal</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">custom_op</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">))</span>
<span class="c"># etc.</span>
</pre></div>


<p>Once we&#8217;ve introduced such a distinction, it becomes possible to provide a different way for those filters to be turned
into <span class="caps">SQL</span>. We can namely define a new compilation routine for them,
and <a href="docs.sqlalchemy.org/en/rel_0_9/core/compiler.html#sqlalchemy.ext.compiler.compiles">mark it as canonical</a>
for a specific <span class="caps">SQL</span>&nbsp;dialect:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="kn">import</span> <span class="n">compiles</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile the SQL expression representing a regular expression match</span>
<span class="sd">    for the SQLite engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># ...</span>
</pre></div>


<p>The function receives an <span class="caps">AST</span> <code>element</code> to process (here, the <code>RegexMatchExpression</code>), along with a
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/internals.html#sqlalchemy.sql.compiler.SQLCompiler">special <code>compiler</code> object</a>
that controls the whole translation process. Armed with those tools, we are allowed to modify the process
in arbitrary ways and output just the right <span class="caps">SQL</span> statement that&#8217;ll do the job in&nbsp;SQLite.</p>
<h4>Regex support&nbsp;lite</h4>
<p>How does such a statement look like, though? As I&#8217;ve remarked early on, SQLite is very easy to extend with your own
functions, and the <code>sqlite3</code> driver used by SQLAlchemy enables us to write those functions directly in Python.
Obviously, this is fantastic news when you have something like
<a href="https://docs.python.org/2/library/re.html">the standard <code>re</code> module</a> at your&nbsp;disposal.</p>
<p>Indeed, coding the four required functions is quite&nbsp;trivial:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="c"># Mapping from the regular expression matching operators</span>
<span class="c"># to named Python functions that implement them for SQLite.</span>
<span class="n">SQLITE_REGEX_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;~&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;REGEXP&#39;</span><span class="p">,</span>
          <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">))),</span>
    <span class="s">&#39;~*&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;IREGEXP&#39;</span><span class="p">,</span>
           <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))),</span>
    <span class="s">&#39;!~&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NOT_REGEXP&#39;</span><span class="p">,</span>
           <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">)),</span>
    <span class="s">&#39;!~*&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;NOT_IREGEXP&#39;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">regex</span><span class="p">:</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)),</span>
<span class="p">}</span>
</pre></div>


<p>What&#8217;s less apparent is how &#8212; or rather, <em>when</em> &#8212; to instruct the SQLite database to use them.
As per the <a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"><span class="caps">API</span> we have to use</a>,
custom SQLite functions are created on a per-connection basis. But SQLAlchemy, like any good database interface,
takes care of connection management, lifecycle, and pooling. Nowhere in our application there is a <code>connect</code> call
(nor there should be!) that we could just follow with a few <code>create_function</code> invocations.</p>
<p>Yet, there is a way of doing exactly what we require, and it involves utilizing the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/event.html">event subsystem</a> included in SQLAlchemy. Anytime something
interesting happens to any of its <span class="caps">ORM</span> or core objects &#8212; models, sessions, connection pools, etc. &#8212; SQLAlchemy
publishes an <em>event</em> that our application code can <em>listen</em> (subscribe) to. It&#8217;s a classic
<a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">PubSub system</a> that introduces some serious potential
for&nbsp;extensibility.</p>
<p>Our use of it will be pretty modest, though. All we&#8217;re interested in is the establishing of a connection
to the SQLite database. This translates directly to a <code>'connect'</code> event of the
<a href="docs.sqlalchemy.org/en/rel_0_9/core/connections.html"><code>Engine</code> object</a>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Engine</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="nd">@event.listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s">&#39;connect&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_engine_connect</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listener for the event of establishing connection to a SQLite database.</span>

<span class="sd">    Creates the functions handling regular expression operators</span>
<span class="sd">    within SQLite engine, pointing them to their Python implementations above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">SQLITE_REGEX_FUNCTIONS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
</pre></div>


<p>Note that this will catch all the connection events, so we have to verify it&#8217;s really SQLite we&#8217;re talking to.
Afterwards, the creation of <code>REGEXP</code>, <code>IREGEXP</code>, etc. functions is extremely&nbsp;straightforward.</p>
<h4>Compilation, take&nbsp;two</h4>
<p>This was quite a build-up, but now we&#8217;re very close to the finale. What remains is finishing the compilation&nbsp;routine:</p>
<div class="highlight"><pre><span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>We know that <code>element</code> corresponds to an expression in the form of <code>a ~ 'foo'</code>. For SQLite, however, the compatible
version is a <em>function call</em>: <code>REGEXP(a, 'foo')</code>. At first this may appear rather disconcerting, because it&#8217;s basically
a completely different <span class="caps">AST</span> node to&nbsp;build.</p>
<p>But it&#8217;s actually not a problem at all. Inside compiler hooks, we are allowed to use the much of the same <span class="caps">API</span> that&#8217;s
available when drafting regular queries. This includes the
<a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.func"><code>func</code> factory object</a>
which produces calls to arbitrary <span class="caps">SQL</span> functions. Rather than compiling the original binary expression, we&#8217;ll simply
poach its operands and use them as arguments to one of the new&nbsp;functions:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">func</span>


<span class="nd">@compiles</span><span class="p">(</span><span class="n">RegexMatchExpression</span><span class="p">,</span> <span class="s">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sqlite_regex_match</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="c"># determine the name of a custom SQLite function to use for the operator</span>
    <span class="n">operator</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">opstring</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SQLITE_REGEX_FUNCTIONS</span><span class="p">[</span><span class="n">operator</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">would_be_sql_string</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">left</span><span class="p">),</span>
                                        <span class="n">operator</span><span class="p">,</span>
                                        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">right</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">StatementError</span><span class="p">(</span>
            <span class="s">&quot;unknown regular expression match operator: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">,</span>
            <span class="n">would_be_sql_string</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c"># compile the expression as an invocation of the custom function</span>
    <span class="n">regex_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
    <span class="n">regex_func_call</span> <span class="o">=</span> <span class="n">regex_func</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">regex_func_call</span><span class="p">)</span>
</pre></div>


<p>Notice how <code>compiler.process</code> is used to obtain the final result. The <code>compiler</code> object doesn&#8217;t care that we use it on
a totally different <span class="caps">AST</span> node; it will dutifully carry out its compilation into raw <span class="caps">SQL</span>. We can even use this capability
to add a little bit of paranoid error handling: if we encounter an unknown operator, the resulting error message
will include fully compiled, <span class="caps">SQL</span> versions of both&nbsp;arguments.</p>
<h4>Summary</h4>
<p>This concludes our efforts: the original query examples with <code>Person.nick.regexp</code> should now work
in both Postgres and SQLite.
For you convenience, I&#8217;ve bundled all the code in <a href="https://gist.github.com/Xion/204ddbd020f1a4275a53">this gist</a>.</p>
<p>If you feel like tinkering with it further, I would suggest you try to remove the superfluous <code>NOT_*</code> functions.
They make little sense given that <span class="caps">SQL</span> has a perfectly adequate <code>NOT</code> keyword. A clean solution would probably prefer
an additional <code>reverse</code> flag in <code>RegexMatchExpression</code> over looking for a <code>'!'</code> character in the operator&nbsp;string.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It may or <a href="http://michael.robellard.com/2015/07/dont-test-with-sqllite-when-you-use.html">may not be</a>
a <em>good</em> practice, though.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Although it&#8217;s possible to write <code>Column(Integer)</code>, it&#8217;s merely a syntactical convenience.
SQLAlchemy interprets it readily as <code>Column(Integer())</code>. Parameterized types &#8212; like <code>String</code> &#8212; always require explicit
instantiation.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/sqlalchemy-regex-filters.html#sqlalchemy-regex-filters">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/requirejs-optional.html#requirejs-optional">Optional loading of RequireJS&nbsp;modules</a></h2>
    <p>
      Posted on Tue 29 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/javascript.html">JavaScript</a>,      <a href="http://xion.io/tag/requirejs.html">RequireJS</a>,      <a href="http://xion.io/tag/modules.html">modules</a>,      <a href="http://xion.io/tag/web-workers.html">Web Workers</a>,      <a href="http://xion.io/tag/dom.html">DOM</a>,      <a href="http://xion.io/tag/ajax.html">AJAX</a>      &#8226; <a href="http://xion.io/post/code/requirejs-optional.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://requirejs.org/">RequireJS</a> is a module loader for JavaScript. Similar to its alternatives such as
<a href="http://browserify.org/">Browserify</a>, it tries to solve an important problem on the web front(end):
dividing JavaScript code into modules for better maintainability while still loading them correctly and efficiently
without manual curation of the <code>&lt;script&gt;</code> tags.</p>
<p>Once it&#8217;s configured correctly (which can be rather <a href="http://requirejs.org/docs/api.html#config">non-trivial</a>, though),
modules in RequireJS are simply <code>define</code>d as functions that return arbitrary JavaScript&nbsp;objects:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;jquery&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lodash&#39;</span><span class="p">,</span>

    <span class="s1">&#39;myapp/dep1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;myapp/dep2&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dep1</span><span class="p">,</span> <span class="nx">dep2</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... all of the module&#39;s code ...</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">exportedSymbol1</span><span class="o">:</span> <span class="p">...,</span>
        <span class="nx">exportedSymbol2</span><span class="o">:</span> <span class="p">...,</span>
    <span class="p">};</span>
<span class="p">});</span>
</pre></div>


<p>Before executing the function, RequireJS loads all the specified dependencies, repeating the process recursively
and asynchronously. Return values from module functions are passed as parameters to the next module function,
and thus the whole mechanism clicks, serving as a crafty workaround for the lack of proper <code>import</code> functionality<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>Relative&nbsp;failures</h4>
<p>If, at some point in the chain, the desired module cannot be found or loaded, the entire process grinds to a halt
with an error. Most of the time, this is perfectly acceptable (or even desirable) behavior, equivalent to an incorrect
<code>import</code> statement, invalid <code>#include</code> directive, or similar mistake in other&nbsp;languages.</p>
<p>But there are situations when we&#8217;d like to proceed with a missing module, because the dependent code is prepared
to handle it. The canonical example are
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Web Workers</a>.
Unlike traditional web application code, Web Worker scripts operate outside of a context of any single page,
having no access to the <abbr title="Document Object Model"><span class="caps">DOM</span></abbr> tree (because <em>which</em> <span class="caps">DOM</span> tree would it be?).
Correspondingly, they have no <code>document</code> nor <code>window</code> objects in their global&nbsp;scope.</p>
<p>Unfortunately, some libraries (<em>*cough*</em> jQuery <em>*cough*</em>) require those objects as a hard (and usually implicit)
dependency. This doesn&#8217;t exactly help if we&#8217;d like to use them in worker code for other features, not related to <span class="caps">DOM</span>.
In case of jQuery, for example, it could be the <span class="caps">API</span> for making <span class="caps">AJAX</span> calls, which is still decidedly more pleasant
than dealing with bare <code>XMLHTTPRequest</code> if we&#8217;re doing anything&nbsp;non-trivial.</p>
<p>Due to this hard dependency on <span class="caps">DOM</span>, however, Web Workers cannot <code>require</code> jQuery. No biggie, you may think: browsers
supporting workers also offer an excellent, promise-based
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch <span class="caps">API</span></a> that largely replaces the old <span class="caps">AJAX</span>,
so we may just use it in worker code. Good thinking indeed, but it doesn&#8217;t solve the issue of <em>sharing code</em> between
main (&#8220;<span class="caps">UI</span>&#8221;) part of the app and Web&nbsp;Workers.</p>
<p>Suppose you have the following dependency&nbsp;graph:</p>
<p><div class="graphviz" style="text-align: center;"><img src="data:image/png;base64,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"></div></p>
<p>The <code>common</code> module has some logic that we&#8217;d want reused between regular <code>&lt;script&gt;</code>-based code and a Web Worker,
but its dependency on jQuery makes it impossible. It would work, however, if this dependency was a <em>soft</em> one.
If <code>common</code> could <em>detect</em> that jQuery is not available and fall back to other solutions (like the Fetch <span class="caps">API</span>),
we would be able to <code>require</code> it in both execution&nbsp;environments.</p>
<h4>The <code>optional</code> plugin</h4>
<p>What we need, it seems, is an ability to say that some dependencies (like <code>'jquery'</code>) are <em>optional</em>. They can be loaded
if they&#8217;re available but otherwise, they shouldn&#8217;t cause the whole dependency structure to crumble. RequireJS does not
support this functionality by default, but it&#8217;s easy enough to add it via a <em>plugin</em>.</p>
<p>There are already <a href="https://github.com/jrburke/requirejs/wiki/Plugins">several useful plugins</a> available for RequireJS
that offer some interesting features. As of this writing, however, optional module loading doesn&#8217;t seem to be among them.
That&#8217;s not a big problem: rolling out our own<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> plugin turns out to be relatively&nbsp;easy.</p>
<p><a href="http://requirejs.org/docs/plugins.html">RequireJS plugins</a> are themselves modules: you create them as separate JavaScript
files having code wrapped in <code>define</code> call. They can also declare their own dependencies like any other module.
The only requirement is that they export an object with <a href="http://requirejs.org/docs/plugins.html#api">certain <span class="caps">API</span></a>:
at minimum, it has to include the <code>load</code> method. Since our <code>optional</code> plugin is very simple, <code>load</code> is in fact
the only method we have to&nbsp;implement:</p>
<div class="highlight"><pre><span class="cm">/* Skeleton of a simple RequireJS plugin module. */</span>

<span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

<span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">parentRequire</span><span class="p">,</span> <span class="nx">onload</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="nx">load</span><span class="p">,</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>


<p>As its name would hint, <code>load</code> carries out the actual module loading which a plugin is allowed to influence, modify,
or even replace with something altogether different. In our case, we don&#8217;t want to be too invasive, but we need to
detect failure in the original loading procedure and step&nbsp;in.</p>
<p>I mentioned previously that module loading is asynchronous, which JavaScript often translates to &#8220;callbacks&#8221;.
Here, <code>load</code> receives the <code>onload</code> callback which we eventually need to invoke. It also get the mysterious
<code>parentRequire</code> argument; this is simply a regular <code>require</code> function that&#8217;d normally be used if our plugin didn&#8217;t
stand in the&nbsp;way.</p>
<p>Those two are the most important pieces of the puzzle, which overall has a pretty succinct&nbsp;solution:</p>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * RequireJS plugin for optional module loading.</span>
<span class="cm"> */</span>
<span class="nx">define</span> <span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>


<span class="cm">/** Default value to return when a module failed to load. */</span>
<span class="kd">var</span> <span class="nx">DEFAULT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">load</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">parentRequire</span><span class="p">,</span> <span class="nx">onload</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">parentRequire</span><span class="p">([</span><span class="nx">moduleName</span><span class="p">],</span> <span class="nx">onload</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">failedModule</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">&amp;&amp;</span> <span class="nx">requireModules</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Could not load optional module: &quot;</span> <span class="o">+</span> <span class="nx">failedModule</span><span class="p">);</span>
        <span class="nx">requirejs</span><span class="p">.</span><span class="nx">undef</span><span class="p">(</span><span class="nx">failedModule</span><span class="p">);</span>

        <span class="nx">define</span><span class="p">(</span><span class="nx">failedModule</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">DEFAULT</span><span class="p">;</span> <span class="p">});</span>
        <span class="nx">parentRequire</span><span class="p">([</span><span class="nx">failedModule</span><span class="p">],</span> <span class="nx">onload</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">load</span><span class="o">:</span> <span class="nx">load</span><span class="p">,</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>


<p>The logic here is as&nbsp;follows:</p>
<ul>
<li>First, try to load the module normally (via the outer <code>parentRequire</code> call).</li>
<li>If it succeeds, <code>onload</code> is called and there is nothing for us to&nbsp;do.</li>
<li>If it fails, we log the <code>failedModule</code> and cleanup some internal RequireJS state with <code>requirejs.undef</code>.</li>
<li>Most importantly, we <code>define</code> the module as a trivial shim that returns some <code>DEFAULT</code> (here, <code>null</code>).</li>
<li>As a result, when we require it again (through the inner <code>parentRequire</code> call), we <em>know</em> it&#8217;ll be loaded&nbsp;successfully.</li>
</ul>
<h4>Usage</h4>
<p>Plugins in RequireJS are invoked on a per-module basis. You can specify that a certain dependency <code>'bar'</code> shall be loaded
through a plugin <code>'foo'</code> by putting <code>'foo!bar'</code> on the dependency&nbsp;list:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span> <span class="s1">&#39;foo!bar&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bar</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>Both <code>'foo'</code> and <code>'bar'</code> represent module paths here: the first one is the path to the <em>plugin</em> module,
while the second one is the actual dependency. In a more realistic example &#8212; like when our optional loader is involved &#8212;
both of them would most likely be multi-segments&nbsp;paths:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;myapp/ext/require/optional!myapp/common/buttons/awesome-button&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>


<p>As you can see, they can get pretty unreadable rather quickly. It would be better if the plugin prefix consisted
of just one segment (i.e. <code>optional!</code>) instead. We can make that happen by adding
<a href="http://requirejs.org/docs/api.html#config-map">a mapping</a> to the RequireJS&nbsp;config:</p>
<div class="highlight"><pre><span class="nx">requirejs</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
    <span class="c1">// ...</span>
    <span class="nx">map</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;optional&#39;</span><span class="o">:</span> <span class="s1">&#39;myapp/ext/require/optional&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>


<p>With this renaming in place, the loading of non-mandatory dependencies becomes quite a bit&nbsp;clearer:</p>
<div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
    <span class="s1">&#39;optional!myapp/common/buttons/awesome-button&#39;</span><span class="p">,</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>

<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">AwesomeButtonController</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... (some work around) ...</span>
<span class="p">}</span>

<span class="p">});</span>
</pre></div>


<p>Of course, you still need to actually code around the potential lack of an optional dependency.
The <code>if</code> statement above is just an illustrative example; you may find it more sensible to provide some shim&nbsp;instead:</p>
<div class="highlight"><pre><span class="nx">AwesomeButtonController</span> <span class="o">=</span> <span class="nx">AwesomeButtonController</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</pre></div>


<p>Either way, I recommend trying to keep the size of such conditional logic to a minimum.
Ideally, it should be confined to a single place, or &#8212; better yet &#8212; abstracted behind a&nbsp;function.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>An actual <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import"><code>import</code> statement</a>
has made it into the <span class="caps">ES6</span> (ECMAScript 2015) standard but, as of this writing, no browser implements it.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Most of the code for the plugin presented here is based on
<a href="http://stackoverflow.com/a/27422370/434799">this StackOverflow answer</a>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/requirejs-optional.html#requirejs-optional">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/jinja-reload-macro-files.html#jinja-reload-macro-files">Reload Jinja macro&nbsp;files</a></h2>
    <p>
      Posted on Thu 24 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/jinja.html">Jinja</a>,      <a href="http://xion.io/tag/flask.html">Flask</a>,      <a href="http://xion.io/tag/werkzeug.html">Werkzeug</a>,      <a href="http://xion.io/tag/flask-script.html">Flask-Script</a>      &#8226; <a href="http://xion.io/post/code/jinja-reload-macro-files.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>The integration between <a href="http://jinja.pocoo.org">Jinja templating engine</a> and the
<a href="http://flask.pocoo.org">Flask microframework</a> for Python is quite seamless most of the time. It also facilitates
rapid development: when we run our web application through Flask&#8217;s development server, any changes in Python code
will get picked up immediately without restarting it. Similarly, Jinja&#8217;s default template loader will detect
whether any template has been modified after its last compilation and recompile it if&nbsp;necessary.</p>
<p>One instance when it <em>doesn&#8217;t</em> seem to work that well, though, is template files that only contain
<a href="http://jinja.pocoo.org/docs/dev/templates/#macros">Jinja macros</a>. They apparently aren&#8217;t subject to the same caching
rules that apply to regular templates. Modifications to those files alone may not be picked up by Jinja <code>Environment</code>,
causing <a href="http://flask.pocoo.org/docs/0.10/api/#flask.render_template"><code>render_template</code> calls</a> in Flask
to (indirectly) use their stale&nbsp;versions.</p>
<h4>I&#8217;ll be watching&nbsp;you</h4>
<p>This problem can be alleviated by making the server watch those macro files explicitly, not unlike the Python sources
it already monitors. When running a Flask server through
<a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.run">the <code>Flask.run</code> method</a>, you can pass additional keyword arguments
which aren&#8217;t handled by Flask itself, but by the underlying <a href="http://wsgi.readthedocs.org/en/latest/what.html"><span class="caps">WSGI</span></a>
scaffolding called <a href="http://werkzeug.pocoo.org/">Werkzeug</a>. The automatic reloader is actually part of it and is quite
configurable. Most importantly, it allows passing a list of <code>extra_files=</code> to&nbsp;watch:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PORT&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)),</span>
        <span class="n">extra_files</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">template_folder</span><span class="p">,</span> <span class="s">&#39;macros.html&#39;</span><span class="p">)])</span>
</pre></div>


<p>But of course it&#8217;s tedious and error-prone to keep this list up to date manually, so let&#8217;s try to do&nbsp;better.</p>
<h4>&#8230;all of&nbsp;you</h4>
<p>I&#8217;m going to assume you&#8217;re keeping all your Jinja macro files inside a single directory. This makes sense,
as macros are reusable pieces of template code that are imported by multiple regular templates,
so they shouldn&#8217;t be scattered around the codebase without some order. The folder may be named <em>macros</em>, <em>util</em>,
<em>common</em>, or similar; what&#8217;s important is that all the macros have a designated place in the project source&nbsp;tree.</p>
<p>Under this assumption, it&#8217;s not difficult to programmatically compute their complete list<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">myapplication</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c"># Flask application object</span>


<span class="c">#: Directories under app&#39;s template folder that contain files</span>
<span class="c">#: with only Jinja macros.</span>
<span class="n">JINJA_MACRO_DIRS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;macros&#39;</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">get_extra_files</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns an iterable of the extra files that the Flask server</span>
<span class="sd">    should monitor for changes and reload the app if any has been modified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">app_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">JINJA_MACRO_DIRS</span><span class="p">:</span>
        <span class="n">macros_dir</span> <span class="o">=</span> <span class="n">app_root</span> <span class="o">/</span> <span class="n">app</span><span class="o">.</span><span class="n">template_folder</span> <span class="o">/</span> <span class="n">dirname</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">macros_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">&#39;*.html&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>


<p>If you&#8217;re using Flask <a href="http://flask.pocoo.org/docs/0.10/blueprints/">blueprints</a>,
in addition to the global application templates you&#8217;d also want to monitor any blueprint-specific macro&nbsp;files:</p>
<div class="highlight"><pre>        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">blueprints</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">macros_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">root_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">bp</span><span class="o">.</span><span class="n">template_folder</span> <span class="o">/</span> <span class="n">dirname</span>
            <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">macros_dir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s">&#39;*.html&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>


<h4>A new&nbsp;start</h4>
<p>How you&#8217;re going to use the <code>get_extra_files</code> function from the snippet above depends on how exactly you&#8217;re running
the Flask development server. In the simplest case, when <code>Flask.run</code> is invoked at the top-level scope of some module,
it&#8217;s pretty&nbsp;obvious:</p>
<div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">extra_files</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">get_extra_files</span><span class="p">()))</span>
</pre></div>


<p>More realistically, though, you may be using the <a href="http://flask-script.readthedocs.org/">Flask-Script</a> extension
for all management tasks, including starting the server. If so, calling <code>Flask.run</code> will be relegated to it,
so you&#8217;ll need to override the <code>Server</code> command to inject additional parameters&nbsp;there:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask.ext.script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Server</span> <span class="k">as</span> <span class="n">_Server</span>

<span class="kn">from</span> <span class="nn">myapplication</span> <span class="kn">import</span> <span class="n">app</span>


<span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">_Server</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;use_reloader&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;extra_files&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_extra_files</span><span class="p">())</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">with_default_commands</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PORT&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)))</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
</pre></div>


<p>This new <code>server</code> command should work just like the default one provided by Flask-Script out of the box,
except that all your Jinja macro files will now be monitored for&nbsp;changes.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Like <a href="http://xion.io/post/code/flask-auto-error-pages.html">before</a>, I&#8217;m using the
<a href="https://docs.python.org/3/library/pathlib.html"><em>pathlib</em> module</a>, for which there is a
<a href="https://pypi.python.org/pypi/pathlib/">backport</a> if you&#8217;re using Python 3.3 or older.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/jinja-reload-macro-files.html#jinja-reload-macro-files">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/memcached-purge-local.html#memcached-purge-local">Purging local&nbsp;Memcached</a></h2>
    <p>
      Posted on Sat 19 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/memcache.html">memcache</a>,      <a href="http://xion.io/tag/memcached.html">Memcached</a>,      <a href="http://xion.io/tag/expect.html">expect</a>,      <a href="http://xion.io/tag/caching.html">caching</a>,      <a href="http://xion.io/tag/scripting.html">scripting</a>,      <a href="http://xion.io/tag/tcl.html">Tcl</a>      &#8226; <a href="http://xion.io/post/code/memcached-purge-local.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><a href="http://memcached.org/">Memcached</a> is a ubiquitous caching solution, most commonly used to speed things up
in web application backends. You deploy it as a separate binary and have your application servers talk to it
before querying a database, calling a third party <span class="caps">API</span> over <span class="caps">HTTP</span>, or performing some other time-consuming I/O operation.
Since it stores data in memory, as its name obviously suggests, it can be orders of magnitude faster than anything
that may have to hit a spinning disk (like a database) or an unreliable, external&nbsp;network.</p>
<p>From the point of view of a developer, using Memcached is pretty simple.
There exist <a href="https://code.google.com/p/memcached/wiki/Clients">numerous libraries</a> that wrap its protocol in a neat,
language-appropriate <span class="caps">API</span>. It does put another requirement on the development environment, of course: you need to have
a working memcached deamon in the background if you want the local server to hit code paths where it retrieves data
from memcache<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. Thankfully, it&#8217;s an extremely popular piece of software, present in basically all
<a href="https://code.google.com/p/memcached/wiki/NewInstallFromPackage">package repositories</a>,
so having it up and running is just one <code>apt-get install</code> or <code>brew install</code> away.</p>
<h4>How to&nbsp;flush</h4>
<p>It&#8217;s a little dated and finicky piece of software, too. Once you have its local instance used for a while,
there comes a time when you&#8217;d like to purge all its contents and have your server(s) fill it up again.
Rather than restarting the daemon (which is system-specific procedure that may require root privileges),
you&#8217;d like to just issue the <code>flush_all</code> command to&nbsp;it.</p>
<p>This <em>should</em> be easy. Unlike <a href="http://redis.io/">Redis</a>, however, memcached doesn&#8217;t come with a dedicated <span class="caps">CLI</span> client.
In theory, it doesn&#8217;t have to, because you can talk to it over just <code>telnet</code>:</p>
<div class="highlight"><pre><span class="nv">$ </span>telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">&#39;^]&#39;</span>.
flush_all
OK
^<span class="o">]</span>

telnet&gt; quit
Connection closed.
</pre></div>


<p>But going through this rigmarole every time we want to flush memcache gets a bit tedious after a while.
An obvious attempt at automating it will, however,&nbsp;fail:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;flush_all\n&quot;</span> <span class="p">|</span> telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is <span class="s1">&#39;^]&#39;</span>.
Connection closed by foreign host.
</pre></div>


<p>Turns out the you cannot just bombard memcached with <code>flush_all</code> (or any other command) while the connection
is being established. You can of course try adding a <code>sleep</code> to allow it some time, but this is inherently unreliable,
especially when connecting to remote&nbsp;servers.</p>
<p>The most successful approach I&#8217;ve managed to find is to automate not the raw data exchange,
but the <em>interactive <code>telnet</code> session itself</em>. By that I mean invoking a <code>telnet</code> command, observing its output
and reacting to it &#8212; just like a human would do, but in a scripted, automated&nbsp;way.</p>
<h4>Nobody expects the Telnet&nbsp;instrumentation</h4>
<p>There is a dedicated Unix program for scripting just this kind of <span class="caps">CLI</span> interactions. It&#8217;s decidedly more obscure
than mere <code>echo</code> or pipes, but should nonetheless be available for any modern (or ancient) Unix system,
from Linuxes to <span class="caps">OSX</span>. Its name is <code>expect</code> and &#8212; if installed<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> &#8212; the usual place you can find it is
<code>/usr/bin</code> or <code>/usr/local/bin</code>.</p>
<p><code>expect</code> accepts commands and scripts written in <a href="https://en.wikipedia.org/wiki/Tcl">Tcl</a> &#8212; a scripting language
whose syntax looks a bit like a mix of <span class="caps">PHP</span> and Objective-C. It&#8217;s a fully featured language with all the usual
programming constructs you&#8217;d normally want but <code>expect</code> enhances it further with instructions dedicated to spawning
external processes, reading their output, and sending input in&nbsp;response.</p>
<p>In fact, the main commands of the <code>expect</code> program are <code>spawn</code>, <code>expect</code>, and <code>send</code>. Mashing them together,
we can easily nail the crucial part of our memcache-purging&nbsp;script:</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/expect</span>

<span class="nv">spawn</span> telnet localhost <span class="mi">11211</span><span class="k">;</span>
<span class="nv">expect</span> <span class="s2">&quot;Connected to localhost&quot;</span><span class="k">;</span>
<span class="nv">send</span> <span class="s2">&quot;flush_all\n&quot;</span><span class="k">;</span>
</pre></div>


<p>This performs the actual flush but the <code>telnet</code> session/process is kept open afterwards.
Once the <code>expect</code> program ends (after finishing our script), that process may get orphaned and hog system resources.
To prevent that, we should behave like a good Unix citizen and <em>wait</em> for our child processes to&nbsp;terminate:</p>
<div class="highlight"><pre><span class="nv">wait</span><span class="k">;</span>
</pre></div>


<p>But obviously, this will never happen, because we&#8217;ve never instructed the <code>telnet</code> process to&nbsp;end!</p>
<h4>Escape&nbsp;artist</h4>
<p>Your first instinct may be to send <code>^C</code> (<span class="caps">SIGINT</span>) or <code>^D</code> (end-of-file) to the <code>telnet</code> process
but this won&#8217;t work either. Everything we type inside an active Telnet session is sent to the remote server,
and that includes those two key&nbsp;chords.</p>
<p>Authors of the <code>telnet</code> program were of course aware of this problem. As a countermeasure, they introduced the concept
of an <em>escape character</em> that allows the user to control the Telnet connection itself &#8212; including, but not limited to,
its termination. When encountered in the input stream, the escape character causes <code>telnet</code> to temporally suspend
its normal operation, &#8220;escaping&#8221; from the client-server session to a simple command shell of the <code>telnet</code> program itself.
(This is indicated by the <code>telnet&gt;</code> prompt).</p>
<p>The default escape character is <code>^]</code>, which can be easily typed on a keyboard using the key combination <em>Ctrl+]</em>.
The <code>expect</code> program, however, only simulates typing real characters. Coupled with some syntactical quirks of the Tcl
language, this makes the usage of <code>^]</code> as an escape character rather cumbersome, to say the&nbsp;least.</p>
<p>Fortunately, this default can be changed rather easily with an <code>-e</code> flag to the <code>telnet</code> application.
After setting it to something more common but still outside of the memcache protocol &#8212; such as the exclamation mark &#8212;
we are now able to <code>send</code> it without an&nbsp;issue:</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/expect</span>

<span class="k">set</span> escapechar <span class="o">!</span><span class="k">;</span>

<span class="nv">spawn</span> telnet <span class="o">-</span>e <span class="nv">$escapechar</span> localhost <span class="mi">11211</span><span class="k">;</span>
<span class="nv">expect</span> <span class="s2">&quot;Connected to localhost&quot;</span><span class="k">;</span>
<span class="nv">send</span> <span class="s2">&quot;flush_all\n&quot;</span><span class="k">;</span>

<span class="nv">send</span> <span class="nv">$escapechar</span><span class="k">;</span>
<span class="nv">expect</span> <span class="s2">&quot;telnet&gt;&quot;</span><span class="k">;</span>
<span class="nv">send</span> <span class="s2">&quot;quit\n&quot;</span><span class="k">;</span>
<span class="nv">wait</span><span class="k">;</span>
</pre></div>


<p>The script will also terminate despite <code>wait</code>ing for the <code>telnet</code> process to finish, which means everything has been
shut down&nbsp;gracefully.</p>
<h4>Production-ready</h4>
<p>As a final touch, it&#8217;d be nice to make our solution work with any memcache server and not just <em>localhost</em>.
You can see it done in <a href="https://gist.github.com/Xion/624979b05e0411324eb1">this gist</a>: the script accepts
two optional arguments (host <span class="amp">&amp;</span> port) and uses it when spawning the <code>telnet</code> process.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>It probably goes without saying that any value in the memcache, as well as the entire memcached server (or servers),
must be treated as potentially unavailable at any time. A properly written application server should still be able
to service all requests &#8212; if only a little slower &#8212; without any (mem)caching at all.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>On all distros, as well as in Homebrew for <span class="caps">OSX</span>, it should be available as a package with a totally uncreative
name of <code>expect</code>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/memcached-purge-local.html#memcached-purge-local">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/js-mailto-urls.html#js-mailto-urls">mailto: URLs in&nbsp;JavaScript</a></h2>
    <p>
      Posted on Tue 15 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/javascript.html">JavaScript</a>,      <a href="http://xion.io/tag/email.html">email</a>,      <a href="http://xion.io/tag/url.html">URL</a>      &#8226; <a href="http://xion.io/post/code/js-mailto-urls.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Though not as popular as back in the days, <code>mailto:</code> URLs are sometimes still the best way
&#8212; and most certainly the easiest &#8212; to enable users to send emails from a web application. Typically, they are used
in plain regular links that are created with the <code>&lt;a&gt;</code> tag:</p>
<div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;mailto:john.doe@example.com&quot;</span><span class="nt">&gt;</span>Send email<span class="nt">&lt;/a&gt;</span>
</pre></div>


<p>Depending on the operating system and browser settings, clicking on such a link could invoke a different mail client.
In the past, this could cause much confusion if the user has never used its local email application (e.g. Outlook),
but nowadays browsers are increasingly doing the right thing and presenting a choice of possible options.
This includes the various web applications from popular email providers. User can thus choose &#8212; say &#8212; Gmail, and have
all subsequent <code>mailto:</code> links take them to a <em>Compose Mail</em> view&nbsp;there.</p>
<p>Given those developments, it&#8217;s possible that soon those URLs won&#8217;t be as quaint as they used to be ;)
In any case, I think it&#8217;s worthwhile to have a few <code>mailto:</code> tricks up our sleeve for when they turn out to be
an appropriate solution for the task at&nbsp;hand.</p>
<h4>Triggering them in&nbsp;JavaScript</h4>
<p>In the example above, I&#8217;ve used a <code>mailto:</code> <span class="caps">URL</span> directly in some <span class="caps">HTML</span> markup. For the most part, however, those URLs
behave like any other and support a lot of the same functionality that <code>http://</code> URLs&nbsp;do:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">&#39;mailto:&#39;</span> <span class="o">+</span> <span class="nx">address</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Predictably, calling this <code>sendEmail</code> function is equivalent to clicking on a <code>mailto:</code> link. This additional level
of indirection, however, may be enough to fool some web crawlers that look for email addresses to spam. Its effectiveness
depends largely on how radically we&#8217;re going to obfuscate the <code>address</code> argument in the actual&nbsp;invocation.</p>
<p>More importantly, though, a function like that can be part of some more complicated logic. The only limitation is
the same one that restricts where and when it&#8217;s possible to <code>window.open</code> another browser window. Namely, it has to be
called in a direct response to a <span class="caps">UI</span> action triggered by the user (a button click would be a good&nbsp;example).</p>
<h4>Customization</h4>
<p>In their simplest form, <code>mailto:</code> URLs aren&#8217;t terribly interesting, since their only parameter is the address of a sole recipient. Fortunately, this isn&#8217;t where their capabilities end: it&#8217;s possible to customize other email fields as well,
such as the subject or even body<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>Somewhat surprisingly, all this can be done in a manner that&#8217;s more typical for <code>http://</code> <span class="caps">URL</span>: with query string
parameters. Right after the recipient&#8217;s address, we can drop a question mark and add some ampersand-separated
key-value&nbsp;pairs:</p>
<div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;mailto:john.doe@example.com?subject=Hi&amp;amp;body=Hello%20John!&quot;</span><span class="nt">&gt;</span>
  Say hello to John!
<span class="nt">&lt;/a&gt;</span>
</pre></div>


<p>A more programmatic approach is of course also possible. One thing we need to remember, though, is the proper escaping
of input values in order to make them safe to put inside an <span class="caps">URL</span><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>.
The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent"><code>encodeURIComponent</code> function</a> can be used for this&nbsp;purpose:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">getMailtoUrl</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">subject</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">subject</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;subject=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">subject</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">body</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;body=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;mailto:&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>In theory, almost any of the numerous <a href="https://en.wikipedia.org/wiki/Email#Header_fields">email headers</a> can be specified
this way. However, support may vary across browsers, especially since some of the headers
(like <a href="https://en.wikipedia.org/wiki/Blind_carbon_copy">the <code>Bcc:</code> one</a>) are subject to certain security
or privacy considerations. Personally, I wouldn&#8217;t recommend relying on anything besides
<code>subject=</code> and <code>body=</code>, with a possible addition of <code>cc=</code> for
<a href="https://en.wikipedia.org/wiki/Carbon_copy">the <code>Cc:</code>header </a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>By <a href="http://www.ietf.org/rfc/rfc2368.txt"><span class="caps">RFC</span> 2368</a>, only <em>text/plain</em> email body can be specified this way.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Note that this is unrelated to the <em><span class="caps">HTML</span></em> escaping of <code>&amp;</code> character as <code>&amp;amp;</code> entity in the previous example.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/js-mailto-urls.html#js-mailto-urls">Continue reading</a>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://xion.io/category/code5.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
    <a class="btn float-right" href="http://xion.io/category/code3.html">
      Newer Posts <i class="fa fa-angle-right"></i>
    </a>
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2017 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>