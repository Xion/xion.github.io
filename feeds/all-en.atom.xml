<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Karol Kuczmarski's Blog</title><link href="http://xion.io/" rel="alternate"></link><link href="http://xion.io/feeds/all-en.atom.xml" rel="self"></link><id>http://xion.io/</id><updated>2018-01-24T22:49:00-08:00</updated><entry><title>Unfolding a Stream of paginatedÂ items</title><link href="http://xion.io/post/code/rust-unfold-pagination.html" rel="alternate"></link><updated>2018-01-24T22:49:00-08:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2018-01-24:post/code/rust-unfold-pagination.html</id><summary type="html">&lt;p&gt;My &lt;a href="https://github.com/Xion/ezomyte"&gt;most recent Rust crate&lt;/a&gt;
is an &lt;span class="caps"&gt;API&lt;/span&gt; client for &lt;a href="https://www.pathofexile.com/developer/docs/api-resource-public-stash-tabs"&gt;the Path of Exile&amp;#8217;s public stash tabs&lt;/a&gt;.
One problem that I had to solve while writing it was to turn a sequence of &lt;em&gt;paginated&lt;/em&gt; items
(in this case, player stash tabs) into a single, asynchronous &lt;code&gt;Stream&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;In this post, I&amp;#8217;ll explain how to use
&lt;a href="https://docs.rs/futures/0.1.17/futures/stream/trait.Stream.html"&gt;the &lt;code&gt;Stream&lt;/code&gt; interface&lt;/a&gt;,
along with functions from &lt;a href="https://docs.rs/futures"&gt;the &lt;code&gt;futures&lt;/code&gt; crate&lt;/a&gt;,
to create a single &lt;code&gt;Stream&lt;/code&gt; from multiple batches of&amp;nbsp;entities.&lt;/p&gt;
&lt;h4&gt;Pagination&amp;nbsp;101&lt;/h4&gt;
&lt;p&gt;To divide a long list of items into &lt;em&gt;pages&lt;/em&gt;
is a very common pattern in many &lt;span class="caps"&gt;HTTP&lt;/span&gt;-based&amp;nbsp;APIs.&lt;/p&gt;
&lt;p&gt;If the client requests a sequence of entities
that would be too large to serve as a single response,
there has to be some way to split it over multiple &lt;span class="caps"&gt;HTTP&lt;/span&gt; roundtrips.
To accomplish that, &lt;span class="caps"&gt;API&lt;/span&gt; servers will often return a constant number of items at first (like 50),
followed by some form of &lt;em&gt;continuation token&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;$ curl http://api.example.com/items
{
    &amp;quot;items&amp;quot;: [
        {...},
        {...},
        {...}
    ],
    &amp;quot;continuationToken&amp;quot;: &amp;quot;e53c68db0ee412ac239173db147a02a0&amp;quot;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Such token is preferably an opaque sequence of bytes,
though sometimes it can be an explicit offset (index) into the list of results&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.
Regardless of its exact nature, clients need to pass the token with their next request
in order to obtain another batch of&amp;nbsp;results:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;$ curl &amp;#39;http://api.example.com/items?after=e53c68db0ee412ac239173db147a02a0&amp;#39;
{
    &amp;quot;items&amp;quot;: [
        {...},
        {...}
    ],
    &amp;quot;continuationToken&amp;quot;: &amp;quot;4e3986e4c7f591b8cb17cf14addd40a6&amp;quot;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Repeat this procedure for as long as the response contains a continuation token,
and you will eventually go through the entire sequence.
If it&amp;#8217;s really, &lt;em&gt;really&lt;/em&gt; long (e.g. it&amp;#8217;s a Twitter firehose for a popular hashtag),
then you may of course hit some problems due to the sheer number of requests.
For many datasets, however, this pagination scheme is absolutely sufficient
while remaining relatively simple for clients to&amp;nbsp;implement.&lt;/p&gt;
&lt;h4&gt;Stream it in&amp;nbsp;Rust&lt;/h4&gt;
&lt;p&gt;What the client code would typically do, however,
is to hide the pagination details completely
and present only the final, unified sequence of items.
Such abstraction is useful even for end-user applications,
but it&amp;#8217;s definitely expected from any shared library that wraps the third-party &lt;span class="caps"&gt;API&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Depending on your programming language of choice,
this abstraction layer may be very simple to implement.
Here&amp;#8217;s how it could be done in Python,
whose concepts of &lt;em&gt;iterables&lt;/em&gt; and &lt;em&gt;generators&lt;/em&gt; are a perfect fit for this task&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;requests&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;iter_items&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;after&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Yield items from an example API.&lt;/span&gt;
&lt;span class="sd"&gt;    :param after: Optional continuation token&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://api.example.com/items&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;after&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;?after=&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;after&lt;/span&gt;
        &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;raise_for_status&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;items&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]:&lt;/span&gt;
            &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;
        &lt;span class="n"&gt;after&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;continuationToken&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;after&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;break&lt;/span&gt;

&lt;span class="c"&gt;# consumer&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;iter_items&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In Rust, you can find their analogues in the &lt;code&gt;Iterator&lt;/code&gt; and &lt;code&gt;Stream&lt;/code&gt; traits,
so we&amp;#8217;re off to a pretty good start.
What&amp;#8217;s missing, however, is the equivalent of &lt;code&gt;yield&lt;/code&gt;:
something to tell the consumer &amp;#8220;Here, have the next item!&amp;#8221;,
and then &lt;em&gt;go back&lt;/em&gt; to the exact same place in the producer&amp;nbsp;function.&lt;/p&gt;
&lt;p&gt;This ability to jump back and forth between two (or more) functions
involves having a language support for &lt;em&gt;coroutines&lt;/em&gt;.
Not many mainstream languages pass this requirement,
although Python and C# would readily come to mind.
In case of Rust, there have been some nightly
&lt;a href="https://github.com/rust-lang/rfcs/blob/master/text/2033-experimental-coroutines.md"&gt;proposals&lt;/a&gt;
and &lt;a href="https://docs.rs/futures-await"&gt;experiments&lt;/a&gt;,
but nothing seems to be stabilizing anytime&amp;nbsp;soon.&lt;/p&gt;
&lt;h4&gt;&lt;span class="caps"&gt;DIY&lt;/span&gt;&amp;nbsp;streaming&lt;/h4&gt;
&lt;p&gt;But of course, if you do want a &lt;code&gt;Stream&lt;/code&gt; of paginated items,
there is at least one straightforward solution:
just implement the &lt;code&gt;Stream&lt;/code&gt; trait&amp;nbsp;directly.&lt;/p&gt;
&lt;p&gt;This is actually quite a viable approach, very similar to rolling out a custom &lt;code&gt;Iterator&lt;/code&gt;.
Some minor differences stem mostly from a more complicated state management in &lt;code&gt;Stream::poll&lt;/code&gt;
compared to &lt;code&gt;Iterator::next&lt;/code&gt;.
While an iterator is either exhausted or not,
a stream can also be &lt;a href="https://docs.rs/futures/0.1.17/futures/enum.Async.html"&gt;waiting&lt;/a&gt;
for the next item to &amp;#8220;arrive&amp;#8221; (&lt;code&gt;Ok(Async::NotReady)&lt;/code&gt;),
or have errored out permanently (&lt;code&gt;Err(e)&lt;/code&gt;).
As a consequence, the return value of &lt;code&gt;Stream::poll&lt;/code&gt; is
&lt;a href="https://docs.rs/futures/0.1.17/futures/type.Poll.html"&gt;slightly more complex&lt;/a&gt;
than just plain &lt;code&gt;Option&lt;/code&gt;, but nevertheless quite&amp;nbsp;manageable.&lt;/p&gt;
&lt;p&gt;Irrespective of difficulty,
writing a custom &lt;code&gt;Stream&lt;/code&gt; from scratch would inevitably involve a lot of boilerplate.
You may find it necessary in more complicated applications, of course,
but for something that&amp;#8217;s basically a glorified &lt;code&gt;while&lt;/code&gt; loop,
it doesn&amp;#8217;t seem like a big ask to have a more concise&amp;nbsp;solution.&lt;/p&gt;
&lt;h4&gt;The stream&amp;nbsp;unfolds&lt;/h4&gt;
&lt;p&gt;Fortunately there is one!
Its crucial element is the standalone
&lt;a href="https://docs.rs/futures/0.1.17/futures/stream/fn.unfold.html"&gt;&lt;code&gt;stream::unfold&lt;/code&gt; function&lt;/a&gt;
from the &lt;code&gt;futures&lt;/code&gt; crate.&lt;/p&gt;
&lt;p&gt;Reading through the signature of this function can be a little intimidating at first.
Part of it is Rust&amp;#8217;s verbose syntax for anything
that involves both trait bounds and closures&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;,
making &lt;code&gt;stream::unfold&lt;/code&gt; seem more complicated than it actually is.
Indeed, if you&amp;#8217;ve ever used &lt;code&gt;Iterator&lt;/code&gt; adapters like &lt;code&gt;.filter_map&lt;/code&gt; or &lt;code&gt;.fold&lt;/code&gt;,
the &lt;code&gt;unfold&lt;/code&gt; function will be pretty easy to understand.
(And if you haven&amp;#8217;t, don&amp;#8217;t worry! It&amp;#8217;s really quite simple&amp;nbsp;:))&lt;/p&gt;
&lt;p&gt;If you look closely, you&amp;#8217;ll see that &lt;code&gt;stream::unfold&lt;/code&gt; takes the following two&amp;nbsp;arguments:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;first one is essentially an arbitrary initial value, called a &lt;em&gt;seed&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;second one is a &lt;em&gt;closure&lt;/em&gt; that receives the seed and returns an optional &lt;em&gt;pair&lt;/em&gt; of&amp;nbsp;values&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;What are those values?&amp;#8230;
Well, the entire purpose of the &lt;code&gt;unfold&lt;/code&gt; function is to create a &lt;code&gt;Stream&lt;/code&gt;,
and a stream should inevitably produce some &lt;em&gt;items&lt;/em&gt;.
Consequently, the first value in the returned pair will be the next item in the&amp;nbsp;stream.&lt;/p&gt;
&lt;p&gt;And what about the second value? That&amp;#8217;s just the &lt;em&gt;next state&lt;/em&gt; of the seed!
It will be received by the very same closure
when someone asks the &lt;code&gt;Stream&lt;/code&gt; to produce its next item.
By passing around a useful value &amp;#8212; say, a continuation token &amp;#8212;
you can create something that&amp;#8217;s effectively a &lt;code&gt;while&lt;/code&gt; loop from the Python example&amp;nbsp;above.&lt;/p&gt;
&lt;p&gt;&lt;div class="graphviz" style="text-align: center;"&gt;&lt;img src="data:image/png;base64,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xjpKL774YpyUjAorASo0YW05yk0CJEACJJA2ARgJY68xjNJgg1pspOzWk0o7M54QKAJUaALVHBSGBEiABEgg3wRgGAy7mnHjxukWFNgLjxuq5pt6/vOnQpN/xiyBBEiABEgggASwCjz2pqotq3HDDV4WVQyglBTJLwEqNH5JMR0JkAAJkEDREahevbqRleXVrRvbT/To0cN4t+wpugoXcYWo0BRx47JqJEACJEACqQlg7yjsJYW9oLBP1JFHHqn7uKU+kymCRIAKTZBag7KQAAmQAAkUjECHDh3M7NmzdZNjbHaJncwZwkOACk142oqSkgAJkAAJ5JkAdpDHTvNYWV42WTVTpkzJc4nMPlcEqNDkiiTzIQESIAESKAoC2DcKdjXHHXecLsZHY+FwNGuZ2vogHE1CKUmABEiABApNABvFPv300wab18JYeNmyZZGNiwstG8uPT4AKTXwujCUBEiABEijjBLBtwqBBg3RH9J49e5r169ebgQMHlnEqwa0+FZrgtg0lIwESIAESCACBCy+80FSpUsWcc8455vfff9cNLgMgFkWIIRBXoVmyZAl3I40BFeSfc+bMMS1btgyyiCllO/XUUw3ehhjKJoG5c+fq0H5Ya491S2A8yl2c/bXgTz/95C9hgFJ16dLFYBrqjDPOMBs2bDD33Xcf71kBah+IUkKh2WeffUyLFi0CJibFSUYAlviNGzdOliSwx3bZZRfTsWPHwMpHwUqHwIEHHmgaNWpUOoXluJS1a9fqarOFXozts88+M3///bfZc889c1zD3GfXtm1b06BBg9xnnOccO3XqZDbffHNVXNHe2OySL2J5hp5G9ptYCWmkZ1ISIAESIAEPgX79+umS+W+//bapU6eO50jpfsUoLQxYsUcRQ34JvPLKK7qx5fnnn2/uvvvu/BbG3H0ToNu2b1RMSAIkQAIlCdx4443m3XffLagyA6mwCFxYR7lKUg12DNy54QGFaadrrrkm2MKWIelKTDmVobqzqiRAAiSQNYEKFSro5oZZZ5RFBr/88otZsWKFadiwYRa58NR0CJx88sk65QRD4a222sr07ds3ndOZNg8EqNDkASqzJAESIIHSJOCW6OcITWlSN7o+DWyoLr74YlVqunfvXroCsLQoAlRoonDwBwmQAAmEjwAUGqxuu9NOO4VP+JBL3Lt3b7N69WrdpXvnnXc2bdq0CXmNwis+FZrwth0lJwESIAElMH/+fE43FbAvDBgwwHz99dcGy0/AOHy//fYroDRlt2gaBZfdtmfNSYAE0iRQaNfsROJSoUlEpvTiR4wYoctnwCX9u+++K72CWVKEABWaCAp+IQESIIHEBKZPn27q1atnfvjhh8SJCnRk4cKFoVh/pkB4SqVYGIePGTPGVK1a1UCpWbduXamUy0L+I0CF5j8W/EYCJEACcQlguftu3boZLDxao0aNuGkKFbly5UqDlXfDsKBeoRiVVrlbb721mThxolm+fLmuKMxl3kqL/L/lUKEpXd4sjQRIIIQEsAIv3rofeOCBwEmP0RkEKjTBaJrddtvNjB071mDxPW5kWbptwpWCS5c3SyMBEiCBnBLA8vuXXHKJgfswl+HPKdqsMrvnnntMnz59zKRJk8wxxxyTVV482R8BjtD448RUJEACJBBIAhihwb5IVGaC1TwXXXSRej117txZPaCCJV1xSkOFpjjblbUiARIoIwRoEBzchh45cqSuDdShQwfdoTu4khaHZFRoiqMdWQsSIIEySgC7bIdx5+qy0FyVK1dWe5olS5Zwa4RSaHAqNKUAmUWQAAmQQD4IYF2cpUuXmvr16+cje+aZAwJ169Y1WKNm+PDh6gGVgyyZRQICVGgSgGE0CZAACQSdwJdffmnggUWFJtgthRWEzzzzTIONLLGJKEN+CFChyQ9X5koCJJAFgSeeeCKLs7M/ddy4cebmm2/OPqM854DpJgQs+McQbAL33nuv2WKLLUzXrl0N16fJT1tRockPV+ZKAiSQIYG33nrL9O/fP8Ozc3Pa9ddfbxYsWJCbzPKYy+LFiw02RKxSpUoeS2HWuSCw5ZZbmqeeesq8/vrrBi7dDLknwM0pc8+UOZIACQiBd99918DGAwu+Pf744+aoo47SvW4AZ/LkyWbWrFm6Q3SnTp3Mdtttp8ygzBx//PHqgoxF7Nzu0V988YW+3Z577rnm119/NRjB+fPPP82OO+5ocL4L8co84IADDPItV66cOfTQQ8348eMNFAFMA8SbqkFZ2IsHMgc9YIQmXh2CLndZlQ/979prrzVXXXWVOe644wzsaxhyR4AL6+WOJXMiARIQAth1uEePHrpSau/evfX3G2+8YVq1amVGjRplevbsaVq0aKGKDqZ1pk6daqZNm2b22msv89FHH5levXoZPKhHjx5tsJQ8di5u1KiRWbNmjfn222+VMZSaXXbZRXeYhhKTqMxmzZoZvBmj3NNPP12H+rfffnv9DQXn008/Ndtuu22JdoMittlmm5WID1oE6geFJogrGAeNVVDkgSJ+0EEHab978803uX5QLhtG5vIYSIAESCCnBD7//HMr9ykroyP2r7/+sj/++KOV/YbssGHD7HXXXRcpSxQUTSfKTiTuhBNOsDVr1oz8xpeTTz7ZigITFYe85Y03EpeoTNmHScuQh7+Vh4mmf/nllzVORmsi54fxy6677mqHDBkSRtHLtMzvv/++LV++vBVFtExzyHXlOeWUS+2QeZEACSgBN1XUpk0bIzdug1ERhNtvv13fTjFK4wLWUMEGi96Qyaq3icpEvsivTp06ZtNN/73lYTQI4ZtvvtHPMP7buHGjWbZsmdYrjPKXZZkxQnPppZeaK664wuAagR0UQ/YEqNBkz5A5kAAJxBDAdA4ClBkXVq9erbsQww6mXbt2LjruZyYKTbwy42YukU4ueUNMlCTw8Vh/5p9//jG777574GWlgCUJ3HDDDQbedJiefemll0omYEzaBP6966R9Gk8gARIggfQIOIVj3rx5KU/MRKFJmWmRJYDxMgJGnhjCR6BSpUrmwQcfNDL9qX/hq0HwJKZCE7w2oUQkUJQEqlatanbbbTdz//33G7Friaoj3Fnd9A+UGSwW5w2YKtqwYYM3qsx/h0JTrVo1A64M4SQAo25422H6CVOIDNkRoEKTHT+eTQIkEIfA+vXrNfbnn3+OOtq3b1+1+2jevLl6N3344YdGjITVg0kMXDUtXLF/+OEHg1Vw8dBGXsccc4xBXo8++qj+xucvv/yiaVatWqXnJSpz3bp16t0EzyUXnFyxipU7HobPr776itNNYWioFDLeeuut5vvvv1f7shRJeTgFASo0KQDxMAmQQHoE4HKNN04EuF7fddddumYMfl9wwQWmX79+Zs6cOQZvp40bN9a1ai688EIc1tCxY0dVQA488EB1/caicYg75JBDdOn4gw8+WN25cRwu3WPGjFE373hlQsm5+uqrNV8saDZhwgS14xk4cKDGYWRo7ty55sknn1QDzX8lCMd/2NDUqlUrHMJSyoQEsPwArolbbrlF1z9KmJAHUhLgOjQpETEBCZBArglgZAQjMJiCwo7EsQFrzsDmBmvIeIO4fkc8pjAFtfnmm3sPZ/wdylX16tV1fZqMMynlE6HQYT2foUOHZlUyFins0qVLVnnw5OwIoC/D8+5///ufriacXW7FeTaufbx8HHvssQkryBGahGh4gARIIF8EYBDZsGHDuMoMytxqq61KKDOId+7f+J4rZQYPE4x2YBQoTCEXIzRB2GYiTMzzJSv68m233WaefvppI2vU5KuY0OYLm7rOnTvrdZqsEuVlz5LrkyXgMRIgARIoZgIwOO7Tp4/ZY489QrNqK+yCBgwYoC6/WCkYqyXD3giK4n333WcqVKgQWdtk+fLl5vnnn9ctH2SRw4jdjdtmArZFWC0ZdhwwMMaIDfLD6NgOO+yg20bArXjmzJm6FQWUTYREZWI158cee0ynE+fPn29GjhypKznvvffeoeFbiP6OLUIwLTpjxgzdmdsrA0Y0sV0IpnDBHSObXmNw2JHBrgzTsZMmTTJjx47VKVqMcqKvPPzwwxoHw3v0DWw1gmPYBgTpsWI2tgjBCtwPPfSQloHVt7FCtwsLFy7UdJjmfOWVV3T6FtNl6A9YPgByP/fcc7okAuK9IVEfRBr0ySlTpqiyUqNGDZUT8sOWDnLCWPq0004zEydO1LJg/4Z1e2JHb7W8XK/Ux/xIgARIgATyS0Bc33Wl49dee83KnkD6XbaZsLIPlpUpPHviiSeqALK0vj3vvPPsBx98YOVhaGW3ZyvrnugxMci2hx12mJVRLyvKjcVvBKSTh4OVB5v+xj9ZMyVSnowMJSwTKzAjP5x/xx13WNlZ2rZt21Z/i91SJD9+iU8A7QB2+HRBlAwrD3CNw6rbN910kxWlwv7222+aRJRHbXNRzK1semn33XdfzePjjz+2smClFYXXTp8+3Ypio/0C+YviY0WJ1/NlpDRqFe61a9daUZYiq3Dj92WXXaZ5nnTSSdp/xObHHnHEEbrasSgaVhQOTYPVvCGHKL9OfJusD0I+8fLSvGVrEiujMPbiiy+2Mv1rRaGxYvhvZf0qK0qxphGnAuUgClwkf+8XGN8xkAAJkAAJhIiAvCHrDV5sjWyiLR/wIJRF9/RB5qrWrVs3Pe+9997TqHjbTMjbuqbxKjRuqwgoUAiJysQx2XhRz5cRBfzUgG0qxObH/eRnEgJHH310RJlAMjFctzKaYsXzT8+S/c6U7+zZsyO5QBmAoiIjGxonoyn6CcUDyo8LYoOi6aBsuuBnWxGklZEYVYScIgVFR0Z7bJMmTSLKlRjhW9kDzcoebZq9nz4oo08qU7KtSVydZaTJiR33kysFSy9gIAESIIEwEcCWBxhyx7QDpswQYreZwFQPpiqwvL4LcIfHQnxLlizRKQnEZ7KIYbJtJjDthYApPBdg8CrKkPvJzyQE4O0E7z945Mnolk63YDoIRuuw98JGrgiiVOoUE7679sBO9QiOPaYhYUzrNluV0RsDr0G3yasm9vkPfQ19x7Uv+h/KrVevXiQOBv6yD5vBkgIIzz77bMo+CPsh9EE/W5Ok6qtUaHw2JpORAAmQQFAIfPfddxEbGdhCILjtHJyMsF+BHcK9997rouJ+pnpIxDspUZnx0iIOsskrdaLDjPcQgB2MTBmaa6+9VhUasIYyA5spPPxxHAF2Ky649nCfLh7ee7C7gX0L1n6CrQ2UGxkFckmy+qxYsWKJ82Gj49aE8tsHYzNxfTm2z6Tqq1RoYknyNwmQAAkEnABGaGINL2NFxkNh8eLFugYQHjKJQqqHRKLzGJ8/AlBe9t9/fx3VgtH3UUcdpYopRmywzpPfgH3TMBqHdZ5kGkgNvAcNGpTU9dlv3kiXqO+4eL990G+ZLt9E6em2nYgM40mABEggoAT8KDSYXsCb8ogRI6JqgU1C4QmFgAdEvG0mcAzTGwyFIYAFI7E69pAhQwwckf/8808drYE03pGZVNJhOhKjdI888ojZZ599jNjOGDHwjToNafLV1n76YJQwCX44RSa2r8Ymp0ITS4S/SYAEygQBMTQ0jz/+eCjr6p1ycsP7bjsHV6FOnTqpPcPll19usLw+3G4x/dC9e/eIWzAedrHbTGBEoHbt2rrIIFx3Fy1apG7fyBdbVeCBmqhMpBFjUXzo1IZ+kX+QDe63sVMI7jg/SxKA7ZN4O+lWIXCph6s0ODplFK7QUE4RXHtgOxBvwL5pL7zwgipEmGqC2zZcs73Bz7YiaDeUEbvfFFzCxVPJm52mcwqSnz6IPJA/5HPB9WXYgCGgnyKIMbum/eSTT/R3iX+SEQMJkAAJlDkCV155pZW1P0JZb1mfww4fPtzKlJKVVX7VS0TWjLF33nmnlQdDpE4LFixQt1258WsaWVdEXbhdArgHw8126623tnfffbeLVpdtxMHNGy65Yoiqrr1w9X311VcTljl16lT1rEJ5Mt1h5UFsxTBU3YARJ6MNVkYbIuXwS3IC8AyD9w88lcReRd2uRSlRj7FtttnGytoz2lZw6wbfU045xc6aNSuS6bhx46wYAesx1wfw2bJlS20bJIQnkmwromlwPcBTCu7ZrVq1UndpeDPBVRznwSV/1KhReo5Mi2mcGAeruzi8nwYPHqxx6DvysqByJOuDcCXHcgPIW9agsbIujhVlPeJeDhd02SZF85FVsTUdeIiirXGx/7j1gZBkIAESKHsEmjZtaho0aKALv4Wp9ph+gDEmFsvr0KGDL9Ex0oJhe7cBqPekRNtM4C0bZcGbBZ+wh4g1OvXmw++5J4ARNSwqh9E1LCYHDyUEeZBrm4iLdNJC33jjDd0f6vDDD9eROFE6dAQFozZY6FBc7CPn52tbEVdAsj7o0iT7RJ0xKgUOiQIVmkRkGE8CJFDUBGSBOH0wYNXVMAVMN8Eg+O233zZ4UDEULwHYjNStW9fAHVtG39KqKPY9at++vU4zOa8hlwGmqtz0o4srhk/a0BRDK7IOJEACaROAnUjYlBlUcsWKFVpXLBPPUNwEoIjAQ0lWAzYYXUknwM4EtjfYygDr0WCLAXg8PfPMM0amhgzsW4otUKEpthZlfUiABIqaAIx4EbA2CUPxEzjnnHPUGBeKSDrh7LPPNsOGDVPjbmwEK3YtagwOI9wbb7xR90VKJ78wpOWUUxhaiTKSAAmQwP8TwNs63tqdBwjBFD+BM844Q0dXsEFoJgE2UMnWIsokzyCewxGaILYKZSIBEiCBBATgJotdiBnKDgHZg8uI95LByruZhLKgzIALFZpMegfPIQESIIECEcBaI1RoCgS/QMVipWDZaNSIm3aBJAhHsVRowtFOlJIESIAElAAVmrLXEeByLztqqz1MOisFlzVSVGjKWouzviRQxgmkWj496Hg45RT0FsqPfJ07d9Y1ZaZPn56fAoogVyo0RdCIrAIJkIB/AtjPBvvahDVAoZFVYsMqPuXOkMAee+xhsMcT1o9hiE+ACk18LowlARIoUgLYrbhatWqhrR32SqpatWpo5afgmROQLQnMiy++qAtCZp5L8Z5JhaZ425Y1IwESiEOgTp06pk2bNnGOhCOKCk042ikfUkKhwWJ58HhiKElg05JRjCEBEiCB4iUgm1KGunLYLZkjNKFuwoyFxwJ5WN0aO2/LhpIZ51OsJ1KhKdaWZb1IgAR0JAZLxmNDO9kp2MiO1JFP73dswBiWAIUmTPKGhWtY5GzdurWRHc91td+wyFxaclKhKS3SLIcESKDUCWC9lkmTJmm5m266qe44DS+nWE8n2NRgN+DKlSuXuozpFIgdh7F0PRWadKgVV9pWrVqZESNGmFWrVtE4PKZpaUMTA4Q/SYAEiodAixYtVImBIoDl3//4448Syky5cuV0j5ugKzNoFciPumy++ebF00isSVoEmjZtqumx2zpDNAEqNNE8+IsESKCICDRv3tykWogMCkLv3r1DUeuNGzeqnBUrVgyFvBQy9wSwyeS+++5rpk2blvvMQ54jFZqQNyDFJwESSEygZs2aBn+JAqah4DlSu3btREkCFb9hwwaVhyM0gWqWUhfm0EMPpadTHOpUaOJAYRQJkEDxEIARZaLN+f766y/Tt2/f0FSWIzShaaq8Ctq4cWPz4Ycflpg+zWuhIcicCk0IGokikgAJZE4A005QXGIDbGfwYGjSpEnsocD+hh0QQiIFLbCCU7CcEjjggAMMvPcWL16c03zDnhkVmrC3IOUnARJISqBZs2ZxV1aFbU3Y1qSBvQ8CNitkKLsEsA0ClNr58+eXXQhxak6FJg4URpEACRQPAaw3U69evRIVgm3NCSecUCKeESQQdAJQZrDi9cKFC4MuaqnKR4WmVHGzMBIggUIQiLWjKV++vLniiisMpp3CGDhCE8ZWy63MUGi++uqr3GYa8tzCeTWHHDrFJwESKF0CsKNx9icouVKlSqZr166lKwRLI4EcEoBn3tKlS3OYY/izokIT/jZkDUiABFIQOPLIIyN2J3DV7tWrl6lSpUqKs4J32BkDY4E9hrJNoEaNGmbFihVlG0JM7anQxADhTxIggeIjgMXI9t57b60YDGsvuuiiUFbSrT/j1qMJZSUodE4IwDbsp59+yklexZIJFZpiaUnWgwRIICmBY489Vo+feuqpZqeddkqaNqgHnULj1qMJqpyUK/8EsJ/X2rVr819QiEqgQhOixqKoJBA2AljjBQasQfgbOnSo4nv66acDIY9jks7Cfk6h8TNC8+WXXwaqnq6+Ze1zl112yctli73HMPWYamuPvBQe0Ey523ZAG4ZikUCxEGjXrp1u/ljo+kAJuP32203//v0LLUqk/HRl2WyzzQz+0nkzHzx4sNl9990jZfJL6RGYOHGimTx5cl4KhGKIAIUmrN56uQZDhSbXRJkfCZBAFIEGDRqYjh07RsUV6geMg3fddddCFV+i3GHDhpWISxWxzTbbmFWrVqVKFjnesmVLc+CBB0Z+80vpEVi2bFneFBq3+jWM3Bn+JcApJ/YEEiCBMkMgSMpMptDTVWgyLYfnBZvAunXrdPmBYEtZutJRoSld3iyNBEiABLIisO2225qVK1dmlQdPDj8B9IHtttsu/BXJYQ2o0OQQJrMiARIggXwTwPojy5cvz3cxzD/gBDCdhb7A8B8BKjT/seA3EiABEgg8AexBhYcZQ9kmAC82GntH9wEqNNE8+IsESIAEAk0ACs23334baBkpXP4JfPLJJwa7bjP8R4AKzX8s+I0ESIAEAk8Ahs3ff/+9rkESeGEpYF4IwH4GIzT0XovGS4Ummgd/kQAJkECgCey5557m77//NosXLw60nBQufwTeeustXTTxsMMOy18hIcyZCk0IG40ikwAJlF0C9evXN1h7ZP78+VEQOA0VhaOof4wfP15HZ+jlFN3MVGiiefAXCZAACQSaAFYKhlIzb968iJxXXnmladu2beQ3vxQvgd9//92MGzfOnHzyycVbyQxrRoUmQ3A8jQRIgAQKReDggw827733ni57f95555lbb73VwEh02rRphRKJ5ZYSAexF9ttvv5nOnTuXUonhKYYKTXjaipKSAAmQgBI44ogjzMyZM02nTp3MI488Yqy1Og2VyVYKRBoeArCdQht36NDB5GvTy/DQKCkpN4EoyYQxJEACJBBoAo0bNzbYeXvs2LGR3Zaxtw82Q/ziiy9MnTp1Ai0/hcuMwEMPPWQ+//xz88ILL2SWQZGfxRGaIm9gVo8ESKC4CGCn7fPPP9/8+uuvEWXG1RDGwnfddZf7yc8iIgBX/auuusp069bNNGrUqIhqlruqUKHJHUvmRAIkQAJ5JfDTTz+Zww8/3Lz//vvG7bbsLfDPP/80I0eONGvWrPFG83vICWCq6fTTTzdVqlQxQ4cODXlt8ic+FZr8sWXOJEACJJAzAtju4JBDDjELFy6Mq8y4gqDUYGqCoXgI9OjRw8yYMcM899xzZuutty6eiuW4JlRocgyU2ZEACeSXAFZIPeecc8rcfkazZs0ymG6CAXCygLf52267TRffS5aOx4JP4J9//jG9evXSUTcoqVxIL3mbUaFJzodHSYAEAkbggw8+MI8++mjUOiwBEzEv4sCz5ZtvvjGDBg0yW265pXo1JSoI9havv/56osOMDwGBVatWmRNPPNGMGDFCFZouXbqEQOrCikiFprD8WToJkECaBLCgGGxJWrduHXXmE088EfW7GH9UqlTJ9O3bV0en+vXrp55OMASODeXKlTMPPvhgbHSgfqMNX3311ZzLlGm+Qeo/EyZMMPvtt5955513DL7DEJghNQEqNKkZMQUJkEDACFSrVi1KIuxt079//6i4Yv5RtWpVc+ONN+qIDaYkKlSoEDVig6kKLLQX1IBpMSwMt3Tp0pyKmGm+Qek/sJM55phjTLt27czee+9tPv74Y3PsscfmlFExZ1ZStS/m2rJuJEACoSeAhzVWxN1iiy0MVszFw+j444/XzfoeeOABs9NOO+kDwVV08uTJBvYn22yzjS5E593/Bga2P/zwgznyyCPNpEmTdMPHjh07mpo1a6pLNN6QsSJv06ZN1SDX5RmUz+23397ccccd5rLLLjPXX3+9TsWVL1/ewDAYn3jApxOwHxTWtrnooovMggULzEsvvWSwuzc8bDDq48Ly5ct1dAWGyrDraNGihR5CeTBc/eOPP/Q3OGIzTbQB2g2jDviN/BC3ww47aLu1b9/e7Ljjji77lJ8//vijrrmDT6y5c8ABB5idd945Yb7YLmDq1KkG05XgcuaZZ2p6FJSs/ySqZ0oB00gAmzBwfuyxx1QJxQ7aGJVp06ZNGrkwKQj810PJgwRIgAQCTgAPWayO27x5czN37lyVForKPvvsYypWrGgaNGigyggO4KGKbQF+/vln3ecID6499thDH9RYw+Xyyy83e+21lxk+fLg+wKG8vPjii2a33XYzr7zyijnjjDP0QXPPPfcYrMwLpSioAavGwmgUO3DD7gLBKTMrVqzwJbbb8LBPnz7m7rvvNrfffruuRgzbjSFDhkTyAEcoT/vvv78qJyeccILp2bOnHoeygNEFKFldu3Y1tWvXVgUTruSYLoNCs2HDhsioA5QQtBmO+Q2rV682xx13nIHiiTaEAgZFJVG+69atM/Xq1dMysI4L3N2hhEHJQUjUf5LV06+sSAcj7vXr1xvYNX300UcGnLHaL5SqunXrqkI2YMAAHZFBmXPmzKEykw5gb1qBzUACJEACeSEgK9paeejkNG+ZSoGbj73//vsj+cpD1cpoQOQ3vshDw1533XWROBl90PNatWoVidtqq62sjPJY2RtH48SLyMr0jW3SpEkkTh5GVjaEtDfffHPkvFx9yQcfyCZTFfaoo47S+p511lm+xZUHvp4joyeRc2T0w8qogf4WRdDuvvvuVpSEyHGx79BzZCQrEic7gVtRMG337t2tPMCtPLAjx/BFHux6zsMPPxwV7+eHKJhWRtQiSWWEwz7zzDP6O16+Tz31lJXRJSsjcVFpZs+eHckjtv/4rWckgwRfrrnmGq0n+qv3T0ajrIxq2auvvtq+9tprduPGjQlyYHQ6BDjl5NXu+J0ESCDwBDASEy9ssskmUdEYYTjooIMiowc4iNGAlStXRtLBFgVTFm6EAN5DmLJyb/RIWLlyZR31+eqrryLnBf0LRqxEWdC6wTMKmxmiHqmC44CRLBcwiiUPXf357LPP6sjGFVdc4Q7rlB0YLlmyJDIth3Mw6iAPdANuGPGKF2LbLF6a2DjIhilHjKBhJAgjamgzb/Dme9ppp+mUVPXq1XUUx23giS0EMGXpgvccv/V05yb6xLTotttua0Sp0ilSTLFBVvQzhtwToEKTe6bMkQRIoAAEvA8kTEvA/uHcc8+NsqfxI1Y8hQlGt5g2CGPATtzx6uS3LphGkrdkTS4jL2rrcu+996Y8HUoPpsFgZ4Ppr3jeWN42S5nh/yfAdCOmmrDWzssvv6xbPWB6yxu8+cL2B8oMFCzsf+WUGNj0eIP3nHTq6c0j9ruM7KmyHOuRF5uOv3NDgDY0ueHIXEiABApMwPtAcgas8+bNS1sqbz7ekxPFe9ME9TuUklwE5AM7HRgdpwowwsVIzaJFi8wNN9wQN3kmTNG2UNIwagRDYiyy6LXxQUHefDFCBHsfbOgJT7hatWqllCWdesbNjJEFIUCFpiDYWSgJkEAuCeAB5oxgkS+mkjAVIXY2EeNPVx6G/zENw5A+gX333VdHqrDYmzdgROy+++6LROE3lIwxY8aYCy+8UBUQZ8SNRE7h8LZZ5OQUXzCVhtGVo48+2nz44YfqYQXDbYR4+cKAGQpY27ZtNU3syIw7zyuL33pqhvwXGAJUaALTFBSEBEjADwExoNRk8F5yAW/qcL+GC+wXX3yhD123AB2mKDBagIefGAnrxo1wRcY0CqaRXH4uL3jFeO1sEI908KIp9oCtFRCc2zW+gzMYgRc8zOCKjSkfjJLA7X306NFGjH/VawfpEeD2jSkeTHUNHjxY7UgwLeQ8i5yLNlzikW86a+bA9uWNN97QcmAXBC8rty5RvHzRdvAwgh0P6uIUL0xJQvFCiO0/UH781FNP5r/gEJDOxEACJEACeSGQay+emTNnWlkpWD1GGjVqZGW9DpVb3F2t2GhY2bjPisuxxsmbuJXVdDVe7rj6CS8eeRO38Ga66aabNB9Zy8WOGjXKwrMF3jhIK0abFt408H6SB7LGIe/HH388p5xyzccrnCh2Kre4AXujE34XpU89mFB/sT2yogRYMY61Mtql+chIh5WRDiuu87Z+/foah7RoB3Gb1nzBVRb6s+KObUXZ0ThxG7fiJq3pZZE4KwqJxsPLB+c3a9bMfv311wnlij2ANhLDYG0feDf17t07Uj7Sxub77rvvWplmUq8rcWm3MjqnXlvirm1lCw3NPl7/SVZPPcnHPzFMVxY+kjJJDghsgjykUzGQAAmQQM4JiPuzLkqHt/l8hzVr1ujib7EeJBgVwMgNpqD8ePrkW05v/vnkgzrD+wjrmmCxtlwHUUJ0igejXZkEPHowSoK1aNIJWEcGBsZYVA8jQOJ6H3V6vHwxzYR+UKVKFU2LNJiGgtGuC4n6Tzb1hBcWjJdhGM2QfwL0cso/Y5ZAAiRQCgRiH2yuSLgiN2zY0P3kZ44IJDKu9Zs97F28ykyPHj1SnoqpLSzOhwAX6HghNl+kgSGxU2bwG2m8ygziEvWfbOuJvBlKhwAVmtLhzFJIgARIgASSEJCppyRH/z2ErR4YSCARASo0icgwngRIgARIoNQIYCsDBhLIhgC9nLKhx3NJgARIgARIgAQCQYAKTSCagUKQAAmQAAmQAAlkQ4AKTTb0eC4JkAAJkAAJkEAgCFChCUQzUAgSIAESIAESIIFsCFChyYYezyUBEiABEiABEggEASo0gWgGCkECJEACJEACJJANASo02dDjuSRAAiRAAiRAAoEgQIUmEM1AIUiABEiABEiABLIhQIUmG3o8lwRIgARIgARIIBAEqNAEohkoBAmQAAmQAAmQQDYEqNBkQ4/nkgAJkAAJkAAJBIIAFZpANAOFIAESIAESIAESyIYAFZps6PFcEiABEiABEiCBQBDgbtuBaAYKQQLFS2DYsGEGfwzxCTRt2jT+gRzFHnTQQTnKidlkQmDnnXfO5DSekwEBKjQZQOMpJEAC/ggMHDjQrFy50l/iMpqqQYMGeal59erVzejRo/OSNzP1T6By5cr+EzNlVgQ2sRKyyoEnkwAJkAAJkAAJkECBCdCGpsANwOJJgARIgARIgASyJ0CFJnuGzIEESIAESIAESKDABKjQFLgBWDwJkAAJkAAJkED2BP4PaDMay9okBEcAAAAASUVORK5CYII="&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;The last important bits about this pair of values is the&amp;nbsp;wrapping.&lt;/p&gt;
&lt;p&gt;First, it is actually a &lt;code&gt;Future&lt;/code&gt;, allowing your stream to yield objects
that it doesn&amp;#8217;t quite have yet &amp;#8212;
for example, those which ultimately come from an &lt;span class="caps"&gt;HTTP&lt;/span&gt;&amp;nbsp;response.&lt;/p&gt;
&lt;p&gt;Secondly, its outermost layer is an &lt;code&gt;Option&lt;/code&gt;.
This enables you to &lt;em&gt;terminate&lt;/em&gt; the stream when the underlying source is exhausted
by simply returning &lt;code&gt;None&lt;/code&gt;.
Until then, however, you should return &lt;code&gt;Some&lt;/code&gt; with the (future of) aforementioned pair of&amp;nbsp;values.&lt;/p&gt;
&lt;h4&gt;Paginate!&amp;nbsp;Paginate!&lt;/h4&gt;
&lt;p&gt;If you have doubts about how all those pieces of &lt;code&gt;stream::unfold&lt;/code&gt; fit in,
then looking at &lt;a href="https://docs.rs/futures/0.1.17/futures/stream/fn.unfold.html#example"&gt;the usage example in the docs&lt;/a&gt;
may give you &lt;em&gt;some&lt;/em&gt; idea of what it enables you to do.
It&amp;#8217;s a very artificial example, though:
the resulting &lt;code&gt;Stream&lt;/code&gt; isn&amp;#8217;t waiting for any asynchronous &lt;code&gt;Future&lt;/code&gt;s,
which is the very reason you&amp;#8217;d use a &lt;code&gt;Stream&lt;/code&gt; over an &lt;code&gt;Iterator&lt;/code&gt; in the first place&lt;sup id="fnref:4"&gt;&lt;a class="footnote-ref" href="#fn:4" rel="footnote"&gt;4&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;We can find a more natural application for &lt;code&gt;unfold&lt;/code&gt;
if we go back to our original problem.
To reiterate, we want to repeatedly query an &lt;span class="caps"&gt;HTTP&lt;/span&gt; &lt;span class="caps"&gt;API&lt;/span&gt; for a long list of items,
giving our callers a &lt;code&gt;Stream&lt;/code&gt; of such items they can process at their leisure.
At the same time, all details about pagination and handling of continuation tokens or offsets
should be completely hidden from the&amp;nbsp;user.&lt;/p&gt;
&lt;p&gt;To use &lt;code&gt;stream::unfold&lt;/code&gt; for this task, we need the initial seed and an appropriate closure.
I have hinted already at using the continuation token as our seed,
or the state that we pass around from one closure invocation to another.
What remains is mostly making the actual &lt;span class="caps"&gt;HTTP&lt;/span&gt; request and interpreting the &lt;span class="caps"&gt;JSON&lt;/span&gt; response,
for which we&amp;#8217;ll use the &lt;em&gt;defacto&lt;/em&gt; standard Rust crates:
&lt;a href="https://docs.rs/hyper"&gt;&lt;code&gt;hyper&lt;/code&gt;&lt;/a&gt;, &lt;a href="https://serde.rs"&gt;Serde&lt;/a&gt;,
and &lt;a href="https://docs.rs/serde_json"&gt;&lt;code&gt;serde_json&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;futures&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;future&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Future&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Stream&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;hyper&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;Client&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;hyper&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;serde_json&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;tokio_core&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;reactor&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Handle&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="kr"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;URL&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="kt"&gt;str&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;http://api.example.com/items&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;Handle&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;after&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Stream&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Item&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Item&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Client&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;unfold&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;after&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;cont_token&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;match&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;cont_token&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{}?after={}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;URL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Get&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;from_err&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;and_then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;concat2&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;from_err&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;and_then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_success&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="n"&gt;serde_json&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;from_slice&lt;/span&gt;&lt;span class="o"&gt;::&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;ItemsResponse&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map_err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;::&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;::&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HTTP status: {}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;into&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;items_resp&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;iter_ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;items_resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;items_resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;continuation_token&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatten&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="cp"&gt;#[derive(Deserialize)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ItemsResponse&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Item&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="cp"&gt;#[serde(rename = &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;continuationToken&amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;continuation_token&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;While &lt;a href="https://play.rust-lang.org/?gist=556ff0d112272b3c2da36c3d03aac52e&amp;amp;version=stable"&gt;this code&lt;/a&gt;
may be a little challenging to decipher at first,
it&amp;#8217;s not out of line compared to how working with &lt;code&gt;Future&lt;/code&gt;s and &lt;code&gt;Stream&lt;/code&gt;s looks like in general.
In either case, you can expect a lot of &lt;code&gt;.and_then&lt;/code&gt; callbacks&amp;nbsp;:)&lt;/p&gt;
&lt;p&gt;There is one detail here that I haven&amp;#8217;t mentioned previously, though.
It relates to the &lt;code&gt;stream::iter_ok&lt;/code&gt; and &lt;code&gt;Stream::flatten&lt;/code&gt; calls
which you may have already noticed.&lt;br&gt;
The issue with &lt;code&gt;stream::unfold&lt;/code&gt; is that it only allows to yield an item &lt;em&gt;once&lt;/em&gt; per closure invocation.
For us, this is too limiting: a single batch response from the &lt;span class="caps"&gt;API&lt;/span&gt; will contain many such items,
but we have no way of &amp;#8220;splitting&amp;#8221;&amp;nbsp;them.&lt;/p&gt;
&lt;p&gt;What we can do instead is to produce a &lt;code&gt;Stream&lt;/code&gt; of entire &lt;em&gt;batches&lt;/em&gt; of items,
at least at first, and then &lt;code&gt;flatten&lt;/code&gt; it.
What &lt;code&gt;Stream::flatten&lt;/code&gt; does here is to turn a nested &lt;code&gt;Stream&amp;lt;Stream&amp;lt;Item&amp;gt;&amp;gt;&lt;/code&gt;
into a flat &lt;code&gt;Stream&amp;lt;Item&amp;gt;&lt;/code&gt;. The latter is what we eventually want to return,
so all we need now is to create this nested &lt;em&gt;stream of streams&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;How? Well, that&amp;#8217;s actually pretty&amp;nbsp;easy.&lt;/p&gt;
&lt;p&gt;We can already deserialize a &lt;code&gt;Vec&amp;lt;Item&amp;gt;&lt;/code&gt;
from the &lt;span class="caps"&gt;JSON&lt;/span&gt; response &amp;#8212; that&amp;#8217;s our item batch! &amp;#8212;
which is essentially an &lt;em&gt;iterable&lt;/em&gt; of &lt;code&gt;Item&lt;/code&gt;s&lt;sup id="fnref:5"&gt;&lt;a class="footnote-ref" href="#fn:5" rel="footnote"&gt;5&lt;/a&gt;&lt;/sup&gt;.
Another utility function from the &lt;code&gt;stream&lt;/code&gt; module,
namely &lt;a href="https://docs.rs/futures/*/futures/stream/fn.iter_ok.html"&gt;&lt;code&gt;stream::iter_ok&lt;/code&gt;&lt;/a&gt;,
can readily turn such iterable into a &amp;#8220;immediate&amp;#8221; &lt;code&gt;Stream&lt;/code&gt;.
Such &lt;code&gt;Stream&lt;/code&gt; won&amp;#8217;t be asynchronous at all
&amp;#8212; its items will have been ready from the very beginning &amp;#8212;
but it will still conform to the &lt;code&gt;Stream&lt;/code&gt; interface,
enabling it to be &lt;code&gt;flatten&lt;/code&gt;ed as we&amp;nbsp;request.&lt;/p&gt;
&lt;h4&gt;But wait! There is a&amp;nbsp;bug!&lt;/h4&gt;
&lt;p&gt;So in the end, is this the solution we&amp;#8217;re looking&amp;nbsp;for?&amp;#8230;&lt;/p&gt;
&lt;p&gt;Well, almost. First, here&amp;#8217;s the expected usage of the function we just&amp;nbsp;wrote:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;core&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;tokio_core&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;reactor&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Core&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;core&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;continuation_token&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// start from the beginning&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;core&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;continuation_token&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;for_each&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;println&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{:?}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}).&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;While this is more complicated than the plain &lt;code&gt;for&lt;/code&gt; loop in Python,
most of it is just Tokio boilerplate.
The notable part is the invocation of &lt;code&gt;items()&lt;/code&gt;,
where we pass &lt;code&gt;None&lt;/code&gt; as a continuation token to indicate that
we want the entire sequence, right from its&amp;nbsp;beginning.&lt;/p&gt;
&lt;p&gt;And since we&amp;#8217;re talking about fetching long sequences,
we would indeed expect a &lt;em&gt;lot&lt;/em&gt; of items.
So it is probably quite surprising to hear
that the stream we&amp;#8217;ve created here will be completely &lt;em&gt;empty&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&amp;#8230;What?&amp;nbsp;How?!&lt;/p&gt;
&lt;p&gt;If you look again at the source code of &lt;code&gt;items()&lt;/code&gt;,
the direct reason should be pretty easy to find.
The culprit lies in the &lt;code&gt;return None&lt;/code&gt; branch of the first &lt;code&gt;match&lt;/code&gt;.
If we don&amp;#8217;t pass &lt;code&gt;Some(continuation_token)&lt;/code&gt; as a parameter to &lt;code&gt;items()&lt;/code&gt;,
this branch will be hit &lt;em&gt;immediately&lt;/em&gt;,
terminating the stream before it had a chance to produce&amp;nbsp;anything.&lt;/p&gt;
&lt;p&gt;It may not be very clear how to fix this problem.
After all, the purpose of the &lt;code&gt;match&lt;/code&gt; was to detect the &lt;em&gt;end&lt;/em&gt; of the sequence,
but it apparently prevents us from &lt;em&gt;starting&lt;/em&gt; it in the first&amp;nbsp;place!&lt;/p&gt;
&lt;p&gt;Looking at the problem from another angle,
we can see we&amp;#8217;ve conflated two distinct states of our stream
&amp;#8212; &amp;#8220;before it has started&amp;#8221; and &amp;#8220;after it&amp;#8217;s ended&amp;#8221; &amp;#8212; into a single one (&amp;#8220;no continuation token&amp;#8221;).
Since we obviously don&amp;#8217;t want to make the &lt;code&gt;after&lt;/code&gt; parameter mandatory
&amp;#8212; users should be able to say &amp;#8220;Give me everything!&amp;#8221; &amp;#8212;
we need another way of telling those two states&amp;nbsp;apart.&lt;/p&gt;
&lt;p&gt;In terms of Rust types, it seems that &lt;code&gt;Option&amp;lt;String&amp;gt;&lt;/code&gt; is no longer sufficient
for encoding all possible states of our &lt;code&gt;Stream&lt;/code&gt;.
Although we could try to fix that in some ad-hoc way (e.g. by adding another &lt;code&gt;bool&lt;/code&gt; flag),
it feels cleaner to just define a new, dedicated type.
For one, this allows us to designate a name for each of the states in question,
improving the readability and maintainability of our&amp;nbsp;code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;enum&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Next&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;End&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that we can put this definition directly inside the &lt;code&gt;items()&lt;/code&gt; function,
without cluttering the module namespace.
All the relevant details of our &lt;code&gt;Stream&lt;/code&gt; are thus nicely contained
&lt;a href="https://play.rust-lang.org/?gist=42af60531f18509e181c4e30a46eb077&amp;amp;version=stable"&gt;within a single function&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;Handle&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;after&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Stream&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Item&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Item&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;// (definition of State enum can go here)&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Client&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;unfold&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;after&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;cont_token&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;match&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;opt_ct&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;opt_ct&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Next&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;End&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;match&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;cont_token&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{}?after={}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;URL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;URL&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;into&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Request&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Method&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Get&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;req&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;from_err&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;and_then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;concat2&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;from_err&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;and_then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_success&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="n"&gt;serde_json&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;from_slice&lt;/span&gt;&lt;span class="o"&gt;::&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;ItemsResponse&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                        &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map_err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;::&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;::&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HTTP status: {}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;status&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;into&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;move&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;items_resp&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;next_state&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;match&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;items_resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;continuation_token&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Next&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ct&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                    &lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;End&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;iter_ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;items_resp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;items&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;next_state&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatten&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Sure, there is a little more bookkeeping required now,
but at least all the items are being emitted by the &lt;code&gt;Stream&lt;/code&gt; as&amp;nbsp;intended.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;You can see the complete source in
&lt;a href="https://play.rust-lang.org/?gist=42af60531f18509e181c4e30a46eb077&amp;amp;version=stable"&gt;the playground here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Furthermore, the token doesn&amp;#8217;t have to come as part of the &lt;span class="caps"&gt;HTTP&lt;/span&gt; response body.
Some &lt;span class="caps"&gt;API&lt;/span&gt; providers (such as GitHub) may use the &lt;code&gt;Link:&lt;/code&gt; header
to point directly to the next &lt;span class="caps"&gt;URL&lt;/span&gt; to query.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;This example uses &amp;#8220;traditional&amp;#8221;, synchronous Python code.
However, it should be easy to convert it to the asynchronous equivalent
that works in Python 3.5 and above,
provided you can replace &lt;code&gt;requests&lt;/code&gt; with some async &lt;span class="caps"&gt;HTTP&lt;/span&gt; library.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;If you are curious whether other languages could express it better,
you can check the
&lt;a href="https://hackage.haskell.org/package/conduit-1.2.13/docs/Data-Conduit-List.html#v:unfold"&gt;&lt;code&gt;Data.Conduit.List.unfold&lt;/code&gt; function&lt;/a&gt;
from the Haskell&amp;#8217;s &lt;a href="https://hackage.haskell.org/package/conduit"&gt;&lt;code&gt;conduit&lt;/code&gt; package&lt;/a&gt;.
For most intents and purposes, it is their equivalent of &lt;code&gt;stream::unfold&lt;/code&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:4"&gt;
&lt;p&gt;Coincidentally, you can create iterators in the very same manner
through the &lt;a href="https://docs.rs/itertools/0.7.6/itertools/fn.unfold.html"&gt;&lt;code&gt;itertools::unfold&lt;/code&gt; function&lt;/a&gt;
from the &lt;a href="https://docs.rs/itertools/"&gt;&lt;code&gt;itertools&lt;/code&gt; crate&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:5"&gt;
&lt;p&gt;In more technical Rust terms, it means &lt;code&gt;Vec&lt;/code&gt; implements the &lt;code&gt;IntoIterator&lt;/code&gt; trait,
allowing anyone to get an &lt;code&gt;Iterator&lt;/code&gt; from it.&amp;#160;&lt;a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="Rust"></category><category term="Tokio"></category><category term="streams"></category><category term="HTTP"></category></entry><entry><title>Terminating a Stream inÂ Rust</title><link href="http://xion.io/post/code/rust-stream-terminate.html" rel="alternate"></link><updated>2017-12-16T21:17:00-08:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2017-12-16:post/code/rust-stream-terminate.html</id><summary type="html">&lt;p&gt;Here&amp;#8217;s a little trick that may be useful in dealing with
&lt;a href="https://docs.rs/futures/0.1.17/futures/stream/trait.Stream.html"&gt;asynchronous &lt;code&gt;Stream&lt;/code&gt;s&lt;/a&gt; in&amp;nbsp;Rust.&lt;/p&gt;
&lt;p&gt;When you consume a &lt;code&gt;Stream&lt;/code&gt; using
&lt;a href="https://docs.rs/futures/0.1.17/futures/stream/trait.Stream.html#method.for_each"&gt;the &lt;code&gt;for_each&lt;/code&gt; method&lt;/a&gt;,
its default behavior is to finish early should an error be produced by the&amp;nbsp;stream:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;futures&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;prelude&lt;/span&gt;&lt;span class="o"&gt;::*&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;futures&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;tokio_core&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;reactor&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Core&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;iter_result&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;vec&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;)]);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;fut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;for_each&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;println&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In more precise terms, it means that
&lt;a href="https://docs.rs/futures/0.1.17/futures/future/trait.Future.html"&gt;the &lt;code&gt;Future&lt;/code&gt;&lt;/a&gt;
returned by &lt;code&gt;for_each&lt;/code&gt; will resolve with the first error
from the underlying&amp;nbsp;stream:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// Prints 1, 2, and then panics with &amp;quot;false&amp;quot;.&lt;/span&gt;
&lt;span class="n"&gt;Core&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fut&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For most purposes, this is perfectly alright;
errors are generally meant to propagate, after&amp;nbsp;all.&lt;/p&gt;
&lt;p&gt;Certain &lt;em&gt;kinds&lt;/em&gt; of errors, however, are better off silenced.
Perhaps they are expected to pop up during normal program operation,
or maybe their occurrence should merely &lt;em&gt;affect&lt;/em&gt; program execution in a particular way,
and not halt it outright.
In a simple case like above, you can of course check what &lt;code&gt;for_each&lt;/code&gt; itself has returned,
but that doesn&amp;#8217;t scale to building larger &lt;code&gt;Stream&lt;/code&gt; pipelines.&lt;/p&gt;
&lt;p&gt;I encountered a situation like this myself when using
&lt;a href="https://docs.rs/crate/hubcaps/0.4.2"&gt;the &lt;em&gt;hubcaps&lt;/em&gt; library&lt;/a&gt;.
The code I was writing was meant to
&lt;a href="https://docs.rs/hubcaps/0.4.2/hubcaps/search/struct.SearchIssues.html#method.iter"&gt;search for GitHub issues&lt;/a&gt;
within a specific repository.
In GitHub &lt;span class="caps"&gt;API&lt;/span&gt;, this is accomplished by sending a search query like &lt;code&gt;repo:$OWNER/$NAME&lt;/code&gt;,
which may result in a rather obscure &lt;span class="caps"&gt;HTTP&lt;/span&gt; error (&lt;a href="https://httpstatuses.com/422"&gt;422 Unprocessable Entity&lt;/a&gt;)
if the given repository doesn&amp;#8217;t actually exist.
But I didn&amp;#8217;t care about this error; should it occur, I&amp;#8217;d simply return an empty stream,
because doing so was more convenient for the larger bit of logic that was consuming&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Unfortunately, the &lt;code&gt;Stream&lt;/code&gt; trait offers no interface that&amp;#8217;d target this use case.
There are only a few methods that even allow to look at errors mid-stream,
and even fewer that can end it prematurely.
On the flip side, at least we don&amp;#8217;t have to consider &lt;em&gt;too&lt;/em&gt; many combinations
when looking for the solution&amp;nbsp;;)&lt;/p&gt;
&lt;p&gt;Indeed, it seems there are only two &lt;code&gt;Stream&lt;/code&gt; methods that are worthy of our&amp;nbsp;attention:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://docs.rs/futures/0.1.17/futures/stream/trait.Stream.html#method.then"&gt;&lt;code&gt;Stream::then&lt;/code&gt;&lt;/a&gt;,
  because it allows for a closure to receive all stream values (items &lt;em&gt;and&lt;/em&gt;&amp;nbsp;errors)&lt;/li&gt;
&lt;li&gt;&lt;a href="https://docs.rs/futures/0.1.17/futures/stream/trait.Stream.html#method.take_while"&gt;&lt;code&gt;Stream::take_while&lt;/code&gt;&lt;/a&gt;,
  because it accepts a closure that can end the stream early (but only based on items, not&amp;nbsp;errors)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Combining them both, we arrive at the following&amp;nbsp;recipe:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Inside a &lt;code&gt;.then&lt;/code&gt; closure, look for &lt;code&gt;Err&lt;/code&gt;ors that you consider non-fatal
  and replace them with a special item value.
  The natural choice for such a value is &lt;code&gt;None&lt;/code&gt;.
  As a side effect, this forces us to convert the regular (&amp;#8220;successful&amp;#8221;) &lt;code&gt;item&lt;/code&gt;s into &lt;code&gt;Some(item)&lt;/code&gt;,
  effectively transforming a &lt;code&gt;Stream&amp;lt;Item=T&amp;gt;&lt;/code&gt; into &lt;code&gt;Stream&amp;lt;Item=Option&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Looks for the special value (i.e. &lt;code&gt;None&lt;/code&gt;) in the &lt;code&gt;.take_while&lt;/code&gt; closure
  and terminate the stream when it&amp;#8217;s been&amp;nbsp;found.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Finally, convert the wrapped items back into their original form using &lt;code&gt;.map&lt;/code&gt;,
  thus giving us back a &lt;code&gt;Stream&lt;/code&gt; of &lt;code&gt;T&lt;/code&gt;&lt;span class="quo"&gt;&amp;#8216;&lt;/span&gt;s.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Applying this technique to our initial example,
we get something that looks like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;iter_result&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;vec&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;)])&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;match&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// no-op passthrough of items&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;false&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;// non-fatal error, terminate the stream&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="c1"&gt;// no-op passthrough of other errors&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;take_while&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;future&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_some&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If we now try to consume this stream like&amp;nbsp;before:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Core&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;for_each&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;println&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;{}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(())&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;it will still end after the first two items,
but without producing any errors&amp;nbsp;afterwards.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;For a more reusable version of the trick, you can check
&lt;a href="https://play.rust-lang.org/?gist=1bf2199460258be6674c9c7a7a157f50&amp;amp;version=stable"&gt;this gist&lt;/a&gt;;
it adds a &lt;code&gt;Stream::take_while_err&lt;/code&gt; method through an &lt;a href="http://xion.io/post/code/rust-extension-traits.html"&gt;extension trait&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This isn&amp;#8217;t a perfect solution, however, because it requires &lt;code&gt;Box&lt;/code&gt;ing even on nightly Rust&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.
We can fix that by introducing a dedicated &lt;code&gt;TakeWhileErr&lt;/code&gt; stream type,
similarly to what native &lt;code&gt;Stream&lt;/code&gt; methods do.
I leave that as an exercise for the reader&amp;nbsp;;-)&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;This is due to a limitation in &lt;a href="https://github.com/rust-lang/rust/issues/34511"&gt;the &lt;code&gt;impl Trait&lt;/code&gt; feature&lt;/a&gt;
which prevents it from being used as a return type of trait methods.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="Rust"></category><category term="streams"></category><category term="Tokio"></category><category term="async"></category></entry><entry><title>Recap of the gishtÂ project</title><link href="http://xion.io/post/programming/gisht-recap.html" rel="alternate"></link><updated>2017-11-24T17:52:00+00:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2017-11-24:post/programming/gisht-recap.html</id><summary type="html">&lt;p&gt;In this post, I want to discuss some of the experiences I had with a project
that I recently finished, &lt;a href="https://github.com/Xion/gisht"&gt;&lt;em&gt;gisht&lt;/em&gt;&lt;/a&gt;.
By &amp;#8220;finished&amp;#8221; I mean that I don&amp;#8217;t anticipate developing any new major features for it,
though smaller things, bug fixes, or non-code stuff, is of course still very&amp;nbsp;possible.&lt;/p&gt;
&lt;p&gt;I&amp;#8217;m thinking this is as much &amp;#8220;done&amp;#8221; as most software projects can ever hope to be.
Thus, it is probably the best time for a recap / summary / postmortem / etc. &amp;#8212;
something to recount the lessons learned, and assess the choices&amp;nbsp;made.&lt;/p&gt;
&lt;h4&gt;Some&amp;nbsp;context&lt;/h4&gt;
&lt;p&gt;The original purpose of &lt;em&gt;gisht&lt;/em&gt; was to facilitate download &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; execution of GitHub gists
straight from the command&amp;nbsp;line:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;gisht Xion/git-outgoing  &lt;span class="c"&gt;# run the https://gist.github.com/Xion/git-outgoing gist&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;I initially wrote &lt;a href="https://github.com/Xion/gisht.py"&gt;its first version in Python&lt;/a&gt;
because I&amp;#8217;ve accumulated a sizable number of small &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; useful scripts
(for Git, Unix, Python, etc.) which were all posted as gists.
Sure, I could download them manually to &lt;code&gt;~/bin&lt;/code&gt; every time I used a new machine
but that&amp;#8217;s rather cumbersome, and I&amp;#8217;m quite&amp;nbsp;lazy.&lt;/p&gt;
&lt;p&gt;Well, lazy &lt;em&gt;and&lt;/em&gt; impatient :)
I noticed pretty fast that the speed tax of Python
is basically unacceptable for a program like &lt;em&gt;gisht&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;What I&amp;#8217;m referring to here is not the speed of code execution, however,
but only the &lt;em&gt;startup time&lt;/em&gt; of Python interpreter.
Irrespective of the machine, operating system, or language version,
it doesn&amp;#8217;t seem to go lower than about one hundred milliseconds;
empirically, it&amp;#8217;s often 2 or 3 times higher than that.
For the common case of finding a cached gist (no downloads)
and doing a simple &lt;code&gt;fork&lt;/code&gt;+&lt;code&gt;exec&lt;/code&gt;,
this startup time was very noticeable and extremely jarring.
It also precluded some more sophisticated uses for &lt;em&gt;gisht&lt;/em&gt;,
like putting its invocation into the shell&amp;#8217;s &lt;code&gt;$PROMPT&lt;/code&gt;&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h4&gt;Speed:&amp;nbsp;delivered&lt;/h4&gt;
&lt;p&gt;And so the obvious solution emerged:
let&amp;#8217;s &lt;a href="https://transitiontech.ca/random/RIIR"&gt;rewrite it in Rust&lt;/a&gt;!&amp;#8230;&lt;/p&gt;
&lt;p&gt;Because if I&amp;#8217;m executing code straight from the internet,
I should at least do it in a &lt;em&gt;safe&lt;/em&gt;&amp;nbsp;language.&lt;/p&gt;
&lt;p&gt;But jokes aside, it is obvious that a language compiling to native code
is likely a good pick if you want to optimize for startup speed.
So while the choice of Rust was in large part educational
(&lt;em&gt;gisht&lt;/em&gt; was one of my first projects to be written in it),
it definitely hasn&amp;#8217;t disappointed&amp;nbsp;there.&lt;/p&gt;
&lt;p&gt;Even without any intentional optimization efforts,
the app still runs &lt;em&gt;instantaneously&lt;/em&gt;.
I tried to take some measurements using the &lt;code&gt;time&lt;/code&gt; command,
but it never ticked into more than 0.001s.
Perceptively, it is at least on par with &lt;code&gt;git&lt;/code&gt;,
so that&amp;#8217;s acceptable for me&amp;nbsp;:)&lt;/p&gt;
&lt;h4&gt;Can&amp;#8217;t segfault if your code doesn&amp;#8217;t&amp;nbsp;build&lt;/h4&gt;
&lt;p&gt;Achieving the performance objective wouldn&amp;#8217;t do us much good, however,
if the road to get there involved excessive penalties on productivity.
Such negative impact could manifest in many ways,
including troublesome debugging due to a tricky runtime&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;,
or difficulty in getting the code to compile in the first&amp;nbsp;place.&lt;/p&gt;
&lt;p&gt;If you had even a passing contact with Rust,
you&amp;#8217;d expect the latter to be much more likely than the&amp;nbsp;former.&lt;/p&gt;
&lt;p&gt;Indeed, Rust&amp;#8217;s very design eschews runtime flexibility to a ridiculous degree
(in its &amp;#8220;safe&amp;#8221; mode, at least),
while also forcing you to absorb subtle &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; complex ideas
to even get your code past the compiler.
The reward is increased likelihood your program will behave as intended &amp;#8212;
although it&amp;#8217;s definitely not on the level of &amp;#8220;if it compiles, it works&amp;#8221;
that can be offered by Haskell or&amp;nbsp;Idris.&lt;/p&gt;
&lt;p&gt;But since &lt;em&gt;gisht&lt;/em&gt; is hardly mission critical,
I didn&amp;#8217;t actually care too much about this increased reliability.
I don&amp;#8217;t think it&amp;#8217;s likely that Rust would buy me much over something like modern C++.
And if I were to &lt;em&gt;really&lt;/em&gt; do some kind of cost-benefit analysis of several languages
&amp;#8212; rather than going with Rust simply to learn it better &amp;#8212;
then it would be hard to justify it over something like&amp;nbsp;Go.&lt;/p&gt;
&lt;h4&gt;It&amp;nbsp;scales&lt;/h4&gt;
&lt;p&gt;So the real question is: has Rust &lt;em&gt;not hampered&lt;/em&gt; my productivity too much?
Having the benefit of hindsight,
I&amp;#8217;m happy to say that the trade-off was definitely acceptable&amp;nbsp;:)&lt;/p&gt;
&lt;p&gt;One thing I was particularly satisfied with was the language&amp;#8217;s &lt;em&gt;scalability&lt;/em&gt;.
What I mean here is the ability to adapt as the project grows,
but also to start quickly and remain nimble
while the codebase is still pretty&amp;nbsp;small.&lt;/p&gt;
&lt;p&gt;Many languages (most, perhaps) are naturally tailored towards the large end,
doing their best to make it more bearable to work with big codebases.
In turn, they often forget about helping projects take off in the first place.
Between complicated build systems and dependency managers (Java),
or a virtual lack of either (C++),
it can be really hard to get going in a &amp;#8220;serious&amp;#8221; language like&amp;nbsp;this.&lt;/p&gt;
&lt;p&gt;On the other hand, languages like Python make it very easy to start up
and achieve relatively impressive results.
Some people, however, report having encountered problems
once the code evolves past certain size.
While I&amp;#8217;m actually
&lt;a href="http://xion.io/post/programming/long-live-dynamic-languages.html"&gt;very unsympathetic&lt;/a&gt; to those claims,
I realize perception plays a significant role here,
making those anecdotal experiences into a sort of self-fulfilling&amp;nbsp;prophecy.&lt;/p&gt;
&lt;p&gt;This perception problem should almost certainly spare Rust,
as it&amp;#8217;s a natively compiled and statically typed language,
with a respectable type system to boot.
There is also &lt;a href="https://servo.org/"&gt;some evidence&lt;/a&gt;
that the language works well in large projects already.
So the only question that we might want to ask is:
how easy it is to actually &lt;em&gt;start&lt;/em&gt; a project in Rust,
and carry it towards some kind of &lt;abbr title="Minimum Viable Product"&gt;&lt;span class="caps"&gt;MVP&lt;/span&gt;&lt;/abbr&gt;?&lt;/p&gt;
&lt;p&gt;Based on my experiences with &lt;em&gt;gisht&lt;/em&gt;,
I can say that it is, in fact, quite easy.
Thanks mostly to the impressive Swiss army knife of &lt;code&gt;cargo&lt;/code&gt;
&amp;#8212; acting as both package manager and a rudimentary build system &amp;#8212;
it was almost Python-trivial to cook a &amp;#8220;Hello World&amp;#8221; program
that does something tangible, like
&lt;a href="https://github.com/Xion/gisht/blob/de1be876784d671dd84618c3a15d0836f9fd5697/src/main.rs"&gt;talk to a &lt;span class="caps"&gt;JSON&lt;/span&gt; &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt;.
From there, it only took a few coding sessions to grow it
into a &lt;a href="https://github.com/Xion/gisht/tree/5c156cb"&gt;functioning prototype&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;Abstractions&amp;nbsp;galore&lt;/h4&gt;
&lt;p&gt;As part of rewriting &lt;em&gt;gisht&lt;/em&gt; from Python to Rust,
I also wanted to fix some longstanding issues that limited its&amp;nbsp;capabilities.&lt;/p&gt;
&lt;p&gt;The most important one was the hopeless coupling to GitHub
and their particular flavor of gists.
Sure, this is where the project even got its name from,
but people use a dozen of different services to share code snippets
and it should very possible to support them&amp;nbsp;all.&lt;/p&gt;
&lt;p&gt;Here&amp;#8217;s where it became necessary to utilize
the abstraction capabilities that Rust has to offer.
It was somewhat obvious to
&lt;a href="https://github.com/Xion/gisht/blob/3fc443dc9986612fd46b4311ca2ecbc613a15cf9/src/gist.rs#L16"&gt;define a &lt;code&gt;Host&lt;/code&gt; trait&lt;/a&gt;
but of course its exact form had to be
&lt;a href="https://github.com/Xion/gisht/commit/26746dfc2eac68b67753f71148eb9897a861914e#diff-9d0a9c0911fa012f0fcf8ca56b43f8c5"&gt;shaped&lt;/a&gt;
over &lt;a href="https://github.com/Xion/gisht/commit/1e54ad05480b42089977171f10d4727beca5f835#diff-9d0a9c0911fa012f0fcf8ca56b43f8c5"&gt;numerous iterations&lt;/a&gt;.
Along the way, it even turned out that &lt;code&gt;Result&amp;lt;Option&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt; and &lt;code&gt;Option&amp;lt;Result&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;
are sometimes &lt;a href="https://github.com/Xion/gisht/blob/d9c30e69d58b2a4e5608e6c8a1aa6392133b490f/src/hosts/mod.rs#L44"&gt;both necessary&lt;/a&gt;
as return types&amp;nbsp;:)&lt;/p&gt;
&lt;p&gt;Besides cleaner architecture,
another neat thing about an explicit abstraction is
the ability to slice a concept into smaller pieces &amp;#8212;
and then put &lt;em&gt;some of them&lt;/em&gt; back together.
While the &lt;code&gt;Host&lt;/code&gt; trait could support a very diverse set of gist services and &lt;em&gt;pastebins&lt;/em&gt;,
many of them turned out to be just a slight variation of one central theme.
Because of this similarity, it was possible to introduce
a single &lt;a href="https://github.com/Xion/gisht/blob/d2e78b1f5ee4616b1d5eb7067c3c5dd0ce9e2fe4/src/hosts/simple.rs#L26"&gt;&lt;code&gt;Basic&lt;/code&gt; implementation&lt;/a&gt;
which handles multiple services through varying sets of &lt;span class="caps"&gt;URL&lt;/span&gt;&amp;nbsp;patterns.&lt;/p&gt;
&lt;p&gt;Devices like these aren&amp;#8217;t of course specific to Rust:
interfaces (traits) and classes are a staple of &lt;span class="caps"&gt;OO&lt;/span&gt; languages in general.
But some other techniques were more idiomatic;
the concept of &lt;a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html"&gt;iterators&lt;/a&gt;, for example,
is flexible enough to accommodate
&lt;a href="https://github.com/Xion/gisht/blob/4fa347c6197190b0f6c68dd548efc28287a5859f/src/hosts/github.rs#L354"&gt;looping over GitHub user&amp;#8217;s gists&lt;/a&gt;,
even as they read directly from &lt;span class="caps"&gt;HTTP&lt;/span&gt;&amp;nbsp;responses.&lt;/p&gt;
&lt;h4&gt;Hacking&amp;nbsp;time&lt;/h4&gt;
&lt;p&gt;Not everything was sunshine and rainbows,&amp;nbsp;though.&lt;/p&gt;
&lt;p&gt;Take &lt;em&gt;clap&lt;/em&gt;, for example.
It&amp;#8217;s mostly a very good crate for parsing command line arguments,
but it couldn&amp;#8217;t &lt;em&gt;quite&lt;/em&gt; cope with the unusual requirements that &lt;em&gt;gisht&lt;/em&gt; had.
To make &lt;code&gt;gisht Foo/bar&lt;/code&gt; work alongside &lt;code&gt;gisht run Foo/bar&lt;/code&gt;,
it was necessary to
&lt;a href="https://github.com/Xion/gisht/commit/0eff00e31f94f3856558ebb1f6655a9e6fc50ca6#diff-7397f82f682a49eb62e2b056118124d0"&gt;analyze &lt;code&gt;argv&lt;/code&gt;&lt;/a&gt;
before even handing it over to &lt;code&gt;clap&lt;/code&gt;.
This turned out to be
&lt;a href="https://github.com/Xion/gisht/commit/e7ab06a01d4675947965ec82fc6f3ec5a2517c89#diff-7397f82f682a49eb62e2b056118124d0"&gt;surprisingly tricky&lt;/a&gt;
to get right.
Like,
&lt;a href="https://github.com/Xion/gisht/commit/69e8aad4a1743beb57184dc38150ef02b306a0a1#diff-7397f82f682a49eb62e2b056118124d0"&gt;really&lt;/a&gt;
tricky, with
&lt;a href="https://github.com/Xion/gisht/commit/acadcfa0a97fe52584fbf8198541baa8733cb0a5#diff-7397f82f682a49eb62e2b056118124d0R58"&gt;edges cases&lt;/a&gt;
and
&lt;a href="https://github.com/Xion/gisht/commit/a9eb599168f5b6821aefa46dde0b0a89a41cd4e6#diff-7397f82f682a49eb62e2b056118124d0R562"&gt;stuff&lt;/a&gt;.
But as it is often the case in software,
the answer turned out to be yet another layer of indirection plus
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/args.rs#L457-L578"&gt;a copious amount of tests&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In another instance, however, a direct library support was&amp;nbsp;crucial.&lt;/p&gt;
&lt;p&gt;It so happened that &lt;em&gt;hyper&lt;/em&gt;, the crate I&amp;#8217;ve been using for &lt;span class="caps"&gt;HTTP&lt;/span&gt; requests,
didn&amp;#8217;t handle the &lt;code&gt;Link:&lt;/code&gt; response header out of the box&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;.
This was a stumbling block that prevented the gist iterator (mentioned earlier)
from correctly handling pagination in the responses from GitHub &lt;span class="caps"&gt;API&lt;/span&gt;.
Thankfully, having &lt;a href="https://docs.rs/hyper/0.11.7/hyper/header/trait.Header.html"&gt;the &lt;code&gt;Header&lt;/code&gt; abstraction&lt;/a&gt; in &lt;em&gt;hyper&lt;/em&gt;
meant it was possible to add the missing support in
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/ext/hyper.rs"&gt;a relatively straighforward manner&lt;/a&gt;.
Yes, it&amp;#8217;s &lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/ext/hyper.rs#L23"&gt;not a universal implementation&lt;/a&gt;
that&amp;#8217;d be suitable for &lt;em&gt;every&lt;/em&gt; &lt;span class="caps"&gt;HTTP&lt;/span&gt; client,
but it does the job for &lt;em&gt;gisht&lt;/em&gt; just&amp;nbsp;fine.&lt;/p&gt;
&lt;h4&gt;Test-Reluctant&amp;nbsp;Development&lt;/h4&gt;
&lt;p&gt;And so the program kept growing steadily over the months,
most notably through
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/mod.rs#L101"&gt;more and more gist hosts&lt;/a&gt;
it could now&amp;nbsp;support.&lt;/p&gt;
&lt;p&gt;Eventually, some of them would fall into a sort of twilight zone.
They weren&amp;#8217;t as complicated as GitHub to warrant writing a completely new &lt;code&gt;Host&lt;/code&gt; instance,
but they also couldn&amp;#8217;t be handled via
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/common/basic.rs#L28"&gt;the &lt;code&gt;Basic&lt;/code&gt; structure&lt;/a&gt; alone.
A good example would be &lt;a href="http://sprunge.us/"&gt;sprunge.us&lt;/a&gt;:
mostly an ordinary pastebin,
except for its optional syntax highlighting
which may add some &amp;#8220;junk&amp;#8221; to the otherwise regular&amp;nbsp;URLs.&lt;/p&gt;
&lt;p&gt;In order to handle those odd cases,
I went for a classic wrapper/decorator pattern which, in its essence,
boils down to something like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;pub&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Basic&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;impl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;pub&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Basic&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ID&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;sprunge.us&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                                  &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;http://sprunge.us/${id}&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;...)}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;impl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;// override &amp;amp; wrap methods that require custom logic:&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;resolve_url&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="kt"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="nb"&gt;Result&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Gist&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;url_obj&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Url&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;url_obj&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;None&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;resolve_url&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url_obj&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;as_str&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;// passthrough to the `Basic` struct for others:&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;fetch_gist&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;gist&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;Gist&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;mode&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;FetchMode&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="nb"&gt;Result&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fetch_gist&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gist&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;mode&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;// (etc.)&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Despite the noticeable boilerplate of a few pass-through methods,
I was pretty happy with this solution, at least initially.
After a few more unusual hosts, however,
it became cumbersome to fix all the edge cases
by looking only at the final output of the inner &lt;code&gt;Basic&lt;/code&gt; implementation.
The code was evidently asking for some &lt;em&gt;tests&lt;/em&gt;,
if only to check how the inner structure is being&amp;nbsp;called.&lt;/p&gt;
&lt;p&gt;Shouldn&amp;#8217;t be too hard, right?&amp;#8230; Yeah, that&amp;#8217;s what I thought,&amp;nbsp;too.&lt;/p&gt;
&lt;p&gt;The reality, unfortunately, fell very short of those expectations.
Stubs, mocks, fakes &amp;#8212;
&lt;a href="https://testing.googleblog.com/2013/07/testing-on-toilet-know-your-test-doubles.html"&gt;&lt;em&gt;test doubles&lt;/em&gt;&lt;/a&gt;
in general &amp;#8212;
are a dark and forgotten corner of Rust
that almost no one seems to pay any attention to.
Absent a proper library support &amp;#8212; much less a language one &amp;#8212;
the only way forward was to roll up my sleeves
and implement
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/testing/inmemory_host.rs"&gt;a fake &lt;code&gt;Host&lt;/code&gt;&lt;/a&gt;
from&amp;nbsp;scratch.&lt;/p&gt;
&lt;p&gt;But that was just the beginning.
How do you seamlessly inject this fake implementation into the wrapper
so that it replaces the &lt;code&gt;Basic&lt;/code&gt; struct for testing?
If you are not careful and go for the &amp;#8220;obvious&amp;#8221; solution &amp;#8212; a trait&amp;nbsp;object:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;pub&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Box&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Host&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;you&amp;#8217;ll soon realize that you need not just a &lt;code&gt;Box&lt;/code&gt;, but at least an &lt;code&gt;Rc&lt;/code&gt; (or maybe even &lt;code&gt;Arc&lt;/code&gt;).
Without this kind of shared ownership,
you&amp;#8217;ll lose your chance to interrogate the test double once you hand it over to the wrapper.
This, in turn, will heavily limit your ability to write effective&amp;nbsp;tests.&lt;/p&gt;
&lt;p&gt;What&amp;#8217;s the non-obvious approach, then?
The full rationale would probably warrant a separate post,
but the working recipe looks more or less like&amp;nbsp;this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;First, &lt;em&gt;parametrize&lt;/em&gt; the wrapper with its inner type:
  &lt;code&gt;pub struct Sprunge&amp;lt;T: Host&amp;gt; { inner: T }&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Put that in an internal module with the correct visibility&amp;nbsp;setup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;mod&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;internal&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;pub&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Host&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;pub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;super&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;inner&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Make the regular (&amp;#8220;production&amp;#8221;) version of the wrapper into an &lt;em&gt;alias&lt;/em&gt;,
  giving it the type parameter that you&amp;#8217;ve been using directly&lt;sup id="fnref:4"&gt;&lt;a class="footnote-ref" href="#fn:4" rel="footnote"&gt;4&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;pub&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Sprunge&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Basic&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Change the &lt;code&gt;new&lt;/code&gt; constructor to instantiate the &lt;code&gt;internal&lt;/code&gt; type.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;In tests, create the wrapper with a fake &lt;code&gt;inner&lt;/code&gt; object&amp;nbsp;inside.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As you can see in
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/sprunge.rs"&gt;the real example&lt;/a&gt;,
this convoluted technique removes the need for any pointer indirection.
It also permits you to
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/sprunge.rs#L152"&gt;access the out-of-band interface&lt;/a&gt;
that a fake object would normally&amp;nbsp;expose.&lt;/p&gt;
&lt;p&gt;It&amp;#8217;s a shame, though, that so much work is required for something
that should be very simple.
As it appears, testing is still a neglected topic in&amp;nbsp;Rust.&lt;/p&gt;
&lt;h4&gt;Packing&amp;nbsp;up&lt;/h4&gt;
&lt;p&gt;It wasn&amp;#8217;t just Rust that played a notable role in the development of &lt;em&gt;gisht&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Pretty soon after getting the app to a presentable state,
it became clear that a mere &lt;code&gt;cargo build&lt;/code&gt; won&amp;#8217;t do everything
that&amp;#8217;s necessary to carry out a complete build.
It &lt;em&gt;could&lt;/em&gt; do more, admittedly,
if I had the foresight to explore &lt;a href="http://doc.crates.io/build-script.html"&gt;Cargo build scripts&lt;/a&gt;
a little more thoroughly.
But overall, I don&amp;#8217;t regret dropping back to my trusty ol&amp;#8217; pick:&amp;nbsp;Python.&lt;/p&gt;
&lt;p&gt;Like in a few previous projects, I used the &lt;a href="http://pyinvoke.org"&gt;Invoke task runner&lt;/a&gt;
for both the crucial and the auxiliary automation tasks.
It is a relatively powerful tool
&amp;#8212; and probably the best in its class in Python that I know of &amp;#8212;
though it can be a bit capricious if you want to
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/release/__init__.py#L69"&gt;really fine-tune it&lt;/a&gt;.
But it does make it much easier to organize your automation code,
to reuse it between tasks, and to (ahem) &lt;em&gt;invoke&lt;/em&gt; those tasks in a convenient&amp;nbsp;manner.&lt;/p&gt;
&lt;p&gt;In any case, it certainly beats a collection of disconnected Bash scripts&amp;nbsp;;)&lt;/p&gt;
&lt;p&gt;What have I automated in this way, you may ask?
Well, a couple of small things; those&amp;nbsp;include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;embedding of the current Git commit hash into the binary,
to help identify the exact revision in the logs of any potential bug reports&lt;sup id="fnref:5"&gt;&lt;a class="footnote-ref" href="#fn:5" rel="footnote"&gt;5&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;after a successful build,
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/build.py#L40"&gt;replacing&lt;/a&gt;
the &lt;em&gt;Usage&lt;/em&gt; section in &lt;em&gt;&lt;span class="caps"&gt;README&lt;/span&gt;&lt;/em&gt; with the program&amp;#8217;s &lt;code&gt;--help&lt;/code&gt; output&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;generating &lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/build.py#L96"&gt;completion scripts&lt;/a&gt;
for popular shells by invoking the binary with a magic hidden flag (courtesy of &lt;em&gt;clap&lt;/em&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Undoubtedly the biggest task that I relegated to Python/Invoke,
was the preparation of
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/release/__init__.py"&gt;&lt;em&gt;release packages&lt;/em&gt;&lt;/a&gt;.
When it comes to the various Linuxes (currently Debian and Red Hat flavors),
this wasn&amp;#8217;t particularly complicated.
Major thanks are due to the amazing &lt;a href="https://github.com/jordansissel/fpm"&gt;&lt;em&gt;fpm&lt;/em&gt; tool&lt;/a&gt; here,
which I recommend to anyone who needs to package their software in a distro-compatible&amp;nbsp;manner.&lt;/p&gt;
&lt;p&gt;Homebrew, however &amp;#8212; or more precisely, &lt;span class="caps"&gt;OS&lt;/span&gt; X itself &amp;#8212; was quite a different story.
Many, &lt;a href="https://github.com/Xion/gisht/commits/a5423a63d10221c50faa1cb30a999a85286853a1"&gt;many&lt;/a&gt;
failed attempts were needed to even get it to build on &lt;a href="https://travis-ci.org"&gt;Travis&lt;/a&gt;,
and the additional dependency on Python was
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/ci/travis/before_install-osx.sh#L15"&gt;partially to blame&lt;/a&gt;.
To be fair, however, most of the pain was exclusively due to OpenSSL;
getting that thing to build is always &lt;a href="https://github.com/sfackler/rust-openssl/issues/255"&gt;loads of &amp;#8220;fun&amp;#8221;&lt;/a&gt;,
especially in such an opaque and poorly debuggable environment as&amp;nbsp;Travis.&lt;/p&gt;
&lt;h4&gt;The&amp;nbsp;wrap&lt;/h4&gt;
&lt;p&gt;There&amp;#8217;s probably a lot of minor things and tidbits I could&amp;#8217;ve mentioned along the way,
but the story so far has most likely covered all the important topics.
Let&amp;#8217;s wrap it up then, and highlight some interesting points in the classic &lt;em&gt;Yay/Meh/Nay&lt;/em&gt;&amp;nbsp;manner.&lt;/p&gt;
&lt;h5&gt;Yay&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;It was definitely a good choice to rewrite &lt;em&gt;gisht&lt;/em&gt; specifically in Rust.
Besides all the advantages I&amp;#8217;ve mentioned already,
it is also worth noting that the language went through about 10 minor version bumps
while I was working on this project.
Of all those new releases,
I don&amp;#8217;t recall a single one that would introduce a breaking&amp;nbsp;change.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Most of the Rust ecosystem (third-party libraries) was a joy to use,
and very easy to get started with.
Honorable mention goes to &lt;em&gt;serde_json&lt;/em&gt; and how easy it was to
&lt;a href="https://github.com/Xion/gisht/commit/a0655a6a5b86c05df5665e3bc7f1512f2476c9e4"&gt;transition the code&lt;/a&gt;
from &lt;em&gt;rustc_serialize&lt;/em&gt; that I had used at&amp;nbsp;first.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;With a possible exception of sucking in node.js as a huge dependency of your project
and using Grunt, there is probably no better way of writing automation &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; support code than Python.
There may eventually be some Rust-based task runners that could try to compete,
but I&amp;#8217;m not very convinced about using a compiled language for this purpose
(and especially one that takes so long to&amp;nbsp;build).&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5&gt;Meh&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;While &lt;a href="https://docs.rs/clap"&gt;the &lt;em&gt;clap&lt;/em&gt; crate&lt;/a&gt; is quite configurable and pretty straightforward to use,
it does lack at least &lt;a href="https://github.com/kbknapp/clap-rs/issues/568"&gt;one feature&lt;/a&gt;
that&amp;#8217;d be very nice for &lt;em&gt;gisht&lt;/em&gt;.
Additionally, working with raw &lt;em&gt;clap&lt;/em&gt; is often a little tedious,
as it doesn&amp;#8217;t assist you in translating parsed flags into your own configuration types,
and thus requires
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/args.rs#L138-L182"&gt;shuffling those bits&lt;/a&gt;
manually&lt;sup id="fnref:6"&gt;&lt;a class="footnote-ref" href="#fn:6" rel="footnote"&gt;6&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Being a &lt;em&gt;defacto&lt;/em&gt; standard for continuous integration in open-source projects,
&lt;a href="https://travis-ci.org"&gt;Travis &lt;span class="caps"&gt;CI&lt;/span&gt;&lt;/a&gt; could be a &lt;em&gt;little&lt;/em&gt; less finicky.
In almost every project I decide to use it for,
I end up with about half a dozen commits
that frantically try to fix silly configuration issues,
all before even a simple &lt;em&gt;.travis.yml&lt;/em&gt; works as intended.
Providing a way to test &lt;span class="caps"&gt;CI&lt;/span&gt; builds locally would be an obvious way to avoid this&amp;nbsp;churn.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5&gt;Nay&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Testing in Rust is such a weird animal.
On one hand, there is a first-class, out-of-the-box support for unit tests
(and even integration tests) right in the toolchain.
On the other hand, the relevant parts of the ecosystem are immature or lacking,
as evidenced by the dreary story of mocking and stubbing.
It&amp;#8217;s no surprise that there is a long way to catch up to languages with the strongest testing culture
(Java and C#/.&lt;span class="caps"&gt;NET&lt;/span&gt;&lt;sup id="fnref:7"&gt;&lt;a class="footnote-ref" href="#fn:7" rel="footnote"&gt;7&lt;/a&gt;&lt;/sup&gt;), but it&amp;#8217;s disappointing to see Rust outclassed
&lt;a href="https://github.com/google/googletest"&gt;even by C++&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Getting anything to build reliably on &lt;span class="caps"&gt;OSX&lt;/span&gt; in a &lt;span class="caps"&gt;CI&lt;/span&gt; environment is already a tall order.
But if it involves things as OpenSSL, then it quickly goes from bad to terrible.
I&amp;#8217;m really not amused anymore how this &amp;#8220;Just Works&amp;#8221; system often turns out to hardly work at&amp;nbsp;all.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Since I don&amp;#8217;t want to end on such a negative note,
I feel compelled to state the obvious fact: every technology choice is a trade-off.
In case of this project, however, the drawbacks were &lt;em&gt;heavily&lt;/em&gt; outweighed by the&amp;nbsp;benefits.&lt;/p&gt;
&lt;p&gt;For this reason, I can definitely recommend the software stack I&amp;#8217;ve just described
to anyone developing non-trivial, cross-platform command line&amp;nbsp;tools.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;This is not an isolated complaint, by the way,
as the interpreter startup time has recently emerged as &lt;a href="https://lwn.net/Articles/730915/"&gt;an important issue&lt;/a&gt;
to many developers of the Python language.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Which may also include a practical &lt;em&gt;lack&lt;/em&gt; thereof.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;It does handle it &lt;a href="https://docs.rs/hyper/0.11.7/hyper/header/struct.Link.html"&gt;now&lt;/a&gt;, fortunately.&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:4"&gt;
&lt;p&gt;Observant readers may notice that we&amp;#8217;re exposing a technically private type (&lt;code&gt;internal::Sprunge&lt;/code&gt;)
through a publicly visible type alias. If that type was &lt;em&gt;actually&lt;/em&gt; private,
this would trigger a compiler warning
which is slated to become &lt;a href="https://github.com/rust-lang/rust/issues/34537"&gt;a hard error&lt;/a&gt;
at some point in the future. But, amusingly, we can fool the compiler by making it a
&lt;em&gt;public type&lt;/em&gt; inside a &lt;em&gt;private module&lt;/em&gt;, which is exactly what we&amp;#8217;re doing here.&amp;#160;&lt;a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:5"&gt;
&lt;p&gt;This has since been rewritten and is now done in
&lt;a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/build.rs"&gt;&lt;em&gt;build.rs&lt;/em&gt;&lt;/a&gt;
&amp;#8212; but that&amp;#8217;s only because I implemented
&lt;a href="https://github.com/rust-lang/cargo/pull/3929"&gt;the relevant Cargo feature&lt;/a&gt; myself :)&amp;#160;&lt;a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:6"&gt;
&lt;p&gt;For an alternative approach that doesn&amp;#8217;t seem to have this problem,
check &lt;a href="https://docs.rs/structopt_derive"&gt;the &lt;em&gt;structopt&lt;/em&gt; crate&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:7"&gt;
&lt;p&gt;Dynamically typed languages, due to their rich runtime,
are basically a class of their own when it comes to testing ease,
so it wouldn&amp;#8217;t really be fair to hold them up for comparison.&amp;#160;&lt;a class="footnote-backref" href="#fnref:7" rev="footnote" title="Jump back to footnote 7 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="Rust"></category><category term="gisht"></category><category term="CLI"></category><category term="GitHub"></category><category term="Python"></category><category term="testing"></category></entry><entry><title>Currying and APIÂ design</title><link href="http://xion.io/post/programming/currying-api-design.html" rel="alternate"></link><updated>2017-11-12T14:07:00+00:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2017-11-12:post/programming/currying-api-design.html</id><summary type="html">&lt;p&gt;In functional programming, &lt;em&gt;currying&lt;/em&gt; is one of the concepts
that contribute greatly to its expressive power.
Its importance could be compared to something as ubiquitous
as chaining method calls (&lt;code&gt;foo.bar().baz()&lt;/code&gt;) in imperative, object-oriented&amp;nbsp;languages.&lt;/p&gt;
&lt;p&gt;Although a simple idea on the surface,
it has significant consequences for the way functional APIs are designed.
This post is an overview of various techniques
that help utilize currying effectively when writing your functions.
While the examples are written in Haskell syntax,
I believe it should be useful for developers working in other functional languages,&amp;nbsp;too.&lt;/p&gt;
&lt;h4&gt;The&amp;nbsp;basics&lt;/h4&gt;
&lt;p&gt;Let&amp;#8217;s start with a short&amp;nbsp;recap.&lt;/p&gt;
&lt;p&gt;Intuitively, we say that an &lt;em&gt;N&lt;/em&gt;-argument function is &lt;em&gt;curried&lt;/em&gt;
if you can invoke it with a single argument and get back an (&lt;em&gt;N&lt;/em&gt;-1)-argument function.
Repeat this &lt;em&gt;N&lt;/em&gt; times,
and it&amp;#8217;ll be equivalent to supplying all &lt;em&gt;N&lt;/em&gt; arguments at&amp;nbsp;once.&lt;/p&gt;
&lt;p&gt;Here&amp;#8217;s an example: the &lt;code&gt;Data.Text&lt;/code&gt; module in Haskell
contains the following function called &lt;code&gt;splitOn&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="n"&gt;sep&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It&amp;#8217;s a fairly standard string splitting function,
taking a separator as its first argument,
with the second one being a string to perform the splitting&amp;nbsp;on:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;1,2,3&amp;quot;&lt;/span&gt;  &lt;span class="c1"&gt;-- produces [&amp;quot;1&amp;quot;, &amp;quot;2&amp;quot;, &amp;quot;3&amp;quot;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Both arguments are of type &lt;code&gt;Text&lt;/code&gt; (Haskell strings),
while the return type is &lt;code&gt;[Text]&lt;/code&gt; &amp;#8212; a &lt;em&gt;list&lt;/em&gt; of strings.
This add up to the signature (type) of &lt;code&gt;splitOn&lt;/code&gt;,
written above as &lt;code&gt;Text -&amp;gt; Text -&amp;gt; [Text]&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Like all functions in Haskell, however, &lt;code&gt;splitOn&lt;/code&gt; is &lt;em&gt;curried&lt;/em&gt;.
We don&amp;#8217;t have to provide it with both arguments at once;
instead, we can stop at one in order to obtain &lt;em&gt;another function&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOnComma&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nf"&gt;splitOnComma&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;splitOn&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This new function is a &lt;em&gt;partially applied&lt;/em&gt; version of &lt;code&gt;splitOn&lt;/code&gt;,
with its first argument (the separator) already filled in.
To complete the call, all you need to do now is provide the text to&amp;nbsp;split:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOnComma&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;1,2,3&amp;quot;&lt;/span&gt;  &lt;span class="c1"&gt;-- also produces [&amp;quot;1&amp;quot;, &amp;quot;2&amp;quot;, &amp;quot;3&amp;quot;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and, unsurprisingly, you&amp;#8217;ll get the exact same&amp;nbsp;result.&lt;/p&gt;
&lt;p&gt;Compare now the type signatures of both &lt;code&gt;splitOn&lt;/code&gt; and &lt;code&gt;splitOnComma&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nf"&gt;splitOnComma&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It may be puzzling at first why the same arrow symbol (&lt;code&gt;-&amp;gt;&lt;/code&gt;) is used
for what seems like two distinct meanings: the &amp;#8220;argument separator&amp;#8221;,
and the return type&amp;nbsp;indicator.&lt;/p&gt;
&lt;p&gt;But for curried functions, both of those meanings are in fact &lt;em&gt;identical&lt;/em&gt;!&lt;/p&gt;
&lt;p&gt;Indeed, we can make it more explicit by defining &lt;code&gt;splitOn&lt;/code&gt; as:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;or&amp;nbsp;even:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;TypeOf&lt;/span&gt; &lt;span class="n"&gt;splitOnComma&lt;/span&gt; &lt;span class="c1"&gt;-- (not a real Haskell syntax)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;From this perspective, what &lt;code&gt;splitOn&lt;/code&gt; actually returns is not &lt;code&gt;[Text]&lt;/code&gt;
but a &lt;em&gt;function&lt;/em&gt;  from &lt;code&gt;Text&lt;/code&gt; to &lt;code&gt;[Text]&lt;/code&gt; (&lt;code&gt;Text -&amp;gt; [Text]&lt;/code&gt;).
And conversely, a call with two&amp;nbsp;arguments:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;1,2,3&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;is instead &lt;em&gt;two function calls&lt;/em&gt;, each taking just &lt;em&gt;one argument&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;splitOn&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;1,2,3&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This is why the &lt;code&gt;-&amp;gt;&lt;/code&gt; arrow isn&amp;#8217;t actually ambiguous:
it always signifies the &lt;em&gt;mapping&lt;/em&gt; of an argument type to a result type.
And it&amp;#8217;s always just one argument, too,&amp;nbsp;because:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Currying makes all functions take only one&amp;nbsp;argument.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It&amp;#8217;s just that sometimes, what those single-argument functions return
will be yet another&amp;nbsp;function.&lt;/p&gt;
&lt;h4&gt;Least used arguments go &lt;em&gt;first&lt;/em&gt;&lt;/h4&gt;
&lt;p&gt;Now that we have a firmer grasp on the idea of currying,
we can see how it influences &lt;span class="caps"&gt;API&lt;/span&gt;&amp;nbsp;design.&lt;/p&gt;
&lt;p&gt;There is one thing in particular you will notice almost immediately,
especially if you are coming from imperative languages
that support default argument values and/or function overloading.
It&amp;#8217;s the particular &lt;em&gt;order of arguments&lt;/em&gt;
that a well designed, functional &lt;span class="caps"&gt;API&lt;/span&gt; will almost certainly&amp;nbsp;follow.&lt;/p&gt;
&lt;p&gt;See the &lt;code&gt;splitOn&lt;/code&gt; function&amp;nbsp;again:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nf"&gt;splitOn&lt;/span&gt; &lt;span class="n"&gt;sep&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is no accident that it puts the &lt;code&gt;sep&lt;/code&gt;arator as its first argument.
This choice &amp;#8212; as opposed to the alternative where &lt;code&gt;text&lt;/code&gt; goes first &amp;#8212;
produces much more useful results when the function is applied partially
through&amp;nbsp;currying.&lt;/p&gt;
&lt;p&gt;Say, for instance, that you want to splice a list of strings
where the individual pieces can be&amp;nbsp;comma-separated:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;spliceOnComma&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nf"&gt;spliceOnComma&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;2,3&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;4,5,6&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;7&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="c1"&gt;-- ^ This should produce [&amp;quot;1&amp;quot;, &amp;quot;2&amp;quot;, &amp;quot;3&amp;quot;, &amp;quot;4&amp;quot;, &amp;quot;5&amp;quot;, &amp;quot;6&amp;quot;, &amp;quot;7&amp;quot;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Because the separator appears first in a &lt;code&gt;splitOn&lt;/code&gt; call,
you can do it easily through a direct use of&amp;nbsp;currying:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;spliceOnComma&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;concat&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;splitOn&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt;

&lt;span class="c1"&gt;-- or equivalently, in a terser point-free style:&lt;/span&gt;
&lt;span class="c1"&gt;-- spliceOnComma = concatMap $ splitOn &amp;quot;,&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What we do here is apply the split to every string in the list &lt;code&gt;xs&lt;/code&gt;
(with &lt;code&gt;map&lt;/code&gt;), followed by flattening the result &amp;#8212; a list of lists, &lt;code&gt;[[Text]]&lt;/code&gt; &amp;#8212;
back to a regular &lt;code&gt;[Text]&lt;/code&gt; with &lt;code&gt;concat&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;If we had the alternative version of &lt;code&gt;splitOn&lt;/code&gt;,
one where the order of arguments is&amp;nbsp;reversed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;splitOn&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="n"&gt;sep&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;we&amp;#8217;d have no choice but to &amp;#8220;fix it&amp;#8221;, with either a lambda function
or &lt;a href="http://hackage.haskell.org/package/base-4.10.0.0/docs/Prelude.html#v:flip"&gt;the &lt;code&gt;flip&lt;/code&gt; combinator&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;spliceOnComma&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;concat&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;\&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;splitOn&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt;
&lt;span class="nf"&gt;spliceOnComma&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;concat&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;flip&lt;/span&gt; &lt;span class="n"&gt;splitOn&amp;#39;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;xs&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Putting the delimiter first is simply more convenient.
It is much more likely you&amp;#8217;ll be splitting multiple strings on the same separator,
as opposed to a single string and multiple separators.
The argument order of &lt;code&gt;splitOn&lt;/code&gt; is making the common use case slightly easier
by moving the more &amp;#8220;stable&amp;#8221; parameter to the&amp;nbsp;front.&lt;/p&gt;
&lt;p&gt;This practice generalizes to all curried functions,
forming a simple&amp;nbsp;rule:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The more likely it is for an argument to remain &lt;em&gt;constant&lt;/em&gt; between calls,
the sooner it should appear in the function&amp;nbsp;signature.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Note how this is different compared to any language
where functions may take variable number of arguments.
In Python, for example, the equivalent of &lt;code&gt;splitOn&lt;/code&gt; is defined&amp;nbsp;as:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sep&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and the implicit default value for &lt;code&gt;sep&lt;/code&gt; is essentially &amp;#8220;any whitespace character&amp;#8221;.
In many cases, this is exactly what we want,
making the following calls possible&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Alice has a cat&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Alice&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;has&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;cat&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So, as a less-used argument, &lt;code&gt;sep&lt;/code&gt; actually goes last in &lt;code&gt;str.split&lt;/code&gt;,
as it is often desirable to omit it altogether.
Under the currying regime, however, we put it &lt;em&gt;first&lt;/em&gt;,
so that we can fix it to a chosen value and obtain a more specialized version of the&amp;nbsp;function.&lt;/p&gt;
&lt;h4&gt;The fewer arguments, the&amp;nbsp;better&lt;/h4&gt;
&lt;p&gt;Another thing you&amp;#8217;d encounter in languages with flexible function definitions
is the proliferation of optional&amp;nbsp;arguments:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;http://example.com/foo&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                        &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;arg&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;42&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
                        &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;field&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;value&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
                        &lt;span class="n"&gt;auth&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;user&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;pass&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                        &lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;User-Agent&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;My Amazing App&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
                        &lt;span class="n"&gt;cookies&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;c_is&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;for_cookie&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
                        &lt;span class="n"&gt;files&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;attachment.txt&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;file.txt&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;rb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)},&lt;/span&gt;
                        &lt;span class="n"&gt;allow_redirects&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                        &lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;5.0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Trying to translate this directly to a functional paradigm
would result in extremely unreadable function calls &amp;#8212;
doubly so when you don&amp;#8217;t actually need all those arguments
and have to provide some canned&amp;nbsp;defaults:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="kt"&gt;Requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;
    &lt;span class="s"&gt;&amp;quot;http://example.com/foo&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="n"&gt;&amp;#39;arg&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;42&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
    &lt;span class="kt"&gt;[]&lt;/span&gt; &lt;span class="kt"&gt;Nothing&lt;/span&gt; &lt;span class="kt"&gt;[]&lt;/span&gt; &lt;span class="kt"&gt;[]&lt;/span&gt; &lt;span class="kt"&gt;[]&lt;/span&gt; &lt;span class="kt"&gt;True&lt;/span&gt; &lt;span class="kt"&gt;Nothing&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What does that &lt;code&gt;True&lt;/code&gt; mean, for example?
Or what exactly does each empty list signify?
It&amp;#8217;s impossible to know just by looking at the function call&amp;nbsp;alone.&lt;/p&gt;
&lt;p&gt;Long argument lists are thus detrimental to the quality of functional APIs.
It&amp;#8217;s much harder to correctly apply the previous rule (least used arguments first)
when there are so many possible&amp;nbsp;permutations.&lt;/p&gt;
&lt;p&gt;What should we do then?&amp;#8230;
In some cases, including the above example of an &lt;span class="caps"&gt;HTTP&lt;/span&gt; library,
we cannot simply cut out features in the name of elegance.
The necessary information needs to go &lt;em&gt;somewhere&lt;/em&gt;,
meaning we need to find at least somewhat acceptable place for&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Fortunately, we have a couple of options
that should help us with solving this&amp;nbsp;problem.&lt;/p&gt;
&lt;h5&gt;Combinators /&amp;nbsp;builders&lt;/h5&gt;
&lt;p&gt;Looking back at the last example in Python,
we can see why the function call remains readable
even if it sprouts a dozen or so additional&amp;nbsp;arguments.&lt;/p&gt;
&lt;p&gt;The obvious reason is that
each one has been uniquely identified by a &lt;em&gt;name&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;In order to emulate some form of what&amp;#8217;s called keyword arguments,
we can split the single function call into multiple stages.
Each one would then supply one piece of data,
with a matching function name serving as a readability&amp;nbsp;cue:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="n"&gt;sendRequest&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
            &lt;span class="n"&gt;withHeaders&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;User-Agent&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;My Amazing App&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
            &lt;span class="n"&gt;withBasicAuth&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;user&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;pass&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
            &lt;span class="n"&gt;withData&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
                &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://example.com/foo&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If we follow this approach,
the caller would only invoke those intermediate functions
that fit his particular use case.
The &lt;span class="caps"&gt;API&lt;/span&gt; above could still offer &lt;code&gt;withCookies&lt;/code&gt;, &lt;code&gt;withFiles&lt;/code&gt;,
or any of the other combinators,
but their usage shall be completely&amp;nbsp;optional.&lt;/p&gt;
&lt;p&gt;Pretty neat,&amp;nbsp;right?&lt;/p&gt;
&lt;p&gt;Thing is, the implementation would be a little involved here.
We would clearly need to carry some data between the various &lt;code&gt;withFoo&lt;/code&gt; calls,
which requires some additional data types in addition to plain functions.
At minimum, we need something to represent the &lt;code&gt;Request&lt;/code&gt;,
as it is created by the &lt;code&gt;get&lt;/code&gt; function:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;get&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and then &amp;#8220;piped&amp;#8221; through &lt;code&gt;withFoo&lt;/code&gt; transformers like this&amp;nbsp;one:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;withBasicAuth&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;Request&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;so that it can we can finally send&amp;nbsp;it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;sendRequest&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="kt"&gt;Response&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Such &lt;code&gt;Request&lt;/code&gt; type needs to keep track of all the additional parameters
that may have been tacked onto&amp;nbsp;it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;type&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;Param&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;  &lt;span class="c1"&gt;-- Text is the URL&lt;/span&gt;

&lt;span class="kr"&gt;data&lt;/span&gt; &lt;span class="kt"&gt;Param&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;Header&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;
           &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="kt"&gt;BasicAuth&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;
           &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="kt"&gt;Data&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
           &lt;span class="c1"&gt;-- and so on&lt;/span&gt;

&lt;span class="c1"&gt;-- example&lt;/span&gt;
&lt;span class="nf"&gt;withBasicAuth&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="n"&gt;pass&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="kt"&gt;BasicAuth&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt; &lt;span class="n"&gt;pass&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;All of a sudden, what would be a single function explodes into a collection of data types
and associated&amp;nbsp;combinators.&lt;/p&gt;
&lt;p&gt;In Haskell at least,
we can forgo some of the boilerplate by automatically deriving an instance
of &lt;a href="https://hackage.haskell.org/package/base-4.10.0.0/docs/Data-Monoid.html"&gt;&lt;code&gt;Monoid&lt;/code&gt;&lt;/a&gt;
(or perhaps a &lt;a href="https://hackage.haskell.org/package/base-4.10.0.0/docs/Data-Semigroup.html"&gt;&lt;code&gt;Semigroup&lt;/code&gt;&lt;/a&gt;).
Rather than invoking a series of combinators,
clients would then build their requests through repeated &lt;code&gt;mappend&lt;/code&gt;s&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="n"&gt;sendRequest&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://example.com/foo&amp;quot;&lt;/span&gt;
                          &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;header&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;User-Agent&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;My Awesome App&amp;quot;&lt;/span&gt;
                          &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;basicAuth&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;user&amp;quot;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;pass&amp;quot;&lt;/span&gt;
                          &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This mini-&lt;a href="https://en.wikipedia.org/wiki/Domain-specific_language"&gt;&lt;span class="caps"&gt;DSL&lt;/span&gt;&lt;/a&gt;
looks very similar to keyword arguments in Python,
as well as the equivalent Builder pattern from Java, Rust, and others.
What&amp;#8217;s disappointing, however,
is that it doesn&amp;#8217;t easily beat those solutions in terms of compile-time safety.
Unless you invest into some tricky type-level hacks,
there is nothing to prevent the users from building invalid requests at&amp;nbsp;runtime:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;let&lt;/span&gt; &lt;span class="n"&gt;reqParams&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://example.com/foo&amp;quot;&lt;/span&gt;
&lt;span class="c1"&gt;--&lt;/span&gt;
&lt;span class="c1"&gt;-- ... lots of code in between ...&lt;/span&gt;
&lt;span class="c1"&gt;--&lt;/span&gt;
&lt;span class="nf"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="n"&gt;sendRequest&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
            &lt;span class="n"&gt;reqParams&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://example.com/bar&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;-- woops!&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Compared to a plain function (with however many arguments),
we have actually lost some measure of correctness&amp;nbsp;here.&lt;/p&gt;
&lt;h5&gt;Record&amp;nbsp;types&lt;/h5&gt;
&lt;p&gt;In many cases, fortunately,
there is another way to keep our calls both flexible and safe against runtime errors.
We just need to change the representation of the input type (here, &lt;code&gt;Request&lt;/code&gt;)
into a &lt;em&gt;record&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Record is simply a user-defined type that&amp;#8217;s a collection of &lt;em&gt;named fields&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Most languages (especially imperative ones: C, C++, Go, Rust, &amp;#8230;) call those &lt;em&gt;structures&lt;/em&gt;,
and use the &lt;code&gt;struct&lt;/code&gt; keyword to signify a record definition.
In functional programming parlance, they are also referred to as &lt;em&gt;product types&lt;/em&gt;;
this is because the joint record type is a Cartesian product of its individual field types&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Going back to our example,
it shouldn&amp;#8217;t be difficult to define a record representing an &lt;span class="caps"&gt;HTTP&lt;/span&gt; &lt;code&gt;Request&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;data&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;reqURL&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt;
                       &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reqMethod&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Method&lt;/span&gt;
                       &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reqHeaders&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
                       &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reqPostData&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
                       &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In fact, I suspect most programmers would naturally reach for this notation&amp;nbsp;first.&lt;/p&gt;
&lt;p&gt;Having this definition,
calls to &lt;code&gt;sendRequest&lt;/code&gt; can be rewritten to take a record instance
that we construct on the spot&lt;sup id="fnref:4"&gt;&lt;a class="footnote-ref" href="#fn:4" rel="footnote"&gt;4&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="n"&gt;sendRequest&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
    &lt;span class="kt"&gt;Request&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;reqURL&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://example.com/bar&amp;quot;&lt;/span&gt;
            &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reqMethod&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;GET&lt;/span&gt;
            &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reqHeaders&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;User-Agent&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;My Awesome App&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
            &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;reqPostData&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;[]&lt;/span&gt;
            &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Compare this snippet to the Python example from the beginning of this section.
It comes remarkably close, right?
The &lt;code&gt;Request&lt;/code&gt; record and its fields can indeed work quite nicely
as substitutes for keyword&amp;nbsp;arguments.&lt;/p&gt;
&lt;p&gt;But besides the readability boon of having &amp;#8220;argument&amp;#8221; names at the call site.
we&amp;#8217;ve also gained stronger correctness checks.
For example, there is no way anymore to accidentally supply the &lt;span class="caps"&gt;URL&lt;/span&gt; field&amp;nbsp;twice.&lt;/p&gt;
&lt;h4&gt;Different functions for different&amp;nbsp;things&lt;/h4&gt;
&lt;p&gt;Astute readers may have noticed at least two things about the previous&amp;nbsp;solutions.&lt;/p&gt;
&lt;p&gt;First, they are not mutually incompatible.
Quite the opposite, actually: they compose very neatly, allowing us to combine
builder functions with the &lt;em&gt;record update&lt;/em&gt; syntax in the final &lt;span class="caps"&gt;API&lt;/span&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="n"&gt;sendRequest&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;http://example.com/baz&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;reqHeaders&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;User-Agent&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;My Awesome App&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This cuts out basically all the boilerplate of record-based calls,
leaving only the parts that actually differ from the defaults&lt;sup id="fnref:5"&gt;&lt;a class="footnote-ref" href="#fn:5" rel="footnote"&gt;5&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;But on the second and more important note:
we don&amp;#8217;t seem to be talking about &lt;em&gt;currying&lt;/em&gt; anymore.
Does it mean it loses its usefulness
once we go beyond certain threshold of&amp;nbsp;complexity?&amp;#8230;&lt;/p&gt;
&lt;p&gt;Thankfully, the answer is no.
While some APIs may require more advanced techniques
to access the full breadth of their functionality,
it is always possible to expose some carefully constructed facade
that is conducive to partial&amp;nbsp;application.&lt;/p&gt;
&lt;p&gt;Consider, for example, the functionality exposed by this set of &lt;span class="caps"&gt;HTTP&lt;/span&gt;&amp;nbsp;wrappers:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;head&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;span class="nf"&gt;headWith&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;span class="nf"&gt;get&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;span class="nf"&gt;getWith&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;span class="nf"&gt;postForm&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;span class="nf"&gt;postFormWith&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;span class="nf"&gt;toURL&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Method&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;URL&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Request&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Each one is obviously curry-friendly&lt;sup id="fnref:6"&gt;&lt;a class="footnote-ref" href="#fn:6" rel="footnote"&gt;6&lt;/a&gt;&lt;/sup&gt;.
Combined, they also offer a pretty comprehensive &lt;span class="caps"&gt;API&lt;/span&gt; surface.
And should they prove insufficient,
you&amp;#8217;d still have the builder pattern and/or record updates to fall back on &amp;#8212;
either for specialized one-off cases, or for writing your own&amp;nbsp;wrappers.&lt;/p&gt;
&lt;p&gt;Naturally, this technique of layered &lt;span class="caps"&gt;API&lt;/span&gt; design &amp;#8212;
with simple wrappers hiding a progressively more advanced core &amp;#8212;
isn&amp;#8217;t limited to just functional programming.
In some way, it is what &lt;em&gt;good&lt;/em&gt; &lt;span class="caps"&gt;API&lt;/span&gt; design looks like in general.
But in &lt;span class="caps"&gt;FP&lt;/span&gt; languages, it becomes especially important,
because the expressive benefits of partial application are so paramount&amp;nbsp;there&lt;/p&gt;
&lt;p&gt;Fortunately, these principles seem to be followed pretty consistently,
at least within the Haskell ecosystem.
You can see it in the design of
&lt;a href="https://www.stackage.org/haddock/lts-9.12/http-client-0.5.7.0/Network-HTTP-Client.html"&gt;the &lt;code&gt;http-client&lt;/code&gt; package&lt;/a&gt;,
which is the real world extension of the &lt;span class="caps"&gt;HTTP&lt;/span&gt; interface outlined here.
More evidently, it can be observed in any of the numerous packages
the expose both a basic &lt;code&gt;foo&lt;/code&gt; and a more customizable &lt;code&gt;fooWith&lt;/code&gt; functions;
popular examples include
&lt;a href="https://www.stackage.org/haddock/lts-9.12/async-2.1.1.1/Control-Concurrent-Async.html#v:cancelWith"&gt;the &lt;code&gt;async&lt;/code&gt; package&lt;/a&gt;,
&lt;a href="https://hackage.haskell.org/package/zlib-0.6.1.2/docs/Codec-Compression-Zlib.html#g:2"&gt;the &lt;code&gt;zlib&lt;/code&gt; library&lt;/a&gt;,
and &lt;a href="https://www.stackage.org/haddock/lts-9.12/regex-compat-tdfa-0.95.1.4/Text-Regex.html"&gt;the &lt;code&gt;Text.Regex&lt;/code&gt; module&lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;It&amp;#8217;d be more common in Python to write this as &lt;code&gt;"Alice has a cat".split()&lt;/code&gt;,
but this form would make it less obvious how the arguments are passed.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;A great example of this pattern can be found
in the &lt;a href="http://hackage.haskell.org/package/optparse-applicative"&gt;&lt;em&gt;optparse-applicative&lt;/em&gt; package&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;Tuples (like &lt;code&gt;(Int, String)&lt;/code&gt;) are also product types.
They can be thought of as ad-hoc records where field indices serve as rudimentary &amp;#8220;names&amp;#8221;.
In fact, some languages even use the dotted notation to access fields
of both records/structs (&lt;code&gt;x.foo&lt;/code&gt;) and tuples (&lt;code&gt;y.0&lt;/code&gt;).&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:4"&gt;
&lt;p&gt;For simplicity, I&amp;#8217;m gonna assume the &lt;code&gt;URL&lt;/code&gt; and &lt;code&gt;Header&lt;/code&gt; types
can be &amp;#8220;magically&amp;#8221; constructed from string literals
through the &lt;span class="caps"&gt;GHC&lt;/span&gt;&amp;#8217;s &lt;code&gt;OverloadedStrings&lt;/code&gt; extension.&amp;#160;&lt;a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:5"&gt;
&lt;p&gt;In many languages,
we can specify more formally what the &amp;#8220;default&amp;#8221; means for a compound-type like &lt;code&gt;Request&lt;/code&gt;,
and sometimes even &lt;em&gt;derive&lt;/em&gt; it automatically.
Examples include
&lt;a href="https://hackage.haskell.org/package/data-default-0.7.1.1/docs/Data-Default.html#t:Default"&gt;the &lt;code&gt;Default&lt;/code&gt; typeclass&lt;/a&gt; in Haskell,
&lt;a href="https://doc.rust-lang.org/std/default/trait.Default.html"&gt;the &lt;code&gt;Default&lt;/code&gt; trait&lt;/a&gt; in Rust,
and the default/argumentless/trivial constructors in C++ &lt;em&gt;et al&lt;/em&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:6"&gt;
&lt;p&gt;Haskell programmers may especially notice how the last function is designed specifically
for infix application: &lt;code&gt;response &amp;lt;- sendRequest $ POST `toUrl` url&lt;/code&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="functional programming"></category><category term="currying"></category><category term="partial application"></category><category term="Haskell"></category><category term="API"></category><category term="abstraction"></category></entry><entry><title>Small Rust crates I (almost) alwaysÂ use</title><link href="http://xion.io/post/code/rust-little-crates.html" rel="alternate"></link><updated>2017-10-31T15:21:00+00:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2017-10-31:post/code/rust-little-crates.html</id><summary type="html">&lt;p&gt;Alternative clickbait title: &lt;em&gt;My Little Crates: Rust is Magic&lt;/em&gt;&amp;nbsp;:-)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Due to its relatively scant standard library,
programming in Rust inevitably involves pulling in a good number of third-party&amp;nbsp;dependencies.&lt;/p&gt;
&lt;p&gt;Some of them deal with problems that are solved with built-ins
in languages that take a more &amp;#8220;batteries included&amp;#8221; approach.
A good example would be the Python&amp;#8217;s &lt;code&gt;re&lt;/code&gt; module,
whose moral equivalent in the Rust ecosystem is &lt;a href="http://docs.rs/regex"&gt;the &lt;em&gt;regex&lt;/em&gt; crate&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Things like regular expressions, however, represent comparatively large problems.
It isn&amp;#8217;t very surprising that dedicated libraries exist to address them.
It is less common for a language to offer &lt;em&gt;small&lt;/em&gt; packages
that target very specialized&amp;nbsp;applications.&lt;/p&gt;
&lt;p&gt;As in, one function/type/macro-kind of specialized,
or perhaps only a little larger than&amp;nbsp;that.&lt;/p&gt;
&lt;p&gt;In this post, we&amp;#8217;ll take a whirlwind tour through a bunch of such essential&amp;nbsp;&amp;#8220;micropackages&amp;#8221;.&lt;/p&gt;
&lt;h4&gt;either&lt;/h4&gt;
&lt;p&gt;Rust has the built-in &lt;code&gt;Result&lt;/code&gt; type, which is a sum&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt; of an &lt;code&gt;Ok&lt;/code&gt; outcome or an &lt;code&gt;Err&lt;/code&gt;or.
It forms the basis of a general error handling mechanism in the&amp;nbsp;language.&lt;/p&gt;
&lt;p&gt;Structurally, however, &lt;code&gt;Result&amp;lt;T, E&amp;gt;&lt;/code&gt; is just an alternative between the types &lt;code&gt;T&lt;/code&gt; and &lt;code&gt;E&lt;/code&gt;.
You may want to use such an enum for other purposes
than representing results of fallible operations.
Unfortunately, because of the strong inherent meaning of &lt;code&gt;Result&lt;/code&gt;,
such usage would be unidiomatic and highly&amp;nbsp;confusing.&lt;/p&gt;
&lt;p&gt;This is why the &lt;a href="http://docs.rs/either"&gt;&lt;em&gt;either&lt;/em&gt; crate&lt;/a&gt; exists.
It contains the following &lt;code&gt;Either&lt;/code&gt; type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;enum&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Either&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;R&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Left&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Right&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;R&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;While it is isomorphic to &lt;code&gt;Result&lt;/code&gt;,
it carries no connotation to the entrenched error handling practices&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;.
Additionally, it offers symmetric combinator methods such as &lt;code&gt;map_left&lt;/code&gt;
or &lt;code&gt;right_and_then&lt;/code&gt; for chaining computations involving the &lt;code&gt;Either&lt;/code&gt; values.&lt;/p&gt;
&lt;h4&gt;lazy_static&lt;/h4&gt;
&lt;p&gt;As a design choice, Rust doesn&amp;#8217;t allow for safe access to global mutable variables.
The semi-standard way of introducing those into your code
is therefore &lt;a href="http://docs.rs/lazy_static"&gt;the &lt;em&gt;lazy_static&lt;/em&gt; crate&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;However, the most important usage for it is to declare lazy initialized &lt;em&gt;constants&lt;/em&gt;
of more complex&amp;nbsp;types:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;lazy_static&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ref&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;TICK_INTERVAL&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Duration&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Duration&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;from_secs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The trick isn&amp;#8217;t entirely transparent&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;,
but it&amp;#8217;s the best you can do until we get a proper support
for &lt;a href="https://github.com/rust-lang/rfcs/issues/322"&gt;compile-time expressions&lt;/a&gt; in the&amp;nbsp;language.&lt;/p&gt;
&lt;h4&gt;maplit&lt;/h4&gt;
&lt;p&gt;To go nicely with the crate above &amp;#8212;
and to act as a natural syntactic follow-up to
&lt;a href="https://doc.rust-lang.org/1.3.0/std/macro.vec!.html"&gt;the standard &lt;code&gt;vec![]&lt;/code&gt; macro&lt;/a&gt; &amp;#8212;
we&amp;#8217;ve got the &lt;a href="http://docs.rs/maplit"&gt;&lt;em&gt;maplit&lt;/em&gt; crate&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;What it does is add &lt;code&gt;HashMap&lt;/code&gt; and &lt;code&gt;HashSet&lt;/code&gt; &lt;span class="dquo"&gt;&amp;#8220;&lt;/span&gt;literals&amp;#8221; by defining
some very simple &lt;code&gt;hashmap!&lt;/code&gt; and &lt;code&gt;hashset!&lt;/code&gt; macros:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;lazy_static&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ref&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;IMAGE_EXTENSIONS&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;HashMap&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;&amp;#39;static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ImageFormat&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;hashmap&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;gif&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ImageFormat&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;GIF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;jpeg&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ImageFormat&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;JPEG&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;jpg&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ImageFormat&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;JPG&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;png&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;ImageFormat&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;PNG&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Internally, &lt;code&gt;hashmap!&lt;/code&gt; expands to the appropriate amount of &lt;code&gt;HashMap::insert&lt;/code&gt; calls,
returning the finished hash map with all the keys and values&amp;nbsp;given.&lt;/p&gt;
&lt;h4&gt;try_opt&lt;/h4&gt;
&lt;p&gt;Before the &lt;code&gt;?&lt;/code&gt; operator was introduced to Rust,
the idiomatic way of propagating erroneous &lt;code&gt;Result&lt;/code&gt;s was the &lt;code&gt;try!&lt;/code&gt; macro.&lt;/p&gt;
&lt;p&gt;A similar macro can also be implemented for &lt;code&gt;Option&lt;/code&gt; types
so that it propagates the &lt;code&gt;None&lt;/code&gt;s upstream.
The &lt;a href="http://docs.rs/try_opt"&gt;&lt;em&gt;try_opt&lt;/em&gt; crate&lt;/a&gt; is doing precisely that,
and the macro can be used in a straightforward&amp;nbsp;manner:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;parse_ipv4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="kt"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Option&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;u8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u8&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;lazy_static&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ref&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;RE&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Regex&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Regex&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="s-Raw"&gt;r&amp;quot;^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$&amp;quot;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;caps&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RE&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;captures&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;caps&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)).&lt;/span&gt;&lt;span class="n"&gt;as_str&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;caps&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)).&lt;/span&gt;&lt;span class="n"&gt;as_str&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;caps&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;)).&lt;/span&gt;&lt;span class="n"&gt;as_str&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;caps&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;)).&lt;/span&gt;&lt;span class="n"&gt;as_str&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;()),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;()),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;()),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;try_opt&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;()),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Until Rust supports &lt;code&gt;?&lt;/code&gt; for &lt;code&gt;Option&lt;/code&gt;s (which is &lt;a href="https://github.com/rust-lang/rust/issues/31436"&gt;planned&lt;/a&gt;),
this &lt;code&gt;try_opt!&lt;/code&gt; macro can serve as an acceptable&amp;nbsp;workaround.&lt;/p&gt;
&lt;h4&gt;exitcode&lt;/h4&gt;
&lt;p&gt;It is a common convention in basically every mainstream &lt;span class="caps"&gt;OS&lt;/span&gt;
that a process has finished with an error
if it exits with a code different than 0 (zero),
Linux divides the space of error codes &lt;a href="http://www.tldp.org/LDP/abs/html/exitcodes.html"&gt;further&lt;/a&gt;,
and &amp;#8212; along with &lt;span class="caps"&gt;BSD&lt;/span&gt; &amp;#8212; it also includes the &lt;em&gt;sysexits.h&lt;/em&gt; header with some more specialized&amp;nbsp;codes.&lt;/p&gt;
&lt;p&gt;These have been adopted by great many programs
and &lt;a href="https://docs.python.org/3.0/library/os.html#os.EX_OK"&gt;languages&lt;/a&gt;.
In Rust, those semi-standard names for common errors can be used, too.
All you need to do is add &lt;a href="http://docs.rs/exitcode"&gt;the &lt;em&gt;exitcode&lt;/em&gt; crate&lt;/a&gt; to your&amp;nbsp;project:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;main&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap_or_else&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;print_args_error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exitcode&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;USAGE&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;});&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In addition to constants like &lt;code&gt;USAGE&lt;/code&gt; or &lt;code&gt;TEMPFAIL&lt;/code&gt;,
the &lt;em&gt;exitcode&lt;/em&gt; crate also defines an &lt;code&gt;ExitCode&lt;/code&gt; alias
for the integer type holding the exit codes.
You can use it, among other things, as a return type of your top-level&amp;nbsp;functions:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;do_stuff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;do_stuff&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Options&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;exitcode&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;ExitCode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;enum-set&lt;/h4&gt;
&lt;p&gt;In Java, there is a specialization of the general &lt;code&gt;Set&lt;/code&gt; interface
that works for enum types:
&lt;a href="https://docs.oracle.com/javase/7/docs/api/java/util/EnumSet.html"&gt;the &lt;code&gt;EnumSet&lt;/code&gt; class&lt;/a&gt;.
Its members are represented very compactly as &lt;em&gt;bits&lt;/em&gt; rather than hashed&amp;nbsp;elements.&lt;/p&gt;
&lt;p&gt;A similar (albeit slightly less powerful&lt;sup id="fnref:4"&gt;&lt;a class="footnote-ref" href="#fn:4" rel="footnote"&gt;4&lt;/a&gt;&lt;/sup&gt;) structure has been implemented
in the &lt;a href="http://docs.rs/enum-set"&gt;&lt;em&gt;enum-set&lt;/em&gt; crate&lt;/a&gt;. Given a &lt;code&gt;#[repr(u32)]&lt;/code&gt; enum&amp;nbsp;type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;#[repr(u32)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="cp"&gt;#[derive(Clone, Copy, Debug Eq, Hash, PartialEq)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;enum&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Weekday&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Monday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Tuesday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Wednesday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Thursday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Friday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Saturday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Sunday&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;you can create an &lt;code&gt;EnumSet&lt;/code&gt; of its&amp;nbsp;variants:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;weekend&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;EnumSet&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Weekday&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;EnumSet&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;weekend&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Weekday&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Saturday&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;weekend&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Weekday&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Sunday&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;as long as you provide a simple trait impl that specifies
how to convert those enum values to and from &lt;code&gt;u32&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;impl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;enum_set&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;CLike&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Weekday&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;to_u32&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u32&lt;/span&gt;&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u32&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;unsafe&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;from_u32&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u32&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Self&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;mem&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;transmute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The advantage is having a set structure represented by a single, unsigned 32-bit integer,
leading to &lt;em&gt;O&lt;/em&gt;(1) complexity of &lt;em&gt;all&lt;/em&gt; common set operations.
This includes membership checks, the union of two sets, their intersection, difference, and so&amp;nbsp;on.&lt;/p&gt;
&lt;h4&gt;antidote&lt;/h4&gt;
&lt;p&gt;As part of fulfilling the promise of Fearless Concurrencyâ¢,
Rust offers multiple synchronization primitives
that are all defined in &lt;a href="https://doc.rust-lang.org/std/sync/"&gt;the &lt;code&gt;std::sync&lt;/code&gt; module&lt;/a&gt;.
One thing that &lt;code&gt;Mutex&lt;/code&gt;, &lt;code&gt;RwLock&lt;/code&gt;, and similar mechanisms there have in common
is that their locks can become &amp;#8220;poisoned&amp;#8221; if a thread panicks while holding them.
As a result, acquiring a lock requires handling the potential &lt;code&gt;PoisonError&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;For many programs, however, lock poisoning is not even a remote,
but a straight-up &lt;em&gt;impossible&lt;/em&gt; situation.
If you follow the best practices of concurrent resource sharing,
you won&amp;#8217;t be holding locks for more than a few instructions,
devoid of &lt;code&gt;unwrap&lt;/code&gt;s or any other opportunity to &lt;code&gt;panic!()&lt;/code&gt;.
Unfortunately, you cannot prove this to the Rust compiler statically,
so it will still require you to handle a &lt;code&gt;PoisonError&lt;/code&gt; that cannot&amp;nbsp;happen.&lt;/p&gt;
&lt;p&gt;This is where the aptly named &lt;a href="http://docs.rs/antidote"&gt;&lt;em&gt;antidote&lt;/em&gt; crate&lt;/a&gt; crate offers help.
In it, you can find all the same locks &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; guards &lt;span class="caps"&gt;API&lt;/span&gt; that is offered by &lt;code&gt;std::sync&lt;/code&gt;,
just without the &lt;code&gt;PoisonError&lt;/code&gt;.
In many cases, this removal has radically simplified the interface,
for example by turning &lt;code&gt;Result&amp;lt;Guard, Error&amp;gt;&lt;/code&gt; return types into just &lt;code&gt;Guard&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The caveat, of course, is that you need to ensure all threads holding these &amp;#8220;immunized&amp;#8221; locks&amp;nbsp;either:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;don&amp;#8217;t panic at all;&amp;nbsp;or&lt;/li&gt;
&lt;li&gt;don&amp;#8217;t leave guarded resources in an inconsistent state if they &lt;em&gt;do&lt;/em&gt;&amp;nbsp;panic&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Like it&amp;#8217;s been mentioned earlier,
the best way to make that happen is to keep lock-guarded critical sections minimal and&amp;nbsp;infallible.&lt;/p&gt;
&lt;h4&gt;matches&lt;/h4&gt;
&lt;p&gt;Pattern matching is one of the most important features of Rust,
but some of the relevant language constructs have awkward shortcomings.
The &lt;code&gt;if let&lt;/code&gt; conditional, for example, cannot be combined with boolean&amp;nbsp;tests:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_good&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and thus requires additional nesting, or a different approach&amp;nbsp;altogether.&lt;/p&gt;
&lt;p&gt;Thankfully, to help with situations like this,
there is the &lt;a href="http://docs.rs/matches"&gt;&lt;em&gt;matches&lt;/em&gt; crate&lt;/a&gt; with a bunch of convenient macros.
Besides &lt;a href="https://docs.rs/matches/0.1.6/matches/macro.matches.html"&gt;its namesake, &lt;code&gt;matches!&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;matches&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Foo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;y&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_good&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;it also exposes assertion macros
(&lt;a href="https://docs.rs/matches/0.1.6/matches/macro.assert_matches.html"&gt;&lt;code&gt;assert_match!&lt;/code&gt;&lt;/a&gt;
and &lt;a href="https://docs.rs/matches/0.1.6/matches/macro.debug_assert_matches.html"&gt;&lt;code&gt;debug_assert_match!&lt;/code&gt;&lt;/a&gt;)
that can be used in both production and test&amp;nbsp;code.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;This concludes the overview of small Rust crates, at least for&amp;nbsp;now.&lt;/p&gt;
&lt;p&gt;To be certain, these crates are by far not the only ones that are small in size
and simultaneously almost indispensable.
Many more great libraries can be found
e.g. in the &lt;a href="https://github.com/rust-unofficial/awesome-rust#libraries"&gt;Awesome Rust registry&lt;/a&gt;,
though obviously you could argue if all of them are truly &amp;#8220;micro&amp;#8221;&amp;nbsp;;-)&lt;/p&gt;
&lt;p&gt;If you know more crates in the similar vein,
make sure to mention them in the&amp;nbsp;comments!&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;A &lt;em&gt;sum type&lt;/em&gt; consists of several alternatives,
out of which only one has been picked for a particular instance.
The other common name for it is a &lt;em&gt;tagged union&lt;/em&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Unless you come from Haskell, that is, where &lt;code&gt;Either&lt;/code&gt; is the equivalent of Rust&amp;#8217;s &lt;code&gt;Result&lt;/code&gt; :)&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;You will occasionally need an explicit &lt;code&gt;*&lt;/code&gt; to trigger the &lt;code&gt;Deref&lt;/code&gt; coercion it uses.&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:4"&gt;
&lt;p&gt;It only supports unitary enums of up to 32 variants.&amp;#160;&lt;a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="Rust"></category><category term="libraries"></category></entry><entry><title>O(n log n) isnâtÂ bad</title><link href="http://xion.io/post/programming/o-nlogn-isnt-bad.html" rel="alternate"></link><updated>2017-10-19T14:59:00+00:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2017-10-19:post/programming/o-nlogn-isnt-bad.html</id><summary type="html">&lt;p&gt;Most programmers should be familiar with the Big O notation of computational complexity.
This is how, in very theoretical terms, we are describing the relative differences in the performance of&amp;nbsp;algorithms.&lt;/p&gt;
&lt;p&gt;Excluding the case of constant time complexity (&lt;code&gt;O(1)&lt;/code&gt;),
the vast majority of practical algorithms falls into one of the following&amp;nbsp;classes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;O(log n)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;O(n)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;O(n log n)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;O(nÂ²)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The further down a class is on this list, the worse (less efficient) it gets.
What may not be completely obvious, however, is the magnitude of&amp;nbsp;differences.&lt;/p&gt;
&lt;p&gt;Let&amp;#8217;s have a closer&amp;nbsp;look.&lt;/p&gt;
&lt;h4&gt;The best and the&amp;nbsp;worst&lt;/h4&gt;
&lt;p&gt;First, it&amp;#8217;s pretty easy when it comes to the extreme points.
A logarithmic complexity is clearly great,
because the number of operations barely even grows as the size of input increases.
For &lt;code&gt;N&lt;/code&gt; of one million,  the (natural&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;) logarithm is equal to about 14.
For one &lt;em&gt;trillion&lt;/em&gt; &amp;#8212; million times more &amp;#8212; &lt;code&gt;log n&lt;/code&gt; is only&amp;nbsp;27!&lt;/p&gt;
&lt;p&gt;Such amazing scalability is one of the reasons
why databases, for example,
can execute queries extremely efficiently even for millions or billions of&amp;nbsp;records.&lt;/p&gt;
&lt;p&gt;On the other end, an algorithm that has quadratic complexity
will only do well for very small datasets.
It can still be useful in practice,
especially as a small-input optimization of some larger procedure&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;,
or because of some other desirable properties (like good&amp;nbsp;parallelizability).&lt;/p&gt;
&lt;p&gt;Outside of those carefully selected cases, however,
the computational requirements of &lt;code&gt;O(nÂ²)&lt;/code&gt; for any large dataset are usually too&amp;nbsp;great.&lt;/p&gt;
&lt;h4&gt;Middle&amp;nbsp;ground&lt;/h4&gt;
&lt;p&gt;As for the remaining two classes,
the linear one (&lt;code&gt;O(n)&lt;/code&gt;) is probably the easiest to reason&amp;nbsp;about.&lt;/p&gt;
&lt;p&gt;In a linear algorithm,
the number of operations increases steadily along with the size of input.&lt;br&gt;
For thousand elements, you need roughly a thousand steps (times a constant factor).&lt;br&gt;
For a million, there will be a million operations&amp;nbsp;necessary.&lt;/p&gt;
&lt;p&gt;Thus, by itself, the linear scaling doesn&amp;#8217;t get any better or worse when data gets bigger&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;.
In many cases, it means there is nothing to be exploited in the structure of input set
that could make the running time any better
(compared to e.g. the reliance of logarithmic searches on sorted order).
Typically, all the data must be traversed at least once in its&amp;nbsp;entirety.&lt;/p&gt;
&lt;p&gt;All in all, it can be a decent time complexity,
but it&amp;#8217;s nothing to write home&amp;nbsp;about.&lt;/p&gt;
&lt;h4&gt;A function has no&amp;nbsp;name&lt;/h4&gt;
&lt;p&gt;What about &lt;code&gt;O(n log n)&lt;/code&gt;, then?
It falls between the linear and the quadratic,
which suggests that it&amp;#8217;s somewhere half-way between mediocre and awful.
We don&amp;#8217;t even have a widely used word for it,
meaning it is probably not even that&amp;nbsp;important.&lt;/p&gt;
&lt;p&gt;Both of those suppositions are&amp;nbsp;wrong.&lt;/p&gt;
&lt;p&gt;First, &lt;code&gt;O(n log n)&lt;/code&gt; isn&amp;#8217;t even remotely close to the &amp;#8220;median&amp;#8221; (whatever that means) of &lt;code&gt;O(n)&lt;/code&gt; and &lt;code&gt;O(nÂ²)&lt;/code&gt;.
In reality, its asymptotic rate of growth places it very close to the former.
You can see this pretty clearly by looking at the following&amp;nbsp;plot:&lt;/p&gt;
&lt;p style="text-align:center"&gt;
    &lt;img src="http://xion.io/images/time-complexity.png" alt="Time complexity plot"&gt;&lt;br&gt;
    &lt;small&gt;
        &lt;a href="http://coding-geek.com/how-databases-work/"&gt;Source&lt;/a&gt;
    &lt;/small&gt;
&lt;/p&gt;

&lt;p&gt;The gap between &lt;code&gt;O(n)&lt;/code&gt; and &lt;code&gt;O(n log n)&lt;/code&gt; barely even widens,
even as the values on vertical axis increase to the limits of&amp;nbsp;practicality.&lt;/p&gt;
&lt;p&gt;Indeed, the &lt;code&gt;log n&lt;/code&gt; part of the function grows slowly enough
that, for many practical purposes, it can be considered a large &amp;#8220;constant&amp;#8221; in the complexity formula.
Some complicated algorithm that&amp;#8217;s technically linear may therefore be a &lt;em&gt;worse&lt;/em&gt; choice
than a simpler solution with &lt;code&gt;O(n log n)&lt;/code&gt; scaling.&lt;/p&gt;
&lt;h4&gt;Sorting it&amp;nbsp;out&lt;/h4&gt;
&lt;p&gt;What are the typical situations where &lt;code&gt;O(n log n)&lt;/code&gt; arises in practice?
Very often, it has to do with establishing some kind of &lt;em&gt;ordering&lt;/em&gt; of the input
which includes at least one of the&amp;nbsp;following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a wholesale sorting of it (using pairwise&amp;nbsp;comparison)&lt;/li&gt;
&lt;li&gt;repeated queries for the current maximum or minimum (via a priority&amp;nbsp;queue)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Considering that many practical algoithms &amp;#8212;
from &lt;a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm"&gt;pathfinding&lt;/a&gt;
to &lt;a href="https://en.wikipedia.org/wiki/Huffman_coding"&gt;compression&lt;/a&gt; &amp;#8212;
utilize some form of sorting or sorted data structures,
it makes &lt;code&gt;O(n log n)&lt;/code&gt; quite an important complexity&amp;nbsp;class.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Natural logarithm has a base of &lt;em&gt;e&lt;/em&gt; = 2.71828183&amp;#8230;
The exact choice of logarithm base doesn&amp;#8217;t matter for asymptotic complexity,
because it changes only the constant coefficient in the &lt;code&gt;O(f(n))&lt;/code&gt; function.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;A widely used example is &lt;a href="https://en.wikipedia.org/wiki/Timsort"&gt;Timsort&lt;/a&gt;
which switches from merge sort (&lt;code&gt;O(log n)&lt;/code&gt;) to insertion sort (&lt;code&gt;O(nÂ²)&lt;/code&gt;)
when the array slice is short enough to warrant it.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;In reality, practical factors like memory/cache size, &lt;span class="caps"&gt;OS&lt;/span&gt; scheduling behavior,
and a myriad of other things can make the actual running time scale sublinearly beyond a certain point.&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="algorithms"></category><category term="complexity"></category><category term="Big O"></category></entry><entry><title>The Printer Monad inÂ Haskell</title><link href="http://xion.io/post/code/haskell-printer-monad.html" rel="alternate"></link><updated>2017-08-04T12:39:00+00:00</updated><author><name>Karol Kuczmarski</name></author><id>tag:xion.io,2017-08-04:post/code/haskell-printer-monad.html</id><summary type="html">&lt;p&gt;Quite recently, I have encountered an interesting case of monad-based refactoring in&amp;nbsp;Haskell.&lt;/p&gt;
&lt;p&gt;Suppose you have a &lt;code&gt;ComplicatedRecord&lt;/code&gt;
that holds the results of some lengthy and important process in your program.
You want to present that data to the user in a nicely formatted way,
so you write a function which begins somewhat like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cm"&gt;{-# LANGUAGE RecordWildcards #-}&lt;/span&gt;

&lt;span class="c1"&gt;-- | Pretty-print the content of the record.&lt;/span&gt;
&lt;span class="nf"&gt;ppRecord&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;ComplicatedRecord&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;span class="nf"&gt;ppRecord&lt;/span&gt; &lt;span class="kt"&gt;ComplicatedRecord&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="c1"&gt;-- ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Inside, there is plenty of &lt;code&gt;putStrLn&lt;/code&gt; calls, likely hidden inside more specific subfunctions
that format all the numerous parts of &lt;code&gt;ComplicatedRecord&lt;/code&gt;.
But the &lt;code&gt;IO&lt;/code&gt; monad isn&amp;#8217;t there just for printing:
because the code went through multiple iterations,
some of this logic actually takes advantage of it by making additional system &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; network&amp;nbsp;calls.&lt;/p&gt;
&lt;p&gt;So yeah, it&amp;#8217;s not particularly&amp;nbsp;pretty.&lt;/p&gt;
&lt;p&gt;Now, however, we find out that the output we&amp;#8217;re printing here
shouldn&amp;#8217;t &lt;em&gt;always&lt;/em&gt; go directly to stdout.
In some cases, unsurprisingly, we actually want it back as a single string,
without having it sent to the standard output at&amp;nbsp;all.&lt;/p&gt;
&lt;h4&gt;Just $ return .&amp;nbsp;it&lt;/h4&gt;
&lt;p&gt;Your first instinct here may be to simply give back the final string (well, &lt;code&gt;Text&lt;/code&gt;)
as the function result&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;ppRecord&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;ComplicatedRecord&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;However, this turns out to be rather awkward.
While in most other languages
we would simply accumulate output by progressively adding more data to a mutable result,
this would be much more inconvenient (and somewhat weird) to do in&amp;nbsp;Haskell.&lt;/p&gt;
&lt;p&gt;This is where the stdout-based approach seems cleaner;
instead of straightforward, sequential code like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cm"&gt;{-# LANGUAGE OverloadedStrings #-}&lt;/span&gt;

&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;Control.Monad.Extra&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;whenJust&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;Data.Text.IO&lt;/span&gt;
&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;TextShow&lt;/span&gt;

&lt;span class="nf"&gt;ppOrder&lt;/span&gt; &lt;span class="kt"&gt;Order&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;putStrLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Order #&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;ordNumber&lt;/span&gt;
    &lt;span class="n"&gt;ppAddress&lt;/span&gt; &lt;span class="n"&gt;ordDeliveryAddress&lt;/span&gt;
    &lt;span class="n"&gt;forM_&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;zip&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="n"&gt;ordItems&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="nf"&gt;\&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Item&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
        &lt;span class="n"&gt;putStrLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;showt&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="ow"&gt;::&lt;/span&gt;&lt;span class="kt"&gt;Int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;. &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;itName&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;showt&lt;/span&gt; &lt;span class="n"&gt;itQuantity&lt;/span&gt;
    &lt;span class="n"&gt;whenJust&lt;/span&gt; &lt;span class="n"&gt;ordBillingAddress&lt;/span&gt; &lt;span class="n"&gt;ppAddress&lt;/span&gt;

&lt;span class="nf"&gt;ppAddress&lt;/span&gt; &lt;span class="kt"&gt;Address&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;putStrLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;addrFirstName&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;addrLastName&lt;/span&gt;
    &lt;span class="n"&gt;putStrLn&lt;/span&gt; &lt;span class="n"&gt;addrLine1&lt;/span&gt;
    &lt;span class="n"&gt;whenJust&lt;/span&gt; &lt;span class="n"&gt;addrLine2&lt;/span&gt; &lt;span class="n"&gt;putStrLn&lt;/span&gt;
    &lt;span class="n"&gt;putStrLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;addrCity&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;, &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;addrPostalCode&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;we have to overhaul each function and turn it into a much less pleasant &amp;#8220;&lt;code&gt;mappend&lt;/code&gt;age&amp;#8221;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;ppOrder&lt;/span&gt; &lt;span class="kt"&gt;Order&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;unlines&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;mconcat&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Order #&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;ordNumber&lt;/span&gt;
    &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ppAddress&lt;/span&gt; &lt;span class="n"&gt;ordDeliveryAddress&lt;/span&gt;
    &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ppItems&lt;/span&gt; &lt;span class="n"&gt;ordItems&lt;/span&gt;
    &lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;maybe&lt;/span&gt; &lt;span class="kt"&gt;[]&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;\&lt;/span&gt;&lt;span class="n"&gt;addr&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;ppAddress&lt;/span&gt; &lt;span class="n"&gt;addr&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt; &lt;span class="n"&gt;ordBillingAddress&lt;/span&gt;
    &lt;span class="kr"&gt;where&lt;/span&gt;
    &lt;span class="n"&gt;ppItems&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mconcat&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="n"&gt;map&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uncurry&lt;/span&gt; &lt;span class="n"&gt;ppItem&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;.&lt;/span&gt; &lt;span class="n"&gt;zip&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;ppItem&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="kt"&gt;Item&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;showt&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;. &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;itName&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; x&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;itQuantity&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;One may argue that this is, in fact, the more idiomatic approach,
but I&amp;#8217;m not very fond of all those commas.
Plus, it shows rather clearly that any conditional logic (like with &lt;code&gt;ordBillingAddress&lt;/code&gt; here)
is going to get pretty&amp;nbsp;cumbersome.&lt;/p&gt;
&lt;h4&gt;Along comes the &lt;code&gt;Writer&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;What I&amp;#8217;m saying here is that even in pure code,
it is sometimes very desirable to have a &lt;code&gt;do&lt;/code&gt; notation.
For that, however, we need a suitable &lt;code&gt;Monad&lt;/code&gt;&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt; to provide the meaning of &amp;#8220;invisible semicolon&amp;#8221; in a &lt;code&gt;do&lt;/code&gt; block.&lt;/p&gt;
&lt;p&gt;And &lt;code&gt;Text&lt;/code&gt;, obviously, isn&amp;#8217;t one.
Neither is &lt;code&gt;[Text]&lt;/code&gt; (lines of text),
nor any other type we&amp;#8217;d use to represent the final output of formatting &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; printing.
They are unsuitable, because they cannot encode the &lt;em&gt;computation&lt;/em&gt; that eventually produces said output &amp;#8212;
either the top-level one (&lt;code&gt;ppRecord&lt;/code&gt;) or any of its building blocks (like the &lt;code&gt;ppOrder&lt;/code&gt; or &lt;code&gt;ppAddress&lt;/code&gt;),
down to a most elementary &lt;code&gt;putStrLn&lt;/code&gt;.
The only thing they can stand for is the result&amp;nbsp;itself.&lt;/p&gt;
&lt;p&gt;Fortunately, the pattern of executing code and occassionally producing some &amp;#8220;additional&amp;#8221; output
has been abstracted over in the Haskell standard library.
This is exactly the use case for the &lt;code&gt;Writer&lt;/code&gt; monad!&lt;/p&gt;
&lt;p&gt;The definition of &lt;code&gt;Writer&lt;/code&gt; is roughly equivalent to the&amp;nbsp;following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;newtype&lt;/span&gt; &lt;span class="kt"&gt;Writer&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt; &lt;span class="c1"&gt;-- omitted&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Of the two type parameters it takes, the &lt;code&gt;w&lt;/code&gt; one signifies what output it can produce &amp;#8220;on the side&amp;#8221;.
This is contrasted with &lt;code&gt;a&lt;/code&gt; which is the regular result of a monadic expression or function.
In our case, &lt;code&gt;a&lt;/code&gt; will basically always be &lt;code&gt;()&lt;/code&gt; (unit/&amp;#8221;empty&amp;#8221; type),
but it is nonetheless necessary for the &lt;code&gt;Writer&lt;/code&gt; to behave as a&amp;nbsp;monad.&lt;/p&gt;
&lt;p&gt;To complement the above definition, &lt;code&gt;Writer&lt;/code&gt; comes with several useful functions.
Among those, the most interesting one is &lt;code&gt;tell&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;tell&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Writer&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;write&lt;/code&gt; would&amp;#8217;ve probably been a better name for it,
as it&amp;#8217;s definitely the main and defining operation of &lt;code&gt;Writer&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Looking at its signature, we can see it takes a bit of the &lt;code&gt;Writer&lt;/code&gt;&lt;span class="quo"&gt;&amp;#8216;&lt;/span&gt;s output (&lt;code&gt;w&lt;/code&gt;)
and results in a &lt;code&gt;Writer&lt;/code&gt; action.
Internally, it will simply add the argument to the already accumulated output of the writer&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;To make everything more concrete,
here&amp;#8217;s a literal &amp;#8220;Hello world&amp;#8221; example coded very verbosly as a &lt;code&gt;Writer&lt;/code&gt; action:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;Control.Monad.Writer&lt;/span&gt;

&lt;span class="nf"&gt;hello&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Writer&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;span class="nf"&gt;hello&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;tell&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Hello&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;tell&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;tell&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;world&amp;quot;&lt;/span&gt;

&lt;span class="nf"&gt;main&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;span class="nf"&gt;main&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="kr"&gt;let&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kr"&gt;_&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;greeting&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;runWriter&lt;/span&gt; &lt;span class="n"&gt;hello&lt;/span&gt;
    &lt;span class="kt"&gt;Text&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;putStrLn&lt;/span&gt; &lt;span class="n"&gt;greeting&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It also contains the last element of the &lt;code&gt;Writer&lt;/code&gt; puzzle:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;runWriter&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Writer&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Like its name suggests, this function will &amp;#8220;run&amp;#8221; any &lt;code&gt;Writer&lt;/code&gt; action that we give it,
returning both the &amp;#8220;regular&amp;#8221; result (&lt;code&gt;a&lt;/code&gt;) plus any output passed in &lt;code&gt;tell&lt;/code&gt;s (&lt;code&gt;w&lt;/code&gt;).&lt;sup id="fnref:4"&gt;&lt;a class="footnote-ref" href="#fn:4" rel="footnote"&gt;4&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h4&gt;My little monad: transformers are&amp;nbsp;magic&lt;/h4&gt;
&lt;p&gt;The last example may be very simple,
but it contains all the building blocks for many of the printing functions we need.
If we define a convenience wrapper for &lt;code&gt;tell&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;putLn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Writer&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;span class="nf"&gt;putLn&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tell&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;then both &lt;code&gt;ppAddress&lt;/code&gt; and &lt;code&gt;ppOrder&lt;/code&gt; can be translated
through a mere mechanical substitution of &lt;code&gt;putStrLn&lt;/code&gt; with &lt;code&gt;putLn&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;ppAddress&lt;/span&gt; &lt;span class="kt"&gt;Address&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;putLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;addrFirstName&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;addrLastName&lt;/span&gt;
    &lt;span class="n"&gt;putLn&lt;/span&gt; &lt;span class="n"&gt;addrLine1&lt;/span&gt;
    &lt;span class="n"&gt;whenJust&lt;/span&gt; &lt;span class="n"&gt;addrLine2&lt;/span&gt; &lt;span class="n"&gt;putLn&lt;/span&gt;
    &lt;span class="n"&gt;putLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;addrCity&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;, &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;addrPostalCode&lt;/span&gt;

&lt;span class="c1"&gt;-- ppOrder omitted&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Unfortunately, a bare &lt;code&gt;Writer&lt;/code&gt; like this can only work for pure code,
which isn&amp;#8217;t a luxury we can expect in every situtation.
In my case, some of the printing logic was tied pretty strongly to &lt;code&gt;IO&lt;/code&gt;,
and it would be difficult and time consuming to decouple&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Thankfully, the reliance on &lt;code&gt;IO&lt;/code&gt; isn&amp;#8217;t a complete deal breaker.
While we cannot ensure that nothing calls &lt;code&gt;putStrLn&lt;/code&gt; anymore,
we can provide the &lt;code&gt;tell&lt;/code&gt;/&lt;code&gt;putLn&lt;/code&gt; capabilities alongside whatever &lt;em&gt;other&lt;/em&gt; &lt;code&gt;IO&lt;/code&gt; calls
our code has to make (for&amp;nbsp;now).&lt;/p&gt;
&lt;p&gt;To achieve that, we need to create a &lt;em&gt;monad stack&lt;/em&gt; with &lt;code&gt;WriterT&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;newtype&lt;/span&gt; &lt;span class="kt"&gt;WriterT&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt; &lt;span class="c1"&gt;-- omitted&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;WriterT&lt;/code&gt; is a &lt;em&gt;monad transformer&lt;/em&gt;, one of those scary Haskell concepts
that are actually simpler than they appear on the surface.
This is because transfomers like &lt;code&gt;WriterT&lt;/code&gt; are mere wrappers.
The only difference between it and a regular &lt;code&gt;Writer&lt;/code&gt; is the additional &lt;code&gt;m&lt;/code&gt; parameter,
which is the &lt;em&gt;inner monad&lt;/em&gt; we&amp;#8217;re packaging inside a new &lt;code&gt;Writer&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Here (and in many other cases), &lt;code&gt;m&lt;/code&gt; will be substituted with &lt;code&gt;IO&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;type&lt;/span&gt; &lt;span class="kt"&gt;Printer&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;WriterT&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;  &lt;span class="c1"&gt;-- w == Text, m == IO&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;thus creating the titular &lt;code&gt;Printer&lt;/code&gt; monad.
This hybrid beast can both output &lt;code&gt;Text&lt;/code&gt; through the &lt;code&gt;Writer&lt;/code&gt; &lt;span class="caps"&gt;API&lt;/span&gt;,
as well as perform any additional &lt;code&gt;IO&lt;/code&gt; operations
that the code may (still)&amp;nbsp;require.&lt;/p&gt;
&lt;p&gt;Below is an example;
the &lt;code&gt;User&lt;/code&gt; record requires an I/O call to get the size of its &lt;code&gt;$HOME&lt;/code&gt; directory:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;Control.Monad.IO.Class&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;liftIO&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;System.Directory&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;getFileSize&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;-- To print this data type nicely, we sadly require I/O :(&lt;/span&gt;
&lt;span class="kr"&gt;data&lt;/span&gt; &lt;span class="kt"&gt;User&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;User&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;usrName&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;
                 &lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;usrHomeDir&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;FilePath&lt;/span&gt;
                 &lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="nf"&gt;ppUser&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;User&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt;
&lt;span class="nf"&gt;ppUser&lt;/span&gt; &lt;span class="kt"&gt;User&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="o"&gt;..&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;snd&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;$&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;runWriterT&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;putLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Name: &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;usrName&lt;/span&gt;
    &lt;span class="n"&gt;homeSize&lt;/span&gt; &lt;span class="ow"&gt;&amp;lt;-&lt;/span&gt; &lt;span class="n"&gt;liftIO&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;getFileSize&lt;/span&gt; &lt;span class="n"&gt;usrHomeDir&lt;/span&gt;
    &lt;span class="n"&gt;putLn&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;$HOME: &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;showt&lt;/span&gt; &lt;span class="n"&gt;usrHomeDir&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;(&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;showt&lt;/span&gt; &lt;span class="n"&gt;homeSize&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; bytes)&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As a bit of necessary cruft,
we have to use &lt;code&gt;liftIO&lt;/code&gt; to &amp;#8220;lift&amp;#8221; (wrap) &lt;code&gt;IO&lt;/code&gt; actions such as &lt;code&gt;getFileSize&lt;/code&gt;
in a full &lt;code&gt;Printer&lt;/code&gt; monad before executing them.
Besides everything else you can think of,
this is yet another argument for eventually getting rid of the &lt;code&gt;IO&lt;/code&gt; :)&lt;/p&gt;
&lt;h4&gt;Making the monads&amp;nbsp;coexist&lt;/h4&gt;
&lt;p&gt;But our job isn&amp;#8217;t done yet.
Despite looking very reasonable, this version of &lt;code&gt;ppUser&lt;/code&gt; doesn&amp;#8217;t actually compile!
The actual type error may vary a little,
but it all boils down to a difference between &lt;code&gt;WriterT Text IO ()&lt;/code&gt; (i.e. &lt;code&gt;Printer ()&lt;/code&gt;)
and &lt;code&gt;Writer Text ()&lt;/code&gt; at each call site of &lt;code&gt;putLn&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;span class="caps"&gt;GHC&lt;/span&gt; is obviously correct.
However, the problem lies not in how we&amp;#8217;re calling &lt;code&gt;putLn&lt;/code&gt;,
but rather the way it&amp;#8217;s been&amp;nbsp;defined:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;putLn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Writer&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This type can only produce a specific, &lt;em&gt;pure&lt;/em&gt; &lt;code&gt;Writer&lt;/code&gt; action.
But to fit inside the &lt;code&gt;do&lt;/code&gt; block of our compound monad,
we need the &lt;code&gt;Writer&lt;/code&gt; + &lt;code&gt;IO&lt;/code&gt; combo from &lt;code&gt;WriterT Text IO&lt;/code&gt; (i.e. &lt;code&gt;Printer&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;We can try to address the mismatch by changing the signature&amp;nbsp;to:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;putLn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;WriterT&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="kt"&gt;IO&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;  &lt;span class="c1"&gt;-- or just: Printer ()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;but this will only result in the &lt;em&gt;opposite&lt;/em&gt; problem.
Now, all the pure printers like &lt;code&gt;ppAddress&lt;/code&gt; are facing the fact
that &lt;code&gt;putLn&lt;/code&gt; is a (wrapped) &lt;code&gt;IO&lt;/code&gt; action, despite not actually doing any I/O&amp;nbsp;whatsoever.&lt;/p&gt;
&lt;p&gt;The obvious question is, can we have something that fits &lt;em&gt;both&lt;/em&gt;?&lt;/p&gt;
&lt;p&gt;Earlier on, I&amp;#8217;ve said that both vanilla &lt;code&gt;Writer&lt;/code&gt; and the &lt;code&gt;IO&lt;/code&gt;-spruced &lt;code&gt;Printer&lt;/code&gt; support the &amp;#8220;&lt;code&gt;Writer&lt;/code&gt; &lt;span class="caps"&gt;API&lt;/span&gt;&amp;#8221;,
most notably the &lt;code&gt;tell&lt;/code&gt; function.
This notion of a &amp;#8220;monadic interface&amp;#8221; isn&amp;#8217;t just hand-waving, though,
and Haskell (obviously!) provides a way to express it&amp;nbsp;programmatically.&lt;/p&gt;
&lt;p&gt;Meet the &lt;code&gt;MonadWriter&lt;/code&gt; typeclass:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;class&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;Monad&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kt"&gt;Monoid&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="ow"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;MonadWriter&lt;/span&gt; &lt;span class="n"&gt;w&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Any monad that can work as a &lt;code&gt;Writer&lt;/code&gt; will be an instance of it,
regardless of whether it wraps over &lt;code&gt;IO&lt;/code&gt; or anything else.
Functions like &lt;code&gt;tell&lt;/code&gt; are defined to be
&lt;a href="http://hackage.haskell.org/package/mtl-2.2.1/docs/Control-Monad-Writer-Class.html#v:tell"&gt;polymorphic over it&lt;/a&gt;,
enabling us to leverage the same technique they use when we define &lt;code&gt;putLn&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cm"&gt;{-# LANGUAGE FlexibleContexts #-}&lt;/span&gt;

&lt;span class="kr"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;Control.Monad.Writer.Class&lt;/span&gt;

&lt;span class="nf"&gt;putLn&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="kt"&gt;MonadWriter&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="ow"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="kt"&gt;Text&lt;/span&gt; &lt;span class="ow"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="nb"&gt;()&lt;/span&gt;
&lt;span class="nf"&gt;putLn&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tell&lt;/span&gt; &lt;span class="o"&gt;$&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If you aren&amp;#8217;t very familiar with this syntax,
the part before &lt;code&gt;=&amp;gt;&lt;/code&gt; is a &lt;em&gt;typeclass constraint&lt;/em&gt;, or &lt;em&gt;context&lt;/em&gt;.
It defines the requirements to be satisfied by types
which are later used in the function&amp;nbsp;signature.&lt;/p&gt;
&lt;p&gt;Here, we request a &lt;code&gt;MonadWriter&lt;/code&gt; instance &amp;#8212; one where &lt;code&gt;Text&lt;/code&gt; is the output
but &lt;em&gt;anything&lt;/em&gt; can be the inner monad.
We refer to that unknown monad only as &lt;code&gt;m&lt;/code&gt;, a type variable.
The compiler will figure out what to substitute for it &lt;em&gt;at every call site&lt;/em&gt; of &lt;code&gt;putLn&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;As a result, both a pure &lt;code&gt;Writer&lt;/code&gt; and the &lt;code&gt;IO&lt;/code&gt;-bound &lt;code&gt;Printer&lt;/code&gt; can now use it.
In the second case, the relevant instance of &lt;code&gt;MonadWriter&lt;/code&gt; will,
naturally, have &lt;code&gt;IO&lt;/code&gt; fill in the &lt;code&gt;m&lt;/code&gt; position.&lt;/p&gt;
&lt;p&gt;But curiously, the &amp;#8220;pure&amp;#8221; &lt;code&gt;Writer&lt;/code&gt; also has
&lt;a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Data-Functor-Identity.html#t:Identity"&gt;an inner monad&lt;/a&gt;.
It just literally &lt;em&gt;does nothing&lt;/em&gt; but wrap some other&amp;nbsp;value:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;newtype&lt;/span&gt; &lt;span class="kt"&gt;Identity&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="ow"&gt;=&lt;/span&gt; &lt;span class="kt"&gt;Identity&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="n"&gt;runIdentity&lt;/span&gt; &lt;span class="ow"&gt;::&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In most cases, this fact is hidden behind
&lt;a href="http://hackage.haskell.org/package/mtl-2.2.1/docs/Control-Monad-Writer-Lazy.html#t:Writer"&gt;the real definition of &lt;code&gt;Writer&lt;/code&gt;&lt;/a&gt;,
though &lt;code&gt;runIdentity&lt;/code&gt; may sometimes come handy for some on-the-spot type hacks&lt;sup id="fnref:5"&gt;&lt;a class="footnote-ref" href="#fn:5" rel="footnote"&gt;5&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h4&gt;The&amp;nbsp;wrap&lt;/h4&gt;
&lt;p&gt;The many things we&amp;#8217;ve talked about here could of course be a starting point
for even more advanced stuff, but obviously we have to stop somewhere!
But don&amp;#8217;t worry: knowing about &lt;code&gt;MonadWriter&lt;/code&gt; and other monad typeclasses like this
is enough to write quite idiomatic&amp;nbsp;code&amp;#8230;&lt;/p&gt;
&lt;p&gt;&amp;#8230;at least until you learn about
&lt;a href="http://www.haskellforall.com/2012/06/you-could-have-invented-free-monads.html"&gt;free monads&lt;/a&gt;,
&lt;a href="https://ocharles.org.uk/blog/posts/2013-12-04-24-days-of-hackage-extensible-effects.html"&gt;effects&lt;/a&gt;,
and the like&amp;nbsp;;-)&lt;/p&gt;
&lt;p&gt;In any case, you can check &lt;a href="https://gist.github.com/Xion/74c39b65c591ae9615b7cf81e88a5946"&gt;this gist&lt;/a&gt;
for the complete code from this&amp;nbsp;post.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;&lt;code&gt;IO&lt;/code&gt; is still necessary due to ad-hoc network fetches and syscalls mentioned earlier.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Or at least an &lt;code&gt;Applicative&lt;/code&gt;, via the &lt;code&gt;ApplicativeDo&lt;/code&gt; &lt;span class="caps"&gt;GHC&lt;/span&gt; extension.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;The adding is done via &lt;code&gt;mappend&lt;/code&gt;, requiring &lt;code&gt;w&lt;/code&gt; to be a &lt;code&gt;Monoid&lt;/code&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:4"&gt;
&lt;p&gt;There is also the &lt;code&gt;execWriter&lt;/code&gt; variant which is actually more practical here
  as it only returns the accumulated output.&amp;#160;&lt;a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:5"&gt;
&lt;p&gt;We could, for example, use it alongside &lt;code&gt;mapWriterT&lt;/code&gt; to &amp;#8220;fix&amp;#8221; the calls to &lt;code&gt;putLn&lt;/code&gt;
  if we didn&amp;#8217;t have control over its definition.&amp;#160;&lt;a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</summary><category term="Haskell"></category><category term="Writer"></category><category term="monads"></category><category term="monad transformers"></category><category term="WriterT"></category></entry></feed>