<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Karol Kuczmarski's Blog</title><link>http://xion.io/</link><description>def code(tea):&lt;br&gt;return 42</description><atom:link href="http://xion.io/feeds/code.rss.xml" rel="self"></atom:link><lastBuildDate>Mon, 07 Mar 2016 20:36:00 -0800</lastBuildDate><item><title>Tricks with ownership in Rust</title><link>http://xion.io/post/code/rust-borrowchk-tricks.html</link><description>&lt;p&gt;&lt;em&gt;&amp;#8230;or how I learned to stop worrying and love the borrow&amp;nbsp;checker.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Having no equivalents in other languages, the &lt;a href="https://doc.rust-lang.org/book/ownership.html"&gt;borrow checker&lt;/a&gt;
is arguably the most difficult thing to come to terms with when learning Rust. It&amp;#8217;s easy to understand why it&amp;#8217;s immensely
useful, especially if you recall
&lt;a href="https://googleonlinesecurity.blogspot.com/2016/02/cve-2015-7547-glibc-getaddrinfo-stack.html"&gt;the various vulnerabities&lt;/a&gt;
stemming from memory mismanagement. But that knowledge doesn&amp;#8217;t exactly help when the compiler is whining about what
seems like a perfectly correct&amp;nbsp;code.&lt;/p&gt;
&lt;p&gt;Let&amp;#8217;s face it: it will take some time to become productive writing efficient and safe code. It&amp;#8217;s not entirely unlike
adjusting to a different paradigm such as functional programming when you&amp;#8217;ve been writing mostly imperative code.
Before that happens, though, you can use some tricks to make the transition a little&amp;nbsp;easier.&lt;/p&gt;
&lt;h4&gt;Just &lt;code&gt;clone&lt;/code&gt; it&lt;/h4&gt;
&lt;p&gt;Ideally, we&amp;#8217;d want our code to be both correct &lt;em&gt;and&lt;/em&gt; fast. But if we cannot quite get to the &amp;#8220;correctness&amp;#8221; part yet &amp;#8212;
because our program doesn&amp;#8217;t, you know, &lt;em&gt;compile&lt;/em&gt; &amp;#8212; then how about paying for it with a small (and refundable)
performance&amp;nbsp;hit?&lt;/p&gt;
&lt;p&gt;This is where the &lt;code&gt;clone&lt;/code&gt; methods comes in handy. Many problems with the borrow checker stem from trying to spread
object ownership too thin. It is a precious resource and it&amp;#8217;s not very cheap to &amp;#8220;produce&amp;#8221;, which is why good Rust code
often deals with just immutable or mutable&amp;nbsp;references.&lt;/p&gt;
&lt;p&gt;But if that proves difficult, then &amp;#8220;making more objects&amp;#8221; is a great intermediate solution. Incidentally, this is what
higher level languages are doing all the time, and often transparently. To ease the transition to Rust from
those languages, we can start off by replicating their&amp;nbsp;behavior.&lt;/p&gt;
&lt;p&gt;As an example, consider a function that tries to convert some value to &lt;code&gt;String&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;maybe_to_string&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Result&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;// omitted&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If we attempt to build upon it and create a &lt;code&gt;Vec&lt;/code&gt;tor&amp;nbsp;version:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;maybe_all_to_string&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Result&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;results&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;maybe_to_string&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="n"&gt;collect&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Some&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;results&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;find&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_err&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Err&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;results&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;()).&lt;/span&gt;&lt;span class="n"&gt;collect&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;then we&amp;#8217;ll be unpleasantly surprised by a borrow checker&amp;nbsp;error:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;error: cannot move out of borrowed content [E0507]
    Ok(results.iter().map(|r| r.ok().unwrap()).collect())
                              ^
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Much head scratching will ensue, and we may eventually find an idiomatic and efficient solution.
However, a simple stepping stone in the shape of additional &lt;code&gt;clone()&lt;/code&gt; call can help move things forward just
a little&amp;nbsp;quicker:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;#[derive(Clone)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Error&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;results&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iter&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clone&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;()).&lt;/span&gt;&lt;span class="n"&gt;collect&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The performance tradeoff is explicit, and easy to find later on with a simple &lt;code&gt;grep clone\(\)&lt;/code&gt; or similar.
When you learn to do things the Rusty way, it won&amp;#8217;t be hard to go back to your &amp;#8220;hack&amp;#8221; and fix it&amp;nbsp;properly.&lt;/p&gt;
&lt;h4&gt;Refcounting to the&amp;nbsp;rescue&lt;/h4&gt;
&lt;p&gt;Adding &lt;code&gt;clone()&lt;/code&gt; willy-nilly to make the code compile is a valid workaround when we&amp;#8217;re just learning. Sometimes, however,
even some gratuitous cloning doesn&amp;#8217;t &lt;em&gt;quite&lt;/em&gt; solve the problem, because the &lt;code&gt;clone()&lt;/code&gt; itself can become an&amp;nbsp;issue.&lt;/p&gt;
&lt;p&gt;For one, it requires our objects to implement the &lt;a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"&gt;&lt;code&gt;Clone&lt;/code&gt; trait&lt;/a&gt;.
This was apparent even in our previous example, since we had to add a &lt;code&gt;#[derive(Clone)]&lt;/code&gt; attribute to the &lt;code&gt;struct Error&lt;/code&gt;
in order to make it &lt;code&gt;clone&lt;/code&gt;-able.&lt;/p&gt;
&lt;p&gt;Fortunately, in the vast majority of cases this will be all that&amp;#8217;s necessary, as most built-in types in Rust implement
&lt;code&gt;Clone&lt;/code&gt; already. One notable exception are &lt;em&gt;function traits&lt;/em&gt; (&lt;code&gt;FnOnce&lt;/code&gt;, &lt;code&gt;Fn&lt;/code&gt;, and &lt;code&gt;FnMut&lt;/code&gt;) which are used to store
and refer to &lt;em&gt;closures&lt;/em&gt;&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;. Structures and other custom types that contain them (or those which &lt;em&gt;may&lt;/em&gt; contain them)
cannot therefore implement &lt;code&gt;Clone&lt;/code&gt; through a simple &lt;code&gt;#[derive]&lt;/code&gt; annotation:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c-Doc"&gt;/// A value that&amp;#39;s either there already&lt;/span&gt;
&lt;span class="c-Doc"&gt;/// or can be obtained by calling a function.&lt;/span&gt;
&lt;span class="cp"&gt;#[derive(Clone)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;enum&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;LazyValue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Clone&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Immediate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Deferred&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Fn&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;!-- --&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;error: the trait `core::marker::Sized` is not implemented for the type `core::ops::Fn() -&amp;gt; T + &amp;#39;static` [E0277]
    #[derive(Clone)]
             ^~~~~
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What can we do in this case, then? Well, there is yet another kind of performance concessions we can make,
and this one will likely sound familiar if you&amp;#8217;ve ever worked with a higher level language before. Instead of actually
cloning an object, you can merely increment its &lt;em&gt;reference counter&lt;/em&gt;. As the most rudimentary kind of garbage collection,
this allows to safely share the object between multiple &amp;#8220;owners&amp;#8221;, where each can behave as if it had
its own copy of&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Rust&amp;#8217;s pointer type that provides reference counting capabilities is called &lt;code&gt;std::rc::Rc&lt;/code&gt;. Conceptually, it is analogous
to &lt;code&gt;std::shared_ptr&lt;/code&gt; from C++, and it similarly keeps the refcount updated when the pointer is &amp;#8220;acquired&amp;#8221; (&lt;code&gt;clone&lt;/code&gt;-ed)
and &amp;#8220;released&amp;#8221; (&lt;code&gt;drop&lt;/code&gt;-ed). Because no data is moved around during either of those two operations, &lt;code&gt;Rc&lt;/code&gt; can refer even
to types whose size isn&amp;#8217;t known at compilation time, like abstract&amp;nbsp;closures:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;rc&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;Rc&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="cp"&gt;#[derive(Clone)]&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="k"&gt;enum&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;LazyValue&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Clone&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Immediate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;Deferred&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Rc&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Fn&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Wrapping them in &lt;code&gt;Rc&lt;/code&gt; therefore makes them &amp;#8220;cloneable&amp;#8221;. They aren&amp;#8217;t actually cloned, of course, but because of
the inherent immutability of Rust types they will appear so to any outside observer&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h4&gt;Move&amp;nbsp;it!&lt;/h4&gt;
&lt;p&gt;Ultimately, most problems with the borrow checker boil down to unskillful mixing of the two ways you handle data in Rust.
There is &lt;em&gt;ownership&lt;/em&gt;, which is passed around by moving the values; and there is &lt;em&gt;borrowing&lt;/em&gt;, which means operating
on them through&amp;nbsp;references.&lt;/p&gt;
&lt;p&gt;When you try to switch from one to the other, some friction is bound to occur. Code that uses references, for example,
has to be copiously sprinkled with &lt;code&gt;&amp;amp;&lt;/code&gt; and &lt;code&gt;&amp;amp;mut&lt;/code&gt;, and may sometimes require explicit lifetime annotations. All these
have to be added or removed, and changes like that tend to propagate quite readily to the upper layers
of the program&amp;#8217;s&amp;nbsp;logic.&lt;/p&gt;
&lt;p&gt;Therefore it is generally preferable, if at all possible, to expose &lt;span class="caps"&gt;API&lt;/span&gt; that deals with data directly
and not through references. To maintain efficiency, however, we need to learn how to move the objects through the various
stages of our algorithms. It turns out it&amp;#8217;s surprisingly easy to inadvertently borrow something, hindering the possibility
of producing a moved&amp;nbsp;value.&lt;/p&gt;
&lt;p&gt;Take our first example. The intuitively named &lt;code&gt;Vec::iter&lt;/code&gt; method produces an iterator that we can &lt;code&gt;map&lt;/code&gt; over, but does
it really go over the actual &lt;em&gt;items&lt;/em&gt; in the vector? Nope! It gives use a &lt;em&gt;reference&lt;/em&gt; to each one &amp;#8212; a borrow, if you will
&amp;#8212; which exactly why we originally had to use &lt;code&gt;clone&lt;/code&gt; to get out of this&amp;nbsp;bind.&lt;/p&gt;
&lt;p&gt;Instead, why not just get the elements themselves, by moving them out of the vector? &lt;code&gt;Vec::into_iter&lt;/code&gt; allows to do exactly&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nb"&gt;Ok&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;results&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;into_iter&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="n"&gt;unwrap&lt;/span&gt;&lt;span class="p"&gt;()).&lt;/span&gt;&lt;span class="n"&gt;collect&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and enables us to remove the &lt;code&gt;clone()&lt;/code&gt; call. The family of &lt;code&gt;into_X&lt;/code&gt; (or even just &lt;code&gt;into&lt;/code&gt;) methods can be reliably counted
on to work like that at least in the standard library. They are also part of a more-or-less official
&lt;a href="https://aturon.github.io/style/naming.html#conversions"&gt;naming convention&lt;/a&gt; that you should also follow in your own&amp;nbsp;code.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Note how this is different from function &lt;em&gt;types&lt;/em&gt;, i.e. &lt;code&gt;fn(A, B, C, ...) -&amp;gt; Ret&lt;/code&gt;. It is because plain functions
do not carry their closure environments along with them. This makes them little more than just pointers to some code,
and those can be freely &lt;code&gt;Clone&lt;/code&gt;-d (or even &lt;code&gt;Copy&lt;/code&gt;-ed).&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;If you want both shared ownership (&amp;#8220;fake cloneability&amp;#8221;) &lt;em&gt;and&lt;/em&gt; the ability to mutate the shared value,
take a look at the &lt;a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html"&gt;&lt;code&gt;RefCell&lt;/code&gt; type&lt;/a&gt; and how it can be
&lt;a href="http://doc.rust-lang.org/nightly/book/choosing-your-guarantees.html#composition"&gt;wrapped in &lt;code&gt;Rc&lt;/code&gt;&lt;/a&gt; to achieve both.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Mon, 07 Mar 2016 20:36:00 -0800</pubDate><guid>tag:xion.io,2016-03-07:post/code/rust-borrowchk-tricks.html</guid><category>Rust</category><category>borrow checker</category><category>reference counting</category><category>traits</category></item><item><title>Requirements for Python’s pip</title><link>http://xion.io/post/code/python-pip-requirements.html</link><description>&lt;p&gt;In this post I&amp;#8217;ll describe all (hopefully all!) the various ways you can specify a single dependency for a Python&amp;nbsp;package.&lt;/p&gt;
&lt;p&gt;This assumes &lt;em&gt;pip&lt;/em&gt; is used for installation. The list of dependencies then goes either in &lt;code&gt;install_requires=&lt;/code&gt;
parameter of the &lt;code&gt;setup&lt;/code&gt; function within &lt;em&gt;setup.py&lt;/em&gt;, or as a separate &lt;em&gt;requirements.txt&lt;/em&gt; file. Commonly, it will actually
go in both places, with the latter being the canonical source of&amp;nbsp;truth:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;setuptools&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;setup&lt;/span&gt;

&lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;requirements.txt&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;rf&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;setup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="c"&gt;# ...&lt;/span&gt;
        &lt;span class="n"&gt;install_requires&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;rf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readlines&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;More details about this approach can be found in
&lt;a href="http://xion.org.pl/2014/01/27/anathomy-of-a-python-package/"&gt;one of my previous posts&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here, I will concentrate on the format of a single line in &lt;em&gt;requirements.txt&lt;/em&gt; that defines a dependency.
There are numerous variants that &lt;em&gt;pip&lt;/em&gt; supports, and they are all described in excruciating detail in
&lt;a href="https://www.python.org/dev/peps/pep-0440/"&gt;&lt;span class="caps"&gt;PEP&lt;/span&gt; 440&lt;/a&gt;. This post shall serve as a short reference on the most useful&amp;nbsp;ones.&lt;/p&gt;
&lt;h4&gt;Package name (and&amp;nbsp;version)&lt;/h4&gt;
&lt;p&gt;The simplest and most common option is to identify a dependency by its package&amp;nbsp;name:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;SQLAlchemy
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This will locate it in a global index of packages, which is sometimes called a &amp;#8220;cheese shop&amp;#8221;. Currently,
by far the most popular package registry for Python is &lt;a href="https://pypi.python.org"&gt;PyPI&lt;/a&gt;, and &lt;em&gt;pip&lt;/em&gt; uses it by default&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Without any further modifiers, &lt;em&gt;pip&lt;/em&gt; will download and install the &amp;#8220;current&amp;#8221; version of the package &amp;#8212; either the newest,
or the one designated explicitly by a maintainer. This obviously makes the dependency somewhat unpredictable,
for it can mean unintended upgrades that introduce breaking changes to your&amp;nbsp;code.&lt;/p&gt;
&lt;p&gt;To prevent this, you&amp;#8217;d normally &lt;em&gt;pin&lt;/em&gt; the dependency to an exact version&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;SQLAlchemy==0.9.10
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Other comparison operators are also&amp;nbsp;available:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;SQLAlchemy&amp;gt;=0.9.10
SQLAlchemy&amp;lt;1.0.0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and can even be&amp;nbsp;combined:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;SQLAlchemy&amp;gt;=0.9,&amp;lt;1.0.0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Specs like that will make &lt;em&gt;pip&lt;/em&gt; find the newest version that&amp;#8217;s within given range. Assuming your dependency follows
the &lt;a href="http://semver.org/"&gt;semantic versioning&lt;/a&gt; scheme, this will allow you to stay on top of any minor bugfixes
and improvements to an older release (0.9.x here), without the risk of accidentally upgrading to a new one (1.x)
that your code is not compatible with&amp;nbsp;yet.&lt;/p&gt;
&lt;h4&gt;Repository &lt;span class="caps"&gt;URL&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;Sometimes you want to live on the bleeding edge, though, and depend not just on the latest &lt;em&gt;release&lt;/em&gt;,
but the head &lt;em&gt;commit&lt;/em&gt; to the package&amp;#8217;s repository. This makes sense especially in large systems
that are distributed among multiple repos, and where development happens in&amp;nbsp;lockstep.&lt;/p&gt;
&lt;p&gt;For those occasions, and a few others, &lt;em&gt;pip&lt;/em&gt; can recognize direct repository URLs. They are in the&amp;nbsp;format:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;$VCS+$PROTOCOL://$URL@$LABEL#egg=$PACKAGE
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;where the &lt;code&gt;$PROTOCOL&lt;/code&gt; part can be optional if the version control system has a default there. That&amp;#8217;s for example
the case for &lt;code&gt;git&lt;/code&gt;, which is of course the most important &lt;span class="caps"&gt;VCS&lt;/span&gt; you&amp;#8217;d be interested in&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;git://git.example.com/somepackage#egg=somepackage
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that the &lt;code&gt;#egg=$PACKAGE&lt;/code&gt; part is not a part of the &lt;code&gt;$URL&lt;/code&gt;, and it&amp;#8217;s only there to give a local name for the package
distribution. This is what makes it possible to refer to it later via &lt;em&gt;pip&lt;/em&gt;, if only to remove it with
&lt;code&gt;pip uninstall $PACKAGE&lt;/code&gt;.
Of course, the sanest practice is to use the PyPI moniker if&amp;nbsp;possible.&lt;/p&gt;
&lt;p&gt;When no &lt;code&gt;$LABEL&lt;/code&gt; is given, &lt;em&gt;pip&lt;/em&gt; will use the &lt;span class="caps"&gt;HEAD&lt;/span&gt;, trunk, tip, or the equivalent default/current revision from the repo.
Often though (at least in case of Git), you would also pick a branch, tag, or even a particular &lt;em&gt;commit hash&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;git+https://github.com/Xion/unmatcher.git@0.1.3.1#egg=unmatcher
git+ssh://github.com/You/yourpackage.git@master#egg=yourpackage
git+https://github.com/mitsuhiko/jinja2.git@5b498453b5898257b2287f14ef6c363799f1405a#egg=Jinja2
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The last two options could be a good choice even with third party packages, when you don&amp;#8217;t want to wait for a new PyPI
release to get a necessary feature or an urgent bug&amp;nbsp;fix.&lt;/p&gt;
&lt;h4&gt;Local&amp;nbsp;filesystem&lt;/h4&gt;
&lt;p&gt;Lastly, you can ask &lt;em&gt;pip&lt;/em&gt; to install a package from a local directory or archive. The former option is often used
with the &lt;code&gt;-e&lt;/code&gt; (&lt;code&gt;--editable&lt;/code&gt;) flag for &lt;code&gt;pip install&lt;/code&gt;. This installs the package in the so-called &lt;em&gt;development mode&lt;/em&gt;,
allowing you to edit its source code&amp;nbsp;in-place:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;$ pip install -e /home/me/Code/myotherpackage
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You almost certainly don&amp;#8217;t want to put this line in &lt;em&gt;requirements.txt&lt;/em&gt;: you should still be pulling the other package
from PyPI. But if it&amp;#8217;s your own one  &amp;#8212; maybe a self-contained utility library used by your main program &amp;#8212;
this setup will be very helpful for making changes to it, informed by your own usage of the&amp;nbsp;package.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;This can be changed with &lt;code&gt;--index_url&lt;/code&gt; flag to &lt;code&gt;pip install&lt;/code&gt;. Running local indexes is a good practice
for Python shops, especially those that rely on &lt;code&gt;pip install&lt;/code&gt; as part of their deployment process.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;If the package uses &lt;a href="http://semver.org/"&gt;semantic versioning&lt;/a&gt;, a possible alternative to &lt;code&gt;==&lt;/code&gt; is &lt;code&gt;~=&lt;/code&gt;,
which means &amp;#8220;compatible&amp;#8221; version. The precise meaning of this is
&lt;a href="https://www.python.org/dev/peps/pep-0440/#compatible-release"&gt;somewhat complicated&lt;/a&gt;, but it roughly means that upgrades
are permitted as long as nothing in the public interface changes.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;&lt;a href="https://pip.pypa.io/en/latest/reference/pip_install/#vcs-support"&gt;Other options&lt;/a&gt; include &lt;code&gt;hg&lt;/code&gt; (Mercurial),
&lt;code&gt;svn&lt;/code&gt;, and &lt;code&gt;bzr&lt;/code&gt; (Bazaar).&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Sun, 21 Feb 2016 09:01:00 -0800</pubDate><guid>tag:xion.io,2016-02-21:post/code/python-pip-requirements.html</guid><category>Python</category><category>pip</category><category>packages</category><category>dependencies</category></item><item><title>Moving out of a container in Rust</title><link>http://xion.io/post/code/rust-move-out-of-container.html</link><description>&lt;p&gt;To prevent the kind of memory errors that plagues many C programs,
the &lt;a href="https://doc.rust-lang.org/book/ownership.html"&gt;&lt;em&gt;borrow checker&lt;/em&gt; in Rust&lt;/a&gt; tracks how data is moved between variables,
or accessed via references. This is all done at compile time, with zero runtime overhead, and is a sizeable part
of Rust&amp;#8217;s value&amp;nbsp;offering.&lt;/p&gt;
&lt;p&gt;Like all rigid and automated systems, however, it is necessarily constrained and cannot handle all situations perfectly.
One of its limitations is treating all objects as &lt;em&gt;atomic&lt;/em&gt;. It&amp;#8217;s impossible for a variable to own a part of some bigger
structure, neither is it possible to maintain mutable references to two or more elements of a&amp;nbsp;collection.&lt;/p&gt;
&lt;p&gt;If we nonetheless &lt;a href="http://is.gd/yWCYmJ"&gt;try&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;get_name&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;vec&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;John&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_owned&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Smith&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_owned&lt;/span&gt;&lt;span class="p"&gt;()];&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;we&amp;#8217;ll be served with a classic borrow checker&amp;nbsp;error:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;lt;anon&amp;gt;:3:25: 3:33 error: cannot move out of indexed content [E0507]
&amp;lt;anon&amp;gt;:3     let fullname = join(names[0], names[1]);
                                 ^~~~~~~~
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Behind its rather cryptic verbiage, it informs us that we tried to move a &lt;em&gt;part&lt;/em&gt; of the &lt;code&gt;names&lt;/code&gt; vector &amp;#8212; its first
element &amp;#8212; to a new variable (here, a function parameter). This isn&amp;#8217;t allowed, because in principle it would
render the vector invalid from the standpoint of strict memory safety. Rust would no longer guarantee &lt;code&gt;names[0]&lt;/code&gt; to be
a legal &lt;code&gt;String&lt;/code&gt;: its internal pointer could&amp;#8217;ve been invalidated by the code which the element moved to
(the &lt;code&gt;join&lt;/code&gt; function)&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;But while commendable, this guarantee isn&amp;#8217;t exactly &lt;em&gt;useful&lt;/em&gt; here. Even though &lt;code&gt;names[0]&lt;/code&gt; would technically be invalid,
there isn&amp;#8217;t anyone to actually notice this fact. The &lt;code&gt;names&lt;/code&gt; vector is inaccessible outside of the function
it&amp;#8217;s defined in, and even the function itself doesn&amp;#8217;t look at it after the move. In its present form,
the program is inarguably correct: Rust&amp;#8217;s borrow checker is just incapable of ascertaining&amp;nbsp;it.&lt;/p&gt;
&lt;h4&gt;Pointers to the&amp;nbsp;rescue?&lt;/h4&gt;
&lt;p&gt;Vectors wouldn&amp;#8217;t be very useful or efficient, though, if we could only obtain &lt;a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"&gt;copies&lt;/a&gt; or &lt;a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"&gt;clones&lt;/a&gt; of their elements.
As this is an inherent limitation of Rust&amp;#8217;s memory model, and applies to &lt;em&gt;all&lt;/em&gt; compound types
(structs, hashmaps, etc.), it&amp;#8217;s been recognized and countermeasures are&amp;nbsp;available.&lt;/p&gt;
&lt;p&gt;However, the &lt;a href="http://is.gd/o3GRnw"&gt;idiomatic practice&lt;/a&gt; is to actually leave the elements be and access them
solely through&amp;nbsp;references:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;get_name&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;vec&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;John&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_owned&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Smith&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_owned&lt;/span&gt;&lt;span class="p"&gt;()];&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clone&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The obvious downside of this approach is that it requires an interface change to &lt;code&gt;join&lt;/code&gt;: it now has to accept
pointers instead of actual objects&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;. And since the result is a completely new &lt;code&gt;String&lt;/code&gt;, we have to either bite
the bullet and &lt;code&gt;clone&lt;/code&gt;, or write a more awkward &lt;code&gt;join_into(a: &amp;amp;mut String, b: &amp;amp;String)&lt;/code&gt; function.&lt;br/&gt;
In general, making an &lt;span class="caps"&gt;API&lt;/span&gt; switch from actual objects to references has an annoying tendency to percolate up
the call stacks and abstraction&amp;nbsp;layers.&lt;/p&gt;
&lt;h4&gt;Vector&amp;nbsp;solution&lt;/h4&gt;
&lt;p&gt;If we still insist on moving the elements out, at least in case of vector we aren&amp;#8217;t &lt;em&gt;completely&lt;/em&gt; out of luck.
The &lt;code&gt;Vec&lt;/code&gt; type offers several specialized methods that can slice, dice, and splice the collection in various ways.
Those&amp;nbsp;include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_first"&gt;&lt;code&gt;split_first&lt;/code&gt;&lt;/a&gt; (and &lt;code&gt;split_first_mut&lt;/code&gt;)
for cutting right after the first&amp;nbsp;element&lt;/li&gt;
&lt;li&gt;&lt;a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_last"&gt;&lt;code&gt;split_last&lt;/code&gt;&lt;/a&gt; (and &lt;code&gt;split_last_mut&lt;/code&gt;)
for a similar cut right before the last&amp;nbsp;element&lt;/li&gt;
&lt;li&gt;&lt;a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_at"&gt;&lt;code&gt;split_at&lt;/code&gt;&lt;/a&gt; (and &lt;code&gt;split_at_mut&lt;/code&gt;),
generalized versions of the above&amp;nbsp;methods&lt;/li&gt;
&lt;li&gt;&lt;a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.split_off"&gt;&lt;code&gt;split_off&lt;/code&gt;&lt;/a&gt;, a partially-in-place version
of &lt;code&gt;split_at_mut&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.drain"&gt;&lt;code&gt;drain&lt;/code&gt;&lt;/a&gt; for moving all elements from a specified&amp;nbsp;range&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Other types may offer different methods, depending on their particular data layout, though &lt;code&gt;drain&lt;/code&gt; should be available
on any data structure that can be iterated&amp;nbsp;over.&lt;/p&gt;
&lt;h4&gt;Structural&amp;nbsp;advantage&lt;/h4&gt;
&lt;p&gt;What about user-defined types, such as &lt;code&gt;struct&lt;/code&gt;s?&lt;/p&gt;
&lt;p&gt;Fortunately, these are covered by the compiler itself. Since accessing &lt;code&gt;struct&lt;/code&gt; fields is a fully compile-time
operation, it is possible to track the ownership of each individual object that makes up the structure.
Thus there are no obstacles to simply &lt;a href="http://is.gd/ZUI2Mn"&gt;moving all the fields&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;get_name&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;John&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_owned&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;                   &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Smith&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_owned&lt;/span&gt;&lt;span class="p"&gt;()};&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;If all else&amp;nbsp;fails&amp;#8230;&lt;/h4&gt;
&lt;p&gt;This leaves us with some rare cases when the container&amp;#8217;s interface doesn&amp;#8217;t &lt;em&gt;quite&lt;/em&gt; support the exact subset of elements
we want to move out. If we don&amp;#8217;t want to &lt;code&gt;drain&lt;/code&gt; them all and inspect every item for potential preservation,
it may be time to skirt around the more dangerous areas of the&amp;nbsp;language.&lt;/p&gt;
&lt;p&gt;But I don&amp;#8217;t necessarily mean going all out with &lt;code&gt;unsafe&lt;/code&gt; blocks, pointers, and (let&amp;#8217;s be honest) segfaults.
Instead, we can look at the gray zone between them and the regular, borrow-checked Rust&amp;nbsp;code.&lt;/p&gt;
&lt;p&gt;Some of the functions inside the &lt;a href="https://doc.rust-lang.org/std/mem/index.html"&gt;&lt;code&gt;std::mem&lt;/code&gt; module&lt;/a&gt; can be said
to fall into this category. Most notably, &lt;a href="https://doc.rust-lang.org/std/mem/fn.swap.html"&gt;&lt;code&gt;mem::swap&lt;/code&gt;&lt;/a&gt; and
&lt;a href="https://doc.rust-lang.org/std/mem/fn.replace.html"&gt;&lt;code&gt;mem::replace&lt;/code&gt;&lt;/a&gt; allow us to operate directly on the memory blocks
that back every Rust object, albeit without the dangerous ability to freely modify&amp;nbsp;them.&lt;/p&gt;
&lt;p&gt;What those functions enable is a small sleight of hand &amp;#8212; a quick exchange of two variables or objects
while the borrow checker &amp;#8220;isn&amp;#8217;t looking&amp;#8221;. Possessing such an ability, we can smuggle any item out of a container
as long as we&amp;#8217;re able to provide a suitable&amp;nbsp;replacement:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;std&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;mem&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="c-Doc"&gt;/// Pick only the items under indices that are powers of two.&lt;/span&gt;
&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;pick_powers_of_2&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Default&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Vec&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;elem&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;mem&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;replace&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="k"&gt;mut&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;v&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;default&lt;/span&gt;&lt;span class="p"&gt;());&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;elem&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p style="text-align: center"&gt;
    &lt;img src="http://xion.io/images/indyswap.jpg" alt="Swap!"&gt;&lt;/br&gt;
    &lt;small&gt;Pictured: implementation of &lt;code&gt;mem::replace&lt;/code&gt;.&lt;/small&gt;
&lt;/p&gt;

&lt;p&gt;&lt;a href="https://doc.rust-lang.org/std/default/trait.Default.html#tymethod.default"&gt;The &lt;code&gt;Default&lt;/code&gt; value&lt;/a&gt;,
if available, is usually a great choice here. Alternately, a &lt;code&gt;Copy&lt;/code&gt; or &lt;code&gt;Clone&lt;/code&gt; of some other element can also work
if it&amp;#8217;s cheap to&amp;nbsp;obtain.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;In Rust jargon, it is sometimes said that the object has been &amp;#8220;consumed&amp;#8221; there.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;For &lt;code&gt;String&lt;/code&gt;s specifically, the usual practice is to require a more generic &lt;code&gt;&amp;amp;str&lt;/code&gt; type (string slice)
instead of &lt;code&gt;&amp;amp;String&lt;/code&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Fri, 05 Feb 2016 00:18:00 -0800</pubDate><guid>tag:xion.io,2016-02-05:post/code/rust-move-out-of-container.html</guid><category>Rust</category><category>vector</category><category>borrow checker</category><category>references</category></item><item><title>Retry idiom for Python</title><link>http://xion.io/post/code/python-retry-idiom.html</link><description>&lt;p&gt;A relatively little known feature of Python is the &lt;code&gt;else&lt;/code&gt; block for control flow statements other than &lt;code&gt;if&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;If you haven&amp;#8217;t heard about it before, you can provide such a block for both &lt;code&gt;while&lt;/code&gt; and &lt;code&gt;for&lt;/code&gt; loops,
as well as any variant of the &lt;code&gt;try&lt;/code&gt; statement, Its functionality is roughly analogous in both&amp;nbsp;cases:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;in loops, the &lt;code&gt;else&lt;/code&gt; block is executed if the loop didn&amp;#8217;t exit abnormally (i.e. with &lt;code&gt;break&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;in &lt;code&gt;try&lt;/code&gt; constructs, the &lt;code&gt;else&lt;/code&gt; block runs if &lt;em&gt;no&lt;/em&gt; exception&amp;nbsp;happened&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Likely because of the unique semantics that don&amp;#8217;t exist in other languages, neither of those constructs has been seen much
in real world code. Recently, however, I&amp;#8217;ve found they can be combined into a very pythonic pattern
that&amp;#8217;s also quite&amp;nbsp;useful.&lt;/p&gt;
&lt;h4&gt;The&amp;nbsp;trick&lt;/h4&gt;
&lt;p&gt;Say you have a task that won&amp;#8217;t always succeed. Perhaps it&amp;#8217;s a request made to a janky server, or other network operartion
that&amp;#8217;s prone to timeouts. Since failures are likely to be transient, you&amp;#8217;d like to retry it several more times before
giving up&amp;nbsp;permanently.&lt;/p&gt;
&lt;p&gt;With &lt;code&gt;try&lt;/code&gt;/&lt;code&gt;except&lt;/code&gt; block, you can detect those half-expected failures. With a simple loop, you can repeat the attempt
for as many times as you deem feasible. Combined, they can solve the problem rather&amp;nbsp;neatly:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MAX_RETRIES&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# ... do stuff ...&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;SomeTransientError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# ... log it, sleep, etc. ...&lt;/span&gt;
        &lt;span class="k"&gt;continue&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;break&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;PermanentError&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;But&amp;nbsp;why?&lt;/h4&gt;
&lt;p&gt;What&amp;#8217;s the deal with the &lt;code&gt;else&lt;/code&gt;s here, though? Are they both&amp;nbsp;necessary?&lt;/p&gt;
&lt;p&gt;The simple answer is of course no. &lt;code&gt;else&lt;/code&gt; after either a loop or  &lt;code&gt;try&lt;/code&gt;/&lt;code&gt;except&lt;/code&gt; block is always a &lt;em&gt;syntactic sugar&lt;/em&gt;.
Any code that contains it can be transformed into an equivalent snippet that utilizes different techniques to achieve
the same&amp;nbsp;effect.&lt;/p&gt;
&lt;p&gt;But this view isn&amp;#8217;t very useful, for many of the essential features in any programming languages can be dismissed
as superfluous using this reasoning. The real question is whether the above idiom is more readable and understandable
than the&amp;nbsp;alternatives.&lt;/p&gt;
&lt;p&gt;To that, I posit, the answer is: &lt;em&gt;absolutely&lt;/em&gt;.&lt;/p&gt;
&lt;h4&gt;Desugaring&lt;/h4&gt;
&lt;p&gt;Without the double &lt;code&gt;else&lt;/code&gt;, this example would have to be written in a considerably more convoluted&amp;nbsp;way:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;retries&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MAX_RETRIES&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="n"&gt;retries&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# ... do stuff ...&lt;/span&gt;
        &lt;span class="k"&gt;break&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;SomeTransientError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# ... log it, sleep, etc. ...&lt;/span&gt;
        &lt;span class="n"&gt;retries&lt;/span&gt; &lt;span class="o"&gt;-=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;retries&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;PermanentError&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Although at first glance the difference may be minuscule, this version adds significant extra busywork the programmer
has to pay careful attention&amp;nbsp;to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;retries&lt;/code&gt; variable now has to be explicit, because the final conditional statement must look at its&amp;nbsp;value.&lt;/li&gt;
&lt;li&gt;We can&amp;#8217;t use a &lt;code&gt;for&lt;/code&gt; loop anymore (e.g. &lt;code&gt;for retries in range(MAX_RETRIES)&lt;/code&gt;), because we wouldn&amp;#8217;t distinguish the
&amp;#8220;success at last try&amp;#8221; and &amp;#8220;retry limit exceeded&amp;#8221; cases: they&amp;#8217;d both result in &lt;code&gt;retries&lt;/code&gt; equal to &lt;code&gt;MAX_RETRIES - 1&lt;/code&gt;
after the loop&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/li&gt;
&lt;li&gt;As a result, we have to remember to decrement the counter ourselves upon an&amp;nbsp;error.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Additionally, the &lt;code&gt;break&lt;/code&gt; is easy to miss amidst the actual logic within the &lt;code&gt;try&lt;/code&gt; block, both for developer
who writes the code and for any subsequent readers. An alternative is to move it outside of the &lt;code&gt;try&lt;/code&gt;/&lt;code&gt;except&lt;/code&gt; clause,
but that in turn reintroduces &lt;code&gt;continue&lt;/code&gt; into the &lt;code&gt;except&lt;/code&gt; branch and further complicates the whole&amp;nbsp;flow.&lt;/p&gt;
&lt;p&gt;In short, the desugared version is more error-prone (all those off-by-ones!) and also quite&amp;nbsp;inscrutable.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Or to &lt;code&gt;1&lt;/code&gt;, if we count from &lt;code&gt;MAX_RETRIES&lt;/code&gt; down to zero.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Wed, 27 Jan 2016 17:48:00 -0800</pubDate><guid>tag:xion.io,2016-01-27:post/code/python-retry-idiom.html</guid><category>Python</category><category>exceptions</category><category>else</category></item><item><title>Rust: first impressions</title><link>http://xion.io/post/code/rust-first-impressions.html</link><description>&lt;p&gt;Having recently been writing some C++ code at work, I had once again experienced the kind of exasperation that this
cumbersome language evokes on regular basis. When I was working in it less sporadically, I was shrugging it off
and telling myself it&amp;#8217;s all because of the low level it operates on. Superior performance was the other side of the deal,
and it was supposed to make all the trade-offs&amp;nbsp;worthwhile.&lt;/p&gt;
&lt;p&gt;Now, however, I realized that running close to the metal by no means excuses the sort of clunkiness that C++ permits.
For example, there really is no reason why the archaically asinine separation of header &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; source files &amp;#8212;
with its inevitable redundancy of declarations and definitions, worked around with Java-esque contraptions such as
&lt;a href="http://c2.com/cgi/wiki?PimplIdiom"&gt;pimpl&lt;/a&gt; &amp;#8212; is still the bread and butter of C++ programs.&lt;br/&gt;
Same goes for the lack of sane dependency management, or a universal, portable build system. None of those would be
at odds with native compilation to machine code, or runtime speeds that are adequate for real-time&amp;nbsp;programs.&lt;/p&gt;
&lt;p&gt;Rather than dwelling on those gripes, I thought it&amp;#8217;d be more productive to look around and see what&amp;#8217;s
the modern offerring in the domain of lower level, &lt;em&gt;really&lt;/em&gt; fast languages. The search wasn&amp;#8217;t long at all, because
right now it seems there is just one viable contender: Rust&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h4&gt;Rusty&amp;nbsp;systems&lt;/h4&gt;
&lt;p&gt;&lt;a href="https://www.rust-lang.org"&gt;Rust&lt;/a&gt; introduces itself as a
&lt;a href="https://en.wikipedia.org/wiki/System_programming_language"&gt;&amp;#8220;systems programming language&amp;#8221;&lt;/a&gt;, which is quite a bold claim.
What followed the last time this phrase has been applied to an emerging language &amp;#8212; Go &amp;#8212; was a kind of
&lt;a href="https://www.quora.com/Of-the-emerging-systems-languages-Rust-D-Go-and-Nim-which-is-the-strongest-language-and-why"&gt;word twisting&lt;/a&gt;
that&amp;#8217;s more indicative of politics, not computer&amp;nbsp;science.&lt;/p&gt;
&lt;p&gt;But Rust&amp;#8217;s pretense to the system level is well justified. It clearly provides the requisite toolkit for working
directly with the hardware, be it &lt;a href="https://github.com/miselin/rustic"&gt;embedded controllers&lt;/a&gt; or
&lt;a href="http://www.redox-os.org/"&gt;fully featured computers&lt;/a&gt;. It offers compilation to native machine code;
direct memory access; running time guarantees thanks to the lack of &lt;span class="caps"&gt;GC&lt;/span&gt;-incuded stops;
and great interoperability through static and dynamic&amp;nbsp;linkage.&lt;/p&gt;
&lt;p&gt;In short, with Rust you can wreak havoc against the &lt;span class="caps"&gt;RAM&lt;/span&gt; and twiddle bits to your heart&amp;#8217;s&amp;nbsp;content.&lt;/p&gt;
&lt;h4&gt;Safe and&amp;nbsp;sound&lt;/h4&gt;
&lt;p&gt;To be fair, though, the &amp;#8220;havoc&amp;#8221; part is not entirely accurate. Despite its focus on the low level, efficient computing,
Rust aims to be a very safe language. Unlike C, it actively tries to prevent the programmer from shooting themselves
in the foot &amp;#8212; though it will hand you the gun if you but ask for&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;The safety guarantees provided by Rust apply to resource management, with the specific emphasis on memory
and pointers to it. The way that most contemporary languages deal with memory is by introducing a &lt;em&gt;garbage collector&lt;/em&gt;
which mostly (though not wholly) relieves the programmer from thinking about allocations and deallocations.
However, the kind of global, stop-the-world garbage collections
(e.g. &lt;a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection#Na.C3.AFve_mark-and-sweep"&gt;mark-and-sweep&lt;/a&gt;)
is costly and unpredictable, ruling it out as a mechanism for real-time&amp;nbsp;systems.&lt;/p&gt;
&lt;p&gt;For this reason, Rust doesn&amp;#8217;t mandate a &lt;span class="caps"&gt;GC&lt;/span&gt; of this kind&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;. And although it offers mechanisms that are similar to
smart pointers from C++ (e.g. &lt;code&gt;std::shared_ptr&lt;/code&gt;), it is actually preferrable and &lt;em&gt;safer&lt;/em&gt; to use regular, &amp;#8220;naked&amp;#8221; pointers:
&lt;code&gt;&amp;amp;Foo&lt;/code&gt; versus &lt;code&gt;Cell&amp;lt;Foo&amp;gt;&lt;/code&gt; or &lt;code&gt;RefCell&amp;lt;Foo&amp;gt;&lt;/code&gt; (which are some of the Rust&amp;#8217;s &amp;#8220;smart pointer&amp;#8221;&amp;nbsp;types).&lt;/p&gt;
&lt;p&gt;The trick is in the clever compiler. As long as we use regular pointers, it is capable of detecting potential memory
bugs at &lt;em&gt;compilation time&lt;/em&gt;. They are referred to as &amp;#8220;data races&amp;#8221; in Rust&amp;#8217;s terminology, and include
&lt;a href="https://doc.rust-lang.org/stable/book/references-and-borrowing.html#issues-borrowing-prevents"&gt;perennial problems&lt;/a&gt;
that will segfault any C code which wasn&amp;#8217;t written with utmost&amp;nbsp;care.&lt;/p&gt;
&lt;p&gt;Part of those safety guarantees is also the &lt;em&gt;default immutability&lt;/em&gt; of references (pointers). The simplest reference
of type &lt;code&gt;&amp;amp;Foo&lt;/code&gt; in Rust translates to something like &lt;code&gt;const Foo * const&lt;/code&gt; in C&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;. You have to explicitly request
mutability with the &lt;code&gt;mut&lt;/code&gt; keyword, and Rust ensures there is always at most one mutable reference to any value,
thus preventing problems caused by &lt;a href="https://en.wikipedia.org/wiki/Pointer_aliasing"&gt;pointer aliasing&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;But what if you really must sling raw pointers, and access arbitrary memory locations? Maybe you are programming
a microcontroller where I/O is done through a special memory region. For those occassions, Rust has got you covered
with the &lt;code&gt;unsafe&lt;/code&gt; keyword:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;// Read the state of a diode in some imaginary uC.&lt;/span&gt;
&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;get_led_state&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;isize&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;bool&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;assert&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;There are FOUR lights!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="kr"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u8&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mh"&gt;0x1234&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;as&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="kr"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;u8&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// known memory location&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;unsafe&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;offset&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;!=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Its usage, like in the above example, can be &lt;em&gt;very&lt;/em&gt; localized, limited only to those places where it&amp;#8217;s truly necessary
and guarded by appropriate checks. As a result, the interface exposed by a function like the one above
can be considered safe. The unrestricted memory access can be contained to where it&amp;#8217;s really&amp;nbsp;inevitable.&lt;/p&gt;
&lt;h4&gt;Typing&amp;nbsp;counts&lt;/h4&gt;
&lt;p&gt;Ensuring memory safety is not the only way in which Rust differentiates itself from C.
What separates those two languages is also a few decades of practice and research into programming semantics.
It&amp;#8217;s only natural to expect Rust to take advantage of this&amp;nbsp;progress.&lt;/p&gt;
&lt;p&gt;And advantage it takes. Although Rust&amp;#8217;s type system isn&amp;#8217;t nearly as advanced and complex like &amp;#8212; say &amp;#8212; Scala&amp;#8217;s,
it exhibits several interesting properties that are indicative of its relatively modern&amp;nbsp;origin.&lt;/p&gt;
&lt;p&gt;First, it mixes the two most popular programming paradigms &amp;#8212; functional and object-oriented &amp;#8212; in roughly equal
concentrations, as opposed to being biased towards the latter. Rust doesn&amp;#8217;t have interfaces or classes: it has &lt;em&gt;traits&lt;/em&gt;
and their &lt;em&gt;implementations&lt;/em&gt;. Even though they often fulfill similar purposes of abstraction and encapsulation,
these constructs are closer to the concepts of &lt;a href="https://en.wikipedia.org/wiki/Type_class"&gt;type classes&lt;/a&gt;
and their instances, which are found for example in&amp;nbsp;Haskell.&lt;/p&gt;
&lt;p&gt;Still, the more familiar notions of &lt;span class="caps"&gt;OOP&lt;/span&gt; aren&amp;#8217;t too far off. Most of the key functionality of classes, for example,
can be simulated by implementing &amp;#8220;default&amp;#8221; traits for user-defined&amp;nbsp;types:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;struct&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="k"&gt;impl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="kt"&gt;str&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="kt"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_string&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;fn&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;greet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;println&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Hello, {}!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;

&lt;span class="c1"&gt;// usage&lt;/span&gt;
&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;John&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Doe&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;greet&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The second aspect of Rust&amp;#8217;s type system that we would come to expect from a new language is its expressive power.
&lt;em&gt;Type inference&lt;/em&gt; is nowadays a staple, and above we can observe the simplest form of it. But it extends further,
to generic parameters, closure arguments, and closure return&amp;nbsp;values.&lt;/p&gt;
&lt;p&gt;Generics, by the way, are quite nice as well. Besides their applicability to structs, type aliases, functions,
traits, trait implementations, etc., they allow for constraining their arguments with traits. This is similar to
the abandoned-and-not-quite-revived-yet idea of &lt;a href="https://en.wikipedia.org/wiki/Concepts_%28C%2B%2B%29"&gt;concepts in C++&lt;/a&gt;,
or to an analogous mechanism from&amp;nbsp;C#.&lt;/p&gt;
&lt;p&gt;The third common trend in contemporary language design is to use the type system to solve common tasks.
Rust doesn&amp;#8217;t go full Haskell and opt for monads for everything, but its &lt;code&gt;Option&lt;/code&gt; and &lt;code&gt;Result&lt;/code&gt; types are evidently
the functional approach to error handling&lt;sup id="fnref:4"&gt;&lt;a class="footnote-ref" href="#fn:4" rel="footnote"&gt;4&lt;/a&gt;&lt;/sup&gt;. To facilitate their use, a powerful
&lt;a href="https://doc.rust-lang.org/stable/book/patterns.html"&gt;&lt;em&gt;pattern matching&lt;/em&gt; facility&lt;/a&gt; is also present in&amp;nbsp;Rust.&lt;/p&gt;
&lt;h4&gt;Unexpectedly&amp;nbsp;pythonic&lt;/h4&gt;
&lt;p&gt;If your general go-to language is Python, you will find Rust a very nice complement and possibly a valuable weapon
in your coding arsenal. Interoperability between Python and Rust is
&lt;a href="https://doc.rust-lang.org/stable/book/rust-inside-other-languages.html#python"&gt;stupidly easy&lt;/a&gt;,
thanks to both the &lt;a href="https://docs.python.org/3.5/library/ctypes.html"&gt;&lt;code&gt;ctypes&lt;/code&gt; module&lt;/a&gt; and the extreme simplicity
of creating portable,
&lt;a href="https://doc.rust-lang.org/stable/book/rust-inside-other-languages.html#a-rust-library"&gt;shared libraries&lt;/a&gt; in Rust.
Offloading some expensive, &lt;a href="https://wiki.python.org/moin/GlobalInterpreterLock"&gt;&lt;span class="caps"&gt;GIL&lt;/span&gt;&lt;/a&gt;-bypassing computation to a fast,
native code written in Rust can thus be a relatively painless way of speeding up crucial parts of a Python&amp;nbsp;program.&lt;/p&gt;
&lt;p&gt;But somewhat more surprisingly, Rust has quite a few bits that seem to be directly inspired by Python semantics.
Granted, those two languages are conceptually pretty far apart in general, but the analogies are&amp;nbsp;there:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The concept of &lt;a href="https://doc.rust-lang.org/stable/book/iterators.html"&gt;iterators&lt;/a&gt; in Rust is very similar to
&lt;a href="https://docs.python.org/2/glossary.html#term-iterable"&gt;iterables&lt;/a&gt; in Python. Even the &lt;code&gt;for&lt;/code&gt; loop is basically identical:
rather than manually increment a counter, both in &lt;a href="https://doc.rust-lang.org/stable/book/loops.html#for"&gt;Rust&lt;/a&gt;
and &lt;a href="https://wiki.python.org/moin/ForLoop"&gt;Python&lt;/a&gt; you iterate over a &lt;em&gt;range of numbers&lt;/em&gt;.&lt;br/&gt;
Oh, and both languages have an &lt;code&gt;enumerate&lt;/code&gt; &lt;a href="https://doc.rust-lang.org/stable/book/loops.html#enumerate"&gt;method&lt;/a&gt;/
&lt;a href="https://docs.python.org/2/library/functions.html#enumerate"&gt;function&lt;/a&gt; that yields pairs of &lt;code&gt;(index, element)&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Syntax for &lt;a href="https://doc.rust-lang.org/stable/book/method-syntax.html#method-calls"&gt;method definition&lt;/a&gt;
in Rust uses the &lt;code&gt;self&lt;/code&gt; keyword as first argument to distinguish between instance methods and &amp;#8220;class&amp;#8221;/&amp;#8221;static&amp;#8221; methods
(or &lt;em&gt;associated functions&lt;/em&gt; in Rust&amp;#8217;s parlance).
This is even more pythonic than in actual Python, where &lt;code&gt;self&lt;/code&gt; is technically just a convention,
albeit an extremely strong&amp;nbsp;one.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;In either language, overloading operators doesn&amp;#8217;t use any new keywords or special syntax,
like it does in C++, C#, and others. Python accomplishes it through &lt;code&gt;__magic__&lt;/code&gt; methods, whereas Rust
has very similarly named &lt;a href="https://doc.rust-lang.org/stable/book/operators-and-overloading.html"&gt;operator traits&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Rust basically &lt;a href="https://doc.rust-lang.org/stable/book/documentation.html#documentation-as-tests"&gt;has &lt;code&gt;doctest&lt;/code&gt;&lt;/a&gt;.
If you don&amp;#8217;t know, the &lt;a href="https://docs.python.org/2/library/doctest.html"&gt;&lt;code&gt;doctest&lt;/code&gt; module&lt;/a&gt; is a standard Python testing
utility that can run usage examples found in documentation comments and verify their correctness. Rust version (&lt;code&gt;rustdoc&lt;/code&gt;)
is even more powerful and flexible, allowing for example to mark additional boilerplate lines that should be run
when testing examples, but &lt;em&gt;not&lt;/em&gt; included in the generated&amp;nbsp;documentation.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I&amp;#8217;m sure the list doesn&amp;#8217;t end here and will grow over time. As of this writing, for example, nightly builds of Rust
already offer &lt;a href="https://doc.rust-lang.org/stable/book/slice-patterns.html"&gt;advanced slice pattern matching&lt;/a&gt; which are
very similar to the &lt;a href="https://www.python.org/dev/peps/pep-3132/"&gt;extended iterable unpacking&lt;/a&gt; from Python&amp;nbsp;3.&lt;/p&gt;
&lt;h4&gt;Is it worth&amp;nbsp;it?&lt;/h4&gt;
&lt;p&gt;Depending on your background and the programming domain you are working in, you may be wondering if Rust
is a language that&amp;#8217;s worth looking into now, or in the near&amp;nbsp;future.&lt;/p&gt;
&lt;p&gt;Firstly, let me emphasize that it&amp;#8217;s still in its early stages. Although the stable version 1.0 has been released
&lt;a href="http://blog.rust-lang.org/2015/05/15/Rust-1.0.html"&gt;a good couple of months ago&lt;/a&gt;, the ecosystem isn&amp;#8217;t nearly as diverse
and abundant as in some of the other new&amp;nbsp;languages.&lt;/p&gt;
&lt;p&gt;If you are specifically looking to deploying Rust-written &lt;span class="caps"&gt;API&lt;/span&gt; servers, backends, and other &amp;#8212; shall I use the word
&amp;#8212; microservices, then right now you&amp;#8217;ll probably be better served by more established solutions, like node.js,
Go, Java with &lt;a href="http://docs.paralleluniverse.co/quasar/"&gt;fibers&lt;/a&gt;, asynchronous Python on PyPy, Erlang, or similar.
I predict Rust catching up here in the coming months, though, because the prospect of writing native speed &lt;span class="caps"&gt;JSON&lt;/span&gt; slingers
with relative ease is just too compelling to&amp;nbsp;pass.&lt;/p&gt;
&lt;p&gt;The other interesting area for Rust is &lt;em&gt;game programming&lt;/em&gt;, because it&amp;#8217;s one of the few languages capable of supporting
even the most demanding &lt;span class="caps"&gt;AAA&lt;/span&gt;+ productions. The good news is that portable, open source
&lt;a href="http://www.piston.rs/"&gt;game engines&lt;/a&gt; are already there. The bad news is that most of the existing knowledge
about designing and coding high performance games is geared towards writing (stripped down) C++. The community
is also rather &lt;del&gt;stubborn&lt;/del&gt; reluctant to adopt anything that may carry even a &lt;em&gt;hint&lt;/em&gt; of potentially unknown
performance implications. Although some inroads have been made (here&amp;#8217;s, for example,
an &lt;a href="https://github.com/HeroesGrave/ecs-rs"&gt;entity component system&lt;/a&gt; written in Rust), and I wouldn&amp;#8217;t be surprised
to see indie games written in Rust, it probably won&amp;#8217;t take over the industry anytime&amp;nbsp;soon.&lt;/p&gt;
&lt;p&gt;When it comes to hardware, though, Rust may already have an upper hand. It is obviously much easier language to program in
than pure C. Along with its toolchain&amp;#8217;s ability to produce
&lt;a href="https://doc.rust-lang.org/stable/book/no-stdlib.html"&gt;minimal executables&lt;/a&gt;, it makes for a compelling language for
programming microcontrollers and other embedded&amp;nbsp;devices.&lt;/p&gt;
&lt;p&gt;So in short, Rust is pretty nice. And if you have read that far, I think you should just go ahead
and &lt;a href="https://www.rust-lang.org/"&gt;have a look&lt;/a&gt; for yourself&amp;nbsp;:)&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Because as much as we&amp;#8217;d like for &lt;a href="http://dlang.org/"&gt;D&lt;/a&gt; to finally get &lt;em&gt;somewhere&lt;/em&gt;, at this point
we may have better luck waiting for the Year of Linux on Desktop to dawn&amp;#8230;&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Of course, nobody has stopped the community from &lt;a href="https://github.com/Manishearth/rust-gc"&gt;implementing it&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;Strictly speaking, it&amp;#8217;s the binding such as &lt;code&gt;let x = &amp;amp;foo;&lt;/code&gt; that translates to it. Unadorned C pointer type
&lt;code&gt;Foo*&lt;/code&gt; would correspond to mutable binding to a mutable reference in Rust, i.e. &lt;code&gt;let mut x = &amp;amp;mut foo;&lt;/code&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:4"&gt;
&lt;p&gt;Their Haskell equivalents are &lt;code&gt;Maybe&lt;/code&gt; and &lt;code&gt;Either&lt;/code&gt; type classes, respectively.&amp;#160;&lt;a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Thu, 10 Dec 2015 20:33:00 -0800</pubDate><guid>tag:xion.io,2015-12-10:post/code/rust-first-impressions.html</guid><category>Rust</category><category>pointers</category><category>types</category><category>FP</category><category>OOP</category><category>traits</category></item><item><title>URL library for Python</title><link>http://xion.io/post/code/python-furl.html</link><description>&lt;p&gt;Python has many &lt;a href="https://docs.python.org/3/library/"&gt;batteries included&lt;/a&gt;, but a few things are still conspicuously&amp;nbsp;missing.&lt;/p&gt;
&lt;p&gt;One of them is a standardized and convenient approach to &lt;span class="caps"&gt;URL&lt;/span&gt; manipulation, akin to the
&lt;a href="http://docs.oracle.com/javase/7/docs/api/java/net/URI.html"&gt;&lt;code&gt;URI&lt;/code&gt; class&lt;/a&gt; in Java.
There are some functions in &lt;a href="https://docs.python.org/2/library/urllib.html"&gt;&lt;code&gt;urllib&lt;/code&gt;&lt;/a&gt;, of course
(or &lt;a href="https://docs.python.org/3/library/urllib.parse.html"&gt;&lt;code&gt;urllib.parse&lt;/code&gt;&lt;/a&gt; in Python 3), but much like their &lt;span class="caps"&gt;HTTP&lt;/span&gt;-related
comrades, they prove rather verbose and somewhat&amp;nbsp;clunky.&lt;/p&gt;
&lt;p&gt;&lt;span class="caps"&gt;HTTP&lt;/span&gt;, however, is solved by the &lt;a href="http://python-requests.org/"&gt;Requests&lt;/a&gt; package, so you may wonder
if there is some analogous package for &lt;span class="caps"&gt;URL&lt;/span&gt; operations. The answer is affirmative, and the library in question is,
quite whimsically, called &lt;a href="https://github.com/gruns/furl"&gt;&lt;em&gt;furl&lt;/em&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;&lt;span class="caps"&gt;URL&lt;/span&gt; in a&amp;nbsp;wrap&lt;/h4&gt;
&lt;p&gt;The sole interesting part of the &lt;em&gt;furl&lt;/em&gt; interface is the &lt;code&gt;furl&lt;/code&gt; class. It represents a single &lt;span class="caps"&gt;URL&lt;/span&gt;, broken down to
its constituents, with properties and methods for both reading them out and replacing with new&amp;nbsp;values.&lt;/p&gt;
&lt;p&gt;Thanks to this handy (and quite obvious) abstraction, common &lt;span class="caps"&gt;URL&lt;/span&gt; operations become quite simple and&amp;nbsp;self-documenting:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;furl&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;furl&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;to_absolute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;base&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;If given ``url`` is a relative path,&lt;/span&gt;
&lt;span class="sd"&gt;    make it relative to the ``base``.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;furled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;furl&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;furled&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scheme&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;furl&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;url&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;is_same_origin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;urls&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Check whether URLs are from the same origin (host:port).&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;origins&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;netloc&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;furl&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;urls&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;origins&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_facebook_username&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;profile_url&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Get Facebook user ID from their profile URL.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;furled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;furl&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;profile_url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;furled&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;facebook.com&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt;
            &lt;span class="n"&gt;furled&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;endswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;.facebook.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
        &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="ne"&gt;ValueError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;not a Facebook URL: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;profile_url&lt;/span&gt;&lt;span class="p"&gt;,))&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;furled&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;segments&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="c"&gt;# etc.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This includes the extremely prevalent, yet very harmful pattern of bulding URLs through string&amp;nbsp;interpolation:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;?&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BASE_URL&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;urlencode&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;query_params&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Besides looking unpythonically ugly, it&amp;#8217;s also inflexible and error-prone. If &lt;code&gt;BASE_URL&lt;/code&gt; gains some innate query string
params (&lt;code&gt;'http://example.com/?a=b'&lt;/code&gt;), this method will start producing completely invalid &lt;code&gt;url&lt;/code&gt;s (with two question marks,
e.g. &lt;code&gt;'http://example.com/?a=b?foo=bar'&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;The equivalent in &lt;em&gt;furl&lt;/em&gt; has none of these&amp;nbsp;flaws:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;furl&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BASE_URL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;query_params&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;The full&amp;nbsp;package&lt;/h4&gt;
&lt;p&gt;To see the full power of &lt;em&gt;furl&lt;/em&gt;, I recommend having a look at its
&lt;a href="https://github.com/gruns/furl/blob/master/API.md"&gt;&lt;span class="caps"&gt;API&lt;/span&gt; documentation&lt;/a&gt;. It&amp;#8217;s quite clear and should be very easy to&amp;nbsp;use.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Fri, 27 Nov 2015 19:37:00 -0800</pubDate><guid>tag:xion.io,2015-11-27:post/code/python-furl.html</guid><category>Python</category><category>URL</category><category>furl</category></item><item><title>let: binding for Knockout</title><link>http://xion.io/post/code/knockout-let-binding.html</link><description>&lt;p&gt;&lt;a href="http://knockoutjs.com/"&gt;Knockout&lt;/a&gt; is a JavaScript &amp;#8220;framework&amp;#8221; that has always lurked in the shadows of other,
more flashy ones. Even in the days of its relative novelty, the likes of Backbone or Ember had seemed to garner more
widespread interest among frontend developers. Today, this hasn&amp;#8217;t changed much, the difference being mainly
that the spotlight is now taken by new actors (&lt;em&gt;*cough*&lt;/em&gt; &lt;a href="https://facebook.github.io/react/"&gt;React&lt;/a&gt; &lt;em&gt;*cough*&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;But Knockout has a loyal following, and for good reasons. Possibly the most imporant one is why I&amp;#8217;ve put the word
&amp;#8220;framework&amp;#8221; in quotes. Knockout is, first and foremost, a &lt;em&gt;data binding&lt;/em&gt; library: it doesn&amp;#8217;t do much else besides
tying &lt;span class="caps"&gt;DOM&lt;/span&gt; nodes to JavaScript&amp;nbsp;objects.&lt;/p&gt;
&lt;p&gt;This quality makes it both easy to learn and simple to integrate. In fact, it can very well live in just some small
compartments of your web application, mingling easily with any server-side templating mechanism you might be using.
It also interplays effortlessly with other &lt;span class="caps"&gt;JS&lt;/span&gt; libraries, and sticks very well to
&lt;a href="http://stackoverflow.com/q/30766900/434799"&gt;whatever duct tape you use&lt;/a&gt; to hold your frontend stack&amp;nbsp;together.&lt;/p&gt;
&lt;p&gt;Lastly, it&amp;#8217;s also quite extensible. We can, for example, create our own
&lt;a href="http://knockoutjs.com/documentation/binding-syntax.html"&gt;bindings&lt;/a&gt; rather easily, extending the declarative language
used to describe relationship between the data and &lt;span class="caps"&gt;UI&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;In this post, I&amp;#8217;m going to demonstrate this by implementing a very simple &lt;code&gt;let:&lt;/code&gt; binding &amp;#8212;
a kind of &amp;#8220;assignment&amp;#8221; of an expression to a&amp;nbsp;name.&lt;/p&gt;
&lt;h4&gt;From Knockout &lt;code&gt;with:&lt;/code&gt; bluff&lt;/h4&gt;
&lt;p&gt;Out of box, Knockout proffers the &lt;a href="http://knockoutjs.com/documentation/with-binding.html"&gt;&lt;code&gt;with:&lt;/code&gt; binding&lt;/a&gt;,
a quite similar mechanism. How it may be somewhat problematic is analogous to the
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/with"&gt;widely discouraged &lt;code&gt;with&lt;/code&gt; statement&lt;/a&gt;
in JavaScript itself. Namely, it blends several namespaces together, making it harder to determine which object
is being referred to. As a result, the code is more prone to&amp;nbsp;errors.&lt;/p&gt;
&lt;p&gt;On the other hand, freeing the developer from repeating long and complicated expressions is obviously valuable.
Perhaps reducing them to nil is not the right approach, though, so how about we just shorten them
to a more manageable length? Well, that&amp;#8217;s exactly what the &lt;code&gt;let:&lt;/code&gt; binding is meant to&amp;nbsp;do:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;data-bind=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;let: { addr: currentUser.personalInfo.address }&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;p&lt;/span&gt; &lt;span class="na"&gt;data-bind=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text: addr.line1&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
  &lt;span class="c"&gt;&amp;lt;!-- ko if: addr.line2 --&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;p&lt;/span&gt; &lt;span class="na"&gt;data-bind=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text: addr.line2&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
  &lt;span class="c"&gt;&amp;lt;!-- /ko --&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;p&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;span&lt;/span&gt; &lt;span class="na"&gt;data-bind=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text: add.city&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/span&amp;gt;&lt;/span&gt;,
    &lt;span class="nt"&gt;&amp;lt;span&lt;/span&gt; &lt;span class="na"&gt;data-bind=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text: add.region&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/span&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;p&lt;/span&gt; &lt;span class="na"&gt;data-bind=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text: add.country&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Making it happen turns out to be pretty&amp;nbsp;easy.&lt;/p&gt;
&lt;h4&gt;Binding&amp;nbsp;contract&lt;/h4&gt;
&lt;p&gt;To define a Knockout binding, up to two things are needed. We have to specify what the library should&amp;nbsp;do:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;when the binding is first applied to a &lt;span class="caps"&gt;DOM&lt;/span&gt; node (the &lt;code&gt;init&lt;/code&gt; method)&lt;/li&gt;
&lt;li&gt;when any of the &lt;a href="http://knockoutjs.com/documentation/observables.html"&gt;observed values&lt;/a&gt; changes (the &lt;code&gt;update&lt;/code&gt; method)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Not every binding has to implement both methods. In our cases, only the &lt;code&gt;init&lt;/code&gt; is necessary, because all we have to do
is modify the &lt;em&gt;binding context&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;What&amp;#8217;s that? Shortly speaking, a &lt;a href="http://knockoutjs.com/documentation/binding-context.html"&gt;binding context&lt;/a&gt;,
is an object holding all the data you can potentially bind to your &lt;span class="caps"&gt;DOM&lt;/span&gt; nodes. Think of it as a namespace, or local scope:
whatever&amp;#8217;s in there can be used directly inside &lt;code&gt;data-bind&lt;/code&gt; attributes.&lt;/p&gt;
&lt;h4&gt;&lt;code&gt;let:&lt;/code&gt; it&amp;nbsp;go&lt;/h4&gt;
&lt;p&gt;Therefore, all that the &lt;code&gt;let:&lt;/code&gt; binding has to do is to extend the context with a mapping passed to it as an argument.
Well, almost&amp;nbsp;all:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;ko&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;bindingHandlers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;let&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;init&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;valueAccessor&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;allBindings&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;viewModel&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;bindingContext&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;innerContext&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;bindingContext&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;extend&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;valueAccessor&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;ko&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;applyBindingsToDescendants&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;innerContext&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;controlsDescendantBindings&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt; &lt;span class="p"&gt;};&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The resulting &lt;code&gt;innerContext&lt;/code&gt; is a copy of the original &lt;code&gt;bindingContext&lt;/code&gt;, augmented with additional properties from
the argument of &lt;code&gt;let:&lt;/code&gt; (those are available through &lt;code&gt;valueAccessor&lt;/code&gt;). Once we have it, though, we need to handle it
in a little special&amp;nbsp;way.&lt;/p&gt;
&lt;p&gt;Normally, Knockout is processing all bindings recursively, pasing down the same &lt;code&gt;bindingContext&lt;/code&gt; (which ultimately
comes from the root &lt;code&gt;viewModel&lt;/code&gt;). But since we want to locally alter the context, we also need to interrupt this regular
way and take care of the lower-level &lt;span class="caps"&gt;DOM&lt;/span&gt; nodes&amp;nbsp;ourselves.&lt;/p&gt;
&lt;p&gt;This is exactly what the overly-long &lt;code&gt;ko.applyBindingsToDescendants&lt;/code&gt; function is doing. The only caveat is that Knockout
has to be &lt;a href="http://knockoutjs.com/documentation/custom-bindings-controlling-descendant-bindings.html"&gt;told explicitly&lt;/a&gt;
about our intentions through the &lt;code&gt;return&lt;/code&gt; value from &lt;code&gt;init&lt;/code&gt;. Otherwise, it would try to apply the &lt;em&gt;original&lt;/em&gt;
&lt;code&gt;bindingContext&lt;/code&gt; recursively, which in our case would amount to applying it &lt;strong&gt;twice&lt;/strong&gt;.
&lt;code&gt;{ controlsDescendantBindings: true }&lt;/code&gt; prevents Knockout from doing so&amp;nbsp;erroneously.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Wed, 18 Nov 2015 16:45:00 -0800</pubDate><guid>tag:xion.io,2015-11-18:post/code/knockout-let-binding.html</guid><category>Knockout</category><category>JavaScript</category><category>web frontend</category><category>data binding</category></item><item><title>Turn SQLAlchemy queries into literal SQL</title><link>http://xion.io/post/code/sqlalchemy-query-to-sql.html</link><description>&lt;p&gt;Like I mentioned in the &lt;a href="http://xion.io/post/code/sqlalchemy-regex-filters.html"&gt;post about adding regular expression support&lt;/a&gt;,
the nice thing about &lt;a href="http://www.sqlalchemy.org/"&gt;SQLAlchemy&lt;/a&gt; is the clean, layered structure of various abstractions
it&amp;nbsp;utilizes.&lt;/p&gt;
&lt;p&gt;Regretably, though, we know that &lt;a href="https://en.wikipedia.org/wiki/Leaky_abstraction"&gt;software abstractions tend to leak&lt;/a&gt;.
Inn particular, any &lt;span class="caps"&gt;ORM&lt;/span&gt; seem to be a poster child of this rule, especially in the popular opinion among
&lt;a href="https://www.reddit.com/r/programming/search?q=ORM&amp;amp;restrict_sr=on"&gt;developer crowds&lt;/a&gt;.
By design, they&amp;#8217;re intended to hide at least &lt;em&gt;some&lt;/em&gt; details of the operations on a database,
but those very details can be quite critical at times. There are situations when we simply want to know
what &lt;em&gt;exactly&lt;/em&gt; is going on, and how all those model classes and mappers and relationships translate
to the actual &lt;span class="caps"&gt;SQL&lt;/span&gt;&amp;nbsp;code.&lt;/p&gt;
&lt;p&gt;To make it a little more concrete, let&amp;#8217;s focus on the SQLAlchemy &lt;code&gt;Query&lt;/code&gt; class. Given such a query, we&amp;#8217;d like to get
the final &lt;span class="caps"&gt;SQL&lt;/span&gt; representation of it, the one that&amp;#8217;s ultimately sent to the database, It could be useful
for any number of things, from logging&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt; to profiling, or just displaying in the web page&amp;#8217;s footer,
or even solely for prototyping in the Python &lt;span class="caps"&gt;REPL&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;In other words, we want to turn&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;db_session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;some_email&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;into something like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;users&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;users&lt;/span&gt; &lt;span class="k"&gt;WHERE&lt;/span&gt; &lt;span class="n"&gt;users&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;regardless of the complexity of the query, the number of model classes it spans, or the number of relationship-related
&lt;code&gt;JOIN&lt;/code&gt;s it&amp;nbsp;involves.&lt;/p&gt;
&lt;h4&gt;It&amp;#8217;s a&amp;nbsp;dialect&lt;/h4&gt;
&lt;p&gt;There is one aspect we cannot really universalize, though. It&amp;#8217;s the specific &lt;em&gt;database backend&lt;/em&gt; that SQLAlchemy
should compile our query for. Shrugging off syntactical and semantical differences between database engines
is one thing that using an &lt;span class="caps"&gt;ORM&lt;/span&gt; can potentially buy us, but if we want to get down to the &lt;span class="caps"&gt;SQL&lt;/span&gt; level,
we need to be specific about&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;In SQLAlchemy&amp;#8217;s parlance, any specific variant of the &lt;span class="caps"&gt;SQL&lt;/span&gt; language is called a &lt;em&gt;dialect&lt;/em&gt;. Most of the time,
you&amp;#8217;ll be interested in the particular dialect your database of choice is using. This is easily obtainable from
the &lt;a href="docs.sqlalchemy.org/en/latest/orm/session_api.html#sqlalchemy.orm.session.Session"&gt;database &lt;code&gt;Session&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;dialect&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;db_session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dialect&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The resulting
&lt;a href="http://docs.sqlalchemy.org/en/latest/core/internals.html#sqlalchemy.engine.interfaces.Dialect"&gt;&lt;code&gt;Dialect&lt;/code&gt; object&lt;/a&gt;
is little more than a container for small tidbits of information, used by SQLAlchemy to handle various quirks of
the database backends it supports. For our purposes, though, it can be treated as a completely opaque&amp;nbsp;token.&lt;/p&gt;
&lt;h4&gt;Compile &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt;&amp;nbsp;unwrap&lt;/h4&gt;
&lt;p&gt;With the &lt;code&gt;Dialect&lt;/code&gt; in hand, we can invoke the query compiler to get the textual representatio of our &lt;code&gt;Query&lt;/code&gt;.
Or, to be more precise, the compiled version of the query&amp;#8217;s
&lt;a href="docs.sqlalchemy.org/en/latest/core/selectable.html#sqlalchemy.sql.expression.Select"&gt;&lt;code&gt;Select&lt;/code&gt; statement&lt;/a&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;query&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;db_session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;foo@example.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;statement&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dialect&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;db_session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dialect&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;SELECT&lt;/span&gt; &lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;
&lt;span class="n"&gt;FROM&lt;/span&gt; &lt;span class="n"&gt;users&lt;/span&gt;
&lt;span class="n"&gt;WHERE&lt;/span&gt; &lt;span class="n"&gt;users&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;email_1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Perhaps unsurprisingly, even after compilation the result is still just &lt;em&gt;another object&lt;/em&gt;:
the &lt;a href="docs.sqlalchemy.org/en/latest/core/internals.html#sqlalchemy.engine.interfaces.Compiled"&gt;&lt;code&gt;Compiled&lt;/code&gt; one&lt;/a&gt;.
As you can see, however, the actual &lt;span class="caps"&gt;SQL&lt;/span&gt; text is just its &lt;code&gt;__str__&lt;/code&gt;&lt;span class="quo"&gt;&amp;#8216;&lt;/span&gt;ing representation, which we can &lt;code&gt;print&lt;/code&gt; directly
or obtain with &lt;code&gt;str()&lt;/code&gt; or &lt;code&gt;unicode()&lt;/code&gt;.&lt;/p&gt;
&lt;h4&gt;&lt;code&gt;Query.to_sql&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;But obviously, we don&amp;#8217;t want to type the above incantations everytime we need to take a peek at the generated &lt;span class="caps"&gt;SQL&lt;/span&gt;
for an &lt;span class="caps"&gt;ORM&lt;/span&gt; query. Probably the best solution is to extend the &lt;code&gt;Query&lt;/code&gt; class so that it offers this additional
functionality under a new&amp;nbsp;method:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.orm.query&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Query&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;_Query&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_Query&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Custom, enhanced SQLALchemy Query class.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;to_sql&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Return a literal SQL representation of the query.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="n"&gt;dialect&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;dialect&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;statement&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;compile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dialect&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;dialect&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This new &lt;code&gt;Query&lt;/code&gt; class needs then be passed as
&lt;a href="http://docs.sqlalchemy.org/en/latest/orm/session_api.html#sqlalchemy.orm.session.Session.params.query_cls"&gt;&lt;code&gt;query_cls&lt;/code&gt; argument&lt;/a&gt;
to the constructor of &lt;code&gt;Session&lt;/code&gt;. Details may vary a little bit dependening on how exactly your application is set up,
but in most cases, it should be &lt;a href="http://docs.sqlalchemy.org/en/latest/orm/contextual.html"&gt;easy enough to figure out&lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;If you&amp;#8217;re only interested in indiscriminate logging of all queries, setting the
&lt;a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#sqlalchemy.create_engine.params.echo"&gt;&lt;code&gt;echo&lt;/code&gt; parameter&lt;/a&gt;
in &lt;a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#sqlalchemy.create_engine"&gt;&lt;code&gt;create_engine&lt;/code&gt;&lt;/a&gt; may be sufficient.
Another alternative is to look directly at the
&lt;a href="http://docs.sqlalchemy.org/en/latest/core/engines.html#configuring-logging"&gt;logging configuration options&lt;/a&gt;
for various parts of SQLAlchemy&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Thu, 12 Nov 2015 22:56:00 -0800</pubDate><guid>tag:xion.io,2015-11-12:post/code/sqlalchemy-query-to-sql.html</guid><category>SQLAlchemy</category><category>SQL</category><category>databases</category></item><item><title>Celery task in a Flask request context</title><link>http://xion.io/post/code/celery-include-flask-request-context.html</link><description>&lt;p&gt;&lt;a href="http://celeryproject.org"&gt;Celery&lt;/a&gt; is an asynchronous task worker that&amp;#8217;s frequently used for background processing
in Python web apps. Rather than performing a time-consuming task within the request loop, we delegate it to a &lt;em&gt;queue&lt;/em&gt;
so that a &lt;em&gt;worker process&lt;/em&gt; can pick it up when ready. The immediate benefit is much better latency for the end user.
Pros also include easier scalability, since you can adjust the number of workers to your task&amp;nbsp;load.&lt;/p&gt;
&lt;p&gt;Examples of tasks that are usually best done in the background vary from fetching data through a third-party &lt;span class="caps"&gt;API&lt;/span&gt;
to sending emails, and from pushing mobile notifications to pruning the database of stale records. Anything that may
take more than a couple hundred milliseconds to complete &amp;#8212; and isn&amp;#8217;t absolutely essential to the current &lt;span class="caps"&gt;HTTP&lt;/span&gt; request &amp;#8212;
is typically a good candidate for asynchronous&amp;nbsp;processing.&lt;/p&gt;
&lt;p&gt;In Celery, workers are just regular Python processes, often running the exact same code that&amp;#8217;s powering the app&amp;#8217;s web
frontend&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;. But unlike most of that code, they aren&amp;#8217;t servicing any &lt;span class="caps"&gt;HTTP&lt;/span&gt; requests &amp;#8212; they simply run some function
with given arguments, both specified by whomever sent a task for execution. Indeed, those functions don&amp;#8217;t even &lt;em&gt;know&lt;/em&gt;
who or what asked for them to be&amp;nbsp;executed.&lt;/p&gt;
&lt;p&gt;Neat, right? It is what we usually compliment as &lt;em&gt;decoupling&lt;/em&gt;, or separation of concerns. They are valuable qualities even
regardless of the &lt;span class="caps"&gt;UI&lt;/span&gt; and scaling benefits mentioned&amp;nbsp;earlier.&lt;/p&gt;
&lt;h4&gt;Not quite&amp;nbsp;web&lt;/h4&gt;
&lt;p&gt;But those qualities come with a trade-off. Task code is no longer a web frontend code: it doesn&amp;#8217;t run within the
comfy environment of our web framework of choice. Losing it may be quite unnerving, actually, because in a typical
web application there will be many things tied directly to the &lt;span class="caps"&gt;HTTP&lt;/span&gt; request pipeline. After all, this is what web
applications &lt;em&gt;do&lt;/em&gt; &amp;#8212; respond to &lt;span class="caps"&gt;HTTP&lt;/span&gt; requests &amp;#8212; so it often makes perfect sense e.g. to marry the request flow
with database transactions, committing or rolling those back according to &lt;span class="caps"&gt;HTTP&lt;/span&gt; status code that the app&amp;nbsp;produced.&lt;/p&gt;
&lt;p&gt;Tasks may also require a database, though, if only to
&lt;a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#state"&gt;assert the expected state of the world&lt;/a&gt;.
Similar goes for memcache, a Redis instance, or basically any resource used by the frontend code.
Alas, it&amp;#8217;s quite possible &lt;em&gt;the very reason&lt;/em&gt; we delegate work to a task is to shift lengthy interactions with those
external systems away from the &lt;span class="caps"&gt;UI&lt;/span&gt;. Obviously, we&amp;#8217;re going to need them for&amp;nbsp;that!&lt;/p&gt;
&lt;h4&gt;Fake a&amp;nbsp;request&lt;/h4&gt;
&lt;p&gt;So one way or another, our tasks will most likely need some initialization and/or cleanup code. And since it&amp;#8217;s probably
the same code that most &lt;span class="caps"&gt;HTTP&lt;/span&gt; request handlers require and use already, why not just &lt;em&gt;pretend we&amp;#8217;re handling a request
after all&lt;/em&gt;?&lt;/p&gt;
&lt;p&gt;In &lt;a href="http://flask.pocoo.org"&gt;Flask&lt;/a&gt;, we can pull that off rather easily.
The &lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.test_request_context"&gt;&lt;code&gt;test_request_context&lt;/code&gt; method&lt;/a&gt;
is conveniently provided to allow for faking the &lt;em&gt;request context&lt;/em&gt; &amp;#8212; that is, an execution environment for &lt;span class="caps"&gt;HTTP&lt;/span&gt; handlers.
Like the name suggest, it is used mostly &lt;a href="http://flask.pocoo.org/docs/0.10/testing/"&gt;for testing&lt;/a&gt;, but there is nothing
stopping us from using it in tasks run by&amp;nbsp;Celery.&lt;/p&gt;
&lt;p&gt;We probably don&amp;#8217;t want to call it directly, though. What would be better is to have Celery prepare the context first,
and then run the task code as if it was an &lt;span class="caps"&gt;HTTP&lt;/span&gt; handler. For even better results, the context would preserve information
extracted from the &lt;em&gt;actual &lt;span class="caps"&gt;HTTP&lt;/span&gt; request&lt;/em&gt;, one that has sent the task for execution. Moving some work to the background
would then be a trivial matter, for both the task and the original handler would operate within the same&amp;nbsp;environment.&lt;/p&gt;
&lt;p&gt;Convenient? I believe so. And as I&amp;#8217;ll demonstrate next, it isn&amp;#8217;t very complicated to implement&amp;nbsp;either.&lt;/p&gt;
&lt;h4&gt;Wrap the&amp;nbsp;decorator?&lt;/h4&gt;
&lt;p&gt;At least one piece of the solution should stand out as pretty obvious. Since our intention is to wrap the task&amp;#8217;s code
in some additional packaging &amp;#8212; the request context &amp;#8212; it seems fairly natural to write our own &lt;code&gt;@task&lt;/code&gt; decorator:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;functools&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;myapp&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;celery&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Decorator function to apply to Celery tasks.&lt;/span&gt;
&lt;span class="sd"&gt;    Executes the actual task inside Flask&amp;#39;s test request context.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;decorator&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Actual decorator.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="nd"&gt;@celery.task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nd"&gt;@functools.wraps&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;wrapped&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;test_request_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;wrapped&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;decorator&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here, &lt;code&gt;app&lt;/code&gt; is the &lt;a href="http://flask.pocoo.org/docs/0.10/api/#application-object"&gt;&lt;code&gt;Flask&lt;/code&gt; application&lt;/a&gt;, and &lt;code&gt;celery&lt;/code&gt; is the
&lt;a href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery-application-objects"&gt;&lt;code&gt;Celery&lt;/code&gt; object&lt;/a&gt;
that&amp;#8217;s often configured alongside&amp;nbsp;it.&lt;/p&gt;
&lt;h4&gt;The &lt;code&gt;Task&lt;/code&gt; class&lt;/h4&gt;
&lt;p&gt;While this technique will give us &lt;em&gt;a&lt;/em&gt; request context inside the task code, it won&amp;#8217;t be &lt;em&gt;the&lt;/em&gt; request context
from which the task has been sent for execution. To replicate that context correctly, we need additional support
on the sender&amp;nbsp;side.&lt;/p&gt;
&lt;p&gt;Internally, Celery is converting every function we annotate with &lt;code&gt;@task&lt;/code&gt; decorator into a subclass of
&lt;a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task"&gt;&lt;code&gt;Celery.app.task.Task&lt;/code&gt;&lt;/a&gt;.
This process can be customized, for example by providing an explicit &lt;code&gt;base=&lt;/code&gt; parameter to &lt;code&gt;@task&lt;/code&gt; which
specifies a &lt;a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#custom-task-classes"&gt;custom &lt;code&gt;Task&lt;/code&gt; subclass&lt;/a&gt;
to use in place of the default one. Within that subclass, we&amp;#8217;re free to override any functionality that we need&amp;nbsp;to.&lt;/p&gt;
&lt;p&gt;In our case, we&amp;#8217;ll scrape the current request context from Flask for all relevant information,
and later use it to recreate the context in the task&amp;nbsp;code.&lt;/p&gt;
&lt;p&gt;But before we get to that, let&amp;#8217;s just create the &lt;code&gt;Task&lt;/code&gt; subclass and move the above execution logic to it.
This way, users won&amp;#8217;t have to use a completely new &lt;code&gt;@task&lt;/code&gt; decorator which would needlessly couple them to a specific
&lt;code&gt;Celery&lt;/code&gt; app&amp;nbsp;instance:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;celery&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Task&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Task&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Base class for tasks that run inside a Flask request context.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;abstract&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;test_request_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Instead, they can either set this class as &lt;code&gt;base=&lt;/code&gt; for a specific&amp;nbsp;task:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@celery.task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;base&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sync_user_data&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user_id&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;or make it into new default for all their&amp;nbsp;tasks:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;celery&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Celery&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;celery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Task&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;RequestContextTask&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;Invocation&amp;nbsp;patterns&lt;/h4&gt;
&lt;p&gt;When the frontend asks for a task to be executed, it most often uses the
&lt;a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.delay"&gt;&lt;code&gt;Task.delay&lt;/code&gt; method&lt;/a&gt;.
It will package a payload contaning task arguments, and send it off through a &lt;em&gt;broker&lt;/em&gt; &amp;#8212;
usually an &lt;a href="https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol"&gt;&lt;span class="caps"&gt;AMQP&lt;/span&gt;&lt;/a&gt;-based queue,
such as &lt;a href="https://www.rabbitmq.com/"&gt;RabbitMQ&lt;/a&gt; &amp;#8212; so that a Celery worker can pick it up and actually&amp;nbsp;execute.&lt;/p&gt;
&lt;p&gt;But there are other means of task invocation. We can even run it
&lt;a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.apply"&gt;&amp;#8220;in place&amp;#8221;&lt;/a&gt;,
locally and synchronously, which is especially useful for various testing scenarios. Lastly, a task can also be
&lt;a href="http://docs.celeryproject.org/en/latest/reference/celery.app.task.html#celery.app.task.Task.retry"&gt;retried&lt;/a&gt; from within
its own code, terminating its current run and scheduling another attempt for some future&amp;nbsp;date.&lt;/p&gt;
&lt;p&gt;Obviously, for the &lt;code&gt;RequestContextTask&lt;/code&gt; to be useful, it needs to behave correctly in every situation.
Therefore we need to cover all the entry points I&amp;#8217;ve mentioned &amp;#8212;
the asynchronous call, a synchronous invocation, and a task&amp;nbsp;retry:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Task&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;apply_async&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;rest&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_include_context&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; \
            &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;apply_async&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;rest&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;apply&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;rest&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_include_context&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; \
            &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;apply&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;rest&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;retry&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;rest&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_include_context&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; \
            &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;rest&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that &lt;code&gt;Task.apply_async&lt;/code&gt; is being called internally by &lt;code&gt;Task.delay&lt;/code&gt;,
so it&amp;#8217;s only that first method that we have to&amp;nbsp;override.&lt;/p&gt;
&lt;h4&gt;Context in a&amp;nbsp;box&lt;/h4&gt;
&lt;p&gt;As you can deduce right away, the Flask-related magic is meant to go in the &lt;code&gt;_include_context&lt;/code&gt; method.
The idea is to prepare arguments for the eventual invocation of &lt;code&gt;Flask.test_request_context&lt;/code&gt;,
and pass them through an extra task parameter.
Those arguments are relatively uncomplicated: they are just a medley of various pieces of information
that we can easily obtain from the Flask&amp;#8217;s &lt;code&gt;request&lt;/code&gt; object:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;flask&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;has_request_context&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Task&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;CONTEXT_ARG_NAME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;_flask_request_context&amp;#39;&lt;/span&gt;

    &lt;span class="c"&gt;# ...&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_include_request_context&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Includes all the information about current HTTP request context&lt;/span&gt;
&lt;span class="sd"&gt;        as an additional argument to the task.&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;has_request_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt;

        &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="s"&gt;&amp;#39;path&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;&amp;#39;base_url&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url_root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;&amp;#39;method&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s"&gt;&amp;#39;headers&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;dict&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;?&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;query_string&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;find&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;?&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;):]&lt;/span&gt;

        &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CONTEXT_ARG_NAME&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On the worker side, we simply unpack them and recreate the&amp;nbsp;context:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;flask&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;make_response&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Task&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;call&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RequestContextTask&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CONTEXT_ARG_NAME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;has_request_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;call&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;test_request_context&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;call&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;make_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The only tricky part is calling
&lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.process_response"&gt;&lt;code&gt;Flask.process_response&lt;/code&gt;&lt;/a&gt; at the end.
We need to do that for the &lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.after_request"&gt;&lt;code&gt;@after_request&lt;/code&gt; hooks&lt;/a&gt;
to execute correctly. This is quite crucial, because those hooks are where you&amp;#8217;d normally put important cleanup code,
like commit/rollback of the database&amp;nbsp;transaction.&lt;/p&gt;
&lt;h4&gt;Complete&amp;nbsp;solution&lt;/h4&gt;
&lt;p&gt;To see how all those code snippets fit together, see &lt;a href="https://gist.github.com/Xion/46d739b980af14a0d3ea"&gt;this gist&lt;/a&gt;.
You may also want to have a look at
&lt;a href="http://flask.pocoo.org/docs/0.10/patterns/celery/"&gt;the article on Celery integration&lt;/a&gt; in Flask docs for some tips on
how to integrate it with your own&amp;nbsp;project.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;This isn&amp;#8217;t strictly necessary, as Celery supports sending tasks for execution
&lt;a href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery.send_task"&gt;by explicit name&lt;/a&gt;.
For that request to reach the worker, however,
the &lt;a href="http://docs.celeryproject.org/en/latest/configuration.html#broker-url"&gt;task broker configuration&lt;/a&gt;
must be correctly shared between sender and the worker.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Tue, 03 Nov 2015 22:40:00 -0800</pubDate><guid>tag:xion.io,2015-11-03:post/code/celery-include-flask-request-context.html</guid><category>Celery</category><category>Flask</category><category>Python</category><category>queue</category><category>request context</category></item><item><title>Actually, Python enums are pretty OK</title><link>http://xion.io/post/code/python-enums-are-ok.html</link><description>&lt;p&gt;Little over two years ago, I was writing about
&lt;a href="http://xion.org.pl/2013/05/13/we-dont-need-no-enums-in-python/"&gt;my skepticism&lt;/a&gt; towards the
&lt;a href="https://www.python.org/dev/peps/pep-0435/"&gt;addition of enum types to Python&lt;/a&gt;. My stance has changed somewhat since then,
and I now think there is some non-trivial value that enums can add to Python code. It becomes especially apparent
in the circumstances involving any kind of persistence,
from &lt;a href="https://docs.python.org/2/library/pickle.html"&gt;pickling&lt;/a&gt; to&amp;nbsp;databases.&lt;/p&gt;
&lt;p&gt;I will elaborate on that through the rest of this&amp;nbsp;post.&lt;/p&gt;
&lt;h4&gt;Revision&lt;/h4&gt;
&lt;p&gt;First, let&amp;#8217;s recap (or perhaps introduce) the important facts about enums in Python. An &lt;em&gt;enum&lt;/em&gt;, or an enumeration type,
is a special class that inherits from &lt;code&gt;enum.Enum&lt;/code&gt;&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt; and defines one or more&amp;nbsp;constants:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;enum&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Enum&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Cutlery&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;knife&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;knife&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;fork&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;fork&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;spoon&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;spoon&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Their values are then converted into singleton objects with distinct identity.
They available as attributes of the enumeration&amp;nbsp;type:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt;
&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;fork&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As a shorthand for when the values themselves are not important, the &lt;code&gt;Enum&lt;/code&gt; class can be directly invoked
with constant names as&amp;nbsp;strings:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;Cutlery&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;knife&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;fork&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;spoon&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Resulting class offers some useful &lt;span class="caps"&gt;API&lt;/span&gt; that we&amp;#8217;d expect from an enumeration type in any programming&amp;nbsp;language:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;knife&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;knife&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fork&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;fork&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;spoon&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;spoon&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;knife&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;fork&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;spoon&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;knife&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;
&lt;span class="bp"&gt;True&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;spoon&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;spoon&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;spoon&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;spork&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;Traceback&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;most&lt;/span&gt; &lt;span class="n"&gt;recent&lt;/span&gt; &lt;span class="n"&gt;call&lt;/span&gt; &lt;span class="n"&gt;last&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="c"&gt;# (...)&lt;/span&gt;
&lt;span class="ne"&gt;ValueError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;spork&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="n"&gt;valid&lt;/span&gt; &lt;span class="n"&gt;Cutlery&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;How it was done&amp;nbsp;previously&lt;/h4&gt;
&lt;p&gt;Of course, there is nothing really groundbreaking about assigning some values to &amp;#8220;constants&amp;#8221;. It&amp;#8217;s been done like that
since times immemorial, and quite often those constants have been grouped within finite&amp;nbsp;sets.&lt;/p&gt;
&lt;p&gt;Here&amp;#8217;s an example of a comment model in some imaginary &lt;span class="caps"&gt;ORM&lt;/span&gt;, complete with a status&amp;nbsp;&amp;#8220;enumeration&amp;#8221;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;APPROVED&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;approved&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;REJECTED&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;rejected&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;IN_REVIEW&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;in_review&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;STATES&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;frozenset&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;APPROVED&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;REJECTED&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;IN_REVIEW&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;StringProperty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TextProperty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;STATES&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# usage&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;author&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Xion&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Boo&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IN_REVIEW&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Converting it to use an &lt;code&gt;Enum&lt;/code&gt; is relatively&amp;nbsp;straightforward:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;State&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;approved&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;approved&amp;#39;&lt;/span&gt;
        &lt;span class="n"&gt;rejected&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;rejected&amp;#39;&lt;/span&gt;
        &lt;span class="n"&gt;in_review&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;in_review&amp;#39;&lt;/span&gt;

    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;StringProperty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TextProperty&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;StringProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

&lt;span class="n"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;author&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Xion&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Meh.&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;approved&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is not apparent, though, if there is any immediate benefit of doing so. True, we no longer need to define the &lt;code&gt;STATES&lt;/code&gt;
set explicitly, but saving on this bit of boilerplate is balanced out by having to access the enum&amp;#8217;s &lt;code&gt;value&lt;/code&gt;
when assigning it to a string&amp;nbsp;property.&lt;/p&gt;
&lt;p&gt;All in all, it seems like a wash &amp;#8212; though at least we&amp;#8217;ve established that enums are &lt;em&gt;no worse&lt;/em&gt; than their alternatives&amp;nbsp;:)&lt;/p&gt;
&lt;h4&gt;Enums are&amp;nbsp;interoperable&lt;/h4&gt;
&lt;p&gt;Obviously, this doesn&amp;#8217;t exactly sound like high praise. Thing is, we haven&amp;#8217;t really replaced the previous solution
&lt;em&gt;completely&lt;/em&gt;. Remnants of it still linger in the way the &lt;code&gt;state&lt;/code&gt; property is declared. Even though it&amp;#8217;s supposed to hold
enum constants, it is defined as string, which at this point is more of an implementation detail of how those constants
are&amp;nbsp;serialized.&lt;/p&gt;
&lt;p&gt;What were really need here is a kind of &lt;code&gt;EnumProperty&lt;/code&gt; that&amp;#8217;d allow us to work solely with enum objects.
Before the introduction of a standard &lt;code&gt;Enum&lt;/code&gt; base, however, there was little incentive for ORMs and other similiar
libraries to provide such a functionality. But now, it makes much more sense to support enums as first-class citizens,
at least for data exchange and serialization, because users can be expected to already prefer the standard &lt;code&gt;Enum&lt;/code&gt;
in their own&amp;nbsp;code.&lt;/p&gt;
&lt;p&gt;Thus, the previous example changes into something along these&amp;nbsp;lines:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;EnumProperty&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;comment&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;author&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Xion&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Yay!&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;approved&lt;/span&gt;  &lt;span class="c"&gt;# no .value!&lt;/span&gt;
&lt;span class="n"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;save&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Details of &lt;code&gt;EnumProperty&lt;/code&gt;, or some equivalent construct, are of course specific to any given data management library.
In SQLAlchemy, for example, a &lt;a href="https://gist.github.com/Xion/5564b907e5f4e883511c"&gt;custom column type&lt;/a&gt;
can handle the necessary serialization and deserialization between Python code and &lt;span class="caps"&gt;SQL&lt;/span&gt; queries,
allowing you to define your models like this&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Comment&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;State&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c"&gt;# ...&lt;/span&gt;

    &lt;span class="n"&gt;author&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;text&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Text&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EnumType&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;State&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;impl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;32&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;

&lt;span class="c"&gt;# usage like above&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In any case, the point is to have Python code operate solely on enum objects, while the persistence layer takes
care of converting between them and their serializable&amp;nbsp;values.&lt;/p&gt;
&lt;h4&gt;Enums are&amp;nbsp;extensible&lt;/h4&gt;
&lt;p&gt;The other advantage &lt;code&gt;Enum&lt;/code&gt;s have over loose collections of constants is that they are proper &lt;em&gt;types&lt;/em&gt;.
Like all user-defined types in Python, they can have additional methods and properties defined on their instances,
or even on the type&amp;nbsp;itself.&lt;/p&gt;
&lt;p&gt;Although this capability is (by default) not as powerful as e.g. in Java &amp;#8212; where &lt;em&gt;each enum constant&lt;/em&gt; can
&lt;a href="https://gist.github.com/chandrasekhar4u/431839b9eac715c08b71"&gt;override a method in its own way&lt;/a&gt; &amp;#8212; it can nevertheless
be quite convenient at times. Typical use cases include constant&amp;nbsp;classification:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Direction&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;left&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;37&lt;/span&gt;
    &lt;span class="n"&gt;up&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;38&lt;/span&gt;
    &lt;span class="n"&gt;right&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;39&lt;/span&gt;
    &lt;span class="n"&gt;down&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;40&lt;/span&gt;

    &lt;span class="nd"&gt;@property&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;is_horizontal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;right&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nd"&gt;@property&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;is_vertical&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;down&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;up&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and&amp;nbsp;conversion:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;as_vector&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;up&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;right&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="n"&gt;Direction&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;down&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For the latter, it would be handy to have the Java&amp;#8217;s ability to
&lt;a href="https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html"&gt;attach additional data&lt;/a&gt; to an enum constant.
As it turns out, Python supports this feature natively in a very similar way.
We simply have to override enum&amp;#8217;s &lt;code&gt;__new__&lt;/code&gt; method to parse out any extra values from the initializer
and turn them into attributes of the enum&amp;nbsp;instance:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Direction&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;left&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;37&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;up&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;38&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;right&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;39&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;down&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;40&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__new__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;keycode&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;vector&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;obj&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__new__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_value_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;keycode&lt;/span&gt;
        &lt;span class="n"&gt;obj&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vector&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;vector&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;obj&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It&amp;#8217;s possible, in fact, to insert any arbitrary computation here that yields the final &lt;code&gt;_value_&lt;/code&gt; of an enum constant&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3" rel="footnote"&gt;3&lt;/a&gt;&lt;/sup&gt;.
This trick can be used to, for example, construct enums that
&lt;a href="https://docs.python.org/3/library/enum.html#autonumber"&gt;automatically number themselves&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Finally, we can add static methods, class methods, or &lt;a href="http://stackoverflow.com/a/3203659"&gt;class properties&lt;/a&gt; to the
&lt;code&gt;Enum&lt;/code&gt; subclass, just like we would do with any other&amp;nbsp;class:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MyEnum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Enum&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;

    &lt;span class="nd"&gt;@classproperty&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__values__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;Enums just&amp;nbsp;are&lt;/h4&gt;
&lt;p&gt;All these things are possible primarly because of the most notable aspect of Python enums: their existence
as an &lt;em&gt;explicit concept&lt;/em&gt;. A syntactically unorganized bunch of constants cannot offer half of the highlighted features
because there is nowhere to pin them&amp;nbsp;on.&lt;/p&gt;
&lt;p&gt;For that reason alone, using enums as an explicit &amp;#8212; rather than implicit &amp;#8212; pattern seems worthwhile.
The one benefit we&amp;#8217;re certain to reap is better code structure through separation of important&amp;nbsp;concepts.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;The &lt;code&gt;enum&lt;/code&gt; module is part of the Python standard library
&lt;a href="https://docs.python.org/3/library/enum.html"&gt;since version 3.4&lt;/a&gt;
but &lt;a href="https://pypi.python.org/pypi/enum/"&gt;a fully functional backport&lt;/a&gt; is available for Python 2.x as well.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;It is even possible to instruct SQLAlchemy how to map Python enums to
&lt;a href="http://www.postgresql.org/docs/9.1/static/datatype-enum.html"&gt;&lt;code&gt;ENUM&lt;/code&gt; types&lt;/a&gt; in database engines that support it,
but details are outside of the scope of this article.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;If you&amp;#8217;re fine with the enum&amp;#8217;s &lt;code&gt;value&lt;/code&gt; being the &lt;em&gt;whole&lt;/em&gt; tuple (everything after the &lt;code&gt;=&lt;/code&gt; sign),
you can override &lt;code&gt;__init__&lt;/code&gt; instead of &lt;code&gt;__new__&lt;/code&gt;
(cf. &lt;a href="https://docs.python.org/3/library/enum.html#planet"&gt;the planet example&lt;/a&gt; from standard docs).&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Sun, 25 Oct 2015 20:59:00 -0700</pubDate><guid>tag:xion.io,2015-10-25:post/code/python-enums-are-ok.html</guid><category>Python</category><category>enums</category><category>serialization</category></item><item><title>CSS class helper for Jinja</title><link>http://xion.io/post/code/jinja-classlist.html</link><description>&lt;p&gt;One of the great uses for a templating engine such as &lt;a href="http://jinja.pocoo.org"&gt;Jinja&lt;/a&gt; is reducing the clutter
in our &lt;span class="caps"&gt;HTML&lt;/span&gt; source files. Even with the steady advances in the &lt;span class="caps"&gt;CSS&lt;/span&gt;&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt; standards, various &lt;code&gt;div.wrapper&lt;/code&gt;, &lt;code&gt;div.container&lt;/code&gt;,
&lt;code&gt;div.content&lt;/code&gt;, and other presentational elements are still a common fact of life.
Unless you&amp;#8217;re one of the cool kids who use &lt;a href="http://webcomponents.org/"&gt;Web Components&lt;/a&gt; with
&lt;a href="https://www.polymer-project.org"&gt;Polymer&lt;/a&gt;, your main option for abstracting this boilerplate away
is defining some more general &lt;a href="http://jinja.pocoo.org/docs/dev/templates/#macros"&gt;template macros&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;As with any kind of abstraction, it&amp;#8217;s crucial to balance broad applicability with a potential for finely-tuned
customization. In the case of wrapping &lt;span class="caps"&gt;HTML&lt;/span&gt; snippets in Jinja macros, an easy way to maintain flexibility is to allow
the caller to specify some crucial attributes of the root&amp;nbsp;element:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;{#&lt;/span&gt;
&lt;span class="c"&gt;  Renders the markup for a &amp;lt;button&amp;gt; from Twitter Bootstrap.&lt;/span&gt;
&lt;span class="c"&gt;#}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;macro&lt;/span&gt; &lt;span class="nv"&gt;button&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kp"&gt;none&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;style&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;default&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;button&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &amp;lt;button type=&amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="x"&gt;        class=&amp;quot;btn btn-&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;style&lt;/span&gt; &lt;span class="cp"&gt;}}{%&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nv"&gt;class&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt; &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;class&lt;/span&gt; &lt;span class="cp"&gt;}}{%&lt;/span&gt; &lt;span class="k"&gt;endif&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="x"&gt;        &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="nf"&gt;xmlattr&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="x"&gt;    &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;text&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &amp;lt;/button&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endmacro&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;An element &lt;code&gt;id&lt;/code&gt; would be a good example, and in the above macro it&amp;#8217;s handled implicility
thanks to the &lt;code&gt;{{ kwargs|xmlattr }}&lt;/code&gt; stanza.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;class&lt;/code&gt;, however, is not that simple, because a macro like that usually needs to supply some &lt;span class="caps"&gt;CSS&lt;/span&gt; classes of its own.
The operation of combining them with additional ones, passed by the caller, is awfully textual and error-prone.
It&amp;#8217;s easy, for example, to forget about the crucial space and run two class names&amp;nbsp;together.&lt;/p&gt;
&lt;p&gt;As if &lt;span class="caps"&gt;CSS&lt;/span&gt; wasn&amp;#8217;t difficult enough to debug&amp;nbsp;already!&lt;/p&gt;
&lt;h4&gt;Let them have&amp;nbsp;list&lt;/h4&gt;
&lt;p&gt;The root cause for any of those problems is working at a level that&amp;#8217;s too low for the task.
The value for a &lt;code&gt;class&lt;/code&gt; attribute may be &lt;em&gt;encoded&lt;/em&gt; as string, but it&amp;#8217;s fundamentally a &lt;em&gt;list of tokens&lt;/em&gt;.
In the modern &lt;span class="caps"&gt;DOM&lt;/span&gt; &lt;span class="caps"&gt;API&lt;/span&gt;, for example, it is represented
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/classList"&gt;as exactly that&lt;/a&gt;: a &lt;code&gt;DOMTokenList&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I&amp;#8217;ve found it helpful to replicate a similar mechanism in Jinja templates. The result is a &lt;code&gt;ClassList&lt;/code&gt; wrapper
whose code I quote here in&amp;nbsp;full:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;collections&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;MutableSet&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ClassList&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MutableSet&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Data structure for holding, and ultimately returning as a single string,&lt;/span&gt;
&lt;span class="sd"&gt;    a set of identifiers that should be managed like CSS classes.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Constructor.&lt;/span&gt;
&lt;span class="sd"&gt;        :param arg: A single class name or an iterable thereof.&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;basestring&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;classes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Iterable&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;classes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;arg&lt;/span&gt;
        &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;arg&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="ne"&gt;TypeError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
                &lt;span class="s"&gt;&amp;quot;expected a string or string iterable, got &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__contains__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;class_&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;class_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__iter__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;iter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__len__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;class_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;class_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;discard&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;class_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;discard&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;class_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__str__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;sorted&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;classes&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__html__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;class=&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;To make it work with &lt;a href="http://flask.pocoo.org"&gt;Flask&lt;/a&gt;, adorn the class with
&lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.template_global"&gt;&lt;code&gt;Flask.template_global&lt;/code&gt; decorator&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;myflaskapp&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;

&lt;span class="nd"&gt;@app.template_global&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;classlist&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ClassList&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MutableSet&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Otherwise, if you&amp;#8217;re working with a raw &lt;a href="http://jinja.pocoo.org/docs/dev/api/#jinja2.Environment"&gt;Jinja &lt;code&gt;Environment&lt;/code&gt;&lt;/a&gt;,
simply add &lt;code&gt;ClassList&lt;/code&gt; to its &lt;a href="http://jinja.pocoo.org/docs/dev/api/#global-namespace"&gt;global namespace&lt;/a&gt;&amp;nbsp;directly:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;jinja_env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;globals&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;classlist&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ClassList&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In either case, I recommend following the apparent Jinja convention of naming template symbols
as &lt;code&gt;lowercasewithoutspaces&lt;/code&gt;.&lt;/p&gt;
&lt;h4&gt;Becoming&amp;nbsp;classy&lt;/h4&gt;
&lt;p&gt;Usage of this new &lt;code&gt;classlist&lt;/code&gt; helper is relatively straightforward. Since it accepts both a space-separated string
or an iterable of &lt;span class="caps"&gt;CSS&lt;/span&gt; class names, a macro can wrap anything the caller would pass it as a value for &lt;code&gt;class&lt;/code&gt; attribute:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;macro&lt;/span&gt; &lt;span class="nv"&gt;button&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kp"&gt;none&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;style&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;default&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;button&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;set&lt;/span&gt; &lt;span class="nv"&gt;classes&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nv"&gt;classlist&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;class&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &lt;/span&gt;&lt;span class="c"&gt;{# ... #}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;code&gt;classlist&lt;/code&gt; is capable of producing the complete &lt;code&gt;class&lt;/code&gt; attribute syntax (i.e. &lt;code&gt;class="..."&lt;/code&gt;), or omit it entirely
if it would be empty. All we need to do is evaluate it using the normal Jinja expression&amp;nbsp;syntax:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;  &amp;lt;button type=&amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot; &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;classes&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt; &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="nf"&gt;xmlattr&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Before that, though, we may want to include some additional classes that are specific to our macro.
The &lt;code&gt;button&lt;/code&gt; macro, for example, needs to add the &lt;a href="http://getbootstrap.com/css/#buttons"&gt;Bootstrap-specific&lt;/a&gt;
&lt;code&gt;btn&lt;/code&gt; and &lt;code&gt;btn-$STYLE&lt;/code&gt; classes to the &lt;code&gt;&amp;lt;button&amp;gt;&lt;/code&gt; element it produces&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;  &lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="nv"&gt;classes.add&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;btn&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;btn-&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nv"&gt;style&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;After executing this statement, the final &lt;code&gt;class&lt;/code&gt; attribute contains both the caller-provided classes,
as well those two that were added&amp;nbsp;explicitly.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Believe it or not, we can finally
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/CSS/justify-content"&gt;center the content vertically&lt;/a&gt;
without much of an issue!&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;The &lt;code&gt;{% do %}&lt;/code&gt; block in Jinja allows to execute statements (such as function calls) without evaluating values
they return. It is not exposed by default,
but &lt;a href="http://jinja.pocoo.org/docs/dev/api/#jinja2.Environment.add_extension"&gt;adding&lt;/a&gt; a standard
&lt;a href="http://jinja.pocoo.org/docs/dev/extensions/#expression-statement"&gt;&lt;code&gt;jinja2.ext.do&lt;/code&gt; extension&lt;/a&gt; to the &lt;code&gt;Environment&lt;/code&gt;
makes it available.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Thu, 22 Oct 2015 18:38:00 -0700</pubDate><guid>tag:xion.io,2015-10-22:post/code/jinja-classlist.html</guid><category>Jinja</category><category>CSS</category><category>Python</category><category>Flask</category></item><item><title>Regular expression filters in SQLAlchemy</title><link>http://xion.io/post/code/sqlalchemy-regex-filters.html</link><description>&lt;p&gt;The nice part about &lt;a href="http://www.sqlalchemy.org/"&gt;SQLAlchemy&lt;/a&gt;
&amp;#8212; an &lt;a href="https://en.wikipedia.org/wiki/Object-relational_mapping"&gt;&lt;span class="caps"&gt;ORM&lt;/span&gt;&lt;/a&gt; library/framework for Python &amp;#8212;
is that it offers much more than just mapping of &lt;span class="caps"&gt;SQL&lt;/span&gt; relations to model classes. At its lower level, for example,
there exists an additional layer between those classes and raw &lt;span class="caps"&gt;SQL&lt;/span&gt; queries: an abstraction for the &lt;em&gt;&lt;span class="caps"&gt;SQL&lt;/span&gt; language itself&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Although it may sound byzantine at first, this extra layer serves two important&amp;nbsp;purposes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;portability&lt;/em&gt;: compiling of the same query to potentially different &lt;span class="caps"&gt;SQL&lt;/span&gt; syntaxes,
as required by different database&amp;nbsp;backends&lt;/li&gt;
&lt;li&gt;&lt;em&gt;extensibility&lt;/em&gt;: allowing the user to introduce new elements: operators, functions, or even whole&amp;nbsp;statements&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I&amp;#8217;m going to take advantage of both of these qualities here, and show how you can implement support
for &lt;em&gt;regular expression&lt;/em&gt; operators in query filters. On supported database backends, it will allow for powerful
pattern matching on string&amp;nbsp;columns.&lt;/p&gt;
&lt;h4&gt;Database&amp;nbsp;side&lt;/h4&gt;
&lt;p&gt;We will use the Postgres syntax of &lt;span class="caps"&gt;POSIX&lt;/span&gt;
&lt;a href="http://www.postgresql.org/docs/9.3/static/functions-matching.html#FUNCTIONS-POSIX-REGEXP"&gt;regular expression matchers&lt;/a&gt;
as a reference. It includes four operators: for case sensitive or insensitive matching, in regular or negated&amp;nbsp;versions.&lt;/p&gt;
&lt;p&gt;Since it&amp;#8217;s a common practice to use an in-memory &lt;a href="https://www.sqlite.org/"&gt;SQLite&lt;/a&gt; for running database-involved
&amp;#8220;unit&amp;#8221; tests&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;, we will also add support for that backend. Regular expressions are not implemented there directly,
but thanks to
&lt;a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"&gt;&lt;code&gt;sqlite3&lt;/code&gt;&lt;span class="quo"&gt;&amp;#8216;&lt;/span&gt;s custom function ability&lt;/a&gt;,
it&amp;#8217;ll be easy enough to provide the necessary support in&amp;nbsp;Python.&lt;/p&gt;
&lt;h4&gt;Desired &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;In essence, what we want to do is to enhance the &lt;code&gt;String&lt;/code&gt; column type with additional &lt;em&gt;comparators&lt;/em&gt;, which will then
be usable as arguments for the &lt;code&gt;Query.filter&lt;/code&gt; method.&lt;/p&gt;
&lt;p&gt;As an example, consider the following model class with a string&amp;nbsp;column:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Person&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Model&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;nick&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Column&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;255&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Once we&amp;#8217;re done, it should be possible to query for e.g. all the people whose nicks contain numbers
in a pretty straightforward&amp;nbsp;fashion:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;numerics&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;nick&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;r&amp;#39;\d+&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Because of the limitations of underlying databases backends, only &lt;em&gt;literal&lt;/em&gt; regular expressions would be supported.
It means that, from the &lt;span class="caps"&gt;SQL&lt;/span&gt; standpoint, they have to be constants: you cannot use the value of one column as part
of a regular expression that another column is matched&amp;nbsp;against.&lt;/p&gt;
&lt;p&gt;But of course, you can still construct those literals in Python&amp;nbsp;code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_copycats&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nick&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Return all the people who tried to parrot given nick&lt;/span&gt;
&lt;span class="sd"&gt;    but failed and had to append some numbers to it.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;nick_regexp&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;^&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;escape&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nick&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s"&gt;r&amp;#39;\d+$&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Person&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;nick&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nick_regexp&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Considering that regular expressions themselves are already pretty powerful, this really ought to be sufficient
for all reasonable&amp;nbsp;purposes.&lt;/p&gt;
&lt;h4&gt;How comparators&amp;nbsp;work?&lt;/h4&gt;
&lt;p&gt;So how do we add the &lt;code&gt;regexp&lt;/code&gt; method to the &lt;code&gt;String&lt;/code&gt; type? It may seem logical to simply extend the class
and add it&amp;nbsp;directly:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;String&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;_String&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_String&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Enhanced version of the standard string type.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c"&gt;# hmm...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But this won&amp;#8217;t actually work. In SQLAlchemy, objects like &lt;code&gt;String&lt;/code&gt; or &lt;code&gt;Integer&lt;/code&gt; do not represent columns of certain type;
they correspond to &lt;em&gt;types themselves&lt;/em&gt;&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;. Extending them with additional methods won&amp;#8217;t do much good, because regular code
rarely operates on column&amp;nbsp;types.&lt;/p&gt;
&lt;p&gt;On the other hand, though, we obviously don&amp;#8217;t want to mess with the &lt;code&gt;Column&lt;/code&gt; class itself. Our additions are only
meaningful for string columns, but putting them there would expose them to &lt;em&gt;all&lt;/em&gt; columns, regardless of&amp;nbsp;type!&lt;/p&gt;
&lt;p&gt;Thankfully, there is an intermediate mechanism which SQLAlchemy introduced precisely to address the need we&amp;#8217;ve got here.
Every column type can define a
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/type_api.html#sqlalchemy.types.TypeEngine.comparator_factory"&gt;&lt;code&gt;comparator_factory&lt;/code&gt;&lt;/a&gt;: a kind of mixin class whose methods are incorporated into columns of that type.
By &lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/custom_types.html#types-operators"&gt;overriding this inner class&lt;/a&gt;,
we can both modify the behavior of existing operators, as well as introduce completely new&amp;nbsp;ones.&lt;/p&gt;
&lt;p&gt;So in order to add &lt;code&gt;regexp&lt;/code&gt; and other methods to all &lt;code&gt;String&lt;/code&gt; columns, our new string type must define its own
&lt;code&gt;comparator_factory&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;String&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_String&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;comparator_factory&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_String&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;comparator_factory&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We need to remember about deriving it from the original one, too. Otherwise, all the standard operators
you&amp;#8217;d want to use in queries (&lt;code&gt;==&lt;/code&gt;, &lt;code&gt;+&lt;/code&gt;, etc.) would cease to work, because the new &lt;code&gt;comparator_factory&lt;/code&gt; wouldn&amp;#8217;t
include an implementation of any of the necessary magic methods (&lt;code&gt;__eq__&lt;/code&gt;, &lt;code&gt;__add__&lt;/code&gt;,&amp;nbsp;etc.).&lt;/p&gt;
&lt;h4&gt;&lt;span class="caps"&gt;SQL&lt;/span&gt;,&amp;nbsp;abstracted&lt;/h4&gt;
&lt;p&gt;Knowing where to put our new comparator methods is certainly desirable, but the more interesting question is
how do we implement&amp;nbsp;them?&lt;/p&gt;
&lt;p&gt;Like I&amp;#8217;ve mentioned in the beginning, SQLAlchemy employs an additional layer between
&lt;span class="caps"&gt;ORM&lt;/span&gt; models and raw, textual &lt;span class="caps"&gt;SQL&lt;/span&gt; language. Basically, it&amp;#8217;s an &lt;a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"&gt;&lt;span class="caps"&gt;AST&lt;/span&gt;&lt;/a&gt;
for backend-independent queries which includes almost all of the various &lt;span class="caps"&gt;SQL&lt;/span&gt; constructs, codified in a platform-agnostic
way inside the &lt;code&gt;sqlalchemy.sql&lt;/code&gt; package.&lt;/p&gt;
&lt;p&gt;You may have used this layer directly if you ever wrote queries based on
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/metadata.html#sqlalchemy.schema.Table"&gt;&lt;code&gt;Table&lt;/code&gt; objects&lt;/a&gt; and ran them with
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/session_api.html#sqlalchemy.orm.session.Session.execute"&gt;&lt;code&gt;Session.execute&lt;/code&gt;&lt;/a&gt;. But even those constructed using the more familiar
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query"&gt;&lt;code&gt;Query&lt;/code&gt; class&lt;/a&gt; interface
end up in this intermediate representation. Often there is little to no additional processing&amp;nbsp;involved.&lt;/p&gt;
&lt;p&gt;Arguments to the
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/query.html#sqlalchemy.orm.query.Query.filter"&gt;&lt;code&gt;Query.filter&lt;/code&gt; method&lt;/a&gt;,
for example, are already given as &lt;span class="caps"&gt;SQL&lt;/span&gt; clause objects. It just so happens that its creation is hidden behind
a very neat, operator-based &lt;span class="caps"&gt;API&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Thus, if our regular expression filters are to cooperate, they also need to return pieces of the &lt;span class="caps"&gt;SQL&lt;/span&gt; syntax tree.
Not very complicated pieces, mind you, since we only need to represent simple expressions: something like &lt;code&gt;foo ~ 'bar'&lt;/code&gt;, where &lt;code&gt;~&lt;/code&gt; may optionally be replaced by one of the other three&amp;nbsp;operators.&lt;/p&gt;
&lt;h4&gt;Creating the&amp;nbsp;node&lt;/h4&gt;
&lt;p&gt;They are all &lt;em&gt;binary&lt;/em&gt; operators, by the way (i.e. taking exactly two arguments), so it makes sense that the corresponding
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.BinaryExpression"&gt;&lt;span class="caps"&gt;AST&lt;/span&gt; node class&lt;/a&gt; is called &lt;code&gt;BinaryExpression&lt;/code&gt;. The node&amp;#8217;s children are the left argument, the right argument, and the operator&amp;nbsp;itself.&lt;/p&gt;
&lt;p&gt;With a little help from a few more &lt;span class="caps"&gt;SQL&lt;/span&gt; syntax wrappers, the implementation of &lt;code&gt;regexp&lt;/code&gt; and the other methods
turns out to be quite&amp;nbsp;straightforward:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.sql.expression&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BinaryExpression&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;literal&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.sql.operators&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;custom_op&lt;/span&gt;


&lt;span class="c"&gt;# (inside String.comparator_factory)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;BinaryExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expr&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;literal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;custom_op&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;~&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;iregexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;BinaryExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expr&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;literal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;custom_op&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;~*&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;not_regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;BinaryExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expr&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;literal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;custom_op&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;!~&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;not_iregexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;BinaryExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expr&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;literal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;custom_op&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;!~*&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The use of
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.literal"&gt;&lt;code&gt;literal&lt;/code&gt; function&lt;/a&gt;
is dictated by the limitation that was mentioned earlier: any regular expression given in the query must be a &lt;span class="caps"&gt;SQL&lt;/span&gt; literal.
If we now try to pass a column-like clause, we&amp;#8217;ll get an exception right at the query definition, rather than
a database error when we try to execute&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;The &lt;a href="docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.operators.custom_op"&gt;&lt;code&gt;custom_op&lt;/code&gt; function&lt;/a&gt;,
on the other hand, is simply the easiest way to create an &amp;#8220;operator node&amp;#8221; that&amp;#8217;s required as a child
of &lt;code&gt;BinaryExpression&lt;/code&gt;. Since it&amp;#8217;s a custom operator, it won&amp;#8217;t be interpreted by SQLAlchemy in any way; it will simply
be used verbatim in the final &lt;span class="caps"&gt;SQL&lt;/span&gt; string that&amp;#8217;s sent to the&amp;nbsp;database.&lt;/p&gt;
&lt;h4&gt;Compile!&lt;/h4&gt;
&lt;p&gt;You may have noticed that this would pose a problem if said database doesn&amp;#8217;t support &lt;code&gt;~&lt;/code&gt; or the other operators,
which happens to be the case for everything besides Postgres. Because we originally intended to support SQLite in addition
to Postgres, this is evidently a&amp;nbsp;problem.&lt;/p&gt;
&lt;p&gt;It&amp;#8217;s also where the portability of an intermediate &lt;span class="caps"&gt;SQL&lt;/span&gt; representation comes into play. Since our new operators return
&lt;span class="caps"&gt;AST&lt;/span&gt; nodes and not just textual &lt;span class="caps"&gt;SQL&lt;/span&gt;, we can redefine the way those nodes are &lt;em&gt;compiled&lt;/em&gt; into actual query fragments
on various database&amp;nbsp;backends.&lt;/p&gt;
&lt;p&gt;To accomplish that, first we need to distinguish our regex filters from other &lt;code&gt;BinaryExpression&lt;/code&gt;s:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;RegexMatchExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BinaryExpression&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Represents matching of a column againsts a regular expression.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# (inside String.comparator_factory)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;regexp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;RegexMatchExpression&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;expr&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;literal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;other&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;custom_op&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;~&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="c"&gt;# etc.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Once we&amp;#8217;ve introduced such a distinction, it becomes possible to provide a different way for those filters to be turned
into &lt;span class="caps"&gt;SQL&lt;/span&gt;. We can namely define a new compilation routine for them,
and &lt;a href="docs.sqlalchemy.org/en/rel_0_9/core/compiler.html#sqlalchemy.ext.compiler.compiles"&gt;mark it as canonical&lt;/a&gt;
for a specific &lt;span class="caps"&gt;SQL&lt;/span&gt;&amp;nbsp;dialect:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.ext.compiler&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;compiles&lt;/span&gt;


&lt;span class="nd"&gt;@compiles&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RegexMatchExpression&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;sqlite&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sqlite_regex_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;compiler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kw&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Compile the SQL expression representing a regular expression match&lt;/span&gt;
&lt;span class="sd"&gt;    for the SQLite engine.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The function receives an &lt;span class="caps"&gt;AST&lt;/span&gt; &lt;code&gt;element&lt;/code&gt; to process (here, the &lt;code&gt;RegexMatchExpression&lt;/code&gt;), along with a
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/internals.html#sqlalchemy.sql.compiler.SQLCompiler"&gt;special &lt;code&gt;compiler&lt;/code&gt; object&lt;/a&gt;
that controls the whole translation process. Armed with those tools, we are allowed to modify the process
in arbitrary ways and output just the right &lt;span class="caps"&gt;SQL&lt;/span&gt; statement that&amp;#8217;ll do the job in&amp;nbsp;SQLite.&lt;/p&gt;
&lt;h4&gt;Regex support&amp;nbsp;lite&lt;/h4&gt;
&lt;p&gt;How does such a statement look like, though? As I&amp;#8217;ve remarked early on, SQLite is very easy to extend with your own
functions, and the &lt;code&gt;sqlite3&lt;/code&gt; driver used by SQLAlchemy enables us to write those functions directly in Python.
Obviously, this is fantastic news when you have something like
&lt;a href="https://docs.python.org/2/library/re.html"&gt;the standard &lt;code&gt;re&lt;/code&gt; module&lt;/a&gt; at your&amp;nbsp;disposal.&lt;/p&gt;
&lt;p&gt;Indeed, coding the four required functions is quite&amp;nbsp;trivial:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;

&lt;span class="c"&gt;# Mapping from the regular expression matching operators&lt;/span&gt;
&lt;span class="c"&gt;# to named Python functions that implement them for SQLite.&lt;/span&gt;
&lt;span class="n"&gt;SQLITE_REGEX_FUNCTIONS&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="s"&gt;&amp;#39;~&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;REGEXP&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bool&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;))),&lt;/span&gt;
    &lt;span class="s"&gt;&amp;#39;~*&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;IREGEXP&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bool&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IGNORECASE&lt;/span&gt;&lt;span class="p"&gt;))),&lt;/span&gt;
    &lt;span class="s"&gt;&amp;#39;!~&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;NOT_REGEXP&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
    &lt;span class="s"&gt;&amp;#39;!~*&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;NOT_IREGEXP&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;regex&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IGNORECASE&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What&amp;#8217;s less apparent is how &amp;#8212; or rather, &lt;em&gt;when&lt;/em&gt; &amp;#8212; to instruct the SQLite database to use them.
As per the &lt;a href="https://docs.python.org/2/library/sqlite3.html#sqlite3.Connection.create_function"&gt;&lt;span class="caps"&gt;API&lt;/span&gt; we have to use&lt;/a&gt;,
custom SQLite functions are created on a per-connection basis. But SQLAlchemy, like any good database interface,
takes care of connection management, lifecycle, and pooling. Nowhere in our application there is a &lt;code&gt;connect&lt;/code&gt; call
(nor there should be!) that we could just follow with a few &lt;code&gt;create_function&lt;/code&gt; invocations.&lt;/p&gt;
&lt;p&gt;Yet, there is a way of doing exactly what we require, and it involves utilizing the
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/event.html"&gt;event subsystem&lt;/a&gt; included in SQLAlchemy. Anytime something
interesting happens to any of its &lt;span class="caps"&gt;ORM&lt;/span&gt; or core objects &amp;#8212; models, sessions, connection pools, etc. &amp;#8212; SQLAlchemy
publishes an &lt;em&gt;event&lt;/em&gt; that our application code can &lt;em&gt;listen&lt;/em&gt; (subscribe) to. It&amp;#8217;s a classic
&lt;a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern"&gt;PubSub system&lt;/a&gt; that introduces some serious potential
for&amp;nbsp;extensibility.&lt;/p&gt;
&lt;p&gt;Our use of it will be pretty modest, though. All we&amp;#8217;re interested in is the establishing of a connection
to the SQLite database. This translates directly to a &lt;code&gt;'connect'&lt;/code&gt; event of the
&lt;a href="docs.sqlalchemy.org/en/rel_0_9/core/connections.html"&gt;&lt;code&gt;Engine&lt;/code&gt; object&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;event&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.engine&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Engine&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sqlite3&lt;/span&gt;


&lt;span class="nd"&gt;@event.listens_for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Engine&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;connect&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sqlite_engine_connect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dbapi_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection_record&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Listener for the event of establishing connection to a SQLite database.&lt;/span&gt;

&lt;span class="sd"&gt;    Creates the functions handling regular expression operators&lt;/span&gt;
&lt;span class="sd"&gt;    within SQLite engine, pointing them to their Python implementations above.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;dbapi_connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sqlite3&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt;

    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;function&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;SQLITE_REGEX_FUNCTIONS&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
        &lt;span class="n"&gt;dbapi_connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;function&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that this will catch all the connection events, so we have to verify it&amp;#8217;s really SQLite we&amp;#8217;re talking to.
Afterwards, the creation of &lt;code&gt;REGEXP&lt;/code&gt;, &lt;code&gt;IREGEXP&lt;/code&gt;, etc. functions is extremely&amp;nbsp;straightforward.&lt;/p&gt;
&lt;h4&gt;Compilation, take&amp;nbsp;two&lt;/h4&gt;
&lt;p&gt;This was quite a build-up, but now we&amp;#8217;re very close to the finale. What remains is finishing the compilation&amp;nbsp;routine:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@compiles&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RegexMatchExpression&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;sqlite&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sqlite_regex_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;compiler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kw&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We know that &lt;code&gt;element&lt;/code&gt; corresponds to an expression in the form of &lt;code&gt;a ~ 'foo'&lt;/code&gt;. For SQLite, however, the compatible
version is a &lt;em&gt;function call&lt;/em&gt;: &lt;code&gt;REGEXP(a, 'foo')&lt;/code&gt;. At first this may appear rather disconcerting, because it&amp;#8217;s basically
a completely different &lt;span class="caps"&gt;AST&lt;/span&gt; node to&amp;nbsp;build.&lt;/p&gt;
&lt;p&gt;But it&amp;#8217;s actually not a problem at all. Inside compiler hooks, we are allowed to use the much of the same &lt;span class="caps"&gt;API&lt;/span&gt; that&amp;#8217;s
available when drafting regular queries. This includes the
&lt;a href="http://docs.sqlalchemy.org/en/rel_0_9/core/sqlelement.html#sqlalchemy.sql.expression.func"&gt;&lt;code&gt;func&lt;/code&gt; factory object&lt;/a&gt;
which produces calls to arbitrary &lt;span class="caps"&gt;SQL&lt;/span&gt; functions. Rather than compiling the original binary expression, we&amp;#8217;ll simply
poach its operands and use them as arguments to one of the new&amp;nbsp;functions:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;exc&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.sql.expression&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;


&lt;span class="nd"&gt;@compiles&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;RegexMatchExpression&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;sqlite&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;sqlite_regex_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;compiler&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kw&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# determine the name of a custom SQLite function to use for the operator&lt;/span&gt;
    &lt;span class="n"&gt;operator&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;operator&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;opstring&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;func_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SQLITE_REGEX_FUNCTIONS&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;operator&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;KeyError&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ne"&gt;ValueError&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;would_be_sql_string&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;compiler&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                        &lt;span class="n"&gt;operator&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                        &lt;span class="n"&gt;compiler&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;right&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
        &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;exc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StatementError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="s"&gt;&amp;quot;unknown regular expression match operator: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;operator&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;would_be_sql_string&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c"&gt;# compile the expression as an invocation of the custom function&lt;/span&gt;
    &lt;span class="n"&gt;regex_func&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;func_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;regex_func_call&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;regex_func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;left&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;element&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;right&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;compiler&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;regex_func_call&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Notice how &lt;code&gt;compiler.process&lt;/code&gt; is used to obtain the final result. The &lt;code&gt;compiler&lt;/code&gt; object doesn&amp;#8217;t care that we use it on
a totally different &lt;span class="caps"&gt;AST&lt;/span&gt; node; it will dutifully carry out its compilation into raw &lt;span class="caps"&gt;SQL&lt;/span&gt;. We can even use this capability
to add a little bit of paranoid error handling: if we encounter an unknown operator, the resulting error message
will include fully compiled, &lt;span class="caps"&gt;SQL&lt;/span&gt; versions of both&amp;nbsp;arguments.&lt;/p&gt;
&lt;h4&gt;Summary&lt;/h4&gt;
&lt;p&gt;This concludes our efforts: the original query examples with &lt;code&gt;Person.nick.regexp&lt;/code&gt; should now work
in both Postgres and SQLite.
For you convenience, I&amp;#8217;ve bundled all the code in &lt;a href="https://gist.github.com/Xion/204ddbd020f1a4275a53"&gt;this gist&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you feel like tinkering with it further, I would suggest you try to remove the superfluous &lt;code&gt;NOT_*&lt;/code&gt; functions.
They make little sense given that &lt;span class="caps"&gt;SQL&lt;/span&gt; has a perfectly adequate &lt;code&gt;NOT&lt;/code&gt; keyword. A clean solution would probably prefer
an additional &lt;code&gt;reverse&lt;/code&gt; flag in &lt;code&gt;RegexMatchExpression&lt;/code&gt; over looking for a &lt;code&gt;'!'&lt;/code&gt; character in the operator&amp;nbsp;string.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;It may or &lt;a href="http://michael.robellard.com/2015/07/dont-test-with-sqllite-when-you-use.html"&gt;may not be&lt;/a&gt;
a &lt;em&gt;good&lt;/em&gt; practice, though.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Although it&amp;#8217;s possible to write &lt;code&gt;Column(Integer)&lt;/code&gt;, it&amp;#8217;s merely a syntactical convenience.
SQLAlchemy interprets it readily as &lt;code&gt;Column(Integer())&lt;/code&gt;. Parameterized types &amp;#8212; like &lt;code&gt;String&lt;/code&gt; &amp;#8212; always require explicit
instantiation.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Wed, 14 Oct 2015 10:15:00 -0700</pubDate><guid>tag:xion.io,2015-10-14:post/code/sqlalchemy-regex-filters.html</guid><category>regular expressions</category><category>SQLAlchemy</category><category>SQL</category><category>Postgres</category><category>SQLite</category><category>AST</category></item><item><title>Optional loading of RequireJS modules</title><link>http://xion.io/post/code/requirejs-optional.html</link><description>&lt;p&gt;&lt;a href="http://requirejs.org/"&gt;RequireJS&lt;/a&gt; is a module loader for JavaScript. Similar to its alternatives such as
&lt;a href="http://browserify.org/"&gt;Browserify&lt;/a&gt;, it tries to solve an important problem on the web front(end):
dividing JavaScript code into modules for better maintainability while still loading them correctly and efficiently
without manual curation of the &lt;code&gt;&amp;lt;script&amp;gt;&lt;/code&gt; tags.&lt;/p&gt;
&lt;p&gt;Once it&amp;#8217;s configured correctly (which can be rather &lt;a href="http://requirejs.org/docs/api.html#config"&gt;non-trivial&lt;/a&gt;, though),
modules in RequireJS are simply &lt;code&gt;define&lt;/code&gt;d as functions that return arbitrary JavaScript&amp;nbsp;objects:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;define&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;jquery&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;lodash&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;

    &lt;span class="s1"&gt;&amp;#39;myapp/dep1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;myapp/dep2&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;_&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;dep1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;dep2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ... all of the module&amp;#39;s code ...&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;exportedSymbol1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="p"&gt;...,&lt;/span&gt;
        &lt;span class="nx"&gt;exportedSymbol2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="p"&gt;...,&lt;/span&gt;
    &lt;span class="p"&gt;};&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Before executing the function, RequireJS loads all the specified dependencies, repeating the process recursively
and asynchronously. Return values from module functions are passed as parameters to the next module function,
and thus the whole mechanism clicks, serving as a crafty workaround for the lack of proper &lt;code&gt;import&lt;/code&gt; functionality&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h4&gt;Relative&amp;nbsp;failures&lt;/h4&gt;
&lt;p&gt;If, at some point in the chain, the desired module cannot be found or loaded, the entire process grinds to a halt
with an error. Most of the time, this is perfectly acceptable (or even desirable) behavior, equivalent to an incorrect
&lt;code&gt;import&lt;/code&gt; statement, invalid &lt;code&gt;#include&lt;/code&gt; directive, or similar mistake in other&amp;nbsp;languages.&lt;/p&gt;
&lt;p&gt;But there are situations when we&amp;#8217;d like to proceed with a missing module, because the dependent code is prepared
to handle it. The canonical example are
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers"&gt;Web Workers&lt;/a&gt;.
Unlike traditional web application code, Web Worker scripts operate outside of a context of any single page,
having no access to the &lt;abbr title="Document Object Model"&gt;&lt;span class="caps"&gt;DOM&lt;/span&gt;&lt;/abbr&gt; tree (because &lt;em&gt;which&lt;/em&gt; &lt;span class="caps"&gt;DOM&lt;/span&gt; tree would it be?).
Correspondingly, they have no &lt;code&gt;document&lt;/code&gt; nor &lt;code&gt;window&lt;/code&gt; objects in their global&amp;nbsp;scope.&lt;/p&gt;
&lt;p&gt;Unfortunately, some libraries (&lt;em&gt;*cough*&lt;/em&gt; jQuery &lt;em&gt;*cough*&lt;/em&gt;) require those objects as a hard (and usually implicit)
dependency. This doesn&amp;#8217;t exactly help if we&amp;#8217;d like to use them in worker code for other features, not related to &lt;span class="caps"&gt;DOM&lt;/span&gt;.
In case of jQuery, for example, it could be the &lt;span class="caps"&gt;API&lt;/span&gt; for making &lt;span class="caps"&gt;AJAX&lt;/span&gt; calls, which is still decidedly more pleasant
than dealing with bare &lt;code&gt;XMLHTTPRequest&lt;/code&gt; if we&amp;#8217;re doing anything&amp;nbsp;non-trivial.&lt;/p&gt;
&lt;p&gt;Due to this hard dependency on &lt;span class="caps"&gt;DOM&lt;/span&gt;, however, Web Workers cannot &lt;code&gt;require&lt;/code&gt; jQuery. No biggie, you may think: browsers
supporting workers also offer an excellent, promise-based
&lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API"&gt;Fetch &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt; that largely replaces the old &lt;span class="caps"&gt;AJAX&lt;/span&gt;,
so we may just use it in worker code. Good thinking indeed, but it doesn&amp;#8217;t solve the issue of &lt;em&gt;sharing code&lt;/em&gt; between
main (&amp;#8220;&lt;span class="caps"&gt;UI&lt;/span&gt;&amp;#8221;) part of the app and Web&amp;nbsp;Workers.&lt;/p&gt;
&lt;p&gt;Suppose you have the following dependency&amp;nbsp;graph:&lt;/p&gt;
&lt;p&gt;&lt;div class="graphviz" style="text-align: center;"&gt;&lt;img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAD7CAYAAAAvttudAAAy0klEQVR4Ae2dBbhVVRbHtzEWtoiOimJjIphYYHegjgp2d4/1GTjG2DHGOJigiIqtYIGK2DN2JyCYOHYyo+5ZvzXu63n3nXvejXPuPbHX95137juxY529dqz476mstcONJ88Bz4FQDkwlAmJD7/iLngOeA2ZqzwPPAc+ByhzwAlKZN/6O54AfQXwb8ByI4sC0UTeTvvfvf//bvPrqq3qMGzfOfPTRR3p8/PHH5rvvvjM//vij+emnn8x///tfM8MMM+gx44wzmtlnn93MN998esw///yme/fuZtlllzVLLbWUPpN0uYuQ/i+//GI++OADM378eMO3mTBhgvnss88M38wdX3/9tfnPf/5jpkyZUjrDm+mnn95MN910pfNss81mOnfuXDrmnntu061bN7PIIouYhRde2CywwAJmmmmmSSVbm7pIRxgeffRRPR5//HGDIEBzzjmnWXzxxQ2NnYb/xz/+0cwyyywlgfjDH/6ggoKwIDRffPFFSZj4iG+//bZ+JJiMkKy99tqmT58+eswzzzypZHyaCjV58mTzwgsvmBdffLF0vPfee9oxUc6ZZppJGzS8nGuuuUoNnY4KYQgKBM8HBYbfX331VUmoPv/8c/Ppp5+qwP3www88bvi+iy22mOnRo4dZYYUV9OjZs6fp0qWL3m/ln0QF5NdffzVPPPGEuf322/WYOHGioTdZc801zVprrWV69eqlPT8C0QjR273zzjs6Ej3zzDNm7Nix5vnnnzdcX2211cw222xjtt12W+2tGsknL+8yUo8ZM6bUWb311ltaNXpyGinHMsssU+rhk+pkEBQ3Qr322mvmpZdeUgH98MMPtTxLLrlkqaPr27evdp5N/waoeeOmTz75xJ5xxhl2oYUWQoVsl156aXvCCSfYf/3rX1YabdzZhab37bff2rvvvtvuvvvuVkYoLYcw2d50001WpgWh7+T5oowO9pRTTrHSMysvpNe2vXv3tscdd5y99957rUybUlN9ykKZKBtlpKy0I8pOHahLs8jEmZH04na33XbTCtEojzjiCCs9Q5xZ1JWWrGGU4VtttZWVaZiVHtGeffbZVtY5daWXlZdk3WAHDhxoZZ6vDUymr3b//fdXXnz//fdZqYalrAgMZacOCAt1om7UMUmKRUBk6qSCQeNbYokl7LXXXmtlrZBkuetOW9Ys9thjj7UzzzyzlcWiPe+886zMk+tOL20vMkLfcsstdv3117dTTTWVlXm8PfLII3X0lilv2opbc3moAzMR6kTdqCN1pc5JzE4aEhB65nPOOcd26tTJLrroonbo0KH2559/rrnSrXiBYfz444+3ohWzogWzDz/8cCuKEVueosCwgwYNsrLYtVNPPbXdcsst7V133WX5Rnkl6kYdt9hiC60zdYcH8CIuqltAXn/9dbv88strAzv11FNjLVRclasmHVkkamNi2N577711OK/mvbQ8Q6951VVXWVF0WNEm2X322cfKojstxWtaOagzdYcH8AKexDGi1CUg11xzjRXVn1111VWtqAObxoQkM7rtttt0MY9C4ZVXXkkyq9jSZtQTjZOddtpp7YEHHmhRjhSd4AG8gCfwptGZQU0CwvyPhTfzPjQMeRu+WUuJClrXJw888EBq2xoaOkY7Rj2mF2+88UZqy9qqgsETeONmBvCsHqpaQFCN9u/f34qF1A4bNqyevDLxDvXcZZddVBN3/fXXp67MYmBVDY5YpnVhmroCpqxALN7hFVoveFcrVSUgjBwDBgzQnrXRIavWArbq+WOOOUYXfjA4LXTllVeq4LIAFyNbWoqV+nLAK3iGPQUe1kJVCQjTKkaOUaNG1ZJ25p89+OCDddH3yCOPtLQudFBHH320Tm1POukky/+eauMAPIN3LA/gZbU87FBAbrzxRp3HcS4awcTttttO7SXiN9aS6lMGtDP0fkX8BnEzHR7CS3hajZBECghWSvGdUq1A3AXNSnrffPON2ng23HDDqhgad70wamKAHT58eNxJFzY9eAlPUTR1RJECghYAtWdareIdVS6u++IAqeuR6667Lq4kq0rnhhtu0NEbzwRP8XIAnqLhgsdRVFFAxC1dE7j//vuj3i/Mvb322ssuuOCCTTOIMnrjDnP44YcXhsfNrii8hcdR/lwV3d3XWWcd9dN/8MEHRdA84SJOzIL4bhkxRCXOEBm9NVAJt33iLTzFzwFiVQi5IHDrnnvuCc0gVEDeffddDWAaMWKE2WyzzUJfjOOiqIw1eCaYFtGBBMtARKyJF2fwtlljjTU0xqTNRfmHGJOuXbuWX471f3GdN2JlN88991ys6ZYn9thjj2nQl2gNjTjild/OzP8EXfH9iDPp169fKss9evRos8EGG2gMETFK7ShsWDvxxBOtRPcl7ngo0WV2oLgsS6H0uOOOO6xEmZWKhJYB446E06rflzQcXSjjTkBsB+/haPj+++83ZQEtgVia58svv1wqYxI/cMvHop9lkk5WF8F8I2I40kzwGp6HUegahCCV/fbbL+z52K9NmjRJGx0CWYlOO+00e+aZZ7a5fcEFF+h7hx56aJvrSf6DwErIqb3wwgsTywYvY/yI8IzOOuHekQUBgdeofsOCxtrB/jAvY97LVKYZNOuss2o27hyWJ7HPHEEidBdy5+C9pH6Lkcmsvvrq5sknn0wqC/PQQw9p2mL5TSyPZiUsgt6srBrKB15LZ1TifTCxdjVg/YGQuHVA8OFW/Zb4BsORBoIv4n6SWFEkGMgst9xyCloRVyYAXVx++eUldJiddtrJvPnmm6W1nGhyzK677qp5ilezoQ1ssskmRsIZtAgyEuhaQhwAdZ0nNqE2670vv/zSiAFOlRf33XefkSmoOeqoo9oVX7RFBrAOiRkydDbM/QHpgFgLgCcwxxxzmB122EHBIVwCldKPSwABCIHn8H777bd32eq5XauTYUZvpAFRok1JU/IPkDUgcyRF4wVmB21ZnARUEgtlMYwZCV9VVBKUGigcuMZvGgkEyMWQIUMUTIP/AVJgNiFTEHPQQQcpQonYxozYhLitz5L2YYcdZi699FIjQWiapsQL6f3gH8EoMLfeeqvCB2288cYqHMAGiVVbUU8233xzI249CuPk3qcs1aYfzKvW3/Ac3pdTOwFBWiEk2VN7DgBR5HjU/m7jV+itk5g2guqClo9e2pH4JOlPptSOuC/rOh2xabw77rijaqBAhqFzYGRgSkKjphELBoHeZ1QAtgnoIEYaN/q4dJmVoB7nffJ1SCmXXHKJvkc+oKnI+k6FRUJq9dVq03f51HuG5/C+nNoJiITP6jP0NJ7acwC+OB61v9v4FWwe4H/FTeJaYSSGxIjhVxsg6bt1nwTAlbJjqsQUDOJZpmKMKkHaaKONFCju6quv1stumiSaIP0fVX2Q6FAQMASvXJUqyhbF5GJ04hBljAHuB+wzRx2l755r5AzPw+xN7dYgAINBTCPKF8aNFKDSuwzdzEclPLLSI/oxAC9LAzEFdTxKojw0BhplEoSAiEbQSJyLEQ9tQ+MUa7K56KKLFFcMIWKUcNMtN81hjRIk18gZKSC3PnTn4LP8RtDA3mIUA9jPEYByGGApF4bRSuTSdedKzzVyXbSpOrUrT6PdCMI8EQKtsBnE/BhURbFl6OItLE96Ez5cGgi+OB4lUR4Wi0xTojqMevNF+GiIV1xxhQFNkcZJj810mlFEAA/MvvvuW0qe6ST01FNPla7xg/rTsVU7DZdAO8PBCEHdHLkGz1qolQSvKRe8L6d2AkLvKNA9qm0ofzip/yW2XTVnlYSSefHKK6+cVPY1pQtSJKrepGjddddVD4KkVMmCLaUjFA2WhTWYx8zzWQyDbgj0pyO+CwRSZZCAkJVwayP2suDlyN8IZTfB48Wi7hRBTPHA5kXDhqYtSGKbMCBxNoPgNV4b8L6c2gkID6DVcPr48heS+F8cAQ0jCT1MOaME4E0/WrlWTdzQtSjunES5ytPkgwFxCn+SIqYg9GTibZpIFqhW8T1izg2GMSRGYcVJZgoUJBbNCA8CEmysqGoZ9d1o49ar5do9h72LMDFNQ4PFyIWQuHss2MFXpnEChwpGsHhXaIMV51AtTqX0g2Vt5De8hufB6V8pvTBrreik1QLaTFRE3DhwG5l33nk12F700VbUixYrepBkuqWWbIcWSLzxWWedZQFcSJpwmQCsjLj1JEl6W43gTKpO8AtY1iDhahF083H3CHWQjssKVq8dPHiwwumIf16J38Dr4AUhDcryzWS011dlNmBFgPQ6XtDgV8maw4p9Ra8RRkHwEt4J4JPhPUAanInTcJA9ldJ35Wv0DI+JloXnYRTqakKhZZ5pm+nG4QqHewJMlvmxu5SKM0LBhxY1ZeLlEZWolV7eiuozkbxo9HzjIIUJR/A+jVumlxbXoCSI/GXq1nRcMngMr+F5GIUKCA+KflrjsaN85cMSzOu1iy++WPmBY2QzSDyptUcVZPxmZFfIPOAtoxa8rkQVBYQeEyjHpHqxSgVK43WmdTgp/vnPf25q8YibFgNWIZESk2Y0SIzwFh5HUUUB4SXXi7FlQJFJFq86z0ZQmklMhUCvZGrnR/L4OA8v4Sm8hcdRFCkgvAiMI5KWF4jRKGaE3RMVpMaji1Yv7Hbi10Tro8oLwMGTmv8nXokUZQAP4SUKIXjbEXUoICyeJCzRilqvqgQ7yjBL90eOHKlalZNPPrmlxUZhIWpIBWX+5z//2dKyZDlzeAewNbysVgnUoYDAECL4kDoERfxqssyjqsuO2hmA7j322KPqd5J8EPghVKRi2LPNRldJsl7NShuewTt4CC+rpaoEhMQIoRRvUNWHJ6Wfr7bQST+HdoN9Q1h7pAmgm71XUDODDgigXTVThKR5lfb04RG8gmfwrtb9a6oWEBjB7kzEh4tPj3366afTzpu6yseOU+IjZA844ICSsaquhBJ8ifUQi0zxT9PRpNymkWDWmUkanjBqwCN4VS+mdE0CAneYYm266aY6N8cim5ePQ0+DhRhLLrtmpZ0w3CHEIASuuOKKttX4wWniF7yAJ/AGHsGreqlmASEjhOLcc8/VQHdxfc7MhjOVmETQPht70tOI41qlx1J5HeszsKgYvMTPqnAA48GPArg6PIAX8ATeNEp1CYjLVCLRVJdMrwsCfBgqhHs2jWfKLw57pSlVlhUQ+M+xmSWNg+2S2dukI/eRNH6TWstEHakrdabu8ABexEUNCQiFwKmMjROZ6wHjiKPZZ599Flf5Eknn2WefLe1LiLEoT6pT6obTIDA22K+Ab8rjelFiVLRu1JG6UmfqHjc1LCCuQOw5zt7jCAoaIEEhtFQiLcTOp0ylmBLS06y00kqRPjhpKXe95WDTGBQOeM1SX4nFsBL/YVngp0kzV239KDNlpw7UhTpRN+qY5GZCsQmIqyiC8o9//MNK4I1WAjdp0BMFHcM90rQzHppsQM9+fhIdpwtwVLdF2wiInvWEE05QFT0NS0Kp7dZbb61hAwKjmkptHTMTygZIH2WlzJSd9kRdkhgtwhpmKDavFCQWIhJQ4OWNQIpqUAzRY4BiE6jDwf9xEsgaIHQQ4MMhCPWKVEE0IsFAsvegEUtqnFlmLi0wr8RDQIOT4BHhzDJNMaL1UVQRgqSIKgR4IQzEIIkKg3hCHD5hr8AMcYgAGILhCPulrQjUrOJExw2J1FF9EhUQl7lIppF5vn4YPorMiTXEFlAI6REUg4kwX2KmOWjEAAcQZUhIKPHPMFEcy/TgoxJPLbs+GYLtARcgXBRgAKBqSJfoMNA5gKhJGtTa1TNrZ74L8eCAZRPJRwMlnBZeA6TBtxAPCu3I6MyI6pQAtdIBnxEiCTgqneEB34A03FnUrBpmS6gth0yJjDgMKg7VuHHj9FuKZlTTEDubCigAfYBDEOlHWVpFTRGQ8srBPHoIEPj4IBwggcM4RoFqCaQTsJjo7WAsB4z9+9//ruGdxLg7hI5q0yz6c/Cf3vyQQw7RxkwjpREDqiHKF8UEozHXQ4A0APQg61QFfiD0lwPhA+qH7yga0XqSTuydlghIpdrAeDHY6chAHLIbMfho9FRuRIHJ9G5MDcKI2Ghipom1BrXDU20coPNaZZVVjIQ5tIPi5BsxgjMSAHQQHCn4DfGtgiML34mRh+mSQzKprUStezpVAhInG/72t78Z2d9PUf7iXuvEWc40pgUoBdMapl5Fp9wKCKOOm3aBpuGpOg7IBpcKNwqQMwv3olNuBYQPy+5G7JCFNgtNiKdoDgAFxDoATWNSsEPRJUjf3VwLCOwGRZx1DfPqrM1/m91czjjjDCMOqIqqWXR1uON9KHCcu5mHM/izqDJ9jxj9NVGZIxxsh+CF43de5X4EoaqoLFmHeLXv7x++/BcblIJsiIoX25On/3Mg9yMI1RRERFVH/vWvf/XfPYQDTD/ZEEfiYLxwlPGnECMIdfZq37IvH/jXq3UDzCj7WRgB8Wrfsi//279OrYsrkHg4hz9U4KuFERC+sVf7tm3pXq3blh9h/xVKQGCAV/v+3gy8Wvd3XlT6VYhFerDyXu37f254tW6wVVT+XbgRBFag9mWvczbDKaq3r1frVhaK4J3CjSBUHrUvsQpFVft6tW5QBKJ/F3IEgSVFVvt6tW60UATvFlZA2DePze6JaCySt69X6wabf8e/CysgsKZoal+v1u1YIMqfKLSAwIwiqX29Wre8+Xf8fyEX6UG2FEXt69W6wa9e/e/CjyCwqgjevl6tW71QBJ8s/AgCM/Lu7evVusEmX9tvP4L8xq88q32B7oE8CMNvH7uGkxeQ35iVV29fr9atQRpCHvUCEmBK3tS+Xq0b+Lh1/vQCUsa4PKl9vVq37OPW8a9fpJcxLS9qX9S6oEp6EIayD1zjv34ECWFYHtS+Xq0b8mHruORHkBCmZV3t69W6IR+1zkt+BKnAuCyrfb23boWPWsdlLyAVmIa3L3tTgO+bJW9fr9at8EHrvOwFJIJxWVP7erVuxMes85YXkA4YlyW1r1frdvAx67jtF+kdMK2S2pfNY+68884O3k7mNvH0m2++uWIOuxy8t67jRMznsJ09/bW2HDj44IPtvPPOa2VTydK+8G7XVdkXse3DTfiPPcGlGVjZ5Eb3Cmdf+t12280utNBCVnblakIJipNF7NtA55F1st2YlW3frOySa2VzUG2YroHefPPNTa+y7OunAkIZZE8/K3s1WtlI08qOwk0vS94z9FOsKkbkL7/8UnfNvf766xUhXhqFvsXuu2xZ3Exi38bx48eXssTJ8ocfftDNT2X/cHP33XeX7vkfjXPAC0gED9mn++ijj9Zdl8CuhWSD+9IbQAfJZvel/5vxgx2BnYAG82NzzYkTJ5qtttpKd4hiW2xPjXMgXXvuNl6f2FJg7/U11ljDfPfdd22EojyD559/vvxSov8zYk0zzTShZXLbM7PPx3bbbacbmCZamAIk7keQCh+ZraZlIV7h7u+X2TucbaebRQhI1FZy7DPepUsX3cK5WWXKcz5eQCp8XbYhw6eJLQHosaOomesQdp/Fyh9GCMcSSyxhGNV69OgR9oi/ViMHvIBEMGyuuebSbcn69eun+4aHPdrshTprkDBiVOnTp495+umnzfzzzx/2iL9WBwe8gHTAtOmnn97g38RiPYyY97/wwgtht2K/hvbq+++/D013jz32MPfff39hwbhDmRLDRS8gVTBRDHLm7LPPNoMGDdL5P/87QqvFtKcZVGkqBwj3VVddZZhieYqXA15AauDnvvvua0aOHKkbXQbXJe+++27FdUENyXf4KAIiBkF9jikVAnHjjTea448/vsN3/QP1ccALSI18w3nxySefNKxPXI+Nse6NN96oMaXaH2cqxwKdfDt16mQefvhhs+OOO9aekH+jag54AamaVb8/uMIKK6iBcPHFFy9puCpNf35/q/FfaNUwEs4333yqYXN4V42n7FOoxAE/aa3EmQ6uL7DAAmb06NFmm222Mc8884zBDWXcuHFqE8E1JXhgbMTqTu/P2f1mJEALxrTJnWeYYQaDDSZ4zDnnnKZz587mww8/VJcXvHkRTk/Jc8DHg3TAY7RUrDGYQrkDKzvbt+Hy7ohGLk6E2pCDjZvfbPMWFAInDEzNyoUGX6ugcPH7iy++UOHAKOkI7Vq3bt1UYMSBUs9LL720nsV50T3mzw1ywAtIGQPppRkR8L3iYFrz7bffqh2ka9eu6pdFg+zevbtZcMEFDdc4qrG6l2VV879EDFK+SZMm6YGQOqHlNyMTygPChFdZZRU9Vl11Vd0kKMr6XnNBCvRC4QXkq6++Mo888ogZNWqUTploaDQmBMA1Mqzp9M4sjNNKqJvfe+89tck44caijqcvo9g666xjNthgAz0WXXTRtFYjdeUqpIDQAwPEcNttt6nlmYVvz549zfrrr2/WW289s9pqq+XC4IbQvPLKK6rteuihh8zYsWPV+XLhhRc2eAf86U9/MowwQbtO6lpoiwtUGAFh/s5CGqs4Peyss86qYatbb721WXfddQ0L4bwT6x2mjyNGjNDOgbUV08Ntt93WSESiQTvnqYwD0nvmmmT6ZMVWoBF3IhRWXDKsGPvslClTcl3vaionqml78sknW9GIaYSiTCmtWOStaN2qeb0Qz+Qy5FZ6SjtkyBANj5X+wPbu3dteffXV/sNXaNKiqbN0JAMGDLCiZrZ0JILpaydPnlzhjeJczpWAiBbHXnnllZaYbbExaAz5yy+/XJyvGUNNJbbFCnyQnXvuuTXW/YgjjrAfffRRDClnM4ncCMgdd9yhUwWxD9gDDjjAiudrNr9ISkot2i8r8KtW1igqKAMHDrTiSZyS0jWvGJkXkAkTJtjNNttM59A77bST5X9P8XFAbC/2nHPOsbPNNpsVw6QVtMn4Es9ASpkWkGuvvdaKldqKjcKKCjMD7M5uEQWYTtcorOn23ntvK8bT7FamhpJnUkAY/gFKAzjtmGOOsfRynprDAUGT1PUJ+GBixW9Opi3MJXMCgmZFjFtW7BZWIuhayLriZi3uLlYQX3TaJQbIXDMiU+7u4M+uvfba6jGLwWujjTYqs+r4f5vBAdztiUUBH3jTTTdVw2Mz8m1FHplxd8dzdsMNN1S3CPb7FqzcVvDL5/kbB/BOxjNh5plnVgyuBx54QEEj8sagTLiayBiuPRVogU899ZRH7UhRK+TbiIHRICA4R+KCnyfKhICcd9555sQTTzSPP/644lTl6QPkoS7EsKy++upmxhln1G+UK9f6tK+wBG9WDVVYdz2llwOC16X+bpdffnl6C1lHyVI/guy3334aq/Hmm2+WED3y0OvmsQ7ilmJkOwhFnyfiMQ+Uai0WC/OhQ4cqaBuLQk/p5oDYpAxhBcTZ5IVSLSBsokkMA4tAT+nnAHjGaBqztCtwR1xNtZqXCLiVV17ZiB9QR/Wo+z6II+w1KFup6bbP2FaC+RGPjqAS+01wEQ2Ac5C498knn6ia87777tO0iNbjOUAfnnjiCdW+YcMhWtERi9u77rrLbLnllkYMoJoPNoYttthCY8s//fRT3RCHRS/pEeQVJLRGqLwJq+3Vq1dJDc4zAEIQSsy74u5v7rnnHi0XOFoAXCdFhPWefvrpSSXf/HTrWLc07RWJ9LP77LNPYvnhKiGGLkvgEDEk/fv3twIIZyW2W/N88cUXreyVbmXKoLERok2zovfXWBMeYM/Co446Sh0lBf7HHnjggVZQDq3gVVkBT9DALNLkGYEJUhd8AZfWtMeMGVMKVDr//POtoDZawf9VhYRE+KnbPs6XBHvhUiNCo++5P7ihs1chZRVBscsvv7zt27evZbs4QUHR96Q1WdIgzuOwww6z88wzj5Ve3uLSnhQ9+OCDyo8k80iq7GHpptrVZMUVV1Rfq7CCN3pNelgrIab2iiuuKCUlu0WpJkZ6W404FOAGjbgrPSA/aGyyHrJikyldxtNVRjqLjxiE4Ai0j7rEuGu4ivOe9K6l92QHXW1MgnNVukagEg0boXQkW6tZ3PglxlwvEQxGUJMATrhHLJuJ8t7OO++s12R00v8FrEGFn4uyPZteo35JkeAUax6CEZZUFk1NN9VrEEDUmIYkQUybZIQw4ipfSp5pClMqXChASkdzFpwS8SBTMOB1JEKx9B5TH5BCsANA4GAxVQLczV0Dq4opFwjtjtxUTkYpd8ksueSS+ju4vwcIKxIibCRwSe9ddNFFirri3uci0ybAGFBqsHUcvAOMgXI5iFSQWSC2akuK3Pci/zxQqgVEtjVWtMIkGA1UKDA+EjnXJnmnLQMcDsKVIkgO7pN1RxSFqTkBjKu0fYFLq9J73Odd6T51PVReLu67siHYYeQAt0kjKQJdEuFgl6s8UKoFBDwqXEuAr4mbWDzT4FjIhpFDOSH/ICG0NHSwpqKoEpROpesuraj73OMgb7ZcKOeLgyPtqGwuryTOeDsAoeSEMYk8mplmqgWEqQ6wm2A6xU1uWjNs2LA2SbPfoITvKl4UN9CkBYkdnlA9oxlqFYFlxVSwfOMetFr03ECgtoKYeqKVQwuXF0q1gNAjsq2YLGZj5zeqVXo6WfCa/fffX4XwwgsvNHvuuac6RrIGACsKAQnO2ekhKRd7hUBMVxiJWCMECfUxwh0kngM+1BGNHAq+y3tQ8F3eg9y7Z511lmEqhjetI0ZERjvu0XuTDmWj0ToSDZf+dOsEdz2uM+sfkCrhW25ImJhqIiBHmG1RH8ZNH3zwgRW9vapRZeqialKuOUITdNBBB9llllnGDh48WDGjiH/HPwxCW3Xaaadp+UABuemmmzQUFawpykw48CWXXKLaLWm4ek0wfFVNLHuMWBFCvUZ0JFofme5ZURToNfJBU8ZzoijQa6h13377bc1b7B8aI3744Ydb6bXtrrvuai+77DK9J8JhDz30UH1HwgIsWiuCnARNUa+Rr2AO67Nx/RFhV1W2dDZxJZmKdFLvi0VPhJEMEGm0TkHNDffiIHo9emC37ihPE5cXXO0Bq2bbg7SQtCAjAqPTLaaMYQv8ZpUVnzlcTFAQsFVDXigTAoJ/D7CYYhdRq3eu3Klz0JJkdDVsIsraDSjXXFEqxrEqCiHzays2BbWsS29fxRv+kWZwQHB+1Sgq8TrNyK7peaTakl7ODT4G1mhZSFss4Z5aywGs/XwP3GTySpkSED6COANaMfBZcRq0svtSXr9L6usl22Jbmeqqj1eeR/TMCQgtB58pcdtQLQ5TL0/N4wBOiLLOUMdLoEnzTqm2g1Ra7OEzhVEM36I111xT9wl3NoJK7/jrjXOAsABReSvv8UAQVXLjiaY9haz3AIMGDVIAM3HUs6D+eYqfA9hexKtBbSjsrxL0Io4/t3SlmMkpVjkLgefHDR1jH7EYAmpW/oj/vw4OYBAlxgXXfeJiMGQWjXIhIO6jEYyEZVxGbbU+E/+Q5wWkq3fcZzH26U5cCIbgXGnwVlG1hrkSENdQEBQ3JQBkmcAkIu08VeYAEZVMUXFxQTsl/mYW9HyuF5lyKSDug7K7FJvpEH0nbhgahoqamJ2oPP2fA7ILroYJE4rLFFUCwuztt9/u7Uy/NZBcC4gTApz32JrNOf3hMLjLLrtoj4lDYtEIR0Vi5yUKUaejxMvzf17CZOP8npnwxYpTE4jrOrA0HDIV0+g3VMVuj3Rc4PPm6yUeymb06NHq0k9sDSj5OF6y/TOOoIQVE4jlqT0HCicgQRaIC7iCLo8aNUobD06RePTSYGRLZIUc4pwl71TsQXg9E3HIfvBsE/HOO++op6/s6aEdAdBF2JK8UARbQ/jvQgtIkCUyLBvi1AWORxsVjYv4akg0OWogAzxBFv16AK4gEEHBJJr6G0Gg4eNeTny8O4ilJ+KRsFswxRBwRkgwuRyARFMLmvHMvIBEfEAi8BAUQltpgDQ+AOYAaoMAfQCphBgRdwYEgsYZPABYAAyCg3h2dyamnIg/GjRnDqL9xMeszUF0IaMdU6VJkybpmdEOYjpIiK0TXOJCEAqiHv0IoSxq6I8XkBrZx0jz/vvva+9NYw0eNGBi2mngNPZGicYvCgUVNmA9EcLgAcwPI1krA6UarWPa3/cCktAXYpRxIwHx4cFRgt+CeGgOPvhgnf4ERxemQU4oiJ70o0BCH6jKZL2AVMmouB+j4Q8fPly1SHGn7dOLjwOZ9OaNr/o+Jc+BaA54AYnmj79bcA54ASl4A/DVj+aAF5Bo/vi7BeeAF5CCNwBf/WgOeAGJ5o+/W3AOeAEpeAPw1Y/mgBeQaP74uwXngBeQgjcAX/1oDngBieaPv1twDngBKXgD8NWP5oAXkGj++LsF54AXkII3AF/9aA54AYnmj79bcA54ASl4A/DVj+aAF5Bo/vi7BeeAF5CCNwBf/WgOeAGJ5o+/W3AOeAEpeAPw1Y/mgBeQaP74uwXngBeQgjcAX/1oDngBieaPv1twDngBKXgD8NWP5oAXkGj++LsF54AXkII3AF/9aA54AYnmj79bcA54ASl4A/DVj+aAF5Bo/vi7BeeAF5CCNwBf/WgOeAGJ5o+/W3AOeAEpeAPw1Y/mwLTRt/3dODjANm4PP/xwu6TuvPNO895775WuzzfffGbXXXct/e9/tJ4DfgOdJnyDQw45xFx66aW6N6HLjq3cgrtH/fzzz7rVGvsiekoPB/wUqwnfYrvtttNc3EadnINbsvH/NNNMY3bccccmlMZnUQsH/AhSC7fqfJbRYp555jFuZ9pKyTz++OOGvcw9pYcDfgRpwrdgKsXagi2gKxG72K6++uqVbvvrLeKAF5AmMX7AgAE6rQrLDsHZbbfd2qxJwp7z15rPAT/FaiLP2dd8woQJoTm+9NJLZvnllw+95y+2jgN+BGki73fffXcz7bTtNeuLLbaYF44mfodasvICUgu3Gny2f//+BnVukBAYBMdTOjngp1hN/i5Mo1555ZU2uWIsXGSRRdpc8/+kgwN+BGnydwhOs9Bu9erVywtHk79BLdl5AamFWzE8u8MOO5hffvlFU5p66qlVexVDsj6JhDjgp1gJMTYq2TXXXNM88cQTqtb96KOPzLzzzhv1uL/XQg74EaQFzHcOiX369PHC0QL+15KlH0Fq4VaFZ/Grev/999Uzd9y4cWbixIkGp0MO3Es4f/fddwafqylTppiffvpJf+N/NeOMM5rpp59eHRn5Pddcc5nOnTuXDjx8WcC7Y9ZZZ61QCn85CQ54AamRq0yJXnjhhdLx4osvqvHv119/1ZRmn312061bNzP33HOXGjkNfpZZZlFBcMKAwHAN4UJoEJ4ffvjBfP755yXhQrAmTZpkyBN/Loi00IT17NnTrLDCCnpeaqmlDOsZT/FzwAtIBzz94IMPzCOPPGLGjBmjByMEhFWcBsqx9NJL6//08nPMMUcHKdZ+GwHCAk/eb7/9tsHqjmC+9tprKlgI5VprrWX69u2rB2XyAlM7n8Pe8AISwpWXX37Z3HHHHXrQGKebbjqz6qqrGtYMHCuvvLKZbbbZQt5s7iVGH4Rk7Nix5tFHH9Uzo06XLl3MVlttZfr162fWW2+9NnEozS1h9nPzAvLbN2SkGDx4sB4Y7pj708i23nprs/baa5sZZpgh9V+baRhGyHvuuccQrfjss88a1izEo+y1117eW7ieLyhMLSzJusGOGDHCbrrpplYWzFbm9/awww6zzzzzjOVe1knWL/bCCy+0smZhAWNlrWIvuOAC+80332S9ak0rP4u/wpH4Q9kbbrjBLrfcctpwNtxwQ3vLLbdYmevnlhcymtgDDjjAdurUyco6yZ500klWNGy5rW9cFSucgMjawor3rBUnQSsxGlbWGHHxMhPpiJbMnnrqqVa0bHammWayJ598sv3+++8zUfZWFLIwAoIgrLPOOjpiSOy3FY1QK/idmjxFpWzPOussK2sUO//889vrr78+NWVLU0FyLyBMp+gxGTFWW201+9RTT6WJ/y0vy+TJk+3+++9vRS1sN9poIys2l5aXKU0FyLWAiDZKhUI0ULo4zcPCO6nGI75hOvUUS7697bbbksomc+nmVkDENmDnnHNOKxZn+8Ybb2Tuw7SiwKxFGE3QeA0cOLAVRUhdnrkUEDRUYtyz2267rV+A1tHkBg0apFPSnXfe2YoLTB0p5OeV3AnIjTfeqPPpo48+Ohe2jFY1tYceesjOPPPMVuJXrMSvtKoYLc83VwJy//33W4HQsUcccUTLGZuHAgiesGX9hv2kqJQbAREnPivesXaPPfYo6rdMpN533323jsgXX3xxIumnPdFc+GIRwioqXPW0IVIP50JP8XHg9NNPN6eddpq6+OO5XCTKhYBccsklRtYc+gGJjfAULwfogIBFJZYFz+EiUeYFhCAjApSA7jz33HNj+3ZECP7lL38xp5xyillwwQXbpPvVV19pjAies+L4Z5ZddlltQEsssUSb5/L0D3uc4PI/cuRII86deapaZF0yH4YmLhLm22+/Ncccc0xkRWu9SUDStddeq4FJwXdvvfVWDZB67LHHzMYbb2xkAWuIJsQlnlEMgc0jrbLKKlpf8QbOY/Uq1ynti6SOyicIIep02NFz9dwv93YVgVEj2hVXXNEuORlx1DCJ63xeCUdPwfKyH374YV6r2K5emdZiff311xrHMXz48HYVi/sCsRUSRWhlOlXRviKLWRWgK6+8Mu7sU5Hejz/+qGpfOoqiUKbXIISZEodNNKB4pFYeJuu4w7SJWHT27UBzc9xxx5mzzz7bnH/++ebII48MTVF6VrPAAguYhRZaSGPIiewjOlEMbmbvvffWqeB1112nQA2kC4hckEaPHm0kWEvj2rkHwomjL7/80ogR1Bx44IHmvvvuM4QFA9wAoAPEAnqbbbbRM+uF119/XdMhKjJOYoMf8mVLuUJQlnsCejKByom9CoJaYjfffHMdDW6++WZNf5NNNtH/oxz5sDhjqJSGYxndoGWWWcaK0Ohv/hDNh4t57969S9cI1BIBsngByNrHSoisRjdKvLk+I6HAGruBR7Jo7GyPHj00j6efflrTJz8cM4PUvXt3+9ZbbwUvxfJbML00AjOWxDKQSKYX6UDnJIETBSrIscce26aDBBwBYoSoRCCJEMsOuefL1c5A/bDdQZBQUzMCskehNH4jYbIK/eNGKjR0ADCADM9zKBDEAVO1SmeeeaYmFdxF9+OPP1bNWhJaNfiNUqQo1H6zigzVnGkFIGxJkISmtknW/S/z8DbXy/9x9ylbtYRmaKWVVjIHHXRQ6ZUll1zSfPHFF6X/neC5KZOMEHpPRjqDEJIGwAwAYg8bNiyx7aSBIKqlbqUKZPRHpgWERiNTGe3R6JmTJBokvTbrnUpE43EbdZaPEpXewabCOoI1yhZbbFHpsRLOVTneFQKBennPPfc09957r9lss80MaxkBn6iYViM3ALJzwtpIOll5N9NTLAx00PPPP584v9ddd13NA5ysSsS0SqbVip1V7dTPNfjyPUMq5RF2faeddtKpFwoEyiDrntCdrMLerfUavBawi1pfy+zzmRYQtEUgHKLVSZokkEjn9WID0VErLD9nyZdgo9JtdpCKmgYiSNTh8ssvN2565l4eOnSo4vy6/yud8T07/PDDVevGaCIOm5Uebeg6wiEhukZi+xtKJ0svZ1pAYPT222+vc+7yrc3i/gg0dAnE0v3O2QRHou/aZHH11Vcb0XAZBCjYgARSSBfcWOV5hzP4u8CIorqFaNRM3RilxgjEKdi/CBnTR+fm4vLj3TDab7/9FO0RZEVGkCQIYL1FF13UrLjiikkkn840M6Bpiyzi+PHj1Vg4ZMiQyOdqvSm9papSnZrXvU9Y6iGHHGJFQ2Sl11ZACKzngsBoiZ8oJ9H4aFy8fH0Fbrv99tut2CsUIMEZFImVP/744zWKj+dQ54rdpRSodNVVVynyCPekQ1Bgu/J8+J9w2csuuyzsVsPXAHcggEqmcQ2nlaUEMm1Jd4wW7Y2VntaK2tddavj83HPPqYCENXoSFyNgyeaBjQT0lCiigTnCIh1GQPG8+uqrdYcJb7DBBlZGpbCkG76G8Ilxs+6yNVyAFiWQCwH55JNPFC1Q1KSxsREjHD02aVcicVi0otHR54jfbiWkJwZGmWZVKmpD18WjQH2wZE3UUDpZfDkXAgLjsULToG+66aa6vwMNHjA1gArEa1f9rjpKDAFieiQu9zoNwh9L1hGW0SBpAk5U1i2KJ4x1nelm3IRjomwRpwAYcaedhfRyIyAwWyzPVoxY9sEHH6yL9w888ICORLiBsE6YMGFC1emwjsCjV/ygdPrFVClpIi/CjHGiTMJhUxb8VvzQtKMQe03S1Ull+pl2VpQRow0JhzVwShbCqvplU5laiTTYdyMrYbto77ClOHtKrfWt9DwGzPXXX181boQxF8k4GORJ5tW8wcpgVb7mmmuMLJoN6lW8X2sl0siKcFA31M9xC8e7776rMf6ojEeNGlVY4YC/uRIQ12BENat+TYLebgTmv7QvOfc9RXMANxVCa3HdEUVFO8fK6LdzeDeVE7+YCkXkH+7wgFYn4fodUzFTkQxKBTYPkhHUgn6PvceTzLfzzgQJHLK9evXSeIrzzjsv15vk1PstQVEU72Fd7BdRlRvFt9wLCJVHbSsIJTqasHkO1mxPVkfVLbfcUtXjnNHCeWrLgUIIiKvyxIkTbf/+/bVBMO2SjS4rxpe7d/J4ZlQVfzJ1aSHGXhbieaxmLHUqlIA4jmE/wHeK+Tahqfg6xemm4vJJ0xk7DRZxRgrqzYae+K915CKTpjq0oiyFFBDHaImdsMRYY1zEEQ+fLjaSyROBxoJ1X7xwdeTECMoUE4Hx1DEHcmUorFfJSGgrsRcykug+48SZsD864a0AwskW0fUm3ZL3BMhb90m/6667VFUru9qaXXbZRUNyXZBZSwqWwUy9gJR9NGIxsMQLSJpG58kuVRrf0adPH4UYooFhTEwTAdIABBKHTKOMqLQVMkimUwr2IHsPZsr4mSbeegGJ+BrvvPOOGTFihDY6oEZxv0BgAFgA+cQdiy++eGIhruXFQxhANXEHUX5YvrGoU66+ffsaBAI3m6yNfOV1TcP/XkCq/AoyZ9dGiaDQKBlpAHHAF4rGSeTfIossogdTtC5dupjOnTuXDizToIHgxuLOvAvQg6ih9UzILe4dwYNIQ6IPOcRb1wB1BHXt2lUB3ABxY+sHgWBVgLoqq+Mfq5IDXkCqZFTYYzRuQBKY87tGzFnUyYpuAvJ7vSQ7O6lwgcCI4BHq6s6AJgRRF+vNw7/XMQe8gHTMo7qfwCvYjQb0/MHRglGDkceNKIwqCAUNn5EHuFJPreeAF5DWfwNfghRzIHfevCnmtS9aBjngBSSDH80XuXkc8ALSPF77nDLIgf8BUn3iXpYwiGsAAAAASUVORK5CYII="&gt;&lt;/div&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;common&lt;/code&gt; module has some logic that we&amp;#8217;d want reused between regular &lt;code&gt;&amp;lt;script&amp;gt;&lt;/code&gt;-based code and a Web Worker,
but its dependency on jQuery makes it impossible. It would work, however, if this dependency was a &lt;em&gt;soft&lt;/em&gt; one.
If &lt;code&gt;common&lt;/code&gt; could &lt;em&gt;detect&lt;/em&gt; that jQuery is not available and fall back to other solutions (like the Fetch &lt;span class="caps"&gt;API&lt;/span&gt;),
we would be able to &lt;code&gt;require&lt;/code&gt; it in both execution&amp;nbsp;environments.&lt;/p&gt;
&lt;h4&gt;The &lt;code&gt;optional&lt;/code&gt; plugin&lt;/h4&gt;
&lt;p&gt;What we need, it seems, is an ability to say that some dependencies (like &lt;code&gt;'jquery'&lt;/code&gt;) are &lt;em&gt;optional&lt;/em&gt;. They can be loaded
if they&amp;#8217;re available but otherwise, they shouldn&amp;#8217;t cause the whole dependency structure to crumble. RequireJS does not
support this functionality by default, but it&amp;#8217;s easy enough to add it via a &lt;em&gt;plugin&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;There are already &lt;a href="https://github.com/jrburke/requirejs/wiki/Plugins"&gt;several useful plugins&lt;/a&gt; available for RequireJS
that offer some interesting features. As of this writing, however, optional module loading doesn&amp;#8217;t seem to be among them.
That&amp;#8217;s not a big problem: rolling out our own&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt; plugin turns out to be relatively&amp;nbsp;easy.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://requirejs.org/docs/plugins.html"&gt;RequireJS plugins&lt;/a&gt; are themselves modules: you create them as separate JavaScript
files having code wrapped in &lt;code&gt;define&lt;/code&gt; call. They can also declare their own dependencies like any other module.
The only requirement is that they export an object with &lt;a href="http://requirejs.org/docs/plugins.html#api"&gt;certain &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt;:
at minimum, it has to include the &lt;code&gt;load&lt;/code&gt; method. Since our &lt;code&gt;optional&lt;/code&gt; plugin is very simple, &lt;code&gt;load&lt;/code&gt; is in fact
the only method we have to&amp;nbsp;implement:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cm"&gt;/* Skeleton of a simple RequireJS plugin module. */&lt;/span&gt;

&lt;span class="nx"&gt;define&lt;/span&gt;&lt;span class="p"&gt;([],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;

&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;moduleName&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;parentRequire&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;onload&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;config&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;load&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nx"&gt;load&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As its name would hint, &lt;code&gt;load&lt;/code&gt; carries out the actual module loading which a plugin is allowed to influence, modify,
or even replace with something altogether different. In our case, we don&amp;#8217;t want to be too invasive, but we need to
detect failure in the original loading procedure and step&amp;nbsp;in.&lt;/p&gt;
&lt;p&gt;I mentioned previously that module loading is asynchronous, which JavaScript often translates to &amp;#8220;callbacks&amp;#8221;.
Here, &lt;code&gt;load&lt;/code&gt; receives the &lt;code&gt;onload&lt;/code&gt; callback which we eventually need to invoke. It also get the mysterious
&lt;code&gt;parentRequire&lt;/code&gt; argument; this is simply a regular &lt;code&gt;require&lt;/code&gt; function that&amp;#8217;d normally be used if our plugin didn&amp;#8217;t
stand in the&amp;nbsp;way.&lt;/p&gt;
&lt;p&gt;Those two are the most important pieces of the puzzle, which overall has a pretty succinct&amp;nbsp;solution:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cm"&gt;/**&lt;/span&gt;
&lt;span class="cm"&gt; * RequireJS plugin for optional module loading.&lt;/span&gt;
&lt;span class="cm"&gt; */&lt;/span&gt;
&lt;span class="nx"&gt;define&lt;/span&gt; &lt;span class="p"&gt;([],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;


&lt;span class="cm"&gt;/** Default value to return when a module failed to load. */&lt;/span&gt;
&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;DEFAULT&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;moduleName&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;parentRequire&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;onload&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;parentRequire&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="nx"&gt;moduleName&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="nx"&gt;onload&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;failedModule&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;err&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;requireModules&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="nx"&gt;requireModules&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
        &lt;span class="nx"&gt;console&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;warn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Could not load optional module: &amp;quot;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;failedModule&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;requirejs&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;undef&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;failedModule&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;

        &lt;span class="nx"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;failedModule&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;DEFAULT&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
        &lt;span class="nx"&gt;parentRequire&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="nx"&gt;failedModule&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="nx"&gt;onload&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;load&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nx"&gt;load&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;

&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;The logic here is as&amp;nbsp;follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;First, try to load the module normally (via the outer &lt;code&gt;parentRequire&lt;/code&gt; call).&lt;/li&gt;
&lt;li&gt;If it succeeds, &lt;code&gt;onload&lt;/code&gt; is called and there is nothing for us to&amp;nbsp;do.&lt;/li&gt;
&lt;li&gt;If it fails, we log the &lt;code&gt;failedModule&lt;/code&gt; and cleanup some internal RequireJS state with &lt;code&gt;requirejs.undef&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Most importantly, we &lt;code&gt;define&lt;/code&gt; the module as a trivial shim that returns some &lt;code&gt;DEFAULT&lt;/code&gt; (here, &lt;code&gt;null&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;As a result, when we require it again (through the inner &lt;code&gt;parentRequire&lt;/code&gt; call), we &lt;em&gt;know&lt;/em&gt; it&amp;#8217;ll be loaded&amp;nbsp;successfully.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Usage&lt;/h4&gt;
&lt;p&gt;Plugins in RequireJS are invoked on a per-module basis. You can specify that a certain dependency &lt;code&gt;'bar'&lt;/code&gt; shall be loaded
through a plugin &lt;code&gt;'foo'&lt;/code&gt; by putting &lt;code&gt;'foo!bar'&lt;/code&gt; on the dependency&amp;nbsp;list:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;define&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;foo!bar&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;bar&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Both &lt;code&gt;'foo'&lt;/code&gt; and &lt;code&gt;'bar'&lt;/code&gt; represent module paths here: the first one is the path to the &lt;em&gt;plugin&lt;/em&gt; module,
while the second one is the actual dependency. In a more realistic example &amp;#8212; like when our optional loader is involved &amp;#8212;
both of them would most likely be multi-segments&amp;nbsp;paths:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;define&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;myapp/ext/require/optional!myapp/common/buttons/awesome-button&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;AwesomeButtonController&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As you can see, they can get pretty unreadable rather quickly. It would be better if the plugin prefix consisted
of just one segment (i.e. &lt;code&gt;optional!&lt;/code&gt;) instead. We can make that happen by adding
&lt;a href="http://requirejs.org/docs/api.html#config-map"&gt;a mapping&lt;/a&gt; to the RequireJS&amp;nbsp;config:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;requirejs&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;config&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
    &lt;span class="nx"&gt;map&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s1"&gt;&amp;#39;*&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="s1"&gt;&amp;#39;optional&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;myapp/ext/require/optional&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With this renaming in place, the loading of non-mandatory dependencies becomes quite a bit&amp;nbsp;clearer:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;define&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;optional!myapp/common/buttons/awesome-button&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;AwesomeButtonController&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;

&lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="nx"&gt;AwesomeButtonController&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ... (some work around) ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Of course, you still need to actually code around the potential lack of an optional dependency.
The &lt;code&gt;if&lt;/code&gt; statement above is just an illustrative example; you may find it more sensible to provide some shim&amp;nbsp;instead:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;AwesomeButtonController&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;AwesomeButtonController&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Either way, I recommend trying to keep the size of such conditional logic to a minimum.
Ideally, it should be confined to a single place, or &amp;#8212; better yet &amp;#8212; abstracted behind a&amp;nbsp;function.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;An actual &lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import"&gt;&lt;code&gt;import&lt;/code&gt; statement&lt;/a&gt;
has made it into the &lt;span class="caps"&gt;ES6&lt;/span&gt; (ECMAScript 2015) standard but, as of this writing, no browser implements it.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Most of the code for the plugin presented here is based on
&lt;a href="http://stackoverflow.com/a/27422370/434799"&gt;this StackOverflow answer&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Tue, 29 Sep 2015 22:15:00 -0700</pubDate><guid>tag:xion.io,2015-09-29:post/code/requirejs-optional.html</guid><category>JavaScript</category><category>RequireJS</category><category>modules</category><category>Web Workers</category><category>DOM</category><category>AJAX</category></item><item><title>Reload Jinja macro files</title><link>http://xion.io/post/code/jinja-reload-macro-files.html</link><description>&lt;p&gt;The integration between &lt;a href="http://jinja.pocoo.org"&gt;Jinja templating engine&lt;/a&gt; and the
&lt;a href="http://flask.pocoo.org"&gt;Flask microframework&lt;/a&gt; for Python is quite seamless most of the time. It also facilitates
rapid development: when we run our web application through Flask&amp;#8217;s development server, any changes in Python code
will get picked up immediately without restarting it. Similarly, Jinja&amp;#8217;s default template loader will detect
whether any template has been modified after its last compilation and recompile it if&amp;nbsp;necessary.&lt;/p&gt;
&lt;p&gt;One instance when it &lt;em&gt;doesn&amp;#8217;t&lt;/em&gt; seem to work that well, though, is template files that only contain
&lt;a href="http://jinja.pocoo.org/docs/dev/templates/#macros"&gt;Jinja macros&lt;/a&gt;. They apparently aren&amp;#8217;t subject to the same caching
rules that apply to regular templates. Modifications to those files alone may not be picked up by Jinja &lt;code&gt;Environment&lt;/code&gt;,
causing &lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.render_template"&gt;&lt;code&gt;render_template&lt;/code&gt; calls&lt;/a&gt; in Flask
to (indirectly) use their stale&amp;nbsp;versions.&lt;/p&gt;
&lt;h4&gt;I&amp;#8217;ll be watching&amp;nbsp;you&lt;/h4&gt;
&lt;p&gt;This problem can be alleviated by making the server watch those macro files explicitly, not unlike the Python sources
it already monitors. When running a Flask server through
&lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.run"&gt;the &lt;code&gt;Flask.run&lt;/code&gt; method&lt;/a&gt;, you can pass additional keyword arguments
which aren&amp;#8217;t handled by Flask itself, but by the underlying &lt;a href="http://wsgi.readthedocs.org/en/latest/what.html"&gt;&lt;span class="caps"&gt;WSGI&lt;/span&gt;&lt;/a&gt;
scaffolding called &lt;a href="http://werkzeug.pocoo.org/"&gt;Werkzeug&lt;/a&gt;. The automatic reloader is actually part of it and is quite
configurable. Most importantly, it allows passing a list of &lt;code&gt;extra_files=&lt;/code&gt; to&amp;nbsp;watch:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;

&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0.0.0.0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;PORT&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5000&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
        &lt;span class="n"&gt;extra_files&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;root_path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;template_folder&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;macros.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But of course it&amp;#8217;s tedious and error-prone to keep this list up to date manually, so let&amp;#8217;s try to do&amp;nbsp;better.&lt;/p&gt;
&lt;h4&gt;&amp;#8230;all of&amp;nbsp;you&lt;/h4&gt;
&lt;p&gt;I&amp;#8217;m going to assume you&amp;#8217;re keeping all your Jinja macro files inside a single directory. This makes sense,
as macros are reusable pieces of template code that are imported by multiple regular templates,
so they shouldn&amp;#8217;t be scattered around the codebase without some order. The folder may be named &lt;em&gt;macros&lt;/em&gt;, &lt;em&gt;util&lt;/em&gt;,
&lt;em&gt;common&lt;/em&gt;, or similar; what&amp;#8217;s important is that all the macros have a designated place in the project source&amp;nbsp;tree.&lt;/p&gt;
&lt;p&gt;Under this assumption, it&amp;#8217;s not difficult to programmatically compute their complete list&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pathlib&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;myapplication&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;  &lt;span class="c"&gt;# Flask application object&lt;/span&gt;


&lt;span class="c"&gt;#: Directories under app&amp;#39;s template folder that contain files&lt;/span&gt;
&lt;span class="c"&gt;#: with only Jinja macros.&lt;/span&gt;
&lt;span class="n"&gt;JINJA_MACRO_DIRS&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;macros&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_extra_files&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Returns an iterable of the extra files that the Flask server&lt;/span&gt;
&lt;span class="sd"&gt;    should monitor for changes and reload the app if any has been modified.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;app_root&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;root_path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;dirname&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;JINJA_MACRO_DIRS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;macros_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;app_root&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;template_folder&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;dirname&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;filepath&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;macros_dir&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rglob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filepath&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If you&amp;#8217;re using Flask &lt;a href="http://flask.pocoo.org/docs/0.10/blueprints/"&gt;blueprints&lt;/a&gt;,
in addition to the global application templates you&amp;#8217;d also want to monitor any blueprint-specific macro&amp;nbsp;files:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;bp&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;blueprints&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="p"&gt;{})&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="n"&gt;macros_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;root_path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;bp&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;template_folder&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="n"&gt;dirname&lt;/span&gt;
            &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;filepath&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;macros_dir&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rglob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filepath&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;A new&amp;nbsp;start&lt;/h4&gt;
&lt;p&gt;How you&amp;#8217;re going to use the &lt;code&gt;get_extra_files&lt;/code&gt; function from the snippet above depends on how exactly you&amp;#8217;re running
the Flask development server. In the simplest case, when &lt;code&gt;Flask.run&lt;/code&gt; is invoked at the top-level scope of some module,
it&amp;#8217;s pretty&amp;nbsp;obvious:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;extra_files&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_extra_files&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;More realistically, though, you may be using the &lt;a href="http://flask-script.readthedocs.org/"&gt;Flask-Script&lt;/a&gt; extension
for all management tasks, including starting the server. If so, calling &lt;code&gt;Flask.run&lt;/code&gt; will be relegated to it,
so you&amp;#8217;ll need to override the &lt;code&gt;Server&lt;/code&gt; command to inject additional parameters&amp;nbsp;there:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;flask.ext.script&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Manager&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Server&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;_Server&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;myapplication&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_Server&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;use_reloader&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setdefault&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;extra_files&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;extend&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_extra_files&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Server&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="n"&gt;manager&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Manager&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;with_default_commands&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;PORT&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;5000&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;span class="n"&gt;manager&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_command&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;server&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This new &lt;code&gt;server&lt;/code&gt; command should work just like the default one provided by Flask-Script out of the box,
except that all your Jinja macro files will now be monitored for&amp;nbsp;changes.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Like &lt;a href="http://xion.io/post/code/flask-auto-error-pages.html"&gt;before&lt;/a&gt;, I&amp;#8217;m using the
&lt;a href="https://docs.python.org/3/library/pathlib.html"&gt;&lt;em&gt;pathlib&lt;/em&gt; module&lt;/a&gt;, for which there is a
&lt;a href="https://pypi.python.org/pypi/pathlib/"&gt;backport&lt;/a&gt; if you&amp;#8217;re using Python 3.3 or older.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Thu, 24 Sep 2015 20:36:00 -0700</pubDate><guid>tag:xion.io,2015-09-24:post/code/jinja-reload-macro-files.html</guid><category>Python</category><category>Jinja</category><category>Flask</category><category>Werkzeug</category><category>Flask-Script</category></item><item><title>Purging local Memcached</title><link>http://xion.io/post/code/memcached-purge-local.html</link><description>&lt;p&gt;&lt;a href="http://memcached.org/"&gt;Memcached&lt;/a&gt; is a ubiquitous caching solution, most commonly used to speed things up
in web application backends. You deploy it as a separate binary and have your application servers talk to it
before querying a database, calling a third party &lt;span class="caps"&gt;API&lt;/span&gt; over &lt;span class="caps"&gt;HTTP&lt;/span&gt;, or performing some other time-consuming I/O operation.
Since it stores data in memory, as its name obviously suggests, it can be orders of magnitude faster than anything
that may have to hit a spinning disk (like a database) or an unreliable, external&amp;nbsp;network.&lt;/p&gt;
&lt;p&gt;From the point of view of a developer, using Memcached is pretty simple.
There exist &lt;a href="https://code.google.com/p/memcached/wiki/Clients"&gt;numerous libraries&lt;/a&gt; that wrap its protocol in a neat,
language-appropriate &lt;span class="caps"&gt;API&lt;/span&gt;. It does put another requirement on the development environment, of course: you need to have
a working memcached deamon in the background if you want the local server to hit code paths where it retrieves data
from memcache&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;. Thankfully, it&amp;#8217;s an extremely popular piece of software, present in basically all
&lt;a href="https://code.google.com/p/memcached/wiki/NewInstallFromPackage"&gt;package repositories&lt;/a&gt;,
so having it up and running is just one &lt;code&gt;apt-get install&lt;/code&gt; or &lt;code&gt;brew install&lt;/code&gt; away.&lt;/p&gt;
&lt;h4&gt;How to&amp;nbsp;flush&lt;/h4&gt;
&lt;p&gt;It&amp;#8217;s a little dated and finicky piece of software, too. Once you have its local instance used for a while,
there comes a time when you&amp;#8217;d like to purge all its contents and have your server(s) fill it up again.
Rather than restarting the daemon (which is system-specific procedure that may require root privileges),
you&amp;#8217;d like to just issue the &lt;code&gt;flush_all&lt;/code&gt; command to&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;This &lt;em&gt;should&lt;/em&gt; be easy. Unlike &lt;a href="http://redis.io/"&gt;Redis&lt;/a&gt;, however, memcached doesn&amp;#8217;t come with a dedicated &lt;span class="caps"&gt;CLI&lt;/span&gt; client.
In theory, it doesn&amp;#8217;t have to, because you can talk to it over just &lt;code&gt;telnet&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is &lt;span class="s1"&gt;&amp;#39;^]&amp;#39;&lt;/span&gt;.
flush_all
OK
^&lt;span class="o"&gt;]&lt;/span&gt;

telnet&amp;gt; quit
Connection closed.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But going through this rigmarole every time we want to flush memcache gets a bit tedious after a while.
An obvious attempt at automating it will, however,&amp;nbsp;fail:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;flush_all\n&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is &lt;span class="s1"&gt;&amp;#39;^]&amp;#39;&lt;/span&gt;.
Connection closed by foreign host.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Turns out the you cannot just bombard memcached with &lt;code&gt;flush_all&lt;/code&gt; (or any other command) while the connection
is being established. You can of course try adding a &lt;code&gt;sleep&lt;/code&gt; to allow it some time, but this is inherently unreliable,
especially when connecting to remote&amp;nbsp;servers.&lt;/p&gt;
&lt;p&gt;The most successful approach I&amp;#8217;ve managed to find is to automate not the raw data exchange,
but the &lt;em&gt;interactive &lt;code&gt;telnet&lt;/code&gt; session itself&lt;/em&gt;. By that I mean invoking a &lt;code&gt;telnet&lt;/code&gt; command, observing its output
and reacting to it &amp;#8212; just like a human would do, but in a scripted, automated&amp;nbsp;way.&lt;/p&gt;
&lt;h4&gt;Nobody expects the Telnet&amp;nbsp;instrumentation&lt;/h4&gt;
&lt;p&gt;There is a dedicated Unix program for scripting just this kind of &lt;span class="caps"&gt;CLI&lt;/span&gt; interactions. It&amp;#8217;s decidedly more obscure
than mere &lt;code&gt;echo&lt;/code&gt; or pipes, but should nonetheless be available for any modern (or ancient) Unix system,
from Linuxes to &lt;span class="caps"&gt;OSX&lt;/span&gt;. Its name is &lt;code&gt;expect&lt;/code&gt; and &amp;#8212; if installed&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt; &amp;#8212; the usual place you can find it is
&lt;code&gt;/usr/bin&lt;/code&gt; or &lt;code&gt;/usr/local/bin&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;expect&lt;/code&gt; accepts commands and scripts written in &lt;a href="https://en.wikipedia.org/wiki/Tcl"&gt;Tcl&lt;/a&gt; &amp;#8212; a scripting language
whose syntax looks a bit like a mix of &lt;span class="caps"&gt;PHP&lt;/span&gt; and Objective-C. It&amp;#8217;s a fully featured language with all the usual
programming constructs you&amp;#8217;d normally want but &lt;code&gt;expect&lt;/code&gt; enhances it further with instructions dedicated to spawning
external processes, reading their output, and sending input in&amp;nbsp;response.&lt;/p&gt;
&lt;p&gt;In fact, the main commands of the &lt;code&gt;expect&lt;/code&gt; program are &lt;code&gt;spawn&lt;/code&gt;, &lt;code&gt;expect&lt;/code&gt;, and &lt;code&gt;send&lt;/code&gt;. Mashing them together,
we can easily nail the crucial part of our memcache-purging&amp;nbsp;script:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/expect&lt;/span&gt;

&lt;span class="nv"&gt;spawn&lt;/span&gt; telnet localhost &lt;span class="mi"&gt;11211&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;expect&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Connected to localhost&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;send&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;flush_all\n&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This performs the actual flush but the &lt;code&gt;telnet&lt;/code&gt; session/process is kept open afterwards.
Once the &lt;code&gt;expect&lt;/code&gt; program ends (after finishing our script), that process may get orphaned and hog system resources.
To prevent that, we should behave like a good Unix citizen and &lt;em&gt;wait&lt;/em&gt; for our child processes to&amp;nbsp;terminate:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;wait&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But obviously, this will never happen, because we&amp;#8217;ve never instructed the &lt;code&gt;telnet&lt;/code&gt; process to&amp;nbsp;end!&lt;/p&gt;
&lt;h4&gt;Escape&amp;nbsp;artist&lt;/h4&gt;
&lt;p&gt;Your first instinct may be to send &lt;code&gt;^C&lt;/code&gt; (&lt;span class="caps"&gt;SIGINT&lt;/span&gt;) or &lt;code&gt;^D&lt;/code&gt; (end-of-file) to the &lt;code&gt;telnet&lt;/code&gt; process
but this won&amp;#8217;t work either. Everything we type inside an active Telnet session is sent to the remote server,
and that includes those two key&amp;nbsp;chords.&lt;/p&gt;
&lt;p&gt;Authors of the &lt;code&gt;telnet&lt;/code&gt; program were of course aware of this problem. As a countermeasure, they introduced the concept
of an &lt;em&gt;escape character&lt;/em&gt; that allows the user to control the Telnet connection itself &amp;#8212; including, but not limited to,
its termination. When encountered in the input stream, the escape character causes &lt;code&gt;telnet&lt;/code&gt; to temporally suspend
its normal operation, &amp;#8220;escaping&amp;#8221; from the client-server session to a simple command shell of the &lt;code&gt;telnet&lt;/code&gt; program itself.
(This is indicated by the &lt;code&gt;telnet&amp;gt;&lt;/code&gt; prompt).&lt;/p&gt;
&lt;p&gt;The default escape character is &lt;code&gt;^]&lt;/code&gt;, which can be easily typed on a keyboard using the key combination &lt;em&gt;Ctrl+]&lt;/em&gt;.
The &lt;code&gt;expect&lt;/code&gt; program, however, only simulates typing real characters. Coupled with some syntactical quirks of the Tcl
language, this makes the usage of &lt;code&gt;^]&lt;/code&gt; as an escape character rather cumbersome, to say the&amp;nbsp;least.&lt;/p&gt;
&lt;p&gt;Fortunately, this default can be changed rather easily with an &lt;code&gt;-e&lt;/code&gt; flag to the &lt;code&gt;telnet&lt;/code&gt; application.
After setting it to something more common but still outside of the memcache protocol &amp;#8212; such as the exclamation mark &amp;#8212;
we are now able to &lt;code&gt;send&lt;/code&gt; it without an&amp;nbsp;issue:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/expect&lt;/span&gt;

&lt;span class="k"&gt;set&lt;/span&gt; escapechar &lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;

&lt;span class="nv"&gt;spawn&lt;/span&gt; telnet &lt;span class="o"&gt;-&lt;/span&gt;e &lt;span class="nv"&gt;$escapechar&lt;/span&gt; localhost &lt;span class="mi"&gt;11211&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;expect&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Connected to localhost&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;send&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;flush_all\n&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;

&lt;span class="nv"&gt;send&lt;/span&gt; &lt;span class="nv"&gt;$escapechar&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;expect&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;telnet&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;send&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;quit\n&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;wait&lt;/span&gt;&lt;span class="k"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The script will also terminate despite &lt;code&gt;wait&lt;/code&gt;ing for the &lt;code&gt;telnet&lt;/code&gt; process to finish, which means everything has been
shut down&amp;nbsp;gracefully.&lt;/p&gt;
&lt;h4&gt;Production-ready&lt;/h4&gt;
&lt;p&gt;As a final touch, it&amp;#8217;d be nice to make our solution work with any memcache server and not just &lt;em&gt;localhost&lt;/em&gt;.
You can see it done in &lt;a href="https://gist.github.com/Xion/624979b05e0411324eb1"&gt;this gist&lt;/a&gt;: the script accepts
two optional arguments (host &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; port) and uses it when spawning the &lt;code&gt;telnet&lt;/code&gt; process.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;It probably goes without saying that any value in the memcache, as well as the entire memcached server (or servers),
must be treated as potentially unavailable at any time. A properly written application server should still be able
to service all requests &amp;#8212; if only a little slower &amp;#8212; without any (mem)caching at all.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;On all distros, as well as in Homebrew for &lt;span class="caps"&gt;OSX&lt;/span&gt;, it should be available as a package with a totally uncreative
name of &lt;code&gt;expect&lt;/code&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Sat, 19 Sep 2015 20:23:00 -0700</pubDate><guid>tag:xion.io,2015-09-19:post/code/memcached-purge-local.html</guid><category>memcache</category><category>Memcached</category><category>expect</category><category>caching</category><category>scripting</category><category>Tcl</category></item><item><title>mailto: URLs in JavaScript</title><link>http://xion.io/post/code/js-mailto-urls.html</link><description>&lt;p&gt;Though not as popular as back in the days, &lt;code&gt;mailto:&lt;/code&gt; URLs are sometimes still the best way
&amp;#8212; and most certainly the easiest &amp;#8212; to enable users to send emails from a web application. Typically, they are used
in plain regular links that are created with the &lt;code&gt;&amp;lt;a&amp;gt;&lt;/code&gt; tag:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;a&lt;/span&gt; &lt;span class="na"&gt;href=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;mailto:john.doe@example.com&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Send email&lt;span class="nt"&gt;&amp;lt;/a&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Depending on the operating system and browser settings, clicking on such a link could invoke a different mail client.
In the past, this could cause much confusion if the user has never used its local email application (e.g. Outlook),
but nowadays browsers are increasingly doing the right thing and presenting a choice of possible options.
This includes the various web applications from popular email providers. User can thus choose &amp;#8212; say &amp;#8212; Gmail, and have
all subsequent &lt;code&gt;mailto:&lt;/code&gt; links take them to a &lt;em&gt;Compose Mail&lt;/em&gt; view&amp;nbsp;there.&lt;/p&gt;
&lt;p&gt;Given those developments, it&amp;#8217;s possible that soon those URLs won&amp;#8217;t be as quaint as they used to be ;)
In any case, I think it&amp;#8217;s worthwhile to have a few &lt;code&gt;mailto:&lt;/code&gt; tricks up our sleeve for when they turn out to be
an appropriate solution for the task at&amp;nbsp;hand.&lt;/p&gt;
&lt;h4&gt;Triggering them in&amp;nbsp;JavaScript&lt;/h4&gt;
&lt;p&gt;In the example above, I&amp;#8217;ve used a &lt;code&gt;mailto:&lt;/code&gt; &lt;span class="caps"&gt;URL&lt;/span&gt; directly in some &lt;span class="caps"&gt;HTML&lt;/span&gt; markup. For the most part, however, those URLs
behave like any other and support a lot of the same functionality that &lt;code&gt;http://&lt;/code&gt; URLs&amp;nbsp;do:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;sendEmail&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;location&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;href&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;mailto:&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;address&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Predictably, calling this &lt;code&gt;sendEmail&lt;/code&gt; function is equivalent to clicking on a &lt;code&gt;mailto:&lt;/code&gt; link. This additional level
of indirection, however, may be enough to fool some web crawlers that look for email addresses to spam. Its effectiveness
depends largely on how radically we&amp;#8217;re going to obfuscate the &lt;code&gt;address&lt;/code&gt; argument in the actual&amp;nbsp;invocation.&lt;/p&gt;
&lt;p&gt;More importantly, though, a function like that can be part of some more complicated logic. The only limitation is
the same one that restricts where and when it&amp;#8217;s possible to &lt;code&gt;window.open&lt;/code&gt; another browser window. Namely, it has to be
called in a direct response to a &lt;span class="caps"&gt;UI&lt;/span&gt; action triggered by the user (a button click would be a good&amp;nbsp;example).&lt;/p&gt;
&lt;h4&gt;Customization&lt;/h4&gt;
&lt;p&gt;In their simplest form, &lt;code&gt;mailto:&lt;/code&gt; URLs aren&amp;#8217;t terribly interesting, since their only parameter is the address of a sole recipient. Fortunately, this isn&amp;#8217;t where their capabilities end: it&amp;#8217;s possible to customize other email fields as well,
such as the subject or even body&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Somewhat surprisingly, all this can be done in a manner that&amp;#8217;s more typical for &lt;code&gt;http://&lt;/code&gt; &lt;span class="caps"&gt;URL&lt;/span&gt;: with query string
parameters. Right after the recipient&amp;#8217;s address, we can drop a question mark and add some ampersand-separated
key-value&amp;nbsp;pairs:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;a&lt;/span&gt; &lt;span class="na"&gt;href=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;mailto:john.doe@example.com?subject=Hi&amp;amp;amp;body=Hello%20John!&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  Say hello to John!
&lt;span class="nt"&gt;&amp;lt;/a&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;A more programmatic approach is of course also possible. One thing we need to remember, though, is the proper escaping
of input values in order to make them safe to put inside an &lt;span class="caps"&gt;URL&lt;/span&gt;&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;.
The &lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent"&gt;&lt;code&gt;encodeURIComponent&lt;/code&gt; function&lt;/a&gt; can be used for this&amp;nbsp;purpose:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;getMailtoUrl&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;to&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;subject&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[];&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;typeof&lt;/span&gt; &lt;span class="nx"&gt;subject&lt;/span&gt; &lt;span class="o"&gt;!==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;undefined&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;args&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;subject=&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nb"&gt;encodeURIComponent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;subject&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;typeof&lt;/span&gt; &lt;span class="nx"&gt;body&lt;/span&gt; &lt;span class="o"&gt;!==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;undefined&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;args&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;body=&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nb"&gt;encodeURIComponent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;mailto:&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nb"&gt;encodeURIComponent&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;to&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;args&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;length&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;url&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;?&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="nx"&gt;args&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;amp;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;url&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In theory, almost any of the numerous &lt;a href="https://en.wikipedia.org/wiki/Email#Header_fields"&gt;email headers&lt;/a&gt; can be specified
this way. However, support may vary across browsers, especially since some of the headers
(like &lt;a href="https://en.wikipedia.org/wiki/Blind_carbon_copy"&gt;the &lt;code&gt;Bcc:&lt;/code&gt; one&lt;/a&gt;) are subject to certain security
or privacy considerations. Personally, I wouldn&amp;#8217;t recommend relying on anything besides
&lt;code&gt;subject=&lt;/code&gt; and &lt;code&gt;body=&lt;/code&gt;, with a possible addition of &lt;code&gt;cc=&lt;/code&gt; for
&lt;a href="https://en.wikipedia.org/wiki/Carbon_copy"&gt;the &lt;code&gt;Cc:&lt;/code&gt;header &lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;By &lt;a href="http://www.ietf.org/rfc/rfc2368.txt"&gt;&lt;span class="caps"&gt;RFC&lt;/span&gt; 2368&lt;/a&gt;, only &lt;em&gt;text/plain&lt;/em&gt; email body can be specified this way.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Note that this is unrelated to the &lt;em&gt;&lt;span class="caps"&gt;HTML&lt;/span&gt;&lt;/em&gt; escaping of &lt;code&gt;&amp;amp;&lt;/code&gt; character as &lt;code&gt;&amp;amp;amp;&lt;/code&gt; entity in the previous example.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Tue, 15 Sep 2015 22:49:00 -0700</pubDate><guid>tag:xion.io,2015-09-15:post/code/js-mailto-urls.html</guid><category>JavaScript</category><category>email</category><category>URL</category></item><item><title>Query string authentication in Requests</title><link>http://xion.io/post/code/requests-query-string-auth.html</link><description>&lt;p&gt;&lt;a href="http://python-requests.org"&gt;Requests&lt;/a&gt; is a widely used Python library that provides a nicer &lt;span class="caps"&gt;API&lt;/span&gt; for writing &lt;span class="caps"&gt;HTTP&lt;/span&gt; clients
than the standard &lt;code&gt;urllib2&lt;/code&gt; module does. It deals with authentication in an especially concise way: through
a simple &lt;code&gt;auth=&lt;/code&gt; argument, rather than a
&lt;a href="https://gist.github.com/kennethreitz/973705"&gt;separate password manager &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; authentication handler&lt;/a&gt; or other such&amp;nbsp;nonsense.&lt;/p&gt;
&lt;p&gt;There are &lt;a href="http://docs.python-requests.org/en/latest/user/authentication/"&gt;several possible ways&lt;/a&gt;
to authenticate an &lt;span class="caps"&gt;HTTP&lt;/span&gt; call with Requests, and it&amp;#8217;s pretty easy to
&lt;a href="http://docs.python-requests.org/en/latest/user/authentication/#new-forms-of-authentication"&gt;implement our own approach&lt;/a&gt;
if the server requires it. All the built-in ways, however, as well as
&lt;a href="http://docs.python-requests.org/en/latest/user/advanced/#custom-authentication"&gt;the examples of custom implementations&lt;/a&gt;,
are heavily biased towards using &lt;span class="caps"&gt;HTTP&lt;/span&gt; headers to transmit the necessary credentials (such as username/password
or some kind of opaque&amp;nbsp;token).&lt;/p&gt;
&lt;h4&gt;Non-standard&amp;nbsp;auth&lt;/h4&gt;
&lt;p&gt;This is actually quite reasonable: the most popular authentication methods, including OAuth 1.0 &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; 2.0, use &lt;span class="caps"&gt;HTTP&lt;/span&gt; headers
either primarily or&amp;nbsp;exclusively.&lt;/p&gt;
&lt;p&gt;Not every &lt;span class="caps"&gt;HTTP&lt;/span&gt; &lt;span class="caps"&gt;API&lt;/span&gt; follows this convention, though. Sometimes, credentials are put in other parts of the request,
commonly the &lt;span class="caps"&gt;URL&lt;/span&gt; itself. It may seem like a bad idea at first but it can also be perfectly acceptable:
credentials don&amp;#8217;t have to expose secrets of any particular &lt;em&gt;user&lt;/em&gt; of the remote&amp;nbsp;system.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://steamcommunity.com/dev"&gt;Steam &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt; is a good example here. Calling any of
&lt;a href="https://developer.valvesoftware.com/wiki/Steam_Web_API#Interfaces_and_method"&gt;its endpoints&lt;/a&gt; requires providing
an &lt;span class="caps"&gt;API&lt;/span&gt; key but it grants no special rights to access data of any particular Steam user. All the information
it returns is already visible on their public profile&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;For those special authentication schemes, Requests necessitate rolling out our own implementation.
Thankfully, doing so is mostly pretty&amp;nbsp;straightforward.&lt;/p&gt;
&lt;h4&gt;Simple&amp;nbsp;example&lt;/h4&gt;
&lt;p&gt;All Requests&amp;#8217; authenticators are callable objects inheriting from &lt;code&gt;requests.auth.AuthBase&lt;/code&gt; class.
Writing your own is hence a matter of defining a subclass of &lt;code&gt;AuthBase&lt;/code&gt; with at least a &lt;code&gt;__call__&lt;/code&gt; method:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;SillyAuth&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;AuthBase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;X-ID&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;im valid so auth is yes&amp;#39;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;

&lt;span class="c"&gt;# usage&lt;/span&gt;
&lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;http://example.com&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;auth&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;SillyAuth&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The job of an authenticator is to modify the &lt;code&gt;request&lt;/code&gt; so that it includes appropriate credentials in whatever form
necessary to have them accepted by the remote server. Like I&amp;#8217;ve mentioned before, &lt;span class="caps"&gt;HTTP&lt;/span&gt; headers are the most common option,
but the request can be modified in other ways as&amp;nbsp;well.&lt;/p&gt;
&lt;h4&gt;Query string&amp;nbsp;parameters&lt;/h4&gt;
&lt;p&gt;One problem with modifying a query string, though, is that it&amp;#8217;s a part of request &lt;span class="caps"&gt;URL&lt;/span&gt;. By the time it reaches
authenticators, the Requests library has already merged any additional query params into it&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2" rel="footnote"&gt;2&lt;/a&gt;&lt;/sup&gt;. Including more params
will thus require modifying the &lt;span class="caps"&gt;URL&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Though it may sound like a risky endeavour involving string manipulations that are fraught with security issues,
it&amp;#8217;s not really &lt;em&gt;that&lt;/em&gt; bad at all. In fact, the Requests library provides an &lt;span class="caps"&gt;API&lt;/span&gt; to do exactly&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;QueryStringAuth&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;AuthBase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Authenticator that attaches a set of query string parameters&lt;/span&gt;
&lt;span class="sd"&gt;    (e.g. an API key) to the request.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__call__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;prepare_url&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;request&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Albeit &lt;a href="http://docs.python-requests.org/en/latest/api/#requests.PreparedRequest.prepare_url"&gt;scantly documented&lt;/a&gt;,
the &lt;code&gt;prepare_url&lt;/code&gt; method will take an existing &lt;span class="caps"&gt;URL&lt;/span&gt; and a dictionary of query string params, and outfit the request
with a brand new &lt;span class="caps"&gt;URL&lt;/span&gt; that contains those params neatly&amp;nbsp;encoded.&lt;/p&gt;
&lt;p&gt;Full implementation of &lt;code&gt;QueryStringAuth&lt;/code&gt; is a &lt;a href="https://gist.github.com/Xion/9c1bbbc287d4443dbaf5"&gt;little more involved&lt;/a&gt;
than the snippet above, because we should like to replicate all the idiosyncracies of how
&lt;a href="http://docs.python-requests.org/en/latest/user/quickstart/#passing-parameters-in-urls"&gt;regular Requests &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt;
handles query string params. Some of them &amp;#8212; like allowing both strings and lists as param values &amp;#8212; are taken care of
by &lt;code&gt;prepare_url&lt;/code&gt; itself, but the rest should be dealt with on our&amp;nbsp;own.&lt;/p&gt;
&lt;h4&gt;Usage&lt;/h4&gt;
&lt;p&gt;To finish up, let&amp;#8217;s use this authenticator to call Steam &lt;span class="caps"&gt;API&lt;/span&gt; and return a
&lt;a href="https://developer.valvesoftware.com/wiki/Steam_Web_API#GetOwnedGames_.28v0001.29"&gt;list of games&lt;/a&gt;
that a given user owns but hasn&amp;#8217;t played&amp;nbsp;yet:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;STEAM_API_KEY&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;a1b2c3d4e5f6g7h8i9j&amp;#39;&lt;/span&gt;  &lt;span class="c"&gt;# not a real one, of course&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_steam_backlog&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;steam_id&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s"&gt;&amp;#39;steamid&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;steam_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s"&gt;&amp;#39;include_appinfo&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;requests&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;params&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;auth&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;QueryStringAuth&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;STEAM_API_KEY&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;games&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;response&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{})&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;games&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;())&lt;/span&gt;

    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;game&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;games&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;game&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;playtime_forever&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;continue&lt;/span&gt;
        &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;game&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We could&amp;#8217;ve put &lt;code&gt;STEAM_API_KEY&lt;/code&gt; directly in &lt;code&gt;params&lt;/code&gt;, of course. Singling it out explicitly as an authentication
detail, however, makes the code clearer and plays nicely with more advanced features of Requests,
such as &lt;a href="http://docs.python-requests.org/en/latest/user/advanced/#session-objects"&gt;sessions&lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;It can be said that only in this case we&amp;#8217;re dealing with exclusively &lt;em&gt;authentication&lt;/em&gt;, whereas the others
also perform &lt;em&gt;authorization&lt;/em&gt;. I wouldn&amp;#8217;t quibble too much about those details. The fact that both terms are often
shortened to &amp;#8220;auth&amp;#8221; doesn&amp;#8217;t exactly help with distinguishing them anyway.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;In fact, what &lt;code&gt;AuthBase.__call__&lt;/code&gt; receives is a special
&lt;a href="http://docs.python-requests.org/en/latest/user/advanced/#prepared-requests"&gt;&lt;code&gt;PreparedRequest&lt;/code&gt; object&lt;/a&gt; which contains
the exact bytes that&amp;#8217;ll be sent to the server. Most of the higher level abstractions offered by the Requests library
(like form data or &lt;span class="caps"&gt;JSON&lt;/span&gt; request body) has been compiled to raw octets at this point. This is done to allow
some authenticators (like OAuth) to analyze the full request payload and sign it cryptographically
as a part of their flow.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Fri, 11 Sep 2015 22:54:00 -0700</pubDate><guid>tag:xion.io,2015-09-11:post/code/requests-query-string-auth.html</guid><category>Python</category><category>Requests</category><category>HTTP</category><category>authentication</category></item><item><title>Automatic error pages in Flask</title><link>http://xion.io/post/code/flask-auto-error-pages.html</link><description>&lt;p&gt;In &lt;a href="http://flask.pocoo.org"&gt;Flask&lt;/a&gt;, a popular web framework for Python, it&amp;#8217;s pretty easy to implement custom handlers
for specific &lt;span class="caps"&gt;HTTP&lt;/span&gt; errors. All you have to do is to write a function and annotate it with the &lt;code&gt;@errorhandler&lt;/code&gt; decorator:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@app.errorhandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;not_found&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;errors/404.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Albeit simple, the above example is actually very realistic. There&amp;#8217;s rarely anything else to do in response to serious
request error than to send back some &lt;span class="caps"&gt;HTML&lt;/span&gt; with an appropriate message. If you have more handlers like that, though,
you&amp;#8217;ll notice they get pretty repetitive: for each erroneous &lt;span class="caps"&gt;HTTP&lt;/span&gt; status code (404, 403, 400, etc.),
pick a corresponding template and simply render&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Which is, of course, why we&amp;#8217;d want to deal with all in a little smarter way and with less&amp;nbsp;boilerplate.&lt;/p&gt;
&lt;h4&gt;Just add a&amp;nbsp;template&lt;/h4&gt;
&lt;p&gt;Ideally, we would like to avoid writing any Python code at all for each individual error handler. Since all we&amp;#8217;re doing
revolves around predefined templates, let&amp;#8217;s just define the handlers automatically based on the &lt;span class="caps"&gt;HTML&lt;/span&gt; files&amp;nbsp;themselves.&lt;/p&gt;
&lt;p&gt;Assuming we store them in the same template directory &amp;#8212; say, &lt;code&gt;errors/&lt;/code&gt; &amp;#8212; and name their files after
numeric status codes (e.g. &lt;em&gt;404.html&lt;/em&gt;), getting all those codes is quite simple&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1" rel="footnote"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pathlib&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;PurePath&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;mywebapp&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;


&lt;span class="c"&gt;#: Path to the directory where HTML templates for error pages are stored.&lt;/span&gt;
&lt;span class="n"&gt;ERRORS_DIR&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PurePath&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;errors&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;get_supported_error_codes&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Returns an iterable of HTTP status codes for which we have&lt;/span&gt;
&lt;span class="sd"&gt;    a custom error page templates defined.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;error_templates_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;root_path&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;template_folder&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ERRORS_DIR&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;potential_error_templates&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;entry&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;entry&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;error_templates_dir&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;glob&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;*.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;entry&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_file&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;template&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;potential_error_templates&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;template&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stem&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;  &lt;span class="c"&gt;# e.g. 404.html&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;ValueError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;pass&lt;/span&gt;  &lt;span class="c"&gt;# could be some base.html template, or similar&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;400&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;warning&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
                    &lt;span class="s"&gt;&amp;quot;Found error template for non-error HTTP status &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="k"&gt;continue&lt;/span&gt;
            &lt;span class="k"&gt;yield&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Once we have them, we can try wiring up the handlers programmatically and making them do the right&amp;nbsp;thing.&lt;/p&gt;
&lt;h4&gt;One function to handle them&amp;nbsp;all&lt;/h4&gt;
&lt;p&gt;Although I&amp;#8217;ve used a plural here, in reality we only need a single handler, as it&amp;#8217;ll be perfectly capable of
dealing with any &lt;span class="caps"&gt;HTTP&lt;/span&gt; error we bind it to. To help distinguishing between the different status codes,
Flask by default invokes our error handlers with an
&lt;a href="http://werkzeug.pocoo.org/docs/0.10/exceptions/#werkzeug.exceptions.HTTPException"&gt;&lt;code&gt;HTTPException&lt;/code&gt;&lt;/a&gt; argument
that has the &lt;code&gt;code&lt;/code&gt; as an&amp;nbsp;attribute:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;flask&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jinja2&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;TemplateNotFound&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;error_handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Universal handler for all HTTP errors.&lt;/span&gt;

&lt;span class="sd"&gt;    :param error: :class:`~werkzeug.exceptions.HTTPException`&lt;/span&gt;
&lt;span class="sd"&gt;                  representing the HTTP error.&lt;/span&gt;

&lt;span class="sd"&gt;    :return: HTTP response to be returned&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;code&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;warning&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="s"&gt;&amp;quot;Got spurious argument to HTTP error handler: &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;FATAL_ERROR_RESPONSE&lt;/span&gt;

    &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HTTP error &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;, rendering error page&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;template&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ERRORS_DIR&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;.html&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;template&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;TemplateNotFound&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="c"&gt;# shouldn&amp;#39;t happen if the handler has been wired up properly&lt;/span&gt;
        &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;logger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fatal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Missing template for HTTP error page: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;template&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;FATAL_ERROR_RESPONSE&lt;/span&gt;

&lt;span class="c"&gt;#: Response emitted when an error occurs in the error handler itself.&lt;/span&gt;
&lt;span class="n"&gt;FATAL_ERROR_RESPONSE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Internal Server Error&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Catching &lt;code&gt;TemplateNotFound&lt;/code&gt; exception is admittedly a little paranoid here, as it can occur pretty much exclusively
due to a programming error elsewhere. Feel free to treat it as a failed assertion about application&amp;#8217;s internal state
and e.g. convert to &lt;code&gt;AssertionError&lt;/code&gt; if&amp;nbsp;desirable.&lt;/p&gt;
&lt;h4&gt;The&amp;nbsp;setup&lt;/h4&gt;
&lt;p&gt;The final step is to actually set up the&amp;nbsp;handler(s):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;get_supported_error_codes&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errorhandler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)(&lt;/span&gt;&lt;span class="n"&gt;error_handler&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It may look a bit wonky, but it&amp;#8217;s just a simple desugaring of the standard Python decorator syntax from the first example.
There exists a more direct approach of putting the handler inside &lt;code&gt;app.error_handler_spec&lt;/code&gt; dictionary,
but it is &lt;a href="http://flask.pocoo.org/docs/0.10/api/#flask.Flask.errorhandler"&gt;discouraged by Flask documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Where to put the above code, though? I posit it&amp;#8217;s perfectly fine to place in the module&amp;#8217;s global scope,
because the error handlers (and other request handlers) are traditionally defined at import time&amp;nbsp;anyway.&lt;/p&gt;
&lt;p&gt;Also notice that the default error handling we&amp;#8217;ve defined here doesn&amp;#8217;t preclude more specialized variants
for select &lt;span class="caps"&gt;HTTP&lt;/span&gt; codes. All you have to do is ensure that your custom &lt;code&gt;@app.errorhandler&lt;/code&gt; definition occurs
&lt;em&gt;after&lt;/em&gt; the above&amp;nbsp;loop.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Note that I&amp;#8217;m using the &lt;a href="https://docs.python.org/3/library/pathlib.html"&gt;&lt;em&gt;pathlib&lt;/em&gt; module&lt;/a&gt; here
&amp;#8212; and you should, too, since it&amp;#8217;s all around awesome. However, it is only a part of the standard library
since Python 3.4, so you will most likely need to get &lt;a href="https://pypi.python.org/pypi/pathlib/"&gt;the backport&lt;/a&gt; first.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Tue, 08 Sep 2015 23:47:00 -0700</pubDate><guid>tag:xion.io,2015-09-08:post/code/flask-auto-error-pages.html</guid><category>Flask</category><category>Python</category><category>HTTP</category><category>errors</category></item><item><title>Decorated functions in Go</title><link>http://xion.io/post/code/go-decorated-functions.html</link><description>&lt;p&gt;One of the downsides of working with a simple and minimalistic programming language such as &lt;a href="http://golang.org"&gt;Go&lt;/a&gt;
is that &lt;a href="http://blog.atte.ro/2015/08/29/golang-code-reuse.html"&gt;abstracting for code reuse&lt;/a&gt;
is often rather challenging. What&amp;#8217;s brought up most often in this context is Go&amp;#8217;s lack of support for generics
(higher order&amp;nbsp;types).&lt;/p&gt;
&lt;p&gt;But here I wanted to talk about a different mechanism that &amp;#8212; unlike generics &amp;#8212; can be transplanted to Go
quite successfully: function&amp;nbsp;decorators.&lt;/p&gt;
&lt;h4&gt;Canonical&amp;nbsp;example&lt;/h4&gt;
&lt;p&gt;Decorators are most commonly found in Python (where they can be applied not just to functions, but also classes),
but have syntactical analogues in Java (annotations), C# (attributes), and a few other&amp;nbsp;languages.&lt;/p&gt;
&lt;p&gt;A &lt;em&gt;decorator&lt;/em&gt; looks like a modifier adorning a function definition, distinguished by its initial &lt;code&gt;@&lt;/code&gt; sign:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nd"&gt;@app.route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;/home&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="nd"&gt;@login_required&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;home&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;user/home.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Even if you&amp;#8217;re not familiar with the &lt;a href="http://flask.pocoo.org"&gt;particular web framework&lt;/a&gt; this request handler is meant for
&amp;#8212; or indeed, the Python language itself &amp;#8212; it shouldn&amp;#8217;t be too difficult to figure out what purpose the two decorators&amp;nbsp;serve.&lt;/p&gt;
&lt;p&gt;What&amp;#8217;s really important is that their goals are neatly separated from essential logic of the request&amp;nbsp;handler:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it doesn&amp;#8217;t have to explicitly check if the user is logged in &amp;#8212; it has the &lt;code&gt;@login_required&lt;/code&gt; decorator&lt;/li&gt;
&lt;li&gt;it doesn&amp;#8217;t have to be separately registered in some
&lt;a href="https://docs.djangoproject.com/en/1.8/topics/http/urls/#example"&gt;centalized &lt;span class="caps"&gt;URL&lt;/span&gt; routing choke point&lt;/a&gt; &amp;#8212;
it has the &lt;code&gt;@app.route&lt;/code&gt; decorator&amp;nbsp;instead&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Such &lt;em&gt;separation of concerns&lt;/em&gt; is a desirable quality in software, because it makes it easier
to reason about different aspects of the&amp;nbsp;system.&lt;/p&gt;
&lt;h4&gt;Under the&amp;nbsp;hood&lt;/h4&gt;
&lt;p&gt;Behind this synctactic sugar and lofty phrasing, the code above is still perfectly equivalent
to its undecorated&amp;nbsp;version:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;home&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;current_user&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_authenticated&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;abort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;403&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Login Required&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;user/home.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_url_route&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;/home&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;view_func&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;No source code transformations take place, either: &lt;code&gt;@login_required&lt;/code&gt; doesn&amp;#8217;t actually &amp;#8220;inject&amp;#8221; the &lt;code&gt;if&lt;/code&gt; statement
at the beginning of &lt;code&gt;home&lt;/code&gt; function. What happens instead is that it takes the whole function and &lt;em&gt;wraps it&lt;/em&gt;
in a new one which also contains the crucial&amp;nbsp;check:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;login_required&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Grossly simplified version of a decorator enforcing user login.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;wrapped&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;current_user&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_authenticated&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;abort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;403&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Login Required&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;wrapped&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Given this definition, decorating &lt;code&gt;home&lt;/code&gt; simply means passing it to the &lt;code&gt;login_required&lt;/code&gt; function, and calling its result
a new &lt;code&gt;home&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;home&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;render_template&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;user/home.html&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;home&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;login_required&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;home&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As you&amp;#8217;ve probably guessed, the &lt;code&gt;@&lt;/code&gt; syntax is nothing else than a syntatic sugar for the above.
But how sweet a sugar it&amp;nbsp;is!&lt;/p&gt;
&lt;p&gt;&lt;small&gt;(The &lt;code&gt;@app.route&lt;/code&gt; decorator is simultaneously simpler and more complicated. I recommend having a direct look at
&lt;a href="https://github.com/mitsuhiko/flask/blob/2446ca63a8d840a35ea4eac02672b24a6fcf406f/flask/app.py#L1040"&gt;its source code&lt;/a&gt;
for more insight).&lt;/small&gt;&lt;/p&gt;
&lt;h4&gt;What gophers can&amp;nbsp;learn&lt;/h4&gt;
&lt;p&gt;Unlike Python, in Go, we are out of luck when it comes to dedicated language support for decorators.
However, the general principle still applies: we can decorate functions by writing &amp;#8212; &lt;em&gt;ahem&lt;/em&gt; &amp;#8212; decorator&amp;nbsp;functions.&lt;/p&gt;
&lt;p&gt;Consider, for example, a trivial &lt;code&gt;net/http&lt;/code&gt; request&amp;nbsp;handler:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;func&lt;/span&gt; &lt;span class="nx"&gt;hello&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;w&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;ResponseWriter&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;r&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;fmt&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Fprint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Hello, world!\n&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Any real web application will have many similar handlers. They are usually wired to their corresponding &lt;span class="caps"&gt;URL&lt;/span&gt; paths
during program&amp;nbsp;startup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;func&lt;/span&gt; &lt;span class="nx"&gt;main&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/hello&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;hello&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This approach to routing configuration provides an opportunity to decorate some (or all) of the request handlers with
any auxiliary functionality that the application may&amp;nbsp;require.&lt;/p&gt;
&lt;h4&gt;Handler in, handler&amp;nbsp;out&lt;/h4&gt;
&lt;p&gt;To do that, though, we need to write the necessary decorator functions first. For a simplest possible example,
let&amp;#8217;s create one that automatically fills in the &lt;code&gt;Server:&lt;/code&gt; header of &lt;span class="caps"&gt;HTTP&lt;/span&gt; response with the name and version
of our web&amp;nbsp;application:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;func&lt;/span&gt; &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;h&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandlerFunc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandlerFunc&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kd"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;w&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;ResponseWriter&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;r&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;w&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;().&lt;/span&gt;&lt;span class="nx"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Server&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;HelloServer v0.0.1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nx"&gt;h&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;r&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Using it is then a simple matter of wrapping the original handler in a decorator&amp;nbsp;call:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/hello&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;hello&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As it both accepts and returns a &lt;code&gt;http.HandlerFunc&lt;/code&gt; &amp;#8212; a function type matching request handlers&amp;#8217; signatures &amp;#8212;
we don&amp;#8217;t need anything else to be able to wrap our handlers in as many decorators as&amp;nbsp;necessary:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;index&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/home&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;LoginRequired&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;home&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/api/share&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;LoginRequired&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;CsrfProtected&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;api&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Share&lt;/span&gt;&lt;span class="p"&gt;))))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It&amp;#8217;s possible simply by the means of ordinary function&amp;nbsp;composition.&lt;/p&gt;
&lt;h4&gt;Going&amp;nbsp;meta&lt;/h4&gt;
&lt;p&gt;Looking at the last line of the example above &amp;#8212; which is made-up but could very well come from actual production code
&amp;#8212; you probably can&amp;#8217;t help but notice that stacking function calls like that creates a somewhat messy amalgamation
of parentheses. Beyond three or four items, a decorator chain such as this one becomes rather unwieldy to&amp;nbsp;follow.&lt;/p&gt;
&lt;p&gt;If we&amp;#8217;re concerned about readability, it&amp;#8217;s possible to alleviate the issue by taking another step up
the abstraction ladder. Rather than composing the decorators explicitly, we can write a function that does it for&amp;nbsp;us:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;type&lt;/span&gt; &lt;span class="nx"&gt;HttpHandlerDecorator&lt;/span&gt; &lt;span class="kd"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandlerFunc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandlerFunc&lt;/span&gt;

&lt;span class="kd"&gt;func&lt;/span&gt; &lt;span class="nx"&gt;Handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;h&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandlerFunc&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;decors&lt;/span&gt; &lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="nx"&gt;HttpHandlerDecorator&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandlerFunc&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="nx"&gt;i&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="k"&gt;range&lt;/span&gt; &lt;span class="nx"&gt;decors&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;d&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="nx"&gt;decors&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;decors&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="nx"&gt;i&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;  &lt;span class="c1"&gt;// iterate in reverse&lt;/span&gt;
        &lt;span class="nx"&gt;h&lt;/span&gt; &lt;span class="p"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;d&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;h&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nx"&gt;h&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and thus eliminate all the&amp;nbsp;parentheses:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/api/share&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;Handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;api&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Share&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;LoginRequired&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;CsrfProtected&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This technique proves especially valuable if the decorators themselves are&amp;nbsp;parameterized:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nx"&gt;http&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;HandleFunc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/api/notifications&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;Handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;api&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Notifications&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="nx"&gt;WithServerHeader&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;LoginRequired&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;Cached&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;time&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Duration&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="nx"&gt;time&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;Minute&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In practice, you may find it valuable to wrap the complete &lt;code&gt;http.HandleFunc&lt;/code&gt; call to accept a request handler
along with its decorator chain, or the equivalent of such a call in any of the numerous
&lt;a href="https://corner.squareup.com/2014/05/evaluating-go-frameworks.html"&gt;Go web frameworks&lt;/a&gt;.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Sat, 05 Sep 2015 08:36:00 -0700</pubDate><guid>tag:xion.io,2015-09-04:post/code/go-decorated-functions.html</guid><category>Go</category><category>functions</category><category>decorators</category></item><item><title>Interruptible fade-out of DOM elements</title><link>http://xion.io/post/code/html-interruptive-fadeout.html</link><description>&lt;p&gt;Here&amp;#8217;s a nice animated effect you may have seen in some applications, quite often games.
An ephemeral &lt;span class="caps"&gt;UI&lt;/span&gt; element is displayed, either in a corner or pretty prominently, and after a short while
it slowly fades out to transparency over several&amp;nbsp;seconds:&lt;/p&gt;
&lt;p style="text-align: center"&gt;
    &lt;img src="http://xion.io/images/paragon-222.jpg" alt='"Ding" with full opacity'&gt;
    &lt;br&gt;
    &lt;img src="http://xion.io/images/paragon-222-faded.jpg" alt ='"Ding" after fading out'&gt;
&lt;/p&gt;

&lt;p&gt;If you hover your mouse over it, though, it turns opaque right away and stays like that
until you move away with the cursor. It then tries to disappear again, lest you stop it once more
and restore to full opacity &amp;#8212; and so on. Leave it for a moment, though, and it eventually&amp;nbsp;vanishes.&lt;/p&gt;
&lt;p&gt;Cool, eh? Wouldn&amp;#8217;t it be nice to have a similar mechanism for, say, notifications displayed within a web app?
Sure it would be! And it doesn&amp;#8217;t even seem all that complicated, so let&amp;#8217;s give it a&amp;nbsp;try.&lt;/p&gt;
&lt;h4&gt;A promising &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;Before delving into implementation details, it&amp;#8217;s a good practice think for a moment about an &lt;span class="caps"&gt;API&lt;/span&gt;
that we&amp;#8217;ll expose to the user. Since it looks like a relatively simple problem, we don&amp;#8217;t need no classes or frameworks.
All that&amp;#8217;s necessary is a simple&amp;nbsp;function:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;interruptibleFadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Surely, however, whoever calls it would like to be able to tell when the animation finishes (e.g. to remove the &lt;code&gt;element&lt;/code&gt;
they&amp;#8217;ve passed from the &lt;span class="caps"&gt;DOM&lt;/span&gt; tree). Simply waiting a predefined number of seconds is not sufficient, because
&amp;#8212; as described above &amp;#8212; the effect could be restarted arbitrary many times through mouse&amp;nbsp;interaction.&lt;/p&gt;
&lt;p&gt;We could pass a callback, of course, but the modern JavaScript way of dealing with asynchronicity and concurrency
is through &lt;a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"&gt;&lt;em&gt;promises&lt;/em&gt;&lt;/a&gt;.
Following this pattern, our function shall return a promise that &lt;em&gt;resolves&lt;/em&gt; when the effect ends.
Disregarding the possible user interaction for now, a minimal implementation of the fade-out alone would simply use
the &lt;a href="http://api.jquery.com/fadeout/"&gt;&lt;code&gt;jQuery.fadeOut&lt;/code&gt; method&lt;/a&gt; and look something like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;function&lt;/span&gt; &lt;span class="nx"&gt;interruptibleFadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;typeof&lt;/span&gt; &lt;span class="nx"&gt;options&lt;/span&gt; &lt;span class="o"&gt;===&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;number&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;options&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;};&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;

    &lt;span class="nx"&gt;element&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;Promise&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The constructor of &lt;code&gt;Promise&lt;/code&gt; is admittedly a little weird, as it employs a level of abstraction and indirection
that is indicative of (more) functional programming languages. You pass it a function that&amp;#8217;s invoked &lt;em&gt;immediately&lt;/em&gt;
with an argument that itself is a function. (Actually two arguments, but we ignore the other one here).
That input function, &lt;code&gt;resolve&lt;/code&gt;, should be called whenever the new promise &amp;#8220;completes&amp;#8221;, in whatever sense
it&amp;#8217;s appropriate for the particular use&amp;nbsp;case.&lt;/p&gt;
&lt;p&gt;Here, we&amp;#8217;re resolving the promise when our animation ends. This enables callers to react to this
in a very straightforward&amp;nbsp;way:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;elem&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;#foo&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="nx"&gt;interruptibleFadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;elem&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;400&lt;/span&gt; &lt;span class="cm"&gt;/* ms */&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;elem&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As a small aside, the &lt;code&gt;Promise&lt;/code&gt; class is a ECMAScript 6 feature, which means it may not be available in all the browsers.
The open-source &lt;a href="https://github.com/kriskowal/q"&gt;&lt;em&gt;Q&lt;/em&gt; library&lt;/a&gt; is often used as a compatibility shim,
among many other libraries implementing the &lt;a href="https://promisesaplus.com/"&gt;Promises/A+ recommendation&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;Interaction&amp;nbsp;handling&lt;/h4&gt;
&lt;p&gt;There&amp;#8217;s little value in just wrapping an existing jQuery method, so let&amp;#8217;s make it more interesting through mouse events.
We want hovering on the element to pause the animation, while moving the cursor away should resume&amp;nbsp;it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;Promise&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;mouseenter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;  &lt;span class="c1"&gt;// true == discard remaining animation stages&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;css&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;opacity&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;1.0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;mouseleave&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;

    &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;That will &lt;em&gt;mostly&lt;/em&gt; work even with the above code, but there are several problems that need to be addressed&amp;nbsp;immediately:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;mouseenter&lt;/code&gt; and &lt;code&gt;mouseleave&lt;/code&gt; event handlers are should only fire while the fade-out effect is being played.
  Currently, they &amp;#8220;leak&amp;#8221;, and remain bound even after it finishes, interfering with given &lt;span class="caps"&gt;DOM&lt;/span&gt; element
  for as long as it&amp;nbsp;exists.&lt;/li&gt;
&lt;li&gt;The whole concept of &lt;em&gt;hovering&lt;/em&gt; is contingent upon the user having a pointing device. In today&amp;#8217;s mobile world,
  this excludes a significant fraction of clients. We need an alternative interaction pattern for touchscreen devices,
  and one possible option is restart the effect on&amp;nbsp;click/tap.&lt;/li&gt;
&lt;li&gt;There is a fair amount of repetition here, and it will only get worse once the previous problems are dealt&amp;nbsp;with.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Cleaning&amp;nbsp;up&lt;/h4&gt;
&lt;p&gt;A correct (and cleaner) version is quite a bit longer, but shouldn&amp;#8217;t be too hard to&amp;nbsp;follow:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;new&lt;/span&gt; &lt;span class="nx"&gt;Promise&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="c1"&gt;// Event handlers used by the effect.&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;events&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;mouseenter&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;interruptAnimation&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt;
        &lt;span class="nx"&gt;mouseleave&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;delayedFadeOut&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt;
        &lt;span class="nx"&gt;click&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;interruptAnimation&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
            &lt;span class="nx"&gt;delayedFadeOut&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="p"&gt;};&lt;/span&gt;
    &lt;span class="nb"&gt;Object&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;keys&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;events&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;forEach&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;events&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nx"&gt;name&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
    &lt;span class="p"&gt;});&lt;/span&gt;

    &lt;span class="c1"&gt;// Helper functions.&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;interruptAnimation&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;css&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;opacity&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;1.0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;};&lt;/span&gt;
    &lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;delayedFadeOut&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="nb"&gt;Object&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;keys&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;events&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;forEach&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
                &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;off&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;events&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nx"&gt;name&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
            &lt;span class="p"&gt;});&lt;/span&gt;
            &lt;span class="nx"&gt;resolve&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
        &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="p"&gt;};&lt;/span&gt;

    &lt;span class="c1"&gt;// Start the animation.&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeIn&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeIn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;fadeIn&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="nx"&gt;delayedFadeOut&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The main part is of course the &lt;code&gt;delayedFadeOut&lt;/code&gt; function. It is invoked right at the beginning, as well as whenever
the animation has to be started&amp;nbsp;again.&lt;/p&gt;
&lt;p&gt;We also put the event handlers in a &amp;#8220;map&amp;#8221; (JavaScript object). This makes it easy to initially bind them to the element, and &amp;#8212; more importantly &amp;#8212; unbind them when the effect&amp;nbsp;ends.&lt;/p&gt;
&lt;p&gt;As a final touch, we also allow the caller to specify how long the element should remain at its full opacity
before it starts to fade out (&lt;code&gt;delay&lt;/code&gt;), and to optionally add a &lt;code&gt;fadeIn&lt;/code&gt; stage at the very beginning to make everything
look a little nicer. (I recommend no more than 300-400ms for that part,&amp;nbsp;though).&lt;/p&gt;
&lt;h4&gt;Practical&amp;nbsp;example&lt;/h4&gt;
&lt;p&gt;A complete code sample for the &lt;code&gt;interruptibleFadeOut&lt;/code&gt; function can be seen in
&lt;a href="https://gist.github.com/Xion/0a9da59c44d5c9664a2c"&gt;this gist&lt;/a&gt;. To use it in practice, you&amp;#8217;d most likely need
at least a little bit of &lt;span class="caps"&gt;CSS&lt;/span&gt; and additional JavaScript to position the element&amp;nbsp;appropriately:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;toast&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Hello, world!&lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;!----&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nf"&gt;#toast&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="k"&gt;position&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="k"&gt;fixed&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;display&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="k"&gt;none&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

    &lt;span class="c"&gt;/* These are arbitrary */&lt;/span&gt;
    &lt;span class="k"&gt;top&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="m"&gt;100px&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;width&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="m"&gt;80%&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="k"&gt;height&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="m"&gt;50px&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;!----&gt;

&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kd"&gt;var&lt;/span&gt; &lt;span class="nx"&gt;toast&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;#toast&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="nx"&gt;toast&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;offset&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;
    &lt;span class="nx"&gt;left&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;Math&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;round&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;$&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;window&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;width&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;outerWidth&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;span class="p"&gt;});&lt;/span&gt;
&lt;span class="nx"&gt;toast&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;show&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;
&lt;span class="nx"&gt;interruptibleFadeOut&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;toast&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;fadeIn&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;delay&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nx"&gt;fadeOut&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;3000&lt;/span&gt; &lt;span class="p"&gt;})&lt;/span&gt;
    &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;then&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nx"&gt;toast&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="p"&gt;});&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Styling it to look like a level-up ding is left as an exercise for the reader&amp;nbsp;:)&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Sun, 30 Aug 2015 21:13:00 -0700</pubDate><guid>tag:xion.io,2015-08-30:post/code/html-interruptive-fadeout.html</guid><category>HTML</category><category>JavaScript</category><category>DOM</category><category>jQuery</category><category>animation</category><category>promises</category></item><item><title>Querying multiple scalar values in SQLAlchemy</title><link>http://xion.io/post/code/sqlalchemy-query-values.html</link><description>&lt;p&gt;&lt;a href="http://www.sqlalchemy.org/"&gt;SQLAlchemy&lt;/a&gt; is probably the greatest
&lt;a href="https://en.wikipedia.org/wiki/Object-relational_mapping"&gt;&lt;span class="caps"&gt;ORM&lt;/span&gt;&lt;/a&gt; library ever invented &amp;#8212; and not just for Python.
Like everything, though, it could sometimes use an&amp;nbsp;improvement.&lt;/p&gt;
&lt;p&gt;One typical pattern that I&amp;#8217;ve seen repeated many times is querying for values of a single column from multiple rows.
Almost always, the desired outcome is to have those values in a Python iterable. Unfortunately, when returning multiple
rows, the &lt;code&gt;Query&lt;/code&gt; class can only give them out as tuples, making it necessary to unpack them explicitly every&amp;nbsp;time:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;active_users_ids&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="n"&gt;uid&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uid&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_active&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It&amp;#8217;s worth noting that a very similar operation &amp;#8212; retrieving a single column value from &lt;em&gt;one&lt;/em&gt; row &amp;#8212;
is comparatively cleaner thanks to a
&lt;a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/query.html#sqlalchemy.orm.query.Query.scalar"&gt;dedicated &lt;code&gt;Query.scalar&lt;/code&gt;&lt;/a&gt;
method. So why not have a similar one for the use case&amp;nbsp;above?&amp;#8230;&lt;/p&gt;
&lt;p&gt;Turns out that SQLAlchemy is so amazingly extensible that we can easily outfit &lt;code&gt;Query&lt;/code&gt; with such a method&amp;nbsp;ourselves.&lt;/p&gt;
&lt;h4&gt;Our own &lt;code&gt;Query&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;The officially ordained way to do something like that is to extend the original &lt;code&gt;sqlalchemy.orm.query.Query&lt;/code&gt; class
with any additional functionality we require. We can then introduce a method in the subclass &amp;#8212; let&amp;#8217;s call it &lt;code&gt;values&lt;/code&gt; &amp;#8212;
that implements our&amp;nbsp;logic:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.orm.exc&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;MultipleResultsFound&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy.orm.query&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Query&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;_Query&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_Query&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Custom SQLAlchemy query class.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;values&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Return an iterable of all scalar, singleton element values&lt;/span&gt;
&lt;span class="sd"&gt;        from rows matched by this query.&lt;/span&gt;

&lt;span class="sd"&gt;        :raise MultipleValuesFound: If result rows have more than one element&lt;/span&gt;
&lt;span class="sd"&gt;        &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;()]&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;ValueError&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;MultipleValuesFound&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MultipleValuesFound&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;ValueError&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;MultipleResultsFound&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Exception raised by :meth:`Query.values`&lt;/span&gt;
&lt;span class="sd"&gt;    when multiple values were found in a single result row.&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;There is a special erroneous condition that occurrs when the &lt;code&gt;Query&lt;/code&gt; returns rows with more than one column value.
It would be possible to detect it preemptively by inspecting certain attributes of the query object,
but it&amp;#8217;s simpler to just catch the exception caused by unsuccessful tuple&amp;nbsp;unpacking.&lt;/p&gt;
&lt;p&gt;In any case, I recommend re-raising it as a custom exception to enable more robust error handling in the client&amp;nbsp;code.&lt;/p&gt;
&lt;h4&gt;Wiring&amp;nbsp;it&lt;/h4&gt;
&lt;p&gt;The last piece of the puzzle is to make &lt;code&gt;Session&lt;/code&gt; objects in our application use the new &lt;code&gt;Query&lt;/code&gt; class.
It&amp;#8217;s easy: we simply pass it as &lt;code&gt;query_cls&lt;/code&gt; parameter to the &lt;code&gt;Session&lt;/code&gt; constructor. In more realistic scenarios &amp;#8212;
such as web applications with per-request database sessions &amp;#8212; it means giving it directly to the &lt;code&gt;sessionmaker&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;create_engine&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;scoped_session&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sessionmaker&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;myapp.ext.sqlalchemy&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Query&lt;/span&gt;


&lt;span class="n"&gt;session&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;scoped_session&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sessionmaker&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bind&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;create_engine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;DATABASE_URL&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                      &lt;span class="n"&gt;query_cls&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Query&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Of course, &lt;a href="http://docs.sqlalchemy.org/en/latest/orm/contextual.html"&gt;actual session setup&lt;/a&gt; in your app
may differ in few details from the sample&amp;nbsp;above.&lt;/p&gt;
&lt;h4&gt;Usage&amp;nbsp;example&lt;/h4&gt;
&lt;p&gt;With the new &lt;code&gt;Query&lt;/code&gt; class wired in, the &lt;code&gt;values&lt;/code&gt; method becomes immediately&amp;nbsp;usable:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;active_user_ids&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;session&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;User&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_active&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and the ugly manual unpacking of row tuples is no longer&amp;nbsp;necessary.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Wed, 26 Aug 2015 21:06:00 -0700</pubDate><guid>tag:xion.io,2015-08-26:post/code/sqlalchemy-query-values.html</guid><category>SQLAlchemy</category><category>Python</category></item><item><title>Custom errors in Jinja templates</title><link>http://xion.io/post/code/jinja-custom-errors.html</link><description>&lt;p&gt;&lt;a href="http://jinja.pocoo.org"&gt;Jinja&lt;/a&gt; is a pretty great templating engine for Python.
Unlike the likes of &lt;a href="https://mustache.github.io/"&gt;Mustache&lt;/a&gt; or &lt;a href="http://handlebarsjs.com/"&gt;Handlebars&lt;/a&gt;,
it doesn&amp;#8217;t try to constrain overmuch the kind of logic that the programmer can put in their templates.
Most Python expressions, for example, are supported, as are variables and functions (or &lt;em&gt;macros&lt;/em&gt; in Jinja&amp;#8217;s&amp;nbsp;parlance).&lt;/p&gt;
&lt;p&gt;One conspicously absent feature is throwing exceptions directly from template code.
(It&amp;#8217;s obviously possible from custom filters or tags). If we had it, we could add some more robust error checking
to the template input values or macro&amp;nbsp;paramaters.&lt;/p&gt;
&lt;h4&gt;Example&lt;/h4&gt;
&lt;p&gt;Let&amp;#8217;s say you have extracted a &lt;code&gt;{% macro %}&lt;/code&gt; for rendering a button,
like &lt;a href="http://getbootstrap.com/css/#buttons"&gt;the one from Twitter Bootstrap&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;macro&lt;/span&gt; &lt;span class="nv"&gt;button&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;text&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kp"&gt;none&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;style&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;default&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;button&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &amp;lt;button class=&amp;quot;btn btn-&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;style&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot; type=&amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&amp;gt;&lt;/span&gt;
&lt;span class="x"&gt;    &lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nv"&gt;text&lt;/span&gt; &lt;span class="k"&gt;is&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="nf"&gt;none&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;      &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;text&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;    &lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;      &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;caller&lt;/span&gt;&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;    &lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endif&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &amp;lt;/button&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endmacro&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The benefit of this conditional definition is the relative ease of creating buttons with either just a text&amp;nbsp;label:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;button&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Load More...&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;or some more complicated&amp;nbsp;markup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;call&lt;/span&gt; &lt;span class="nv"&gt;button&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;style&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;success&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;submit&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &amp;lt;i class=&amp;quot;fa fa-check&amp;quot;&amp;gt;&amp;lt;/i&amp;gt;Finish&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endcall&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Supplying &lt;em&gt;both&lt;/em&gt;, however, is an ambiguity that the macro currently &amp;#8220;resolves&amp;#8221; by preferring text
over a &lt;code&gt;{% call %}&lt;/code&gt; block. It should rather be an error&amp;nbsp;instead:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nv"&gt;caller&lt;/span&gt; &lt;span class="k"&gt;and&lt;/span&gt; &lt;span class="nv"&gt;caller&lt;/span&gt; &lt;span class="k"&gt;is&lt;/span&gt; &lt;span class="nf"&gt;defined&lt;/span&gt; &lt;span class="k"&gt;and&lt;/span&gt; &lt;span class="nv"&gt;text&lt;/span&gt; &lt;span class="k"&gt;is&lt;/span&gt; &lt;span class="k"&gt;not&lt;/span&gt; &lt;span class="nf"&gt;none&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;  &lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;error&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Cannot supply text= parameter to button() when invoking it through {% call %}&amp;quot;&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endif&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But &lt;code&gt;{% error %}&lt;/code&gt; isn&amp;#8217;t a tag that Jinja supports by default. To make it available,
we need to implement the logic&amp;nbsp;ourselves.&lt;/p&gt;
&lt;h4&gt;Adding new Jinja&amp;nbsp;tags&lt;/h4&gt;
&lt;p&gt;Don&amp;#8217;t sweat, though! It won&amp;#8217;t be necessary to fork Jinja itself and modify its core code.
Custom tags may just as well be added with &lt;em&gt;extensions&lt;/em&gt;,
which is a &lt;a href="jinja.pocoo.org/docs/extensions/#writing-extensions"&gt;dedicated Jinja mechanism&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;An extension is just a Python class that declares &lt;code&gt;tags&lt;/code&gt; it intends to support and implements a &lt;code&gt;parse&lt;/code&gt; method:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jinja2.ext&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Extension&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ErrorExtension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Extension&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;tags&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;frozenset&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;error&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What can be a little tricky is that &lt;code&gt;parse&lt;/code&gt; method itself shouldn&amp;#8217;t take any &lt;em&gt;direct&lt;/em&gt; action. Instead, it shall return
a piece of &lt;span class="caps"&gt;AST&lt;/span&gt; &amp;#8212; &lt;a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree"&gt;abstract syntax tree&lt;/a&gt; &amp;#8212; that Jinja will include
in the compiled template. All regular Jinja features are thus available, but the power of extensions doesn&amp;#8217;t end&amp;nbsp;here.&lt;/p&gt;
&lt;h4&gt;Handling the {% error %}&amp;nbsp;tag&lt;/h4&gt;
&lt;p&gt;The argument to &lt;code&gt;parse&lt;/code&gt; is a parser object, which we can use to extract tokens from the template source code.
The &lt;code&gt;error&lt;/code&gt; tag identifier is one such token, and the string following it is another. As it turns out,
we are only tenuously interested in the former, but we definitely want to pick the latter, because it&amp;#8217;s the error message
we&amp;#8217;ll raise an exception&amp;nbsp;with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;tag&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;next&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parse_expression&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As it was mentioned previously, the &lt;code&gt;parse&lt;/code&gt; method itself won&amp;#8217;t be raising this exception immediately. If we did that,
no template with the &lt;code&gt;{% error %}&lt;/code&gt; tag would ever parse successfully! What we need instead is an &lt;span class="caps"&gt;AST&lt;/span&gt; node
that throws the exception when it&amp;#8217;s &lt;em&gt;evaluated&lt;/em&gt;. This way, it will be deferred until the template
is being rendered and its execution point reaches the &lt;code&gt;{% error "..." %}&lt;/code&gt; stanza.&lt;/p&gt;
&lt;p&gt;Jinja already has a correct node type handy: it&amp;#8217;s named &lt;code&gt;CallBlock&lt;/code&gt;,
and it represents a statement that &lt;code&gt;{% call %}&lt;/code&gt;s given method of the &lt;code&gt;Extension&lt;/code&gt; class:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jinja2.nodes&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;CallBlock&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Const&lt;/span&gt;

&lt;span class="c"&gt;# (in ErrorExtension.parse)&lt;/span&gt;
&lt;span class="n"&gt;node&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;CallBlock&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;call_method&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_exec_error&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Const&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;lineno&lt;/span&gt;&lt;span class="p"&gt;)]),&lt;/span&gt;
    &lt;span class="p"&gt;[],&lt;/span&gt; &lt;span class="p"&gt;[],&lt;/span&gt; &lt;span class="p"&gt;[])&lt;/span&gt;
&lt;span class="n"&gt;node&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_lineno&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;lineno&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;node&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This method, &lt;code&gt;_exec_error&lt;/code&gt;, should do the crux of what this extension is about: raise an exception.
Let&amp;#8217;s define a distinct error class for it, to tell user errors apart from those thrown by Jinja&amp;nbsp;itself:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jinja2&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;TemplateAssertionError&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ErrorExtension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Extension&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c"&gt;# ...&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_exec_error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;lineno&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;caller&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;TemplateUserError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;lineno&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TemplateUserError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;TemplateAssertionError&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;Using the&amp;nbsp;extension&lt;/h4&gt;
&lt;p&gt;The last step is to tell Jinja to use our extension when compiling and rendering templates.
For that, we simply add it to the &lt;code&gt;Environment&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;jinja_env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_extension&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ErrorExtension&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If you are using the &lt;a href="http://flask.pocoo.org/"&gt;Flask&lt;/a&gt; framework,
&lt;code&gt;jinja_env&lt;/code&gt; is an attribute on the &lt;code&gt;Flask&lt;/code&gt; application&amp;nbsp;object.&lt;/p&gt;
&lt;p&gt;To see the complete code sample for &lt;code&gt;ErrorExtension&lt;/code&gt;,
have a look at &lt;a href="https://gist.github.com/Xion/47c85671cdfb481fd925"&gt;this gist&lt;/a&gt;.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Karol Kuczmarski</dc:creator><pubDate>Sun, 23 Aug 2015 09:33:00 -0700</pubDate><guid>tag:xion.io,2015-08-23:post/code/jinja-custom-errors.html</guid><category>Jinja</category><category>templates</category><category>Python</category><category>errors</category></item></channel></rss>