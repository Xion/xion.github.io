<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog &ndash; Tag: testing</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/programming/gisht-recap.html#gisht-recap">Recap of the gisht&nbsp;project</a></h2>
    <p>
      Posted on Fri 24 November 2017 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/gisht.html">gisht</a>,      <a href="http://xion.io/tag/cli.html">CLI</a>,      <a href="http://xion.io/tag/github.html">GitHub</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/testing.html">testing</a>      &#8226; <a href="http://xion.io/post/programming/gisht-recap.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In this post, I want to discuss some of the experiences I had with a project
that I recently finished, <a href="https://github.com/Xion/gisht"><em>gisht</em></a>.
By &#8220;finished&#8221; I mean that I don&#8217;t anticipate developing any new major features for it,
though smaller things, bug fixes, or non-code stuff, is of course still very&nbsp;possible.</p>
<p>I&#8217;m thinking this is as much &#8220;done&#8221; as most software projects can ever hope to be.
Thus, it is probably the best time for a recap / summary / postmortem / etc. &#8212;
something to recount the lessons learned, and assess the choices&nbsp;made.</p>
<h4>Some&nbsp;context</h4>
<p>The original purpose of <em>gisht</em> was to facilitate download <span class="amp">&amp;</span> execution of GitHub gists
straight from the command&nbsp;line:</p>
<div class="highlight"><pre><span class="nv">$ </span>gisht Xion/git-outgoing  <span class="c"># run the https://gist.github.com/Xion/git-outgoing gist</span>
</pre></div>


<p>I initially wrote <a href="https://github.com/Xion/gisht.py">its first version in Python</a>
because I&#8217;ve accumulated a sizable number of small <span class="amp">&amp;</span> useful scripts
(for Git, Unix, Python, etc.) which were all posted as gists.
Sure, I could download them manually to <code>~/bin</code> every time I used a new machine
but that&#8217;s rather cumbersome, and I&#8217;m quite&nbsp;lazy.</p>
<p>Well, lazy <em>and</em> impatient :)
I noticed pretty fast that the speed tax of Python
is basically unacceptable for a program like <em>gisht</em>.</p>
<p>What I&#8217;m referring to here is not the speed of code execution, however,
but only the <em>startup time</em> of Python interpreter.
Irrespective of the machine, operating system, or language version,
it doesn&#8217;t seem to go lower than about one hundred milliseconds;
empirically, it&#8217;s often 2 or 3 times higher than that.
For the common case of finding a cached gist (no downloads)
and doing a simple <code>fork</code>+<code>exec</code>,
this startup time was very noticeable and extremely jarring.
It also precluded some more sophisticated uses for <em>gisht</em>,
like putting its invocation into the shell&#8217;s <code>$PROMPT</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>Speed:&nbsp;delivered</h4>
<p>And so the obvious solution emerged:
let&#8217;s <a href="https://transitiontech.ca/random/RIIR">rewrite it in Rust</a>!&#8230;</p>
<p>Because if I&#8217;m executing code straight from the internet,
I should at least do it in a <em>safe</em>&nbsp;language.</p>
<p>But jokes aside, it is obvious that a language compiling to native code
is likely a good pick if you want to optimize for startup speed.
So while the choice of Rust was in large part educational
(<em>gisht</em> was one of my first projects to be written in it),
it definitely hasn&#8217;t disappointed&nbsp;there.</p>
<p>Even without any intentional optimization efforts,
the app still runs <em>instantaneously</em>.
I tried to take some measurements using the <code>time</code> command,
but it never ticked into more than 0.001s.
Perceptively, it is at least on par with <code>git</code>,
so that&#8217;s acceptable for me&nbsp;:)</p>
<h4>Can&#8217;t segfault if your code doesn&#8217;t&nbsp;build</h4>
<p>Achieving the performance objective wouldn&#8217;t do us much good, however,
if the road to get there involved excessive penalties on productivity.
Such negative impact could manifest in many ways,
including troublesome debugging due to a tricky runtime<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>,
or difficulty in getting the code to compile in the first&nbsp;place.</p>
<p>If you had even a passing contact with Rust,
you&#8217;d expect the latter to be much more likely than the&nbsp;former.</p>
<p>Indeed, Rust&#8217;s very design eschews runtime flexibility to a ridiculous degree
(in its &#8220;safe&#8221; mode, at least),
while also forcing you to absorb subtle <span class="amp">&amp;</span> complex ideas
to even get your code past the compiler.
The reward is increased likelihood your program will behave as intended &#8212;
although it&#8217;s definitely not on the level of &#8220;if it compiles, it works&#8221;
that can be offered by Haskell or&nbsp;Idris.</p>
<p>But since <em>gisht</em> is hardly mission critical,
I didn&#8217;t actually care too much about this increased reliability.
I don&#8217;t think it&#8217;s likely that Rust would buy me much over something like modern C++.
And if I were to <em>really</em> do some kind of cost-benefit analysis of several languages
&#8212; rather than going with Rust simply to learn it better &#8212;
then it would be hard to justify it over something like&nbsp;Go.</p>
<h4>It&nbsp;scales</h4>
<p>So the real question is: has Rust <em>not hampered</em> my productivity too much?
Having the benefit of hindsight,
I&#8217;m happy to say that the trade-off was definitely acceptable&nbsp;:)</p>
<p>One thing I was particularly satisfied with was the language&#8217;s <em>scalability</em>.
What I mean here is the ability to adapt as the project grows,
but also to start quickly and remain nimble
while the codebase is still pretty&nbsp;small.</p>
<p>Many languages (most, perhaps) are naturally tailored towards the large end,
doing their best to make it more bearable to work with big codebases.
In turn, they often forget about helping projects take off in the first place.
Between complicated build systems and dependency managers (Java),
or a virtual lack of either (C++),
it can be really hard to get going in a &#8220;serious&#8221; language like&nbsp;this.</p>
<p>On the other hand, languages like Python make it very easy to start up
and achieve relatively impressive results.
Some people, however, report having encountered problems
once the code evolves past certain size.
While I&#8217;m actually
<a href="http://xion.io/post/programming/long-live-dynamic-languages.html">very unsympathetic</a> to those claims,
I realize perception plays a significant role here,
making those anecdotal experiences into a sort of self-fulfilling&nbsp;prophecy.</p>
<p>This perception problem should almost certainly spare Rust,
as it&#8217;s a natively compiled and statically typed language,
with a respectable type system to boot.
There is also <a href="https://servo.org/">some evidence</a>
that the language works well in large projects already.
So the only question that we might want to ask is:
how easy it is to actually <em>start</em> a project in Rust,
and carry it towards some kind of <abbr title="Minimum Viable Product"><span class="caps">MVP</span></abbr>?</p>
<p>Based on my experiences with <em>gisht</em>,
I can say that it is, in fact, quite easy.
Thanks mostly to the impressive Swiss army knife of <code>cargo</code>
&#8212; acting as both package manager and a rudimentary build system &#8212;
it was almost Python-trivial to cook a &#8220;Hello World&#8221; program
that does something tangible, like
<a href="https://github.com/Xion/gisht/blob/de1be876784d671dd84618c3a15d0836f9fd5697/src/main.rs">talk to a <span class="caps">JSON</span> <span class="caps">API</span></a>.
From there, it only took a few coding sessions to grow it
into a <a href="https://github.com/Xion/gisht/tree/5c156cb">functioning prototype</a>.</p>
<h4>Abstractions&nbsp;galore</h4>
<p>As part of rewriting <em>gisht</em> from Python to Rust,
I also wanted to fix some longstanding issues that limited its&nbsp;capabilities.</p>
<p>The most important one was the hopeless coupling to GitHub
and their particular flavor of gists.
Sure, this is where the project even got its name from,
but people use a dozen of different services to share code snippets
and it should very possible to support them&nbsp;all.</p>
<p>Here&#8217;s where it became necessary to utilize
the abstraction capabilities that Rust has to offer.
It was somewhat obvious to
<a href="https://github.com/Xion/gisht/blob/3fc443dc9986612fd46b4311ca2ecbc613a15cf9/src/gist.rs#L16">define a <code>Host</code> trait</a>
but of course its exact form had to be
<a href="https://github.com/Xion/gisht/commit/26746dfc2eac68b67753f71148eb9897a861914e#diff-9d0a9c0911fa012f0fcf8ca56b43f8c5">shaped</a>
over <a href="https://github.com/Xion/gisht/commit/1e54ad05480b42089977171f10d4727beca5f835#diff-9d0a9c0911fa012f0fcf8ca56b43f8c5">numerous iterations</a>.
Along the way, it even turned out that <code>Result&lt;Option&lt;T&gt;&gt;</code> and <code>Option&lt;Result&lt;T&gt;&gt;</code>
are sometimes <a href="https://github.com/Xion/gisht/blob/d9c30e69d58b2a4e5608e6c8a1aa6392133b490f/src/hosts/mod.rs#L44">both necessary</a>
as return types&nbsp;:)</p>
<p>Besides cleaner architecture,
another neat thing about an explicit abstraction is
the ability to slice a concept into smaller pieces &#8212;
and then put <em>some of them</em> back together.
While the <code>Host</code> trait could support a very diverse set of gist services and <em>pastebins</em>,
many of them turned out to be just a slight variation of one central theme.
Because of this similarity, it was possible to introduce
a single <a href="https://github.com/Xion/gisht/blob/d2e78b1f5ee4616b1d5eb7067c3c5dd0ce9e2fe4/src/hosts/simple.rs#L26"><code>Basic</code> implementation</a>
which handles multiple services through varying sets of <span class="caps">URL</span>&nbsp;patterns.</p>
<p>Devices like these aren&#8217;t of course specific to Rust:
interfaces (traits) and classes are a staple of <span class="caps">OO</span> languages in general.
But some other techniques were more idiomatic;
the concept of <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html">iterators</a>, for example,
is flexible enough to accommodate
<a href="https://github.com/Xion/gisht/blob/4fa347c6197190b0f6c68dd548efc28287a5859f/src/hosts/github.rs#L354">looping over GitHub user&#8217;s gists</a>,
even as they read directly from <span class="caps">HTTP</span>&nbsp;responses.</p>
<h4>Hacking&nbsp;time</h4>
<p>Not everything was sunshine and rainbows,&nbsp;though.</p>
<p>Take <em>clap</em>, for example.
It&#8217;s mostly a very good crate for parsing command line arguments,
but it couldn&#8217;t <em>quite</em> cope with the unusual requirements that <em>gisht</em> had.
To make <code>gisht Foo/bar</code> work alongside <code>gisht run Foo/bar</code>,
it was necessary to
<a href="https://github.com/Xion/gisht/commit/0eff00e31f94f3856558ebb1f6655a9e6fc50ca6#diff-7397f82f682a49eb62e2b056118124d0">analyze <code>argv</code></a>
before even handing it over to <code>clap</code>.
This turned out to be
<a href="https://github.com/Xion/gisht/commit/e7ab06a01d4675947965ec82fc6f3ec5a2517c89#diff-7397f82f682a49eb62e2b056118124d0">surprisingly tricky</a>
to get right.
Like,
<a href="https://github.com/Xion/gisht/commit/69e8aad4a1743beb57184dc38150ef02b306a0a1#diff-7397f82f682a49eb62e2b056118124d0">really</a>
tricky, with
<a href="https://github.com/Xion/gisht/commit/acadcfa0a97fe52584fbf8198541baa8733cb0a5#diff-7397f82f682a49eb62e2b056118124d0R58">edges cases</a>
and
<a href="https://github.com/Xion/gisht/commit/a9eb599168f5b6821aefa46dde0b0a89a41cd4e6#diff-7397f82f682a49eb62e2b056118124d0R562">stuff</a>.
But as it is often the case in software,
the answer turned out to be yet another layer of indirection plus
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/args.rs#L457-L578">a copious amount of tests</a>.</p>
<p>In another instance, however, a direct library support was&nbsp;crucial.</p>
<p>It so happened that <em>hyper</em>, the crate I&#8217;ve been using for <span class="caps">HTTP</span> requests,
didn&#8217;t handle the <code>Link:</code> response header out of the box<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.
This was a stumbling block that prevented the gist iterator (mentioned earlier)
from correctly handling pagination in the responses from GitHub <span class="caps">API</span>.
Thankfully, having <a href="https://docs.rs/hyper/0.11.7/hyper/header/trait.Header.html">the <code>Header</code> abstraction</a> in <em>hyper</em>
meant it was possible to add the missing support in
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/ext/hyper.rs">a relatively straighforward manner</a>.
Yes, it&#8217;s <a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/ext/hyper.rs#L23">not a universal implementation</a>
that&#8217;d be suitable for <em>every</em> <span class="caps">HTTP</span> client,
but it does the job for <em>gisht</em> just&nbsp;fine.</p>
<h4>Test-Reluctant&nbsp;Development</h4>
<p>And so the program kept growing steadily over the months,
most notably through
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/mod.rs#L101">more and more gist hosts</a>
it could now&nbsp;support.</p>
<p>Eventually, some of them would fall into a sort of twilight zone.
They weren&#8217;t as complicated as GitHub to warrant writing a completely new <code>Host</code> instance,
but they also couldn&#8217;t be handled via
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/common/basic.rs#L28">the <code>Basic</code> structure</a> alone.
A good example would be <a href="http://sprunge.us/">sprunge.us</a>:
mostly an ordinary pastebin,
except for its optional syntax highlighting
which may add some &#8220;junk&#8221; to the otherwise regular&nbsp;URLs.</p>
<p>In order to handle those odd cases,
I went for a classic wrapper/decorator pattern which, in its essence,
boils down to something like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">Basic</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">new</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Sprunge</span><span class="p">{</span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">Basic</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sprunge.us&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="s">&quot;http://sprunge.us/${id}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">...)}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// override &amp; wrap methods that require custom logic:</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">resolve_url</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">io</span><span class="o">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Gist</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">url_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">try_opt</span><span class="o">!</span><span class="p">(</span><span class="n">Url</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">ok</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">url_obj</span><span class="p">.</span><span class="n">set_query</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">inner</span><span class="p">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url_obj</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_str</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// passthrough to the `Basic` struct for others:</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">fetch_gist</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">gist</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Gist</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">:</span><span class="w"> </span><span class="n">FetchMode</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">io</span><span class="o">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">fetch_gist</span><span class="p">(</span><span class="n">gist</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// (etc.)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Despite the noticeable boilerplate of a few pass-through methods,
I was pretty happy with this solution, at least initially.
After a few more unusual hosts, however,
it became cumbersome to fix all the edge cases
by looking only at the final output of the inner <code>Basic</code> implementation.
The code was evidently asking for some <em>tests</em>,
if only to check how the inner structure is being&nbsp;called.</p>
<p>Shouldn&#8217;t be too hard, right?&#8230; Yeah, that&#8217;s what I thought,&nbsp;too.</p>
<p>The reality, unfortunately, fell very short of those expectations.
Stubs, mocks, fakes &#8212;
<a href="https://testing.googleblog.com/2013/07/testing-on-toilet-know-your-test-doubles.html"><em>test doubles</em></a>
in general &#8212;
are a dark and forgotten corner of Rust
that almost no one seems to pay any attention to.
Absent a proper library support &#8212; much less a language one &#8212;
the only way forward was to roll up my sleeves
and implement
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/testing/inmemory_host.rs">a fake <code>Host</code></a>
from&nbsp;scratch.</p>
<p>But that was just the beginning.
How do you seamlessly inject this fake implementation into the wrapper
so that it replaces the <code>Basic</code> struct for testing?
If you are not careful and go for the &#8220;obvious&#8221; solution &#8212; a trait&nbsp;object:</p>
<div class="highlight"><pre><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Host</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>you&#8217;ll soon realize that you need not just a <code>Box</code>, but at least an <code>Rc</code> (or maybe even <code>Arc</code>).
Without this kind of shared ownership,
you&#8217;ll lose your chance to interrogate the test double once you hand it over to the wrapper.
This, in turn, will heavily limit your ability to write effective&nbsp;tests.</p>
<p>What&#8217;s the non-obvious approach, then?
The full rationale would probably warrant a separate post,
but the working recipe looks more or less like&nbsp;this:</p>
<ul>
<li>
<p>First, <em>parametrize</em> the wrapper with its inner type:
  <code>pub struct Sprunge&lt;T: Host&gt; { inner: T }</code>.</p>
</li>
<li>
<p>Put that in an internal module with the correct visibility&nbsp;setup:</p>
<div class="highlight"><pre><span class="kn">mod</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Sprunge</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="n">Host</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="n">super</span><span class="p">)</span><span class="w"> </span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


</li>
<li>
<p>Make the regular (&#8220;production&#8221;) version of the wrapper into an <em>alias</em>,
  giving it the type parameter that you&#8217;ve been using directly<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>:</p>
<div class="highlight"><pre><span class="k">pub</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">internal</span><span class="o">::</span><span class="n">Sprunge</span><span class="o">&lt;</span><span class="n">Basic</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


</li>
<li>
<p>Change the <code>new</code> constructor to instantiate the <code>internal</code> type.</p>
</li>
<li>
<p>In tests, create the wrapper with a fake <code>inner</code> object&nbsp;inside.</p>
</li>
</ul>
<p>As you can see in
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/sprunge.rs">the real example</a>,
this convoluted technique removes the need for any pointer indirection.
It also permits you to
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/sprunge.rs#L152">access the out-of-band interface</a>
that a fake object would normally&nbsp;expose.</p>
<p>It&#8217;s a shame, though, that so much work is required for something
that should be very simple.
As it appears, testing is still a neglected topic in&nbsp;Rust.</p>
<h4>Packing&nbsp;up</h4>
<p>It wasn&#8217;t just Rust that played a notable role in the development of <em>gisht</em>.</p>
<p>Pretty soon after getting the app to a presentable state,
it became clear that a mere <code>cargo build</code> won&#8217;t do everything
that&#8217;s necessary to carry out a complete build.
It <em>could</em> do more, admittedly,
if I had the foresight to explore <a href="http://doc.crates.io/build-script.html">Cargo build scripts</a>
a little more thoroughly.
But overall, I don&#8217;t regret dropping back to my trusty ol&#8217; pick:&nbsp;Python.</p>
<p>Like in a few previous projects, I used the <a href="http://pyinvoke.org">Invoke task runner</a>
for both the crucial and the auxiliary automation tasks.
It is a relatively powerful tool
&#8212; and probably the best in its class in Python that I know of &#8212;
though it can be a bit capricious if you want to
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/release/__init__.py#L69">really fine-tune it</a>.
But it does make it much easier to organize your automation code,
to reuse it between tasks, and to (ahem) <em>invoke</em> those tasks in a convenient&nbsp;manner.</p>
<p>In any case, it certainly beats a collection of disconnected Bash scripts&nbsp;;)</p>
<p>What have I automated in this way, you may ask?
Well, a couple of small things; those&nbsp;include:</p>
<ul>
<li>
<p>embedding of the current Git commit hash into the binary,
to help identify the exact revision in the logs of any potential bug reports<sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup></p>
</li>
<li>
<p>after a successful build,
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/build.py#L40">replacing</a>
the <em>Usage</em> section in <em><span class="caps">README</span></em> with the program&#8217;s <code>--help</code> output</p>
</li>
<li>
<p>generating <a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/build.py#L96">completion scripts</a>
for popular shells by invoking the binary with a magic hidden flag (courtesy of <em>clap</em>)</p>
</li>
</ul>
<p>Undoubtedly the biggest task that I relegated to Python/Invoke,
was the preparation of
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/release/__init__.py"><em>release packages</em></a>.
When it comes to the various Linuxes (currently Debian and Red Hat flavors),
this wasn&#8217;t particularly complicated.
Major thanks are due to the amazing <a href="https://github.com/jordansissel/fpm"><em>fpm</em> tool</a> here,
which I recommend to anyone who needs to package their software in a distro-compatible&nbsp;manner.</p>
<p>Homebrew, however &#8212; or more precisely, <span class="caps">OS</span> X itself &#8212; was quite a different story.
Many, <a href="https://github.com/Xion/gisht/commits/a5423a63d10221c50faa1cb30a999a85286853a1">many</a>
failed attempts were needed to even get it to build on <a href="https://travis-ci.org">Travis</a>,
and the additional dependency on Python was
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/ci/travis/before_install-osx.sh#L15">partially to blame</a>.
To be fair, however, most of the pain was exclusively due to OpenSSL;
getting that thing to build is always <a href="https://github.com/sfackler/rust-openssl/issues/255">loads of &#8220;fun&#8221;</a>,
especially in such an opaque and poorly debuggable environment as&nbsp;Travis.</p>
<h4>The&nbsp;wrap</h4>
<p>There&#8217;s probably a lot of minor things and tidbits I could&#8217;ve mentioned along the way,
but the story so far has most likely covered all the important topics.
Let&#8217;s wrap it up then, and highlight some interesting points in the classic <em>Yay/Meh/Nay</em>&nbsp;manner.</p>
<h5>Yay</h5>
<ul>
<li>
<p>It was definitely a good choice to rewrite <em>gisht</em> specifically in Rust.
Besides all the advantages I&#8217;ve mentioned already,
it is also worth noting that the language went through about 10 minor version bumps
while I was working on this project.
Of all those new releases,
I don&#8217;t recall a single one that would introduce a breaking&nbsp;change.</p>
</li>
<li>
<p>Most of the Rust ecosystem (third-party libraries) was a joy to use,
and very easy to get started with.
Honorable mention goes to <em>serde_json</em> and how easy it was to
<a href="https://github.com/Xion/gisht/commit/a0655a6a5b86c05df5665e3bc7f1512f2476c9e4">transition the code</a>
from <em>rustc_serialize</em> that I had used at&nbsp;first.</p>
</li>
<li>
<p>With a possible exception of sucking in node.js as a huge dependency of your project
and using Grunt, there is probably no better way of writing automation <span class="amp">&amp;</span> support code than Python.
There may eventually be some Rust-based task runners that could try to compete,
but I&#8217;m not very convinced about using a compiled language for this purpose
(and especially one that takes so long to&nbsp;build).</p>
</li>
</ul>
<h5>Meh</h5>
<ul>
<li>
<p>While <a href="https://docs.rs/clap">the <em>clap</em> crate</a> is quite configurable and pretty straightforward to use,
it does lack at least <a href="https://github.com/kbknapp/clap-rs/issues/568">one feature</a>
that&#8217;d be very nice for <em>gisht</em>.
Additionally, working with raw <em>clap</em> is often a little tedious,
as it doesn&#8217;t assist you in translating parsed flags into your own configuration types,
and thus requires
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/args.rs#L138-L182">shuffling those bits</a>
manually<sup id="fnref:6"><a class="footnote-ref" href="#fn:6" rel="footnote">6</a></sup>.</p>
</li>
<li>
<p>Being a <em>defacto</em> standard for continuous integration in open-source projects,
<a href="https://travis-ci.org">Travis <span class="caps">CI</span></a> could be a <em>little</em> less finicky.
In almost every project I decide to use it for,
I end up with about half a dozen commits
that frantically try to fix silly configuration issues,
all before even a simple <em>.travis.yml</em> works as intended.
Providing a way to test <span class="caps">CI</span> builds locally would be an obvious way to avoid this&nbsp;churn.</p>
</li>
</ul>
<h5>Nay</h5>
<ul>
<li>
<p>Testing in Rust is such a weird animal.
On one hand, there is a first-class, out-of-the-box support for unit tests
(and even integration tests) right in the toolchain.
On the other hand, the relevant parts of the ecosystem are immature or lacking,
as evidenced by the dreary story of mocking and stubbing.
It&#8217;s no surprise that there is a long way to catch up to languages with the strongest testing culture
(Java and C#/.<span class="caps">NET</span><sup id="fnref:7"><a class="footnote-ref" href="#fn:7" rel="footnote">7</a></sup>), but it&#8217;s disappointing to see Rust outclassed
<a href="https://github.com/google/googletest">even by C++</a>.</p>
</li>
<li>
<p>Getting anything to build reliably on <span class="caps">OSX</span> in a <span class="caps">CI</span> environment is already a tall order.
But if it involves things as OpenSSL, then it quickly goes from bad to terrible.
I&#8217;m really not amused anymore how this &#8220;Just Works&#8221; system often turns out to hardly work at&nbsp;all.</p>
</li>
</ul>
<p>Since I don&#8217;t want to end on such a negative note,
I feel compelled to state the obvious fact: every technology choice is a trade-off.
In case of this project, however, the drawbacks were <em>heavily</em> outweighed by the&nbsp;benefits.</p>
<p>For this reason, I can definitely recommend the software stack I&#8217;ve just described
to anyone developing non-trivial, cross-platform command line&nbsp;tools.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This is not an isolated complaint, by the way,
as the interpreter startup time has recently emerged as <a href="https://lwn.net/Articles/730915/">an important issue</a>
to many developers of the Python language.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Which may also include a practical <em>lack</em> thereof.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>It does handle it <a href="https://docs.rs/hyper/0.11.7/hyper/header/struct.Link.html">now</a>, fortunately.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Observant readers may notice that we&#8217;re exposing a technically private type (<code>internal::Sprunge</code>)
through a publicly visible type alias. If that type was <em>actually</em> private,
this would trigger a compiler warning
which is slated to become <a href="https://github.com/rust-lang/rust/issues/34537">a hard error</a>
at some point in the future. But, amusingly, we can fool the compiler by making it a
<em>public type</em> inside a <em>private module</em>, which is exactly what we&#8217;re doing here.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>This has since been rewritten and is now done in
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/build.rs"><em>build.rs</em></a>
&#8212; but that&#8217;s only because I implemented
<a href="https://github.com/rust-lang/cargo/pull/3929">the relevant Cargo feature</a> myself :)&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>For an alternative approach that doesn&#8217;t seem to have this problem,
check <a href="https://docs.rs/structopt_derive">the <em>structopt</em> crate</a>.&#160;<a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>Dynamically typed languages, due to their rich runtime,
are basically a class of their own when it comes to testing ease,
so it wouldn&#8217;t really be fair to hold them up for comparison.&#160;<a class="footnote-backref" href="#fnref:7" rev="footnote" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/programming/gisht-recap.html#gisht-recap">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/rust-unit-test-placement.html#rust-unit-test-placement">Better location for unit tests in&nbsp;Rust</a></h2>
    <p>
      Posted on Fri 06 January 2017 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/unit-tests.html">unit tests</a>,      <a href="http://xion.io/tag/testing.html">testing</a>,      <a href="http://xion.io/tag/modules.html">modules</a>      &#8226; <a href="http://xion.io/post/code/rust-unit-test-placement.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>For a unit test to be comprehensive,
it must often access some private symbols from the module it&nbsp;checks.</p>
<p>In Rust, this is permitted for submodules:
they can freely refer to anything defined &#8220;upwards&#8221; in the module hierarchy.
The only requirement is that they import it explicitly by name,
using statements such as <code>use super::foo</code>.</p>
<p>To illustrate this,
here&#8217;s an <a href="https://is.gd/xTgUEd">example</a>
of a ridiculously well-factored <a href="http://wiki.c2.com/?FizzBuzzTest">FizzBuzz</a>
along with its accompanying unit&nbsp;test:</p>
<div class="highlight"><pre><span class="kn">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">borrow</span><span class="o">::</span><span class="n">Cow</span><span class="p">;</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">fizzbuzz</span><span class="p">(</span><span class="n">n</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">1.</span><span class="p">.</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="n">i</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Cow</span><span class="o">&lt;</span><span class="nl">&#39;static</span><span class="p">,</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">by3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">by5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">by3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">by5</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;FizzBuzz&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">by3</span><span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Fizz&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">by5</span><span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Buzz&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">).</span><span class="n">into</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="kn">mod</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">use</span><span class="w"> </span><span class="n">super</span><span class="o">::</span><span class="n">fizzbuzz_string</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[test]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">single_numbers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Fizz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Buzz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;7&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Fizz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">9</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Buzz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;FizzBuzz&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fizzbuzz_string</span><span class="p">(</span><span class="mi">15</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">etc</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>The internal function, as shown above, can be imported and verified independently
of the <code>pub</code>lic one.
This is done through a <code>#[test]</code> procedure in an inline&nbsp;submodule.</p>
<p>Such factorization and granular testing is commonplace,
especially when the public <span class="caps">API</span> may cause unwanted side effects,
such as printing stuff to stdout&nbsp;here.</p>
<h4>The issue of&nbsp;length</h4>
<p>But if you are like me and prefer your modules to be short and sweet,
you may feel justifiably concerned about this <em>inline</em> submodule&nbsp;business.</p>
<p>In the toy example above,
tests have already taken at least as many lines as the actual code.
Real world usually <a href="https://github.com/Geal/nom/blob/80a1deab58d1faf41c05a5d741d9e3f51bde3a55/src/nom.rs#L599">matches</a> this ratio.
A module with a couple hundred lines of regular code starts
to be measured in <a href="https://en.wikipedia.org/wiki/Source_lines_of_code#Related_terms">KLOCs</a>
if we also include its&nbsp;tests.</p>
<p>While this could be taken as a strong hint to split things up,
it can just as easily disincentivize testing&nbsp;instead.</p>
<p>The obvious solution is to move those tests somewhere else.
What is not so evident is how to preserve this crucial module-submodule relation,
enabling us to write comprehensive tests in the first&nbsp;place.</p>
<h4>Looking for&nbsp;inspiration</h4>
<p>I must quickly disappoint anyone who would like to round up all their unit tests
and sequester them in some distant <em>tests/</em> directory.
Such layout is reserved for
<a href="https://doc.rust-lang.org/book/testing.html#the-tests-directory">crate-level</a> (&#8220;integration&#8221;) tests.
Unit tests, on the other hand, are predestined to live among production code<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>So let&#8217;s at least relocate them to separate&nbsp;files.</p>
<p>To make this goal more concrete,
we will try to emulate the project layout described in
<a href="https://google.github.io/styleguide/cppguide.html#File_Names">Google&#8217;s C++ style guide</a>.
By this convention, a conceptual &#8220;module&#8221; or &#8220;unit&#8221; consists of the following&nbsp;files:</p>
<ul>
<li><em>foo.h</em></li>
<li><em>foo.cc</em></li>
<li><em>foo_test.cc</em></li>
</ul>
<p>Translating this to Rust, we&nbsp;get:</p>
<ul>
<li><em>foo.rs</em></li>
<li><em>foo_test.rs</em></li>
</ul>
<p>The first one is obviously our production code.
The second file, <em>foo_test.rs</em>,
contains all the tests we would previously put in the <code>mod tests { }</code> construct.</p>
<p>Seems pretty clean and straightforward, right?
Unfortunately, Rust will not accept this setup without some&nbsp;convincing.</p>
<h4>Family&nbsp;problems</h4>
<p>To understand why,
recall that the mere presence of some <em>.rs</em> files
is not enough for the Rust compiler to care.
If we want them picked up and included in the project,
we also need to add some <em>module declarations</em>&nbsp;first.</p>
<p>In other words, there must also be a <em>mod.rs</em> file in this directory,
containing at the very least the following&nbsp;content:</p>
<div class="highlight"><pre><span class="c1">// (mod.rs)</span>

<span class="kn">mod</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="kn">mod</span><span class="w"> </span><span class="n">foo_test</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>Now it should be clearer that something is&nbsp;wrong.</p>
<p>We got two modules here, but they are <em>siblings</em>.
Both <code>foo</code> and <code>foo_test</code> are on the same level,
children of whatever parent module contains them both.
More to the point, it&#8217;s <code>foo_test</code> that&#8217;s not a child module of <code>foo</code>,
meaning it can only see the <code>pub</code>lic symbols of the&nbsp;latter.</p>
<p>This is not quite enough to write a proper unit test.
It definitely isn&#8217;t for our initial FizzBuzz example,
because the <code>fizzbuzz_string</code> function cannot even be&nbsp;imported!</p>
<h4>Existential&nbsp;crises</h4>
<p>Okay, so how about we move the <code>mod foo_test;</code> declaration to <em>foo.rs</em>?
This should be enough to establish the proper hierarchy.
After all, this is how the module tree is
<a href="https://doc.rust-lang.org/book/crates-and-modules.html#defining-modules">normally reconstructed</a>:
from the appropriate placement of the <code>mod</code> statements.</p>
<p>So, here we&nbsp;go:</p>
<div class="highlight"><pre><span class="c1">// (foo.rs)</span>

<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="kn">mod</span><span class="w"> </span><span class="n">foo_test</span><span class="p">;</span><span class="w"></span>
</pre></div>


<!-- -->

<div class="highlight"><pre>error: cannot declare a new module at this location
  --&gt; src/parent/foo.rs:4:5
   |
 4 | mod foo_test;
</pre></div>


<p>&#8230;Really?</p>
<p>Well, yes. A declaration like this simply isn&#8217;t allowed.
The reason for this is actually much less arbitrary than the error message would&nbsp;indicate.</p>
<p>To put it bluntly, <code>foo_test</code> simply cannot <em>exist</em> if it&#8217;s introduced there.
To deliver on its declaration promise,
the submodule would have to reside <em>within <code>foo</code> itself</em>.
But of course, <em>foo.rs</em> is just a file, so this setup is evidently&nbsp;impossible.</p>
<p>All in all, Rust seems to be looking for our module in all the wrong&nbsp;places.</p>
<p>Perhaps we can just <em>tell it</em> where it should be going&nbsp;instead?&#8230;</p>
<h4>The right&nbsp;path</h4>
<p>Enter the <code>#[path]</code> attribute,
which fulfills this exact&nbsp;purpose:</p>
<div class="highlight"><pre><span class="c1">// (foo.rs)</span>

<span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="cp">#[path = </span><span class="s">&quot;./foo_test.rs&quot;</span><span class="cp">]</span><span class="w"></span>
<span class="kn">mod</span><span class="w"> </span><span class="n">foo_test</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p><code>#[path]</code> tells the Rust compiler where to look for the <code>mod</code>ule it is attached to.
Its argument is relative to the location of the outer module (like <code>foo</code> here),
and can be either a single file, or a directory with <em>mod.rs</em>.</p>
<p>Conceptually, this is similar to a custom <code>ClassLoader</code> in Java,
or the common <a href="http://xion.org.pl/2012/05/06/hacking-python-imports/"><code>sys.path</code> hacks</a> in Python.
Unlike those two languages, however,
the <code>#[path]</code> attribute is only relevant at compile&nbsp;time.</p>
<p>Additionally, and somewhat <a href="https://github.com/rust-lang/rust/issues/13156">confusingly</a>,
<code>#[path]</code> can also be applied <em>retroactively</em>
to a module that the compiler has already located.
In such case, it will affect <a href="https://doc.rust-lang.org/reference.html#modules">the lookup of any child modules</a>
by making <code>rustc</code> search for them in the new&nbsp;location.</p>
<hr />
<p>With <code>#[path]</code> handy,
it is therefore possible to implement custom layouts
of regular source modules and test&nbsp;files.</p>
<p>But like with every tool that can be used to defy conventions,
it should be used with the appropriate care.
While a straightforward and self-documenting approach described here
is unlikely to raise any eyebrows,
rewriting module paths willy-nilly is most certainly a bad&nbsp;idea.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Okay, technically it <em>is</em> possible to completely isolate them,
essentially by abusing the approach I describe later in this post.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/rust-unit-test-placement.html#rust-unit-test-placement">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-all-wild-imports.html#python-all-wild-imports">__all__ and wild imports in&nbsp;Python</a></h2>
    <p>
      Posted on Mon 26 December 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/modules.html">modules</a>,      <a href="http://xion.io/tag/imports.html">imports</a>,      <a href="http://xion.io/tag/testing.html">testing</a>      &#8226; <a href="http://xion.io/post/code/python-all-wild-imports.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>An often misunderstood piece of Python import machinery is the <code>__all__</code> attribute.
While it is completely <em>optional</em>,
it&#8217;s common to see modules with the <code>__all__</code> list populated&nbsp;explicitly:</p>
<div class="highlight"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Foo&#39;</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c"># ...</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="c"># ...</span>

<span class="k">def</span> <span class="nf">baz</span><span class="p">():</span>
    <span class="c"># ...</span>
</pre></div>


<p>Before explaining what the real purpose of <code>__all__</code> is
(and how it relates to the titular wild imports),
let&#8217;s deconstruct some common misconceptions by highlighting what it <em>isn&#8217;t</em>:</p>
<ul>
<li>
<p><code>__all__</code> doesn&#8217;t prevent any of the module symbols (functions, classes, etc.)
from being <em>directly</em> imported.
In our the example, the seemingly omitted <code>baz</code> function (which is not included in <code>__all__</code>),
is still <em>perfectly importable</em> by writing <code>from module import baz</code>.</p>
</li>
<li>
<p>Similarly, <code>__all__</code> doesn&#8217;t influence what symbols are included in the results of
<code>dir(module)</code> or <code>vars(module)</code>. So in the case above, a <code>dir</code> call would result in a
<code>['Foo', 'bar', 'baz']</code> list, even though <code>'baz'</code> does not occur in <code>__all__</code>.</p>
</li>
</ul>
<p>In other words, the content of <code>__all__</code> is more of a convention
rather than a strict limitation.
Regardless of what you put there, every symbol defined in your module
will still be accessible from the&nbsp;outside.</p>
<p>This is a clear reflection of the common policy in Python:
assume <a href="https://mail.python.org/pipermail/tutor/2003-October/025932.html">everyone is a consenting adult</a>,
and that visibility controls are not necessary.
Without an explicit <code>__all__</code> list,
Python simply puts all of the module &#8220;public&#8221; symbols there anyway<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>The meaning of it <code>__all__</code></h4>
<p>So, what does <code>__all__</code> actually&nbsp;effect?</p>
<p>This is neatly summed up in this brief
<a href="http://stackoverflow.com/a/2187636/434799">StackOverflow answer</a>.
Simply speaking, its purpose is&nbsp;twofold:</p>
<ul>
<li>
<p>It tells the readers of the source code &#8212; be it humans or automated tools &#8212;
what&#8217;s the conventional <em>public <span class="caps">API</span></em> exposed by the&nbsp;module.</p>
</li>
<li>
<p>It lists names to import when performing the so-called <em>wild import</em>:
<code>from module import *</code>.</p>
</li>
</ul>
<p>Because of the default content of <code>__all__</code> that I mentioned earlier,
the public <span class="caps">API</span> of a module can also be defined implicitly.
Some style guides (like the <a href="https://google.github.io/styleguide/pyguide.html">Google one</a>)
are therefore relying on the <code>public</code> and <code>_private</code> naming exclusively.
Nevertheless, an explicit <code>__all__</code> list is still a perfectly valid option,
especially considering that no approach offers any form of <em>actual</em> access&nbsp;control.</p>
<h4>Import&nbsp;star</h4>
<p>The second point, however, has some real runtime&nbsp;significance.</p>
<p>In Python, like in many other languages,
it is recommended to be explicit about the exact functions and classes we&#8217;re importing.
Commonly, the <code>import</code> statement will thus take one of the following&nbsp;forms:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">fatal</span><span class="p">,</span> <span class="n">warning</span> <span class="k">as</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="c"># etc.</span>
</pre></div>


<p>In each case, it&#8217;s easy to see the relevant <em>name</em> being imported.
Regardless of the exact syntax and the possible presence of aliasing (<code>as</code>),
it&#8217;s always the last (qualified) name in the <code>import</code> statement,
before a newline or&nbsp;comma.</p>
<p>Contrast this with an <code>import</code> that ends with an&nbsp;asterisk:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>


<p>This is called a <em>star</em> or <em>wild import</em>, and it isn&#8217;t so straightforward.
This is also the reason why using it is <a href="http://stackoverflow.com/a/3615206/434799">generally discouraged</a>,
except for some <a href="http://stackoverflow.com/a/3615238/434799">very specific situations</a>.</p>
<p>Why? Because you cannot easily see what exact names are being imported here.
For that you&#8217;d have to go to the module&#8217;s source and &#8212; you guessed it &#8212;
look at the <code>__all__</code> list<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>.</p>
<h4>Taming the&nbsp;wild</h4>
<p>Barring some less important details,
the mechanics of <code>import *</code> could therefore be expressed in the following Python&nbsp;(pseudo)code:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">module</span> <span class="kn">as</span> <span class="nn">__temp</span>
<span class="k">for</span> <span class="n">__name</span> <span class="ow">in</span> <span class="n">module</span><span class="p">:</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__temp</span><span class="p">,</span> <span class="n">__name</span><span class="p">)</span>
<span class="k">del</span> <span class="n">__temp</span>
<span class="k">del</span> <span class="n">__name</span>
</pre></div>


<p>One interesting case to consider is
what happens when <code>__all__</code> contains a <em>wrong</em>&nbsp;name.</p>
<p>What if one of the strings there doesn&#8217;t correspond to any name within the&nbsp;module?&#8230;</p>
<div class="highlight"><pre><span class="c"># foo.py</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Foo&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">foo</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">foo</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="s">&#39;module&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">&#39;Foo&#39;</span>
</pre></div>


<p>Quite predictably, <code>import *</code> blows up.<br>
Notice, however, that regular import <em>still works</em>.<br></p>
<p>All in all (ahem), this hints at a cute little trick which is also very&nbsp;self-evident:</p>
<div class="highlight"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;DO_NOT_WILD_IMPORT&#39;</span><span class="p">]</span>
</pre></div>


<p>Put this in a Python module, and no one will be able to <code>import *</code> from it!<br>
Much more effective than any lint warning ;-)<br></p>
<h4>Test <code>__all__</code> the&nbsp;things</h4>
<p>Jokes aside, this phenomenon (<code>__all__</code> with an out-of-place name in it) can also backfire.
Especially when
<a href="https://github.com/Xion/callee/blob/277add8170bd0c758f3c4a3068127e8229d2e2d1/callee/__init__.py#L31">reexporting</a>,
it&#8217;s relatively easy to introduce stray <code>'name'</code> into <code>__all__</code>:
one which doesn&#8217;t correspond to any <code>name</code> that&#8217;s <em>actually present</em> in the&nbsp;namespace.</p>
<p>If we commit such a mishap, we are inadvertently lying about the public <span class="caps">API</span> of our package.
What&#8217;s worse is that this mistake can propagate through documentation generators,
and ultimately mislead our&nbsp;users.</p>
<p>While some linters may be able to catch this,
a <a href="https://github.com/Xion/callee/blob/277add8170bd0c758f3c4a3068127e8229d2e2d1/tests/test_all.py#L10">simple test</a>
like this&nbsp;one:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">test_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that __all__ contains only names that are actually exported.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">yourpackage</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">yourpackage</span><span class="o">.</span><span class="n">__all__</span>
                  <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">yourpackage</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEmpty</span><span class="p">(</span>
        <span class="n">missing</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;__all__ contains unresolved names: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">),))</span>
</pre></div>


<p>is a quick <span class="amp">&amp;</span> easy way to ensure this never&nbsp;happens.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><span class="dquo">&#8220;</span>Public&#8221; symbols have names that don&#8217;t begin with underscore (<code>_</code>).
Of course, &#8220;non-public&#8221; ones are still accessible
but are treated as implicitly unstable <span class="amp">&amp;</span> discouraged.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Or check what symbols there don&#8217;t have a leading underscore.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-all-wild-imports.html#python-all-wild-imports">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/news/callee-intro.html#callee-intro">Introducing callee: matchers for&nbsp;unittest.mock</a></h2>
    <p>
      Posted on Sun 20 March 2016 in <a href="http://xion.io/category/news.html">News</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/testing.html">testing</a>,      <a href="http://xion.io/tag/mocking.html">mocking</a>,      <a href="http://xion.io/tag/argument-matchers.html">argument matchers</a>      &#8226; <a href="http://xion.io/post/news/callee-intro.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Combined with dynamic typing, the lax object model of Python makes it pretty easy to write unit tests that involve
<em>mocking</em> some parts of the tested code. Still, there&#8217;s plenty of third party libraries &#8212; usually with &#8220;mock&#8221; somewhere
in the name &#8212; which promise to make it even shorter and simpler. There&#8217;s evidently been a need here that the standard
library didn&#8217;t address&nbsp;adequately.</p>
<p>It changed, however, with Python 3.3. This version introduced a new
<a href="https://docs.python.org/3/library/unittest.mock.html"><code>unittest.mock</code> module</a> which essentially obsoleted
all the other, third party solutions. The module, available also as a <a href="https://pypi.python.org/pypi/mock">backport</a>
for Python 2.6 and above, is flexible, easy to use, and offers most if not all of the requisite&nbsp;functionality.</p>
<h4>Called it,&nbsp;maybe?</h4>
<p>Well, with one notable exception. If we mock a function, or any other callable&nbsp;object:</p>
<div class="highlight"><pre><span class="c"># (production code)</span>
<span class="k">class</span> <span class="nc">ProductionClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">florb</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c"># (test code)</span>
<span class="n">something</span> <span class="o">=</span> <span class="n">ProductionClass</span><span class="p">()</span>
<span class="n">something</span><span class="o">.</span><span class="n">florb</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
</pre></div>


<p>we have very limited capabilities when it comes to verifying <em>how</em> they were called. Sure, we can be extremely&nbsp;specific:</p>
<div class="highlight"><pre><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s">&#39;this particular string&#39;</span><span class="p">)</span>
</pre></div>


<p>or very&nbsp;lenient:</p>
<div class="highlight"><pre><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>  <span class="c"># works for _any_ argument</span>
</pre></div>


<p>but there is virtually nothing in between. Suppose we don&#8217;t care too much what <em>exact</em> string the method was called with,
only that it was <em>some</em> string that&#8217;s long enough? Things get awkward <em>very</em> fast&nbsp;then:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">posargs</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">:</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">posargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;required call to </span><span class="si">%r</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="p">,))</span>
</pre></div>


<p>Yes, this is what&#8217;s required: an actual loop through all the mock&#8217;s calls<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>; unpacking tuples of positional and keyword
arguments; and manual assertions that won&#8217;t even emit useful error messages when they&nbsp;fail.</p>
<p>Eww! Surely Python can do better than&nbsp;that?</p>
<h4>Meet <code>callee</code></h4>
<p>Why, of course it can! Today, I&#8217;m releasing <a href="https://callee.readthedocs.org"><em>callee</em></a>: a library of <strong>argument matchers</strong>
compatible with <code>unittest.mock</code>. It enables you to write much simpler, more readable,
and delightfully declarative&nbsp;assertions:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">callee</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">LongerOrEqual</span>
<span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">String</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">LongerOrEqual</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</pre></div>


<p>The wide array of matchers offered by <em>callee</em> includes
<a href="https://callee.readthedocs.org/en/latest/reference/numbers.html">numeric</a>,
<a href="https://callee.readthedocs.org/en/latest/reference/strings.html">string</a>,
and <a href="https://callee.readthedocs.org/en/latest/reference/collections.html">collection</a> ones.
And if none suits your particular needs,
it&#8217;s a trivial matter to <a href="https://callee.readthedocs.org/en/latest/guide/custom-matchers.html">implement a custom one</a>.</p>
<p>Check the library&#8217;s documentation for <a href="https://callee.readthedocs.org/en/latest/guide/usage.html#example">more examples</a>,
or jump right in to the <a href="https://callee.readthedocs.org/en/latest/guide/installing.html">installation guide</a>
or a <a href="https://callee.readthedocs.org/#api-reference">full matcher reference</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>A loop is not necessary if we simulate <code>assert_called_once_with</code> rather than <code>assert_called_with</code>,
but we still have to dig into <code>mock.call</code> objects to eke out the arguments.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/news/callee-intro.html#callee-intro">Continue reading</a>
  </div>
</article>

  <div class="pagination">
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>