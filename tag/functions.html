<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog &ndash; Tag: functions</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-generator-args.html#python-generator-args">Arguments to Python generator&nbsp;functions</a></h2>
    <p>
      Posted on Tue 14 March 2017 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/generators.html">generators</a>,      <a href="http://xion.io/tag/functions.html">functions</a>,      <a href="http://xion.io/tag/arguments.html">arguments</a>,      <a href="http://xion.io/tag/closures.html">closures</a>      &#8226; <a href="http://xion.io/post/code/python-generator-args.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In Python, a <em>generator function</em> is one that
contains a <code>yield</code> statement inside the function body.
Although this language construct has many fascinating use cases
(<a href="http://www.dabeaz.com/coroutines/Coroutines.pdf"><span class="caps">PDF</span></a>),
the most common one is creating concise and readable&nbsp;iterators.</p>
<h4>A typical&nbsp;case</h4>
<p>Consider, for example, this simple&nbsp;function:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>
</pre></div>


<p>which creates an (infinite) iterator over all multiples of given integer.
A sample of its output looks like&nbsp;this:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">multiples</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
</pre></div>


<p>If you were to replicate in a language such as Java or Rust
&#8212; neither of which supports an equivalent of <code>yield</code> &#8212;
you&#8217;d end up writing an <em>iterator</em> class.
Python also has them, of&nbsp;course:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Multiples</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">of</span> <span class="o">=</span> <span class="n">of</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">of</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>

    <span class="n">__next__</span> <span class="o">=</span> <span class="nb">next</span>  <span class="c"># Python 3</span>
</pre></div>


<p>but they are usually not the first choice<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>It&#8217;s also pretty easy to see why:
they require explicit bookkeeping of any auxiliary state between iterations.
Perhaps it&#8217;s not too much to ask for a trivial walk over integers,
but it can get quite tricky if we were to iterate over recursive data structures,
like trees or graphs. In <code>yield</code>-based generators, this isn&#8217;t a problem,
because the state is stored within local variables on the coroutine&nbsp;stack.</p>
<h4>Lazy!</h4>
<p>It&#8217;s important to remember, however, that
generator functions behave differently than regular functions do,
even if the surface appearance often says&nbsp;otherwise.</p>
<p>The difference I wanted to explore in this post becomes apparent
when we add some argument checking to the initial&nbsp;example:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">of</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected a natural number, got </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">of</span><span class="p">,))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>
</pre></div>


<p>With that <code>if</code> in place, passing a negative number shall result in an exception.
Yet when we attempt to do just that, it will seem as if nothing is&nbsp;happening:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">multiples</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>


<p>And to a certain degree, this is pretty much correct.
Simply <em>calling</em> a generator function does comparatively little,
and doesn&#8217;t actually execute any of its code!
Instead, we get back a <em>generator object</em>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">multiples</span> <span class="n">at</span> <span class="mh">0x10f0ceb40</span><span class="o">&gt;</span>
</pre></div>


<p>which is essentially a built-in analogue to the <code>Multiples</code> iterator instance.
Commonly, it is said that both generator functions and iterator classes are <em>lazy</em>:
they only do work when we asked (i.e. iterated&nbsp;over).</p>
<h4>Getting&nbsp;eager</h4>
<p>Oftentimes, this is perfectly okay.
The laziness of generators is in fact one of their great strengths,
which is particularly evident in the <a href="https://pymotw.com/2/itertools/">immense usefulness</a>
of <a href="http://docs.python.org/2/library/itertools.html">the<code>itertools</code> module</a>.</p>
<p>On the other hand, however,
delaying argument checks and similar operations until later may hamper debugging.
The classic engineering principle of <a href="https://en.wikipedia.org/wiki/Fail-fast">failing fast</a>
applies here very fittingly: any errors should be signaled immediately.
In Python, this means raising exceptions as soon as problems are&nbsp;detected.</p>
<p>Fortunately, it is possible to reconcile the benefits of laziness
with (more) defensive programming.
We can make the generator functions only a <em>little</em> more eager,
just enough to verify the correctness of their&nbsp;arguments.</p>
<p>The trick is simple. We shall extract an <em>inner</em> generator function
and only call it after we have checked the&nbsp;arguments:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">of</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected a natural number, got </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">of</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">multiples</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">x</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>

    <span class="k">return</span> <span class="n">multiples</span><span class="p">()</span>
</pre></div>


<p>From the caller&#8217;s point of view, nothing has changed in the typical&nbsp;case:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">multiples</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">multiples</span> <span class="n">at</span> <span class="mh">0x110579190</span><span class="o">&gt;</span>
</pre></div>


<p>but if we try to make an incorrect invocation now,
the problem is detected <em>immediately</em>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">multiples</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
</pre></div>


<!-- -->

<div class="highlight"><pre>Traceback (most recent call last):
  File &quot;&lt;pyshell#2&gt;&quot;, line 1, in &lt;module&gt;
    multiples(of=-5)
  File &quot;&lt;pyshell#0&gt;&quot;, line 4, in multiples
    raise ValueError(&quot;expected a natural number, got %r&quot; % (of,))
ValueError: expected a natural number, got -5
</pre></div>


<p>Pretty neat, especially for something that requires only two lines of&nbsp;code!</p>
<h4>The last&nbsp;(micro)optimization</h4>
<p>Indeed, we didn&#8217;t even have to pass the arguments to the inner (generator) function,
because they are already captured by the&nbsp;closure.</p>
<p>Unfortunately, this also has a slight performance cost.
A captured variable (also known as a <em>cell variable</em>) is stored on the function object itself,
so Python has to emit
<a href="http://holdenweb.blogspot.com/2014/07/closures-arent-easy.html">a different bytecode instruction</a>
(<code>LOAD_DEREF</code>) that involves
an <a href="http://stupidpythonideas.blogspot.com/2015/12/how-lookup-works.html">extra pointer dereference</a>.
Normally, this is not a problem, but in a tight generator loop it can make a&nbsp;difference.</p>
<p>We can eliminate this extra work<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> by passing the parameters&nbsp;explicitly:</p>
<div class="highlight"><pre>    <span class="c"># (snip)</span>

    <span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">x</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>

    <span class="k">return</span> <span class="n">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
</pre></div>


<p>This turns them into local variables of the inner function,
replacing the <code>LOAD_DEREF</code> instructions with (aptly named) <code>LOAD_FAST</code> ones.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Technically, the <em>Multiples</em> class is here is both an <em>iterator</em>
(because it has the <code>next</code>/<code>__next__</code> methods) and <em>iterable</em>
(because it has <code>__iter__</code> method that returns an iterator, which happens to be the same object).
This is common feature of iterators that are not associated with any collection,
like the ones defined in the built-in <a href="http://docs.python.org/2/library/itertools.html"><code>itertools</code> module</a>.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Note that if you engage in this kind of microoptimizations,
I&#8217;d assume you have already <a href="https://www.python.org/doc/essays/list2str/">changed your global lookup into local ones</a> :)&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-generator-args.html#python-generator-args">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/rust-optional-args.html#rust-optional-args">Optional arguments in Rust&nbsp;1.12</a></h2>
    <p>
      Posted on Thu 29 September 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/arguments.html">arguments</a>,      <a href="http://xion.io/tag/parameters.html">parameters</a>,      <a href="http://xion.io/tag/functions.html">functions</a>      &#8226; <a href="http://xion.io/post/code/rust-optional-args.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Today&#8217;s <a href="https://blog.rust-lang.org/2016/09/29/Rust-1.12.html">announcement of Rust 1.12</a> contains,
among other things, this innocous little&nbsp;tidbit:</p>
<blockquote>
<p><code>Option</code> implements <code>From</code> for its contained&nbsp;type</p>
</blockquote>
<p>If you&#8217;re not very familiar with it,
<code>From</code> is a basic <a href="https://doc.rust-lang.org/std/convert/trait.From.html">converstion trait</a>
which any Rust type can implement.
By doing so, it defines how to create its values <em>from</em> some other type &#8212; hence its&nbsp;name.</p>
<p>Perhaps the most widespread application of this trait (and its <code>from</code> method)
is allocating owned <code>String</code> objects from literal <code>str</code> values:</p>
<div class="highlight"><pre><span class="kd">let</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="o">::</span><span class="n">from</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>


<p>What the change above means is that we can do similar thing with the <code>Option</code> type:</p>
<div class="highlight"><pre><span class="kd">let</span><span class="w"> </span><span class="n">maybe_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Option</span><span class="o">::</span><span class="n">from</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
</pre></div>


<p>At a first glance, this doesn&#8217;t look like a big deal at all.
For one, this syntax is much more wordy than the traditional <code>Some(42)</code>,
so it&#8217;s not very clear what benefits it&nbsp;offers.</p>
<p>But this first impression is rather deceptive.
In many cases, this change can actually <em>reduce</em> the number of times we have to type <code>Some(x)</code>,
allowing us to replace it with just <code>x</code>.
That&#8217;s because this new <code>impl</code> brings Rust quite a bit closer to having <em>optional function arguments</em>
as a first class feature in the&nbsp;language.</p>
<p>Until now, a function defined like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">maybe_plus_5</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>was the closest Rust had to default argument values.
While this works perfectly &#8212; and is bolstered by compile-time checks! &#8212;
callers are unfortunately required to build the <code>Option</code> objects&nbsp;manually:</p>
<div class="highlight"><pre><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maybe_plus_5</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span><span class="w">  </span><span class="c1">// OK</span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maybe_plus_5</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w">      </span><span class="c1">// OK</span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maybe_plus_5</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span><span class="w">        </span><span class="c1">// error!</span>
</pre></div>


<p>After <code>Option&lt;T&gt;</code> implements <code>From&lt;T&gt;</code>, however, this can change for the better.
<em>Much</em> better, in fact, for the last line above can be made valid.
All that is necessary is to take advantage of this new <code>impl</code> in the function&nbsp;definition:</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">maybe_plus_5</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;:</span><span class="w"> </span><span class="n">From</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Option</span><span class="o">::</span><span class="n">from</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Unfortunately, this results in quite a bit of complexity,
up to and including the <code>where</code> clause: a telltale sign of convoluted, generic code.
Still, this trade-off may be well worth it,
as a function defined once can be called many times throughout the code base,
and possibly across multiple crates if it&#8217;s a part of the public <span class="caps">API</span>.</p>
<p>But we can do better than this.
Indeed, using the <code>From</code> trait to constrain argument types is just complicating things for no good reason.
What we should so instead is use the symmetrical trait, <a href="https://doc.rust-lang.org/std/convert/trait.Into.html"><code>Into</code></a>,
and take advantage of its standard <code>impl</code>:</p>
<div class="highlight"><pre><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Into</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">U</span><span class="o">:</span><span class="w"> </span><span class="n">From</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
</pre></div>


<p>Once we translate it to the <code>Option</code> case (now that <code>Option&lt;T&gt;</code> implements <code>From&lt;T&gt;</code>),
we can switch the trait bounds around and get rid of the <code>where</code> clause&nbsp;completely:</p>
<div class="highlight"><pre><span class="k">fn</span><span class="w"> </span><span class="n">maybe_plus_5</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="n">Into</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">into</span><span class="p">().</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>As a small bonus, the function body has also gotten a little&nbsp;simpler.</p>
<hr />
<p>So, should you go wild and change all your functions taking <code>Option</code>als to look like this?&#8230;
Well, technically you can, although the benefits may not outweigh the downsides
for small, private functions that are called&nbsp;infrequently.</p>
<p>On the other hand, if you can afford to only support Rust 1.12 and up,
this technique can make it much more pleasant to use the external <span class="caps">API</span> of your&nbsp;crates.</p>
<p>What&#8217;s best is the <em>full backward compatibility</em> with any callers that still pass <code>Some(x)</code>:
for them, the old syntax will continue to work exactly like before.
Also note that the Rust compiler is smart about eliding the no-op conversion calls like the <code>Into::into</code> above,
so you shouldn&#8217;t observe any changes in the performance department&nbsp;either.</p>
<p>And who knows, maybe at some point Rust makes the final leap, and allows skipping the <code>None</code>s?&#8230;</p>
      <a class="btn" href="http://xion.io/post/code/rust-optional-args.html#rust-optional-args">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-get-lambda-code.html#python-get-lambda-code">Source code of a Python&nbsp;lambda</a></h2>
    <p>
      Posted on Tue 19 April 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/functions.html">functions</a>,      <a href="http://xion.io/tag/ast.html">AST</a>,      <a href="http://xion.io/tag/bytecode.html">bytecode</a>      &#8226; <a href="http://xion.io/post/code/python-get-lambda-code.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>&#8230;or: The Most Hideous Hack I&#8217;ve (Almost)&nbsp;Done</em></p>
<p>In <a href="http://github.com/Xion/callee">callee</a>, the <a href="http://callee.readthedocs.org">argument matcher library for Python</a> that
<a href="http://xion.io/post/news/callee-intro.html">I released recently</a>, there is this lovely
<a href="https://github.com/Xion/callee/blob/f695ff4e1c45bfd45445ebb8014a202029a93dce/callee/general.py#L55"><code>TODO</code> note</a>
for a seemingly simple feature. When using the
<a href="http://callee.readthedocs.org/en/stable/reference/general.html#callee.general.Matching"><code>Matching</code> construct</a>
with a simple <code>lambda</code> predicate:</p>
<div class="highlight"><pre><span class="n">mock_foo</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">Matching</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>


<p>it would be great to see its <em>code</em> in the error message if the assertion fails. Right now it&#8217;s just going to say
something like <code>&lt;Matching &lt;function &lt;lambda&gt; at 0x7f5d8a06eb18&gt;&gt;</code>. Provided you don&#8217;t possess a supernatural ability
of dereferencing pointers in your head, this won&#8217;t give you any immediate hint as to what went wrong. Wouldn&#8217;t it be nice
if it read as, say, <code>&lt;Matching \x: x % 2&gt;</code> instead?<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<p>So I thought: why not try and implement such a mechanism? This is Python, after all &#8212; a language where you can spawn
<a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/#simple-metaclass-use">completely new classes</a>
at runtime, walk the stack <a href="https://docs.python.org/2/library/inspect.html#the-interpreter-stack">backwards</a>
(or even <a href="https://docs.python.org/2/library/sys.html#sys.settrace">forward</a>) and read the local variables,
or change the behavior of the <a href="http://xion.org.pl/2012/05/06/hacking-python-imports/">import system itself</a>.
Surely it would be possible &#8212; nay, easy &#8212; to get the source code of a short lambda function,&nbsp;right?</p>
<p>Boy, was I <em>wrong</em>.</p>
<p>Make no mistake, though: the task turned out to be absolutely doable, at least in the scope I wanted it done.
But what would you think of a solution that involves not just the usual Python hackery, but also <span class="caps">AST</span> inspection,
transformations of the source code as text, <em>and</em> bytecode&nbsp;shenanigans?&#8230;</p>
<h4>The code, all the code, and&#8230; much more than the&nbsp;code</h4>
<p>Let&#8217;s start from the beginning, though. Here&#8217;s a short lambda function, the kind of which we&#8217;d like to obtain
the source code&nbsp;of:</p>
<div class="highlight"><pre><span class="n">is_even</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>


<p>If the documentation for Python standard library is to be believed, this should be pretty easy.
In the <a href="https://docs.python.org/2/library/inspect.html"><code>inspect</code> module</a>,
there is a function called no different than
<a href="https://docs.python.org/2/library/inspect.html#inspect.getsource"><code>getsource</code></a>. For our purposes, however,
<a href="https://docs.python.org/2/library/inspect.html#inspect.getsourcelines"><code>getsourcelines</code></a> is a little more
convienient, because we can easily tell when the lambda is too&nbsp;long:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_short_lambda_source</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source_lines</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>


<p>Of course if you programmed in Python for any longer period of time, you know very well that the standard docs
are <em>not</em> to be trusted. And it&#8217;s not just that the <code>except</code> clause should also include <code>TypeError</code>, because it
will be thrown when you try to pass any of the Python builtins to <code>getsourcelines</code>.</p>
<p>More important is the ambiguity of what does &#8220;source lines for an object&#8221; actually mean. &#8220;Source lines <em>containing</em>
the object definition&#8221; would be much more accurate, and this seemingly small distinction is rather crucial here.
Passing a lambda function to either <code>getsourcelines</code> or <code>getsource</code>, we&#8217;ll get its source <em>and everything else</em>
that the returned lines&nbsp;included.</p>
<p>That&#8217;s right. Say hello to the complete <code>is_even =</code> assignment, and the entire <code>assert_called_with</code> invocation!
And in case you are wondering: yes, the result will also include any end-of-line comments. No token left&nbsp;behind!</p>
<h4>Trim&nbsp;left</h4>
<p>Clearly this is more than we&#8217;ve bargained for. Maybe there is a way to strip away the unnecessary cruft? Python does
know how to parse itself, after all: the standard <a href="https://docs.python.org/2/library/ast.html"><code>ast</code> module</a>
is a manifestation of this knowledge. Perhaps we can use it to retrieve the <code>lambda</code> <span class="caps">AST</span> node in order to turn it &#8212;
and just it &#8212; back into Python&nbsp;code?&#8230;</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_short_lambda_ast_node</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">):</span>
    <span class="n">source_text</span> <span class="o">=</span> <span class="n">get_short_lambda_source</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source_text</span><span class="p">:</span>
        <span class="n">source_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_ast</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">)),</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>But as it turns out, getting the source text back this way is only <em>mostly</em>&nbsp;possible.</p>
<p>See, every substantial <span class="caps">AST</span> node &#8212; which is either an expression (<code>ast.expr</code>) or a statement (<code>ast.stmt</code>) &#8212;
has two common attributes: <code>lineno</code> and <code>col_offset</code>. When combined, they point to a place in the original source code
where the node was parsed from. This is how we can find out where to look for the definition of our lambda&nbsp;function.</p>
<p>Looks promising, right? The only problem is we don&#8217;t know when to <em>stop</em> looking.
That&#8217;s right: nodes created by <code>ast.parse</code> are annotated with their start offset, but not with length nor the end offset.
As a result, the best we can do when it comes to carving out the lambda source from the very first example is&nbsp;this:</p>
<div class="highlight"><pre><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>


<p>So close! Those hanging parentheses are evidently just taunting us, but how can we remove them? <code>lambda</code> is basically
just a Python expression, so in principle it can be followed by almost anything. This is doubly true for lambdas inside
the <code>Matching</code> construct, as they may be a part of some larger mock&nbsp;assertion:</p>
<div class="highlight"><pre><span class="n">mock_foo</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">Matching</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Integer</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">GreaterThan</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
</pre></div>


<p>Here, the extraneous suffix is the entirety of <code>), Integer() &amp; GreaterThan(42))</code>, quite a lot of more than just <code>))</code>.
And that&#8217;s of course nowhere near the limit of possiblities: for one, there may be more <code>lambda</code>s in there,&nbsp;too!</p>
<h4>Back off, <em>slowly</em></h4>
<p>It seems, however, that there is one thing those troublesome tails have in common: <em>they aren&#8217;t syntactically valid</em>.</p>
<p>Intuitively, a <code>lambda</code> node nested within some other syntactical constructs will have their closing fragments (e.g. <code>)</code>)
appear somewhere after its end. Without the corresponding openings (e.g. <code>Matching(</code>), those fragments won&#8217;t&nbsp;parse.</p>
<p>So here&#8217;s the crazy idea. What we have is invalid Python, but only because of some unspecified number of extra characters.
How about we just try and remove them, one by one, until we get something that <em>is</em> syntactically correct?
If we are not mistaken, this will finally be our lambda and nothing&nbsp;else.</p>
<p>The fortune favors the brave, so let&#8217;s go ahead and try&nbsp;it:</p>
<div class="highlight"><pre><span class="c"># ... continuing get_short_lambda_source() ...</span>

<span class="n">source_text</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">lambda_node</span> <span class="o">=</span> <span class="n">get_short_lambda_ast_node</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">)</span>

<span class="n">lambda_text</span> <span class="o">=</span> <span class="n">source_text</span><span class="p">[</span><span class="n">lambda_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">:]</span>
<span class="n">min_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;lambda:_&#39;</span><span class="p">)</span>  <span class="c"># shortest possible lambda expression</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_length</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">lambda_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lambda_text</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="n">lambda_text</span> <span class="o">=</span> <span class="n">lambda_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>Considering that we&#8217;re basically taking lessons from the dusty old tomes in the Restricted Section of Hogwarts library,
the magic here looks quite simple. As long as there is something that can pass for a lambda definition,
we try to parse it and see if it succeeds. The line that says <code>except SyntaxError:</code> is obviously not something for
the faint of heart, but at least we are specifying
<a href="https://docs.python.org/2/howto/doanddont.html#except"><em>what</em> exception</a> we anticipate&nbsp;catching.</p>
<p>And the kicker? It <em>works</em>. By that I mean it doesn&#8217;t return garbage results for a few obvious and not so obvious
test cases, which is already more than you would normally expect from hacks of this magnitude.
All the lambdas defined until this paragraph, for example, can have their source code extracted without&nbsp;issue.</p>
<h4>Just one more&nbsp;thing</h4>
<p>So&#8230; victory? Not quite. Astute readers may recall my promise of some bytecode arcana, and now&#8217;s the time for&nbsp;it.</p>
<p>Despite the initial success of our gradual, character dropping approach, there are cases where it doesn&#8217;t produce
the correct result. Consider, for example, a lambda definition that&#8217;s nestled within a tuple<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_short_lambda_source</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>


<p>We would of course expect the result to be <code>lambda _: True</code>, without a comma or&nbsp;zero.</p>
<p>Unfortunately, here&#8217;s where our earlier assumption fails rather spectacularly. The line of code extracted from <span class="caps">AST</span>
is syntactically valid even <em>with</em> the extra characters. As a result, <code>ast.parse</code> succeeds too early and returns an
incorrect definition. It should have been of a lambda contained within a tuple, but tuple is apparently what the lambda
<em>returns</em>.</p>
<p>You may say that this is the sharp end of a narrow edge case, and anyone who defines functions like that deserves all
the trouble they get. And sure, I wouldn&#8217;t mind if we just threw hands in the air and told them we&#8217;re simply unable
to retrieve the source here. But my opinion is that it doesn&#8217;t justify serving them obviously <em>wrong</em>&nbsp;results!</p>
<h4>A halting&nbsp;problem</h4>
<p>Not if we can help it, anyway. Have a look at the expected source code and the one we&#8217;ve extracted, side by&nbsp;side:</p>
<div class="highlight"><pre><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span>
<span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>


<p>The second line isn&#8217;t just longer: it is also <em>doing more</em>. It isn&#8217;t just defining a lambda; it defines it,
conjures up a constant <code>0</code>, and then packs them both into a tuple. That&#8217;s at least two additional steps compared to
the&nbsp;original.</p>
<p>Those steps have a more precise name, too: they are the <em>bytecode instructions</em>. Every piece of Python source is compiled
to a binary bytecode before it&#8217;s executed, because the interpreter can only work with this representation.
Compilation typically happens when a Python module is first imported, producing a <em>.pyc</em> file corresponding to its
<em>.py</em> file. Subsequent imports will simply reuse the cached&nbsp;bytecode.</p>
<p>Moreover, any function or class object has its bytecode accessible (read-only) at runtime. There is even a
<a href="http://late.am/post/2012/03/26/exploring-python-code-objects.html">dedicated data type</a> to hold it &#8212; called simply
<code>code</code> &#8212; with a buffer of raw bytes under one of its&nbsp;attributes.</p>
<p>Finally, the bytecode compiler itself is also available to Python programs as a built-in
<a href="https://docs.python.org/2/library/functions.html#compile"><code>compile</code> function</a>. You don&#8217;t see it used as often as its
counterparts <a href="https://docs.python.org/2/library/functions.html#eval"><code>eval</code></a>
and <a href="https://docs.python.org/2/reference/simple_stmts.html#exec"><code>exec</code></a> (which hopefully are a rare sight themselves!),
but it taps into the same internal machinery of&nbsp;Python.</p>
<p>So how does it all add up? The idea is, basically, to cross-check the alleged source code of the lambda with its own
<em>byte</em>code. Any junk that&#8217;s still left to trim &#8212; even if syntactically valid &#8212; will surface as a divergence after
compilation. Thus we can simply continue dropping characters until the bytecodes&nbsp;match:</p>
<div class="highlight"><pre><span class="n">lambda_text</span> <span class="o">=</span> <span class="n">source_text</span><span class="p">[</span><span class="n">lambda_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">:]</span>
<span class="n">lambda_body_text</span> <span class="o">=</span> <span class="n">source_text</span><span class="p">[</span><span class="n">lambda_node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">col_offset</span><span class="p">:]</span>
<span class="n">min_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;lambda:_&#39;</span><span class="p">)</span>  <span class="c"># shortest possible lambda expression</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_length</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">lambda_body_text</span><span class="p">,</span> <span class="s">&#39;&lt;unused filename&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">co_code</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_func</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_code</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lambda_text</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">lambda_text</span> <span class="o">=</span> <span class="n">lambda_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lambda_body_text</span> <span class="o">=</span> <span class="n">lambda_body_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>Okay, maybe not the exact bytes<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>, but stopping at the identical bytecode <em>length</em> is good enough a strategy.
As an obvious bonus, <code>compile</code> will also take care of detecting syntax errors in the candidate source code,
so we don&#8217;t need the <code>ast</code> parsing&nbsp;anymore.</p>
<h4>That escalated&nbsp;quickly!</h4>
<p>Believe it or not, but there aren&#8217;t any more objections to this solution, You can view it in its glorious entirety
by looking at <a href="https://gist.github.com/Xion/617c1496ff45f3673a5692c3b0e3f75a">this gist</a>.</p>
<p>Does it mean it is also making its cameo in the <a href="https://github.com/Xion/callee"><em>callee</em> library</a>?&#8230;</p>
<p>No, I&#8217;m afraid&nbsp;not.</p>
<p>Normally, I&#8217;m not the one to shy away from, ahem, <em>bold</em> solutions to tough problems. But in this case, the magnitude
of hackery required is just too great, the result not satisfactory enough, the feature&#8217;s priority isn&#8217;t really
all that high, and the maintenance burden it&#8217;d introduce is most likely too&nbsp;large.</p>
<p>In the end, it was great fun figuring it out: yet another example of how you can fiddle with Python to do basically
anything. Still, we must not get too preoccupied with whether or not we can as to forget if we <em>should</em>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Backslash (<code>\</code>) is how lambda functions are denoted in Haskell. We want to be short and sweet, so it feels
like a natural choice.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This isn&#8217;t an actual snippet from a Python <span class="caps">REPL</span>, because <code>inspect.getsourcelines</code> requires the object to be
defined in a <em>.py</em> file.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Why we won&#8217;t always get an identical bytecode? The short answer is that some instructions may be swapped
for their approximate equivalents.<br/>
The long answer is that with <code>compile</code>, we aren&#8217;t able to replicate the exact closure environment of the original lambda.
When a function refers to an <em>free variable</em> (like <code>foo</code> in <code>lambda x: x + foo</code>), it is its closure where the value
for that variable comes from. For ad-hoc lambdas, this is typically the local scope of its <em>outer function</em>.</br>
Code produced by <code>compile</code>, however, isn&#8217;t associated with any such local scope. All free names are thus assumed
to refer to <em>global</em> variables. Because Python uses different bytecode instructions for referencing local and global
names (<code>LOAD_FAST</code> vs <code>LOAD_GLOBAL</code>), the result of <code>compile</code> may differ from a piece of bytecode produced in the regular
manner.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-get-lambda-code.html#python-get-lambda-code">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/go-decorated-functions.html#go-decorated-functions">Decorated functions in&nbsp;Go</a></h2>
    <p>
      Posted on Fri 04 September 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/go.html">Go</a>,      <a href="http://xion.io/tag/functions.html">functions</a>,      <a href="http://xion.io/tag/decorators.html">decorators</a>      &#8226; <a href="http://xion.io/post/code/go-decorated-functions.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>One of the downsides of working with a simple and minimalistic programming language such as <a href="http://golang.org">Go</a>
is that <a href="http://blog.atte.ro/2015/08/29/golang-code-reuse.html">abstracting for code reuse</a>
is often rather challenging. What&#8217;s brought up most often in this context is Go&#8217;s lack of support for generics
(higher order&nbsp;types).</p>
<p>But here I wanted to talk about a different mechanism that &#8212; unlike generics &#8212; can be transplanted to Go
quite successfully: function&nbsp;decorators.</p>
<h4>Canonical&nbsp;example</h4>
<p>Decorators are most commonly found in Python (where they can be applied not just to functions, but also classes),
but have syntactical analogues in Java (annotations), C# (attributes), and a few other&nbsp;languages.</p>
<p>A <em>decorator</em> looks like a modifier adorning a function definition, distinguished by its initial <code>@</code> sign:</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/home&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;user/home.html&#39;</span><span class="p">)</span>
</pre></div>


<p>Even if you&#8217;re not familiar with the <a href="http://flask.pocoo.org">particular web framework</a> this request handler is meant for
&#8212; or indeed, the Python language itself &#8212; it shouldn&#8217;t be too difficult to figure out what purpose the two decorators&nbsp;serve.</p>
<p>What&#8217;s really important is that their goals are neatly separated from essential logic of the request&nbsp;handler:</p>
<ul>
<li>it doesn&#8217;t have to explicitly check if the user is logged in &#8212; it has the <code>@login_required</code> decorator</li>
<li>it doesn&#8217;t have to be separately registered in some
<a href="https://docs.djangoproject.com/en/1.8/topics/http/urls/#example">centalized <span class="caps">URL</span> routing choke point</a> &#8212;
it has the <code>@app.route</code> decorator&nbsp;instead</li>
</ul>
<p>Such <em>separation of concerns</em> is a desirable quality in software, because it makes it easier
to reason about different aspects of the&nbsp;system.</p>
<h4>Under the&nbsp;hood</h4>
<p>Behind this synctactic sugar and lofty phrasing, the code above is still perfectly equivalent
to its undecorated&nbsp;version:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;Login Required&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;user/home.html&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_url_route</span><span class="p">(</span><span class="s">&#39;/home&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">home</span><span class="p">)</span>
</pre></div>


<p>No source code transformations take place, either: <code>@login_required</code> doesn&#8217;t actually &#8220;inject&#8221; the <code>if</code> statement
at the beginning of <code>home</code> function. What happens instead is that it takes the whole function and <em>wraps it</em>
in a new one which also contains the crucial&nbsp;check:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grossly simplified version of a decorator enforcing user login.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;Login Required&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped</span>
</pre></div>


<p>Given this definition, decorating <code>home</code> simply means passing it to the <code>login_required</code> function, and calling its result
a new <code>home</code>:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;user/home.html&#39;</span><span class="p">)</span>

<span class="n">home</span> <span class="o">=</span> <span class="n">login_required</span><span class="p">(</span><span class="n">home</span><span class="p">)</span>
</pre></div>


<p>As you&#8217;ve probably guessed, the <code>@</code> syntax is nothing else than a syntatic sugar for the above.
But how sweet a sugar it&nbsp;is!</p>
<p><small>(The <code>@app.route</code> decorator is simultaneously simpler and more complicated. I recommend having a direct look at
<a href="https://github.com/mitsuhiko/flask/blob/2446ca63a8d840a35ea4eac02672b24a6fcf406f/flask/app.py#L1040">its source code</a>
for more insight).</small></p>
<h4>What gophers can&nbsp;learn</h4>
<p>Unlike Python, in Go, we are out of luck when it comes to dedicated language support for decorators.
However, the general principle still applies: we can decorate functions by writing &#8212; <em>ahem</em> &#8212; decorator&nbsp;functions.</p>
<p>Consider, for example, a trivial <code>net/http</code> request&nbsp;handler:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">hello</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprint</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hello, world!\n&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>Any real web application will have many similar handlers. They are usually wired to their corresponding <span class="caps">URL</span> paths
during program&nbsp;startup:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="nx">hello</span><span class="p">)</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>


<p>This approach to routing configuration provides an opportunity to decorate some (or all) of the request handlers with
any auxiliary functionality that the application may&nbsp;require.</p>
<h4>Handler in, handler&nbsp;out</h4>
<p>To do that, though, we need to write the necessary decorator functions first. For a simplest possible example,
let&#8217;s create one that automatically fills in the <code>Server:</code> header of <span class="caps">HTTP</span> response with the name and version
of our web&nbsp;application:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">WithServerHeader</span><span class="p">(</span><span class="nx">h</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">Header</span><span class="p">().</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;Server&quot;</span><span class="p">,</span> <span class="s">&quot;HelloServer v0.0.1&quot;</span><span class="p">)</span>
        <span class="nx">h</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Using it is then a simple matter of wrapping the original handler in a decorator&nbsp;call:</p>
<div class="highlight"><pre><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">,</span> <span class="nx">WithServerHeader</span><span class="p">(</span><span class="nx">hello</span><span class="p">))</span>
</pre></div>


<p>As it both accepts and returns a <code>http.HandlerFunc</code> &#8212; a function type matching request handlers&#8217; signatures &#8212;
we don&#8217;t need anything else to be able to wrap our handlers in as many decorators as&nbsp;necessary:</p>
<div class="highlight"><pre><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">WithServerHeader</span><span class="p">(</span><span class="nx">index</span><span class="p">))</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/home&quot;</span><span class="p">,</span> <span class="nx">WithServerHeader</span><span class="p">(</span><span class="nx">LoginRequired</span><span class="p">(</span><span class="nx">home</span><span class="p">)))</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/api/share&quot;</span><span class="p">,</span> <span class="nx">WithServerHeader</span><span class="p">(</span><span class="nx">LoginRequired</span><span class="p">(</span><span class="nx">CsrfProtected</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">Share</span><span class="p">))))</span>
</pre></div>


<p>It&#8217;s possible simply by the means of ordinary function&nbsp;composition.</p>
<h4>Going&nbsp;meta</h4>
<p>Looking at the last line of the example above &#8212; which is made-up but could very well come from actual production code
&#8212; you probably can&#8217;t help but notice that stacking function calls like that creates a somewhat messy amalgamation
of parentheses. Beyond three or four items, a decorator chain such as this one becomes rather unwieldy to&nbsp;follow.</p>
<p>If we&#8217;re concerned about readability, it&#8217;s possible to alleviate the issue by taking another step up
the abstraction ladder. Rather than composing the decorators explicitly, we can write a function that does it for&nbsp;us:</p>
<div class="highlight"><pre><span class="kd">type</span> <span class="nx">HttpHandlerDecorator</span> <span class="kd">func</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span>

<span class="kd">func</span> <span class="nx">Handler</span><span class="p">(</span><span class="nx">h</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">,</span> <span class="nx">decors</span> <span class="o">...</span><span class="nx">HttpHandlerDecorator</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">decors</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">decors</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">decors</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">i</span><span class="p">]</span>  <span class="c1">// iterate in reverse</span>
        <span class="nx">h</span> <span class="p">=</span> <span class="nx">d</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">h</span>
<span class="p">}</span>
</pre></div>


<p>and thus eliminate all the&nbsp;parentheses:</p>
<div class="highlight"><pre><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/api/share&quot;</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">Share</span><span class="p">,</span>
    <span class="nx">WithServerHeader</span><span class="p">,</span> <span class="nx">LoginRequired</span><span class="p">,</span> <span class="nx">CsrfProtected</span><span class="p">))</span>
</pre></div>


<p>This technique proves especially valuable if the decorators themselves are&nbsp;parameterized:</p>
<div class="highlight"><pre><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/api/notifications&quot;</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">Notifications</span><span class="p">,</span>
    <span class="nx">WithServerHeader</span><span class="p">,</span> <span class="nx">LoginRequired</span><span class="p">,</span> <span class="nx">Cached</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)))</span>
</pre></div>


<p>In practice, you may find it valuable to wrap the complete <code>http.HandleFunc</code> call to accept a request handler
along with its decorator chain, or the equivalent of such a call in any of the numerous
<a href="https://corner.squareup.com/2014/05/evaluating-go-frameworks.html">Go web frameworks</a>.</p>
      <a class="btn" href="http://xion.io/post/code/go-decorated-functions.html#go-decorated-functions">Continue reading</a>
  </div>
</article>

  <div class="pagination">
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>