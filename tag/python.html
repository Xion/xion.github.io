<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog &ndash; Tag: Python</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-or-lambda.html#python-or-lambda">&#8230;or&nbsp;lambda?</a></h2>
    <p>
      Posted on Mon 20 June 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/syntax.html">syntax</a>,      <a href="http://xion.io/tag/lambda.html">lambda</a>,      <a href="http://xion.io/tag/operators.html">operators</a>      &#8226; <a href="http://xion.io/post/code/python-or-lambda.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>a.k.a. Curious Facts about Python&nbsp;Syntax</em></p>
<p>In Python 3.3,
a new method has been <a href="https://docs.python.org/3/library/stdtypes.html#str.casefold">added</a> to the <code>str</code> type: <code>casefold</code>.
Its purpose is to return a &#8220;sanitized&#8221; version of the string
that&#8217;s suitable for case-insensitive comparison.
For older versions of Python,
an alternative way that&#8217;s <em>mostly</em> compatible is to use the <code>str.lower</code> method,
which simply changes all letters in the string to&nbsp;lowercase.</p>
<h4>Syntax is&nbsp;hard</h4>
<p>Easy enough for a compatibility shim, right?
That&#8217;s exactly what I thought when I came up with&nbsp;this:</p>
<div class="highlight"><pre><span class="n">casefold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="s">&#39;casefold&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>


<p>Let&#8217;s ignore for a moment
the fact that for a correct handling of <code>unicode</code> objects in Python 2,
a <a href="http://stackoverflow.com/a/32838944/434799">much more sophisticated approach</a> is necessary.
What&#8217;s rather more pertinent is that this simple code <em>doesn&#8217;t parse</em>:</p>
<div class="highlight"><pre>  File &quot;foo.py&quot;, line 42
    getattr(str, &#39;casefold&#39;, None) or lambda s: s.lower()
                                      ^
SyntaxError: invalid syntax
</pre></div>


<p>It&#8217;s not very often that you would produce a <code>SyntaxError</code> with code
that looks perfectly valid to most pythonistas.
The <a href="http://xion.org.pl/2012/04/16/the-infernal-comma/">last time I had it happen</a>,
the explanation was rather surprising and not exactly trivial to come&nbsp;by.</p>
<p>Fortunately, there is always one place
where we can definitively resolve any syntactic confusion.
That place is the <a href="https://docs.python.org/2/reference/grammar.html">full grammar specification</a>
of the Python&nbsp;language.</p>
<p>It may be a little intimidating at first,
especially if you&#8217;re not familiar with the <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_Form"><span class="caps">ENBF</span> notation</a> it uses.
All the Python&#8217;s language constructs are there, though,
so the <code>SyntaxError</code> from above should be traceable to a some rule of the grammar<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>The&nbsp;culprit</h4>
<p>And indeed, the offending bit is right&nbsp;here:</p>
<div class="highlight"><pre>or_test: and_test (&#39;or&#39; and_test)*
and_test: not_test (&#39;and&#39; not_test)*
...
</pre></div>


<p>It says, essentially, that Python defines the <code>or</code> expression (<code>or_test</code>)
as a sequence of <code>and</code> expressions (<code>and_test</code>).
If you follow the syntax definition further, however,
you will notice that <code>and_test</code> expands to
comparisons (<code>a &lt; b</code>, etc.),
arithmetic expressions (<code>x + y</code>, etc.),
<code>list</code> <span class="amp">&amp;</span> <code>dict</code> constructors (<code>[foo, bar]</code>, etc.),
and finally to <em>atoms</em> such as literal strings and&nbsp;numbers.</p>
<p>What you <em>won&#8217;t</em> see along the way are lambda&nbsp;definitions:</p>
<div class="highlight"><pre>lambdef: &#39;lambda&#39; [varargslist] &#39;:&#39; test
</pre></div>


<p>In fact, the branch to allow them is directly above the <code>or_test</code>:</p>
<div class="highlight"><pre>test: or_test [&#39;if&#39; or_test &#39;else&#39; test] | lambdef
</pre></div>


<p>As you can see, the rule puts lambdas at the same syntactical level as conditional expressions
(<code>x if a else b</code>), which is <em>very</em> high up.
The only thing you can do with a <code>lambda</code> to make a larger expression
is to add a <code>yield</code> keyword before it<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>, or follow it with a comma to create a tuple<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.</p>
<p>You cannot, however, pass it as an argument to a binary operator,
even if it otherwise makes sense and even <em>looks</em> unambiguous.
This is also why the nonsensical expressions such as this&nbsp;one:</p>
<div class="highlight"><pre><span class="mi">1</span> <span class="o">+</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span>
</pre></div>


<p>will fail not with <code>TypeError</code>, but also with <code>SyntaxError</code>,
as they won&#8217;t even be&nbsp;evaluated.</p>
<h4>More&nbsp;parentheses</h4>
<p>Savvy readers may have noticed that this phenomenon is very much reminiscent
of the issue of <em>operator precedence</em>.</p>
<p>Indeed, in Python and in many other languages it is the grammar
that ultimately specifies the order of operations.
It does so simply by defining how expressions can be&nbsp;constructed.</p>
<p>Addition, for example, will be of lower priority than multiplication
simply because a <em>sum</em> is said to comprise of terms that are <em>products</em>:</p>
<div class="highlight"><pre>arith_expr: term ((&#39;+&#39;|&#39;-&#39;) term)*
term: factor ((&#39;*&#39;|&#39;/&#39;|&#39;%&#39;|&#39;//&#39;) factor)*
</pre></div>


<p>This makes operator precedence a syntactic feature,
and its resolution is baked into the language parser and handled implicitly<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>.</p>
<p>We know, however, that precedence can be worked around where necessary
by enclosing the operator and its arguments in a pair of parenthesis.
On the syntax level, this means creating an entirely new, top-level&nbsp;expression:</p>
<div class="highlight"><pre>atom: &#39;(&#39; [yield_expr|testlist_comp] &#39;)&#39; |  # parenthesized expression
       &#39;[&#39; [listmaker] &#39;]&#39; |
       &#39;{&#39; [dictorsetmaker] &#39;}&#39; |
       &#39;`&#39; testlist1 &#39;`&#39; |
       NAME | NUMBER | STRING+)
</pre></div>


<p>There, it is again possible to use even the highest-level constructs,
including also the silly stuff such as trying to add a number to a&nbsp;function:</p>
<div class="highlight"><pre><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>This expression will now parse correctly,
 and produce <code>TypeError</code> as&nbsp;expected.</p>
<p>In the end, the resolution of our initial dilemma is therefore rather&nbsp;simple:</p>
<div class="highlight"><pre><span class="n">casefold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="s">&#39;casefold&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</pre></div>


<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Such rules are sometimes called <em>productions</em> of the grammar,
a <a href="https://en.wikipedia.org/wiki/Production_%28computer_science%29">term</a> from computational linguistics.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Yes, <code>yield foo</code> is an expression.
Its result is the value sent <em>to</em> the generator by outer code via the <code>send</code> method.
Since most generators are used as iterables, typically no values are passed this way
so the result of a <code>yield</code> expression is <code>None</code>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>There are also a legacy corner cases of lambdas in <code>list</code>/<code>dict</code>/etc. comprehensions,
but those only apply under Python 2.x.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>This saying, there are languages where the order is resolved at later stage,
after the expressions have already been parsed. They usually allow the programmer
to change the precedence of their own operators,
as it&#8217;s the case in <a href="https://www.haskell.org/tutorial/functions.html#sect3.2.2">Haskell</a>.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-or-lambda.html#python-or-lambda">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/python-dont-use-click.html#python-dont-use-click">Please don&#8217;t use&nbsp;Click</a></h2>
    <p>
      Posted on Fri 20 May 2016 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/cli.html">CLI</a>,      <a href="http://xion.io/tag/ui.html">UI</a>,      <a href="http://xion.io/tag/click.html">Click</a>      &#8226; <a href="http://xion.io/post/programming/python-dont-use-click.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>&#8230;not for standalone programs&nbsp;anyway.</em></p>
<p>Chances are, you have written some command line programs in Python. This is quite probable even if you normally code
in some other language. And if you have, it is not unlikely that you needed to parse the <code>argv</code> of your program at one
point or&nbsp;another.</p>
<p>There are plenty of options here, both in the standard library as well as among third party packages. One does stand out,
however, and it&#8217;s mostly for how it is often overused. I&#8217;m talking about <a href="http://click.pocoo.org/">Click</a>&nbsp;here.</p>
<p>If you wanted to use it in your next Python program, I hereby urge you to&nbsp;reconsider.</p>
<h4>What&#8217;s the&nbsp;fuss?</h4>
<p><img style="float:right; margin-left: 8px; margin: bottom: 7px" src="http://xion.io/images/click-logo.png" alt="click_">
The somewhat bizarrely named Click library is described as a &#8220;package for creating beautiful
command line interfaces&#8221;. Its main trick is the ability to create subcommands by adorning Python functions with the
<code>@click.command()</code> decorator<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. It then makes them coalesce into an argument parser, equipped with the necessary
dispatching&nbsp;logic.</p>
<p>This idea isn&#8217;t new, of course. Prior art goes back at least seven years to the now-abandoned
<a href="https://opster.readthedocs.io">opster</a> package. Click, however, was the first one of its kind to garner noticeable
popularity, which is easily attributed to <a href="http://lucumr.pocoo.org/">whom it&#8217;s been authored by</a>.</p>
<p>So while my arguments against using this kind of <span class="caps">CLI</span> framework would apply to any package implementing the paradigm,
it just happens that Click is currently its most prominent example. Purely for the sake of convenience, I will therefore
refer to it as if it was interchangeable with the whole concept. Because why not? Whatever you may say about
the library&#8217;s name, it&#8217;s hard to imagine a more concise moniker than a simple <em>Click</em>.</p>
<p>What&#8217;s wrong, then, with the way Click handles command line&nbsp;interfaces?</p>
<h4><span class="caps">CLI</span>: Little&nbsp;Interfaces</h4>
<p>It&#8217;s how it encourages to treat them as an <em>accidental afterthought</em> rather than a deliberate design&nbsp;decision.</p>
<p>For applications invoked repeatedly from a terminal, their command line arguments and flags are the primary means of
user interaction<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. It is how users communicate their intent to perform an action; provide the neccessary input data
to carry it throgh; decide how they want to receive the output; and control many other aspects of the programs execution.
Absent graphical components and widgets, the command line is virtually the only way to interact with a terminal&nbsp;program.</p>
<p>In other words, it is <strong>the <span class="caps">UI</span></strong>.</p>
<p>And how important the <span class="caps">UI</span> is for <em>any</em> application? It seems to be important enough that entire fields of study are devoted
to reducing friction of human-computer interaction. In many projects, the emphasis on user interface design is on par
with that of actual software engineering.<br>
Like everything, of course, it is susceptible to trends and fads (such as the recent &#8220;mobile/responsive everything!&#8221;
craze). But its significance remains undiminished. Quite the opposite: in the age of ubiquitous computing,
user interfaces are probably more important than&nbsp;ever.</p>
<p>Yes, this includes <span class="caps">CLI</span>. One of the main reasons we turn to the command line are <em>speed</em> and <em>efficacy</em>. Common tasks must
utilize short and convenient syntax that is quick to integrate into user&#8217;s muscle memory. Others should not only be
possible, but <em>discoverable</em> and <em>accessible</em> without going through reams of <code>man</code> pages.</p>
<p>Any terminal program intended for frequent use by humans should therefore strive to excel in those two qualities.
But except for <a href="http://linux.die.net/man/1/echo">the simplest of cases</a>, it won&#8217;t happen by itself.
Designing an efficient <span class="caps">CLI</span> for any non-trivial application is a challenging and demanding&nbsp;task.</p>
<h4>It doesn&#8217;t&nbsp;click</h4>
<p>With Click, however, we&#8217;re encouraged to just wing&nbsp;it.</p>
<p>Click tells us to slap some decorators on our top-level functions and call it a day. Sure, you can dig deep enough
and uncover the underlying layers of abstraction that may eventually allow you do things for which <code>argparse</code> has
a <a href="https://docs.python.org/3/library/argparse.html#mutual-exclusion">first-class support</a>.</p>
<p>By default, however, Click shoehorns your programs into
<a href="http://click.pocoo.org/5/quickstart/#basic-concepts">predefined patterns</a> that, incidentally, mirror those of some
<a href="http://click.pocoo.org/5/complex/#building-a-git-clone">least intuitive</a> command-line tools in&nbsp;existence.</p>
<p>Indeed, the whole idea of subdiving your program into several distinct is already suspect, for it appears at odds
with the fundamental Unix philosophy of
<a href="https://en.wikipedia.org/wiki/Unix_philosophy#Do_One_Thing_and_Do_It_Well">doing one thing well</a>. While it is
occasionally justified, it shouldn&#8217;t be the first thing that comes to your mind. But that&#8217;s completely at odds with the
Click&#8217;s approach, where <em>not</em> ending up with multiple distinct commands is something you have to consciously&nbsp;avoid.</p>
<h4>&#8230;though it sometimes&nbsp;might</h4>
<p>So, what <em>am</em> I suggesting you use instead libraries such as Click?&#8230; Nothing outrageous,&nbsp;really.</p>
<p>If you care about your command line interface, consider just using
<a href="https://docs.python.org/3/library/argparse.html">the <code>argparse</code> module</a>. Yes, it will force you to create parser objects,
add arguments <span class="amp">&amp;</span> flags to it, and in general pay some attention to the whole business. When it comes to <span class="caps">UI</span>, it&#8217;s always
good to make it an explicit concern, maybe even sufficient to warrant
<a href="https://github.com/Xion/gisht/blob/e86af37388573f00a4d6f282feca76ead88725d8/gisht/args/parser.py">its own module</a>.</p>
<p>Alternatively, the <a href="https://github.com/docopt/docopt"><code>docopt</code> library</a> provides another take on the <span class="caps">UI</span>-first approach
to <span class="caps">CLI</span>, though it is more limited in its capabilities<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.</p>
<p>Finally, I&#8217;m not advocating to ditch Click in <em>all</em> scenarios. There&#8217;s plenty of situations when we&#8217;re interested in
getting <em>any</em> <span class="caps">CLI</span> up and running, and not so much in making the most efficient and intuitive interface possible. The prime
example is any kind of automation scripts that are ancillary to some bigger project, like <em>manage.py</em> is in Django<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>.
The Python ecosystem doesn&#8217;t really have dedicated task runners that are as featureful as <a href="http://gruntjs.com">Grunt</a>
or <a href="http://gulpjs.com/">Gulp</a>, and that makes Click a viable and compelling option<sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup>.</p>
<p>But for standalone programs whose <span class="caps">CLI</span> is the main interface? Yeah, not&nbsp;really.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Oddly enough, that pair of parentheses seems to be mandatory.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Environment variables and config files deserve a honorary mention, of course. But those are usually derivatives of
the command line arguments, containing e.g. the default values for flags.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Click&#8217;s <a href="http://click.pocoo.org/5/why/#why-not-docopt-etc">own documentation</a> actually describes quite nicely
how theirs and docopt&#8217;s philosophies differ in a way that&#8217;s consistent with this article.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Incidentally, this appears to be a major motivation behind creating Click in the first place:
to support web applications built upon on the <a href="http://flask.pocoo.org/">Flask</a> framework, and possibly obviate the need
for extensions such as <a href="http://flask-script.readthedocs.io/en/latest/">Flask-Script</a>.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>This saying, there are some task runners which offer similar experience, like <a href="http://pyinvoke.org">Invoke</a>.&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/programming/python-dont-use-click.html#python-dont-use-click">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-mock-configure.html#python-mock-configure">Mock.configure_mock fix for&nbsp;Python</a></h2>
    <p>
      Posted on Sat 07 May 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/mock.html">mock</a>,      <a href="http://xion.io/tag/patching.html">patching</a>      &#8226; <a href="http://xion.io/post/code/python-mock-configure.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Python&#8217;s <a href="https://docs.python.org/3/library/unittest.mock.html">mocking library</a> is rather uncomplicated.
Most of what it does is creating <em>mock objects</em>: veritable sponges that absorb every interaction with any code
that we pass them&nbsp;to.</p>
<p>This simplicity is also surfaced in the <span class="caps">API</span>, especially in the main part of it &#8212; the <code>mock.Mock</code> constructor:</p>
<div class="highlight"><pre><span class="n">some_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">&#39;http://example.com&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">some_mock</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s">&#39;http://example.com&#39;</span>
</pre></div>


<p>Any arguments that we pass there become attributes on the resulting mock object. This is really useful when
<a href="https://docs.python.org/3/library/unittest.mock.html#the-patchers">patching</a>, because it allows us to completely specify
the replacement object within a <code>@mock.patch</code> decorator:</p>
<div class="highlight"><pre><span class="nd">@patch.object</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">Mock</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">test_404</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">NotFoundError</span><span class="p">):</span>
        <span class="n">do_stuff</span><span class="p">()</span>
</pre></div>


<p>You have to keep in mind, however, that the <code>mock.Mock</code> class also has some
<a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock">constructor arguments</a> of its own.
For this reason, there exists some potential for name collision: some of the <code>Mock</code><span class="quo">&#8216;</span>s own arguments may have the same
names as the <em>attributes</em> we&#8217;d like to set on the mock&nbsp;object:</p>
<div class="highlight"><pre><span class="n">some_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;John Doe&quot;</span><span class="p">)</span>  <span class="c"># doesn&#39;t set the `name` attribute</span>
<span class="k">assert</span> <span class="n">some_mock</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;John Doe&quot;</span>  <span class="c"># blows up!</span>
</pre></div>


<p>Here, the <code>name</code> argument is inherent to the <code>Mock</code> class. Its constructor will interpret it in a special way,
and so it <em>won&#8217;t</em> set a <code>name</code> attribute on the resulting mock. Other possible culprits include the <code>spec</code> and <code>wraps</code>
parameters, both of which have relatively common names that we may want to use as object attributes<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>Collision&nbsp;avoidance</h4>
<p>It&#8217;s trivial to fix the issue, of&nbsp;course:</p>
<div class="highlight"><pre><span class="n">some_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
<span class="n">some_mock</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;John Doe&quot;</span>
<span class="k">assert</span> <span class="n">sock_mock</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;John Doe&quot;</span>
</pre></div>


<p>but this approach has a downside. Creating and configuring a mock is no longer a single expression, which means we cannot
use it with patchers as easily as&nbsp;before:</p>
<div class="highlight"><pre><span class="nd">@patch.object</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_bar</span><span class="p">):</span>
    <span class="n">mock_bar</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;John Doe&quot;</span>
    <span class="c"># (...rest of the test...)</span>
</pre></div>


<p>We can either configure the mock after patching, like above, or perhaps introduce some utility functions to be called
inside the <code>@patch</code> decorator.</p>
<h4>The almost-there&nbsp;method</h4>
<p>In any case, this is somewhat disappointing. And it is even more so when we discover that there is
<a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock.configure_mock">a method called <code>configure_mock</code></a>
which <em>looks</em> like it was designed to solve this very issue. Its arguments are always interpreted as attributes
of the mock: it has no &#8220;special&#8221; or &#8220;reserved&#8221; names. Indeed, this method is what allows us to actually
write the mock setup as a single&nbsp;expression:</p>
<div class="highlight"><pre><span class="n">some_mock</span><span class="o">.</span><span class="n">configure_mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;John Doe&quot;</span><span class="p">)</span>
</pre></div>


<p>Problem is, this expression returns <code>None</code>.</p>
<p>Yes, <code>configure_mock</code> returns nothing.<br>
Or in other words, it doesn&#8217;t return anything.<br>
In fact, it has <a href="https://github.com/testing-cabal/mock/blob/286792b2cd5b5baa8338260538ed207391280e34/mock/mock.py#L671">no <code>return</code> statement</a>&nbsp;whatsoever.</p>
<p>Most importantly, it doesn&#8217;t have the <code>return self</code> line that&#8217;d enable us to write&nbsp;this:</p>
<div class="highlight"><pre><span class="n">some_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span><span class="o">.</span><span class="n">configure_mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;John Doe&quot;</span><span class="p">)</span>
</pre></div>


<p>Well, that is <em>quite</em> a&nbsp;let-down.</p>
<h4>Fixing&nbsp;it</h4>
<p>But hey, this is Python! Shortcomings like that don&#8217;t necessarily mean we have to fork whole libraries.
Let&#8217;s just add the missing <code>return</code>, shall&nbsp;we?</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">Mock</span> <span class="k">as</span> <span class="n">_Mock</span>

<span class="k">class</span> <span class="nc">Mock</span><span class="p">(</span><span class="n">_Mock</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">configure_mock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">configure_mock</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c"># &lt;-- there!</span>
</pre></div>


<p>Whew, that was&nbsp;quick!</p>
<p>&#8230;Alright, that&#8217;s actually the <em>whole</em> fix, but it&#8217;s close. To complete it, we need to apply the same treatment to
three more <code>Mock</code> classes: <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.MagicMock"><code>MagicMock</code></a>,
<a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.NonCallableMock"><code>NonCallableMock</code></a>,
and <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.NonCallableMagicMock"><code>NonCallableMagicMock</code></a>.</p>
<p>A complete solution can be seen in <a href="https://gist.github.com/Xion/8b98733d4b6be354be0ebae815ebd22d">this gist</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Collision may also occur with <code>mock.patch</code> constructs. The most likely offender there is probably
the <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch"><code>new</code> parameter</a>.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-mock-configure.html#python-mock-configure">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-get-lambda-code.html#python-get-lambda-code">Source code of a Python&nbsp;lambda</a></h2>
    <p>
      Posted on Tue 19 April 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/functions.html">functions</a>,      <a href="http://xion.io/tag/ast.html">AST</a>,      <a href="http://xion.io/tag/bytecode.html">bytecode</a>      &#8226; <a href="http://xion.io/post/code/python-get-lambda-code.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>&#8230;or: The Most Hideous Hack I&#8217;ve (Almost)&nbsp;Done</em></p>
<p>In <a href="http://github.com/Xion/callee">callee</a>, the <a href="http://callee.readthedocs.org">argument matcher library for Python</a> that
<a href="http://xion.io/post/news/callee-intro.html">I released recently</a>, there is this lovely
<a href="https://github.com/Xion/callee/blob/f695ff4e1c45bfd45445ebb8014a202029a93dce/callee/general.py#L55"><code>TODO</code> note</a>
for a seemingly simple feature. When using the
<a href="http://callee.readthedocs.org/en/stable/reference/general.html#callee.general.Matching"><code>Matching</code> construct</a>
with a simple <code>lambda</code> predicate:</p>
<div class="highlight"><pre><span class="n">mock_foo</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">Matching</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>


<p>it would be great to see its <em>code</em> in the error message if the assertion fails. Right now it&#8217;s just going to say
something like <code>&lt;Matching &lt;function &lt;lambda&gt; at 0x7f5d8a06eb18&gt;&gt;</code>. Provided you don&#8217;t possess a supernatural ability
of dereferencing pointers in your head, this won&#8217;t give you any immediate hint as to what went wrong. Wouldn&#8217;t it be nice
if it read as, say, <code>&lt;Matching \x: x % 2&gt;</code> instead?<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<p>So I thought: why not try and implement such a mechanism? This is Python, after all &#8212; a language where you can spawn
<a href="https://blog.ionelmc.ro/2015/02/09/understanding-python-metaclasses/#simple-metaclass-use">completely new classes</a>
at runtime, walk the stack <a href="https://docs.python.org/2/library/inspect.html#the-interpreter-stack">backwards</a>
(or even <a href="https://docs.python.org/2/library/sys.html#sys.settrace">forward</a>) and read the local variables,
or change the behavior of the <a href="http://xion.org.pl/2012/05/06/hacking-python-imports/">import system itself</a>.
Surely it would be possible &#8212; nay, easy &#8212; to get the source code of a short lambda function,&nbsp;right?</p>
<p>Boy, was I <em>wrong</em>.</p>
<p>Make no mistake, though: the task turned out to be absolutely doable, at least in the scope I wanted it done.
But what would you think of a solution that involves not just the usual Python hackery, but also <span class="caps">AST</span> inspection,
transformations of the source code as text, <em>and</em> bytecode&nbsp;shenanigans?&#8230;</p>
<h4>The code, all the code, and&#8230; much more than the&nbsp;code</h4>
<p>Let&#8217;s start from the beginning, though. Here&#8217;s a short lambda function, the kind of which we&#8217;d like to obtain
the source code&nbsp;of:</p>
<div class="highlight"><pre><span class="n">is_even</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>


<p>If the documentation for Python standard library is to be believed, this should be pretty easy.
In the <a href="https://docs.python.org/2/library/inspect.html"><code>inspect</code> module</a>,
there is a function called no different than
<a href="https://docs.python.org/2/library/inspect.html#inspect.getsource"><code>getsource</code></a>. For our purposes, however,
<a href="https://docs.python.org/2/library/inspect.html#inspect.getsourcelines"><code>getsourcelines</code></a> is a little more
convienient, because we can easily tell when the lambda is too&nbsp;long:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_short_lambda_source</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source_lines</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>


<p>Of course if you programmed in Python for any longer period of time, you know very well that the standard docs
are <em>not</em> to be trusted. And it&#8217;s not just that the <code>except</code> clause should also include <code>TypeError</code>, because it
will be thrown when you try to pass any of the Python builtins to <code>getsourcelines</code>.</p>
<p>More important is the ambiguity of what does &#8220;source lines for an object&#8221; actually mean. &#8220;Source lines <em>containing</em>
the object definition&#8221; would be much more accurate, and this seemingly small distinction is rather crucial here.
Passing a lambda function to either <code>getsourcelines</code> or <code>getsource</code>, we&#8217;ll get its source <em>and everything else</em>
that the returned lines&nbsp;included.</p>
<p>That&#8217;s right. Say hello to the complete <code>is_even =</code> assignment, and the entire <code>assert_called_with</code> invocation!
And in case you are wondering: yes, the result will also include any end-of-line comments. No token left&nbsp;behind!</p>
<h4>Trim&nbsp;left</h4>
<p>Clearly this is more than we&#8217;ve bargained for. Maybe there is a way to strip away the unnecessary cruft? Python does
know how to parse itself, after all: the standard <a href="https://docs.python.org/2/library/ast.html"><code>ast</code> module</a>
is a manifestation of this knowledge. Perhaps we can use it to retrieve the <code>lambda</code> <span class="caps">AST</span> node in order to turn it &#8212;
and just it &#8212; back into Python&nbsp;code?&#8230;</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_short_lambda_ast_node</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">):</span>
    <span class="n">source_text</span> <span class="o">=</span> <span class="n">get_short_lambda_source</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source_text</span><span class="p">:</span>
        <span class="n">source_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_ast</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">)),</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>But as it turns out, getting the source text back this way is only <em>mostly</em>&nbsp;possible.</p>
<p>See, every substantial <span class="caps">AST</span> node &#8212; which is either an expression (<code>ast.expr</code>) or a statement (<code>ast.stmt</code>) &#8212;
has two common attributes: <code>lineno</code> and <code>col_offset</code>. When combined, they point to a place in the original source code
where the node was parsed from. This is how we can find out where to look for the definition of our lambda&nbsp;function.</p>
<p>Looks promising, right? The only problem is we don&#8217;t know when to <em>stop</em> looking.
That&#8217;s right: nodes created by <code>ast.parse</code> are annotated with their start offset, but not with length nor the end offset.
As a result, the best we can do when it comes to carving out the lambda source from the very first example is&nbsp;this:</p>
<div class="highlight"><pre><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>


<p>So close! Those hanging parentheses are evidently just taunting us, but how can we remove them? <code>lambda</code> is basically
just a Python expression, so in principle it can be followed by almost anything. This is doubly true for lambdas inside
the <code>Matching</code> construct, as they may be a part of some larger mock&nbsp;assertion:</p>
<div class="highlight"><pre><span class="n">mock_foo</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">Matching</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Integer</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">GreaterThan</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
</pre></div>


<p>Here, the extraneous suffix is the entirety of <code>), Integer() &amp; GreaterThan(42))</code>, quite a lot of more than just <code>))</code>.
And that&#8217;s of course nowhere near the limit of possiblities: for one, there may be more <code>lambda</code>s in there,&nbsp;too!</p>
<h4>Back off, <em>slowly</em></h4>
<p>It seems, however, that there is one thing those troublesome tails have in common: <em>they aren&#8217;t syntactically valid</em>.</p>
<p>Intuitively, a <code>lambda</code> node nested within some other syntactical constructs will have their closing fragments (e.g. <code>)</code>)
appear somewhere after its end. Without the corresponding openings (e.g. <code>Matching(</code>), those fragments won&#8217;t&nbsp;parse.</p>
<p>So here&#8217;s the crazy idea. What we have is invalid Python, but only because of some unspecified number of extra characters.
How about we just try and remove them, one by one, until we get something that <em>is</em> syntactically correct?
If we are not mistaken, this will finally be our lambda and nothing&nbsp;else.</p>
<p>The fortune favors the brave, so let&#8217;s go ahead and try&nbsp;it:</p>
<div class="highlight"><pre><span class="c"># ... continuing get_short_lambda_source() ...</span>

<span class="n">source_text</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">lambda_node</span> <span class="o">=</span> <span class="n">get_short_lambda_ast_node</span><span class="p">(</span><span class="n">lambda_func</span><span class="p">)</span>

<span class="n">lambda_text</span> <span class="o">=</span> <span class="n">source_text</span><span class="p">[</span><span class="n">lambda_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">:]</span>
<span class="n">min_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;lambda:_&#39;</span><span class="p">)</span>  <span class="c"># shortest possible lambda expression</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_length</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">lambda_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lambda_text</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="n">lambda_text</span> <span class="o">=</span> <span class="n">lambda_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>Considering that we&#8217;re basically taking lessons from the dusty old tomes in the Restricted Section of Hogwarts library,
the magic here looks quite simple. As long as there is something that can pass for a lambda definition,
we try to parse it and see if it succeeds. The line that says <code>except SyntaxError:</code> is obviously not something for
the faint of heart, but at least we are specifying
<a href="https://docs.python.org/2/howto/doanddont.html#except"><em>what</em> exception</a> we anticipate&nbsp;catching.</p>
<p>And the kicker? It <em>works</em>. By that I mean it doesn&#8217;t return garbage results for a few obvious and not so obvious
test cases, which is already more than you would normally expect from hacks of this magnitude.
All the lambdas defined until this paragraph, for example, can have their source code extracted without&nbsp;issue.</p>
<h4>Just one more&nbsp;thing</h4>
<p>So&#8230; victory? Not quite. Astute readers may recall my promise of some bytecode arcana, and now&#8217;s the time for&nbsp;it.</p>
<p>Despite the initial success of our gradual, character dropping approach, there are cases where it doesn&#8217;t produce
the correct result. Consider, for example, a lambda definition that&#8217;s nestled within a tuple<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_short_lambda_source</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>


<p>We would of course expect the result to be <code>lambda _: True</code>, without a comma or&nbsp;zero.</p>
<p>Unfortunately, here&#8217;s where our earlier assumption fails rather spectacularly. The line of code extracted from <span class="caps">AST</span>
is syntactically valid even <em>with</em> the extra characters. As a result, <code>ast.parse</code> succeeds too early and returns an
incorrect definition. It should have been of a lambda contained within a tuple, but tuple is apparently what the lambda
<em>returns</em>.</p>
<p>You may say that this is the sharp end of a narrow edge case, and anyone who defines functions like that deserves all
the trouble they get. And sure, I wouldn&#8217;t mind if we just threw hands in the air and tell them we&#8217;re simply unable
to retrieve the source here. But my opinion is that it doesn&#8217;t justify serving them obviously <em>wrong</em>&nbsp;results!</p>
<h4>A halting&nbsp;problem</h4>
<p>Not if we can help it, anyway. Have a look at the expected source code and the one we&#8217;ve extracted, side by&nbsp;side:</p>
<div class="highlight"><pre><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span>
<span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>


<p>The second line isn&#8217;t just longer: it is also <em>doing more</em>. It isn&#8217;t just defining a lambda; it defines it,
conjures up a constant <code>0</code>, and then packs them both into a tuple. That&#8217;s at least two additional steps compared to
the&nbsp;original.</p>
<p>Those steps have a more precise name, too: they are the <em>bytecode instructions</em>. Every piece of Python source is compiled
to a binary bytecode before it&#8217;s executed, because the interpreter can only work with this representation.
Compilation typically happens when a Python module is first imported, producing a <em>.pyc</em> file corresponding to its
<em>.py</em> file. Subsequent imports will simply reuse the cached&nbsp;bytecode.</p>
<p>Moreover, any function or class object has its bytecode accessible (read-only) at runtime. There is even a
<a href="http://late.am/post/2012/03/26/exploring-python-code-objects.html">dedicated data type</a> to hold it &#8212; called simply
<code>code</code> &#8212; with a buffer of raw bytes under one of its&nbsp;attributes.</p>
<p>Finally, the bytecode compiler itself is also available to Python programs as a built-in
<a href="https://docs.python.org/2/library/functions.html#compile"><code>compile</code> function</a>. You don&#8217;t see it used as often as its
counterparts <a href="https://docs.python.org/2/library/functions.html#eval"><code>eval</code></a>
and <a href="https://docs.python.org/2/reference/simple_stmts.html#exec"><code>exec</code></a> (which hopefully are a rare sight themselves!),
but it taps into the same internal machinery of&nbsp;Python.</p>
<p>So how does it all add up? The idea is, basically, to cross-check the alleged source code of the lambda with its own
<em>byte</em>code. Any junk that&#8217;s still left to trim &#8212; even if syntactically valid &#8212; will surface as a divergence after
compilation. Thus we can simply continue dropping characters until the bytecodes&nbsp;match:</p>
<div class="highlight"><pre><span class="n">lambda_text</span> <span class="o">=</span> <span class="n">source_text</span><span class="p">[</span><span class="n">lambda_node</span><span class="o">.</span><span class="n">col_offset</span><span class="p">:]</span>
<span class="n">lambda_body_text</span> <span class="o">=</span> <span class="n">source_text</span><span class="p">[</span><span class="n">lambda_node</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">col_offset</span><span class="p">:]</span>
<span class="n">min_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;lambda:_&#39;</span><span class="p">)</span>  <span class="c"># shortest possible lambda expression</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_length</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">lambda_body_text</span><span class="p">,</span> <span class="s">&#39;&lt;unused filename&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">co_code</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lambda_func</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_code</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lambda_text</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">lambda_text</span> <span class="o">=</span> <span class="n">lambda_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lambda_body_text</span> <span class="o">=</span> <span class="n">lambda_body_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>Okay, maybe not the exact bytes<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>, but stopping at the identical bytecode <em>length</em> is good enough a strategy.
As an obvious bonus, <code>compile</code> will also take care of detecting syntax errors in the candidate source code,
so we don&#8217;t need the <code>ast</code> parsing&nbsp;anymore.</p>
<h4>That escalated&nbsp;quickly!</h4>
<p>Believe it or not, but there aren&#8217;t any more objections to this solution, You can view it in its glorious entirety
by looking at <a href="https://gist.github.com/Xion/617c1496ff45f3673a5692c3b0e3f75a">this gist</a>.</p>
<p>Does it mean it is also making its cameo in the <a href="https://github.com/Xion/callee"><em>callee</em> library</a>?&#8230;</p>
<p>No, I&#8217;m afraid&nbsp;not.</p>
<p>Normally, I&#8217;m not the one to shy away from, ahem, <em>bold</em> solutions to tough problems. But in this case, the magnitude
of hackery required is just too great, the result not satisfactory enough, the feature&#8217;s priority isn&#8217;t really
all that high, and the maintenance burden it&#8217;d introduce is most likely too&nbsp;large.</p>
<p>In the end, it was great fun figuring it out: yet another example of how you can fiddle with Python to do basically
anything. Still, we must not get too preoccupied with whether or not we can as to forget if we <em>should</em>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Backslash (<code>\</code>) is how lambda functions are denoted in Haskell. We want to be short and sweet, so it feels
like a natural choice.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This isn&#8217;t an actual snippet from a Python <span class="caps">REPL</span>, because <code>inspect.getsourcelines</code> requires the object to be
defined in a <em>.py</em> file.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Why we won&#8217;t always get an identical bytecode? The short answer is that some instructions may be swapped
for their approximate equivalents.<br/>
The long answer is that with <code>compile</code>, we aren&#8217;t able to replicate the exact closure environment of the original lambda.
When a function refers to an <em>free variable</em> (like <code>foo</code> in <code>lambda x: x + foo</code>), it is its closure where the value
for that variable comes from. For ad-hoc lambdas, this is typically the local scope of its <em>outer function</em>.</br>
Code produced by <code>compile</code>, however, isn&#8217;t associated with any such local scope. All free names are thus assumed
to refer to <em>global</em> variables. Because Python uses different bytecode instructions for referencing local and global
names (<code>LOAD_FAST</code> vs <code>LOAD_GLOBAL</code>), the result of <code>compile</code> may differ from a piece of bytecode produced in the regular
manner.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-get-lambda-code.html#python-get-lambda-code">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/news/callee-intro.html#callee-intro">Introducing callee: matchers for&nbsp;unittest.mock</a></h2>
    <p>
      Posted on Sun 20 March 2016 in <a href="http://xion.io/category/news.html">News</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/testing.html">testing</a>,      <a href="http://xion.io/tag/mock.html">mock</a>,      <a href="http://xion.io/tag/argument-matchers.html">argument matchers</a>      &#8226; <a href="http://xion.io/post/news/callee-intro.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Combined with dynamic typing, the lax object model of Python makes it pretty easy to write unit tests that involve
<em>mocking</em> some parts of the tested code. Still, there&#8217;s plenty of third party libraries &#8212; usually with &#8220;mock&#8221; somewhere
in the name &#8212; which promise to make it even shorter and simpler. There&#8217;s evidently been a need here that the standard
library didn&#8217;t address&nbsp;adequately.</p>
<p>It changed, however, with Python 3.3. This version introduced a new
<a href="https://docs.python.org/3/library/unittest.mock.html"><code>unittest.mock</code> module</a> which essentially obsoleted
all the other, third party solutions. The module, available also as a <a href="https://pypi.python.org/pypi/mock">backport</a>
for Python 2.6 and above, is flexible, easy to use, and offers most if not all of the requisite&nbsp;functionality.</p>
<h4>Called it,&nbsp;maybe?</h4>
<p>Well, with one notable exception. If we mock a function, or any other callable&nbsp;object:</p>
<div class="highlight"><pre><span class="c"># (production code)</span>
<span class="k">class</span> <span class="nc">ProductionClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">florb</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c"># (test code)</span>
<span class="n">something</span> <span class="o">=</span> <span class="n">ProductionClass</span><span class="p">()</span>
<span class="n">something</span><span class="o">.</span><span class="n">florb</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
</pre></div>


<p>we have very limited capabilities when it comes to verifying <em>how</em> they were called. Sure, we can be extremely&nbsp;specific:</p>
<div class="highlight"><pre><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s">&#39;this particular string&#39;</span><span class="p">)</span>
</pre></div>


<p>or very&nbsp;lenient:</p>
<div class="highlight"><pre><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>  <span class="c"># works for _any_ argument</span>
</pre></div>


<p>but there is virtually nothing in between. Suppose we don&#8217;t care too much what <em>exact</em> string the method was called with,
only that it was <em>some</em> string that&#8217;s long enough? Things get awkward <em>very</em> fast&nbsp;then:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">posargs</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">:</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">posargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertGreaterEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;required call to </span><span class="si">%r</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="p">,))</span>
</pre></div>


<p>Yes, this is what&#8217;s required: an actual loop through all the mock&#8217;s calls<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>; unpacking tuples of positional and keyword
arguments; and manual assertions that won&#8217;t even emit useful error messages when they&nbsp;fail.</p>
<p>Eww! Surely Python can do better than&nbsp;that?</p>
<h4>Meet <code>callee</code></h4>
<p>Why, of course it can! Today, I&#8217;m releasing <a href="https://callee.readthedocs.org"><em>callee</em></a>: a library of <strong>argument matchers</strong>
compatible with <code>unittest.mock</code>. It enables you to write much simpler, more readable,
and delightfully declarative&nbsp;assertions:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">callee</span> <span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">LongerOrEqual</span>
<span class="n">something</span><span class="o">.</span><span class="n">florb</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">String</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">LongerOrEqual</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</pre></div>


<p>The wide array of matchers offered by <em>callee</em> includes
<a href="https://callee.readthedocs.org/en/latest/reference/numbers.html">numeric</a>,
<a href="https://callee.readthedocs.org/en/latest/reference/strings.html">string</a>,
and <a href="https://callee.readthedocs.org/en/latest/reference/collections.html">collection</a> ones.
And if none suits your particular needs,
it&#8217;s a trivial matter to <a href="https://callee.readthedocs.org/en/latest/guide/custom-matchers.html">implement a custom one</a>.</p>
<p>Check the library&#8217;s documentation for <a href="https://callee.readthedocs.org/en/latest/guide/usage.html#example">more examples</a>,
or jump right in to the <a href="https://callee.readthedocs.org/en/latest/guide/installing.html">installation guide</a>
or a <a href="https://callee.readthedocs.org/#api-reference">full matcher reference</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>A loop is not necessary if we simulate <code>assert_called_once_with</code> rather than <code>assert_called_with</code>,
but we still have to dig into <code>mock.call</code> objects to eke out the arguments.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/news/callee-intro.html#callee-intro">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-pip-requirements.html#python-pip-requirements">Requirements for Python&#8217;s&nbsp;pip</a></h2>
    <p>
      Posted on Sun 21 February 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/pip.html">pip</a>,      <a href="http://xion.io/tag/packages.html">packages</a>,      <a href="http://xion.io/tag/dependencies.html">dependencies</a>      &#8226; <a href="http://xion.io/post/code/python-pip-requirements.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In this post I&#8217;ll describe all (hopefully all!) the various ways you can specify a single dependency for a Python&nbsp;package.</p>
<p>This assumes <em>pip</em> is used for installation. The list of dependencies then goes either in <code>install_requires=</code>
parameter of the <code>setup</code> function within <em>setup.py</em>, or as a separate <em>requirements.txt</em> file. Commonly, it will actually
go in both places, with the latter being the canonical source of&nbsp;truth:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;requirements.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">(</span>
        <span class="c"># ...</span>
        <span class="n">install_requires</span><span class="o">=</span><span class="n">rf</span><span class="o">.</span><span class="n">readlines</span><span class="p">(),</span>
    <span class="p">)</span>
</pre></div>


<p>More details about this approach can be found in
<a href="http://xion.org.pl/2014/01/27/anathomy-of-a-python-package/">one of my previous posts</a>.</p>
<p>Here, I will concentrate on the format of a single line in <em>requirements.txt</em> that defines a dependency.
There are numerous variants that <em>pip</em> supports, and they are all described in excruciating detail in
<a href="https://www.python.org/dev/peps/pep-0440/"><span class="caps">PEP</span> 440</a>. This post shall serve as a short reference on the most useful&nbsp;ones.</p>
<h4>Package name (and&nbsp;version)</h4>
<p>The simplest and most common option is to identify a dependency by its package&nbsp;name:</p>
<div class="highlight"><pre>SQLAlchemy
</pre></div>


<p>This will locate it in a global index of packages, which is sometimes called a &#8220;cheese shop&#8221;. Currently,
by far the most popular package registry for Python is <a href="https://pypi.python.org">PyPI</a>, and <em>pip</em> uses it by default<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>Without any further modifiers, <em>pip</em> will download and install the &#8220;current&#8221; version of the package &#8212; either the newest,
or the one designated explicitly by a maintainer. This obviously makes the dependency somewhat unpredictable,
for it can mean unintended upgrades that introduce breaking changes to your&nbsp;code.</p>
<p>To prevent this, you&#8217;d normally <em>pin</em> the dependency to an exact version<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="highlight"><pre>SQLAlchemy==0.9.10
</pre></div>


<p>Other comparison operators are also&nbsp;available:</p>
<div class="highlight"><pre>SQLAlchemy&gt;=0.9.10
SQLAlchemy&lt;1.0.0
</pre></div>


<p>and can even be&nbsp;combined:</p>
<div class="highlight"><pre>SQLAlchemy&gt;=0.9,&lt;1.0.0
</pre></div>


<p>Specs like that will make <em>pip</em> find the newest version that&#8217;s within given range. Assuming your dependency follows
the <a href="http://semver.org/">semantic versioning</a> scheme, this will allow you to stay on top of any minor bugfixes
and improvements to an older release (0.9.x here), without the risk of accidentally upgrading to a new one (1.x)
that your code is not compatible with&nbsp;yet.</p>
<h4>Repository <span class="caps">URL</span></h4>
<p>Sometimes you want to live on the bleeding edge, though, and depend not just on the latest <em>release</em>,
but the head <em>commit</em> to the package&#8217;s repository. This makes sense especially in large systems
that are distributed among multiple repos, and where development happens in&nbsp;lockstep.</p>
<p>For those occasions, and a few others, <em>pip</em> can recognize direct repository URLs. They are in the&nbsp;format:</p>
<div class="highlight"><pre>$VCS+$PROTOCOL://$URL@$LABEL#egg=$PACKAGE
</pre></div>


<p>where the <code>$PROTOCOL</code> part can be optional if the version control system has a default there. That&#8217;s for example
the case for <code>git</code>, which is of course the most important <span class="caps">VCS</span> you&#8217;d be interested in<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>:</p>
<div class="highlight"><pre>git://git.example.com/somepackage#egg=somepackage
</pre></div>


<p>Note that the <code>#egg=$PACKAGE</code> part is not a part of the <code>$URL</code>, and it&#8217;s only there to give a local name for the package
distribution. This is what makes it possible to refer to it later via <em>pip</em>, if only to remove it with
<code>pip uninstall $PACKAGE</code>.
Of course, the sanest practice is to use the PyPI moniker if&nbsp;possible.</p>
<p>When no <code>$LABEL</code> is given, <em>pip</em> will use the <span class="caps">HEAD</span>, trunk, tip, or the equivalent default/current revision from the repo.
Often though (at least in case of Git), you would also pick a branch, tag, or even a particular <em>commit hash</em>:</p>
<div class="highlight"><pre>git+https://github.com/Xion/unmatcher.git@0.1.3.1#egg=unmatcher
git+ssh://github.com/You/yourpackage.git@master#egg=yourpackage
git+https://github.com/mitsuhiko/jinja2.git@5b498453b5898257b2287f14ef6c363799f1405a#egg=Jinja2
</pre></div>


<p>The last two options could be a good choice even with third party packages, when you don&#8217;t want to wait for a new PyPI
release to get a necessary feature or an urgent bug&nbsp;fix.</p>
<h4>Local&nbsp;filesystem</h4>
<p>Lastly, you can ask <em>pip</em> to install a package from a local directory or archive. The former option is often used
with the <code>-e</code> (<code>--editable</code>) flag for <code>pip install</code>. This installs the package in the so-called <em>development mode</em>,
allowing you to edit its source code&nbsp;in-place:</p>
<div class="highlight"><pre>$ pip install -e /home/me/Code/myotherpackage
</pre></div>


<p>You almost certainly don&#8217;t want to put this line in <em>requirements.txt</em>: you should still be pulling the other package
from PyPI. But if it&#8217;s your own one  &#8212; maybe a self-contained utility library used by your main program &#8212;
this setup will be very helpful for making changes to it, informed by your own usage of the&nbsp;package.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This can be changed with <code>--index_url</code> flag to <code>pip install</code>. Running local indexes is a good practice
for Python shops, especially those that rely on <code>pip install</code> as part of their deployment process.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>If the package uses <a href="http://semver.org/">semantic versioning</a>, a possible alternative to <code>==</code> is <code>~=</code>,
which means &#8220;compatible&#8221; version. The precise meaning of this is
<a href="https://www.python.org/dev/peps/pep-0440/#compatible-release">somewhat complicated</a>, but it roughly means that upgrades
are permitted as long as nothing in the public interface changes.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="https://pip.pypa.io/en/latest/reference/pip_install/#vcs-support">Other options</a> include <code>hg</code> (Mercurial),
<code>svn</code>, and <code>bzr</code> (Bazaar).&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-pip-requirements.html#python-pip-requirements">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-retry-idiom.html#python-retry-idiom">Retry idiom for&nbsp;Python</a></h2>
    <p>
      Posted on Wed 27 January 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/exceptions.html">exceptions</a>,      <a href="http://xion.io/tag/else.html">else</a>      &#8226; <a href="http://xion.io/post/code/python-retry-idiom.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>A relatively little known feature of Python is the <code>else</code> block for control flow statements other than <code>if</code>.</p>
<p>If you haven&#8217;t heard about it before, you can provide such a block for both <code>while</code> and <code>for</code> loops,
as well as any variant of the <code>try</code> statement, Its functionality is roughly analogous in both&nbsp;cases:</p>
<ul>
<li>in loops, the <code>else</code> block is executed if the loop didn&#8217;t exit abnormally (i.e. with <code>break</code>)</li>
<li>in <code>try</code> constructs, the <code>else</code> block runs if <em>no</em> exception&nbsp;happened</li>
</ul>
<p>Likely because of the unique semantics that don&#8217;t exist in other languages, neither of those constructs has been seen much
in real world code. Recently, however, I&#8217;ve found they can be combined into a very pythonic pattern
that&#8217;s also quite&nbsp;useful.</p>
<h4>The&nbsp;trick</h4>
<p>Say you have a task that won&#8217;t always succeed. Perhaps it&#8217;s a request made to a janky server, or other network operartion
that&#8217;s prone to timeouts. Since failures are likely to be transient, you&#8217;d like to retry it several more times before
giving up&nbsp;permanently.</p>
<p>With <code>try</code>/<code>except</code> block, you can detect those half-expected failures. With a simple loop, you can repeat the attempt
for as many times as you deem feasible. Combined, they can solve the problem rather&nbsp;neatly:</p>
<div class="highlight"><pre><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_RETRIES</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># ... do stuff ...</span>
    <span class="k">except</span> <span class="n">SomeTransientError</span><span class="p">:</span>
        <span class="c"># ... log it, sleep, etc. ...</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PermanentError</span><span class="p">()</span>
</pre></div>


<h4>But&nbsp;why?</h4>
<p>What&#8217;s the deal with the <code>else</code>s here, though? Are they both&nbsp;necessary?</p>
<p>The simple answer is of course no. <code>else</code> after either a loop or  <code>try</code>/<code>except</code> block is always a <em>syntactic sugar</em>.
Any code that contains it can be transformed into an equivalent snippet that utilizes different techniques to achieve
the same&nbsp;effect.</p>
<p>But this view isn&#8217;t very useful, for many of the essential features in any programming languages can be dismissed
as superfluous using this reasoning. The real question is whether the above idiom is more readable and understandable
than the&nbsp;alternatives.</p>
<p>To that, I posit, the answer is: <em>absolutely</em>.</p>
<h4>Desugaring</h4>
<p>Without the double <code>else</code>, this example would have to be written in a considerably more convoluted&nbsp;way:</p>
<div class="highlight"><pre><span class="n">retries</span> <span class="o">=</span> <span class="n">MAX_RETRIES</span>
<span class="k">while</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># ... do stuff ...</span>
        <span class="k">break</span>
    <span class="k">except</span> <span class="n">SomeTransientError</span><span class="p">:</span>
        <span class="c"># ... log it, sleep, etc. ...</span>
        <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="k">if</span> <span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">PermanentError</span><span class="p">()</span>
</pre></div>


<p>Although at first glance the difference may be minuscule, this version adds significant extra busywork the programmer
has to pay careful attention&nbsp;to:</p>
<ul>
<li>The <code>retries</code> variable now has to be explicit, because the final conditional statement must look at its&nbsp;value.</li>
<li>We can&#8217;t use a <code>for</code> loop anymore (e.g. <code>for retries in range(MAX_RETRIES)</code>), because we wouldn&#8217;t distinguish the
&#8220;success at last try&#8221; and &#8220;retry limit exceeded&#8221; cases: they&#8217;d both result in <code>retries</code> equal to <code>MAX_RETRIES - 1</code>
after the loop<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</li>
<li>As a result, we have to remember to decrement the counter ourselves upon an&nbsp;error.</li>
</ul>
<p>Additionally, the <code>break</code> is easy to miss amidst the actual logic within the <code>try</code> block, both for developer
who writes the code and for any subsequent readers. An alternative is to move it outside of the <code>try</code>/<code>except</code> clause,
but that in turn reintroduces <code>continue</code> into the <code>except</code> branch and further complicates the whole&nbsp;flow.</p>
<p>In short, the desugared version is more error-prone (all those off-by-ones!) and also quite&nbsp;inscrutable.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Or to <code>1</code>, if we count from <code>MAX_RETRIES</code> down to zero.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-retry-idiom.html#python-retry-idiom">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-furl.html#python-furl"><span class="caps">URL</span> library for&nbsp;Python</a></h2>
    <p>
      Posted on Fri 27 November 2015 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/url.html">URL</a>,      <a href="http://xion.io/tag/furl.html">furl</a>      &#8226; <a href="http://xion.io/post/code/python-furl.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Python has many <a href="https://docs.python.org/3/library/">batteries included</a>, but a few things are still conspicuously&nbsp;missing.</p>
<p>One of them is a standardized and convenient approach to <span class="caps">URL</span> manipulation, akin to the
<a href="http://docs.oracle.com/javase/7/docs/api/java/net/URI.html"><code>URI</code> class</a> in Java.
There are some functions in <a href="https://docs.python.org/2/library/urllib.html"><code>urllib</code></a>, of course
(or <a href="https://docs.python.org/3/library/urllib.parse.html"><code>urllib.parse</code></a> in Python 3), but much like their <span class="caps">HTTP</span>-related
comrades, they prove rather verbose and somewhat&nbsp;clunky.</p>
<p><span class="caps">HTTP</span>, however, is solved by the <a href="http://python-requests.org/">Requests</a> package, so you may wonder
if there is some analogous package for <span class="caps">URL</span> operations. The answer is affirmative, and the library in question is,
quite whimsically, called <a href="https://github.com/gruns/furl"><em>furl</em></a>.</p>
<h4><span class="caps">URL</span> in a&nbsp;wrap</h4>
<p>The sole interesting part of the <em>furl</em> interface is the <code>furl</code> class. It represents a single <span class="caps">URL</span>, broken down to
its constituents, with properties and methods for both reading them out and replacing with new&nbsp;values.</p>
<p>Thanks to this handy (and quite obvious) abstraction, common <span class="caps">URL</span> operations become quite simple and&nbsp;self-documenting:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">furl</span> <span class="kn">import</span> <span class="n">furl</span>


<span class="k">def</span> <span class="nf">to_absolute</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If given ``url`` is a relative path,</span>
<span class="sd">    make it relative to the ``base``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">furled</span> <span class="o">=</span> <span class="n">furl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">furled</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">furl</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">url</span>
    <span class="k">return</span> <span class="n">url</span>


<span class="k">def</span> <span class="nf">is_same_origin</span><span class="p">(</span><span class="o">*</span><span class="n">urls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether URLs are from the same origin (host:port).&quot;&quot;&quot;</span>
    <span class="n">origins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">netloc</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">furl</span><span class="p">,</span> <span class="n">urls</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">origins</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">get_facebook_username</span><span class="p">(</span><span class="n">profile_url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get Facebook user ID from their profile URL.&quot;&quot;&quot;</span>
    <span class="n">furled</span> <span class="o">=</span> <span class="n">furl</span><span class="p">(</span><span class="n">profile_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">furled</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s">&#39;facebook.com&#39;</span> <span class="ow">or</span>
            <span class="n">furled</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.facebook.com&#39;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a Facebook URL: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">profile_url</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">furled</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c"># etc.</span>
</pre></div>


<p>This includes the extremely prevalent, yet very harmful pattern of bulding URLs through string&nbsp;interpolation:</p>
<div class="highlight"><pre><span class="n">url</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">?</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">BASE_URL</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">query_params</span><span class="p">))</span>
</pre></div>


<p>Besides looking unpythonically ugly, it&#8217;s also inflexible and error-prone. If <code>BASE_URL</code> gains some innate query string
params (<code>'http://example.com/?a=b'</code>), this method will start producing completely invalid <code>url</code>s (with two question marks,
e.g. <code>'http://example.com/?a=b?foo=bar'</code>).</p>
<p>The equivalent in <em>furl</em> has none of these&nbsp;flaws:</p>
<div class="highlight"><pre><span class="n">url</span> <span class="o">=</span> <span class="n">furl</span><span class="p">(</span><span class="n">BASE_URL</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span><span class="o">.</span><span class="n">url</span>
</pre></div>


<h4>The full&nbsp;package</h4>
<p>To see the full power of <em>furl</em>, I recommend having a look at its
<a href="https://github.com/gruns/furl/blob/master/API.md"><span class="caps">API</span> documentation</a>. It&#8217;s quite clear and should be very easy to&nbsp;use.</p>
      <a class="btn" href="http://xion.io/post/code/python-furl.html#python-furl">Continue reading</a>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://xion.io/tag/python2.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2016 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>