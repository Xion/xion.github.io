<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog &ndash; Tag: Python</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/programming/gisht-recap.html#gisht-recap">Recap of the gisht&nbsp;project</a></h2>
    <p>
      Posted on Fri 24 November 2017 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/gisht.html">gisht</a>,      <a href="http://xion.io/tag/cli.html">CLI</a>,      <a href="http://xion.io/tag/github.html">GitHub</a>,      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/testing.html">testing</a>      &#8226; <a href="http://xion.io/post/programming/gisht-recap.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In this post, I want to discuss some of the experiences I had with a project
that I recently finished, <a href="https://github.com/Xion/gisht"><em>gisht</em></a>.
By &#8220;finished&#8221; I mean that I don&#8217;t anticipate developing any new major features for it,
though smaller things, bug fixes, or non-code stuff, is of course still very&nbsp;possible.</p>
<p>I&#8217;m thinking this is as much &#8220;done&#8221; as most software projects can ever hope to be.
Thus, it is probably the best time for a recap / summary / postmortem / etc. &#8212;
something to recount the lessons learned, and assess the choices&nbsp;made.</p>
<h4>Some&nbsp;context</h4>
<p>The original purpose of <em>gisht</em> was to facilitate download <span class="amp">&amp;</span> execution of GitHub gists
straight from the command&nbsp;line:</p>
<div class="highlight"><pre><span class="nv">$ </span>gisht Xion/git-outgoing  <span class="c"># run the https://gist.github.com/Xion/git-outgoing gist</span>
</pre></div>


<p>I initially wrote <a href="https://github.com/Xion/gisht.py">its first version in Python</a>
because I&#8217;ve accumulated a sizable number of small <span class="amp">&amp;</span> useful scripts
(for Git, Unix, Python, etc.) which were all posted as gists.
Sure, I could download them manually to <code>~/bin</code> every time I used a new machine
but that&#8217;s rather cumbersome, and I&#8217;m quite&nbsp;lazy.</p>
<p>Well, lazy <em>and</em> impatient :)
I noticed pretty fast that the speed tax of Python
is basically unacceptable for a program like <em>gisht</em>.</p>
<p>What I&#8217;m referring to here is not the speed of code execution, however,
but only the <em>startup time</em> of Python interpreter.
Irrespective of the machine, operating system, or language version,
it doesn&#8217;t seem to go lower than about one hundred milliseconds;
empirically, it&#8217;s often 2 or 3 times higher than that.
For the common case of finding a cached gist (no downloads)
and doing a simple <code>fork</code>+<code>exec</code>,
this startup time was very noticeable and extremely jarring.
It also precluded some more sophisticated uses for <em>gisht</em>,
like putting its invocation into the shell&#8217;s <code>$PROMPT</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>Speed:&nbsp;delivered</h4>
<p>And so the obvious solution emerged:
let&#8217;s <a href="https://transitiontech.ca/random/RIIR">rewrite it in Rust</a>!&#8230;</p>
<p>Because if I&#8217;m executing code straight from the internet,
I should at least do it in a <em>safe</em>&nbsp;language.</p>
<p>But jokes aside, it is obvious that a language compiling to native code
is likely a good pick if you want to optimize for startup speed.
So while the choice of Rust was in large part educational
(<em>gisht</em> was one of my first projects to be written in it),
it definitely hasn&#8217;t disappointed&nbsp;there.</p>
<p>Even without any intentional optimization efforts,
the app still runs <em>instantaneously</em>.
I tried to take some measurements using the <code>time</code> command,
but it never ticked into more than 0.001s.
Perceptively, it is at least on par with <code>git</code>,
so that&#8217;s acceptable for me&nbsp;:)</p>
<h4>Can&#8217;t segfault if your code doesn&#8217;t&nbsp;build</h4>
<p>Achieving the performance objective wouldn&#8217;t do us much good, however,
if the road to get there involved excessive penalties on productivity.
Such negative impact could manifest in many ways,
including troublesome debugging due to a tricky runtime<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>,
or difficulty in getting the code to compile in the first&nbsp;place.</p>
<p>If you had even a passing contact with Rust,
you&#8217;d expect the latter to be much more likely than the&nbsp;former.</p>
<p>Indeed, Rust&#8217;s very design eschews runtime flexibility to a ridiculous degree
(in its &#8220;safe&#8221; mode, at least),
while also forcing you to absorb subtle <span class="amp">&amp;</span> complex ideas
to even get your code past the compiler.
The reward is increased likelihood your program will behave as intended &#8212;
although it&#8217;s definitely not on the level of &#8220;if it compiles, it works&#8221;
that can be offered by Haskell or&nbsp;Idris.</p>
<p>But since <em>gisht</em> is hardly mission critical,
I didn&#8217;t actually care too much about this increased reliability.
I don&#8217;t think it&#8217;s likely that Rust would buy me much over something like modern C++.
And if I were to <em>really</em> do some kind of cost-benefit analysis of several languages
&#8212; rather than going with Rust simply to learn it better &#8212;
then it would be hard to justify it over something like&nbsp;Go.</p>
<h4>It&nbsp;scales</h4>
<p>So the real question is: has Rust <em>not hampered</em> my productivity too much?
Having the benefit of hindsight,
I&#8217;m happy to say that the trade-off was definitely acceptable&nbsp;:)</p>
<p>One thing I was particularly satisfied with was the language&#8217;s <em>scalability</em>.
What I mean here is the ability to adapt as the project grows,
but also to start quickly and remain nimble
while the codebase is still pretty&nbsp;small.</p>
<p>Many languages (most, perhaps) are naturally tailored towards the large end,
doing their best to make it more bearable to work with big codebases.
In turn, they often forget about helping projects take off in the first place.
Between complicated build systems and dependency managers (Java),
or a virtual lack of either (C++),
it can be really hard to get going in a &#8220;serious&#8221; language like&nbsp;this.</p>
<p>On the other hand, languages like Python make it very easy to start up
and achieve relatively impressive results.
Some people, however, report having encountered problems
once the code evolves past certain size.
While I&#8217;m actually
<a href="http://xion.io/post/programming/long-live-dynamic-languages.html">very unsympathetic</a> to those claims,
I realize perception plays a significant role here,
making those anecdotal experiences into a sort of self-fulfilling&nbsp;prophecy.</p>
<p>This perception problem should almost certainly spare Rust,
as it&#8217;s a natively compiled and statically typed language,
with a respectable type system to boot.
There is also <a href="https://servo.org/">some evidence</a>
that the language works well in large projects already.
So the only question that we might want to ask is:
how easy it is to actually <em>start</em> a project in Rust,
and carry it towards some kind of <abbr title="Minimum Viable Product"><span class="caps">MVP</span></abbr>?</p>
<p>Based on my experiences with <em>gisht</em>,
I can say that it is, in fact, quite easy.
Thanks mostly to the impressive Swiss army knife of <code>cargo</code>
&#8212; acting as both package manager and a rudimentary build system &#8212;
it was almost Python-trivial to cook a &#8220;Hello World&#8221; program
that does something tangible, like
<a href="https://github.com/Xion/gisht/blob/de1be876784d671dd84618c3a15d0836f9fd5697/src/main.rs">talk to a <span class="caps">JSON</span> <span class="caps">API</span></a>.
From there, it only took a few coding sessions to grow it
into a <a href="https://github.com/Xion/gisht/tree/5c156cb">functioning prototype</a>.</p>
<h4>Abstractions&nbsp;galore</h4>
<p>As part of rewriting <em>gisht</em> from Python to Rust,
I also wanted to fix some longstanding issues that limited its&nbsp;capabilities.</p>
<p>The most important one was the hopeless coupling to GitHub
and their particular flavor of gists.
Sure, this is where the project even got its name from,
but people use a dozen of different services to share code snippets
and it should very possible to support them&nbsp;all.</p>
<p>Here&#8217;s where it became necessary to utilize
the abstraction capabilities that Rust has to offer.
It was somewhat obvious to
<a href="https://github.com/Xion/gisht/blob/3fc443dc9986612fd46b4311ca2ecbc613a15cf9/src/gist.rs#L16">define a <code>Host</code> trait</a>
but of course its exact form had to be
<a href="https://github.com/Xion/gisht/commit/26746dfc2eac68b67753f71148eb9897a861914e#diff-9d0a9c0911fa012f0fcf8ca56b43f8c5">shaped</a>
over <a href="https://github.com/Xion/gisht/commit/1e54ad05480b42089977171f10d4727beca5f835#diff-9d0a9c0911fa012f0fcf8ca56b43f8c5">numerous iterations</a>.
Along the way, it even turned out that <code>Result&lt;Option&lt;T&gt;&gt;</code> and <code>Option&lt;Result&lt;T&gt;&gt;</code>
are sometimes <a href="https://github.com/Xion/gisht/blob/d9c30e69d58b2a4e5608e6c8a1aa6392133b490f/src/hosts/mod.rs#L44">both necessary</a>
as return types&nbsp;:)</p>
<p>Besides cleaner architecture,
another neat thing about an explicit abstraction is
the ability to slice a concept into smaller pieces &#8212;
and then put <em>some of them</em> back together.
While the <code>Host</code> trait could support a very diverse set of gist services and <em>pastebins</em>,
many of them turned out to be just a slight variation of one central theme.
Because of this similarity, it was possible to introduce
a single <a href="https://github.com/Xion/gisht/blob/d2e78b1f5ee4616b1d5eb7067c3c5dd0ce9e2fe4/src/hosts/simple.rs#L26"><code>Basic</code> implementation</a>
which handles multiple services through varying sets of <span class="caps">URL</span>&nbsp;patterns.</p>
<p>Devices like these aren&#8217;t of course specific to Rust:
interfaces (traits) and classes are a staple of <span class="caps">OO</span> languages in general.
But some other techniques were more idiomatic;
the concept of <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html">iterators</a>, for example,
is flexible enough to accommodate
<a href="https://github.com/Xion/gisht/blob/4fa347c6197190b0f6c68dd548efc28287a5859f/src/hosts/github.rs#L354">looping over GitHub user&#8217;s gists</a>,
even as they read directly from <span class="caps">HTTP</span>&nbsp;responses.</p>
<h4>Hacking&nbsp;time</h4>
<p>Not everything was sunshine and rainbows,&nbsp;though.</p>
<p>Take <em>clap</em>, for example.
It&#8217;s mostly a very good crate for parsing command line arguments,
but it couldn&#8217;t <em>quite</em> cope with the unusual requirements that <em>gisht</em> had.
To make <code>gisht Foo/bar</code> work alongside <code>gisht run Foo/bar</code>,
it was necessary to
<a href="https://github.com/Xion/gisht/commit/0eff00e31f94f3856558ebb1f6655a9e6fc50ca6#diff-7397f82f682a49eb62e2b056118124d0">analyze <code>argv</code></a>
before even handing it over to <code>clap</code>.
This turned out to be
<a href="https://github.com/Xion/gisht/commit/e7ab06a01d4675947965ec82fc6f3ec5a2517c89#diff-7397f82f682a49eb62e2b056118124d0">surprisingly tricky</a>
to get right.
Like,
<a href="https://github.com/Xion/gisht/commit/69e8aad4a1743beb57184dc38150ef02b306a0a1#diff-7397f82f682a49eb62e2b056118124d0">really</a>
tricky, with
<a href="https://github.com/Xion/gisht/commit/acadcfa0a97fe52584fbf8198541baa8733cb0a5#diff-7397f82f682a49eb62e2b056118124d0R58">edges cases</a>
and
<a href="https://github.com/Xion/gisht/commit/a9eb599168f5b6821aefa46dde0b0a89a41cd4e6#diff-7397f82f682a49eb62e2b056118124d0R562">stuff</a>.
But as it is often the case in software,
the answer turned out to be yet another layer of indirection plus
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/args.rs#L457-L578">a copious amount of tests</a>.</p>
<p>In another instance, however, a direct library support was&nbsp;crucial.</p>
<p>It so happened that <em>hyper</em>, the crate I&#8217;ve been using for <span class="caps">HTTP</span> requests,
didn&#8217;t handle the <code>Link:</code> response header out of the box<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.
This was a stumbling block that prevented the gist iterator (mentioned earlier)
from correctly handling pagination in the responses from GitHub <span class="caps">API</span>.
Thankfully, having <a href="https://docs.rs/hyper/0.11.7/hyper/header/trait.Header.html">the <code>Header</code> abstraction</a> in <em>hyper</em>
meant it was possible to add the missing support in
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/ext/hyper.rs">a relatively straighforward manner</a>.
Yes, it&#8217;s <a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/ext/hyper.rs#L23">not a universal implementation</a>
that&#8217;d be suitable for <em>every</em> <span class="caps">HTTP</span> client,
but it does the job for <em>gisht</em> just&nbsp;fine.</p>
<h4>Test-Reluctant&nbsp;Development</h4>
<p>And so the program kept growing steadily over the months,
most notably through
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/mod.rs#L101">more and more gist hosts</a>
it could now&nbsp;support.</p>
<p>Eventually, some of them would fall into a sort of twilight zone.
They weren&#8217;t as complicated as GitHub to warrant writing a completely new <code>Host</code> instance,
but they also couldn&#8217;t be handled via
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/common/basic.rs#L28">the <code>Basic</code> structure</a> alone.
A good example would be <a href="http://sprunge.us/">sprunge.us</a>:
mostly an ordinary pastebin,
except for its optional syntax highlighting
which may add some &#8220;junk&#8221; to the otherwise regular&nbsp;URLs.</p>
<p>In order to handle those odd cases,
I went for a classic wrapper/decorator pattern which, in its essence,
boils down to something like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">Basic</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">new</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Sprunge</span><span class="p">{</span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">Basic</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sprunge.us&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="s">&quot;http://sprunge.us/${id}&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">...)}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// override &amp; wrap methods that require custom logic:</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">resolve_url</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">io</span><span class="o">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Gist</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">url_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">try_opt</span><span class="o">!</span><span class="p">(</span><span class="n">Url</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">ok</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">url_obj</span><span class="p">.</span><span class="n">set_query</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">inner</span><span class="p">.</span><span class="n">resolve_url</span><span class="p">(</span><span class="n">url_obj</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_str</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// passthrough to the `Basic` struct for others:</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">fetch_gist</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">gist</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Gist</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">:</span><span class="w"> </span><span class="n">FetchMode</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">io</span><span class="o">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">fetch_gist</span><span class="p">(</span><span class="n">gist</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// (etc.)</span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Despite the noticeable boilerplate of a few pass-through methods,
I was pretty happy with this solution, at least initially.
After a few more unusual hosts, however,
it became cumbersome to fix all the edge cases
by looking only at the final output of the inner <code>Basic</code> implementation.
The code was evidently asking for some <em>tests</em>,
if only to check how the inner structure is being&nbsp;called.</p>
<p>Shouldn&#8217;t be too hard, right?&#8230; Yeah, that&#8217;s what I thought,&nbsp;too.</p>
<p>The reality, unfortunately, fell very short of those expectations.
Stubs, mocks, fakes &#8212;
<a href="https://testing.googleblog.com/2013/07/testing-on-toilet-know-your-test-doubles.html"><em>test doubles</em></a>
in general &#8212;
are a dark and forgotten corner of Rust
that almost no one seems to pay any attention to.
Absent a proper library support &#8212; much less a language one &#8212;
the only way forward was to roll up my sleeves
and implement
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/testing/inmemory_host.rs">a fake <code>Host</code></a>
from&nbsp;scratch.</p>
<p>But that was just the beginning.
How do you seamlessly inject this fake implementation into the wrapper
so that it replaces the <code>Basic</code> struct for testing?
If you are not careful and go for the &#8220;obvious&#8221; solution &#8212; a trait&nbsp;object:</p>
<div class="highlight"><pre><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Host</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>you&#8217;ll soon realize that you need not just a <code>Box</code>, but at least an <code>Rc</code> (or maybe even <code>Arc</code>).
Without this kind of shared ownership,
you&#8217;ll lose your chance to interrogate the test double once you hand it over to the wrapper.
This, in turn, will heavily limit your ability to write effective&nbsp;tests.</p>
<p>What&#8217;s the non-obvious approach, then?
The full rationale would probably warrant a separate post,
but the working recipe looks more or less like&nbsp;this:</p>
<ul>
<li>
<p>First, <em>parametrize</em> the wrapper with its inner type:
  <code>pub struct Sprunge&lt;T: Host&gt; { inner: T }</code>.</p>
</li>
<li>
<p>Put that in an internal module with the correct visibility&nbsp;setup:</p>
<div class="highlight"><pre><span class="kn">mod</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Sprunge</span><span class="o">&lt;</span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="n">Host</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="n">super</span><span class="p">)</span><span class="w"> </span><span class="n">inner</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


</li>
<li>
<p>Make the regular (&#8220;production&#8221;) version of the wrapper into an <em>alias</em>,
  giving it the type parameter that you&#8217;ve been using directly<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>:</p>
<div class="highlight"><pre><span class="k">pub</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n">Sprunge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">internal</span><span class="o">::</span><span class="n">Sprunge</span><span class="o">&lt;</span><span class="n">Basic</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
</pre></div>


</li>
<li>
<p>Change the <code>new</code> constructor to instantiate the <code>internal</code> type.</p>
</li>
<li>
<p>In tests, create the wrapper with a fake <code>inner</code> object&nbsp;inside.</p>
</li>
</ul>
<p>As you can see in
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/sprunge.rs">the real example</a>,
this convoluted technique removes the need for any pointer indirection.
It also permits you to
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/hosts/sprunge.rs#L152">access the out-of-band interface</a>
that a fake object would normally&nbsp;expose.</p>
<p>It&#8217;s a shame, though, that so much work is required for something
that should be very simple.
As it appears, testing is still a neglected topic in&nbsp;Rust.</p>
<h4>Packing&nbsp;up</h4>
<p>It wasn&#8217;t just Rust that played a notable role in the development of <em>gisht</em>.</p>
<p>Pretty soon after getting the app to a presentable state,
it became clear that a mere <code>cargo build</code> won&#8217;t do everything
that&#8217;s necessary to carry out a complete build.
It <em>could</em> do more, admittedly,
if I had the foresight to explore <a href="http://doc.crates.io/build-script.html">Cargo build scripts</a>
a little more thoroughly.
But overall, I don&#8217;t regret dropping back to my trusty ol&#8217; pick:&nbsp;Python.</p>
<p>Like in a few previous projects, I used the <a href="http://pyinvoke.org">Invoke task runner</a>
for both the crucial and the auxiliary automation tasks.
It is a relatively powerful tool
&#8212; and probably the best in its class in Python that I know of &#8212;
though it can be a bit capricious if you want to
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/release/__init__.py#L69">really fine-tune it</a>.
But it does make it much easier to organize your automation code,
to reuse it between tasks, and to (ahem) <em>invoke</em> those tasks in a convenient&nbsp;manner.</p>
<p>In any case, it certainly beats a collection of disconnected Bash scripts&nbsp;;)</p>
<p>What have I automated in this way, you may ask?
Well, a couple of small things; those&nbsp;include:</p>
<ul>
<li>
<p>embedding of the current Git commit hash into the binary,
to help identify the exact revision in the logs of any potential bug reports<sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup></p>
</li>
<li>
<p>after a successful build,
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/build.py#L40">replacing</a>
the <em>Usage</em> section in <em><span class="caps">README</span></em> with the program&#8217;s <code>--help</code> output</p>
</li>
<li>
<p>generating <a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/build.py#L96">completion scripts</a>
for popular shells by invoking the binary with a magic hidden flag (courtesy of <em>clap</em>)</p>
</li>
</ul>
<p>Undoubtedly the biggest task that I relegated to Python/Invoke,
was the preparation of
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/tasks/release/__init__.py"><em>release packages</em></a>.
When it comes to the various Linuxes (currently Debian and Red Hat flavors),
this wasn&#8217;t particularly complicated.
Major thanks are due to the amazing <a href="https://github.com/jordansissel/fpm"><em>fpm</em> tool</a> here,
which I recommend to anyone who needs to package their software in a distro-compatible&nbsp;manner.</p>
<p>Homebrew, however &#8212; or more precisely, <span class="caps">OS</span> X itself &#8212; was quite a different story.
Many, <a href="https://github.com/Xion/gisht/commits/a5423a63d10221c50faa1cb30a999a85286853a1">many</a>
failed attempts were needed to even get it to build on <a href="https://travis-ci.org">Travis</a>,
and the additional dependency on Python was
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/ci/travis/before_install-osx.sh#L15">partially to blame</a>.
To be fair, however, most of the pain was exclusively due to OpenSSL;
getting that thing to build is always <a href="https://github.com/sfackler/rust-openssl/issues/255">loads of &#8220;fun&#8221;</a>,
especially in such an opaque and poorly debuggable environment as&nbsp;Travis.</p>
<h4>The&nbsp;wrap</h4>
<p>There&#8217;s probably a lot of minor things and tidbits I could&#8217;ve mentioned along the way,
but the story so far has most likely covered all the important topics.
Let&#8217;s wrap it up then, and highlight some interesting points in the classic <em>Yay/Meh/Nay</em>&nbsp;manner.</p>
<h5>Yay</h5>
<ul>
<li>
<p>It was definitely a good choice to rewrite <em>gisht</em> specifically in Rust.
Besides all the advantages I&#8217;ve mentioned already,
it is also worth noting that the language went through about 10 minor version bumps
while I was working on this project.
Of all those new releases,
I don&#8217;t recall a single one that would introduce a breaking&nbsp;change.</p>
</li>
<li>
<p>Most of the Rust ecosystem (third-party libraries) was a joy to use,
and very easy to get started with.
Honorable mention goes to <em>serde_json</em> and how easy it was to
<a href="https://github.com/Xion/gisht/commit/a0655a6a5b86c05df5665e3bc7f1512f2476c9e4">transition the code</a>
from <em>rustc_serialize</em> that I had used at&nbsp;first.</p>
</li>
<li>
<p>With a possible exception of sucking in node.js as a huge dependency of your project
and using Grunt, there is probably no better way of writing automation <span class="amp">&amp;</span> support code than Python.
There may eventually be some Rust-based task runners that could try to compete,
but I&#8217;m not very convinced about using a compiled language for this purpose
(and especially one that takes so long to&nbsp;build).</p>
</li>
</ul>
<h5>Meh</h5>
<ul>
<li>
<p>While <a href="https://docs.rs/clap">the <em>clap</em> crate</a> is quite configurable and pretty straightforward to use,
it does lack at least <a href="https://github.com/kbknapp/clap-rs/issues/568">one feature</a>
that&#8217;d be very nice for <em>gisht</em>.
Additionally, working with raw <em>clap</em> is often a little tedious,
as it doesn&#8217;t assist you in translating parsed flags into your own configuration types,
and thus requires
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/src/args.rs#L138-L182">shuffling those bits</a>
manually<sup id="fnref:6"><a class="footnote-ref" href="#fn:6" rel="footnote">6</a></sup>.</p>
</li>
<li>
<p>Being a <em>defacto</em> standard for continuous integration in open-source projects,
<a href="https://travis-ci.org">Travis <span class="caps">CI</span></a> could be a <em>little</em> less finicky.
In almost every project I decide to use it for,
I end up with about half a dozen commits
that frantically try to fix silly configuration issues,
all before even a simple <em>.travis.yml</em> works as intended.
Providing a way to test <span class="caps">CI</span> builds locally would be an obvious way to avoid this&nbsp;churn.</p>
</li>
</ul>
<h5>Nay</h5>
<ul>
<li>
<p>Testing in Rust is such a weird animal.
On one hand, there is a first-class, out-of-the-box support for unit tests
(and even integration tests) right in the toolchain.
On the other hand, the relevant parts of the ecosystem are immature or lacking,
as evidenced by the dreary story of mocking and stubbing.
It&#8217;s no surprise that there is a long way to catch up to languages with the strongest testing culture
(Java and C#/.<span class="caps">NET</span><sup id="fnref:7"><a class="footnote-ref" href="#fn:7" rel="footnote">7</a></sup>), but it&#8217;s disappointing to see Rust outclassed
<a href="https://github.com/google/googletest">even by C++</a>.</p>
</li>
<li>
<p>Getting anything to build reliably on <span class="caps">OSX</span> in a <span class="caps">CI</span> environment is already a tall order.
But if it involves things as OpenSSL, then it quickly goes from bad to terrible.
I&#8217;m really not amused anymore how this &#8220;Just Works&#8221; system often turns out to hardly work at&nbsp;all.</p>
</li>
</ul>
<p>Since I don&#8217;t want to end on such a negative note,
I feel compelled to state the obvious fact: every technology choice is a trade-off.
In case of this project, however, the drawbacks were <em>heavily</em> outweighed by the&nbsp;benefits.</p>
<p>For this reason, I can definitely recommend the software stack I&#8217;ve just described
to anyone developing non-trivial, cross-platform command line&nbsp;tools.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This is not an isolated complaint, by the way,
as the interpreter startup time has recently emerged as <a href="https://lwn.net/Articles/730915/">an important issue</a>
to many developers of the Python language.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Which may also include a practical <em>lack</em> thereof.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>It does handle it <a href="https://docs.rs/hyper/0.11.7/hyper/header/struct.Link.html">now</a>, fortunately.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Observant readers may notice that we&#8217;re exposing a technically private type (<code>internal::Sprunge</code>)
through a publicly visible type alias. If that type was <em>actually</em> private,
this would trigger a compiler warning
which is slated to become <a href="https://github.com/rust-lang/rust/issues/34537">a hard error</a>
at some point in the future. But, amusingly, we can fool the compiler by making it a
<em>public type</em> inside a <em>private module</em>, which is exactly what we&#8217;re doing here.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>This has since been rewritten and is now done in
<a href="https://github.com/Xion/gisht/blob/30df960052f2a03270bbb5ca1f7be0920978007d/build.rs"><em>build.rs</em></a>
&#8212; but that&#8217;s only because I implemented
<a href="https://github.com/rust-lang/cargo/pull/3929">the relevant Cargo feature</a> myself :)&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>For an alternative approach that doesn&#8217;t seem to have this problem,
check <a href="https://docs.rs/structopt_derive">the <em>structopt</em> crate</a>.&#160;<a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>Dynamically typed languages, due to their rich runtime,
are basically a class of their own when it comes to testing ease,
so it wouldn&#8217;t really be fair to hold them up for comparison.&#160;<a class="footnote-backref" href="#fnref:7" rev="footnote" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/programming/gisht-recap.html#gisht-recap">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/long-live-dynamic-languages.html#long-live-dynamic-languages">Long Live Dynamic&nbsp;Languages!</a></h2>
    <p>
      Posted on Wed 24 May 2017 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/dynamic-languages.html">dynamic languages</a>,      <a href="http://xion.io/tag/dynamic-typing.html">dynamic typing</a>,      <a href="http://xion.io/tag/static-typing.html">static typing</a>      &#8226; <a href="http://xion.io/post/programming/long-live-dynamic-languages.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>If you followed the few (or a dozen) of my recent posts,
you&#8217;ve probably noticed a sizable bias in the choice of topics.
The vast majority were about <a href="http://rust-lang.org">Rust</a> &#8212;
a native, bare metal, statically typed language with powerful compile time semantics
but little in the way of runtime&nbsp;flexibility.</p>
<p>Needless to say, Rust is radically different than (almost the exact opposite of) Python,
the other language that I&#8217;m covering sometimes.
Considering this topical shift,
it would fair to assume that I, too, have subscribed to the whole Static Typingâ„¢&nbsp;trend.</p>
<p>But that wouldn&#8217;t be very&nbsp;accurate.</p>
<p>Don&#8217;t get me wrong.
As far as fashion cycles in the software industry go,
the current trend towards static/compiled languages is difficult to disparage.
Strong in both hype <em>and</em> merit,
it has given us some <a href="http://rust-lang.org">really innovative</a>
<span class="amp">&amp;</span> <a href="https://www.typescriptlang.org/">promising</a> solutions
(as well as some <a href="http://golang.org">not-so-innovative</a> ones)
that are poised to shape the future of programming for years, if not decades to come.
In many ways, it is also correcting mistakes of <a href="https://www.java.com/en/">the previous generation</a>:
excessive boilerplate, byzantine abstractions, and software&nbsp;bloat.</p>
<p>What about dynamic languages, then?
Are they slowly going the way of the&nbsp;dodo?</p>
<h4>Trigger warning: <code>TypeError</code></h4>
<p>Some programmers would certainly wish&nbsp;so.</p>
<p>Indeed, it&#8217;s not hard at all to find
<a href="https://arstechnica.com/information-technology/2014/06/why-do-dynamic-languages-make-it-difficult-to-maintain-large-codebases/">articles</a>
and <a href="https://www.reddit.com/r/rust/comments/6aqksm/rust_productivity_compared_to_other_languages/dhgp037/">opinions</a>
about dynamic languages that are, well, less than&nbsp;flattering.</p>
<p>The common argument echoed in those accounts points to supposed unsuitability of Python et al.
for any large, multi-person project.
The reasoning can be summed up as &#8220;good for small scripts and not much else&#8221;.
Without statically checked types, the argument goes,
anything bigger than a quick hack or a prototype
shall inevitably become hairy and dangerous&nbsp;monstrosity.</p>
<p>And when that happens,
<em>a single typo</em> can go unchecked and bring down the entire&nbsp;system!&#8230;</p>
<p>At the very end of this spectrum of beliefs,
some pundits may eventually make the leap from languages to <em>people</em>.
If dynamically typed languages (or &#8220;untyped&#8221; ones, as they&#8217;re often mislabeled)
are letting even trivial bugs through,
then obviously anyone who wants to use them is
<a href="https://danluu.com/images/empirical-pl/pl_godwin.png">dangerously irresponsible</a>.
It must follow that all they <em>really</em> want is to hack up some shoddy code,
<em>yolo</em> it over to production, and let others worry about the&nbsp;consequences.</p>
<h4>Mind the&nbsp;gap</h4>
<p>It&#8217;s likely unproductive to engage with someone who&#8217;s that extreme.
If the rhetoric is dialed down, however, we can definitely find the edge of&nbsp;reason.</p>
<p>In my opinion, this fine line goes right through the &#8220;good in small quantities&#8221; argument.
I can certainly understand the apprehension towards large projects
that utilize dynamically typed languages throughout their codebases.
The prospect of such a project <em>is</em> scary,
because it contains an additional element of uncertainty.
More so than with many other technologies,
you ought to <em>know what you&#8217;re doing</em>.</p>
<p>Some people (and teams) do. Others, not so&nbsp;much.</p>
<p>I would therefore refine the argument
so that it better reflects the strengths and weaknesses of dynamic languages.
They are perfectly suited for at least the following&nbsp;cases:</p>
<ul>
<li>anyone writing small, standalone applications or&nbsp;scripts</li>
<li><em>any project</em> (large or small) with a well-functioning team of talented&nbsp;individuals</li>
</ul>
<p>The sad reality of the software industry is the vast, gaping chasm of calamity and despair
that stretches between those two&nbsp;scenarios.</p>
<p>Within lies the bulk of commercial software projects,
consistently hamstrung by the usual suspects:
incompetent management, unclear and shifting requirements, under- or overstaffing,
ancient development practices, lack of coding standards, rampant bureaucracy,
<a href="http://www.daedtech.com/how-developers-stop-learning-rise-of-the-expert-beginner/">inexperienced developers</a>,
and so&nbsp;on.</p>
<p>In such an environment,
it becomes nigh impossible to capitalize on the strengths of dynamic languages.
Instead, the main priority is to protect from even further productivity losses,
which is what bog-standard languages like Java, C#, or Go tend to be pretty good at.
Rather than to move fast, the objective is to remain moving <em>at all</em>.</p>
<h4>Freedom of&nbsp;choice</h4>
<p><span class="dquo">&#8220;</span>But that&#8217;s backwards&#8221;, the usual retort goes.
&#8220;Static typing and compilation checks are what <em>enables</em> me to be&nbsp;productive!&#8221;</p>
<p>I have no doubt that most people saying this do indeed believe
they&#8217;re better off programming in static languages.
Regardless of what they think, however,
there exists <a href="https://danluu.com/empirical-pl/">no conclusive evidence</a>
to back up such claims as a universal&nbsp;rule.</p>
<p>This is of course the perennial problem with software engineering in general,
and the project management aspect of it in particular.
There is very little proper research on optimal and effective approaches to it,
which is why any of the so-called &#8220;best practices&#8221;
are quite likely to stem from <a href="https://leanpub.com/leprechauns">unsubstantiated hearsay</a>.</p>
<p>We can lament this state of affairs, of course.
But on the other hand, we can also find it <em>liberating</em>.
In the absence of rigid prescriptions and judgments about productivity,
we are free to explore, within technical limitations,
what language works best for us, our team, and our&nbsp;projects.</p>
<p>Sometimes it&#8217;ll be Go, Java, Rust, or even Haskell.<br>
A different situation may be best handled by Python, Ruby, or even&nbsp;JavaScript.</p>
<p>As the old adage goes, there is no silver bullet.
We should not try to polish static typing into&nbsp;one.</p>
      <a class="btn" href="http://xion.io/post/programming/long-live-dynamic-languages.html#long-live-dynamic-languages">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-generator-args.html#python-generator-args">Arguments to Python generator&nbsp;functions</a></h2>
    <p>
      Posted on Tue 14 March 2017 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/generators.html">generators</a>,      <a href="http://xion.io/tag/functions.html">functions</a>,      <a href="http://xion.io/tag/arguments.html">arguments</a>,      <a href="http://xion.io/tag/closures.html">closures</a>      &#8226; <a href="http://xion.io/post/code/python-generator-args.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In Python, a <em>generator function</em> is one that
contains a <code>yield</code> statement inside the function body.
Although this language construct has many fascinating use cases
(<a href="http://www.dabeaz.com/coroutines/Coroutines.pdf"><span class="caps">PDF</span></a>),
the most common one is creating concise and readable&nbsp;iterators.</p>
<h4>A typical&nbsp;case</h4>
<p>Consider, for example, this simple&nbsp;function:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>
</pre></div>


<p>which creates an (infinite) iterator over all multiples of given integer.
A sample of its output looks like&nbsp;this:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">multiples</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
</pre></div>


<p>If you were to replicate in a language such as Java or Rust
&#8212; neither of which supports an equivalent of <code>yield</code> &#8212;
you&#8217;d end up writing an <em>iterator</em> class.
Python also has them, of&nbsp;course:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Multiples</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">of</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">of</span> <span class="o">=</span> <span class="n">of</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">of</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>

    <span class="n">__next__</span> <span class="o">=</span> <span class="nb">next</span>  <span class="c"># Python 3</span>
</pre></div>


<p>but they are usually not the first choice<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>It&#8217;s also pretty easy to see why:
they require explicit bookkeeping of any auxiliary state between iterations.
Perhaps it&#8217;s not too much to ask for a trivial walk over integers,
but it can get quite tricky if we were to iterate over recursive data structures,
like trees or graphs. In <code>yield</code>-based generators, this isn&#8217;t a problem,
because the state is stored within local variables on the coroutine&nbsp;stack.</p>
<h4>Lazy!</h4>
<p>It&#8217;s important to remember, however, that
generator functions behave differently than regular functions do,
even if the surface appearance often says&nbsp;otherwise.</p>
<p>The difference I wanted to explore in this post becomes apparent
when we add some argument checking to the initial&nbsp;example:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">of</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected a natural number, got </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">of</span><span class="p">,))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>
</pre></div>


<p>With that <code>if</code> in place, passing a negative number shall result in an exception.
Yet when we attempt to do just that, it will seem as if nothing is&nbsp;happening:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">multiples</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>


<p>And to a certain degree, this is pretty much correct.
Simply <em>calling</em> a generator function does comparatively little,
and doesn&#8217;t actually execute any of its code!
Instead, we get back a <em>generator object</em>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">m</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">multiples</span> <span class="n">at</span> <span class="mh">0x10f0ceb40</span><span class="o">&gt;</span>
</pre></div>


<p>which is essentially a built-in analogue to the <code>Multiples</code> iterator instance.
Commonly, it is said that both generator functions and iterator classes are <em>lazy</em>:
they only do work when we asked (i.e. iterated&nbsp;over).</p>
<h4>Getting&nbsp;eager</h4>
<p>Oftentimes, this is perfectly okay.
The laziness of generators is in fact one of their great strengths,
which is particularly evident in the <a href="https://pymotw.com/2/itertools/">immense usefulness</a>
of <a href="http://docs.python.org/2/library/itertools.html">the<code>itertools</code> module</a>.</p>
<p>On the other hand, however,
delaying argument checks and similar operations until later may hamper debugging.
The classic engineering principle of <a href="https://en.wikipedia.org/wiki/Fail-fast">failing fast</a>
applies here very fittingly: any errors should be signaled immediately.
In Python, this means raising exceptions as soon as problems are&nbsp;detected.</p>
<p>Fortunately, it is possible to reconcile the benefits of laziness
with (more) defensive programming.
We can make the generator functions only a <em>little</em> more eager,
just enough to verify the correctness of their&nbsp;arguments.</p>
<p>The trick is simple. We shall extract an <em>inner</em> generator function
and only call it after we have checked the&nbsp;arguments:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yields all multiples of given integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">of</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;expected a natural number, got </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">of</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">multiples</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">x</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>

    <span class="k">return</span> <span class="n">multiples</span><span class="p">()</span>
</pre></div>


<p>From the caller&#8217;s point of view, nothing has changed in the typical&nbsp;case:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">multiples</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">multiples</span> <span class="n">at</span> <span class="mh">0x110579190</span><span class="o">&gt;</span>
</pre></div>


<p>but if we try to make an incorrect invocation now,
the problem is detected <em>immediately</em>:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">multiples</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
</pre></div>


<!-- -->

<div class="highlight"><pre>Traceback (most recent call last):
  File &quot;&lt;pyshell#2&gt;&quot;, line 1, in &lt;module&gt;
    multiples(of=-5)
  File &quot;&lt;pyshell#0&gt;&quot;, line 4, in multiples
    raise ValueError(&quot;expected a natural number, got %r&quot; % (of,))
ValueError: expected a natural number, got -5
</pre></div>


<p>Pretty neat, especially for something that requires only two lines of&nbsp;code!</p>
<h4>The last&nbsp;(micro)optimization</h4>
<p>Indeed, we didn&#8217;t even have to pass the arguments to the inner (generator) function,
because they are already captured by the&nbsp;closure.</p>
<p>Unfortunately, this also has a slight performance cost.
A captured variable (also known as a <em>cell variable</em>) is stored on the function object itself,
so Python has to emit
<a href="http://holdenweb.blogspot.com/2014/07/closures-arent-easy.html">a different bytecode instruction</a>
(<code>LOAD_DEREF</code>) that involves
an <a href="http://stupidpythonideas.blogspot.com/2015/12/how-lookup-works.html">extra pointer dereference</a>.
Normally, this is not a problem, but in a tight generator loop it can make a&nbsp;difference.</p>
<p>We can eliminate this extra work<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> by passing the parameters&nbsp;explicitly:</p>
<div class="highlight"><pre>    <span class="c"># (snip)</span>

    <span class="k">def</span> <span class="nf">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">of</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">x</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">of</span>

    <span class="k">return</span> <span class="n">multiples</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
</pre></div>


<p>This turns them into local variables of the inner function,
replacing the <code>LOAD_DEREF</code> instructions with (aptly named) <code>LOAD_FAST</code> ones.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Technically, the <em>Multiples</em> class is here is both an <em>iterator</em>
(because it has the <code>next</code>/<code>__next__</code> methods) and <em>iterable</em>
(because it has <code>__iter__</code> method that returns an iterator, which happens to be the same object).
This is common feature of iterators that are not associated with any collection,
like the ones defined in the built-in <a href="http://docs.python.org/2/library/itertools.html"><code>itertools</code> module</a>.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Note that if you engage in this kind of microoptimizations,
I&#8217;d assume you have already <a href="https://www.python.org/doc/essays/list2str/">changed your global lookup into local ones</a> :)&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-generator-args.html#python-generator-args">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-all-wild-imports.html#python-all-wild-imports">__all__ and wild imports in&nbsp;Python</a></h2>
    <p>
      Posted on Mon 26 December 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/modules.html">modules</a>,      <a href="http://xion.io/tag/imports.html">imports</a>,      <a href="http://xion.io/tag/testing.html">testing</a>      &#8226; <a href="http://xion.io/post/code/python-all-wild-imports.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>An often misunderstood piece of Python import machinery is the <code>__all__</code> attribute.
While it is completely <em>optional</em>,
it&#8217;s common to see modules with the <code>__all__</code> list populated&nbsp;explicitly:</p>
<div class="highlight"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Foo&#39;</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c"># ...</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="c"># ...</span>

<span class="k">def</span> <span class="nf">baz</span><span class="p">():</span>
    <span class="c"># ...</span>
</pre></div>


<p>Before explaining what the real purpose of <code>__all__</code> is
(and how it relates to the titular wild imports),
let&#8217;s deconstruct some common misconceptions by highlighting what it <em>isn&#8217;t</em>:</p>
<ul>
<li>
<p><code>__all__</code> doesn&#8217;t prevent any of the module symbols (functions, classes, etc.)
from being <em>directly</em> imported.
In our the example, the seemingly omitted <code>baz</code> function (which is not included in <code>__all__</code>),
is still <em>perfectly importable</em> by writing <code>from module import baz</code>.</p>
</li>
<li>
<p>Similarly, <code>__all__</code> doesn&#8217;t influence what symbols are included in the results of
<code>dir(module)</code> or <code>vars(module)</code>. So in the case above, a <code>dir</code> call would result in a
<code>['Foo', 'bar', 'baz']</code> list, even though <code>'baz'</code> does not occur in <code>__all__</code>.</p>
</li>
</ul>
<p>In other words, the content of <code>__all__</code> is more of a convention
rather than a strict limitation.
Regardless of what you put there, every symbol defined in your module
will still be accessible from the&nbsp;outside.</p>
<p>This is a clear reflection of the common policy in Python:
assume <a href="https://mail.python.org/pipermail/tutor/2003-October/025932.html">everyone is a consenting adult</a>,
and that visibility controls are not necessary.
Without an explicit <code>__all__</code> list,
Python simply puts all of the module &#8220;public&#8221; symbols there anyway<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>The meaning of it <code>__all__</code></h4>
<p>So, what does <code>__all__</code> actually&nbsp;effect?</p>
<p>This is neatly summed up in this brief
<a href="http://stackoverflow.com/a/2187636/434799">StackOverflow answer</a>.
Simply speaking, its purpose is&nbsp;twofold:</p>
<ul>
<li>
<p>It tells the readers of the source code &#8212; be it humans or automated tools &#8212;
what&#8217;s the conventional <em>public <span class="caps">API</span></em> exposed by the&nbsp;module.</p>
</li>
<li>
<p>It lists names to import when performing the so-called <em>wild import</em>:
<code>from module import *</code>.</p>
</li>
</ul>
<p>Because of the default content of <code>__all__</code> that I mentioned earlier,
the public <span class="caps">API</span> of a module can also be defined implicitly.
Some style guides (like the <a href="https://google.github.io/styleguide/pyguide.html">Google one</a>)
are therefore relying on the <code>public</code> and <code>_private</code> naming exclusively.
Nevertheless, an explicit <code>__all__</code> list is still a perfectly valid option,
especially considering that no approach offers any form of <em>actual</em> access&nbsp;control.</p>
<h4>Import&nbsp;star</h4>
<p>The second point, however, has some real runtime&nbsp;significance.</p>
<p>In Python, like in many other languages,
it is recommended to be explicit about the exact functions and classes we&#8217;re importing.
Commonly, the <code>import</code> statement will thus take one of the following&nbsp;forms:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">fatal</span><span class="p">,</span> <span class="n">warning</span> <span class="k">as</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="c"># etc.</span>
</pre></div>


<p>In each case, it&#8217;s easy to see the relevant <em>name</em> being imported.
Regardless of the exact syntax and the possible presence of aliasing (<code>as</code>),
it&#8217;s always the last (qualified) name in the <code>import</code> statement,
before a newline or&nbsp;comma.</p>
<p>Contrast this with an <code>import</code> that ends with an&nbsp;asterisk:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>


<p>This is called a <em>star</em> or <em>wild import</em>, and it isn&#8217;t so straightforward.
This is also the reason why using it is <a href="http://stackoverflow.com/a/3615206/434799">generally discouraged</a>,
except for some <a href="http://stackoverflow.com/a/3615238/434799">very specific situations</a>.</p>
<p>Why? Because you cannot easily see what exact names are being imported here.
For that you&#8217;d have to go to the module&#8217;s source and &#8212; you guessed it &#8212;
look at the <code>__all__</code> list<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>.</p>
<h4>Taming the&nbsp;wild</h4>
<p>Barring some less important details,
the mechanics of <code>import *</code> could therefore be expressed in the following Python&nbsp;(pseudo)code:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">module</span> <span class="kn">as</span> <span class="nn">__temp</span>
<span class="k">for</span> <span class="n">__name</span> <span class="ow">in</span> <span class="n">module</span><span class="p">:</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__temp</span><span class="p">,</span> <span class="n">__name</span><span class="p">)</span>
<span class="k">del</span> <span class="n">__temp</span>
<span class="k">del</span> <span class="n">__name</span>
</pre></div>


<p>One interesting case to consider is
what happens when <code>__all__</code> contains a <em>wrong</em>&nbsp;name.</p>
<p>What if one of the strings there doesn&#8217;t correspond to any name within the&nbsp;module?&#8230;</p>
<div class="highlight"><pre><span class="c"># foo.py</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Foo&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">foo</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">foo</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="s">&#39;module&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s">&#39;Foo&#39;</span>
</pre></div>


<p>Quite predictably, <code>import *</code> blows up.<br>
Notice, however, that regular import <em>still works</em>.<br></p>
<p>All in all (ahem), this hints at a cute little trick which is also very&nbsp;self-evident:</p>
<div class="highlight"><pre><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;DO_NOT_WILD_IMPORT&#39;</span><span class="p">]</span>
</pre></div>


<p>Put this in a Python module, and no one will be able to <code>import *</code> from it!<br>
Much more effective than any lint warning ;-)<br></p>
<h4>Test <code>__all__</code> the&nbsp;things</h4>
<p>Jokes aside, this phenomenon (<code>__all__</code> with an out-of-place name in it) can also backfire.
Especially when
<a href="https://github.com/Xion/callee/blob/277add8170bd0c758f3c4a3068127e8229d2e2d1/callee/__init__.py#L31">reexporting</a>,
it&#8217;s relatively easy to introduce stray <code>'name'</code> into <code>__all__</code>:
one which doesn&#8217;t correspond to any <code>name</code> that&#8217;s <em>actually present</em> in the&nbsp;namespace.</p>
<p>If we commit such a mishap, we are inadvertently lying about the public <span class="caps">API</span> of our package.
What&#8217;s worse is that this mistake can propagate through documentation generators,
and ultimately mislead our&nbsp;users.</p>
<p>While some linters may be able to catch this,
a <a href="https://github.com/Xion/callee/blob/277add8170bd0c758f3c4a3068127e8229d2e2d1/tests/test_all.py#L10">simple test</a>
like this&nbsp;one:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">test_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test that __all__ contains only names that are actually exported.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">yourpackage</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">yourpackage</span><span class="o">.</span><span class="n">__all__</span>
                  <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">yourpackage</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEmpty</span><span class="p">(</span>
        <span class="n">missing</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;__all__ contains unresolved names: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">),))</span>
</pre></div>


<p>is a quick <span class="amp">&amp;</span> easy way to ensure this never&nbsp;happens.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><span class="dquo">&#8220;</span>Public&#8221; symbols have names that don&#8217;t begin with underscore (<code>_</code>).
Of course, &#8220;non-public&#8221; ones are still accessible
but are treated as implicitly unstable <span class="amp">&amp;</span> discouraged.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Or check what symbols there don&#8217;t have a leading underscore.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-all-wild-imports.html#python-all-wild-imports">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python3-primer.html#python3-primer">The brave &#8220;new&#8221; world of Python&nbsp;3</a></h2>
    <p>
      Posted on Mon 15 August 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/python-3.html">Python 3</a>,      <a href="http://xion.io/tag/unicode.html">Unicode</a>,      <a href="http://xion.io/tag/lazy-evaluation.html">lazy evaluation</a>,      <a href="http://xion.io/tag/iterables.html">iterables</a>      &#8226; <a href="http://xion.io/post/code/python3-primer.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>I&#8217;ll blurt it straight up: I&#8217;m not a big fan of Python&nbsp;3.</p>
<p>For a long time, I resisted the appeal of various incremental improvements
that early 3.x releases offered.
And the world agreed with me:
a mere two years ago, Python 3 wasn&#8217;t even <a href="https://alexgaynor.net/2014/jan/03/pypi-download-statistics/">a blip on the PyPI radar</a>.</p>
<p>Lately, however, things seem to be picking up some&nbsp;steam.</p>
<p>As if to compensate for years of &#8220;good enough&#8221;,
Python 3 development team has given in to a steadily accelerating feature creep.
Sure, some of it results in <a href="https://www.python.org/dev/peps/pep-0498/">bad ideas</a>
(or even <a href="https://www.python.org/dev/peps/pep-0628/">ideas you&#8217;d hope are jokes</a>),
but it nevertheless causes an increasingly wide functional gap
between the 2.x and 3.x&nbsp;series.</p>
<p>Starting from around Python 3.5, this gap becomes really noticeable,
even when partially bridged with many excellent backports.
The ecosystem support is also mostly there,
at least insofar as &#8220;not breaking horribly when a package is used in Python&nbsp;3&#8221;.</p>
<p>And then, of course, there is <a href="https://hg.python.org/peps/rev/76d43e52d978">the 2.7 EoL date</a> looming ever&nbsp;closer.</p>
<p>Given all those portents,
even old curmudg&#8230; ahem&#8230; <em>seasoned developers</em> cannot really ignore Python 3 anymore.
For better or for worse, 3.x is how Python will look like in the coming years and decades.
Might as well prepare for&nbsp;it.</p>
<p>In this post, I will discuss some important issues
one should be aware of before trying to switch from Python 2 to 3.
I won&#8217;t be talking about all the minute changes and additions,
but cover the more significant, broader concepts
that mark the divide between the 2.x and 3.x&nbsp;generations.</p>
<p>The two concepts I&#8217;ll be mentioning here are
<em>Unicode</em> (obviously) and <em>lazy vs. eager computation</em>.</p>
<h4>Unicode&nbsp;handling</h4>
<p>You have probably heard it before.
Python 3 was going to solve your Unicode problems once and for all.
You haven&#8217;t believed it, of course,
like you wouldn&#8217;t believe in any other silver&nbsp;bullet.</p>
<p>Still, it may be rather surprising to learn
that in Python 3, you&#8217;ll actually see much <em>more</em> Unicode-related&nbsp;errors.</p>
<p>And strange as it may sound, it is  a <em>good</em>&nbsp;thing.</p>
<p>In any case, either version of Python gets the most important thing about Unicode right.
They both distinguish, at the type level,
between <em>strings</em> (of Unicode codepoints) and their <em>encodings</em> (sequences of bytes).
The type that holds the latter is called <code>bytes</code> in both versions,
while strings are stored within the <code>str</code> type in Python 3 and <code>unicode</code> in Python&nbsp;2.</p>
<p>It is from this crucial distinction &#8212; or rather, failing to account for it &#8212;
where all the dreaded Unicode errors ultimately&nbsp;stem.</p>
<p>But where Python 2 does poorly is in the choice of defaults.
You probably know all too well that <code>bytes</code> there is just an alias for <code>str</code>.
That <code>str</code> is a fully functional string type,
even though it can only contain <span class="caps">ASCII</span> characters.
Moreover, it is also the <em>default</em>:
quoted string literals, for example, will be of this type unless specially&nbsp;marked.</p>
<p>This poor choice of defaults is the primary source of latent Unicode bugs in Python 2&nbsp;programs.</p>
<p>What Python 3 does here is to help <em>expose those bugs</em> sooner.
If you already deal with Unicode correctly in your programs
&#8212; maybe because you watched <a href="https://www.youtube.com/watch?v=sgHbC6udIqc">this excellent talk by Ned Batchelder</a> &#8212;
your main benefit will be not having to write that <code>u""</code> quotes anymore.
Otherwise, it&#8217;ll force you to consider the issue from the very beginning,
rather than letting you write &#8220;working&#8221; programs
that crash the moment they have to process some non-<span class="caps">ASCII</span>&nbsp;input.</p>
<h4>Laziness by&nbsp;default</h4>
<p>The second major change that Python 3 brings is of similar nature.
It is also a change of <em>defaults</em>, but the impetus for it is much less&nbsp;evident.</p>
<p>What&#8217;s different in Python 3 is that many built-in functions and methods which used to return <code>list</code>s
are now giving out bespoke objects that only <em>mostly</em> behave like <code>list</code>s.
Included in these are functions like <code>map</code> or <code>filter</code>,
as well as common <code>dict</code>ionary methods such as <code>keys</code> or <code>values</code>.</p>
<p>This change is usually presented as removal of unnecessary&nbsp;cruft:</p>
<ul>
<li><code>itertools.ifilter</code> is now just <code>filter</code></li>
<li><code>xrange</code> is now just <code>range</code></li>
<li><code>dict.iteritems</code> is now just <code>dict.items</code></li>
</ul>
<p>and so&nbsp;on.</p>
<p>In some cases, this is exactly what happens.
For example, there is virtually no downside to the new implementation of <code>range</code>,
especially considering the way it is used most&nbsp;often.</p>
<p>But not every built-in managed to preserve all the functionality of <code>list</code>s.
Indeed, many have <a href="https://docs.python.org/3/library/functions.html?highlight=iterator#map">downgraded</a>
their <span class="caps">API</span> guaratees to those of mere <em>generators</em>,
i.e. the most simplistic and limited flavor of Python iterables.
Working with them is trickier and more error-prone than with lists,
which is due to <a href="http://xion.org.pl/2012/02/08/generator-pitfalls/">various pitfalls</a>
that generators expose us&nbsp;to.</p>
<p>Navigating around those gotchas used to be something that Python code had to opt-in to,
by explicitly importing <a href="https://docs.python.org/2.7/library/itertools.html">the <code>itertools</code> module</a>
and using its functions in place of the built-ins.
What you could gain in return was increased performance, and a lesser memory footprint.
All those benefits came from making the computations <em>lazy</em>
and refraining from storage of the intermediate&nbsp;results.</p>
<p>In Python 3, however, laziness is <em>preordained</em>.
Even if we don&#8217;t need or care about the aforementioned perks,
we have to devise some way of dealing with the pervasive&nbsp;generators.</p>
<p>One option is to embrace lazy evaluation fully,
and adapt to handling unspecified iterables throughout our code bases.<br>
The risk is an increased frequency of bugs stemming from generator misuse &#8212;
including a common mistake of trying to iterate over lazy <code>foos</code> the second time,
deeper down a long function, after it&#8217;s been already&nbsp;exhausted.</p>
<p>The alternative is to engage in a lot of &#8220;defensive <code>list</code>ing&#8221;:
wrapping of unknown (or known-but-lazy) iterables in <code>list()</code> calls
in order to &#8220;sanitize&#8221; them for later (re)use.<br>
Examples include immediate <code>list</code>ification of a generator&nbsp;object:</p>
<div class="highlight"><pre><span class="n">primes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)))</span>
</pre></div>


<p>or preemptive conversion of an incoming iterable&nbsp;argument:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">foos</span><span class="p">):</span>
    <span class="n">foos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">foos</span><span class="p">)</span>
    <span class="c"># ...the rest of a long function...</span>
</pre></div>


<p>Even if you choose the first path, and somehow use lazy generators everywhere,
conversions are still required at the serialization&nbsp;boundaries:</p>
<div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;keys&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>  <span class="c"># TypeError: dict_keys([&#39;foo&#39;]) is not JSON serializable</span>
<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;keys&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())})</span>  <span class="c"># works</span>
</pre></div>


<p>At least in this case, the lazy iterable will vocally fail with an exception,
rather than silently doing nothing (in case of repeated iteration)
or always posing as truthy even when it&#8217;s empty (in <code>if iterable:</code> checks).</p>
<h4>from __future__ import&nbsp;doubts</h4>
<p>So, here they are: the highlights of Python 3.
If you are disappointed they all turned out to be mixed blessings,
don&#8217;t worry: you are
<a href="http://lucumr.pocoo.org/2011/12/7/thoughts-on-python3/">in</a>
<a href="http://lucumr.pocoo.org/2014/1/5/unicode-in-2-and-3/">a</a>
<a href="http://lucumr.pocoo.org/2014/5/12/everything-about-unicode/">good</a>
<a href="http://lucumr.pocoo.org/2014/8/16/the-python-i-would-like-to-see/">company</a>.</p>
<p>The truth is that Python 3 is more finnicky, less forgiving,
and much less beginner-friendly than its predecessor.
Its various <a href="https://www.python.org/dev/peps/pep-0237/">superficial simplifications</a> are almost squarely balanced
by many new concerns that are thrust upon an unsuspecting programmer from the very&nbsp;beginning.</p>
<p>In one possible view, this is simply a sign that the language has <em>matured</em>.
Perhaps it&#8217;s not a coincidence
that almost exactly <a href="http://python-history.blogspot.com/2009/01/brief-timeline-of-python.html">18 years</a>
has passed between the first public version of Python (0.9)
and the release of Python 3.0.
By no conceivable means it is a toy language anymore,
and it&#8217;s adequately equipped to tackle challenges presented by the computing world of&nbsp;today.</p>
<p>But on the other hand, it&#8217;s clear something is being gradually lost in the&nbsp;process.</p>
<p>It&#8217;s becoming harder to claim the language favors simplicity
over <a href="https://www.python.org/dev/peps/pep-0492/">complexity</a>.<br>
It is no longer so easy to pick <a href="https://www.python.org/dev/peps/pep-3101/">which way</a>
is the <em>obvious</em> way to do it.<br>
It is increasingly often that <a href="https://www.python.org/dev/peps/pep-3113/">ugly replaces beautiful</a>
and <a href="https://www.python.org/dev/peps/pep-3108/">nested replaces flat</a>.</p>
<p>Little by little, Python itself is becoming less and less <em>pythonic</em>.
The pace isn&#8217;t breakneck, but it&#8217;s definitely noticeable.
But who knows? Maybe after two decades,
a wholesale redefinition of the language&#8217;s core principles really <em>is</em> in&nbsp;order.</p>
<p>&#8230;Well, certainly that&#8217;s necessary if some of the <a href="https://www.python.org/dev/peps/pep-0526/">latest ideas</a>
are about to get&nbsp;in!</p>
      <a class="btn" href="http://xion.io/post/code/python3-primer.html#python3-primer">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-startswith-tuple.html#python-startswith-tuple">str.startswith() with tuple&nbsp;argument</a></h2>
    <p>
      Posted on Tue 28 June 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/strings.html">strings</a>,      <a href="http://xion.io/tag/tuples.html">tuples</a>      &#8226; <a href="http://xion.io/post/code/python-startswith-tuple.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Here&#8217;s a little known trick that&#8217;s applicable to Python&#8217;s <a href="http://bugs.python.org/issue1491485"><code>startswith</code></a>
and <a href="http://bugs.python.org/issue1491485"><code>endswith</code></a> methods of <code>str</code> (and <code>unicode</code>).</p>
<p>Suppose you&#8217;re checking whether a string starts with some&nbsp;prefix:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;http://&#39;</span><span class="p">):</span>
    <span class="c"># totally an URL</span>
</pre></div>


<p>You eventually add more possible prefixes (or suffixes) to your&nbsp;condition:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;http://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;https://&#39;</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>Later on you notice the repetition and refactor it into something like&nbsp;this:</p>
<div class="highlight"><pre><span class="n">SCHEMES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;http://&#39;</span><span class="p">,</span> <span class="s">&#39;https://&#39;</span><span class="p">,</span> <span class="s">&#39;ftp://&#39;</span><span class="p">,</span> <span class="s">&#39;git://&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">SCHEMES</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>or if you&#8217;re feeling extra&nbsp;functional:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">,</span> <span class="n">SCHEMES</span><span class="p">)):</span>
    <span class="c"># ...</span>
</pre></div>


<p>Turns out, however, that <code>startswith</code> (and <code>endswith</code>) support this use case natively.
Rather than passing just a single string as the argument,
you can provide a <em>tuple</em> of strings&nbsp;instead:</p>
<div class="highlight"><pre><span class="n">SCHEMES</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;http://&#39;</span><span class="p">,</span> <span class="s">&#39;https://&#39;</span><span class="p">,</span> <span class="s">&#39;ftp://&#39;</span><span class="p">,</span> <span class="s">&#39;git://&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">SCHEMES</span><span class="p">):</span>
    <span class="c"># ...</span>
</pre></div>


<p>Either method will then check the original string against every element of the passed tuple.
Both will only return <code>True</code> if <em>at least one</em> of the strings is recognized as prefix/suffix.
As you can see, that&#8217;s exactly what we would previously do with <code>any</code>.</p>
<p>Somewhat surprisingly, however, the feature only works for actual <em>tuples</em>.
Trying to pass a seemingly equivalent iterable &#8212; a <code>list</code> or <code>set</code>, for example &#8212;
will be met with interpreter&#8217;s&nbsp;refusal:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">is_jpeg</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">([</span><span class="s">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s">&#39;.jpeg&#39;</span><span class="p">])</span>
</pre></div>


<!---->

<div class="highlight"><pre>TypeError: endswith first arg must be str, unicode, or tuple, not list
</pre></div>


<p>If you dig into it, there doesn&#8217;t seem to be a compelling reason for this behavior.
The <a href="http://bugs.python.org/issue1491485">relevant feature request</a> talks about
consistency with the built-in <code>isinstance</code> function,
but it&#8217;s quite difficult to see how those two are&nbsp;related.</p>
<p>In any case, this can be worked around without much&nbsp;difficulty:</p>
<div class="highlight"><pre><span class="n">PROTOCOLS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">,</span> <span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;git&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="s">&#39;://&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">PROTOCOLS</span><span class="p">)):</span>
    <span class="c"># ...</span>
</pre></div>


<p>though ideally, you&#8217;d want to pack the prefixes in a tuple to begin&nbsp;with.</p>
      <a class="btn" href="http://xion.io/post/code/python-startswith-tuple.html#python-startswith-tuple">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/code/python-or-lambda.html#python-or-lambda">&#8230;or&nbsp;lambda?</a></h2>
    <p>
      Posted on Mon 20 June 2016 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/syntax.html">syntax</a>,      <a href="http://xion.io/tag/lambda.html">lambda</a>,      <a href="http://xion.io/tag/operators.html">operators</a>      &#8226; <a href="http://xion.io/post/code/python-or-lambda.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>a.k.a. Curious Facts about Python&nbsp;Syntax</em></p>
<p>In Python 3.3,
a new method has been <a href="https://docs.python.org/3/library/stdtypes.html#str.casefold">added</a> to the <code>str</code> type: <code>casefold</code>.
Its purpose is to return a &#8220;sanitized&#8221; version of the string
that&#8217;s suitable for case-insensitive comparison.
For older versions of Python,
an alternative way that&#8217;s <em>mostly</em> compatible is to use the <code>str.lower</code> method,
which simply changes all letters in the string to&nbsp;lowercase.</p>
<h4>Syntax is&nbsp;hard</h4>
<p>Easy enough for a compatibility shim, right?
That&#8217;s exactly what I thought when I came up with&nbsp;this:</p>
<div class="highlight"><pre><span class="n">casefold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="s">&#39;casefold&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</pre></div>


<p>Let&#8217;s ignore for a moment
the fact that for a correct handling of <code>unicode</code> objects in Python 2,
a <a href="http://stackoverflow.com/a/32838944/434799">much more sophisticated approach</a> is necessary.
What&#8217;s rather more pertinent is that this simple code <em>doesn&#8217;t parse</em>:</p>
<div class="highlight"><pre>  File &quot;foo.py&quot;, line 42
    getattr(str, &#39;casefold&#39;, None) or lambda s: s.lower()
                                      ^
SyntaxError: invalid syntax
</pre></div>


<p>It&#8217;s not very often that you would produce a <code>SyntaxError</code> with code
that looks perfectly valid to most pythonistas.
The <a href="http://xion.org.pl/2012/04/16/the-infernal-comma/">last time I had it happen</a>,
the explanation was rather surprising and not exactly trivial to come&nbsp;by.</p>
<p>Fortunately, there is always one place
where we can definitively resolve any syntactic confusion.
That place is the <a href="https://docs.python.org/2/reference/grammar.html">full grammar specification</a>
of the Python&nbsp;language.</p>
<p>It may be a little intimidating at first,
especially if you&#8217;re not familiar with the <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_Form"><span class="caps">ENBF</span> notation</a> it uses.
All the Python&#8217;s language constructs are there, though,
so the <code>SyntaxError</code> from above should be traceable to a some rule of the grammar<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<h4>The&nbsp;culprit</h4>
<p>And indeed, the offending bit is right&nbsp;here:</p>
<div class="highlight"><pre>or_test: and_test (&#39;or&#39; and_test)*
and_test: not_test (&#39;and&#39; not_test)*
...
</pre></div>


<p>It says, essentially, that Python defines the <code>or</code> expression (<code>or_test</code>)
as a sequence of <code>and</code> expressions (<code>and_test</code>).
If you follow the syntax definition further, however,
you will notice that <code>and_test</code> expands to
comparisons (<code>a &lt; b</code>, etc.),
arithmetic expressions (<code>x + y</code>, etc.),
<code>list</code> <span class="amp">&amp;</span> <code>dict</code> constructors (<code>[foo, bar]</code>, etc.),
and finally to <em>atoms</em> such as literal strings and&nbsp;numbers.</p>
<p>What you <em>won&#8217;t</em> see along the way are lambda&nbsp;definitions:</p>
<div class="highlight"><pre>lambdef: &#39;lambda&#39; [varargslist] &#39;:&#39; test
</pre></div>


<p>In fact, the branch to allow them is directly above the <code>or_test</code>:</p>
<div class="highlight"><pre>test: or_test [&#39;if&#39; or_test &#39;else&#39; test] | lambdef
</pre></div>


<p>As you can see, the rule puts lambdas at the same syntactical level as conditional expressions
(<code>x if a else b</code>), which is <em>very</em> high up.
The only thing you can do with a <code>lambda</code> to make a larger expression
is to add a <code>yield</code> keyword before it<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>, or follow it with a comma to create a tuple<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.</p>
<p>You cannot, however, pass it as an argument to a binary operator,
even if it otherwise makes sense and even <em>looks</em> unambiguous.
This is also why the nonsensical expressions such as this&nbsp;one:</p>
<div class="highlight"><pre><span class="mi">1</span> <span class="o">+</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span>
</pre></div>


<p>will fail not with <code>TypeError</code>, but also with <code>SyntaxError</code>,
as they won&#8217;t even be&nbsp;evaluated.</p>
<h4>More&nbsp;parentheses</h4>
<p>Savvy readers may have noticed that this phenomenon is very much reminiscent
of the issue of <em>operator precedence</em>.</p>
<p>Indeed, in Python and in many other languages it is the grammar
that ultimately specifies the order of operations.
It does so simply by defining how expressions can be&nbsp;constructed.</p>
<p>Addition, for example, will be of lower priority than multiplication
simply because a <em>sum</em> is said to comprise of terms that are <em>products</em>:</p>
<div class="highlight"><pre>arith_expr: term ((&#39;+&#39;|&#39;-&#39;) term)*
term: factor ((&#39;*&#39;|&#39;/&#39;|&#39;%&#39;|&#39;//&#39;) factor)*
</pre></div>


<p>This makes operator precedence a syntactic feature,
and its resolution is baked into the language parser and handled implicitly<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>.</p>
<p>We know, however, that precedence can be worked around where necessary
by enclosing the operator and its arguments in a pair of parenthesis.
On the syntax level, this means creating an entirely new, top-level&nbsp;expression:</p>
<div class="highlight"><pre>atom: &#39;(&#39; [yield_expr|testlist_comp] &#39;)&#39; |  # parenthesized expression
       &#39;[&#39; [listmaker] &#39;]&#39; |
       &#39;{&#39; [dictorsetmaker] &#39;}&#39; |
       &#39;`&#39; testlist1 &#39;`&#39; |
       NAME | NUMBER | STRING+)
</pre></div>


<p>There, it is again possible to use even the highest-level constructs,
including also the silly stuff such as trying to add a number to a&nbsp;function:</p>
<div class="highlight"><pre><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>This expression will now parse correctly,
 and produce <code>TypeError</code> as&nbsp;expected.</p>
<p>In the end, the resolution of our initial dilemma is therefore rather&nbsp;simple:</p>
<div class="highlight"><pre><span class="n">casefold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="s">&#39;casefold&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</pre></div>


<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Such rules are sometimes called <em>productions</em> of the grammar,
a <a href="https://en.wikipedia.org/wiki/Production_%28computer_science%29">term</a> from computational linguistics.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Yes, <code>yield foo</code> is an expression.
Its result is the value sent <em>to</em> the generator by outer code via the <code>send</code> method.
Since most generators are used as iterables, typically no values are passed this way
so the result of a <code>yield</code> expression is <code>None</code>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>There are also a legacy corner cases of lambdas in <code>list</code>/<code>dict</code>/etc. comprehensions,
but those only apply under Python 2.x.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>This saying, there are languages where the order is resolved at later stage,
after the expressions have already been parsed. They usually allow the programmer
to change the precedence of their own operators,
as it&#8217;s the case in <a href="https://www.haskell.org/tutorial/functions.html#sect3.2.2">Haskell</a>.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/python-or-lambda.html#python-or-lambda">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/python-dont-use-click.html#python-dont-use-click">Please don&#8217;t use&nbsp;Click</a></h2>
    <p>
      Posted on Fri 20 May 2016 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/python.html">Python</a>,      <a href="http://xion.io/tag/cli.html">CLI</a>,      <a href="http://xion.io/tag/ui.html">UI</a>,      <a href="http://xion.io/tag/click.html">Click</a>      &#8226; <a href="http://xion.io/post/programming/python-dont-use-click.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p><em>&#8230;not for standalone programs&nbsp;anyway.</em></p>
<p>Chances are, you have written some command line programs in Python. This is quite probable even if you normally code
in some other language. And if you have, it is not unlikely that you needed to parse the <code>argv</code> of your program at one
point or&nbsp;another.</p>
<p>There are plenty of options here, both in the standard library as well as among third party packages. One does stand out,
however, and it&#8217;s mostly for how it is often overused. I&#8217;m talking about <a href="http://click.pocoo.org/">Click</a>&nbsp;here.</p>
<p>If you wanted to use it in your next Python program, I hereby urge you to&nbsp;reconsider.</p>
<h4>What&#8217;s the&nbsp;fuss?</h4>
<p><img style="float:right; margin-left: 8px; margin: bottom: 7px" src="http://xion.io/images/click-logo.png" alt="click_">
The somewhat bizarrely named Click library is described as a &#8220;package for creating beautiful
command line interfaces&#8221;. Its main trick is the ability to create subcommands by adorning Python functions with the
<code>@click.command()</code> decorator<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. It then makes them coalesce into an argument parser, equipped with the necessary
dispatching&nbsp;logic.</p>
<p>This idea isn&#8217;t new, of course. Prior art goes back at least seven years to the now-abandoned
<a href="https://opster.readthedocs.io">opster</a> package. Click, however, was the first one of its kind to garner noticeable
popularity, which is easily attributed to <a href="http://lucumr.pocoo.org/">whom it&#8217;s been authored by</a>.</p>
<p>So while my arguments against using this kind of <span class="caps">CLI</span> framework would apply to any package implementing the paradigm,
it just happens that Click is currently its most prominent example. Purely for the sake of convenience, I will therefore
refer to it as if it was interchangeable with the whole concept. Because why not? Whatever you may say about
the library&#8217;s name, it&#8217;s hard to imagine a more concise moniker than a simple <em>Click</em>.</p>
<p>What&#8217;s wrong, then, with the way Click handles command line&nbsp;interfaces?</p>
<h4><span class="caps">CLI</span>: Little&nbsp;Interfaces</h4>
<p>It&#8217;s how it encourages to treat them as an <em>accidental afterthought</em> rather than a deliberate design&nbsp;decision.</p>
<p>For applications invoked repeatedly from a terminal, their command line arguments and flags are the primary means of
user interaction<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup>. It is how users communicate their intent to perform an action; provide the neccessary input data
to carry it throgh; decide how they want to receive the output; and control many other aspects of the programs execution.
Absent graphical components and widgets, the command line is virtually the only way to interact with a terminal&nbsp;program.</p>
<p>In other words, it is <strong>the <span class="caps">UI</span></strong>.</p>
<p>And how important the <span class="caps">UI</span> is for <em>any</em> application? It seems to be important enough that entire fields of study are devoted
to reducing friction of human-computer interaction. In many projects, the emphasis on user interface design is on par
with that of actual software engineering.<br>
Like everything, of course, it is susceptible to trends and fads (such as the recent &#8220;mobile/responsive everything!&#8221;
craze). But its significance remains undiminished. Quite the opposite: in the age of ubiquitous computing,
user interfaces are probably more important than&nbsp;ever.</p>
<p>Yes, this includes <span class="caps">CLI</span>. One of the main reasons we turn to the command line are <em>speed</em> and <em>efficacy</em>. Common tasks must
utilize short and convenient syntax that is quick to integrate into user&#8217;s muscle memory. Others should not only be
possible, but <em>discoverable</em> and <em>accessible</em> without going through reams of <code>man</code> pages.</p>
<p>Any terminal program intended for frequent use by humans should therefore strive to excel in those two qualities.
But except for <a href="http://linux.die.net/man/1/echo">the simplest of cases</a>, it won&#8217;t happen by itself.
Designing an efficient <span class="caps">CLI</span> for any non-trivial application is a challenging and demanding&nbsp;task.</p>
<h4>It doesn&#8217;t&nbsp;click</h4>
<p>With Click, however, we&#8217;re encouraged to just wing&nbsp;it.</p>
<p>Click tells us to slap some decorators on our top-level functions and call it a day. Sure, you can dig deep enough
and uncover the underlying layers of abstraction that may eventually allow you do things for which <code>argparse</code> has
a <a href="https://docs.python.org/3/library/argparse.html#mutual-exclusion">first-class support</a>.</p>
<p>By default, however, Click shoehorns your programs into
<a href="http://click.pocoo.org/5/quickstart/#basic-concepts">predefined patterns</a> that, incidentally, mirror those of some
<a href="http://click.pocoo.org/5/complex/#building-a-git-clone">least intuitive</a> command-line tools in&nbsp;existence.</p>
<p>Indeed, the whole idea of subdiving your program into several distinct is already suspect, for it appears at odds
with the fundamental Unix philosophy of
<a href="https://en.wikipedia.org/wiki/Unix_philosophy#Do_One_Thing_and_Do_It_Well">doing one thing well</a>. While it is
occasionally justified, it shouldn&#8217;t be the first thing that comes to your mind. But that&#8217;s completely at odds with the
Click&#8217;s approach, where <em>not</em> ending up with multiple distinct commands is something you have to consciously&nbsp;avoid.</p>
<h4>&#8230;though it sometimes&nbsp;might</h4>
<p>So, what <em>am</em> I suggesting you use instead libraries such as Click?&#8230; Nothing outrageous,&nbsp;really.</p>
<p>If you care about your command line interface, consider just using
<a href="https://docs.python.org/3/library/argparse.html">the <code>argparse</code> module</a>. Yes, it will force you to create parser objects,
add arguments <span class="amp">&amp;</span> flags to it, and in general pay some attention to the whole business. When it comes to <span class="caps">UI</span>, it&#8217;s always
good to make it an explicit concern, maybe even sufficient to warrant
<a href="https://github.com/Xion/gisht/blob/e86af37388573f00a4d6f282feca76ead88725d8/gisht/args/parser.py">its own module</a>.</p>
<p>Alternatively, the <a href="https://github.com/docopt/docopt"><code>docopt</code> library</a> provides another take on the <span class="caps">UI</span>-first approach
to <span class="caps">CLI</span>, though it is more limited in its capabilities<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.</p>
<p>Finally, I&#8217;m not advocating to ditch Click in <em>all</em> scenarios. There&#8217;s plenty of situations when we&#8217;re interested in
getting <em>any</em> <span class="caps">CLI</span> up and running, and not so much in making the most efficient and intuitive interface possible. The prime
example is any kind of automation scripts that are ancillary to some bigger project, like <em>manage.py</em> is in Django<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>.
The Python ecosystem doesn&#8217;t really have dedicated task runners that are as featureful as <a href="http://gruntjs.com">Grunt</a>
or <a href="http://gulpjs.com/">Gulp</a>, and that makes Click a viable and compelling option<sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup>.</p>
<p>But for standalone programs whose <span class="caps">CLI</span> is the main interface? Yeah, not&nbsp;really.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Oddly enough, that pair of parentheses seems to be mandatory.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Environment variables and config files deserve a honorary mention, of course. But those are usually derivatives of
the command line arguments, containing e.g. the default values for flags.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Click&#8217;s <a href="http://click.pocoo.org/5/why/#why-not-docopt-etc">own documentation</a> actually describes quite nicely
how theirs and docopt&#8217;s philosophies differ in a way that&#8217;s consistent with this article.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Incidentally, this appears to be a major motivation behind creating Click in the first place:
to support web applications built upon on the <a href="http://flask.pocoo.org/">Flask</a> framework, and possibly obviate the need
for extensions such as <a href="http://flask-script.readthedocs.io/en/latest/">Flask-Script</a>.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>This saying, there are some task runners which offer similar experience, like <a href="http://pyinvoke.org">Invoke</a>.&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/programming/python-dont-use-click.html#python-dont-use-click">Continue reading</a>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://xion.io/tag/python2.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>