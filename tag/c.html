<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://xion.io/$theme/stylesheet/font-awesome.min.css">

    <link href="http://xion.io/style.css" rel="stylesheet">




  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <meta name="author" content="Karol Kuczmarski" />
    <meta name="description" content="" />
<meta property="og:site_name" content="Karol Kuczmarski's Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Karol Kuczmarski's Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://xion.io"/>
<meta property="og:image" content="http://xion.io/logo.jpeg">

  <title>Karol Kuczmarski's Blog &ndash; Tag: C#</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://xion.io">
        <img src="http://xion.io/logo.jpeg" alt="Karol Kuczmarski" title="Karol Kuczmarski">
      </a>
      <h1><a href="http://xion.io">Karol Kuczmarski</a></h1>
      <p>fn(Tea) -> Code</p>
      <nav>
        <ul class="list">
          <li><a href="http://xion.io/page/about.html#about">About</a></li>
          <li><a href="http://xion.io/page/projects.html#projects">Projects</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="http://github.com/Xion" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/434799/xion" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-twitter" href="http://twitter.com/Xion__" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KarolKuczmarski" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://xion.io">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://xion.org.pl/">Old blog</a>
    </nav>

<article>
  <header>
    <h2><a href="http://xion.io/post/code/rust-extension-traits.html#rust-extension-traits">Extension traits in&nbsp;Rust</a></h2>
    <p>
      Posted on Tue 20 June 2017 in <a href="http://xion.io/category/code.html">Code</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/rust.html">Rust</a>,      <a href="http://xion.io/tag/c.html">C#</a>,      <a href="http://xion.io/tag/methods.html">methods</a>,      <a href="http://xion.io/tag/extension-methods.html">extension methods</a>,      <a href="http://xion.io/tag/traits.html">traits</a>      &#8226; <a href="http://xion.io/post/code/rust-extension-traits.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>In a few object-oriented languages,
it is possible to add methods to a class <em>after</em> it&#8217;s already been&nbsp;defined.</p>
<p>This feature arises quite naturally if the language has a dynamic type system
that&#8217;s modifiable at runtime.
In those cases, even <em>replacing</em> existing methods is perfectly possible<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p>In addition to that,
some statically typed languages &#8212; most notably in C# &#8212;
offer <em>extension methods</em> as a <a href="cs-ext-methods">dedicated feature</a> of their type systems.
The premise is that you would write standalone functions whose
first argument is specially designated (usually by <code>this</code> keyword)
as a receiver of the resulting method&nbsp;call:</p>
<div class="highlight"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">WordCount</span><span class="p">(</span><span class="k">this</span> <span class="n">String</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">str</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span> <span class="kt">char</span><span class="p">[]</span> <span class="p">{</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="sc">&#39;?&#39;</span> <span class="p">},</span>
                     <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">).</span><span class="n">Length</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>At the call site,
the new method is indistinguishable from any of the existing&nbsp;ones:</p>
<div class="highlight"><pre><span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="s">&quot;Alice has a cat.&quot;</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">WordCount</span><span class="p">();</span>
</pre></div>


<p>That&#8217;s assuming you have imported both the original class
(or it&#8217;s a built-in like <code>String</code>),
as well as the module in which the extension method is&nbsp;defined.</p>
<h4>Rewrite it in&nbsp;Rust</h4>
<p>The curious thing about <a href="http://rust-lang.org">Rust</a>&#8216;s type system is
that it permits extension methods solely as a side effect of its core building block: <em>traits</em>.</p>
<p>In this post, I&#8217;m going to describe a certain design pattern in Rust
which involves third-party types and user-defined traits.
Several popular crates &#8212;
like <a href="https://docs.rs/itertools">itertools</a> or <a href="https://docs.rs/unicode-normalization/">unicode-normalization</a> &#8212;
utilize it very successfully to add new, useful methods to the language standard&nbsp;types.</p>
<p>I&#8217;m not sure if this pattern has an official or widely accepted name.
Personally, I&#8217;ve taken to calling it <strong>extension traits</strong>.</p>
<p>Let&#8217;s have a look at how they are commonly&nbsp;implemented.</p>
<h4>Ingredients</h4>
<p>We can use the extension trait pattern if we want to have additional methods in a type
that we don&#8217;t otherwise control (or don&#8217;t want to&nbsp;modify).</p>
<p>Common cases&nbsp;include:</p>
<ul>
<li>Rust standard library types, like <code>Result</code>, <code>String</code>,
  or anything else inside the <code>std</code> namespace</li>
<li>types imported from <a href="https://crates.io">third-party&nbsp;libraries</a></li>
<li>types from the current crate if additional methods only make sense in certain scenarios
  (e.g. conditional compilation / testing)<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup></li>
</ul>
<p>The crux of this technique is really simple.
Like with most design patterns, however,
it involves a certain degree of boilerplate and&nbsp;duplication.</p>
<p>So without further ado&#8230;
In order to &#8220;patch&#8221; some new method(s) into an external type you will need&nbsp;to:</p>
<ol>
<li>Define a trait with signatures of all the methods you want to&nbsp;add.</li>
<li>Implement it for the external&nbsp;type.</li>
<li><em>There is no step three</em>.</li>
</ol>
<p>As an important note on the usage side,
the calling code needs to <em>import your new trait</em> in addition to the external type.
Once that&#8217;s done, it can proceed to use the new methods is if they were there to begin&nbsp;with.</p>
<p>I&#8217;m sure you are keen on seeing some&nbsp;examples!</p>
<h4>Broadening your <code>Option</code>s</h4>
<p>We&#8217;re going to add two new methods to Rust&#8217;s <a href="https://doc.rust-lang.org/std/option/enum.Option.html">standard <code>Option</code> type</a>.
The goal is to make it more convenient to operate on mutable <code>Option</code>s
by allowing to easily replace an existing value with another one<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup>.</p>
<p>Here&#8217;s the appropriate extension trait<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup>:</p>
<div class="highlight"><pre><span class="c-Doc">/// Additional mutation methods for `Option`.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">OptionMutExt</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c-Doc">/// Replace the existing `Some` value with a new one.</span>
<span class="w">    </span><span class="c-Doc">///</span>
<span class="w">    </span><span class="c-Doc">/// Returns the previous value if it was present, or `None` if no replacement was made.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c-Doc">/// Replace the existing `Some` value with the result of given closure.</span>
<span class="w">    </span><span class="c-Doc">///</span>
<span class="w">    </span><span class="c-Doc">/// Returns the previous value if it was present, or `None` if no replacement was made.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">replace_with</span><span class="o">&lt;</span><span class="n">F</span><span class="o">:</span><span class="w"> </span><span class="n">FnOnce</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>It may feel at little bit weird to implement it.<br>
You will basically have to pretend you are <em>inside the <code>Option</code> type itself</em>:</p>
<div class="highlight"><pre><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OptionMutExt</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">replace</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">replace_with</span><span class="p">(</span><span class="n">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">replace_with</span><span class="o">&lt;</span><span class="n">F</span><span class="o">:</span><span class="w"> </span><span class="n">FnOnce</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="o">:</span><span class="w"> </span><span class="n">F</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">take</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="bp">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">f</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">result</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">None</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Unfortunately, this is just an illusion.
Extension traits grant no special powers
that&#8217;d allow you to bypass any of the regular visibility rules.
All you can use inside the new methods is still
just the <em>public interface</em> of the type you&#8217;re augmenting (here, <code>Option</code>).</p>
<p>In our case, however, this is good enough,
mostly thanks to <a href="option_take">the recently introduced <code>Option::take</code></a>.</p>
<p>To use our shiny new methods in other places,
all we have to do is import the extension&nbsp;trait:</p>
<div class="highlight"><pre><span class="kn">use</span><span class="w"> </span><span class="n">ext</span><span class="o">::</span><span class="n">rust</span><span class="o">::</span><span class="n">OptionMutExt</span><span class="p">;</span><span class="w">  </span><span class="c1">// assuming you put it in ext/rust.rs</span>

<span class="c1">// ...somewhere...</span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">opt</span><span class="o">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span><span class="w"></span>
<span class="k">match</span><span class="w"> </span><span class="n">opt</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Option had a value of {} before replacement&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>It doesn&#8217;t matter where it was defined either,
meaning we can ship it away to <a href="https://crates.io">crates.io</a>
and let it accrue as many happy users as <code>Itertools</code> has&nbsp;;-)</p>
<h4>Are you <code>hyper::Body</code> ready?</h4>
<p>Our second example will demonstrate attaching more methods to a third-party&nbsp;type.</p>
<p>Last week, there was a new release of <a href="https://hyper.rs/">Hyper</a>,
a popular Rust framework for <span class="caps">HTTP</span> servers <span class="amp">&amp;</span> clients.
It was notable because it marked a switch from synchronous, straightforward <span class="caps">API</span>
to a more complex, asynchronous one
(which I incidentally <a href="http://xion.io/post/programming/rust-async-closer-look.html">wrote about a few weeks ago</a>).</p>
<p>Predictably, <a href="https://www.reddit.com/r/rust/comments/6hksa0/problems_with_understanding_hypers_async/">there has been some confusion</a>
among its new and existing&nbsp;users.</p>
<p>We&#8217;re going to help by pinning a more convenient interface on
<a href="https://hyper.rs/hyper/master/hyper/struct.Body.html">hyper&#8217;s <code>Body</code> type</a>.
<code>Body</code> here is a struct representing the content of an <span class="caps">HTTP</span> request or response.
After the &#8216;asyncatastrophe&#8217;,
it doesn&#8217;t allow to access the raw incoming bytes as easily as it did&nbsp;before.</p>
<p>Thanks to extension traits, we can fix this rather&nbsp;quickly:</p>
<div class="highlight"><pre><span class="kn">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">error</span><span class="o">::</span><span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="kn">use</span><span class="w"> </span><span class="n">futures</span><span class="o">::</span><span class="p">{</span><span class="n">BoxFuture</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">,</span><span class="w"> </span><span class="n">Future</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p">};</span><span class="w"></span>
<span class="kn">use</span><span class="w"> </span><span class="n">hyper</span><span class="o">::</span><span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Body</span><span class="p">};</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">BodyExt</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c-Doc">/// Collect all the bytes from all the `Chunk`s from `Body`</span>
<span class="w">    </span><span class="c-Doc">/// and return it as `Vec&lt;u8&gt;`.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">into_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">BoxFuture</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">hyper</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c-Doc">/// Collect all the bytes from all the `Chunk`s from `Body`,</span>
<span class="w">    </span><span class="c-Doc">/// decode them as UTF8, and return the resulting `String`.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">into_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">BoxFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">BodyExt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Body</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">into_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">BoxFuture</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">hyper</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">concat</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">bytes</span><span class="o">|</span><span class="w"> </span><span class="n">future</span><span class="o">::</span><span class="n">ok</span><span class="o">::&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">hyper</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">to_vec</span><span class="p">()))</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">boxed</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">into_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">BoxFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">into_bytes</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">Box</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">bytes</span><span class="o">|</span><span class="w"> </span><span class="n">String</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">Box</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">boxed</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>With these new methods in hand,
it is relatively straightforward to implement, say, a simple character-counting&nbsp;service:</p>
<div class="highlight"><pre><span class="kn">use</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">error</span><span class="o">::</span><span class="n">Error</span><span class="p">;</span><span class="w"></span>

<span class="kn">use</span><span class="w"> </span><span class="n">futures</span><span class="o">::</span><span class="p">{</span><span class="n">BoxFuture</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">,</span><span class="w"> </span><span class="n">Future</span><span class="p">};</span><span class="w"></span>
<span class="kn">use</span><span class="w"> </span><span class="n">hyper</span><span class="o">::</span><span class="n">server</span><span class="o">::</span><span class="p">{</span><span class="n">Service</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p">};</span><span class="w"></span>

<span class="kn">use</span><span class="w"> </span><span class="n">ext</span><span class="o">::</span><span class="n">hyper</span><span class="o">::</span><span class="n">BodyExt</span><span class="p">;</span><span class="w">  </span><span class="c1">// assuming the above is in ext/hyper.rs</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="n">Length</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Request</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Response</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Box</span><span class="o">&lt;</span><span class="n">Error</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BoxFuture</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="o">:</span><span class="w"> </span><span class="n">Request</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">deconstruct</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">body</span><span class="p">.</span><span class="n">into_string</span><span class="p">().</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">future</span><span class="o">::</span><span class="n">ok</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">Response</span><span class="o">::</span><span class="n">new</span><span class="p">().</span><span class="n">with_body</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">().</span><span class="n">to_string</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">)).</span><span class="n">boxed</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>Replacing <code>Box&lt;Error + Send&gt;</code> with an idiomatic <a href="https://docs.rs/crate/derive-error/">error enum</a>
is left as an exercise for the reader&nbsp;:)</p>
<h4>Extra credit bonus&nbsp;explanation</h4>
<p><small>Reading this section is not necessary to use extension traits.</small></p>
<p>So far, we have seen what extension traits are capable of.
It is only right to mention what they <em>cannot do</em>.</p>
<p>Indeed, this technique has some limitations.
They are a conscious choice on the part of Rust authors,
and they were decided upon in an effort to keep the type system <em>coherent</em>.</p>
<p>Coherence isn&#8217;t an everyday topic in Rust,
but it becomes important when working with traits and types that cross package boundaries.
Rules of trait coherence
(described briefly towards the end of <a href="coherence-in-book">this section of the Rust book</a>)
state that the following combinations of &#8220;local&#8221; (this crate) and &#8220;external&#8221; (other crates<sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup>) are&nbsp;legal:</p>
<ul>
<li>implement a <em>local</em> trait for a <em>local</em> type.<br>
  This is common in larger programs that use polymorphic&nbsp;abstractions.</li>
<li>implement an <em>external</em> trait for a <em>local</em> type.<br>
  We do this often to integrate with third-party libraries and frameworks,
  just like with <code>hyper</code> above.</li>
<li>implement a <em>local</em> trait for an <em>external</em> type.<br>
  That&#8217;s extension traits for&nbsp;you!</li>
</ul>
<p>What is <em>not</em> possible, however, is&nbsp;to:</p>
<ul>
<li>implement an <em>external</em> trait for an <em>external</em>&nbsp;type</li>
</ul>
<p>This case is prohibited in order to make the choice of trait implementations more predictable,
both for the compiler and for the programmer.
Without this rule in place, you could introduce many instances of <code>impl Trait for Type</code>
(same <code>Trait</code> and same <code>Type</code>),
each one with different functionality,
leaving the compiler to &#8220;guess&#8221; the right <code>impl</code> for any given situation<sup id="fnref:6"><a class="footnote-ref" href="#fn:6" rel="footnote">6</a></sup>.</p>
<p>The decision was thus made to disallow the <code>impl ExternalTrait for ExternalType</code> case altogether.
If you like, you can read <a href="rust-orphans">some more extensive backstory</a> behind&nbsp;it.</p>
<p>Bear in mind, however, that this isn&#8217;t the unequivocally &#8220;correct&#8221; solution.
<a href="hs-orphans">Some languages</a> choose to allow this so-called <em>orphan</em> case,
and try to resolve the potential ambiguities in various different ways.
It is a genuinely useful feature, too, as it makes easier it to glue together two unrelated libraries<sup id="fnref:7"><a class="footnote-ref" href="#fn:7" rel="footnote">7</a></sup>.</p>
<p>Thankfully for extension traits,
the coherence restriction doesn&#8217;t apply as long as you keep those traits and their <code>impl</code>s in the same&nbsp;crate.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This practice is often referred to as <em>monkeypatching</em>, especially in Python and Ruby.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>In this case, a more common solution is to just open another <code>impl Foo</code> block,
annotated with <code>#[cfg(test)]</code> or similar.
An extension trait, however, makes it easier
to extract <code>Foo</code> into a separate crate along with some handy, test-only <span class="caps">API</span>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Note that this is <em>not</em> the same as the unstable (as of 1.18) <code>Option</code> methods
guarded behind <a href="https://github.com/rust-lang/rust/issues/39288">the <code>options_entry</code> feature gate</a>.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>My own convention is to call those traits <code>FooExt</code>
if they are meant to enhance the interface of type <code>Foo</code>.
The other practice is to mirror the name of the crate that the trait is packaged in;
both <code>Itertools</code> and <code>UnicodeNormalization</code> are examples of this style.&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>Standard library (<code>std</code> or <code>core</code> namespaces) counts as external crate for this purpose.&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>Or throw an error. However, trait <code>impl</code>s are always imported implicitly,
so this could essentially prevent some combination of different modules/libraries in the ecosystem from being used together,
and generally create an unfathomable mess.&#160;<a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>The usual workaround for coherence/orphan rules in Rust involves creating a wrapper
around the external type in order to make it &#8220;local&#8221;, and therefore allow external trait <code>impl</code>s for it.
This is called <a href="https://github.com/rust-unofficial/patterns/blob/master/patterns/newtype.md">the <em>newtype</em> pattern</a>
and there are <a href="https://docs.rs/newtype_derive">some crates</a> to support it.&#160;<a class="footnote-backref" href="#fnref:7" rev="footnote" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
</ol>
</div>
      <a class="btn" href="http://xion.io/post/code/rust-extension-traits.html#rust-extension-traits">Continue reading</a>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://xion.io/post/programming/package-management.html#package-management">Package managers&#8217; appreciation&nbsp;day</a></h2>
    <p>
      Posted on Sat 26 March 2016 in <a href="http://xion.io/category/programming.html">Programming</a>
      &#8226; Tagged with
      <a href="http://xion.io/tag/packages.html">packages</a>,      <a href="http://xion.io/tag/package-manager.html">package manager</a>,      <a href="http://xion.io/tag/nodejs.html">node.js</a>,      <a href="http://xion.io/tag/npm.html">npm</a>,      <a href="http://xion.io/tag/c.html">C++</a>      &#8226; <a href="http://xion.io/post/programming/package-management.html#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>By now you have probably heard about the infamous &#8220;npm-gate&#8221; that swept through the developer community
over the last week. It has been
<a href="https://medium.com/@azerbike/i-ve-just-liberated-my-modules-9045c06be67c#.hp7p1aolc">brought up</a>,
<a href="https://medium.com/@mproberts/a-discussion-about-the-breaking-of-the-internet-3d4d2a83aa4d#.rlnh89inz">discussed</a>,
<a href="http://www.theregister.co.uk/2016/03/23/npm_left_pad_chaos/">covered</a>,
<a href="http://www.haneycodes.net/npm-left-pad-have-we-forgotten-how-to-program">meta-discussed</a>,
<a href="http://left-pad.io/">satirized</a>, and even featured by
<a href="http://www.businessinsider.com/npm-left-pad-controversy-explained-2016-3">some mainstream media</a>.
Evidently the nerds have managed to stir up some serious trouble again, and it only took them 11 lines of
that strange thing they call&nbsp;&#8220;code&#8221;.</p>
<h4>No good things in small&nbsp;packages</h4>
<p>When looking for a culprit, the one party that everyone pounced on immediately was of course
the <a href="http://npmjs.com">npm</a> itself. With its myriad of packages that could each fit in a tweet, it invites to create
the exact house of cards we&#8217;ve seen&nbsp;collapse.</p>
<p>This serves as a good wake-up call, of course. But it also compels to throw the baby out with the bathwater,
and draw a conclusion that may be a little too far-fetched. Like perhaps declaring the <em>entire idea</em> of
managing dependencies &#8220;the npm way&#8221; suspect. If packages tend to degenerate into something as ludicrous as
<a href="https://www.npmjs.com/package/isarray"><code>isArray</code></a> &#8212; to say nothing of
<a href="https://www.npmjs.com/package/left-pad"><code>left-pad</code></a>, which started the whole debacle &#8212; then maybe this approach
to software reusability has simply bankrupted&nbsp;itself?</p>
<h4>A world without&nbsp;*pm</h4>
<p>I&#8217;m right away responding to that with a resounding &#8220;No!&#8221;. Package management as a concept is not responsible for
the poor decision making of one specific developer collective. And anyone who might think tools like npm do more
harm than good I ask: have you recently written any&nbsp;C++?</p>
<p>See, C++ is the odd one among languages that at least pretend to be keeping up with the times. It doesn&#8217;t present
a package management story at all. That&#8217;s right &#8212; the C++ &#8220;ecosystem&#8221;, as it stands now,&nbsp;has:</p>
<ul>
<li>no package&nbsp;manager</li>
<li>no repository of&nbsp;packages</li>
<li>no unified way of managing&nbsp;dependencies</li>
<li>no way to isolate development environments of different projects from one&nbsp;another</li>
</ul>
<p>Adding any kind of third-party dependency to a C++ project &#8212; especially a portable one, which is allegedly one of C++&#8217;s
strengths &#8212; is a considerable pain, even when it doesn&#8217;t require any additional libraries by itself. And environment
isolation? Some people are using Linux containers (!) for this, which is like dealing with a mosquito by shooting it
with a&nbsp;howitzer.</p>
<p style="text-align: center">
    <img src="http://xion.io/images/carl-sagan.jpg" alt="Billions upon billions of lines"></br>
    <small>To build a C++ binary, you must first build the userspace.</small>
</p>

<p>But hey, at least they can use <code>apt-get</code>,&nbsp;right?&#8230;</p>
<p>So, string padding incidents aside, package managers are absolutely <em>essential</em>. Sure, we can and should discuss
the merits of their particular flavors and implementation details &#8212;like whether it&#8217;s prudent to allow &#8220;delisting&#8221;
of packages. As a whole, however, package managers deserve recognition as a crucial part of modern language tooling
that we cannot really do&nbsp;without.</p>
      <a class="btn" href="http://xion.io/post/programming/package-management.html#package-management">Continue reading</a>
  </div>
</article>

  <div class="pagination">
  </div>

    <footer>
<p>
  &copy; Karol Kuczmarski 2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27379564-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Karol Kuczmarski's Blog ",
  "url" : "http://xion.io",
  "image": "http://xion.io/logo.jpeg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'xionblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>